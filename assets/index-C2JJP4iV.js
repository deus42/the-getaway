const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/GameMenu-CRkn8vdw.js","assets/vendor-Cc93p67d.js","assets/phaser-DkaA9Y8j.js","assets/game-content-DZEr7Bkc.js","assets/game-core-BugaZv1g.js","assets/EnhancedButton-DVdhyrz_.js","assets/CharacterCreationScreen-Ckd8C67r.js","assets/Tooltip-CnX58fCC.js","assets/CharacterScreen-CZ1DLOOx.js","assets/LevelUpModal-BrZdRYeo.js","assets/PerkSelectionPanel-BTuSXLKQ.js","assets/LevelUpPointAllocationPanel-4xWsjv2w.js"])))=>i.map(i=>d[i]);
var $o=Object.defineProperty;var Go=(e,t,n)=>t in e?$o(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var Pe=(e,t,n)=>Go(e,typeof t!="symbol"?t+"":t,n);import{r as c,u as C,j as o,e as Y,f as Le,g as Uo,R as jt,P as Vo,h as qo}from"./vendor-Cc93p67d.js";import{P as Fe}from"./phaser-DkaA9Y8j.js";import{B as Yo,M as Ko,u as Xo,C as Q,w as Qo,l as wr,c as Me,r as Vs,s as Zo,A as ge,a as Jo,b as ei,d as qs,e as Ys,f as O,g as vr,h as ti,i as Ks,j as Qt,k as Nn,m as On,n as ni,o as ri,p as si,q as Sr,t as oi,v as ii,x as ai,y as li,R as ci,D as Xn,z as Ir,E as kr,F as di,G as Xs,H as ui,I as Qs,J as fi,K as Er,L as pi,S as Tr,N as mi,O as gn,P as hn,Q as yn,T as gi,U as Zs,V as hi,W as yi,X as Mt,Y as Cr,Z as bi,_ as Mr,$ as xi,a0 as wi,a1 as Pr,a2 as bn,a3 as Rr,a4 as Pt,a5 as Ut,a6 as Ar,a7 as Qn,a8 as ht,a9 as en,aa as Dr,ab as Vt,ac as Zt,ad as Rt,ae as vi,af as Si,ag as xn,ah as wn,ai as _r,aj as Ii,ak as ki,al as Lr,am as gt,an as Je,ao as Ei,ap as Ti,aq as Ci,ar as jr,as as Mi,at as Pi,au as Ri,av as vn,aw as Ai,ax as zn,ay as tn,az as Di,aA as _i,aB as Li,aC as ji,aD as Ni,aE as Oi,aF as zi,aG as Fi,aH as Bi,aI as Wi,aJ as Fn,aK as Hi,aL as et,aM as Nr,aN as $i,aO as Gi,aP as Ui,aQ as Vi,aR as qi,aS as Yi,aT as Ki,aU as Xi,aV as Js,aW as Qi,aX as Zi,aY as nn,aZ as Ji,a_ as ea,a$ as ta,b0 as na,b1 as ra,b2 as sa,b3 as oa,b4 as ia,b5 as aa,b6 as xe,b7 as eo,b8 as la,b9 as ca,ba as Or,bb as da,bc as ua,bd as Sn,be as fa}from"./game-core-BugaZv1g.js";import{o as Xe,P as be,n as je,v as He,p as pa,e as ma}from"./game-content-DZEr7Bkc.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function n(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(s){if(s.ep)return;s.ep=!0;const a=n(s);fetch(s.href,a)}})();const ga="modulepreload",ha=function(e){return"/the-getaway/"+e},zr={},yt=function(t,n,r){let s=Promise.resolve();if(n&&n.length>0){let l=function(p){return Promise.all(p.map(f=>Promise.resolve(f).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),d=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));s=l(n.map(p=>{if(p=ha(p),p in zr)return;zr[p]=!0;const f=p.endsWith(".css"),u=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${p}"]${u}`))return;const h=document.createElement("link");if(h.rel=f?"stylesheet":ga,f||(h.as="script"),h.crossOrigin="",h.href=p,d&&h.setAttribute("nonce",d),document.head.appendChild(h),f)return new Promise((S,x)=>{h.addEventListener("load",S),h.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${p}`)))})}))}function a(l){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=l,window.dispatchEvent(i),!i.defaultPrevented)throw l}return s.then(l=>{for(const i of l||[])i.status==="rejected"&&a(i.reason);return t().catch(a)})},ya=({onRendererInfo:e})=>{const t=c.useRef(null),n=c.useRef(null),[r,s]=c.useState({label:"Detecting…",detail:"Negotiating renderer"}),a=c.useRef({width:0,height:0});c.useEffect(()=>{if(console.log("[GameCanvas] useEffect running"),console.log("[GameCanvas] gameContainerRef.current:",t.current),!t.current){console.error("[GameCanvas] No container ref available");return}const p=t.current.offsetWidth,f=t.current.offsetHeight;console.log("[GameCanvas] Container dimensions:",{parentWidth:p,parentHeight:f});const u=_=>{switch(_){case Fe.WEBGL:return{label:"WebGL",detail:"GPU accelerated (shaders, batching)",type:_};case Fe.CANVAS:return{label:"Canvas",detail:"CPU rasterization fallback",type:_};case Fe.HEADLESS:return{label:"Headless",detail:"No renderer active",type:_};default:return{label:"Detecting…",detail:"Negotiating renderer",type:_}}},h=()=>{const _=n.current;if(!_||!_.renderer){s({label:"Detecting…",detail:"Negotiating renderer",type:void 0});return}const H=u(_.renderer.type);s(H)},S={type:Fe.AUTO,width:p>0?p:800,height:f>0?f:600,backgroundColor:"#05070d",parent:t.current,scene:[Yo,Ko],scale:{mode:Fe.Scale.FIT,autoCenter:Fe.Scale.CENTER_BOTH,width:p>0?p:800,height:f>0?f:600},render:{antialias:!0,pixelArt:!1,roundPixels:!1,transparent:!1,powerPreference:"high-performance"},physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!1}},pixelArt:!1,roundPixels:!1,transparent:!1};if(console.log("[GameCanvas] Phaser config:",S),!n.current)try{n.current=new Fe.Game(S);const _=n.current;_.isBooted?h():_.events.once(Fe.Core.Events.READY,h),console.log("[GameCanvas] Phaser game initialized successfully")}catch(_){console.error("[GameCanvas] Error initializing Phaser:",_)}let x,y=null;const M={width:p,height:f},P=(_,H)=>{if(!n.current)return;const L=Math.max(0,Math.floor(_)),X=Math.max(0,Math.floor(H));if(L===0||X===0)return;const{width:re,height:pe}=a.current;if(re===L&&pe===X)return;a.current={width:L,height:X},n.current.scale.resize(L,X)},b=(_,H)=>{typeof _=="number"&&typeof H=="number"?(M.width=_,M.height=H):t.current&&(M.width=t.current.offsetWidth,M.height=t.current.offsetHeight),y!==null&&window.clearTimeout(y),y=window.setTimeout(()=>{y=null,P(M.width,M.height)},40)},N=()=>{b()};return typeof ResizeObserver<"u"&&t.current&&(x=new ResizeObserver(_=>{const H=_[0];H&&b(H.contentRect.width,H.contentRect.height)}),x.observe(t.current)),window.addEventListener("resize",N),()=>{console.log("[GameCanvas] Cleanup running"),window.removeEventListener("resize",N),y!==null&&window.clearTimeout(y),x&&x.disconnect(),n.current&&(n.current.events.off(Fe.Core.Events.READY,h),n.current.destroy(!0),n.current=null,console.log("[GameCanvas] Phaser game destroyed"))}},[]),console.log("[GameCanvas] Rendering component");const l=C(p=>p.settings.testMode),i=C(p=>p.settings.lightsEnabled),d=C(p=>p.settings.visualQualityPreset);return c.useEffect(()=>{Xo({lightsEnabled:i,qualityPreset:d})},[i,d]),c.useEffect(()=>{n.current&&window.requestAnimationFrame(()=>{window.dispatchEvent(new Event("resize"))})},[l]),c.useEffect(()=>{e&&e(r)},[e,r]),o.jsx("div",{style:{position:"relative",width:"100%",height:"100%",backgroundColor:"var(--color-gunmetal-900)",overflow:"hidden",display:"flex",justifyContent:"center",alignItems:"center",pointerEvents:"none"},children:o.jsx("div",{ref:t,style:{position:"absolute",width:"100%",height:"100%",top:0,left:0,right:0,bottom:0,display:"flex",justifyContent:"center",alignItems:"center",backgroundColor:"var(--color-gunmetal-900)",minWidth:"400px",minHeight:"300px",pointerEvents:"auto"}})})},ba=()=>({type:"wait",score:0,summary:"Hold position",rationale:["No safer move available"]}),xa=e=>ba(),In=typeof window<"u"?window:globalThis;class wa{constructor(){Pe(this,"timeouts",new Set)}schedule(t,n){const r=In.setTimeout(()=>{this.timeouts.delete(r),t()},n);return this.timeouts.add(r),r}cancel(t){t!=null&&(In.clearTimeout(t),this.timeouts.delete(t))}dispose(){this.timeouts.forEach(t=>{In.clearTimeout(t)}),this.timeouts.clear()}}const va=()=>new wa,Ce=["evening","night"],Sa=[{zoneId:"downtown_checkpoint",cameras:[{id:"downtown_training_static",type:"static",position:{x:28,y:18},range:6,fieldOfView:90,activationPhases:Ce,sweep:{angles:[300,270,240],cycleDurationMs:2600}},{id:"downtown_static_01",type:"static",position:{x:18,y:22},range:8,fieldOfView:90,activationPhases:Ce,sweep:{angles:[310,270,230],cycleDurationMs:3200}},{id:"downtown_static_02",type:"static",position:{x:52,y:20},range:8,fieldOfView:90,activationPhases:Ce,sweep:{angles:[45,90,135],cycleDurationMs:3e3}},{id:"downtown_motion_01",type:"motionSensor",position:{x:36,y:44},range:4,fieldOfView:360,activationPhases:Ce,motionRadius:4},{id:"downtown_drone_01",type:"drone",position:{x:70,y:16},range:10,fieldOfView:90,activationPhases:Ce,patrolPath:{waypoints:[{x:70,y:16},{x:78,y:28},{x:64,y:34},{x:56,y:22}],travelDurationMs:12e3},sweep:{angles:[0,45,0,-45],cycleDurationMs:2800}}]},{zoneId:"gov_complex",cameras:[{id:"gov_static_01",type:"static",position:{x:14,y:12},range:9,fieldOfView:90,activationPhases:Ce,sweep:{angles:[315,270,225,180],cycleDurationMs:3600}},{id:"gov_static_02",type:"static",position:{x:40,y:10},range:9,fieldOfView:90,activationPhases:Ce,sweep:{angles:[0,45,90],cycleDurationMs:3600}},{id:"gov_motion_01",type:"motionSensor",position:{x:27,y:26},range:4,fieldOfView:360,activationPhases:Ce,motionRadius:4},{id:"gov_motion_02",type:"motionSensor",position:{x:48,y:26},range:4,fieldOfView:360,activationPhases:Ce,motionRadius:4},{id:"gov_drone_01",type:"drone",position:{x:56,y:18},range:12,fieldOfView:90,activationPhases:Ce,patrolPath:{waypoints:[{x:56,y:18},{x:70,y:24},{x:60,y:36},{x:46,y:28}],travelDurationMs:14e3},sweep:{angles:[15,0,-15],cycleDurationMs:2600}},{id:"gov_static_03",type:"static",position:{x:32,y:6},range:9,fieldOfView:90,activationPhases:Ce,sweep:{angles:[200,240,280],cycleDurationMs:3400}}]},{zoneId:"corporate_plaza",cameras:[{id:"corp_static_01",type:"static",position:{x:12,y:12},range:8,fieldOfView:90,activationPhases:Ce,sweep:{angles:[40,0,-40],cycleDurationMs:3e3}},{id:"corp_motion_01",type:"motionSensor",position:{x:26,y:22},range:4,fieldOfView:360,activationPhases:Ce,motionRadius:4},{id:"corp_drone_01",type:"drone",position:{x:34,y:14},range:10,fieldOfView:90,activationPhases:Ce,patrolPath:{waypoints:[{x:34,y:14},{x:42,y:16},{x:40,y:28},{x:30,y:24}],travelDurationMs:1e4},sweep:{angles:[90,120,90,60],cycleDurationMs:2400}}]},{zoneId:"industrial_corridor",cameras:[{id:"ind_static_01",type:"static",position:{x:8,y:32},range:9,fieldOfView:90,activationPhases:Ce,sweep:{angles:[180,210,240],cycleDurationMs:3200}},{id:"ind_motion_01",type:"motionSensor",position:{x:22,y:40},range:4,fieldOfView:360,activationPhases:Ce,motionRadius:4}]},{zoneId:"resistance_safehouse",cameras:[]}],Ia=e=>{const t=Sa.find(n=>n.zoneId===e);return t?t.cameras.map(n=>({...n})):[]},ka=400,Ea=3200,to=e=>{const t=typeof e=="number"&&Number.isFinite(e)?Math.abs(e):Ea;return Math.max(ka,t)},_t=e=>{const t=Qo(e);return t<0?t+360:t},Ta=e=>{var r;const t=((r=e.sweep)==null?void 0:r.angles)??[],n=t.length>0?_t(t[0]):_t(e.fieldOfView>=360?0:e.fieldOfView/2);return{...e,alertState:Q.IDLE,detectionProgress:0,isActive:!1,hackState:{},lastDetectionTimestamp:void 0,currentDirection:n,sweepDirection:1,sweepElapsedMs:0,sweepIndex:0,patrolProgressMs:0,currentWaypointIndex:0,networkAlertContributionAt:void 0,trackingPlayer:!1,trackingDirection:void 0}},no=(e,t,n,r)=>{const s=e.sweep;if(!s||s.angles.length===0)return{direction:n?r:e.currentDirection,sweepDirection:e.sweepDirection??1,sweepIndex:e.sweepIndex??0,sweepElapsedMs:e.sweepElapsedMs??0};const a=s.angles,l=a.length;if(l===1){const b=n?r+a[0]:a[0];return{direction:_t(b),sweepDirection:e.sweepDirection??1,sweepIndex:0,sweepElapsedMs:0}}let i=e.sweepDirection??1,d=Me(e.sweepIndex??0,0,l-1),p=(e.sweepElapsedMs??0)+t;const f=to(s.cycleDurationMs)/(l-1);for(;p>=f;){p-=f;let b=d+i;b>=l?(i=-1,b=l-2):b<0&&(i=1,b=1),d=Me(b,0,l-1)}const u=Me(d+i,0,l-1),h=Me(f===0?0:p/f,0,1),S=a[d],x=a[u],y=Zo(S,x),M=S+y*h,P=n?r+M:M;return{direction:_t(P),sweepDirection:i,sweepIndex:d,sweepElapsedMs:p}},ro=(e,t)=>{const n=no(e,t,!1,0);return e.currentDirection=n.direction,e.sweepDirection=n.sweepDirection,e.sweepIndex=n.sweepIndex,e.sweepElapsedMs=n.sweepElapsedMs,e},kn=(e,t)=>t===0?0:e<0?t-1:e>=t?0:e,Ca=(e,t)=>{const n=e.patrolPath;if(!n||n.waypoints.length===0)return ro(e,t);const r=n.waypoints,s=to(n.travelDurationMs)/r.length;let a=(e.patrolProgressMs??0)+t,l=kn(e.currentWaypointIndex??0,r.length),i=kn(l+1,r.length);for(;a>=s;)a-=s,l=i,i=kn(l+1,r.length);const d=r[l],p=r[i],f=s<=0?0:Me(a/s,0,1),u=wr(d.x,p.x,f),h=wr(d.y,p.y,f),S=Math.atan2(p.y-d.y,p.x-d.x),x=Vs(S),y=no(e,t,!0,x);return e.position={x:u,y:h},e.currentDirection=y.direction,e.currentWaypointIndex=l,e.patrolProgressMs=a,e.sweepDirection=y.sweepDirection,e.sweepIndex=y.sweepIndex,e.sweepElapsedMs=y.sweepElapsedMs,e},Ma=(e,t)=>{let n;switch(e.type){case"drone":n=Ca(e,t);break;case"motionSensor":case"static":default:n=ro(e,t);break}return n.trackingPlayer&&typeof n.trackingDirection=="number"&&(n.currentDirection=_t(n.trackingDirection)),n},Pa=(e,t)=>{const{hackState:n}=e;return n?!!(n.disabledUntil&&n.disabledUntil>t):!1},Ra=(e,t)=>{const{hackState:n}=e;return!!(n!=null&&n.loopFootageUntil&&n.loopFootageUntil>t)},En=e=>{switch(e){case ge.IDLE:return 0;case ge.SUSPICIOUS:return 1;case ge.INVESTIGATING:return 2;case ge.ALARMED:return 3;default:return 0}},so=(e,t)=>{const n=e.x-t.x,r=e.y-t.y;return Math.sqrt(n*n+r*r)},oo=(e,t)=>t.blackoutTier==="rolling"?.55:t.blackoutTier==="brownout"?.65:e==="night"?.7:e==="evening"||e==="morning"?.85:1,io=e=>{var l;const t=((l=e.skillTraining)==null?void 0:l.stealth)??0,n=e.skills.agility??5,r=Math.min(t/120,.35),s=Math.max(0,(n-6)*.03),a=Math.min(.45,r+s);return Me(1-a,.55,1)},ao=e=>{switch(e.movementProfile){case"silent":return .7;case"sprint":return 1.15;default:return 1}},Aa=e=>{const t=e.label;return typeof t=="string"&&t.trim().length>0?t:e.id.split(/[_-]/g).map(n=>n.charAt(0).toUpperCase()+n.slice(1)).join(" ")},Da=({enemy:e,player:t,mapArea:n,timeOfDay:r,environmentFlags:s,playerVisible:a,timestamp:l})=>{const i=e.visionCone;if(!i||!a)return null;const d=e.alertLevel??ge.IDLE,p=so(e.position,t.position),f=i.range||8,u=Me(.7+En(d)*.06,.6,.95),h=Me(1-p/(f+1),.25,1),S=oo(r,s),x=io(t),y=ao(t);return{witnessId:e.id,witnessLabel:e.name??"Guard",targetId:t.id,zoneId:n.zoneId,areaId:n.id,timestamp:l,source:"guard",recognitionChannel:"face",baseCertainty:u,distanceModifier:h,lightingModifier:S,disguiseModifier:x,postureModifier:y,reported:En(d)>=En(ge.INVESTIGATING),location:{...e.position}}},_a=({camera:e,player:t,mapArea:n,timeOfDay:r,environmentFlags:s,timestamp:a,alertState:l})=>{const i=so(e.position,t.position),d=e.range||8,p=l===Q.ALARMED?.88:l===Q.INVESTIGATING?.76:l===Q.SUSPICIOUS?.65:.5,f=Me(1-i/(d+1),.3,1),u=oo(r,s),h=io(t),S=ao(t);return{witnessId:e.id,witnessLabel:Aa(e),targetId:t.id,zoneId:n.zoneId,areaId:n.id,timestamp:a,source:"camera",recognitionChannel:"face",baseCertainty:p,distanceModifier:f,lightingModifier:u,disguiseModifier:h,postureModifier:S,reported:l===Q.ALARMED,location:{...e.position}}},La=100/3e3,Fr=100/4e3,ja=60,Bn=100,Na=6e4,Oa=5*60*1e3,rn={},Ge={},lo=(e,t)=>!e.activationPhases||e.activationPhases.length===0?!0:e.activationPhases.includes(t),za=e=>{const t=e%360;return t<0?t+360:t},Fa=(e,t)=>{const n=Math.atan2(t.position.y-e.position.y,t.position.x-e.position.x),r=Vs(n);return za(r)},co=(e,t)=>{const n=t.x-e.x,r=t.y-e.y;return Math.sqrt(n*n+r*r)},uo=(e,t)=>{var r;const n=(r=e.skillTraining)==null?void 0:r[t];return typeof n=="number"?n:0},Ba=(e,t)=>{const n=e.type==="motionSensor"?e.motionRadius??e.range:e.range,r=uo(t,"stealth"),s=Me(r/200,0,.75);let a=n*(1-s);const l=t.movementProfile==="silent"?.8:t.movementProfile==="sprint"?1.2:1;return a*=l,t.stealthModeEnabled&&(a*=.75),Math.max(1,a)},Wa=(e,t,n,r,s,a,l)=>{if(!e.isActive)return{state:Q.DISABLED,progress:0,detectionActive:!1,lastDetectionTimestamp:void 0};if(Pa(t,l))return{state:Q.DISABLED,progress:0,detectionActive:!1,lastDetectionTimestamp:void 0};const i=Ra(t,l),d=Ba(e,n),p=co(e.position,n.position);let f=!1;if(!i)if(e.type==="motionSensor"){const x=n.movementProfile!=="silent";f=p<=d&&s&&x}else Nn(e.position,n.position,{range:d,angle:e.fieldOfView,direction:e.currentDirection})&&On(e.position,n.position,r)&&(f=!0);let u=t.detectionProgress,h=t.lastDetectionTimestamp;if(f){const x=uo(n,"hacking"),y=Me(x/400,0,.25),M=n.movementProfile==="silent"?.7:n.movementProfile==="sprint"?1.2:1,P=n.stealthModeEnabled?.75:1;u+=La*a*(1-y)*M*P,u=Math.min(Bn,u),h=l}else{const x=t.trackingPlayer?Fr*1.8:Fr;u-=x*a,u=Math.max(0,u)}const S=Ga(u);return S===Q.ALARMED&&(u=Bn),{state:S,progress:u,detectionActive:f,lastDetectionTimestamp:h}},Ha=(e,t,n)=>{Ge[e]||(Ge[e]=[]),Ge[e].push({cameraId:t,timestamp:n}),Ge[e]=Ge[e].filter(r=>n-r.timestamp<=Na)},$a=e=>{const t=Ge[e];return t?t.length>=3:!1},qt=e=>{switch(e){case Q.ALARMED:return 4;case Q.INVESTIGATING:return 3;case Q.SUSPICIOUS:return 2;case Q.IDLE:return 1;case Q.DISABLED:default:return 0}},Ga=e=>e>=Bn?Q.ALARMED:e>=ja?Q.INVESTIGATING:e>0?Q.SUSPICIOUS:Q.IDLE,Ua=e=>{const{area:t,timeOfDay:n,dispatch:r,timestamp:s}=e,l=Ia(t.zoneId).map(i=>{const d=Ta(i),p=lo(d,n);return d.isActive=p,d.alertState=p?Q.IDLE:Q.DISABLED,d.detectionProgress=0,d.lastDetectionTimestamp=void 0,d});r(ei({areaId:t.id,zoneId:t.zoneId,cameras:l,timestamp:s})),rn[t.id]={lastPlayerPosition:void 0,lastUpdateTimestamp:s,hudSnapshot:void 0},Ge[t.id]=[]},Br=e=>{const{areaId:t,dispatch:n}=e;n(Jo({areaId:t})),delete rn[t],delete Ge[t]},Va=e=>{const{zone:t,area:n,timeOfDay:r,dispatch:s,timestamp:a}=e;if(!t||!n)return;const l=[];let i=!1;Object.values(t.cameras).forEach(d=>{const p=lo(d,r);if(p===d.isActive&&(p||d.alertState===Q.DISABLED&&(d.detectionProgress??0)===0))return;const f={isActive:p,detectionProgress:p?d.detectionProgress:0,lastDetectionTimestamp:p?d.lastDetectionTimestamp:void 0,alertState:p?Q.IDLE:Q.DISABLED,trackingPlayer:!1,trackingDirection:void 0};p?i=!0:i=i||d.isActive,l.push({cameraId:d.id,changes:f})}),l.forEach(d=>{s(qs({areaId:t.areaId,cameraId:d.cameraId,changes:d.changes,timestamp:a}))}),i&&r!=="day"&&r!=="morning"&&s(Ys({visible:!0,timestamp:a}))},qa=e=>{const{zone:t,mapArea:n,player:r,deltaMs:s,timestamp:a,dispatch:l,logStrings:i,reinforcementsScheduled:d,globalAlertLevel:p,timeOfDay:f,environmentFlags:u,worldTimeSeconds:h,onWitnessObservation:S}=e,x=rn[t.areaId]??{lastPlayerPosition:void 0},y=x.lastPlayerPosition,M=y?y.x!==r.position.x||y.y!==r.position.y:!1,P=k=>k.type==="motionSensor"?k.motionRadius??k.range:k.range;let b=0,N=0,_=Q.IDLE,H=null;const L=[];let X=!1,re=!1;Object.values(t.cameras).forEach(k=>{const w={...k,position:{...k.position},hackState:{...k.hackState}};Ma(w,s);const q=Wa(w,k,r,n,M,s,a);if(w.alertState=q.state,w.detectionProgress=q.progress,w.lastDetectionTimestamp=q.lastDetectionTimestamp,w.alertState===Q.DISABLED&&(w.detectionProgress=0),w.type!=="motionSensor")if(w.isActive&&q.detectionActive&&(w.alertState===Q.SUSPICIOUS||w.alertState===Q.INVESTIGATING||w.alertState===Q.ALARMED)){const D=Fa(w,r);w.trackingPlayer=!0,w.trackingDirection=D,w.currentDirection=D}else w.trackingPlayer&&(w.trackingPlayer=!1,w.trackingDirection=void 0);else w.trackingPlayer&&(w.trackingPlayer=!1,w.trackingDirection=void 0);const $=w.alertState!==k.alertState,le=w.currentDirection!==k.currentDirection,fe=w.position.x!==k.position.x||w.position.y!==k.position.y,he=Math.abs(w.detectionProgress-k.detectionProgress)>.1,V=w.lastDetectionTimestamp!==k.lastDetectionTimestamp,J=w.sweepDirection!==k.sweepDirection||w.sweepIndex!==k.sweepIndex||Math.abs((w.sweepElapsedMs??0)-(k.sweepElapsedMs??0))>.1,ae=(w.trackingPlayer??!1)!==(k.trackingPlayer??!1),me=w.trackingDirection!==k.trackingDirection;if($&&(w.alertState===Q.SUSPICIOUS||w.alertState===Q.INVESTIGATING||w.alertState===Q.ALARMED)){const se=_a({camera:w,player:r,mapArea:n,timeOfDay:f,environmentFlags:u,timestamp:h,alertState:w.alertState});S&&S(se)}if(($||le||fe||he||V||J||ae||me)&&L.push({cameraId:k.id,runtime:w,previous:k}),$&&w.alertState===Q.ALARMED&&(re=!0,Ha(t.areaId,k.id,a)),w.isActive&&w.alertState!==Q.DISABLED){const se=P(w);co(w.position,r.position)<=se+.5&&(b+=1)}w.detectionProgress>N&&(N=w.detectionProgress,H=k.id),qt(w.alertState)>qt(_)&&(_=w.alertState)}),L.forEach(({cameraId:k,runtime:w,previous:q})=>{const $={alertState:w.alertState,detectionProgress:w.detectionProgress,currentDirection:w.currentDirection,lastDetectionTimestamp:w.lastDetectionTimestamp,position:w.position,sweepDirection:w.sweepDirection,sweepIndex:w.sweepIndex,sweepElapsedMs:w.sweepElapsedMs,patrolProgressMs:w.patrolProgressMs,currentWaypointIndex:w.currentWaypointIndex,trackingPlayer:w.trackingPlayer,trackingDirection:w.trackingDirection};if(w.isActive||($.detectionProgress=0,$.alertState=Q.DISABLED,$.lastDetectionTimestamp=void 0,$.trackingPlayer=!1,$.trackingDirection=void 0),l(qs({areaId:t.areaId,cameraId:k,changes:$,timestamp:a})),q.alertState!==w.alertState){const le=qt(q.alertState);qt(w.alertState)>le&&(w.alertState===Q.SUSPICIOUS?l(O(i.cameraAlertSuspicious)):w.alertState===Q.INVESTIGATING?l(O(i.cameraAlertInvestigating)):w.alertState===Q.ALARMED&&l(O(i.cameraAlertAlarmed)))}});const pe=Ge[t.areaId]??[];let F=t.networkAlert;if(F&&F.expiresAt<=a&&(l(vr({areaId:t.areaId,alert:null})),F=null),!F&&$a(t.areaId)){X=!0;const k=pe.slice(-3).map(w=>w.cameraId);F={triggeredAt:a,expiresAt:a+Oa,contributingCameraIds:k},l(vr({areaId:t.areaId,alert:F}))}const g={camerasNearby:b,detectionProgress:Number(Math.min(100,N).toFixed(2)),alertState:_,activeCameraId:H,networkAlertActive:!!F,networkAlertExpiresAt:(F==null?void 0:F.expiresAt)??null},v=x.hudSnapshot;(!v||v.camerasNearby!==g.camerasNearby||Math.abs(v.detectionProgress-g.detectionProgress)>.5||v.alertState!==g.alertState||v.activeCameraId!==g.activeCameraId||v.networkAlertActive!==g.networkAlertActive||v.networkAlertExpiresAt!==g.networkAlertExpiresAt)&&(l(ti(g)),x.hudSnapshot=g),re&&!d?(l(O(i.reinforcementsIncoming)),l(Ks()),l(Qt(ge.ALARMED))):X?(l(O(i.curfewReinforcement)),l(Qt(ge.ALARMED))):re&&p!==ge.ALARMED&&l(Qt(ge.ALARMED)),rn[t.areaId]={...x,lastPlayerPosition:{...r.position},lastUpdateTimestamp:a}},tt=[],Ya=e=>{const t=tt.findIndex(n=>n.id===e.id);if(t>=0){tt[t]={...tt[t],...e},tt[t].fired=!1,tt[t].lastFiredAt=void 0;return}tt.push({...e})},Ka=e=>{e.forEach(Ya)},Xa=(e,t,n=Date.now())=>{const r=t();tt.forEach(s=>{s.once&&s.fired||typeof s.cooldownMs=="number"&&s.lastFiredAt!==void 0&&n-s.lastFiredAt<s.cooldownMs||!s.when(r)||(s.fire({dispatch:e,getState:t,now:n}),s.lastFiredAt=n,s.once&&(s.fired=!0))})},Qa={low:[{id:"rumor.low.coyotes-logo",groupId:"slum-barflies",flag:"gangHeat",value:"low",storyFunction:"world-building",description:"Warm-up chatter when the streets are calm.",lines:["Coyotes rebranded again. Same howls, new accounting font.","CorpSec confiscated their synth-leather jackets. Fashion crime unit, I guess.","If the gang war is over, someone forgot to tell the bullet holes."]},{id:"rumor.low.tax-audit",groupId:"dock-liquor-patrons",flag:"gangHeat",value:"low",storyFunction:"foreshadow",description:"Hints at upcoming tensions despite low heat.",lines:["Heard the Coyotes scheduled a tax audit. They grow up so fast.","You know it’s quiet when the bartops stop vibrating.","Peace smells like ozone and unpaid protection money."]}],med:[{id:"rumor.med.return",groupId:"slum-barflies",flag:"gangHeat",value:"med",storyFunction:"misdirect",description:"Contradicts official statements to set up later payoffs.",lines:["Coyotes are back. Again. They brought merch this time.","Saw their lieutenant handing out coupons for muggings. 20% off with code “WHOOPS”.","If the city says everything is fine, duck."]},{id:"rumor.med.payroll",groupId:"dock-liquor-patrons",flag:"gangHeat",value:"med",storyFunction:"payoff",description:"Signals growing pressure around the docks.",lines:["Dock payroll went missing. Must have taken the scenic route through a heist.","CorpSec switched to hazard pay. They called it “enthusiasm adjustment”.","Graffiti keeps spelling “WE ARE TEMPORARY”. Someone stamped “UNTIL AUDIT COMPLETE” on top."]}],high:[{id:"rumor.high.curfew",groupId:"slum-barflies",flag:"gangHeat",value:"high",storyFunction:"foreshadow",description:"Signals impending clampdowns.",lines:["Curfew now starts before brunch. Crime brunch still sold out.","Coyotes swapped bullets for invoices. Same damage, more paperwork.","Saw CorpSec drones high-fiving. Never a good omen."]},{id:"rumor.high.wanted",groupId:"dock-liquor-patrons",flag:"gangHeat",value:"high",storyFunction:"payoff",description:"Pairs with power glitch triggers that reveal wanted posters.",lines:["CRTs keep flashing some wanted face. He already skipped town, obviously.","Dock sirens learned harmony. It’s unnerving in four-part.","When the lights flicker, we clap. Keeps the grid on edge."]}]},Za=e=>Qa[e]??[],Ja=[{id:"note.supply.norm.crate",flag:"supplyScarcity",value:"norm",storyFunction:"world-building",description:"Everyday logistics with a dry punchline.",preferredZoneId:"downtown_checkpoint",position:{x:28,y:26},lines:["[DATE STAMP SMEARED]","Shift log: 6 crates “medical”.","Counted 5.","Crate 6 coughing."]},{id:"note.supply.tight.ammo-iou",flag:"supplyScarcity",value:"tight",storyFunction:"misdirect",description:"Sets up later gag about returned bullets.",preferredZoneId:"downtown_checkpoint",position:{x:34,y:30},lines:["IOU: 3 bullets. Return unused.","Signed: Depot Clerk, with love.","PS: Bring wipes."]},{id:"note.supply.rationed.bullet-receipt",flag:"supplyScarcity",value:"rationed",storyFunction:"payoff",description:"Punchline for earlier IOU rumor.",preferredZoneId:"downtown_checkpoint",position:{x:36,y:28},lines:["Receipt: All three bullets returned.","Two still lodged in debtor.","Processing fee waived."]},{id:"note.curfew.tier2",flag:"curfewLevel",value:2,storyFunction:"foreshadow",description:"Hints at creeping curfew changes.",preferredZoneId:"downtown_checkpoint",position:{x:40,y:24},lines:["Memo: Curfew trial balloon.","Please begin night at 3 PM.","Public feedback: “Already dark”."]},{id:"note.gangHeat.high",flag:"gangHeat",value:"high",storyFunction:"payoff",description:"Ties to high-heat rumors.",preferredZoneId:"downtown_checkpoint",position:{x:32,y:34},lines:["Wanted poster: “Seen smiling. Suspicious.”","Reward: Half-price cola (while grid stable).","Report sightings to CO-LAW vending kiosks."]},{id:"note.gangHeat.low.suspicion-drill",flag:"gangHeat",value:"low",storyFunction:"world-building",description:"Field memo coaching crews on witness heat drills.",preferredZoneId:"downtown_checkpoint",position:{x:30,y:24},lines:["Ops memo: Trigger one patrol sighting and log the heat spike.","Break line-of-sight, watch the Suspicion Inspector cool to calm.","Report anomalies to George so the city remembers accurately."]}],el=(e,t)=>Ja.filter(n=>n.flag===e&&n.value===t),fo=[{id:"sign.blackout.none.cola",signId:"downtown.vending.primary",flag:"blackoutTier",value:"none",storyFunction:"world-building",description:"Default advertising bluster.",text:"COLA: Now with 12 essential sugars."},{id:"sign.blackout.brownout.colaw",signId:"downtown.vending.primary",flag:"blackoutTier",value:"brownout",storyFunction:"misdirect",description:"First hint the grid is lying.",text:"CO-LAW: Report loiterers, earn fizz miles."},{id:"sign.blackout.rolling.alert",signId:"downtown.vending.primary",flag:"blackoutTier",value:"rolling",storyFunction:"payoff",description:"Full propaganda mode during outages.",text:"CO-LAW: Lights out? Snitch brighter."},{id:"sign.supply.tight.milk",signId:"corner.bodega.priceboard",flag:"supplyScarcity",value:"tight",storyFunction:"foreshadow",description:"Price jumps signal scarcity.",text:"Milk: 45 credits. Bottles scowl included."},{id:"sign.supply.rationed.ammo",signId:"corner.bodega.priceboard",flag:"supplyScarcity",value:"rationed",storyFunction:"payoff",description:"Ammo “sale” becomes a comedic beat.",text:"Ammo Sale*: *Bring your own casing."}],Wr=(e,t)=>fo.filter(n=>n.flag===e&&n.value===t),tl=e=>fo.find(t=>t.id===e),Zn=[{id:"weather.curfew.0",flag:"curfewLevel",value:0,rainIntensity:0,thunderActive:!1,sirenLoop:!1,storyFunction:"world-building",description:"Dry air wobble when curfew is dormant."},{id:"weather.curfew.1",flag:"curfewLevel",value:1,rainIntensity:.2,thunderActive:!1,sirenLoop:!1,storyFunction:"foreshadow",description:"Light drizzle telegraphs rising tension."},{id:"weather.curfew.2",flag:"curfewLevel",value:2,rainIntensity:.6,thunderActive:!1,sirenLoop:!0,storyFunction:"payoff",description:"Rain and sirens when curfew crosses enforcement threshold."},{id:"weather.curfew.3",flag:"curfewLevel",value:3,rainIntensity:.85,thunderActive:!0,sirenLoop:!0,storyFunction:"world-building",description:"Thunderclaps sync with decision beats at max curfew."},{id:"weather.gangHeat.high",flag:"gangHeat",value:"high",rainIntensity:.75,thunderActive:!0,sirenLoop:!0,storyFunction:"misdirect",description:"Extra thunder during high gang heat for dramatic cues."}],nl=e=>Zn.find(t=>t.flag==="curfewLevel"&&typeof t.value=="number"&&t.value===e),rl=e=>Zn.find(t=>t.flag==="gangHeat"&&t.value===e),sl=e=>Zn.find(t=>t.id===e),Hr={"slum-barflies":[{dialogueId:"npc_lira_vendor"},{dialogueId:"npc_courier_brant"}],"dock-liquor-patrons":[{dialogueId:"npc_captain_reyna"},{dialogueId:"npc_drone_handler_kesh"}]},ol=()=>["low","med","high"].flatMap(t=>Za(t).map(r=>({id:`environment.rumor.${r.id}`,cooldownMs:1e3,when:s=>{const{flags:a,rumorSets:l}=s.world.environment;if(a.gangHeat!==t||!(r.groupId in Hr))return!1;const i=l[r.groupId];return!i||i.sourceId!==r.id},fire:({dispatch:s,getState:a,now:l})=>{const d=a().settings.locale,p=Xe(d).logs,f=Hr[r.groupId];s(ni({groupId:r.groupId,snapshot:{lines:[...r.lines],storyFunction:r.storyFunction,sourceId:r.id,updatedAt:l}})),f.forEach(u=>{s(ri({match:u,profile:{lines:[...r.lines],storyFunction:r.storyFunction,sourceId:r.id,updatedAt:l}}))}),s(O(p.environmentRumorSwap(r.description)))}}))),$r=e=>{const{flags:t}=e.world.environment;if(t.curfewLevel<3){const n=rl(t.gangHeat);if(n)return n}return nl(t.curfewLevel)??null},il=()=>[{id:"environment.weather.update",when:e=>{const t=$r(e);if(!t)return!1;const n=e.world.environment.weather,r=e.world.timeOfDay,s=n.presetId!==t.id,a=n.timeOfDay!==r;return s||a},fire:({dispatch:e,getState:t,now:n})=>{const r=t(),s=$r(r);if(!s)return;const a=r.world.environment.weather,l=r.world.timeOfDay,i=r.settings.locale,d=Xe(i).logs;if(e(si({presetId:s.id,rainIntensity:s.rainIntensity,sirenLoop:s.sirenLoop,thunderActive:s.thunderActive,storyFunction:s.storyFunction,updatedAt:n,timeOfDay:l})),a.presetId!==s.id||a.timeOfDay!==l){const p=s.description??s.id;e(O(d.environmentWeatherShift(p)))}}}],al=()=>{const e=["none","brownout","rolling"],t=["norm","tight","rationed"],n=e.flatMap(s=>Wr("blackoutTier",s).map(l=>({id:`environment.signage.${l.id}`,cooldownMs:4e3,when:i=>{if(i.world.environment.flags.blackoutTier!==s)return!1;const d=i.world.environment.signage[l.signId];return!d||d.variantId!==l.id},fire:({dispatch:i,getState:d,now:p})=>{const f=d().settings.locale,u=Xe(f).logs;i(Sr({signId:l.signId,snapshot:{variantId:l.id,storyFunction:l.storyFunction,updatedAt:p}})),i(O(u.environmentSignageSwap(l.text)))}}))),r=t.flatMap(s=>Wr("supplyScarcity",s).map(l=>({id:`environment.signage.${l.id}`,cooldownMs:4e3,when:i=>{if(i.world.environment.flags.supplyScarcity!==s)return!1;const d=i.world.environment.signage[l.signId];return!d||d.variantId!==l.id},fire:({dispatch:i,getState:d,now:p})=>{const f=d().settings.locale,u=Xe(f).logs;i(Sr({signId:l.signId,snapshot:{variantId:l.id,storyFunction:l.storyFunction,updatedAt:p}})),i(O(u.environmentSignageSwap(l.text)))}})));return[...n,...r]},ll=()=>{const e=["norm","tight","rationed"],t=["low","med","high"],n=[0,1,2,3],r=(s,a)=>a.flatMap(l=>el(s,l).map(d=>({id:`environment.notes.${d.id}`,cooldownMs:5e3,when:p=>{const f=p.world.environment.flags;return(s==="supplyScarcity"?f.supplyScarcity===l:s==="gangHeat"?f.gangHeat===l:f.curfewLevel===l)?!p.world.environment.notes.some(h=>h.definitionId===d.id):!1},fire:({dispatch:p,getState:f,now:u})=>{const h=f(),S=h.world.currentMapArea.id,x=h.settings.locale,y=Xe(x).logs;p(oi({instanceId:`env-note::${d.id}`,definitionId:d.id,areaId:S,lines:[...d.lines],storyFunction:d.storyFunction,spawnedAt:u})),p(O(y.environmentNoteSpawned(d.description??"new memo recovered")))}})));return[...r("supplyScarcity",e),...r("gangHeat",t),...r("curfewLevel",n)]};let Gr=!1;const cl=()=>{if(Gr)return;const e=[...ol(),...il(),...al(),...ll()];Ka(e),Gr=!0},Ur={light:0,balanced:1,heavy:2,sensor:3},Vr={open:0,restricted:1,sealed:2},qr={clear:0,caution:1,severe:2},dl={"smog:none":{},"smog:light":{behavior:{sightMultiplier:.9,chaseMultiplier:.95,routineIntervalMultiplier:1.05},travel:{visibilityMultiplier:.85,staminaDrainPerMinute:1,encounterRiskModifier:1.1,advisoryLevel:"caution"}},"smog:heavy":{behavior:{sightMultiplier:.65,chaseMultiplier:.8,loadoutBias:"sensor",routineIntervalMultiplier:1.2},travel:{visibilityMultiplier:.55,staminaDrainPerMinute:3,encounterRiskModifier:1.35,vehicleWearMultiplier:1.2,advisoryLevel:"severe"}},"blackout:none":{},"blackout:brownout":{behavior:{sightMultiplier:.95},faction:{shopMarkupDelta:.05,reinforcementDelayMultiplier:1.1,safehouseAccess:"restricted"},travel:{visibilityMultiplier:.8,advisoryLevel:"caution"}},"blackout:rolling":{behavior:{sightMultiplier:.85,loadoutBias:"sensor"},faction:{shopMarkupDelta:.12,reinforcementDelayMultiplier:.9,safehouseAccess:"restricted"},travel:{visibilityMultiplier:.7,vehicleWearMultiplier:1.1,advisoryLevel:"caution"}},"surveillance:low":{},"surveillance:elevated":{behavior:{chaseMultiplier:1.15,routineIntervalMultiplier:1.05},faction:{reinforcementDelayMultiplier:.95},travel:{encounterRiskModifier:1.2,advisoryLevel:"caution"}},"surveillance:extreme":{behavior:{sightMultiplier:1.1,chaseMultiplier:1.3,loadoutBias:"sensor",routineIntervalMultiplier:1.15},faction:{shopMarkupDelta:.08,reinforcementDelayMultiplier:.75,safehouseAccess:"restricted"},travel:{encounterRiskModifier:1.4,advisoryLevel:"severe"}},"radiation:none":{},"radiation:localized":{behavior:{routineIntervalMultiplier:1.08},faction:{safehouseAccess:"restricted"},travel:{staminaDrainPerMinute:2,vehicleWearMultiplier:1.15,advisoryLevel:"caution"}},"radiation:pervasive":{behavior:{routineIntervalMultiplier:1.18,loadoutBias:"heavy"},faction:{shopMarkupDelta:.1,safehouseAccess:"sealed"},travel:{staminaDrainPerMinute:4,vehicleWearMultiplier:1.3,encounterRiskModifier:1.25,advisoryLevel:"severe"}},"curfew:off":{},"curfew:tight":{behavior:{chaseMultiplier:1.1,routineIntervalMultiplier:1.05},faction:{shopMarkupDelta:.08,reinforcementDelayMultiplier:.85,safehouseAccess:"restricted"},travel:{encounterRiskModifier:1.25,advisoryLevel:"caution"}},"curfew:lockdown":{behavior:{chaseMultiplier:1.35,routineIntervalMultiplier:1.25,loadoutBias:"heavy"},faction:{shopMarkupDelta:.2,reinforcementDelayMultiplier:.65,safehouseAccess:"sealed"},travel:{encounterRiskModifier:1.6,advisoryLevel:"severe"}}},nt=(e,t,n)=>Me(e,t,n),ul=()=>({behavior:{sightMultiplier:1,chaseMultiplier:1,routineIntervalMultiplier:1,loadoutBias:"balanced"},faction:{shopMarkupDelta:0,reinforcementDelayMultiplier:1,safehouseAccess:"open"},travel:{staminaDrainPerMinute:0,vehicleWearMultiplier:1,encounterRiskModifier:1,advisoryLevel:"clear",visibilityMultiplier:1}}),fl=(e,t)=>{if(t&&(typeof t.sightMultiplier=="number"&&(e.sightMultiplier=nt(e.sightMultiplier*t.sightMultiplier,.35,1.8)),typeof t.chaseMultiplier=="number"&&(e.chaseMultiplier=nt(e.chaseMultiplier*t.chaseMultiplier,.5,2)),typeof t.routineIntervalMultiplier=="number"&&(e.routineIntervalMultiplier=nt(e.routineIntervalMultiplier*t.routineIntervalMultiplier,.7,2.2)),t.loadoutBias)){const n=Ur[e.loadoutBias];Ur[t.loadoutBias]>n&&(e.loadoutBias=t.loadoutBias)}},pl=(e,t)=>{if(t&&(typeof t.shopMarkupDelta=="number"&&(e.shopMarkupDelta=Me(e.shopMarkupDelta+t.shopMarkupDelta,-.5,1)),typeof t.reinforcementDelayMultiplier=="number"&&(e.reinforcementDelayMultiplier=nt(e.reinforcementDelayMultiplier*t.reinforcementDelayMultiplier,.4,1.6)),t.safehouseAccess)){const n=Vr[e.safehouseAccess];Vr[t.safehouseAccess]>n&&(e.safehouseAccess=t.safehouseAccess)}},ml=(e,t)=>{if(t&&(typeof t.staminaDrainPerMinute=="number"&&(e.staminaDrainPerMinute=Me(e.staminaDrainPerMinute+t.staminaDrainPerMinute,0,12)),typeof t.vehicleWearMultiplier=="number"&&(e.vehicleWearMultiplier=nt(e.vehicleWearMultiplier*t.vehicleWearMultiplier,.6,2)),typeof t.encounterRiskModifier=="number"&&(e.encounterRiskModifier=nt(e.encounterRiskModifier*t.encounterRiskModifier,.5,3)),typeof t.visibilityMultiplier=="number"&&(e.visibilityMultiplier=nt(e.visibilityMultiplier*t.visibilityMultiplier,.2,1)),t.advisoryLevel)){const n=qr[e.advisoryLevel];qr[t.advisoryLevel]>n&&(e.advisoryLevel=t.advisoryLevel)}},gl=e=>{const t=ul();return e.forEach(n=>{const r=dl[n];r&&(r.behavior&&fl(t.behavior,r.behavior),r.faction&&pl(t.faction,r.faction),r.travel&&ml(t.travel,r.travel))}),t},hl=e=>{if(!e||e.length===0)return"none";const t=e.map(n=>n.toLowerCase());return t.some(n=>n.includes("dense smog")||n.includes("toxic smog"))?"heavy":t.some(n=>n.includes("smog")||n.includes("gas cloud"))?"light":"none"},yl=(e,t)=>{let n="low";(e.gangHeat!=="low"||e.curfewLevel>=1)&&(n="elevated");const r=(t==null?void 0:t.map(s=>s.toLowerCase()))??[];return(e.gangHeat==="high"||e.curfewLevel>=3||r.some(s=>s.includes("camera")||s.includes("drone")||s.includes("surveillance")||s.includes("riot squad")))&&(n="extreme"),n},bl=e=>{if(!e||e.length===0)return"none";const t=e.map(n=>n.toLowerCase());return t.some(n=>n.includes("radiation pocket")||n.includes("reactor"))?"localized":t.some(n=>n.includes("radiation")||n.includes("toxic sludge"))?"pervasive":"none"},xl=e=>e>=3?"lockdown":e>=1?"tight":"off",wl=e=>{const t=hl(e.zoneHazards);let n=bl(e.zoneHazards);n==="none"&&e.zoneId&&(e.zoneId.includes("industrial")||e.zoneId.includes("wasteland"))&&(n="localized");const r=yl(e.flags,e.zoneHazards),s=xl(e.flags.curfewLevel),a=`blackout:${e.flags.blackoutTier}`;return[`smog:${t}`,a,`surveillance:${r}`,`radiation:${n}`,`curfew:${s}`]},Jn=e=>e.world.environment,Nt=Y(Jn,e=>e.flags);Y(Nt,e=>e.gangHeat);Y(Nt,e=>e.curfewLevel);Y(Nt,e=>e.supplyScarcity);Y(Nt,e=>e.blackoutTier);Y(Jn,e=>e.notes);const po=e=>e.world.currentMapArea,vl=Y([Nt,po],(e,t)=>({flags:e,zoneHazards:(t==null?void 0:t.hazards)??[],zoneId:(t==null?void 0:t.zoneId)??null})),Sl=Y(vl,e=>wl(e)),mo=Y(Sl,e=>gl(e)),Il=e=>e.length===0?null:[...e].sort((n,r)=>((r==null?void 0:r.updatedAt)??0)-((n==null?void 0:n.updatedAt)??0))[0]??null,kl=e=>e.length===0?null:[...e].sort((n,r)=>((r==null?void 0:r.updatedAt)??0)-((n==null?void 0:n.updatedAt)??0))[0]??null,El=Y([Jn,po,mo],(e,t,n)=>{const r=Object.entries(e.rumorSets).map(([d,p])=>({groupId:d,lines:[...p.lines],storyFunction:p.storyFunction,updatedAt:p.updatedAt})),s=Object.entries(e.signage).map(([d,p])=>{const f=tl(p.variantId);return{signId:d,text:(f==null?void 0:f.text)??"",storyFunction:(f==null?void 0:f.storyFunction)??p.storyFunction,updatedAt:p.updatedAt}}),a=e.weather.presetId?sl(e.weather.presetId):null,l={presetId:e.weather.presetId,description:(a==null?void 0:a.description)??"",storyFunction:(a==null?void 0:a.storyFunction)??e.weather.storyFunction,updatedAt:e.weather.updatedAt,rainIntensity:e.weather.rainIntensity,thunderActive:e.weather.thunderActive,timeOfDay:e.weather.timeOfDay},i={zoneId:(t==null?void 0:t.zoneId)??null,zoneName:(t==null?void 0:t.displayName)??(t==null?void 0:t.name)??null,dangerRating:(t==null?void 0:t.dangerRating)??null,hazards:Array.isArray(t==null?void 0:t.hazards)?[...t.hazards]:[],summary:(t==null?void 0:t.summary)??null,directives:Array.isArray(t==null?void 0:t.objectives)?t.objectives.filter(d=>d&&d.trim().length>0).map(d=>d.trim()):[]};return{flags:{...e.flags},impacts:n,rumor:Il(r),signage:kl(s),weather:l,zone:i}}),go=e=>!!e.settings.reputationSystemsEnabled,ho=e=>e.suspicion,yo=e=>Y(ho,go,(t,n)=>!n||!e?null:t.zones[e]??null),bo=e=>Y(yo(e),t=>t?t.heat:{zoneId:e??"unknown",totalHeat:0,tier:"calm",leadingWitnessIds:[]});Y(ho,go,(e,t)=>t?ii(e.zones):"calm");const Tl=e=>Y(yo(e),t=>{if(!t)return[];const{heat:n,memories:r}=t;return n.leadingWitnessIds.map(s=>r[s]).filter(s=>!!s).map(s=>ai(s))}),bt=e=>e.paranoia,xo=Y(bt,e=>e.value),Cl=Y(bt,e=>e.tier);Y(xo,e=>Math.max(0,Math.min(1,e/100)));Y(bt,e=>e.cooldowns);const Ml=Y(bt,e=>e.lastSnapshot);Y(bt,e=>e.frozen);const Pl=()=>({cameraAlarmedAt:{},guardAlertRank:{},lastCurfewActive:!1,lastLowHealth:!1,lastLowAmmo:!1,lastSafehouse:!1}),Yr=()=>Pl(),Kr=e=>{switch(e){case ge.ALARMED:return 3;case ge.INVESTIGATING:return 2;case ge.SUSPICIOUS:return 1;default:return 0}},Rl=e=>e.type==="motionSensor"?e.motionRadius??e.range:e.range,Al=(e,t)=>{var n,r,s;return e?!!((n=e.zoneId)!=null&&n.toLowerCase().includes("safehouse")||(r=e.name)!=null&&r.toLowerCase().includes("safehouse")||(s=t==null?void 0:t.zoneId)!=null&&s.toLowerCase().includes("safehouse")):!1},Dl=(e,t)=>t<=0?0:Me(e/t,0,1),_l=e=>e>=7?.5:e>=5?.8:1,Ll=(e,t,n,r)=>e!=="day"||t||n>.02?!1:r===0,jl=(e,t)=>{var F;const n=Math.max(0,e.deltaMs)/1e3,r={},s={},a={},l=e.player,i=e.mapArea,d=e.surveillanceZone,p=Math.max(1,l.skills.perception??5),f=Math.max(1,l.skills.endurance??5),u=Math.max(1,l.skills.intelligence??5),h=Math.max(1,l.skills.charisma??5),S=Math.max(1,l.skills.luck??5),x=Me(1+p*.02-f*.03-u*.03-h*.02,.5,1.8),y=1+f*.02+u*.02+S*.01,M=_l(S);if(d&&i){let g=0,v=0;if(Object.values(d.cameras).forEach(E=>{if(!E.isActive||E.alertState===Q.DISABLED)return;const k=Rl(E),w=E.position.x-l.position.x,q=E.position.y-l.position.y,$=Math.hypot(w,q);if($<=be.surveillance.proximityRadius){const le=1-Math.min($/be.surveillance.proximityRadius,1);g+=le*be.surveillance.proximityGainPerSecond*n}if(E.type!=="motionSensor"&&Nn(E.position,l.position,{range:k,angle:E.fieldOfView,direction:E.currentDirection})&&On(E.position,l.position,i)&&(v+=be.surveillance.coneGainPerSecond*n),E.alertState===Q.ALARMED){const le=t.cameraAlarmedAt[E.id]??0;e.timestamp-le>=1e4&&(a[`camera:${E.id}`]=be.surveillance.alertSpike*M,t.cameraAlarmedAt[E.id]=e.timestamp)}}),g>0){const E=Math.min(g,be.surveillance.maxProximityContributionPerSecond*n);r.camerasProximity=E}v>0&&(r.camerasSweep=v)}let P=0;e.enemies.forEach(g=>{if(!i||!g.visionCone){t.guardAlertRank[g.id]=Kr(g.alertLevel);return}(Nn(g.position,l.position,g.visionCone)?On(g.position,l.position,i):!1)&&(P+=1,r[`guardLOS:${g.id}`]=(r[`guardLOS:${g.id}`]??0)+be.guards.lineOfSightGainPerSecond*n);const E=Kr(g.alertLevel),k=t.guardAlertRank[g.id]??0;t.guardAlertRank[g.id]=E,g.alertLevel===ge.ALARMED&&(r[`guardPursuit:${g.id}`]=(r[`guardPursuit:${g.id}`]??0)+be.guards.pursuitGainPerSecond*n),E>=3&&k<3&&(a[`guardChase:${g.id}`]=be.guards.pursuitSpike*M)});let b=0;if(e.zoneHeat){const g=li(((F=e.mapArea)==null?void 0:F.zoneId)??null);b=Dl(e.zoneHeat.totalHeat,g.tierThresholds.crackdown),b>0&&(r.heat=b*be.heat.baselineGainPerSecond*n)}e.timeOfDay==="night"&&(r.night=be.circadian.nightGainPerSecond*n),e.curfewActive&&!t.lastCurfewActive&&(a.curfew=be.circadian.curfewSpike*M),t.lastCurfewActive=e.curfewActive;const N=Math.max(1,l.maxHealth);l.health/N<be.health.criticalThreshold?(r.lowHealth=be.health.sustainedGainPerSecond*n,t.lastLowHealth||(a.lowHealth=be.health.spike*M),t.lastLowHealth=!0):t.lastLowHealth=!1,t.lastLowAmmo=!1,e.environmentImpacts.travel.staminaDrainPerMinute>0&&(r.hazards=(r.hazards??0)+be.hazards.smogGainPerSecond*n),e.environmentImpacts.travel.visibilityMultiplier<.75&&(r.hazards=(r.hazards??0)+be.hazards.blackoutGainPerSecond*n);const L=Al(i,d);L&&(s.safehouse=(s.safehouse??0)+be.safehouse.reliefPerSecond*n,t.lastSafehouse||(s.safehouseEntry=(s.safehouseEntry??0)+be.safehouse.entryRelief)),t.lastSafehouse=L,Ll(e.timeOfDay,e.curfewActive,r.camerasProximity??0,P)&&(s.daylight=(s.daylight??0)+be.circadian.daylightReliefPerSecond*n);const X=1+b,re={};Object.entries(r).forEach(([g,v])=>{if(g==="heat"){re[g]=v;return}re[g]=v*X});const pe={gain:x,decay:y};return Object.keys(a).forEach(g=>{a[g]=a[g]*M}),{gains:re,losses:s,spikes:a,multipliers:pe}},er=e=>!!e.settings.reputationSystemsEnabled,Nl={},tr=e=>e.reputation,Ol=Y(er,tr,(e,t)=>e&&t.debug.heatmapEnabled),wo=Y(tr,er,(e,t)=>t?e.profiles:Nl),zl=e=>Y(wo,t=>t[e]),Fl=(e,t=3)=>Y(wo,n=>{const r=n[e];return r?ci.map(s=>{const a=r.traits[s];return{trait:s,value:(a==null?void 0:a.value)??0,confidence:(a==null?void 0:a.confidence)??0}}).filter(s=>s.value!==0).sort((s,a)=>Math.abs(a.value)-Math.abs(s.value)).slice(0,t):[]}),Bl=Y(er,tr,(e,t)=>e?t.debug.inspectorTargetId??null:null),Wl=()=>{if(typeof process<"u")return"production";if(typeof window<"u"){const e=window;if(typeof e.__VITE_MODE__=="string")return e.__VITE_MODE__}return"development"},Hl=e=>`${Math.round(e*100)}`,$l=e=>e.charAt(0).toUpperCase()+e.slice(1),Tn=e=>{if(!Number.isFinite(e))return"—";const{hour:t,minute:n}=Xs(e,Xn);return`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`},vo=e=>Math.floor(e/24*Xn.cycleDuration),Gl=vo(6),Xr=vo(22),Ul={fontSize:"0.64rem",letterSpacing:"0.18em",textTransform:"uppercase",color:"rgba(226, 232, 240, 0.72)"},Vl={all:"unset",display:"flex",alignItems:"center",justifyContent:"space-between",gap:"0.5rem",width:"100%",marginBottom:"0.35rem",cursor:"pointer",letterSpacing:"0.18em",textTransform:"uppercase",color:"rgba(226, 232, 240, 0.86)"},ql={fontSize:"0.68rem",color:"rgba(148, 163, 184, 0.72)"},Yl={display:"none"},Ye={display:"flex",justifyContent:"space-between",fontSize:"0.78rem",marginBottom:"0.22rem"},Qr={listStyle:"none",margin:0,padding:0,display:"grid",gap:"0.35rem"},Zr={padding:"0.45rem 0.55rem",borderRadius:"0.55rem",backgroundColor:"rgba(24, 36, 52, 0.78)",border:"1px solid rgba(70, 104, 150, 0.3)"},Kl={display:"flex",flexDirection:"column",alignItems:"flex-start",gap:"0.5rem",pointerEvents:"auto"},Xl={all:"unset",display:"inline-flex",alignItems:"center",gap:"0.45rem",padding:"0.45rem 0.85rem",borderRadius:"999px",border:"1px solid rgba(59, 130, 246, 0.42)",background:"linear-gradient(135deg, rgba(15, 23, 42, 0.92), rgba(30, 41, 59, 0.92))",color:"#e2e8f0",fontFamily:'"DM Mono","IBM Plex Mono",monospace',fontSize:"0.62rem",letterSpacing:"0.2em",textTransform:"uppercase",cursor:"pointer",transition:"transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease"},Ke={all:"unset",display:"inline-flex",alignItems:"center",justifyContent:"center",padding:"0.35rem 0.65rem",borderRadius:"0.55rem",border:"1px solid rgba(148, 163, 184, 0.45)",background:"rgba(15, 23, 42, 0.88)",color:"rgba(226, 232, 240, 0.92)",fontSize:"0.58rem",letterSpacing:"0.18em",textTransform:"uppercase",cursor:"pointer"},Ql={padding:"0.85rem 1rem",borderRadius:"0.85rem",backgroundColor:"rgba(12, 18, 28, 0.9)",color:"#f1f5ff",backdropFilter:"blur(6px)",border:"1px solid rgba(59, 130, 246, 0.38)",width:"min(360px, 28vw)",display:"grid",gap:"0.75rem",fontFamily:'"DM Mono","IBM Plex Mono",monospace',boxShadow:"0 18px 40px rgba(15, 23, 42, 0.32)",zIndex:5},Zl=[],So=({zoneId:e,rendererInfo:t})=>{const n=Le(),r=e??"unknown",s=c.useMemo(()=>bo(r),[r]),a=c.useMemo(()=>Tl(r),[r]),l=C(Ol),i=C(Bl),d=C(D=>D.world.currentMapArea.entities.npcs),p=C(D=>D.world.currentMapArea),f=C(D=>D.settings.testMode),u=C(D=>!!D.settings.reputationSystemsEnabled),h=c.useMemo(()=>i?zl(i):null,[i]),S=c.useMemo(()=>i?Fl(i,4):null,[i]),x=C(D=>h?h(D):null),y=C(D=>S?S(D):Zl),[M,P]=c.useState({renderer:!1,time:!1,suspicion:!1,reputation:!1,paranoia:!1}),b={renderer:"Renderer diagnostics",time:"Time/lighting debug",suspicion:"Suspicion snapshot",reputation:"Reputation debug",paranoia:"Paranoia debug"},[N,_]=c.useState(null),[H,L]=c.useState(null),X=c.useCallback(D=>{P(ce=>({...ce,[D]:!ce[D]}))},[]);c.useEffect(()=>{!i&&d.length>0&&n(Ir(d[0].id))},[n,i,d]);const re=c.useCallback(()=>{const D=Gl;n(kr(D)),L(`Set to day (${Tn(D)})`)},[n]),pe=c.useCallback(()=>{n(kr(Xr)),L(`Set to night (${Tn(Xr)})`)},[n]),F=c.useMemo(()=>d.find(D=>D.id===i),[d,i]),[g,v]=c.useState(!0),E=Wl(),k=C(D=>s(D)),w=C(D=>a(D)),q=C(D=>bt(D)),$=C(Ml),le=C(D=>D.world.currentTime),fe=C(D=>D.world.timeOfDay),he=c.useCallback(()=>{if(!u){_("Reputation systems are disabled for MVP.");return}if(!i||!p){_("Select an NPC inside the current map to seed a sample event.");return}const D=d.find(ce=>ce.id===i);if(!D){_("Selected NPC is no longer present in this area.");return}n(di({actorId:"player",actorLabel:"Player",zoneId:p.zoneId??"zone::debug",position:{...D.position},intensity:"legendary",traits:{heroic:28,intimidating:8},tags:["debug_sample"],mapArea:p,npcsOverride:[D],ambientLighting:1,ambientNoise:.8,disguisePenalty:0,timestamp:Date.now()})),_(`Seeded a heroic event around ${D.name}. If nothing appears, try again nearby or toggle the reputation heatmap.`)},[n,i,p,d,u]);if(c.useEffect(()=>{N&&y.length>0&&_(null)},[N,y.length]),E==="production"||!f)return null;const V="command-debug-panel",J=(t==null?void 0:t.label)??"Detecting…",ae=(t==null?void 0:t.detail)??"Negotiating renderer",me=g?"Show Debug Panel":"Hide Debug Panel",se=(D,ce,ke,z)=>{const Re=M[D],Be=`${V}-${z}`,st=typeof ce=="string"?ce:b[D];return o.jsxs("section",{children:[o.jsxs("button",{type:"button",style:Vl,onClick:()=>X(D),"aria-expanded":!Re,"aria-controls":Be,"aria-label":`${Re?"Expand":"Collapse"} ${st}`,children:[o.jsx("span",{style:Ul,children:ce}),o.jsx("span",{style:ql,children:Re?"▸":"▾"})]}),o.jsx("div",{id:Be,style:Re?Yl:void 0,"aria-hidden":Re,children:Re?null:ke()})]})};return o.jsxs("div",{style:Kl,children:[o.jsxs("button",{type:"button",style:Xl,onClick:()=>v(D=>!D),"aria-expanded":!g,"aria-controls":V,children:[o.jsx("span",{children:me}),o.jsx("span",{style:{fontSize:"0.58rem",letterSpacing:"0.2em",textTransform:"uppercase",opacity:.75},children:J})]}),!g&&o.jsxs("div",{id:V,style:Ql,role:"region","aria-label":"Debug Panel",children:[se("renderer","Renderer Diagnostics",()=>o.jsxs(o.Fragment,{children:[o.jsxs("div",{style:Ye,children:[o.jsx("span",{children:"Mode"}),o.jsx("span",{children:J})]}),o.jsxs("div",{style:{...Ye,alignItems:"flex-start"},children:[o.jsx("span",{children:"Detail"}),o.jsx("span",{style:{textAlign:"right",maxWidth:"18rem"},children:ae})]}),o.jsxs("div",{style:Ye,children:[o.jsx("span",{children:"Phaser"}),o.jsx("span",{children:Fe.VERSION})]})]}),"renderer"),se("time","Time & Lighting",()=>o.jsxs(o.Fragment,{children:[o.jsxs("div",{style:Ye,children:[o.jsx("span",{children:"Current"}),o.jsxs("strong",{children:[Tn(le)," · ",fe]})]}),o.jsxs("div",{style:Ye,children:[o.jsx("span",{children:"Cycle Duration"}),o.jsxs("strong",{children:[Xn.cycleDuration,"s"]})]}),o.jsxs("div",{style:{display:"flex",gap:"0.35rem",flexWrap:"wrap"},children:[o.jsx("button",{type:"button",style:Ke,onClick:re,children:"Set Day"}),o.jsx("button",{type:"button",style:Ke,onClick:pe,children:"Set Night"})]}),H&&o.jsx("div",{style:{fontSize:"0.62rem",color:"rgba(96, 165, 250, 0.8)"},children:H})]}),"time"),u&&se("suspicion",`Suspicion Snapshot · ${r}`,()=>o.jsxs(o.Fragment,{children:[o.jsxs("div",{style:Ye,children:[o.jsx("span",{children:"Heat Tier"}),o.jsx("span",{children:k.tier})]}),o.jsxs("div",{style:Ye,children:[o.jsx("span",{children:"Total Heat"}),o.jsx("span",{children:k.totalHeat.toFixed(2)})]}),w.length>0?o.jsx("ul",{style:Qr,children:w.map(D=>o.jsxs("li",{style:Zr,children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.72rem",marginBottom:"0.18rem"},children:[o.jsx("span",{children:D.witnessLabel??D.witnessId}),o.jsxs("span",{children:[Hl(D.certainty),"%"]})]}),o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.68rem",opacity:.75},children:[o.jsx("span",{children:D.recognitionChannel}),o.jsx("span",{children:D.reported?"reported":"unreported"})]})]},D.id))}):o.jsx("div",{style:{fontSize:"0.7rem",opacity:.65},children:"No active witnesses."})]}),"suspicion"),u&&se("reputation",`Reputation Debug · ${(F==null?void 0:F.name)??"Local Cell"}`,()=>o.jsxs(o.Fragment,{children:[o.jsx("div",{style:{display:"flex",gap:"0.4rem",flexWrap:"wrap",marginBottom:"0.45rem"},children:o.jsx("button",{type:"button",style:{...Ke,borderColor:l?"rgba(96, 165, 250, 0.65)":Ke.border},onClick:()=>n(ui(!l)),children:l?"Hide Heatmap":"Show Heatmap"})}),o.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"0.35rem",marginBottom:"0.45rem"},children:d.length?d.map(D=>o.jsx("button",{type:"button",style:{...Ke,borderColor:i===D.id?"rgba(96, 165, 250, 0.65)":Ke.border},onClick:()=>n(Ir(D.id)),"aria-pressed":i===D.id,children:D.name},D.id)):o.jsx("span",{style:{fontSize:"0.68rem",opacity:.6},children:"No NPCs in this map."})}),o.jsx("div",{style:{fontSize:"0.62rem",color:"rgba(148, 163, 184, 0.75)",marginBottom:"0.35rem"},children:"1) Pick an NPC in the active cell. 2) Trigger an in-game action or use the seed button below. 3) Inspect the traits that populate here and toggle the heatmap to see cell sentiment."}),x?y.length?o.jsx("ul",{style:Qr,children:y.map(D=>{const ce=x.traits[D.trait],ke=(ce==null?void 0:ce.sources)??[];return o.jsxs("li",{style:Zr,children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.7rem",marginBottom:"0.18rem"},children:[o.jsx("span",{children:$l(D.trait)}),o.jsx("span",{children:D.value.toFixed(1)})]}),o.jsxs("div",{style:{fontSize:"0.64rem",opacity:.72},children:["Confidence ",Math.round(D.confidence*100),"%"]}),ke.length?o.jsxs("div",{style:{fontSize:"0.62rem",opacity:.62,marginTop:"0.2rem"},children:["Rumors: ",ke.slice(0,3).join(", ")]}):o.jsx("div",{style:{fontSize:"0.62rem",opacity:.45,marginTop:"0.2rem"},children:"No rumor sources tracked."})]},D.trait)})}):o.jsxs("div",{style:{display:"grid",gap:"0.35rem"},children:[o.jsx("div",{style:{fontSize:"0.68rem",opacity:.6},children:"No localized reputation yet. Trigger a nearby event so NPCs can witness something."}),o.jsx("button",{type:"button",onClick:he,style:{...Ke,borderColor:"rgba(96, 165, 250, 0.55)",justifyContent:"center"},disabled:!p,children:"Seed Sample Heroic Event"}),N&&o.jsx("div",{style:{fontSize:"0.62rem",color:"rgba(96, 165, 250, 0.8)"},children:N})]}):o.jsxs("div",{style:{display:"grid",gap:"0.35rem"},children:[o.jsx("div",{style:{fontSize:"0.68rem",opacity:.6},children:"Select an NPC to inspect reputation."}),o.jsx("button",{type:"button",onClick:he,style:{...Ke,borderColor:"rgba(96, 165, 250, 0.55)",justifyContent:"center"},disabled:!p,children:"Seed Sample Heroic Event"}),N&&o.jsx("div",{style:{fontSize:"0.62rem",color:"rgba(96, 165, 250, 0.8)"},children:N})]})]}),"reputation"),se("paranoia",`Paranoia Debug · ${q.tier}`,()=>o.jsxs(o.Fragment,{children:[o.jsxs("div",{style:Ye,children:[o.jsx("span",{children:"Value"}),o.jsx("span",{children:q.value.toFixed(1)})]}),$?o.jsxs("div",{style:{display:"grid",gap:"0.3rem",fontSize:"0.72rem"},children:[o.jsxs("div",{children:[o.jsx("strong",{style:{opacity:.8},children:"Δ"})," ",$.delta>=0?"+":"",$.delta.toFixed(3)]}),o.jsxs("div",{children:[o.jsx("strong",{style:{opacity:.8},children:"Gains"})," ",Object.keys($.breakdown.gains).length===0?"—":Object.entries($.breakdown.gains).map(([D,ce])=>`${D}:${ce.toFixed(3)}`).join(" | ")]}),o.jsxs("div",{children:[o.jsx("strong",{style:{opacity:.8},children:"Losses"})," ",Object.keys($.breakdown.losses).length===0?"—":Object.entries($.breakdown.losses).map(([D,ce])=>`${D}:${ce.toFixed(3)}`).join(" | ")]}),o.jsxs("div",{children:[o.jsx("strong",{style:{opacity:.8},children:"Spikes"})," ",Object.keys($.breakdown.spikes).length===0?"—":Object.entries($.breakdown.spikes).map(([D,ce])=>`${D}:${ce.toFixed(3)}`).join(" | ")]})]}):o.jsx("div",{style:{fontSize:"0.7rem",opacity:.65},children:"No recent paranoia stimuli."})]}),"paranoia")]})]})},Jl=e=>e.world.engagementMode,Io=e=>e.player.data.stealthModeEnabled,nr=e=>e.player.data.stealthCooldownExpiresAt,an=e=>e.quests.activeDialogue.dialogueId,ko=Y([e=>e.world.inCombat,an,nr],(e,t,n)=>!(e||t||typeof n=="number"&&n>Date.now())),ec=e=>{switch(e){case ge.ALARMED:return 3;case ge.INVESTIGATING:return 2;case ge.SUSPICIOUS:return 1;case ge.IDLE:default:return 0}},tc=e=>{switch(e){case Q.ALARMED:return 3;case Q.INVESTIGATING:return 2;case Q.SUSPICIOUS:return 1;case Q.IDLE:case Q.DISABLED:default:return 0}},nc=Y([e=>e.world.currentMapArea.entities.enemies],e=>{let t=0,n=0;return e.forEach(r=>{const s=ec(r.alertLevel);s>t&&(t=s);const a=r.alertProgress??0;a>n&&(n=a)}),{maxRank:t,maxProgress:Math.max(0,Math.min(100,Math.round(n)))}}),Eo=Y([Io,Jl,ko,nr,e=>e.world.inCombat,an,e=>e.surveillance.hud,nc,e=>e.player.data.movementProfile],(e,t,n,r,s,a,l,i,d)=>{const p=Date.now(),f=typeof r=="number"&&r>p,u=typeof r=="number"?r:null,h=tc(l.alertState),S=i.maxRank,x=h>0||l.detectionProgress>0||!!l.activeCameraId,y=S>0,M=e&&t==="stealth",P=Math.max(Math.round(l.detectionProgress??0),i.maxProgress);return s?{state:"compromised",reason:"combat",severity:Math.max(P,100),stealthActive:M,onCooldown:f,cooldownExpiresAt:u}:a?{state:M?"exposed":"standby",reason:"dialogue",severity:P,stealthActive:M,onCooldown:f,cooldownExpiresAt:u}:M?h>=3||S>=3?{state:"compromised",reason:h>=3?"camera":d==="sprint"?"noise":"vision",severity:Math.max(P,80),stealthActive:M,onCooldown:f,cooldownExpiresAt:u}:x||y||P>=30?{state:"exposed",reason:x?"camera":d==="sprint"?"noise":"vision",severity:Math.max(P,30),stealthActive:M,onCooldown:f,cooldownExpiresAt:u}:{state:"hidden",reason:"none",severity:P,stealthActive:M,onCooldown:f,cooldownExpiresAt:u}:f||!n?{state:"compromised",reason:"cooldown",severity:P,stealthActive:M,onCooldown:f,cooldownExpiresAt:u}:{state:"standby",reason:"none",severity:P,stealthActive:M,onCooldown:f,cooldownExpiresAt:u}});Y([Eo],e=>e.stealthActive&&e.state==="hidden");const rc=Y([Eo,e=>e.world.inCombat,an],(e,t,n)=>{const r=Date.now(),s=e.onCooldown&&e.cooldownExpiresAt?Math.max(1,Math.ceil((e.cooldownExpiresAt-r)/1e3)):0,a=t?"combat":n?"dialogue":e.onCooldown||e.reason==="cooldown"?"cooldown":null,l=e.stealthActive,i=l||a===null;let d="ready";return a==="combat"?d="combat":a==="dialogue"?d="dialogue":a==="cooldown"?d=s>0?`cooldown:${s}`:"cooldown":l&&e.reason!=="none"&&(d=`${e.reason}:${Math.max(0,Math.min(100,Math.round(e.severity)))}`),{isActive:l,stateLabel:e.state,detailLabel:d,canToggle:i,blockedReason:a,severity:Math.max(0,Math.min(100,Math.round(e.severity))),keyHint:"X",reason:e.reason,cooldownSeconds:s}}),sc=Y([Io,ko,nr],(e,t,n)=>({enabled:e,eligible:t,cooldownExpiresAt:typeof n=="number"?n:null,onCooldown:typeof n=="number"&&n>Date.now()})),oc=e=>{switch(e){case"on_edge":return 1.1;case"panicked":return 1.2;case"breakdown":return 1.3;default:return 1}},ic=4500,Cn=e=>{switch(e){case ge.SUSPICIOUS:return 1;case ge.INVESTIGATING:return 2;case ge.ALARMED:return 3;default:return 0}},ac={silent:{radius:2,gain:0},normal:{radius:4,gain:4},sprint:{radius:6,gain:8}},lc=e=>e.reduce((t,n)=>{const r=Array.isArray(n.tags)?n.tags:[],s=n.stackable?n.quantity??1:1;return r.includes("paranoia:calmtabs")&&(t.calmTabs+=s),r.includes("paranoia:cigarettes")&&(t.cigarettes+=s),t},{calmTabs:0,cigarettes:0}),To=e=>e.stackable?Math.max(1,e.quantity??1):1,Co=(e,t)=>e.type!=="collect"||e.isCompleted?!1:e.targetResourceKey&&t.resourceKey?e.targetResourceKey===t.resourceKey:e.target===t.name,cc=(e,t)=>t.reduce((n,r)=>Co(e,r)?n+To(r):n,0),Yt=1.5,dc=(e,t,n)=>{var f;if(!e||!t||!Array.isArray(e.buildings)||e.buildings.length===0)return{available:!1,note:"No workbench nearby"};const{x:r,y:s}=t.position,a=e.buildings.find(u=>{if(!u.workbench)return!1;const{from:h,to:S}=u.footprint;return r>=h.x-Yt&&r<=S.x+Yt&&s>=h.y-Yt&&s<=S.y+Yt});if(!a||!a.workbench)return{available:!1,note:"No workbench nearby"};let l=!1;if(n){const u=Qn(((f=t.factionReputation)==null?void 0:f.scavengers)??0);l=u.id==="friendly"||u.id==="allied"}const i=a.workbench.type==="market"&&(!n||!l)?a.workbench.feeRequired??50:void 0,d=i?t.credits>=i:!0,p=i&&!d?n?`Requires ${i} credits or Friendly scavenger standing`:`Requires ${i} credits`:i?n?"Fee applies if scavenger standing is below Friendly":"Market workbench fee applies":void 0;return{available:d,locationName:a.name,type:a.workbench.type,feeRequired:i,note:p}},uc=()=>{var br;const e=c.useMemo(()=>Qs("GameController"),[]),t=Le(),n=Uo(),r=C(m=>m.player.data),s=r.encumbrance.level,a=r.encumbrance.warning,l=r.encumbrance.percentage,i=C(m=>m.world.currentMapArea),d=i==null?void 0:i.entities.items,p=i==null?void 0:i.id,f=(i==null?void 0:i.isInterior)??!1,u=C(m=>m.world.inCombat),h=C(m=>m.world.isPlayerTurn),S=C(m=>m.world.timeOfDay),x=C(m=>m.world.curfewActive),y=C(m=>m.world.currentMapArea.entities.enemies),M=C(m=>m.world.mapAreas),P=C(m=>m.world.mapConnections),b=C(m=>m.world),N=C(m=>m.quests.quests),_=C(m=>m.quests.dialogues),H=c.useMemo(()=>N.map(m=>`${m.id}:${m.isActive?1:0}:${m.isCompleted?1:0}`).join("|"),[N]),L=C(an),X=C(m=>m.settings.locale),re=C(m=>m.settings.autoBattleEnabled),pe=C(m=>m.settings.autoBattleProfile),F=C(sc),g=F.cooldownExpiresAt,v=F.eligible,E=typeof g=="number",k=C(m=>m.world.engagementMode),w=C(m=>m.world.stealthToggleRequestNonce),q=C(m=>m.settings.autoStealthEnabled),$=C(m=>!!m.settings.reputationSystemsEnabled),le=C(m=>m.world.turnCount),fe=C(m=>m.world.globalAlertLevel),he=C(m=>m.world.reinforcementsScheduled),V=C(m=>p?m.surveillance.zones[p]:void 0),J=C(m=>m.surveillance.hud.overlayEnabled),ae=C(mo),me=C(m=>m.world.environment.flags),se=C(m=>m.world.currentTime),D=C(Cl),ce=c.useMemo(()=>bo((i==null?void 0:i.zoneId)??null),[i==null?void 0:i.zoneId]),ke=C(m=>ce(m)),z=c.useMemo(()=>Xe(X).logs,[X]),Re=c.useMemo(()=>je(X),[X]),Be=c.useMemo(()=>Re.autoBattle,[Re]),st=c.useMemo(()=>Math.max(220,Math.round(320*ae.behavior.routineIntervalMultiplier)),[ae.behavior.routineIntervalMultiplier]),ot=c.useMemo(()=>Math.max(750,Math.round(fi()*ae.faction.reinforcementDelayMultiplier)),[ae.faction.reinforcementDelayMultiplier]),xt=c.useRef(u),wt=c.useRef(S),vt=c.useRef(fe),Qe=c.useRef(void 0),Ue=c.useRef(r),it=c.useRef(i??null),Ot=c.useRef(he),at=c.useRef(va()),Oe=c.useRef(null),T=c.useRef(null),B=c.useRef(fe),oe=c.useRef(S),ee=c.useRef(L),ye=c.useRef(J),de=c.useRef(se),we=c.useRef(null),ve=c.useRef(null),lt=c.useRef(new Map),ze=c.useRef(null),dn=c.useRef(N),St=c.useRef(null),ar=c.useRef(Yr()),lr=c.useRef(D),cr=c.useRef(ke),dr=c.useRef(0),un=c.useRef(w),ur=c.useRef({calmTabs:0,cigarettes:0}),Fo=((br=b.workbenchStatus)==null?void 0:br.available)!==void 0?{...b.workbenchStatus}:{available:b.workbenchAvailable??!1,note:b.workbenchAvailable?void 0:"No workbench nearby"},fr=c.useRef(Fo),[De,ct]=c.useState(0),zt=c.useRef(null),Ft=c.useRef(null),We=c.useRef(null),[Bt,Ve]=c.useState("clear"),[Ae,Se]=c.useState([]),dt=c.useRef(new Set),It=c.useRef([]),Ze=c.useRef(new Map),Wt=c.useRef(null),[fn,Ee]=c.useState(null),[pn,Te]=c.useState(null),Ht=c.useCallback(m=>{var R;if(!m.isInteractive||!m.dialogueId)return t(O(z.npcNotReady(m.name))),!1;if(L===m.dialogueId)return!0;const I=_.find(j=>j.id===m.dialogueId);if(!I||I.nodes.length===0)return t(O(z.npcNoNewInfo(m.name))),!1;const A=(R=I.nodes[0])==null?void 0:R.id;return A?(t(Er({dialogueId:I.id,nodeId:A})),t(O(z.npcChannelOpened(m.name))),!0):(t(O(z.npcChannelEmpty(m.name))),!1)},[t,_,L,z]),ut=c.useCallback((m={})=>{const{sprint:I=!1}=m;if(u)return!0;if(I&&r.isExhausted)return t(O(z.tooTiredToSprint)),!1;let R=l>=80?Tr.strenuousInteraction:0;return I&&(R+=Tr.sprintTile),R<=0?(r.stamina<r.maxStamina&&t(pi(void 0)),!0):r.stamina<R?(t(O(z.notEnoughStamina(R,r.stamina))),!1):(t(mi(R)),!0)},[l,t,u,z,r.isExhausted,r.stamina,r.maxStamina]),_e=c.useCallback((m=!0)=>{m&&zt.current!==null&&window.clearTimeout(zt.current),zt.current=null,Ft.current=null},[]),ft=c.useRef(null),kt=()=>typeof performance<"u"?performance.now():Date.now(),pr=()=>Date.now(),mr=c.useCallback(()=>{var m;t(gn({enabled:!0,cooldownExpiresAt:null})),((m=Ue.current)==null?void 0:m.movementProfile)!=="silent"&&t(hn("silent"))},[t]),pt=c.useCallback(m=>{var A;const I=pr();t(gn({enabled:!1,cooldownExpiresAt:m?I+ic:null})),((A=Ue.current)==null?void 0:A.movementProfile)==="silent"&&t(hn("normal"))},[t]),$t=c.useCallback(m=>{const I=Ue.current;if(I){if(e.debug("Stealth toggle requested",{source:m}),I.stealthModeEnabled){pt(!1),t(yn("none")),t(O(z.stealthDisengaged));return}if(!v){if(u){t(O(z.stealthUnavailableCombat));return}if(ee.current){t(O(z.stealthUnavailableDialogue));return}if(E&&typeof g=="number"){const A=Date.now(),R=Math.max(0,g-A);if(R>0){const j=Math.ceil(R/1e3);t(O(z.stealthCooldown(j)))}}return}mr(),t(yn("stealth")),t(O(z.stealthEngaged))}},[pt,t,mr,u,e,z,g,v,E]);c.useEffect(()=>{Qe.current=V},[V]),c.useEffect(()=>{lr.current=D},[D]),c.useEffect(()=>{cr.current=ke},[ke]),c.useEffect(()=>{Ue.current=r},[r]),c.useEffect(()=>{ee.current=L},[L]),c.useEffect(()=>{dn.current=N},[N]),c.useEffect(()=>{it.current=i??null},[i]),c.useEffect(()=>{if(!d||d.length===0)return;const m=d.filter(A=>{var R,j;return((R=A.position)==null?void 0:R.x)===r.position.x&&((j=A.position)==null?void 0:j.y)===r.position.y});if(m.length===0)return;const I=dn.current.filter(A=>A.isActive&&!A.isCompleted);m.forEach(A=>{var G,ie;const R=To(A),j=gi(A);t(Zs(A)),t(hi({id:A.id,position:A.position,name:A.name})),window.dispatchEvent(new CustomEvent(yi,{detail:{areaId:i.id,itemId:A.id,position:A.position}})),t(Mt({id:He(),value:R,gridX:((G=A.position)==null?void 0:G.x)??r.position.x,gridY:((ie=A.position)==null?void 0:ie.y)??r.position.y,type:"pickup",label:j})),t(O(z.itemPickedUp(j,R))),I.forEach(W=>{W.objectives.forEach(U=>{Co(U,A)&&t(Cr({questId:W.id,objectiveId:U.id,count:R}))})})})},[t,d,r.position,z,i==null?void 0:i.id]),c.useEffect(()=>{const m=dn.current.filter(A=>A.isActive&&!A.isCompleted);if(m.length===0)return;const I=r.inventory.items??[];I.length!==0&&m.forEach(A=>{A.objectives.forEach(R=>{if(R.type!=="collect"||R.isCompleted)return;const j=cc(R,I);if(j<=0)return;const G=R.count??1,ie=R.currentCount??0,U=Math.min(j,G)-ie;U<=0||t(Cr({questId:A.id,objectiveId:R.id,count:U}))})})},[t,r.inventory.items,H]),c.useEffect(()=>{const m=Qe.current??V,I=Ue.current,R=y.reduce((U,ue)=>{const te=Cn(ue.alertLevel);return te>U?te:U},0)>=3,G=(m?Object.values(m.cameras):[]).some(U=>U.alertState===Q.ALARMED),ie=pr();!(I!=null&&I.stealthModeEnabled)&&(I!=null&&I.stealthCooldownExpiresAt)&&I.stealthCooldownExpiresAt<=ie&&t(gn({enabled:!1,cooldownExpiresAt:null}));let W="none";u?(W="combat",I!=null&&I.stealthModeEnabled&&(pt(!0),t(O(z.stealthCompromised)))):ee.current?(W="dialog",I!=null&&I.stealthModeEnabled&&pt(!1)):I!=null&&I.stealthModeEnabled&&(R||G?(pt(!0),t(O(z.stealthCompromised))):W="stealth"),k!==W&&t(yn(W))},[L,pt,t,k,y,u,z,V]),c.useEffect(()=>{ar.current=Yr()},[p]),c.useEffect(()=>{if(!i){lt.current=new Map(y.map(A=>[A.id,A]));return}const m=new Map(y.map(A=>[A.id,A]));if(!$){lt.current=m;return}lt.current.forEach((A,R)=>{const j=m.get(R);(!j||j.health<=0)&&t(bi({witnessId:R,zoneId:i.zoneId}))}),lt.current=m},[y,i,t,$]),c.useEffect(()=>{Ot.current=he},[he]),c.useEffect(()=>{!he&&Oe.current!==null&&(at.current.cancel(Oe.current),Oe.current=null)},[he]),c.useEffect(()=>{const m=lc(r.inventory.items??[]),I=ur.current;ur.current=m;const A=kt();m.calmTabs<I.calmTabs&&t(Mr({amount:be.calmTabs.relief,timestamp:A,cooldownKey:"calmTabs",cooldownMs:be.calmTabs.cooldownMs})),m.cigarettes<I.cigarettes&&(t(Mr({amount:be.cigarettes.relief,timestamp:A})),t(xi({amountPerSecond:be.cigarettes.decayBoostPerSecond,durationMs:be.cigarettes.durationMs,timestamp:A})))},[r.inventory.items,t]),c.useEffect(()=>{B.current=fe},[fe]),c.useEffect(()=>{oe.current=S},[S]),c.useEffect(()=>{ye.current=J},[J]),c.useEffect(()=>{de.current=se},[se]),c.useEffect(()=>{St.current||(St.current=new wi(t,n))},[t,n]),c.useEffect(()=>{St.current&&St.current.update({enabled:re,profileId:pe,player:r,enemies:y,mapArea:i??null,inCombat:u,isPlayerTurn:h,turnCount:le,activeDialogueId:L,logStrings:z,autoBattleStrings:Be})},[re,pe,r,y,i,u,h,le,L,z,Be]),c.useEffect(()=>{ft.current&&ft.current.focus();const m=I=>{if(!ft.current)return;const A=I.target;A instanceof Element&&(ft.current.contains(A)||A.closest('[data-controller-focus-ignore="true"]'))||ft.current.focus()};return document.addEventListener("click",m),()=>{document.removeEventListener("click",m)}},[]),c.useEffect(()=>{const m=it.current;if(!m||!p)return;ve.current!==null&&(window.clearTimeout(ve.current),ve.current=null);const I=we.current;I&&I!==p&&Br({areaId:I,dispatch:t});const A=Qe.current;return(!A||A.areaId!==p)&&Ua({area:m,timeOfDay:oe.current,dispatch:t,timestamp:kt()}),we.current=p,()=>{const R=we.current;R&&(ve.current=window.setTimeout(()=>{Br({areaId:R,dispatch:t}),we.current=null,ve.current=null},0))}},[p,t]),c.useEffect(()=>{if(!i||!p)return;const m=Qe.current??V;m&&Va({zone:m,area:i,timeOfDay:S,dispatch:t,timestamp:kt()})},[S,p,V,i,t]),c.useEffect(()=>{const m=I=>{if(I.defaultPrevented)return;const A=I.target;if(!(A instanceof Element&&A.closest('[data-controller-focus-ignore="true"]'))){if(I.key==="Tab"){if(I.preventDefault(),I.repeat)return;t(Li({enabled:!ye.current}));return}if(I.key.toLowerCase()==="x"){if(I.repeat)return;I.preventDefault(),$t("keyboard")}}};return window.addEventListener("keydown",m),()=>{window.removeEventListener("keydown",m)}},[t,$t]),c.useEffect(()=>{if(w<=un.current){un.current=w;return}un.current=w,$t("hudButton")},[$t,w]),c.useEffect(()=>{if(!p||typeof window>"u")return;cl();let m=null,I=kt();const A=()=>{const R=Qe.current,j=it.current,G=Ue.current,ie=kt(),W=ie-I;I=ie;const ue=n.getState().world;if(j&&G){const te=$?cr.current:null,Z=jl({player:G,enemies:j.entities.enemies,mapArea:j,surveillanceZone:R,zoneHeat:te,environmentImpacts:ae,timeOfDay:ue.timeOfDay,curfewActive:ue.curfewActive,worldTimeSeconds:ue.currentTime,deltaMs:W,timestamp:ie},ar.current),K=Object.values(Z.gains).reduce((qe,mt)=>qe+mt,0),ne=Object.values(Z.losses).reduce((qe,mt)=>qe+mt,0),Ie=Object.values(Z.spikes).reduce((qe,mt)=>qe+mt,0),Et=K*Z.multipliers.gain-ne+Ie;(Et!==0||K>0||ne>0||Ie!==0)&&t(ji({timestamp:ie,delta:Et,deltaMs:W,breakdown:{gains:Z.gains,losses:Z.losses,spikes:Z.spikes}})),t(Ni({deltaMs:W,timestamp:ie,decayMultiplier:Z.multipliers.decay}))}if(R&&j&&G){const te=$?Z=>{t(_r(Z)),e.debug(`Suspicion: camera ${Z.witnessId} reported player in ${Z.zoneId} (${Z.recognitionChannel})`)}:void 0;qa({zone:R,mapArea:j,player:G,deltaMs:W,timestamp:ie,dispatch:t,logStrings:z,reinforcementsScheduled:Ot.current??!1,globalAlertLevel:B.current??ge.IDLE,timeOfDay:ue.timeOfDay,environmentFlags:ue.environment.flags,worldTimeSeconds:ue.currentTime,onWitnessObservation:te})}if(!u&&k==="stealth"&&q&&j&&G){const te=xa();te&&t(O(`[Auto-Stealth]: ${te.summary}`))}if(j&&G){const te=dc(j,G,$),Z=fr.current;(Z.available!==te.available||Z.type!==te.type||Z.locationName!==te.locationName||Z.feeRequired!==te.feeRequired||Z.note!==te.note)&&(fr.current=te,t(Oi(te)))}Xa(t,n.getState),m=window.requestAnimationFrame(A)};return m=window.requestAnimationFrame(A),()=>{m!==null&&window.cancelAnimationFrame(m)}},[p,t,z,n,e,ae,q,k,u,$]),c.useEffect(()=>{const m=I=>{const R=I.detail;if(!R||!i||R.areaId!==i.id||u)return;const j=R.position;if(Ee(null),Te(null),j.x===r.position.x&&j.y===r.position.y){Se([]),Te(null);return}const G=i.entities.npcs.find(U=>U.position.x===j.x&&U.position.y===j.y);if(G){if(u){t(O(z.combatChatterOverrides));return}if(Math.abs(G.position.x-r.position.x)+Math.abs(G.position.y-r.position.y)<=1){Ht(G);return}const ue=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}];let te=null;for(const Z of ue){const K={x:G.position.x+Z.x,y:G.position.y+Z.y};if(K.x===r.position.x&&K.y===r.position.y||K.x<0||K.y<0||K.x>=i.width||K.y>=i.height||!Ut(K,i,r,y,{npcs:i.entities.npcs}))continue;const ne=Pt(r.position,K,i,{player:r,enemies:y,npcs:i.entities.npcs});if(ne.length>0){te=ne;break}}te?(Ee(G.id),Se(te)):t(O(z.npcBoxedIn(G.name)));return}const ie=i.entities.enemies.find(U=>U.position.x===j.x&&U.position.y===j.y&&U.health>0);if(ie){if(Math.abs(ie.position.x-r.position.x)+Math.abs(ie.position.y-r.position.y)<=1){u||(t(Rt()),t(O(z.enteredCombat)));return}const ue=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}];let te=null;for(const Z of ue){const K={x:ie.position.x+Z.x,y:ie.position.y+Z.y};if(K.x===r.position.x&&K.y===r.position.y||K.x<0||K.y<0||K.x>=i.width||K.y>=i.height||!Ut(K,i,r,y,{npcs:i.entities.npcs}))continue;const ne=Pt(r.position,K,i,{player:r,enemies:y,npcs:i.entities.npcs});if(ne.length>0){te=ne;break}}te?(Te(ie.id),Se(te)):t(O(z.enemyOutOfRange));return}const W=Pt(r.position,j,i,{player:r,enemies:y,npcs:i.entities.npcs});if(W.length===0){window.dispatchEvent(new CustomEvent(bn,{detail:{areaId:i.id,path:[]}})),Te(null);return}Se(W)};return window.addEventListener(Pr,m),()=>{window.removeEventListener(Pr,m)}},[i,r,y,u,t,Ht,P,z]),c.useEffect(()=>{i&&window.dispatchEvent(new CustomEvent(bn,{detail:{areaId:i.id,path:Ae}}))},[Ae,i]),c.useEffect(()=>{if(!i)return;const m=I=>{const A=I.detail;if(!A||A.areaId!==i.id)return;const R=Pt(r.position,A.target,i,{player:r,enemies:y,npcs:i.entities.npcs});Se(R),window.dispatchEvent(new CustomEvent(bn,{detail:{areaId:i.id,path:R}}))};return window.addEventListener(Rr,m),()=>{window.removeEventListener(Rr,m)}},[i,r,y]),c.useEffect(()=>{Se(m=>m.length>0?[]:m),Ee(null),Te(null)},[i==null?void 0:i.id]),c.useEffect(()=>{f&&Ve("clear")},[p,f]),c.useEffect(()=>{const m=dt.current,I=It.current,A=Ze.current;m.clear(),I.forEach(R=>{window.clearTimeout(R)}),I.length=0,A.clear()},[i==null?void 0:i.id]);const gr=c.useCallback((m,I)=>{if(I.length===0){Ze.current.delete(m.id);return}if(dt.current.has(m.id))return;const A=I[I.length-1];Ze.current.set(m.id,A),dt.current.add(m.id);const R=st;let j=0,G=m;const ie=()=>{if(j>=I.length){dt.current.delete(m.id),Ze.current.delete(m.id);return}const W=I[j];if(j+=1,G={...G,position:W},t(zi(G)),j<I.length){const U=window.setTimeout(()=>{const ue=It.current.indexOf(U);ue>-1&&It.current.splice(ue,1),ie()},R);It.current.push(U)}else dt.current.delete(m.id),Ze.current.delete(m.id)};ie()},[t,st]);c.useEffect(()=>{i&&i.entities.npcs.forEach(m=>{const I=m.routine.find(G=>G.timeOfDay===S);if(!I||m.position.x===I.position.x&&m.position.y===I.position.y)return;const A=i.entities.npcs.filter(G=>G.id!==m.id).map(G=>G.position),R=Array.from(Ze.current.entries()).filter(([G])=>G!==m.id).map(([,G])=>G),j=Pt(m.position,I.position,i,{player:r,enemies:y,blockedPositions:[...A,...R]});j.length>0&&gr(m,j)})},[i,S,r,y,gr]),c.useEffect(()=>{const m=It.current,I=dt.current,A=Ze.current;return()=>{m.forEach(R=>{window.clearTimeout(R)}),m.length=0,I.clear(),A.clear()}},[]),c.useEffect(()=>{var ie;if(Ae.length===0)return;if(u){Se([]),Ee(null);return}if(r.encumbrance.level==="immobile"){r.encumbrance.warning&&t(O(r.encumbrance.warning)),Se([]),Ee(null),Te(null);return}const m=Ae[0],I=r.position.x,A=r.position.y;if(I===m.x&&A===m.y){Se(W=>W.slice(1));return}if(!Ut(m,i,r,y,{npcs:i.entities.npcs})){Se([]),Ee(null),Te(null);return}const R=i.tiles[m.y][m.x],j=P.find(W=>W.fromAreaId===i.id&&W.fromPosition.x===m.x&&W.fromPosition.y===m.y);if(j){const W=M[j.toAreaId];if(x&&R.type===Ar.DOOR&&W&&!W.isInterior){t(O(z.checkpointSealed)),Se([]),Ee(null),Te(null);return}if(W){if($&&W.factionRequirement){const U=W.factionRequirement,ue=Re.playerStatus.factions[U.factionId]??U.factionId,te=((ie=r.factionReputation)==null?void 0:ie[U.factionId])??0,Z=Qn(te);let K=!0;if(U.minimumStanding){const ne=ht(Z.id),Ie=ht(U.minimumStanding);ne<Ie&&(K=!1)}if(K&&typeof U.minimumReputation=="number"&&te<U.minimumReputation&&(K=!1),!K){const ne=[];U.minimumStanding&&ne.push(en(X,U.minimumStanding)),typeof U.minimumReputation=="number"&&ne.push(`${Re.factionPanel.reputationLabel} ${U.minimumReputation}+`);const Ie=ne.join(" • ")||en(X,Z.id);t(O(z.factionAccessDenied(ue,Ie))),Se([]),Ee(null),Te(null);return}}if(!ut()){Se([]),Ee(null),Te(null);return}t(Dr(W)),t(Vt(j.toPosition)),W.isInterior&&(t(Zt({type:"campfireRest",locationId:W.id})),t(O(z.slipInsideStructure)),Ve("clear"))}else e.warn(`Missing target area in state for ${j.toAreaId}`);Se([]),Ee(null),Te(null);return}if(!ut()){Se([]),Ee(null),Te(null);return}const G=r.movementProfile==="silent"?140:0;We.current===null&&(We.current=window.setTimeout(()=>{We.current=null,t(Vt(m))},G))},[Ae,r,i,y,u,x,t,M,P,e,z,ut,X,Re,$]),c.useEffect(()=>{Ae.length===0&&We.current!==null&&(window.clearTimeout(We.current),We.current=null)},[Ae.length]),c.useEffect(()=>()=>{We.current!==null&&(window.clearTimeout(We.current),We.current=null)},[]),c.useEffect(()=>{const m=a??null;if(m&&m!==Wt.current&&t(O(m)),!m&&Wt.current&&s==="normal"){Wt.current=null;return}Wt.current=m},[s,a,t]),c.useEffect(()=>{if(!fn||!i)return;const m=i.entities.npcs.find(A=>A.id===fn);if(!m){Ee(null);return}if(Math.abs(m.position.x-r.position.x)+Math.abs(m.position.y-r.position.y)<=1){if(u)Ee(null);else{const A=Ht(m);Ee(null),A&&Se([])}return}Ae.length===0&&(t(O(z.npcOutOfReach(m.name))),Ee(null))},[fn,i,r,u,Ae.length,t,P,Ht,z]),c.useEffect(()=>{if(!pn||!i)return;const m=i.entities.enemies.find(A=>A.id===pn);if(!m||m.health<=0){Te(null);return}if(Math.abs(m.position.x-r.position.x)+Math.abs(m.position.y-r.position.y)<=1){Te(null),Se([]),u||(t(Rt()),t(O(z.enteredCombat)));return}Ae.length===0&&Te(null)},[pn,i,r,u,Ae.length,t,z,y]),c.useEffect(()=>{wt.current!==S&&(S==="night"?(t(O(z.nightFalls)),Ve("clear")):wt.current==="night"&&(t(O(z.dawnBreaks)),Ve("clear")),wt.current=S)},[S,t,z]),c.useEffect(()=>{$&&t(vi(!!L))},[L,t,$]),c.useEffect(()=>{var Z;if(!r||y.length===0||!i){ze.current=null;return}const m=[i.id,`${r.position.x},${r.position.y}`,r.movementProfile,u?"combat":"field",S,y.map(K=>{var ne;return`${K.id}:${K.health}:${K.position.x},${K.position.y}:${K.facing}:${((ne=K.visionCone)==null?void 0:ne.direction)??"na"}`}).join("|")].join("::");if(ze.current===m)return;ze.current=m;const I=oc(lr.current),A=r.movementProfile==="silent"?.6:r.movementProfile==="sprint"?1.6:1,R=((Z=r.skillTraining)==null?void 0:Z.stealth)??0,j=Math.max(.7,1-Math.min(.3,R/333)),G=(oe.current??S)==="night"?.85:1,ie=I*A*j*G,{updatedEnemies:W,maxAlertLevel:U,guardPerception:ue}=Si(y,r,i,ie);let te=!1;if(r.movementProfile!=="silent"){const K=ac[r.movementProfile];W.forEach((ne,Ie)=>{const Gt=ue[Ie];if(!ne||Gt!=null&&Gt.playerVisible)return;const Et=ne.position.x-r.position.x,qe=ne.position.y-r.position.y;if(Math.sqrt(Et*Et+qe*qe)>K.radius||K.gain<=0)return;const xr=ne.alertProgress??0,Tt=Math.min(100,xr+K.gain);if(Tt<=xr)return;const Ho=ne.alertLevel??ge.IDLE;let Ct=ne.alertLevel??ge.IDLE;Tt>=xn.alarmThreshold?Ct=ge.ALARMED:Tt>=xn.investigationThreshold?Ct=ge.INVESTIGATING:Tt>=xn.suspicionThreshold&&(Ct=ge.SUSPICIOUS),W[Ie]={...ne,alertProgress:Tt,alertLevel:Ct},Cn(Ct)>Cn(Ho)&&(te=!0)})}if(te){const ne=Date.now();ne-dr.current>=1500&&(t(O(z.stealthNoiseCue)),dr.current=ne)}if(W.forEach((K,ne)=>{const Ie=y[ne];Ie&&(K.alertLevel!==Ie.alertLevel||K.alertProgress!==Ie.alertProgress)&&t(wn(K))}),$&&ue.forEach(({enemy:K,playerVisible:ne})=>{if(!ne)return;const Ie=Da({enemy:K,player:r,mapArea:i,timeOfDay:S,environmentFlags:me,playerVisible:ne,timestamp:se});Ie&&(t(_r(Ie)),e.debug(`Suspicion: guard ${K.id} observed player in ${i.zoneId} (certainty ${(Ie.baseCertainty*Ie.distanceModifier).toFixed(2)})`))}),U!==vt.current){const K=Ii(vt.current,U);K&&t(O(z[K])),t(Qt(U)),vt.current=U,ki(U,he)&&(t(Ks()),t(O(z.reinforcementsIncoming)),Oe.current!==null&&at.current.cancel(Oe.current),Oe.current=at.current.schedule(()=>{Oe.current=null,u||t(Rt());const ne=u&&!h,Ie={id:He(),name:z.curfewPatrolName,position:{x:r.position.x+5,y:r.position.y+2},facing:"west",coverOrientation:null,suppression:0,health:45,maxHealth:45,actionPoints:ne?0:4,maxActionPoints:4,damage:7,attackRange:2,isHostile:!0,visionCone:{range:10,angle:90,direction:180},alertLevel:ge.ALARMED,alertProgress:100};t(Lr(Ie)),t(gt()),ne&&!h&&(t(Je()),t(gt())),_e(),ct(0),t(Ei())},ot))}},[r,y,i,t,z,u,h,he,_e,ot,S,me,se,e,$]),c.useEffect(()=>{if(e.debug(`=== useEffect RUNNING === Turn: ${h?"Player":"Enemy"}, Combat: ${u}, Processing: ${Ft.current?"true":"false"}, EnemyIdx: ${De}`),!u||h||y.length===0){_e(),(!u||h)&&De!==0&&ct(0);return}if(y.filter(R=>R.health>0).length===0){_e(),e.warn("Enemy turn effect running but no living enemies found.");return}if(De>=y.length){e.debug(`Enemy index ${De} out of bounds (length: ${y.length}). Ending enemy turn.`),_e(),t(Je()),t(gt()),ct(0);return}const I=y[De];if(!I||I.health<=0||I.actionPoints<=0){e.debug(`Enemy ${(I==null?void 0:I.id)??`at index ${De}`} cannot act (Dead or 0 AP). Checking next.`),_e();let R=De+1,j=!1;for(;R<y.length;){const G=y[R];if(G&&G.health>0&&G.actionPoints>0){j=!0;break}R+=1}j?(e.debug(`Moving to next valid enemy at index ${R}`),ct(R)):(e.debug("All enemies processed, switching back to player."),t(Je()),t(gt()),ct(0));return}if(Ft.current)return;e.debug(`Scheduling action for enemy index ${De}: ${I.id} (AP: ${I.actionPoints})`),Ft.current=I.id;let A=null;zt.current=window.setTimeout(()=>{if(e.debug(`>>> setTimeout CALLBACK for index ${De}`),!u){e.debug("Combat ended, skipping enemy action"),_e(!1);return}try{e.debug(`Enemy Turn AI: START for ${I.id}`);const R=[];for(let G=0;G<i.height;G+=1)for(let ie=0;ie<i.width;ie+=1)i.tiles[G][ie].provideCover&&R.push({x:ie,y:G});e.debug(`Enemy Turn AI: Got cover positions for ${I.id}`);const j=Ti(I,r,i,y,R,i.entities.npcs,de.current);if(A=j,e.debug(`Enemy ${I.id} action: ${j.action}, AP left: ${j.enemy.actionPoints}`),j.action==="attack"||j.action==="attack_missed"){const G=r.health-j.player.health;G>0?(t(Mt({id:He(),value:G,gridX:r.position.x,gridY:r.position.y,type:j.isCritical?"crit":"damage"})),t(Ci({id:He(),type:j.isCritical?"crit":"damage",intensity:.6,duration:300}))):j.action==="attack_missed"&&t(Mt({id:He(),value:0,gridX:r.position.x,gridY:r.position.y,type:"miss"}))}e.debug(`Enemy Turn AI: BEFORE dispatching updates for ${I.id}`),t(wn(j.enemy)),e.debug(`Enemy Turn AI: AFTER dispatch(updateEnemy) for ${I.id}`),j.player.id===r.id&&(e.debug(`Enemy Turn AI: BEFORE dispatch(setPlayerData) for ${I.id}`),t(jr(j.player)),e.debug(`Enemy Turn AI: AFTER dispatch(setPlayerData) for ${I.id}`)),e.debug(`Enemy Turn AI: END AI & Dispatches for ${I.id}`)}catch(R){e.error("Error during enemy turn AI:",{enemyId:I==null?void 0:I.id,error:R})}finally{const R=(A==null?void 0:A.enemy)??I,j=R&&R.health>0&&R.actionPoints>0;e.debug(`Enemy Turn FINALLY for index ${De}. Remaining AP: ${(R==null?void 0:R.actionPoints)??I.actionPoints}. Repeat: ${j}`),_e(!1),j||ct(G=>G+1)}},500)},[u,h,De,y,t,r,i,_e,e]),c.useEffect(()=>()=>{_e()},[_e]),c.useEffect(()=>{const m=at.current;return()=>{m.dispose(),Oe.current=null}},[]),c.useEffect(()=>{if(!u){T.current=null;return}h&&T.current!==le&&(T.current=le,t(Mi()))},[t,u,h,le]),c.useEffect(()=>{xt.current&&!u&&(t(O(z.combatOver)),e.debug("Combat ended (detected via useEffect watching inCombat)."),t(gt())),xt.current=u},[u,t,e,z]);const hr=c.useCallback((m,I)=>{var Z,K;const A=((Z=r.equipped.weapon)==null?void 0:Z.apCost)??Pi,R=Number.isFinite(r.encumbrance.attackApMultiplier)?Math.max(r.encumbrance.attackApMultiplier,0):Number.POSITIVE_INFINITY,j=Ri(r)?0:Math.ceil(Math.max(0,A)*R);if(!Number.isFinite(j)||r.actionPoints<j){t(O(z.notEnoughAp));return}const G=((K=r.equipped.weapon)==null?void 0:K.range)??1;if(!vn(r.position,m.position,G)){t(O(z.enemyOutOfRange));return}const ie=I.tiles[m.position.y][m.position.x].provideCover;e.debug("attackEnemy: PRE-ATTACK",{enemyId:m.id,enemyPosition:m.position,isBehindCover:ie,playerAP_before:r.actionPoints,attackCost:j});const W=Ai(r,m,ie),U=W.newAttacker;t(jr(U)),W.events&&W.events.forEach(ne=>t(O(ne.message))),e.debug("attackEnemy: POST-ATTACK",{apCost:j,playerAP_after:U.actionPoints}),W.success?(t(O(z.hitEnemy(m.name,W.damage))),t(Mt({id:He(),value:W.damage,gridX:m.position.x,gridY:m.position.y,type:W.isCritical?"crit":"damage"}))):(t(O(z.missedEnemy(m.name))),t(Mt({id:He(),value:0,gridX:m.position.x,gridY:m.position.y,type:"miss"})));const ue=W.newTarget;e.debug("attackEnemy: PRE-DISPATCH updateEnemy",{enemyId:ue.id,healthBeforeUpdate:m.health,healthInNewTarget:ue.health}),t(wn(ue)),y.some(ne=>ne.id!==m.id||ne.id===m.id&&W.newTarget.health>0)?U.actionPoints<=0&&(e.debug("attackEnemy: Player out of AP after attack, switching turn."),t(Je())):t(O(z.allEnemiesDefeated))},[r,y,t,e,z]),mn=c.useCallback(m=>y.length===0?null:y.reduce((I,A)=>{const R=Math.abs(A.position.x-m.x)+Math.abs(A.position.y-m.y),j=Math.abs(I.position.x-m.x)+Math.abs(I.position.y-m.y);return R<j?A:I}),[y]),yr=c.useCallback(m=>{if(!i)return null;const I=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1},{x:1,y:1},{x:-1,y:-1},{x:-1,y:1},{x:1,y:-1}];for(const A of I){const R={x:m.x+A.x,y:m.y+A.y};if(R.x<0||R.y<0||R.x>=i.width||R.y>=i.height)continue;const j=i.tiles[R.y],G=j?j[R.x]:void 0;if(!G||!G.isWalkable)continue;if(!y.some(W=>W.position.x===R.x&&W.position.y===R.y))return R}return null},[i,y]),Bo=c.useCallback(m=>{var j,G,ie;const I=m.key,A=(i==null?void 0:i.isInterior)??!1;if(m.shiftKey&&(I==="A"||I==="a")){m.preventDefault(),m.stopPropagation(),t(zn(!re));return}if(re&&u&&((j=St.current)==null||j.notifyManualOverride("manual_input"),t(zn(!1))),L){m.preventDefault(),m.stopPropagation(),I==="Escape"&&(t(tn()),t(O(z.conversationEnded)));return}if(I==="e"||I==="E"){if(m.preventDefault(),m.stopPropagation(),!i)return;const W=i.entities.npcs.find(te=>!te.isInteractive||!te.dialogueId?!1:Math.abs(te.position.x-r.position.x)+Math.abs(te.position.y-r.position.y)<=1);if(!W){t(O(z.noFriendlyContact));return}const U=_.find(te=>te.id===W.dialogueId);if(!U||U.nodes.length===0){t(O(z.npcNoNewInfo(W.name)));return}const ue=U.nodes[0].id;t(Er({dialogueId:U.id,nodeId:ue})),t(O(z.npcChannelOpened(W.name)));return}if(I==="Tab"&&u&&h){m.preventDefault(),m.stopPropagation(),t(O(z.endingTurn??"Ending turn...")),t(Je());return}if(I===" "){if(m.preventDefault(),m.stopPropagation(),Ae.length>0&&(Se([]),Ee(null),Te(null)),!u){const W=mn(r.position),U=((G=r.equipped.weapon)==null?void 0:G.range)??1;if(W&&vn(r.position,W.position,U)){t(Rt()),t(O(z.enteredCombat));return}}if(u&&h){const W=mn(r.position),U=((ie=r.equipped.weapon)==null?void 0:ie.range)??1;if(W&&vn(r.position,W.position,U)){hr(W,i);return}t(O(z.noEnemiesInRange));return}return}if(u&&(!h||r.actionPoints<=0)){if(y.filter(U=>U.health>0).length===0){t(Di()),t(gt()),t(O(z.zoneSecured));return}if(!h){t(O(z.notYourTurn));return}if(r.actionPoints<=0){t(O(z.actionPointsDepleted)),t(Je());return}}Ae.length>0&&(Se([]),Ee(null),Te(null));const R={...r.position};switch(I){case"ArrowUp":case"w":case"W":R.y-=1;break;case"ArrowDown":case"s":case"S":R.y+=1;break;case"ArrowLeft":case"a":case"A":R.x-=1;break;case"ArrowRight":case"d":case"D":R.x+=1;break;default:return}if(m.preventDefault(),m.stopPropagation(),Ut(R,i,r,y,{npcs:i.entities.npcs})){const W=i.tiles[R.y][R.x],U=P.find(Z=>Z.fromAreaId===i.id&&Z.fromPosition.x===R.x&&Z.fromPosition.y===R.y),ue=!u&&m.shiftKey,te=r.stealthModeEnabled?ue?"sprint":"silent":ue?"sprint":"normal";if(r.movementProfile!==te&&t(hn(te)),U){const Z=M[U.toAreaId];if(x&&W.type===Ar.DOOR&&Z&&!Z.isInterior){t(O(z.checkpointSealed));return}if(Z){if(!ut({sprint:ue}))return;t(Dr(Z)),t(Vt(U.toPosition)),Z.isInterior&&(t(Zt({type:"campfireRest",locationId:Z.id})),t(O(z.slipInsideStructure)),Ve("clear"))}else e.warn(`Missing target area in state for ${U.toAreaId}`);Se([]),Ee(null);return}if(!ut({sprint:ue}))return;if(t(Vt(R)),x&&!A){if(Bt==="clear")t(O(z.searchlightsWarning)),Ve("warning");else if(Bt==="warning"){const Z=yr(R);if(Z){const K={id:He(),name:z.curfewPatrolName,position:Z,maxHealth:30,health:30,actionPoints:6,maxActionPoints:6,damage:6,attackRange:1,isHostile:!0};t(Lr(K)),t(Zt({type:"patrolAmbush",locationId:i==null?void 0:i.id,tags:["corpsec"]})),u?t(O(z.curfewReinforcement)):(t(Rt()),t(O(z.curfewOpenFire)))}else t(O(z.curfewFootsteps));Ve("spawned")}}else Bt!=="clear"&&Ve("clear");u&&(e.debug("handleKeyDown: PRE-MOVE AP DEDUCTION",{apCost:1,playerAP_before:r.actionPoints}),t(_i(-1)),e.debug("handleKeyDown: POST-MOVE AP DEDUCTION",{apCost:1,playerAP_after:r.actionPoints-1}),r.actionPoints<=1&&(e.debug("handleKeyDown: Player out of AP after move, switching turn."),t(Je())))}},[r,i,u,h,t,y,hr,mn,x,Bt,yr,M,Ae,Se,Ee,L,P,_,e,z,ut,re]),Wo=c.useCallback(m=>{m.key},[]);return o.jsx("div",{ref:ft,tabIndex:0,onKeyDown:Bo,onKeyUp:Wo,className:"fixed inset-0 focus:outline-none",style:{zIndex:1},"data-testid":"game-controller",children:o.jsx(So,{zoneId:(i==null?void 0:i.zoneId)??null})})},fc=(...e)=>e.filter(Boolean).join(" "),pc=(e,t,n,r)=>r==="none"?"base":r==="ascending"?e>=n?"critical":e>=t?"warning":"base":e<=n?"critical":e<=t?"warning":"base",Jr=({label:e,current:t,max:n,icon:r,variant:s="neutral",lowThreshold:a=50,criticalThreshold:l=25,disableGlow:i=!1,dangerDirection:d="descending"})=>{const p=c.useMemo(()=>{if(n<=0)return 0;const u=t/n*100;return Math.max(0,Math.min(100,u))},[t,n]),f=pc(p,a,l,d);return o.jsxs("div",{className:"hud-stat","data-variant":s,"data-level":f,"data-glow":i?"off":"on",children:[o.jsxs("div",{className:fc("hud-stat__row",f!=="base"?"hud-stat__row--emphasis":null),children:[o.jsxs("div",{className:"flex items-center gap-[0.4rem]",children:[r?o.jsx("span",{className:"hud-stat__icon",children:r}):null,o.jsx("span",{children:e})]}),o.jsxs("span",{className:"hud-stat__value","aria-live":"polite",children:[t,"/",n]})]}),o.jsx("div",{className:"hud-stat__bar",children:o.jsx("div",{className:"hud-stat__fill",style:{width:`${p}%`}})})]})},mc=(...e)=>e.filter(Boolean).join(" "),Mo=c.forwardRef(({className:e,title:t,children:n,role:r,...s},a)=>o.jsxs("svg",{ref:a,viewBox:"0 0 24 24",className:mc("h-4 w-4 shrink-0 text-current",e),role:t?r??"img":"presentation","aria-hidden":t?void 0:!0,...s,children:[t?o.jsx("title",{children:t}):null,n]}));Mo.displayName="IconBase";const gc=({className:e,...t})=>o.jsxs(Mo,{className:e,...t,children:[o.jsx("path",{d:"M12 4.8 4 18.4c-.4.7.1 1.6.9 1.6h14.2c.8 0 1.3-.9.9-1.6L12 4.8z",fill:"currentColor",fillOpacity:.2}),o.jsx("path",{d:"M12 4.8 4 18.4c-.4.7.1 1.6.9 1.6h14.2c.8 0 1.3-.9.9-1.6L12 4.8z",stroke:"currentColor",strokeWidth:1.8,strokeLinejoin:"round",fill:"none"}),o.jsx("path",{d:"M12 9.8v3.8",stroke:"currentColor",strokeWidth:1.8,strokeLinecap:"round",fill:"none"}),o.jsx("circle",{cx:12,cy:16.6,r:1,fill:"currentColor"})]}),hc=({onOpenCharacter:e,characterOpen:t=!1,showActionButton:n=!0,className:r,variant:s="default"})=>{const a=Le(),l=C(H=>H.player.data),i=C(xo),d=C(H=>H.settings.locale),p=C(H=>H.settings.testMode),f=C(rc),u=je(d),h=u.stealthIndicator,S=l.backgroundId?Fi[l.backgroundId]:void 0,x=(S==null?void 0:S.name)??u.playerStatus.backgroundFallback,y=Math.round(i),M=f.isActive?h.stealthToggleOn:h.stealthToggleOff,P=f.blockedReason==="combat"?h.unavailableReasons.combat:f.blockedReason==="dialogue"?h.unavailableReasons.dialogue:f.blockedReason==="cooldown"?h.cooldown(Math.max(1,f.cooldownSeconds||1)):h.keyHint,b=()=>{const H=l.level,L=Hi(H+1),X=l.experience,re=L-X;a(Fn({amount:Math.max(1,re),reason:"Test mode XP boost"}))},N=s==="frameless"?"flex h-full min-h-0 flex-1 flex-col gap-[0.5rem] px-0 py-0 text-[#f8fafc] font-body":"flex flex-col gap-[0.5rem] rounded-[18px] border border-[rgba(59,130,246,0.22)] bg-[linear-gradient(145deg,rgba(8,15,30,0.92),rgba(12,22,42,0.82),rgba(6,12,28,0.92))] px-[0.9rem] py-[0.9rem] text-[#f8fafc] shadow-[0_20px_30px_-20px_rgba(8,12,24,0.5)] backdrop-blur-[14px] font-body",_=r?`${N} ${r}`:N;return o.jsxs("div",{className:_,"data-testid":"player-summary-panel",children:[o.jsx("div",{className:"flex items-start gap-[0.75rem]",children:o.jsxs("div",{className:"flex min-w-0 flex-1 flex-col gap-[0.2rem]",children:[o.jsxs("div",{className:"flex items-center gap-[0.5rem] text-[0.9rem] uppercase tracking-[0.26em] text-[#bfdbfe] drop-shadow-[0_0_8px_rgba(56,189,248,0.4)]",children:[o.jsx("span",{className:"truncate",children:l.name}),o.jsxs("span",{className:"inline-flex items-center gap-[0.25rem] rounded-[999px] border border-[rgba(56,189,248,0.45)] bg-[rgba(56,189,248,0.18)] px-[0.55rem] py-[0.22rem] text-[0.6rem] font-semibold tracking-[0.14em] text-[#f8fafc] shadow-[0_10px_20px_-10px_rgba(56,189,248,0.55)]",children:[u.playerStatus.levelLabel," ",l.level]}),o.jsx("button",{type:"button",onClick:()=>a(Bi()),className:["inline-flex items-center gap-[0.25rem] rounded-[999px] border px-[0.55rem] py-[0.22rem] text-[0.6rem] font-semibold uppercase tracking-[0.14em] transition-all duration-150",f.isActive?"border-[rgba(45,212,191,0.65)] bg-[rgba(20,83,74,0.44)] text-[#ccfbf1] shadow-[0_10px_20px_-12px_rgba(20,184,166,0.55)]":"border-[rgba(148,163,184,0.6)] bg-[rgba(30,41,59,0.45)] text-[#dbeafe] shadow-[0_10px_20px_-12px_rgba(59,130,246,0.35)]"].join(" "),"data-testid":"player-stealth-toggle","aria-pressed":f.isActive,title:P,children:M})]}),o.jsx("div",{className:"text-[0.6rem] uppercase tracking-[0.12em] text-[rgba(226,232,240,0.72)]",children:x})]})}),o.jsx(Jr,{label:u.playerStatus.healthLabel,current:l.health,max:l.maxHealth,variant:"health",lowThreshold:50,criticalThreshold:25}),o.jsx(Jr,{label:u.playerStatus.paranoiaLabel,current:y,max:100,variant:"paranoia",lowThreshold:50,criticalThreshold:75,dangerDirection:"ascending"}),l.isExhausted&&o.jsxs("span",{className:"mt-[0.35rem] inline-flex items-center gap-[0.3rem] rounded-[999px] border border-[rgba(250,204,21,0.65)] bg-[rgba(250,204,21,0.08)] px-[0.55rem] py-[0.22rem] text-[0.55rem] font-semibold uppercase tracking-[0.14em] text-[#facc15] shadow-[0_8px_18px_-12px_rgba(250,204,21,0.6)]",title:u.playerStatus.fatigueHint,children:[o.jsx(gc,{className:"text-[#facc15]","aria-hidden":!0}),o.jsx("span",{children:u.playerStatus.fatigueStatus})]}),o.jsxs("div",{className:"grid grid-cols-2 gap-[0.28rem]",children:[o.jsxs("div",{className:"flex min-w-0 flex-col gap-[0.12rem] rounded-[12px] border border-[rgba(248,250,252,0.08)] bg-[linear-gradient(160deg,rgba(14,26,52,0.88),rgba(10,18,34,0.88))] px-[0.5rem] py-[0.45rem] shadow-[0_16px_30px_-20px_rgba(13,148,136,0.6)]",children:[o.jsx("span",{className:"text-[0.5rem] uppercase tracking-[0.12em] text-[rgba(148,163,184,0.7)]",children:u.playerStatus.creditsLabel}),o.jsxs("span",{className:"text-[0.85rem] font-semibold text-[#fbbf24] drop-shadow-[0_0_12px_rgba(251,191,36,0.5)]",children:["₿",l.credits]})]}),o.jsxs("div",{className:"flex min-w-0 flex-col gap-[0.12rem] rounded-[12px] border border-[rgba(248,250,252,0.08)] bg-[linear-gradient(160deg,rgba(14,26,52,0.88),rgba(10,18,34,0.88))] px-[0.5rem] py-[0.45rem] shadow-[0_16px_30px_-20px_rgba(13,148,136,0.6)]",children:[o.jsx("span",{className:"text-[0.5rem] uppercase tracking-[0.12em] text-[rgba(148,163,184,0.7)]",children:u.playerStatus.experienceLabel}),o.jsx("span",{className:"text-[0.85rem] font-semibold text-[#38bdf8] drop-shadow-[0_0_12px_rgba(56,189,248,0.45)]",children:Wi(l.experience,l.level)})]})]}),e&&n&&o.jsxs("div",{className:"flex gap-[0.5rem]",children:[o.jsx("button",{type:"button",onClick:e,className:["flex-1 rounded-[999px] border px-[0.75rem] py-[0.42rem] text-[0.58rem] font-semibold uppercase tracking-[0.18em] text-[#e0f2fe] shadow-[0_12px_20px_-18px_rgba(56,189,248,0.45)] transition-transform duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-neon/60 focus-visible:ring-offset-2 focus-visible:ring-offset-gunmetal-900",t?"border-[rgba(251,191,36,0.9)] bg-[linear-gradient(130deg,rgba(251,191,36,0.6),rgba(249,115,22,0.55))] text-[#fff7e1]":"border-[rgba(56,189,248,0.55)] bg-[linear-gradient(130deg,rgba(56,189,248,0.48),rgba(14,165,233,0.45))]"].join(" "),"data-testid":"summary-open-character","aria-pressed":t,children:u.shell.characterButton}),p&&o.jsx("button",{type:"button",onClick:b,className:"flex-1 rounded-[999px] border border-[rgba(251,191,36,0.9)] bg-[linear-gradient(130deg,rgba(251,191,36,0.48),rgba(249,115,22,0.45))] px-[0.75rem] py-[0.38rem] text-[0.58rem] font-semibold uppercase tracking-[0.18em] text-[#fff8dc] shadow-[0_12px_20px_-16px_rgba(251,191,36,0.48)] transition-all duration-200 hover:-translate-y-[2px] hover:scale-[1.01] hover:border-[rgba(251,191,36,1)] hover:shadow-[0_0_0_2px_rgba(251,191,36,0.4),0_14px_24px_-16px_rgba(251,191,36,0.6)] focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-400 focus-visible:ring-offset-2 focus-visible:ring-offset-gunmetal-900",title:"Test Mode: Gain XP to level up",children:"⬆ Level Up"})]})]})},yc=jt.memo(hc),es=15,bc=e=>{const{totalMinutes:t}=Xs(e),n=Math.floor(t/es)*es,r=Math.floor(n/60)%24,s=n%60;return`${r.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`},xc=()=>{const e=C(l=>bc(l.world.currentTime)),t=C(l=>l.settings.locale),n=je(t).dayNight,[r,s]=e.split(":");return o.jsxs(o.Fragment,{children:[o.jsx("style",{children:`
    .day-night-clock {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.28rem;
      width: 7.6rem;
      justify-content: center;
      padding: 0.44rem 0.7rem;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.9);
      box-shadow: 0 0 12px rgba(56, 189, 248, 0.16);
      color: #e2e8f0;
      font-family: 'DM Mono', 'IBM Plex Mono', monospace;
      font-size: 0.98rem;
      font-weight: 600;
      letter-spacing: 0.14em;
      line-height: 1;
      text-shadow: 0 0 9px rgba(56, 189, 248, 0.32);
      pointer-events: none;
      user-select: none;
    }

    .day-night-clock::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(
        to bottom,
        rgba(148, 163, 184, 0.1),
        rgba(15, 23, 42, 0)
      );
      pointer-events: none;
    }

    .day-night-clock__digit {
      display: inline-flex;
      min-width: 1.55rem;
      justify-content: center;
    }

    .day-night-clock__colon {
      color: rgba(186, 230, 253, 0.9);
    }
  `}),o.jsxs("div",{className:"day-night-clock",role:"status","aria-label":`${n.clockLabel}: ${e}`,"data-testid":"day-night-clock",children:[o.jsx("span",{className:"day-night-clock__digit",children:r}),o.jsx("span",{className:"day-night-clock__colon","aria-hidden":!0,children:":"}),o.jsx("span",{className:"day-night-clock__digit",children:s})]})]})},Kt=8,Po={liveArea:20,stroke:2},ts={floor:"#101b32",wall:"#1f2937",door:"#fbbf24",cover:"#1d4ed8",water:"#0ea5e9",trap:"#7c3aed",default:"#101b32"},ns={player:"#60a5fa",enemy:"#f87171",npc:"#34d399",objective:"#facc15"},rs={[Q.IDLE]:"#38bdf8",[Q.SUSPICIOUS]:"#fbbf24",[Q.INVESTIGATING]:"#f97316",[Q.ALARMED]:"#ef4444",[Q.DISABLED]:"#64748b"},sn=Po.stroke,Ro=Po.liveArea/2,wc="rgba(15, 23, 42, 0.95)",ss=16,vc=256,Sc=192,Ic=192,kc=160,Ao=(e,t)=>{if(typeof window>"u"||typeof document>"u")return t;try{const n=window.getComputedStyle(document.documentElement).getPropertyValue(e);return(n==null?void 0:n.trim())||t}catch{return t}},Do=()=>Ao("--color-hud-surface",wc),Ec=()=>{const e=Ao("--hud-radius-lg",`${ss}px`),t=Number.parseFloat(e);return Number.isFinite(t)?t:ss},Wn=e=>({minX:0,minY:0,maxX:Math.max(0,e.mapWidth-1),maxY:Math.max(0,e.mapHeight-1),width:Math.max(1,e.mapWidth),height:Math.max(1,e.mapHeight)}),Xt=e=>{var n;if(!e)return!1;const t=((n=e.type)==null?void 0:n.toString().toLowerCase())??"";return t==="wall"||t==="door"||t==="cover"?!0:e.isWalkable===!1},Mn=e=>{var y;const t=e.tiles;if(!t.length||!((y=t[0])!=null&&y.length))return Wn(e);const n=(M,P,b)=>Math.min(Math.max(M,P),b),r=M=>{if(!M)return-1;for(let P=0;P<M.length;P+=1)if(Xt(M[P]))return P;return-1},s=M=>{if(!M)return-1;for(let P=M.length-1;P>=0;P-=1)if(Xt(M[P]))return P;return-1},a=M=>{for(let P=0;P<t.length;P+=1){const b=t[P];if(b&&Xt(b[M]))return P}return-1},l=M=>{for(let P=t.length-1;P>=0;P-=1){const b=t[P];if(b&&Xt(b[M]))return P}return-1};let i=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY,p=Number.POSITIVE_INFINITY,f=Number.NEGATIVE_INFINITY;for(let M=0;M<t.length;M+=1){const P=t[M],b=r(P);b!==-1&&b<i&&(i=b);const N=s(P);N!==-1&&N>d&&(d=N)}for(let M=0;M<e.mapWidth;M+=1){const P=a(M);P!==-1&&P<p&&(p=P);const b=l(M);b!==-1&&b>f&&(f=b)}if(!Number.isFinite(i)||!Number.isFinite(d)||!Number.isFinite(p)||!Number.isFinite(f))return Wn(e);const u=n(i,0,Math.max(0,e.mapWidth-1)),h=n(d,u,Math.max(0,e.mapWidth-1)),S=n(p,0,Math.max(0,e.mapHeight-1)),x=n(f,S,Math.max(0,e.mapHeight-1));return{minX:u,minY:S,maxX:h,maxY:x,width:Math.max(1,h-u+1),height:Math.max(1,x-S+1)}},At=(e,t,n)=>Math.min(Math.max(e,t),n),os=(e,t)=>Math.min(Ro,Math.max(3,e*t)),rt=(e,t=sn)=>Math.max(.5,t)/Math.max(e,1e-4),Tc=(e,t,n,r,s,a)=>{const l=Math.max(0,Math.min(a,Math.min(r,s)/2));e.beginPath(),e.moveTo(t+l,n),e.lineTo(t+r-l,n),e.quadraticCurveTo(t+r,n,t+r,n+l),e.lineTo(t+r,n+s-l),e.quadraticCurveTo(t+r,n+s,t+r-l,n+s),e.lineTo(t+l,n+s),e.quadraticCurveTo(t,n+s,t,n+s-l),e.lineTo(t,n+l),e.quadraticCurveTo(t,n,t+l,n),e.closePath()},Pn=(e,t)=>{const n=1.3333333333333333,r=Math.max(1,Math.round(t.width)),s=Math.max(1,Math.round(t.height));let a=Math.max(1,e.width),l=Math.max(1,e.height);return a/l>n?a=l*n:l=a/n,a>r&&(a=r,l=a/n),l>s&&(l=s,a=l*n,a>r&&(a=r,l=a/n)),{width:Math.max(1,Math.round(a)),height:Math.max(1,Math.round(l))}},Cc=(e,t,n)=>{if(!e)return null;const r=window.devicePixelRatio||1,s=Math.max(1,Math.round(t*r)),a=Math.max(1,Math.round(n*r));e.width!==s&&(e.width=s),e.height!==a&&(e.height=a),e.style.width=`${t}px`,e.style.height=`${n}px`;const l=e.getContext("2d");return l?(l.setTransform(r,0,0,r,0,0),l.imageSmoothingEnabled=!1,l):null},Mc=({ctx:e,state:t,crop:n})=>{const{tiles:r,tileScale:s}=t,a=Do();e.fillStyle=a,e.fillRect(n.minX*s,n.minY*s,n.width*s,n.height*s);for(let l=n.minY;l<=n.maxY;l+=1){const i=r[l];if(i)for(let d=n.minX;d<=n.maxX;d+=1){const p=i[d];if(!p)continue;const f=ts[p.type.toLowerCase()]??ts.default;e.fillStyle=f,e.fillRect(d*s,l*s,s,s),p.provideCover&&(e.fillStyle="rgba(59, 130, 246, 0.15)",e.fillRect(d*s,l*s,s,s))}}},Pc=({ctx:e,state:t,scale:n,crop:r})=>{const{tileScale:s,entities:a,cameras:l}=t,i=t.objectiveMarkers??[];a.forEach(d=>{if(d.x<r.minX||d.x>r.maxX||d.y<r.minY||d.y>r.maxY)return;const p=ns[d.kind]??ns.npc,f=os(s,d.kind==="player"?.7:.5),u=(d.x+.5)*s,h=(d.y+.5)*s;d.kind==="player"?(e.fillStyle=p,e.beginPath(),e.moveTo(u,h-f),e.lineTo(u+f,h+f),e.lineTo(u-f,h+f),e.closePath(),e.fill()):(e.fillStyle=d.status==="inactive"?"rgba(148, 163, 184, 0.35)":p,e.beginPath(),e.arc(u,h,f*.85,0,Math.PI*2),e.fill(),d.kind==="enemy"&&(e.strokeStyle="rgba(15, 23, 42, 0.85)",e.lineWidth=rt(n),e.stroke()))}),i.forEach(d=>{if(d.x<r.minX||d.x>r.maxX||d.y<r.minY||d.y>r.maxY)return;const p=Math.min(Ro,Math.max(5,s*.55)),f=(d.x+.5)*s,u=(d.y+.5)*s;e.fillStyle="rgba(251, 191, 36, 0.2)",e.beginPath(),e.arc(f,u,p,0,Math.PI*2),e.fill(),e.strokeStyle="rgba(251, 191, 36, 0.95)",e.lineWidth=rt(n),e.beginPath(),e.arc(f,u,p*.7,0,Math.PI*2),e.stroke()}),l.forEach(d=>{if(d.x<r.minX||d.x>r.maxX||d.y<r.minY||d.y>r.maxY)return;const p=d.isActive?rs[d.alertState]:rs[Q.DISABLED],f=os(s,.5),u=(d.x+.5)*s,h=(d.y+.5)*s;e.save(),e.fillStyle=p,e.beginPath(),e.moveTo(u,h-f),e.lineTo(u+f,h+f),e.lineTo(u-f,h+f),e.closePath(),e.fill(),e.lineWidth=rt(n),e.strokeStyle="rgba(15, 23, 42, 0.65)",e.stroke(),e.restore()})},Rc=({ctx:e,state:t,scale:n})=>{const{path:r,tileScale:s}=t;if(!r||r.length<2)return;e.strokeStyle="rgba(59, 130, 246, 0.6)",e.lineWidth=rt(n,sn*.95),e.lineJoin="round",e.lineCap="round",e.setLineDash([s*.8,s*.5]),e.beginPath(),r.forEach((d,p)=>{const f=(d.x+.5)*s,u=(d.y+.5)*s;p===0?e.moveTo(f,u):e.lineTo(f,u)}),e.stroke(),e.setLineDash([]);const a=r[r.length-1],l=(a.x+.5)*s,i=(a.y+.5)*s;e.fillStyle="rgba(59, 130, 246, 0.12)",e.beginPath(),e.arc(l,i,Math.max(4,s*.4),0,Math.PI*2),e.fill(),e.strokeStyle="rgba(59, 130, 246, 0.7)",e.lineWidth=rt(n),e.beginPath(),e.arc(l,i,Math.max(3,s*.28),0,Math.PI*2),e.stroke()},Ac=({ctx:e,state:t,scale:n},r)=>{const{viewport:s,tileScale:a}=t;if(!s||s.width<=0||s.height<=0)return;const l=r.width,i=r.height,d=l*a,p=i*a,f=(s.x+s.width/2)*a,u=(s.y+s.height/2)*a,h=f-d/2,S=u-p/2,x=Math.min(Math.max(4,d*.12),Ec()/Math.max(n,1e-4));e.save(),e.lineWidth=rt(n,sn*.85),e.strokeStyle="rgba(148, 163, 184, 0.4)",Tc(e,h,S,d,p,x),e.stroke(),e.restore();const y=Math.max(2,a*.5);e.save(),e.strokeStyle="rgba(148, 163, 184, 0.5)",e.lineWidth=rt(n,sn*.75),e.beginPath(),e.moveTo(f-y,u),e.lineTo(f+y,u),e.moveTo(f,u-y),e.lineTo(f,u+y),e.stroke(),e.restore()},Dc=(e,t,n,r,s,a)=>{const l=Cc(e,n,r);if(!l)return;l.clearRect(0,0,n,r),l.fillStyle=Do(),l.fillRect(0,0,n,r);const i=a.width*t.tileScale,d=a.height*t.tileScale;if(i<=0||d<=0)return;const p=Math.min(n/i,r/d),f=(n-i*p)/2,u=(r-d*p)/2;l.save(),l.translate(f,u),l.scale(p,p),l.translate(-a.minX*t.tileScale,-a.minY*t.tileScale);const h={ctx:l,state:t,scale:p,crop:a};Mc(h),Rc(h),Pc(h),Ac(h,s),l.restore()},_c=()=>{const e=c.useRef(null),t=c.useRef(null),n=c.useRef(et.getState()),r=c.useRef(n.current?Mn(n.current):null),[s,a]=c.useState({width:vc,height:Sc}),[l,i]=c.useState(0),d=c.useRef(null),p=c.useRef(null),f=c.useRef(!1),u=c.useRef(null),h=c.useRef(!1),S=c.useCallback(()=>n.current,[]),x=c.useCallback(g=>g?(r.current||(r.current=Mn(g)),r.current??Wn(g)):null,[]),y=c.useCallback(g=>{const v=g.viewport;if(!v)return;p.current!==g.areaId&&(d.current=null,p.current=g.areaId);const E=Pn(v,{width:g.mapWidth,height:g.mapHeight}),k=d.current;(!k||k.width!==E.width||k.height!==E.height)&&(d.current=E)},[]);c.useEffect(()=>{const g=v=>{const E=v.detail;n.current=E,r.current=Mn(E),y(E),i(E.version)};return et.addEventListener(Nr,g),et.requestImmediateState(),()=>{et.removeEventListener(Nr,g)}},[y]),c.useEffect(()=>{const g=e.current;if(!g||typeof ResizeObserver>"u")return;const v=new ResizeObserver(()=>{const E=Math.max(Ic,Math.floor(g.clientWidth/Kt)*Kt),k=Math.max(kc,Math.floor(g.clientHeight/Kt)*Kt);a(w=>w.width===E&&w.height===k?w:{width:E,height:k}),et.setCanvasBounds(E,k)});return v.observe(g),()=>v.disconnect()},[]),c.useEffect(()=>{const g=S(),v=d.current,E=x(g);!g||!v||!E||Dc(t.current,g,s.width,s.height,v,E)},[s.width,s.height,l,S,x]);const M=c.useCallback(g=>{const v=S(),E=t.current,k=x(v);if(!v||!E||!k)return null;const w=E.getBoundingClientRect(),q=w.width,$=w.height;if(q===0||$===0)return null;const le=k.width*v.tileScale,fe=k.height*v.tileScale,he=Math.min(q/le,$/fe),V=(q-le*he)/2,J=($-fe*he)/2,ae=(g.clientX-w.left-V)/he,me=(g.clientY-w.top-J)/he,se=ae+k.minX*v.tileScale,D=me+k.minY*v.tileScale,ce=At(se/v.tileScale,0,v.mapWidth),ke=At(D/v.tileScale,0,v.mapHeight);return{gridX:ce,gridY:ke}},[x,S]),P=c.useCallback((g,v)=>{if(!g)return;const E=S(),k=E==null?void 0:E.viewport;if(!E||!k)return;const w=d.current??Pn(k,{width:E.mapWidth,height:E.mapHeight}),q=w.width/2,$=w.height/2,le=At(g.gridX,q,Math.max(q,E.mapWidth-q)),fe=At(g.gridY,$,Math.max($,E.mapHeight-$));d.current=w,et.emitInteraction({type:$i,gridX:le,gridY:fe,animate:v})},[S]),b=g=>{if(g.pointerType!=="touch"&&g.button!==0)return;const v=M(g);if(v){if(f.current=!0,h.current=!1,u.current=g.pointerId,typeof g.currentTarget.setPointerCapture=="function")try{g.currentTarget.setPointerCapture(g.pointerId)}catch{}P(v,!0)}},N=g=>{if(!f.current||u.current!==g.pointerId)return;const v=M(g);v&&(h.current=!0,P(v,!1))},_=g=>{if(!f.current||u.current!==g.pointerId)return;const v=M(g);P(v,!h.current),f.current=!1,u.current=null},H=g=>{u.current===g.pointerId&&(f.current=!1,u.current=null)},L=()=>{f.current=!1,u.current=null},X=g=>{g.preventDefault();const v=At(g.deltaY,-120,120);et.adjustZoom(v<0?.15:-.15)},re=g=>{if(!["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(g.key))return;g.preventDefault();const v=S();if(!v)return;const E=d.current??Pn(v.viewport,{width:v.mapWidth,height:v.mapHeight}),k=Math.max(1,Math.floor(E.width*.2));let w=v.viewport.x+v.viewport.width/2,q=v.viewport.y+v.viewport.height/2;switch(g.key){case"ArrowUp":q-=k;break;case"ArrowDown":q+=k;break;case"ArrowLeft":w-=k;break;case"ArrowRight":w+=k;break}P({gridX:w,gridY:q},!1)};return!(S()&&d.current)?null:o.jsx("section",{className:"mini-map-panel","aria-label":"MiniMap panel",children:o.jsx("div",{ref:e,className:"mini-map-canvas",role:"application","aria-label":"MiniMap viewport",tabIndex:0,onKeyDown:re,onWheel:X,onPointerDown:b,onPointerMove:N,onPointerUp:_,onPointerCancel:H,onPointerLeave:L,children:o.jsx("canvas",{ref:t,style:{width:"100%",height:"100%",display:"block"}})})})},Lc=jt.memo(_c),jc=({children:e,className:t,variant:n="default"})=>{const r=n==="frameless"?"flex h-full min-h-0 flex-1 flex-col gap-[0.5rem] px-0 py-0 text-[#f8fafc] font-body":"flex h-full min-h-0 flex-1 flex-col gap-[0.5rem] rounded-[18px] border border-[rgba(59,130,246,0.22)] bg-[linear-gradient(145deg,rgba(8,15,30,0.92),rgba(12,22,42,0.82),rgba(6,12,28,0.92))] px-[0.9rem] py-[0.9rem] text-[#f8fafc] shadow-[0_20px_30px_-20px_rgba(8,12,24,0.5)] backdrop-blur-[14px] font-body",s=t?`${r} ${t}`:r;return o.jsx("div",{className:s,"data-testid":"tactical-panel",children:e})},Nc=jt.memo(jc),rr=e=>e.missions,Oc=e=>e.quests.quests,zc=Y(rr,e=>e.levels[e.currentLevelIndex]??null),Fc=e=>e?e.isCompleted?!0:e.objectives.length>0&&e.objectives.every(t=>t.isCompleted):!1,Bc=(e,t)=>{const n=e.questIds.map(l=>t.find(i=>i.id===l)),r=e.questIds.length,s=n.filter(Fc).length;return{...e,totalQuests:r,completedQuests:s,isComplete:r===0?!1:s===r}},is=(e,t)=>e.map(n=>Bc(n,t)),Ne=Y([zc,Oc],(e,t)=>{if(!e)return null;const n=is(e.objectives.filter(a=>a.kind==="primary"),t),r=is(e.objectives.filter(a=>a.kind==="side"),t),s=n.length>0&&n.every(a=>a.isComplete);return{level:e.level,levelId:e.levelId,name:e.name,zoneId:e.zoneId,primary:n,side:r,allPrimaryComplete:s}});Y(Ne,e=>(e==null?void 0:e.primary)??[]);Y(Ne,e=>(e==null?void 0:e.side)??[]);const Wc=Y(Ne,e=>(e==null?void 0:e.primary.find(t=>!t.isComplete))??null),Hc=Y(Ne,e=>(e==null?void 0:e.side.find(t=>!t.isComplete))??null);Y(Ne,e=>(e==null?void 0:e.allPrimaryComplete)??!1);const sr=Y(rr,e=>e.pendingAdvance),$c=Y(rr,e=>e.celebrationAcknowledged);Y(Ne,e=>(e==null?void 0:e.level)??0);Y(Ne,e=>(e==null?void 0:e.name)??"");const as={margin:0,padding:0,display:"flex",flexDirection:"column",listStyle:"none"},Gc=({collapsed:e=!1,onToggle:t})=>{const n=Le(),r=C(b=>b.settings.locale),s=C(Ne),a=C(sr),l=C(b=>b.world.currentMapArea),i=je(r),d=(l==null?void 0:l.displayName)??(l==null?void 0:l.name)??(s==null?void 0:s.name)??i.levelIndicator.unknownLevel,p=(l==null?void 0:l.level)??(s==null?void 0:s.level)??0,f=s==null?void 0:s.name,u=(s==null?void 0:s.primary)??[],h=(s==null?void 0:s.side)??[],S=(s==null?void 0:s.allPrimaryComplete)??!1,x=()=>{n(Gi())},y=()=>{t&&t()},M={width:e?"min(90vw, 240px)":"min(92vw, 320px)",background:"linear-gradient(145deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.82))",border:"1px solid rgba(148, 163, 184, 0.35)",borderRadius:"14px",padding:e?"0.7rem 0.85rem":"0.9rem 1.05rem",fontFamily:"'DM Mono', 'IBM Plex Mono', monospace",color:"#f8fafc",letterSpacing:"0.05em",display:"flex",flexDirection:"column",gap:e?"0.2rem":"0.4rem",boxShadow:"0 12px 32px rgba(15, 23, 42, 0.45)",pointerEvents:"auto",backdropFilter:"blur(4px)",transition:"width 0.2s ease, padding 0.2s ease"},P={display:"flex",flexDirection:"column",gap:f&&f!==d?"0.25rem":0,flex:1,minWidth:0,width:"100%",cursor:t?"pointer":"default",textTransform:"uppercase",textAlign:"left",transition:"color 0.2s ease",userSelect:"none",pointerEvents:"auto"};return o.jsxs("div",{style:M,children:[o.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"0.35rem",pointerEvents:"auto"},children:[o.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"0.5rem"},children:[o.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",minWidth:0},children:[o.jsx("span",{style:{fontSize:"0.7rem",color:"#94a3b8",opacity:.9},children:i.levelIndicator.levelLabel}),o.jsx("span",{style:{fontSize:"0.96rem",fontWeight:600,whiteSpace:"nowrap"},children:p})]}),o.jsx("div",{style:{display:"flex",alignItems:"center",gap:"0.4rem",minHeight:"1.25rem"},children:a&&o.jsx("button",{type:"button",onClick:x,style:{all:"unset",cursor:"pointer",fontSize:"0.66rem",color:"#5eead4",border:"1px solid rgba(94, 234, 212, 0.38)",borderRadius:"999px",padding:"0.18rem 0.55rem",textTransform:"uppercase",letterSpacing:"0.18em",transition:"all 0.2s ease",pointerEvents:"auto"},onMouseEnter:b=>{b.currentTarget.style.background="rgba(15, 118, 110, 0.22)",b.currentTarget.style.borderColor="rgba(94, 234, 212, 0.55)"},onMouseLeave:b=>{b.currentTarget.style.background="transparent",b.currentTarget.style.borderColor="rgba(94, 234, 212, 0.38)"},children:i.levelIndicator.missionReadyBadge})})]}),o.jsxs("div",{onClick:y,role:"button",tabIndex:0,onKeyDown:b=>{t&&(b.key==="Enter"||b.key===" ")&&(b.preventDefault(),y())},style:P,onMouseEnter:b=>{t&&(b.currentTarget.style.color="rgba(226, 232, 240, 0.92)")},onMouseLeave:b=>{b.currentTarget.style.color="inherit"},children:[o.jsxs("span",{style:{fontSize:"0.72rem",color:"rgba(148, 163, 184, 0.82)",letterSpacing:"0.12em",whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden"},children:[d," ",t&&o.jsx("span",{style:{fontSize:"0.65rem",opacity:.7},children:e?"▸":"▾"})]}),f&&f!==d&&o.jsx("span",{style:{fontSize:"0.62rem",color:"rgba(148, 163, 184, 0.6)",letterSpacing:"0.14em",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:f})]})]}),!e&&o.jsxs(o.Fragment,{children:[o.jsxs("div",{style:{borderTop:"1px solid rgba(148, 163, 184, 0.22)",paddingTop:"0.45rem",display:"flex",flexDirection:"column",gap:"0.3rem"},children:[o.jsx("span",{style:{fontSize:"0.7rem",color:"#94a3b8",opacity:.85},children:i.levelIndicator.objectivesLabel}),u.length===0?o.jsx("span",{style:{fontSize:"0.72rem",color:"#cbd5f5",opacity:.85},children:i.levelIndicator.emptyObjectives}):o.jsx("ul",{style:{...as,gap:"0.32rem"},children:u.map((b,N)=>o.jsxs("li",{style:{display:"flex",alignItems:"center",gap:"0.45rem",fontSize:"0.74rem",lineHeight:1.2,color:b.isComplete?"rgba(148, 163, 184, 0.7)":"rgba(226, 232, 240, 0.92)",textDecoration:b.isComplete?"line-through":"none",textDecorationThickness:"1px",textDecorationColor:"rgba(94, 234, 212, 0.75)",transition:"color 0.18s ease"},children:[o.jsx("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:"0.85rem",height:"0.85rem",borderRadius:"999px",border:"1px solid rgba(94, 234, 212, 0.45)",background:b.isComplete?"linear-gradient(135deg, rgba(94, 234, 212, 0.45), rgba(56, 189, 248, 0.35))":"rgba(14, 165, 233, 0.14)",color:b.isComplete?"#0f172a":"#5eead4",fontSize:"0.64rem",fontWeight:600},"aria-hidden":!0,children:b.isComplete?"✓":N+1}),o.jsx("span",{style:{flex:1},children:b.label}),b.totalQuests>1&&o.jsxs("span",{style:{fontSize:"0.62rem",color:"rgba(148, 163, 184, 0.75)",fontFamily:"'DM Mono', 'IBM Plex Mono', monospace"},children:[b.completedQuests,"/",b.totalQuests]})]},b.id))})]}),o.jsxs("div",{style:{borderTop:"1px solid rgba(148, 163, 184, 0.16)",paddingTop:"0.4rem",display:"flex",flexDirection:"column",gap:"0.24rem"},children:[o.jsx("span",{style:{fontSize:"0.68rem",color:"rgba(148, 163, 184, 0.7)"},children:i.levelIndicator.sideObjectivesLabel}),h.length===0?o.jsx("span",{style:{fontSize:"0.68rem",color:"rgba(148, 163, 184, 0.55)"},children:i.levelIndicator.noSideObjectives}):o.jsx("ul",{style:{...as,gap:"0.22rem"},children:h.map(b=>o.jsxs("li",{style:{display:"flex",alignItems:"center",gap:"0.4rem",fontSize:"0.68rem",color:b.isComplete?"rgba(148, 163, 184, 0.6)":"rgba(226, 232, 240, 0.78)",textDecoration:b.isComplete?"line-through":"none",textDecorationThickness:"1px",textDecorationColor:"rgba(99, 102, 241, 0.6)"},children:[o.jsx("span",{style:{width:"0.5rem",height:"0.5rem",borderRadius:"999px",background:b.isComplete?"linear-gradient(135deg, rgba(129, 140, 248, 0.6), rgba(99, 102, 241, 0.45))":"rgba(99, 102, 241, 0.25)",display:"inline-flex",alignItems:"center",justifyContent:"center",color:"#0f172a",fontSize:"0.55rem"},"aria-hidden":!0,children:b.isComplete?"✓":""}),o.jsx("span",{style:{flex:1},children:b.label})]},b.id))})]}),S&&!a&&o.jsx("span",{style:{marginTop:"0.3rem",fontSize:"0.66rem",color:"rgba(94, 234, 212, 0.76)",fontFamily:"'DM Mono', 'IBM Plex Mono', monospace"},children:i.levelIndicator.primaryCompleteFootnote})]})]})},ln=e=>e.player.data,Uc=e=>!!e.settings.reputationSystemsEnabled,Vc={resistance:0,corpsec:0,scavengers:0};Y(ln,e=>e.karma);const qc=Y(ln,Uc,(e,t)=>t?e.factionReputation:Vc),Yc={corpsec_defector:{earnest:.6,stoic:.4},street_urchin:{sarcastic:.7,ruthless:.3},underground_hacker:{sarcastic:.6,earnest:.4},wasteland_scavenger:{ruthless:.6,stoic:.4}},Kc=e=>{let t="earnest",n=Number.NEGATIVE_INFINITY;return Object.keys(e).forEach(r=>{const s=e[r];s>n&&(t=r,n=s)}),t},Xc=e=>{const t={earnest:0,sarcastic:0,ruthless:0,stoic:0},n={...t,...e},r=Object.values(n).reduce((s,a)=>s+a,0);return r<=0?{...t,earnest:1}:Object.keys(n).reduce((s,a)=>(s[a]=Number.parseFloat((n[a]/r).toFixed(3)),s),t)},Qc=Y(ln,e=>{const t={...e.personality.flags};if(e.backgroundId){const r=Yc[e.backgroundId];r&&Object.keys(r).forEach(s=>{const a=t[s]??0;t[s]=a+r[s]})}const n=Xc(t);return{alignment:Kc(n),flags:n,lastUpdated:e.personality.lastUpdated,lastChangeSource:e.personality.lastChangeSource}});Y(ln,e=>e.name);const Zc=e=>e.quests.quests,Jc=Y(Zc,e=>e.filter(t=>t.isActive&&!t.isCompleted)),ed=(e,t)=>/main/i.test(e.id)||/main/i.test(e.name)?-50+t:/datapad|operation|cold|iron/i.test(e.id)?-25+t:t,or=Y(Jc,e=>{const t=[];return e.forEach((n,r)=>{n.objectives.filter(s=>!s.isCompleted).forEach((s,a)=>{t.push({questId:n.id,questName:n.name,questDescription:n.description,objective:s,priority:ed(n,r)*10+a,isPrimary:r===0})})}),t.sort((n,r)=>n.priority-r.priority)});Y(or,e=>e.length>0?e[0]:null);Y(or,e=>e.length>1?e[1]:null);const Hn={banter:{earnest:[{text:"Shelterline kids started a rumor that thunder is just the ocean applauding us. Let’s stay worth the encore.",guidelineRef:"plot.tone.guideline.7"},{text:"Amara logged a new morale playlist: ninety minutes of clattering cutlery recorded during a pre-war dinner rush. We could dance to that later.",guidelineRef:"plot.tone.guideline.6"}],sarcastic:[{text:"CorpSec just issued an alert about “unauthorized optimism in Sector 12.” Congratulations, you’re contraband joy.",guidelineRef:"plot.tone.guideline.4"},{text:"Fun fact: drone firmware now includes “coyote deterrent mode.” Somewhere an engineer thinks we’re wildlife. Let’s give them a nature documentary.",guidelineRef:"plot.tone.guideline.2"}],ruthless:[{text:"Found an ESD memo describing us as “surgical entropy.” I’ll embrace the brand if you do.",guidelineRef:"plot.tone.guideline.5"},{text:"CorpSec requisitioned riot foam flavored like citrus. Imagine choking on oranges while we dismantle their barricade.",guidelineRef:"plot.tone.guideline.2"}],stoic:[{text:"Filed under anomalies: pigeons roosting in the comms tower tapped out Morse for “stay loud.” No human hands detected.",guidelineRef:"plot.tone.guideline.2"},{text:"Supply ledger shows someone requisitioned 40 kilos of glitter for “psychological operations.” I logged it as “to be determined.”",guidelineRef:"plot.tone.guideline.3"}]},interjections:{questCompleted:{earnest:[{text:"Objective archived. You just stretched curfew a little thinner.",guidelineRef:"plot.tone.guideline.1"},{text:"Quest wrapped. Shelterline will taste this win in their next ration drop.",guidelineRef:"plot.tone.guideline.7"}],sarcastic:[{text:"You crushed that objective so hard the drones filed a workplace grievance.",guidelineRef:"plot.tone.guideline.4"},{text:"Quest complete. Somewhere an ESD analyst just spat in their nutrient slurry.",guidelineRef:"plot.tone.guideline.4"}],ruthless:[{text:"Target neutralized. Momentum stays with us.",guidelineRef:"plot.tone.guideline.5"},{text:"Objective cleared. Line them up for the next strike.",guidelineRef:"plot.tone.guideline.5"}],stoic:[{text:"Task completed. Logging success before it cools.",guidelineRef:"plot.tone.guideline.3"},{text:"Objective done. Updating projections now.",guidelineRef:"plot.tone.guideline.3"}]},reputationPositive:{earnest:[{text:"Your name circulates with smiles today. Resistance morale just spiked.",guidelineRef:"plot.tone.guideline.7"}],sarcastic:[{text:"Congrats, you’re trending on the underground net for something other than property damage.",guidelineRef:"plot.tone.guideline.4"}],ruthless:[{text:"Factions noticed your precision. They’ll expect more sharp edges.",guidelineRef:"plot.tone.guideline.5"}],stoic:[{text:"Reputation bump logged. Allies recalibrating expectations.",guidelineRef:"plot.tone.guideline.3"}]},reputationNegative:{earnest:[{text:"Heads up: whispers turned uneasy. We might need to mend fences soon.",guidelineRef:"plot.tone.guideline.1"}],sarcastic:[{text:"Your popularity dip just broke a few pirate radio polls. Impressive in its own way.",guidelineRef:"plot.tone.guideline.4"}],ruthless:[{text:"Standing dropped. Intimidation can be leverage, but watch the collateral.",guidelineRef:"plot.tone.guideline.5"}],stoic:[{text:"Faction trust decaying. Rebalancing recommendations forthcoming.",guidelineRef:"plot.tone.guideline.3"}]},hostileEntered:{earnest:[{text:"Sensors scream hostile territory. Stay quick, stay breathing.",guidelineRef:"plot.tone.guideline.1"}],sarcastic:[{text:"Welcome to enemy hospitality. Complimentary bullets on the mezzanine.",guidelineRef:"plot.tone.guideline.4"}],ruthless:[{text:"Hostile zone confirmed. Perfect conditions for decisive violence.",guidelineRef:"plot.tone.guideline.5"}],stoic:[{text:"Hostility detected. Updating threat overlay now.",guidelineRef:"plot.tone.guideline.3"}]}}},td=e=>{const t=Hn.banter[e]??Hn.banter.earnest;return t[Math.floor(Math.random()*t.length)]},nd=(e,t)=>{const n=Hn.interjections[e];if(!n)return null;const r=n[t]??n.earnest;return!r||r.length===0?null:r[Math.floor(Math.random()*r.length)]},rd=["gangHeat","curfewLevel","supplyScarcity","blackoutTier"],sd={rumor:45e3,signage:45e3,weather:3e4,zoneDanger:15e3,hazardChange:12e3,zoneBrief:6e4},$n=e=>({gangHeat:e.gangHeat,curfewLevel:e.curfewLevel,supplyScarcity:e.supplyScarcity,blackoutTier:e.blackoutTier}),ls=e=>({flags:$n(e.flags),impacts:{behavior:{...e.impacts.behavior},faction:{...e.impacts.faction},travel:{...e.impacts.travel}},rumor:e.rumor?{groupId:e.rumor.groupId,lines:[...e.rumor.lines],storyFunction:e.rumor.storyFunction,updatedAt:e.rumor.updatedAt}:null,signage:e.signage?{signId:e.signage.signId,text:e.signage.text,storyFunction:e.signage.storyFunction,updatedAt:e.signage.updatedAt}:null,weather:{presetId:e.weather.presetId,description:e.weather.description,storyFunction:e.weather.storyFunction,updatedAt:e.weather.updatedAt,rainIntensity:e.weather.rainIntensity,thunderActive:e.weather.thunderActive,timeOfDay:e.weather.timeOfDay},zone:{zoneId:e.zone.zoneId,zoneName:e.zone.zoneName,dangerRating:e.zone.dangerRating,hazards:[...e.zone.hazards],summary:e.zone.summary,directives:[...e.zone.directives]}}),cs=e=>{const t=new Map;return e.forEach(n=>{const r=n.trim();if(!r)return;const s=r.toLowerCase();t.has(s)||t.set(s,r)}),t},od=(e,t)=>{if(e.length!==t.length)return!1;for(let n=0;n<e.length;n+=1)if(e[n]!==t[n])return!1;return!0};class id{constructor(t){Pe(this,"previous",null);Pe(this,"lastEmitted",{});Pe(this,"cooldowns");this.cooldowns={...sd,...(t==null?void 0:t.cooldowns)??{}}}prime(t){this.previous=ls(t),this.lastEmitted={}}reset(){this.previous=null,this.lastEmitted={}}collect(t,n=Date.now()){const r=ls(t);if(!this.previous)return this.previous=r,[];const s=this.diff(this.previous,r,n),a=[];for(const l of s){const i=this.lastEmitted[l.category],d=this.cooldowns[l.category]??0;typeof i=="number"&&d>0&&n-i<d||(a.push(l),this.lastEmitted[l.category]=n)}return this.previous=r,a}diff(t,n,r){const s=[];n.rumor&&n.rumor.lines.length>0&&(!t.rumor||t.rumor.updatedAt!==n.rumor.updatedAt)&&s.push({category:"rumor",timestamp:r,groupId:n.rumor.groupId,lines:[...n.rumor.lines],storyFunction:n.rumor.storyFunction}),n.signage&&(!t.signage||t.signage.updatedAt!==n.signage.updatedAt||t.signage.text!==n.signage.text)&&s.push({category:"signage",timestamp:r,signId:n.signage.signId,text:n.signage.text,storyFunction:n.signage.storyFunction}),(t.weather.presetId!==n.weather.presetId||t.weather.updatedAt!==n.weather.updatedAt||t.weather.rainIntensity!==n.weather.rainIntensity||t.weather.thunderActive!==n.weather.thunderActive||t.weather.timeOfDay!==n.weather.timeOfDay)&&s.push({category:"weather",timestamp:r,presetId:n.weather.presetId,previousPresetId:t.weather.presetId,description:n.weather.description,storyFunction:n.weather.storyFunction,rainIntensity:n.weather.rainIntensity,thunderActive:n.weather.thunderActive,timeOfDay:n.weather.timeOfDay});const l=rd.reduce((x,y)=>(t.flags[y]!==n.flags[y]&&x.push({key:y,previous:t.flags[y],next:n.flags[y]}),x),[]),i=t.zone.dangerRating!==n.zone.dangerRating,d=n.zone.zoneName??t.zone.zoneName??null;(i||l.length>0)&&s.push({category:"zoneDanger",timestamp:r,dangerRating:n.zone.dangerRating??null,previousDangerRating:t.zone.dangerRating??null,flags:$n(n.flags),previousFlags:$n(t.flags),changedFlags:l,zoneName:d});const p=cs(t.zone.hazards),f=cs(n.zone.hazards),u=[];f.forEach((x,y)=>{p.has(y)||u.push(x)});const h=[];return p.forEach((x,y)=>{f.has(y)||h.push(x)}),(u.length>0||h.length>0)&&s.push({category:"hazardChange",timestamp:r,added:u,removed:h,zoneName:d}),(t.zone.zoneId!==n.zone.zoneId||t.zone.zoneName!==n.zone.zoneName||t.zone.summary!==n.zone.summary||!od(t.zone.directives,n.zone.directives))&&s.push({category:"zoneBrief",timestamp:r,zoneName:n.zone.zoneName??d,summary:n.zone.summary??null,dangerRating:n.zone.dangerRating??null,hazards:[...n.zone.hazards],directives:[...n.zone.directives]}),s}}const Gn="MISSION_ACCOMPLISHED",Un="LEVEL_ADVANCE_REQUESTED",ad=e=>{typeof window>"u"||window.dispatchEvent(new CustomEvent(Gn,{detail:e}))},ld=e=>{typeof window>"u"||window.dispatchEvent(new CustomEvent(Un,{detail:e}))},cd=9e3,ds=48e3,dd=96e3,us=12,ud=['Diagnostics show morale at "manageable"—keep it that way.',"Filed another complaint against the rain. Status: pending since 2034.","If you spot Theo, remind him the coffee synth still needs a filter.","Today’s lucky number is 404. Let’s try not to vanish."],fd={operation:{badge:"OP",tone:"operation"},status:{badge:"ST",tone:"status"},interjection:{badge:"BC",tone:"broadcast"},player:{badge:"ME",tone:"player"},broadcast:{badge:"BC",tone:"broadcast"},battle:{badge:"BT",tone:"battle"},dialog:{badge:"DG",tone:"dialog"},stealth:{badge:"SF",tone:"stealth"}},pd={badge:"--",tone:"broadcast"},fs=({size:e=32,className:t})=>{const n=c.useId(),r=`${n}-bg`,s=`${n}-glow`;return o.jsxs("svg",{className:t,width:e,height:e,viewBox:"0 0 64 64",role:"img","aria-hidden":"true",focusable:"false",children:[o.jsxs("defs",{children:[o.jsxs("linearGradient",{id:r,x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[o.jsx("stop",{offset:"0%",stopColor:"#1e293b",stopOpacity:1}),o.jsx("stop",{offset:"100%",stopColor:"#0f172a",stopOpacity:1})]}),o.jsxs("linearGradient",{id:s,x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[o.jsx("stop",{offset:"0%",stopColor:"#38bdf8",stopOpacity:1}),o.jsx("stop",{offset:"100%",stopColor:"#0ea5e9",stopOpacity:1})]})]}),o.jsx("circle",{cx:"32",cy:"32",r:"32",fill:`url(#${r})`}),o.jsx("path",{d:"M32 16 L46 24 L32 32 L18 24 Z",fill:"#475569",opacity:"0.6"}),o.jsx("circle",{cx:"32",cy:"32",r:"10",fill:"none",stroke:`url(#${s})`,strokeWidth:"2.5"}),o.jsx("circle",{cx:"32",cy:"32",r:"6",fill:"none",stroke:`url(#${s})`,strokeWidth:"1.5"}),o.jsx("line",{x1:"32",y1:"22",x2:"32",y2:"26",stroke:"#38bdf8",strokeWidth:"2",strokeLinecap:"round"}),o.jsx("line",{x1:"32",y1:"38",x2:"32",y2:"42",stroke:"#38bdf8",strokeWidth:"2",strokeLinecap:"round"}),o.jsx("line",{x1:"22",y1:"32",x2:"26",y2:"32",stroke:"#38bdf8",strokeWidth:"2",strokeLinecap:"round"}),o.jsx("line",{x1:"38",y1:"32",x2:"42",y2:"32",stroke:"#38bdf8",strokeWidth:"2",strokeLinecap:"round"}),o.jsx("circle",{cx:"32",cy:"32",r:"2",fill:"#38bdf8"}),o.jsx("path",{d:"M8 8 L12 8 L12 12",fill:"none",stroke:"#0ea5e9",strokeWidth:"1.5",opacity:.4}),o.jsx("path",{d:"M56 8 L52 8 L52 12",fill:"none",stroke:"#0ea5e9",strokeWidth:"1.5",opacity:.4}),o.jsx("path",{d:"M8 56 L12 56 L12 52",fill:"none",stroke:"#0ea5e9",strokeWidth:"1.5",opacity:.4}),o.jsx("path",{d:"M56 56 L52 56 L52 52",fill:"none",stroke:"#0ea5e9",strokeWidth:"1.5",opacity:.4})]})},md=(e,t,n)=>{if(e.length===0)return[t.questNone];const s=e.slice(0,n).map(a=>{const l=a.objective.count&&a.objective.count>1?` (${a.objective.currentCount??0}/${a.objective.count})`:"";return`${a.questName}: ${a.objective.description}${l}`});return e.length>n&&s.push(t.questMore),s},gd=e=>{const t=e.replace(/\s+/g," ").trim();return t.length<=140?t:`${t.slice(0,137).trimEnd()}…`},hd=(e,t)=>{const n=e.trim(),r=n.length?n:"---",s=r.toLowerCase(),a=l=>l.some(i=>s.includes(i));return a(["attack","enemy","combat","battle","damage","hostile"])?{category:"battle",label:t.battle,text:r,timestamp:Date.now()}:a(["dialog","dialogue","whispers","says","conversation","briefing","speech"])?{category:"dialog",label:t.dialog,text:r,timestamp:Date.now()}:a(["stealth","hidden","sneak","shadow","camouflage","conceal"])?{category:"stealth",label:t.stealth,text:r,timestamp:Date.now()}:{category:"broadcast",label:t.broadcast,text:r,timestamp:Date.now()}},yd=()=>{const e=C(T=>T.settings.locale),t=c.useMemo(()=>je(e),[e]),n=c.useMemo(()=>t.george,[t]),{feedLabels:r,levelAdvance:s,missionComplete:a,promptPlaceholder:l,askPlaceholder:i,askInputLabel:d,sendLabel:p}=n,f=C(or),u=C(Ne),h=C(Wc),S=C(Hc),x=C(Qc),y=C(qc),M=C(T=>!!T.settings.reputationSystemsEnabled),P=C(T=>T.quests.quests),b=C(T=>T.world),N=C(El),_=C(T=>T.log.messages),H=c.useMemo(()=>{var T;return(T=n.ambient)!=null&&T.length?n.ambient:ud},[n]),[L,X]=c.useState([]),[re,pe]=c.useState(""),F=c.useRef(0),g=c.useRef(null),v=c.useRef(new Set),E=c.useRef(y),k=c.useRef({level:b.globalAlertLevel,inCombat:b.inCombat}),w=c.useRef(null),q=c.useRef(null),$=c.useRef(""),le=c.useRef(_.length),fe=c.useRef(null),he=c.useRef(!1),V=c.useRef([]),J=c.useRef(null),ae=c.useCallback(()=>{if(!V.current.length){J.current=null;return}const T=V.current.shift();T&&X(B=>{const oe=[...B,T];return oe.length>us?oe.slice(oe.length-us):oe}),J.current=window.setTimeout(ae,1e3)},[]),me=c.useCallback(({category:T,label:B,text:oe,timestamp:ee})=>{const ye=ee??Date.now(),de=fd[T]??pd,we={id:`${ye}-${Math.random().toString(36).slice(2)}`,category:T,text:gd(oe),label:B,timestamp:ye,badge:de.badge,tone:de.tone};V.current=[...V.current,we],J.current===null&&ae()},[ae]),se=c.useCallback(T=>{me(T)},[me]),D=c.useCallback(T=>{F.current=Date.now()+cd,g.current=null,se({category:"interjection",label:n.feedLabels.interjection,text:T.text,timestamp:Date.now()})},[n.feedLabels.interjection,se]),ce=c.useCallback(T=>{const B=nd(T,x.alignment);if(!B)return;if(Date.now()>=F.current){D(B);return}g.current=B},[x.alignment,D]),ke=c.useCallback(()=>H.length&&Math.random()<.5?{text:H[Math.floor(Math.random()*H.length)],guidelineRef:"ambient.line"}:td(x.alignment),[H,x.alignment]),z=c.useCallback(T=>{pe(T.target.value)},[]),Re=c.useCallback(T=>{var ye,de;T&&T.preventDefault();const B=re.trim();if(!B){(ye=fe.current)==null||ye.focus();return}me({category:"player",label:r.player,text:B,timestamp:Date.now()}),pe(""),(de=fe.current)==null||de.focus();const oe=ke(),ee=l(oe.text);me({category:"interjection",label:r.interjection,text:ee,timestamp:Date.now()})},[me,r.interjection,r.player,ke,l,re]),Be=c.useCallback(()=>{w.current!==null&&window.clearTimeout(w.current);const T=Math.floor(ds+Math.random()*(dd-ds));w.current=window.setTimeout(()=>{const B=ke();Date.now()>=F.current?D(B):g.current=B,Be()},T)},[ke,D]);c.useEffect(()=>{const T=window.setInterval(()=>{const B=g.current;B&&Date.now()>=F.current&&D(B)},400);return()=>window.clearInterval(T)},[D]),c.useEffect(()=>(Be(),()=>{w.current!==null&&(window.clearTimeout(w.current),w.current=null),J.current!==null&&(window.clearTimeout(J.current),J.current=null),V.current=[]}),[Be]),c.useEffect(()=>{if(_.length<=le.current){le.current=_.length;return}_.slice(le.current).forEach(B=>{const oe=hd(B,{battle:r.battle,dialog:r.dialog,stealth:r.stealth,broadcast:r.broadcast});se(oe)}),le.current=_.length},[r.battle,r.broadcast,r.dialog,r.stealth,_,se]),c.useEffect(()=>{const T=(u==null?void 0:u.name)??n.zoneFallback,B=[];if(u){if(u.allPrimaryComplete)B.push(n.guidancePrimaryComplete(T));else if(h){const de=h.totalQuests>1?n.guidanceProgress(h.completedQuests??0,h.totalQuests):"";B.push(n.guidancePrimaryObjective(h.label,de))}S&&B.push(n.guidanceSideObjective(S.label))}const oe=md(f,n,3),ee=[n.guidanceIntro];B.length>0&&ee.push(...B),oe.length>0&&(B.length>0&&ee.push(""),ee.push(...oe));const ye=ee.join(`
`).trim();!ye||$.current===ye||($.current=ye,se({category:"operation",label:r.operation,text:ye,timestamp:Date.now()}))},[r.operation,n,u,h,S,f,se]);const st=c.useCallback(T=>{if(!T)return"";try{return new Intl.DateTimeFormat(e,{hour:"2-digit",minute:"2-digit"}).format(new Date(T))}catch{return new Date(T).toLocaleTimeString()}},[e]),ot=c.useCallback(T=>{var ye;const B=n.ambientFeed,oe=x.alignment,ee=de=>({category:"broadcast",text:de,label:r.broadcast,timestamp:T.timestamp});switch(T.category){case"rumor":{const de=((ye=T.lines.find(ve=>ve&&ve.trim().length>0))==null?void 0:ye.trim())??B.fallbacks.rumor,we=T.storyFunction?B.storyFunctionLabels[T.storyFunction]??T.storyFunction.replace(/-/g," ").toUpperCase():void 0;return ee(B.formatRumor({line:de,storyLabel:we},oe))}case"signage":{const de=T.text&&T.text.trim().length>0?T.text.trim():B.fallbacks.signage,we=T.storyFunction?B.storyFunctionLabels[T.storyFunction]??T.storyFunction.replace(/-/g," ").toUpperCase():void 0;return ee(B.formatSignage({text:de,storyLabel:we},oe))}case"weather":{const de=T.description&&T.description.trim().length>0?T.description.trim():B.fallbacks.weather,we=T.storyFunction?B.storyFunctionLabels[T.storyFunction]??T.storyFunction.replace(/-/g," ").toUpperCase():void 0;return ee(B.formatWeather({description:de,storyLabel:we},oe))}case"zoneDanger":{const de=t.levelIndicator.dangerLevels,we=T.dangerRating?de[T.dangerRating]??T.dangerRating:B.dangerFallback,ve=T.previousDangerRating?de[T.previousDangerRating]??T.previousDangerRating:null,lt=T.changedFlags.map(ze=>({label:B.flagLabels[ze.key]??ze.key,previous:B.formatFlagValue(ze.key,ze.previous),next:B.formatFlagValue(ze.key,ze.next)}));return ee(B.formatZoneDanger({zoneName:T.zoneName,dangerLabel:we,previousDangerLabel:ve,flagChanges:lt},oe))}case"hazardChange":{const de=T.added.map(ve=>ve.trim()).filter(ve=>ve.length>0),we=T.removed.map(ve=>ve.trim()).filter(ve=>ve.length>0);return ee(B.formatHazards({zoneName:T.zoneName,additions:de,removals:we},oe))}case"zoneBrief":{const de=t.levelIndicator.dangerLevels,we=T.dangerRating?de[T.dangerRating]??T.dangerRating:B.dangerFallback;return ee(B.formatZoneBrief({zoneName:T.zoneName,summary:T.summary??null,dangerLabel:we,hazards:T.hazards,directives:T.directives},oe))}default:return null}},[r.broadcast,n.ambientFeed,x.alignment,t.levelIndicator.dangerLevels]);c.useEffect(()=>{const T=oe=>{const ee=oe.detail;if(!ee)return;const ye=a(ee.name);se({category:"operation",label:r.operation,text:ye,timestamp:Date.now()}),ce("questCompleted")},B=oe=>{const ee=oe.detail;if(!ee)return;const ye=ee.nextLevelId??`level ${ee.nextLevel}`,de=s(ye);se({category:"operation",label:r.operation,text:de,timestamp:Date.now()})};return window.addEventListener(Gn,T),window.addEventListener(Un,B),()=>{window.removeEventListener(Gn,T),window.removeEventListener(Un,B)}},[r.operation,s,a,se,ce]),c.useEffect(()=>{const T=new Set(P.filter(ee=>ee.isCompleted).map(ee=>ee.id)),B=v.current;Array.from(T).filter(ee=>!B.has(ee)).length>0&&ce("questCompleted"),v.current=T},[P,ce]),c.useEffect(()=>{if(!N)return;if(!q.current){const oe=new id;oe.prime(N),q.current=oe;const ee={category:"zoneBrief",timestamp:Date.now(),zoneName:N.zone.zoneName,summary:N.zone.summary,dangerRating:N.zone.dangerRating??null,hazards:[...N.zone.hazards],directives:[...N.zone.directives]},ye=ot(ee);ye&&se(ye);return}const B=q.current.collect(N);B.length&&B.forEach(oe=>{const ee=ot(oe);ee&&se(ee)})},[N,ot,se]),c.useEffect(()=>{const T=E.current,B=y;if(!M){E.current=B;return}const oe=new Set([...Object.keys(B),...Object.keys(T)]),ee=Array.from(oe).some(de=>{const we=B[de]??0,ve=T[de]??0;return we-ve>=20}),ye=Array.from(oe).some(de=>{const we=B[de]??0,ve=T[de]??0;return we-ve<=-20});ee?ce("reputationPositive"):ye&&ce("reputationNegative"),E.current=B},[y,ce,M]),c.useEffect(()=>{const T=k.current;(!T.inCombat&&b.inCombat||T.level!=="alarmed"&&b.globalAlertLevel==="alarmed")&&ce("hostileEntered"),k.current={level:b.globalAlertLevel,inCombat:b.inCombat}},[ce,b.globalAlertLevel,b.inCombat]);const xt=c.useRef(null),wt=c.useCallback(T=>{var B;T.preventDefault(),(B=fe.current)==null||B.focus()},[]),vt=c.useCallback(()=>{he.current=!0},[]),Qe=c.useCallback(()=>{he.current=!1},[]);c.useEffect(()=>{var B;const T=xt.current;T&&(T.scrollTo({top:T.scrollHeight,behavior:"smooth"}),he.current&&((B=fe.current)==null||B.focus()))},[L]);const Ue={id:"george-placeholder",category:"status",text:n.logEmpty,label:r.broadcast,timestamp:0,badge:"NB",tone:"broadcast"},it=L.length>0?L:[Ue],Ot=L.length>0,at=it.length-1,Oe=re.trim().length===0;return o.jsxs("div",{className:"george-inline","data-controller-focus-ignore":"true",children:[o.jsx("div",{className:"george-chat",role:"log","aria-live":"polite",ref:xt,children:it.map((T,B)=>{const oe=Ot&&B===at,ee=T.timestamp?st(T.timestamp):"";return o.jsxs("div",{className:"george-chat-entry",children:[o.jsx("div",{className:"george-chat-avatar","aria-hidden":"true",children:o.jsx(fs,{size:32})}),o.jsxs("div",{className:`george-chat-bubble george-chat-bubble--${T.tone}${oe?" george-chat-bubble--latest":""}`,children:[o.jsxs("div",{className:"george-chat-bubble__header",children:[o.jsxs("div",{className:"george-chat-bubble__title",children:[o.jsx("span",{className:`george-chat-badge george-chat-badge--${T.tone}`,"aria-hidden":"true",children:T.badge}),o.jsx("span",{className:"george-chat-bubble__label",children:T.label})]}),ee?o.jsx("span",{className:"george-chat-bubble__time",children:ee}):null]}),o.jsx("p",{className:"george-chat-bubble__text",children:T.text})]})]},T.id)})}),o.jsxs("form",{className:"george-input-row",onSubmit:Re,children:[o.jsx(fs,{size:36}),o.jsx("div",{className:"george-input",children:o.jsx("input",{id:"george-prompt-input",className:"george-input__field",type:"text",placeholder:i,"aria-label":d,value:re,onChange:z,autoComplete:"off",ref:fe,onFocus:vt,onBlur:Qe})}),o.jsx("button",{type:"submit",className:"george-send-button","data-disabled":Oe,"aria-label":p,onMouseDown:wt,children:o.jsx("span",{className:"george-send-icon","aria-hidden":"true",children:"↗"})})]})]})},cn=["warmth","melancholy","sarcasm","surrealism","urgency","steadiness","wit"],bd={author:.4,persona:.4,scene:.2},$e={sentenceLengthMean:14,sentenceLengthStdDev:4,metaphorRate:.35,fragmentPreference:.2,motifDensity:.25},ps=cn.reduce((e,t)=>(e[t]=.5,e),{});cn.reduce((e,t)=>(e[t]={type:"number",minimum:0,maximum:1},e),{});const Rn=e=>e.rhetoric?{sentenceLengthMean:e.rhetoric.sentenceLengthMean??$e.sentenceLengthMean,sentenceLengthStdDev:e.rhetoric.sentenceLengthStdDev??$e.sentenceLengthStdDev,metaphorRate:e.rhetoric.metaphorRate??$e.metaphorRate,fragmentPreference:e.rhetoric.fragmentPreference??$e.fragmentPreference,motifDensity:e.rhetoric.motifDensity??$e.motifDensity}:{...$e},xd=e=>{let t=1779033703,n=3144134277,r=1013904242,s=2773480762;for(let a=0;a<e.length;a+=1){const l=e.charCodeAt(a);t=Math.imul(t^l,597399067),n=Math.imul(n^l,2869860233),r=Math.imul(r^l,951274213),s=Math.imul(s^l,2716044179)}return t=Math.imul(t^t>>>18,597399067),n=Math.imul(n^n>>>22,2869860233),r=Math.imul(r^r>>>17,951274213),s=Math.imul(s^s>>>19,2716044179),[t^n^r^s,n^t,r^t,s^t]},wd=e=>()=>{let t=e+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296},Lt=e=>{const t=typeof e=="number"?e.toString(36):e,n=xd(t),r=wd(n[0]),s=()=>r(),a=i=>i<=0?0:Math.floor(s()*i);return{next:s,nextInt:a,pick:i=>{if(i.length===0)throw new Error("Cannot pick from an empty list.");return i[a(i.length)]}}},Dt=(e,t,n)=>Math.min(Math.max(e,t),n),vd=(e,t)=>{const n={...bd,...e};if(!t){const s=n.author+n.persona;return s===0?{author:.5,persona:.5,scene:0}:{author:n.author/s,persona:n.persona/s,scene:0}}const r=n.author+n.persona+n.scene;return r===0?{author:.4,persona:.4,scene:.2}:{author:n.author/r,persona:n.persona/r,scene:n.scene/r}},An=e=>e?cn.reduce((t,n)=>{var s;const r=(s=e.traits)==null?void 0:s[n];return typeof r=="number"&&!Number.isNaN(r)?t[n]=Dt(r,0,1):t[n]=ps[n],t},{}):{...ps},Sd=(e,t,n,r)=>cn.reduce((s,a)=>{const l=t[a]??.5,i=n[a]??.5,d=r?r[a]??.5:.5,p=l*e.author+i*e.persona+d*e.scene;return s[a]=Dt(p,0,1),s},{}),Id=(e,t,n,r)=>{const s=Rn(t),a=Rn(n),l=r?Rn(r):$e;return{sentenceLengthMean:s.sentenceLengthMean*e.author+a.sentenceLengthMean*e.persona+l.sentenceLengthMean*e.scene,sentenceLengthStdDev:s.sentenceLengthStdDev*e.author+a.sentenceLengthStdDev*e.persona+l.sentenceLengthStdDev*e.scene,metaphorRate:s.metaphorRate*e.author+a.metaphorRate*e.persona+l.metaphorRate*e.scene,fragmentPreference:s.fragmentPreference*e.author+a.fragmentPreference*e.persona+l.fragmentPreference*e.scene,motifDensity:s.motifDensity*e.author+a.motifDensity*e.persona+l.motifDensity*e.scene}},kd=(e,t)=>{const n=[],r=$e.sentenceLengthMean+e.melancholy*4-e.urgency*5+e.surrealism*3+e.wit*1-e.sarcasm*1,s=Dt((t.sentenceLengthMean+r)/2,6,28);Math.abs(s-t.sentenceLengthMean)>.01&&(n.push({trait:"urgency",from:t.sentenceLengthMean,to:s}),t.sentenceLengthMean=s);const a=.15+e.sarcasm*.25+e.urgency*.3-e.steadiness*.2,l=Dt((t.fragmentPreference+a)/2,0,.85);Math.abs(l-t.fragmentPreference)>.01&&(n.push({trait:"sarcasm",from:t.fragmentPreference,to:l}),t.fragmentPreference=l);const i=$e.metaphorRate+e.surrealism*.4+e.melancholy*.2-e.urgency*.25,d=Dt((t.metaphorRate+i)/2,0,.9);return Math.abs(d-t.metaphorRate)>.01&&(n.push({trait:"surrealism",from:t.metaphorRate,to:d}),t.metaphorRate=d),n},Ed=e=>Object.entries(e).reduce((t,[n,r])=>{const s=Math.max(0,r-1);return s>0&&(t[n]=s),t},{}),Td=(e,t,n)=>{switch(e.type){case"requiresTrait":return!e.trait||typeof e.threshold!="number"?!0:t[e.trait]>=e.threshold;case"forbidsTrait":return!e.trait||typeof e.threshold!="number"?!0:t[e.trait]<=e.threshold;case"maxSentenceLength":return!0;case"requiresMotif":return e.motifId?(n[e.motifId]??0)>0:!0;default:return!0}},Cd=(e,t,n)=>e.requiredTraits&&Object.entries(e.requiredTraits).some(([s,a])=>t[s]<a)||e.forbiddenTraits&&Object.entries(e.forbiddenTraits).some(([s,a])=>t[s]>a)?!1:e.constraints?e.constraints.every(r=>Td(r,t,n)):!0,Md=(e,t,n,r)=>{var a,l;let s=1;if(e.traitWeightBoost)for(const[i,d]of Object.entries(e.traitWeightBoost))s+=(t[i]??.5)*d;return(a=n.templateBias)!=null&&a.includes(e.id)&&(s+=.75),(l=r.templateBias)!=null&&l.includes(e.id)&&(s+=.75),Math.max(s,.1)},Pd=(e,t,n,r)=>{var p,f;if(e.requestedTemplateId){const u=t.templates.find(h=>h.id===e.requestedTemplateId);if(u)return u}const s=t.templates.filter(u=>Cd(u,n,r));if(s.length===0){const u=((p=e.persona.fallbackTemplates)==null?void 0:p[0])??((f=e.author.fallbackTemplates)==null?void 0:f[0]),h=u?t.templates.find(S=>S.id===u):void 0;if(h)return h;if(t.templates.length===0)throw new Error("No dialogue tone templates defined.");return t.templates[0]}const a=Lt(`${e.seed??"tone"}::template`),l=s.map(u=>({template:u,weight:Md(u,n,e.author,e.persona)})),i=l.reduce((u,h)=>u+h.weight,0);let d=a.next()*i;for(const u of l){if(d<=u.weight)return u.template;d-=u.weight}return l[l.length-1].template},Rd=(e,t)=>{const n=e.palettes.find(r=>r.id===t);if(!n)throw new Error(`Missing palette ${t} referenced by tone template.`);return n},Ad=(e,t)=>{var n;return(n=e.lexiconOverrides)==null?void 0:n[t]},Dd=(e,t,n,r)=>{var a;let s=e.weight;if(e.traitInfluence)for(const[l,i]of Object.entries(e.traitInfluence))s+=(t[l]??.5)*i;if(e.motifId){const l=r[e.motifId]??0;s-=l*.35,(a=n.motifBias)!=null&&a.includes(e.motifId)&&(s+=.5)}return Math.max(s,0)},_d=(e,t,n,r,s,a,l)=>{var x;const i=Ad(r.persona,t);if(i&&i.length>0){const y=Lt(`${l}::override::${t}`),M=i[y.nextInt(i.length)];return{paletteId:e,entryId:"override",text:M}}const d=Rd(s,e),p=Lt(`${l}::palette::${e}`),f=d.entries.map(y=>({entry:y,weight:Dd(y,n,r.persona,a)})),u=f.reduce((y,M)=>y+M.weight,0);if(u<=0){const y=d.defaultText??((x=d.entries[0])==null?void 0:x.text);if(!y)throw new Error(`Palette ${e} has no viable entries.`);return{paletteId:e,entryId:"fallback",text:y}}let h=p.next()*u;for(const{entry:y,weight:M}of f){if(h<=M)return{paletteId:e,entryId:y.id,text:y.text};h-=M}const S=f[f.length-1].entry;return{paletteId:e,entryId:S.id,text:S.text}},Ld=(e,t)=>e.template.replace(/\{\{(.*?)\}\}/g,(n,r)=>{var l;const s=r.trim(),a=t[s];return a?a.text:((l=e.slots.find(i=>i.id===s))==null?void 0:l.fallback)??""}),jd=(e,t)=>{var M;const n=vd(e.weights,!!e.scene),r=An(e.author),s=An(e.persona),a=e.scene?An(e.scene):void 0,l=Sd(n,r,s,a),i=Id(n,e.author,e.persona,e.scene),d=kd(l,i),p=Ed(e.motifState??{}),f=Pd(e,t,l,p);!f.supportsFragments&&i.fragmentPreference>.55&&(d.push({trait:"steadiness",from:i.fragmentPreference,to:.45}),i.fragmentPreference=.45),f.maxSentenceLength&&i.sentenceLengthMean>f.maxSentenceLength&&(d.push({trait:"steadiness",from:i.sentenceLengthMean,to:f.maxSentenceLength}),i.sentenceLengthMean=f.maxSentenceLength);const u={...p},h=f.slots.reduce((P,b)=>{var L;const N=_d(b.paletteId,b.id,l,e,t,u,e.seed??"tone");P[b.id]=N;const _=(L=t.palettes.find(X=>X.id===b.paletteId))==null?void 0:L.entries.find(X=>X.id===N.entryId),H=_==null?void 0:_.motifId;return H&&(u[H]=(u[H]??0)+2),P},{}),S=Ld(f,h),x=e.motifState??{},y={templateId:f.id,text:S,slots:h,motifsApplied:Object.keys(u).filter(P=>(u[P]??0)>(x[P]??0))};return{traits:l,rhetoric:i,weights:n,clampLog:d,render:y,motifState:u,seed:e.seed??"tone",metadata:{authorId:e.author.id,personaId:e.persona.id,sceneId:(M=e.scene)==null?void 0:M.id,templateId:f.id}}},Vn={id:"author.vonnegut_brautigan_core",label:"Vonnegut-Brautigan Core Voice",influences:["plot.tone.guideline.1","plot.tone.guideline.2","plot.tone.guideline.7"],traits:{wit:.75,melancholy:.6,surrealism:.68,sarcasm:.55,warmth:.52,urgency:.48,steadiness:.5},rhetoric:{sentenceLengthMean:18,sentenceLengthStdDev:5,metaphorRate:.48,fragmentPreference:.22},templateBias:["template.deadpan.reassure","template.surreal.resilience"],fallbackTemplates:["template.deadpan.reassure"]},ms={id:"author.propaganda_glitch",label:"Glitched Broadcast Satire",influences:["plot.tone.guideline.4","plot.tone.guideline.2"],traits:{wit:.55,melancholy:.35,surrealism:.5,sarcasm:.7,warmth:.32,urgency:.6,steadiness:.44},rhetoric:{sentenceLengthMean:14,sentenceLengthStdDev:3,metaphorRate:.28,fragmentPreference:.32},templateBias:["template.urgent.push"],fallbackTemplates:["template.urgent.push"]},qn={[Vn.id]:Vn,[ms.id]:ms},_o=Vn.id,Lo=e=>qn[e]??qn[_o],Yn={id:"persona.trace",label:"Trace (Player)",personaTags:["player","resistance"],traits:{wit:.65,warmth:.54,urgency:.62,steadiness:.4,sarcasm:.58,melancholy:.47,surrealism:.44},rhetoric:{sentenceLengthMean:14,sentenceLengthStdDev:4,fragmentPreference:.28},motifBias:["motif.streetlight","motif.rain_hum"],templateBias:["template.urgent.push","template.deadpan.reassure"],lexiconOverrides:{directive:["Keep moving like the cameras forgot you.","Drift along the blackout fringe—quiet shoes, loud mission."]}},gs={id:"persona.amara_velez",label:"Amara Velez",personaTags:["mentor","resistance"],traits:{wit:.52,warmth:.66,urgency:.48,steadiness:.68,sarcasm:.38,melancholy:.55,surrealism:.42},rhetoric:{sentenceLengthMean:17,sentenceLengthStdDev:3,fragmentPreference:.18},motifBias:["motif.compass","motif.streetlight"],templateBias:["template.deadpan.reassure","template.surreal.resilience"],lexiconOverrides:{comfort:["Breathe—we’ve lived through harsher tides.","You held the line; I’ll hold the fallout."]}},hs={id:"persona.theo_anders",label:"Theo Anders",personaTags:["hacker","ally"],traits:{wit:.7,warmth:.5,urgency:.57,steadiness:.38,sarcasm:.64,melancholy:.42,surrealism:.58},rhetoric:{sentenceLengthMean:13,sentenceLengthStdDev:5,fragmentPreference:.36},motifBias:["motif.glowsticks","motif.rain_hum"],templateBias:["template.urgent.push"],lexiconOverrides:{opener:["Signal’s noisy but alive.","Console’s humming like a nervous choir."]}},ys={id:"persona.sadiq_rahm",label:"Sadiq Rahm",personaTags:["strategist","ally"],traits:{wit:.48,warmth:.4,urgency:.52,steadiness:.6,sarcasm:.46,melancholy:.58,surrealism:.36},rhetoric:{sentenceLengthMean:16,sentenceLengthStdDev:3,fragmentPreference:.22},motifBias:["motif.compass"],templateBias:["template.deadpan.reassure"],lexiconOverrides:{promise:["We bank this win, re-draw the map, hit harder tomorrow.","Blueprints shift in our favour; we keep walking."]}},Kn={[Yn.id]:Yn,[gs.id]:gs,[hs.id]:hs,[ys.id]:ys},jo=Yn.id,No=e=>Kn[e]??Kn[jo],bs={id:"scene.share_scarce_food",label:"Share Scarce Food",intent:"break bread after a risky supply run",traits:{warmth:.72,melancholy:.58,wit:.46,surrealism:.42,sarcasm:.3,urgency:.28,steadiness:.64},rhetoric:{sentenceLengthMean:17,metaphorRate:.38}},xs={id:"scene.post_ambush_reassurance",label:"Post-Ambush Reassurance",intent:"steady the squad after scraping through an ambush",traits:{warmth:.62,melancholy:.55,wit:.4,surrealism:.37,sarcasm:.34,urgency:.46,steadiness:.68},rhetoric:{sentenceLengthMean:16,fragmentPreference:.2}},ws={id:"scene.pre_heist_briefing",label:"Pre-Heist Briefing",intent:"sharpen focus during mission prep",traits:{warmth:.38,melancholy:.32,wit:.5,surrealism:.28,sarcasm:.52,urgency:.72,steadiness:.58},rhetoric:{sentenceLengthMean:14,fragmentPreference:.26}},vs={id:"scene.radio_counter_speech",label:"Counter-Broadcast Speech",intent:"mock the regime broadcast while rallying allies",traits:{warmth:.44,melancholy:.36,wit:.68,surrealism:.5,sarcasm:.74,urgency:.6,steadiness:.46},rhetoric:{sentenceLengthMean:15,sentenceLengthStdDev:4,fragmentPreference:.34}},Oo={[bs.id]:bs,[xs.id]:xs,[ws.id]:ws,[vs.id]:vs},Nd=e=>Oo[e],Od=[{id:"template.deadpan.reassure",label:"Deadpan Reassurance",template:"{{opener}} {{comfort}} {{promise}}",supportsFragments:!1,maxSentenceLength:22,requiredTraits:{warmth:.4,steadiness:.45},traitWeightBoost:{warmth:.6,steadiness:.3,wit:.2},slots:[{id:"opener",paletteId:"palette.opener.deadpan"},{id:"comfort",paletteId:"palette.comfort.solidarity"},{id:"promise",paletteId:"palette.promise.grit"}]},{id:"template.urgent.push",label:"Urgent Push",template:"{{urgent_intro}} {{directive}}",supportsFragments:!0,maxSentenceLength:18,requiredTraits:{urgency:.55},forbiddenTraits:{warmth:.85},traitWeightBoost:{urgency:.8,wit:.2,sarcasm:.3},slots:[{id:"urgent_intro",paletteId:"palette.urgent.intro",allowFragments:!0},{id:"directive",paletteId:"palette.directive.push",allowFragments:!0}]},{id:"template.surreal.resilience",label:"Surreal Resilience",template:"{{opener}} {{surreal_image}} {{resolution}}",supportsFragments:!1,maxSentenceLength:24,requiredTraits:{surrealism:.45},traitWeightBoost:{surrealism:.9,melancholy:.4,wit:.25},slots:[{id:"opener",paletteId:"palette.opener.deadpan"},{id:"surreal_image",paletteId:"palette.surreal.image"},{id:"resolution",paletteId:"palette.resolution.resilience"}]}],zd=[{id:"palette.opener.deadpan",slotId:"opener",defaultText:"Streetlight holds.",entries:[{id:"opener.streetlight",text:"Streetlight holds.",weight:1,traitInfluence:{steadiness:.4,warmth:.2},motifId:"motif.streetlight"},{id:"opener.ashtray",text:"Ashtray smoke braids the curfew alarm.",weight:.8,traitInfluence:{melancholy:.3,surrealism:.4},motifId:"motif.rain_hum"},{id:"opener.static",text:"Static licks the PA like a bored coyote.",weight:.9,traitInfluence:{wit:.3,sarcasm:.35}}]},{id:"palette.comfort.solidarity",slotId:"comfort",defaultText:"We bend so we do not break.",entries:[{id:"comfort.breathe",text:"Breathe; the city hums but our pulse sets tempo.",weight:1,traitInfluence:{warmth:.35,steadiness:.35}},{id:"comfort.hum",text:"We hum louder than their drones tonight.",weight:.9,traitInfluence:{wit:.25,urgency:.2},motifId:"motif.rain_hum"},{id:"comfort.coffee",text:"Ration coffee still tastes like defiance.",weight:.8,traitInfluence:{wit:.3,warmth:.3}}]},{id:"palette.promise.grit",slotId:"promise",defaultText:"We bank this and push the next door.",entries:[{id:"promise.grid",text:"Map updates in our favour; we move before dawn.",weight:1,traitInfluence:{urgency:.35,steadiness:.4},motifId:"motif.compass"},{id:"promise.neon",text:"Neon farms glow for us tonight if we choose.",weight:.85,traitInfluence:{surrealism:.4,warmth:.25}},{id:"promise.ledger",text:"Ledger tilts our way; we cash it in soon.",weight:.9,traitInfluence:{wit:.2,melancholy:.2}}]},{id:"palette.urgent.intro",slotId:"urgent_intro",defaultText:"Sirens kick a four count.",entries:[{id:"urgent.metro",text:"Metro lights stutter; sweepers reroute.",weight:1,traitInfluence:{urgency:.45,surrealism:.25},motifId:"motif.glowsticks"},{id:"urgent.chopper",text:"Chopper rotors chew the humidity early.",weight:.9,traitInfluence:{urgency:.4,sarcasm:.3}},{id:"urgent.clocks",text:"Every stolen clock ticks loud right now.",weight:.85,traitInfluence:{melancholy:.25,wit:.3}}]},{id:"palette.directive.push",slotId:"directive",defaultText:"Push past the surveillance bloom.",entries:[{id:"directive.sprint",text:"Sprint the blackout seam before it seals.",weight:1,traitInfluence:{urgency:.5,wit:.2}},{id:"directive.slide",text:"Slide between floodlights like you rehearsed it.",weight:.9,traitInfluence:{steadiness:.2,wit:.35},motifId:"motif.glowsticks"},{id:"directive.smile",text:"Smile like the scanners owe you rent.",weight:.75,traitInfluence:{sarcasm:.45}}]},{id:"palette.surreal.image",slotId:"surreal_image",defaultText:"Drones drift like bored gulls.",entries:[{id:"surreal.malls",text:"Flooded malls grow neon algae halos.",weight:1,traitInfluence:{surrealism:.55,melancholy:.25},motifId:"motif.rain_hum"},{id:"surreal.balloons",text:"Propaganda balloons sag like tired saints.",weight:.9,traitInfluence:{sarcasm:.3,wit:.25}},{id:"surreal.kites",text:"Kids fly hacked drones like paper kites.",weight:.85,traitInfluence:{warmth:.3,wit:.3}}]},{id:"palette.resolution.resilience",slotId:"resolution",defaultText:"We walk out together and louder.",entries:[{id:"resolution.compass",text:"Compass north re-centers on us tonight.",weight:1,traitInfluence:{steadiness:.45,warmth:.3},motifId:"motif.compass"},{id:"resolution.lunch",text:"Save me a ration bar; we earned dessert.",weight:.8,traitInfluence:{wit:.35,warmth:.25}},{id:"resolution.rain",text:"Let the rain mask our getaway beats.",weight:.85,traitInfluence:{melancholy:.3,surrealism:.3},motifId:"motif.rain_hum"}]}],Fd=()=>({authors:qn,personas:Kn,scenes:Oo,templates:Od,palettes:zd,motifDefaults:{"motif.streetlight":0,"motif.rain_hum":0,"motif.compass":0,"motif.glowsticks":0}}),Bd=()=>Lo(_o),Wd=()=>No(jo),Hd=e=>Nd(e),$d=(e,t)=>e?t?{...e,...t}:e:t,Gd=(e,t,n,r,s)=>`${e}::persona:${t}::author:${n}::scene:${r??"none"}::template:${s??"any"}`,Ud=(e,t)=>e?{...e}:t.motifDefaults?{...t.motifDefaults}:{},Vd=(e,t,n,r)=>{const s=(n==null?void 0:n.seedKey)??r??"default";return`${e.id}:${t.id}:${s}`},qd=(e,t)=>{var n;if(t!=null&&t.personaId)return t.personaId;if((n=e.toneDefaults)!=null&&n.personaId)return e.toneDefaults.personaId};class Yd{constructor(){Pe(this,"library");Pe(this,"motifStates");Pe(this,"cache");Pe(this,"defaultAuthor",Bd());Pe(this,"defaultPersona",Wd());Pe(this,"resolvePersona",t=>t?No(t):this.defaultPersona);Pe(this,"resolveShouldGenerate",t=>(t==null?void 0:t.useGenerated)!==!1);Pe(this,"reset",()=>{this.cache.clear(),this.motifStates.clear()});Pe(this,"resetDialogue",t=>{for(const n of this.cache.keys())n.startsWith(`${t}:`)&&this.cache.delete(n)});Pe(this,"resolveLine",t=>{const{dialogue:n,node:r,fallbackText:s,seedOverride:a}=t,l=$d(n.toneDefaults,r.tone);if(!l||!this.resolveShouldGenerate(l))return{text:s,source:"fallback"};const i=l.authorId?Lo(l.authorId):this.defaultAuthor,d=this.resolvePersona(qd(n,l)),p=l.sceneId?Hd(l.sceneId):void 0,f=Vd(n,r,l,a),u=Gd(f,d.id,i.id,p==null?void 0:p.id,l.templateId),h=this.cache.get(u);if(h)return{text:h.render.text,source:"generated",metadata:h};const S=Ud(this.motifStates.get(d.id),this.library),x=jd({author:i,persona:d,scene:p,requestedTemplateId:l.templateId,seed:f,motifState:S},this.library);return this.cache.set(u,x),this.motifStates.set(d.id,x.motifState),{text:x.render.text,source:"generated",metadata:x}});this.library=Fd(),this.motifStates=new Map,this.cache=new Map}}const Kd=new Yd,Xd=(e,t)=>{try{const n=Vi(e);return t==="charisma"?n.dialogueThresholdBonus:0}catch(n){console.warn("[DialogueSystem] Falling back to base stats for dialogue bonus.",n);const r=qi(e.skills);return t==="charisma"?r.dialogueThresholdBonus:0}},Qd=(e,t)=>{if(!t.skillCheck)return!0;const{skill:n,threshold:r,domain:s}=t.skillCheck;if((s??"attribute")==="skill"){const p=n;return(e.skillTraining[p]??0)>=r}const l=n,i=e.skills[l],d=Xd(e,l);return Ui(i,r,d)},Dn={blackout:["blackout","brownout"],smog:["smog","toxic","fumes"],surveillance:["surveillance","camera","drone"]},Ss=["ration bricks","filtered water packs","reactive dampeners","silenced carbines","patch kits"],Is=["battery bricks","jury-rigged lanterns","hand-crank dynamos"],ks=["homemade filters","charcoal respirators","sealed goggles"],Es=["signal scrubbers","anti-drone flares","masking foil"],Ts=["Keep your head down; CorpSec doubled patrol rotations.","George whispered about a convoy slipping through the south gate tonight.","If you see a checkpoint scanner, go around—no one’s calibrating them right now.","Word is the resistance safehouse stashed contraband in the hollow neon signs."],Zd=[{id:"merchant.default_greeting.resistanceFriend",roleId:"merchant",templateKey:"default_greeting",summary:"Warm greeting for resistance-aligned players during regular hours.",content:"Signal's clean for you. {{highlightItem}} just landed—priced for family. {{rumorHook}}",fallbackContent:"Welcome back. Supplies are stocked.",gating:{faction:[{factionId:"resistance",minimumReputation:25}],forbiddenTimesOfDay:["night"]},tokens:[{id:"highlightItem",fallback:"Ration bricks",resolve:(e,t)=>{const n=e.world.hazards.join(" ").toLowerCase();return Dn.blackout.some(r=>n.includes(r))?t.pickOne(Is,Is[0]):Dn.smog.some(r=>n.includes(r))?t.pickOne(ks,ks[0]):Dn.surveillance.some(r=>n.includes(r))?t.pickOne(Es,Es[0]):t.pickOne(Ss,Ss[0])}},{id:"rumorHook",fallback:"Stay nimble out there.",resolve:(e,t)=>t.pickOne(Ts,Ts[0])}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.amara_velez",useGenerated:!0},weight:3},{id:"merchant.default_greeting.curfewUrgent",roleId:"merchant",templateKey:"default_greeting",summary:"Curt greeting while curfew is active.",content:"Curfew sirens already spun up. {{highlightItem}} on the counter—take it and bolt.",fallbackContent:"Curfew's live. Make it quick.",gating:{requireCurfewActive:!0},tokens:[{id:"highlightItem",fallback:"Emergency stim kit",resolve:(e,t)=>e.player.perks.includes("quickDraw")?"reflex chems—your speed deserves it":e.player.perks.includes("toughness")?"impact gel armor—fits right onto your plates":t.pickOne(["emergency stim kit","flashburst grenade","thermal cloak"],"emergency stim kit")}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"merchant.default_greeting.corpsecWatcher",roleId:"merchant",templateKey:"default_greeting",summary:"Wary exchange when player reputation is low with CorpSec.",content:"CorpSec sniffers are wired to sniffing you. Credits up front, {{highlightItem}} after.",fallbackContent:"No trust, no chatter—show credits.",gating:{faction:[{factionId:"corpsec",maximumReputation:-10}]},tokens:[{id:"highlightItem",fallback:"scrambler chip",resolve:(e,t)=>t.pickOne(["scrambler chip","masking foil strip","signal foam"],"scrambler chip")}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"merchant.default_greeting.genericFallback",roleId:"merchant",templateKey:"default_greeting",summary:"Default line when no other gating applies.",content:"Stock's thin but serviceable. {{highlightItem}} still on the shelves.",fallbackContent:"Limited stock today.",tokens:[{id:"highlightItem",fallback:"standard issue kits",resolve:(e,t)=>t.pickOne(["standard issue kits","bulk rations","basic medpacks"],"basic medpacks")}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},weight:1,isFallback:!0}],Cs=["Keep your papers visible and your hands where the drones can see them.","If you spot a rebel courier, flag Ops immediately.","Curfew level's rising—movement passes expire at sundown.","Checkpoint scanners lag two beats; don't test them."],Ms=["Orders say we hit siege level if one more rumor spikes.","CorpSec command wants names; don't make me drag you in.","We're one alert away from full lockdown."],Jd=[{id:"checkpoint_guard.default_greeting.standard",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Baseline checkpoint greeting with procedural warning.",content:"Checkpoint Delta online. {{instructionHook}}",fallbackContent:"Checkpoint active. Move along.",tokens:[{id:"instructionHook",fallback:"Stay within curfew limits.",resolve:(e,t)=>t.pickOne(Cs,Cs[0])}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"checkpoint_guard.default_greeting.highAlert",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Escalated warning when curfew level is high.",content:"Alert tier is {{alertTier}}. Any resistance contact gets you cuffed.",fallbackContent:"High alert. Don't test me.",gating:{environment:[{flag:"curfewLevel",minimumNumeric:2}]},tokens:[{id:"alertTier",fallback:"escalating",resolve:e=>e.world.environmentFlags.curfewLevel>=3?"siege":"escalating"}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},weight:3},{id:"checkpoint_guard.default_greeting.blackout",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Warning when blackout tier is active.",content:"Power grid's unstable; blackout tier {{blackoutTier}}. Expect spot checks.",fallbackContent:"Power grid's shaky. Expect spot checks.",gating:{environment:[{flag:"blackoutTier",allowed:["brownout","rolling"]}]},tokens:[{id:"blackoutTier",fallback:"brownout",resolve:e=>e.world.environmentFlags.blackoutTier}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"checkpoint_guard.default_greeting.crackdown",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Threatening line for hostile resistance reputation.",content:"Your face is flagged on half the scanners in this grid. {{warning}}",fallbackContent:"I've got eyes on you.",gating:{faction:[{factionId:"resistance",maximumReputation:-10}]},tokens:[{id:"warning",fallback:"Step out of line and I'm calling it in.",resolve:(e,t)=>t.pickOne(Ms,Ms[0])}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"checkpoint_guard.default_greeting.nightShift",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Night-time variant referencing curfew sweeps.",content:"Night shift sweep in progress. Curfew papers or back to shelter.",fallbackContent:"Curfew papers or move.",gating:{allowedTimesOfDay:["night"]},toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},isFallback:!0}],Ps=["Keep wounds sealed; alley dust is lethal.","Rotating sutures hourly keeps CorpSec toxins from setting in.","Swap filters every hour—mutation spores love stagnant air.","Use the city's steam vents to sterilise gear if the clinic is compromised."],Rs=["Don't stack stim packs unless you want your heart to stage a protest.","Hydrate with electrolytes after each stim; trust me, you need them.","If the stim crash hits, sleep it off. No negotiation."],eu=[{id:"street_doc.default_greeting.resistanceAlly",roleId:"street_doc",templateKey:"default_greeting",summary:"Compassionate line for resistance allies.",content:"Clinic's running hot, but I carved out a cot for you. {{advice}}",fallbackContent:"Clinic's open for resistance blood.",gating:{faction:[{factionId:"resistance",minimumStanding:"friendly"}],forbiddenTimesOfDay:["night"]},tokens:[{id:"advice",fallback:"Stay hydrated and bandage often.",resolve:(e,t)=>t.pickOne(Ps,Ps[0])}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.amara_velez",useGenerated:!0},weight:2},{id:"street_doc.default_greeting.stimWarning",roleId:"street_doc",templateKey:"default_greeting",summary:"Warns players who lean on adrenaline perks.",content:"Saw your vitals spike mid-field. {{stimulantNote}}",fallbackContent:"Your vitals scream stim abuse.",gating:{forbiddenTimesOfDay:["morning"]},tokens:[{id:"stimulantNote",fallback:"Dial down the stim packs or you'll pancake.",resolve:(e,t)=>e.player.perks.includes("adrenalineRush")?t.pickOne(Rs,Rs[0]):"Your heart rate needs calm, not more gunfire."}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.amara_velez",useGenerated:!0}},{id:"street_doc.default_greeting.hazardClinic",roleId:"street_doc",templateKey:"default_greeting",summary:"Environmental note when hazardous clouds are active.",content:"Smog's thick tonight. I packed spare filters and anti-rad chems.",fallbackContent:"Air's poison. Use the filters.",gating:{requiredHazardKeywords:["smog","toxic","radiation"]},toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"street_doc.default_greeting.overrun",roleId:"street_doc",templateKey:"default_greeting",summary:"Terse line when curfew is active.",content:"I'm triaging patrol victims on the floor. Sit, bleed, talk later.",fallbackContent:"Busy. Sit and wait.",gating:{requireCurfewActive:!0},toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"street_doc.default_greeting.defaultFallback",roleId:"street_doc",templateKey:"default_greeting",summary:"General-purpose greeting.",content:"Slide onto the stool. Tools are clean; I made sure.",fallbackContent:"Seat's open. Let's patch you.",toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},isFallback:!0}],As=["CorpSec squads shifted to the mag-line every half hour.","Drone lattice thins out near the collapsed tram. Use it.","Rumor says resistance cracked the western floodgate. Check it tonight.","The scavengers set a new killbox under the viaduct. Don't stray."],Ds=["Step wrong and I tip off the enforcers.","You smell like CorpSec. Two words: back off.","My crew has eyes everywhere. Try nothing."],tu=[{id:"gang_scout.default_greeting.friendly",roleId:"gang_scout",templateKey:"default_greeting",summary:"Alliance tone when player reputation with scavengers is high.",content:"Scav nets flagged you green. {{intel}}",fallbackContent:"You're clear with the crew.",gating:{faction:[{factionId:"scavengers",minimumReputation:10}]},tokens:[{id:"intel",fallback:"Stick to the alleys; corp eyes are thick tonight.",resolve:(e,t)=>t.pickOne(As,As[0])}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"gang_scout.default_greeting.hostile",roleId:"gang_scout",templateKey:"default_greeting",summary:"Threatening line when player reputation is poor.",content:"Crew tagged you as trouble. {{warning}}",fallbackContent:"Crew doesn't trust you.",gating:{faction:[{factionId:"scavengers",maximumReputation:-5}]},tokens:[{id:"warning",fallback:"You move, we respond.",resolve:(e,t)=>t.pickOne(Ds,Ds[0])}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"gang_scout.default_greeting.blackoutRecon",roleId:"gang_scout",templateKey:"default_greeting",summary:"Intel drop during blackout scenarios.",content:"Blackout's blanketing the grid. Use it to ghost past scanners.",fallbackContent:"Blackout cover tonight. Move quiet.",gating:{environment:[{flag:"blackoutTier",allowed:["brownout","rolling"]}]},toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0}},{id:"gang_scout.default_greeting.nightWatch",roleId:"gang_scout",templateKey:"default_greeting",summary:"Night-only greeting referencing curfew sweeps.",content:"Night patrol spotted a CorpSec sweeper moving east. Stay in the shadows.",fallbackContent:"Night sweeps inbound. Stay sharp.",gating:{allowedTimesOfDay:["night"]},toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"gang_scout.default_greeting.fallback",roleId:"gang_scout",templateKey:"default_greeting",summary:"General-purpose line.",content:"Eyes are open. Feed me intel if you want safe passage.",fallbackContent:"Watch your angles out there.",toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},isFallback:!0}],_s=["Bunks are sanitised—don't bleed on them.","We rotate guard shifts every twenty minutes; slot in if you can.","Leave broken gear on the workbench; the techs are patching it nightly."],Ls=["Food stores run dry in two days unless the next convoy lands.","Filters arrive at dawn—ration what you have left.","Ammo press needs parts; scavenge springs if you spot any."],nu=[{id:"safehouse_handler.default_greeting.welcome",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Warm welcome when the player returns to a safehouse.",content:"Safehouse doors are sealed. {{restNote}}",fallbackContent:"Safehouse secured. Rest while you can.",tokens:[{id:"restNote",fallback:"Grab a bunk and breathe.",resolve:(e,t)=>t.pickOne(_s,_s[0])}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.amara_velez",useGenerated:!0},weight:2},{id:"safehouse_handler.default_greeting.lowSupplies",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Warns about low supplies when scarcity flag is high.",content:"Pantry's thin—{{supplyNote}}",fallbackContent:"Supplies low. Make your run count.",gating:{environment:[{flag:"supplyScarcity",allowed:["tight","rationed"]}]},tokens:[{id:"supplyNote",fallback:"stretch your rations.",resolve:(e,t)=>t.pickOne(Ls,Ls[0])}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0}},{id:"safehouse_handler.default_greeting.hazardShelter",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Highlights shelter when hazards are active outside.",content:"Outside's a killbox tonight. Trade routes stay closed until daybreak.",fallbackContent:"Outside is lethal right now. Stay in.",gating:{requiredHazardKeywords:["smog","radiation","patrol"]},toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0}},{id:"safehouse_handler.default_greeting.curfewShelter",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Curfew-specific shelter reminder.",content:"Curfew alarms are peaking. Lock-in lasts until morning.",fallbackContent:"Curfew locked. Sit tight.",gating:{requireCurfewActive:!0},toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0}},{id:"safehouse_handler.default_greeting.fallback",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Default handler line.",content:"We keep the lights dim and the exits mapped. Rest easy.",fallbackContent:"Safehouse steady.",toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},isFallback:!0}],ru=[...Zd,...Jd,...eu,...tu,...nu],su=ru.reduce((e,t)=>(e[t.roleId]||(e[t.roleId]=[]),e[t.roleId].push(t),e),{}),js=1,ou=(e,t)=>{const n=t[e.flag];return!(e.allowed&&e.allowed.length>0&&!e.allowed.includes(n)||e.forbidden&&e.forbidden.includes(n)||typeof n=="number"&&(typeof e.minimumNumeric=="number"&&n<e.minimumNumeric||typeof e.maximumNumeric=="number"&&n>e.maximumNumeric))},iu=(e,t,n)=>{try{const r=e.resolve(t,n);return n.ensure(r,e.fallback)}catch(r){return console.warn("[RoleTemplateResolver] Token resolver failed",e.id,r),e.fallback}},au=(e,t,n)=>{if(!e.tokens||e.tokens.length===0)return{};const r=Lt(`${n}::${e.id}::tokens`),s={rng:()=>r.next(),pickOne:(a,l)=>!a||a.length===0?l:a[r.nextInt(a.length)],ensure:(a,l)=>a&&a.trim().length>0?a:l};return e.tokens.reduce((a,l)=>(a[l.id]=iu(l,t,s),a),{})},Ns=(e,t)=>e?e.replace(/{{\s*([\w.]+)\s*}}/g,(n,r)=>{const s=t[r];return typeof s=="string"&&s.length>0?s:n}):"",lu=(e,t,n)=>!(t&&t.some(r=>!e.includes(r))||n&&n.some(r=>e.includes(r))),cu=(e,t)=>e.reputationSystemsEnabled===!1||!t||t.length===0?!0:t.every(n=>{var a;const r=((a=e.player.factionReputation)==null?void 0:a[n.factionId])??0;if(typeof n.minimumReputation=="number"&&r<n.minimumReputation||typeof n.maximumReputation=="number"&&r>n.maximumReputation)return!1;const s=Qn(r);if(n.minimumStanding){const l=ht(s.id),i=ht(n.minimumStanding);if(l<i)return!1}if(n.maximumStanding){const l=ht(s.id),i=ht(n.maximumStanding);if(l>i)return!1}return!0}),du=(e,t,n)=>!(t&&t.length>0&&!t.every(s=>e.some(a=>a.toLowerCase().includes(s.toLowerCase())))||n&&n.length>0&&n.some(s=>e.some(a=>a.toLowerCase().includes(s.toLowerCase())))),uu=(e,t)=>{const n=e.gating;if(!n)return!0;const{world:r,player:s,npc:a}=t;if(!cu(t,n.faction)||!lu(s.perks??[],n.requiresPerkIds,n.forbiddenPerkIds)||n.allowedTimesOfDay&&n.allowedTimesOfDay.length>0&&!n.allowedTimesOfDay.includes(r.timeOfDay)||n.forbiddenTimesOfDay&&n.forbiddenTimesOfDay.includes(r.timeOfDay)||typeof n.requireCurfewActive=="boolean"&&n.requireCurfewActive!==r.curfewActive||typeof n.forbidCurfewActive=="boolean"&&n.forbidCurfewActive===r.curfewActive||!du(r.hazards??[],n.requiredHazardKeywords,n.forbiddenHazardKeywords)||n.environment&&n.environment.length>0&&!n.environment.every(i=>ou(i,r.environmentFlags)))return!1;if(n.requiredNpcTags&&n.requiredNpcTags.length>0){const l=(a==null?void 0:a.tags)??[];if(!n.requiredNpcTags.every(d=>l.includes(d)))return!1}if(n.forbiddenNpcTags&&n.forbiddenNpcTags.length>0){const l=(a==null?void 0:a.tags)??[];if(n.forbiddenNpcTags.some(i=>l.includes(i)))return!1}return!(n.requiredZoneIds&&n.requiredZoneIds.length>0&&!n.requiredZoneIds.includes(r.zoneId))},fu=(e,t)=>{if(!e.length)return null;if(e.length===1)return e[0];const n=Lt(`${t}::templatePick`),r=e.reduce((a,l)=>a+(l.weight??js),0);let s=n.next()*r;for(const a of e)if(s-=a.weight??js,s<=0)return a;return e[n.nextInt(e.length)]},pu=(e,t)=>{const n=su[e];return n?n.filter(r=>r.templateKey===t):[]},mu=e=>{const{roleId:t,templateKey:n,context:r}=e,s=pu(t,n);if(s.length===0)return console.warn("[RoleTemplateResolver] Missing templates for role",t,"template",n),null;const a=s.filter(S=>uu(S,r)),l=a.length>0?a:s.filter(S=>S.isFallback)||s,i=e.seedOverride??r.randomSeed??`${t}:${n}`,d=fu(l,i)??l[0],p=`${i}::${d.seedHint??d.id}`,f=au(d,r,p),u=Ns(d.content,f),h=Ns(d.fallbackContent,f);return{templateId:d.id,roleId:t,text:u,fallbackText:h,tokens:f,seed:p,toneOverrides:d.toneOverrides,metadata:d.metadata}},Os=e=>e.charAt(0).toUpperCase()+e.slice(1),gu=/^\[roleTemplate:([a-zA-Z0-9_]+)\.([a-zA-Z0-9_]+)\]$/i,zs={resistance:0,corpsec:0,scavengers:0},_n=e=>e.objectives.some(t=>t.type!=="talk"&&!t.isCompleted),hu=e=>{if(!e)return null;const t=e.trim(),n=gu.exec(t);if(!n)return null;const[,r,s]=n;return{roleId:r,templateKey:s}},yu=()=>{const e=Le(),t=C(g=>g.quests.quests),n=C(g=>g.settings.locale),r=C(g=>!!g.settings.reputationSystemsEnabled),s=Xe(n),a=je(n),{logs:l}=s,i=C(g=>g.player.data),d=C(g=>g.world),[p,f]=jt.useState(null),u=(g,v="attribute")=>{if(v==="skill")try{return Zi(g).name}catch(E){return console.warn("[DialogueOverlay] Missing skill definition for",g,E),Os(g)}return a.skills[g]??Os(g)},h=c.useCallback(g=>{const v=t.find(k=>k.id===g);if(!v)return;let E=!1;if(v.rewards.forEach(k=>{switch(k.type){case"experience":k.amount>0&&(e(Fn({amount:k.amount,reason:`Quest complete: ${v.name}`})),e(O(l.rewardExperience(k.amount,v.name))),E=!0);break;case"currency":k.amount>0&&(e(Yi(k.amount)),e(O(l.rewardCredits(k.amount,v.name))));break;case"item":if(k.id){const w=Math.max(1,k.amount||1);for(let q=0;q<w;q+=1){const $={id:He(),name:k.id,description:a.dialogueOverlay.itemRecoveredDescription(v.name),weight:1,value:0,isQuestItem:!1};e(Zs($))}e(O(l.rewardItem(k.id,v.name)))}break}}),!E){const k=Math.max(40,(v.objectives.length||1)*30);e(Fn({amount:k,reason:`Quest complete: ${v.name}`})),e(O(l.rewardExperience(k,v.name)))}},[e,t,l,a]),S=c.useCallback(g=>{if(!g.questEffect)return;const{questId:v,effect:E,objectiveId:k}=g.questEffect;switch(E){case"start":{const w=t.find(q=>q.id===v);w&&!w.isActive&&!w.isCompleted&&(e(Js(v)),e(O(l.questAccepted(w.name))))}break;case"complete":{const w=t.find(q=>q.id===v);if(w&&w.isActive&&!w.isCompleted){if(_n(w))break;e(Xi(v)),h(v),e(O(l.questCompleted(w.name)))}}break;case"update":if(k){e(Ki({questId:v,objectiveId:k,isCompleted:!0}));const w=t.find($=>$.id===v),q=w==null?void 0:w.objectives.find($=>$.id===k);w&&q&&e(O(l.objectiveUpdated(q.description,w.name)))}break}},[e,h,t,l]),{activeDialogue:{dialogueId:x,currentNodeId:y},dialogues:M}=C(g=>g.quests),P=c.useMemo(()=>x?M.find(g=>g.id===x)??null:null,[x,M]),b=c.useMemo(()=>!P||P.nodes.length===0?null:P.nodes.find(v=>v.id===y)??P.nodes[0],[P,y]),N=c.useMemo(()=>{var q,$,le;if(!P||!b)return null;const g=P.nodes.find(fe=>fe.id===b.id)??b;let v=g.text,E=g,k;const w=hu(g.text);if(w&&i&&d){const fe=w.roleId,{templateKey:he}=w,V={level:i.level,perks:i.perks??[],factionReputation:r?i.factionReputation??zs:zs},J={locale:n,reputationSystemsEnabled:r,player:V,world:{timeOfDay:d.timeOfDay,curfewActive:d.curfewActive,zoneId:((q=d.currentMapArea)==null?void 0:q.zoneId)??"unknown_zone",zoneName:($=d.currentMapArea)==null?void 0:$.name,hazards:((le=d.currentMapArea)==null?void 0:le.hazards)??[],environmentFlags:d.environment.flags},npc:void 0,randomSeed:`${P.id}:${g.id}`},ae=mu({roleId:fe,templateKey:he,context:J});ae&&(v=ae.text,k=ae.seed,E={...g,text:ae.text,tone:{...g.tone??{},...ae.toneOverrides??{}}})}return{dialogue:P,node:E,fallbackText:v,seedOverride:k}},[P,b,n,i,d,r]),_=c.useMemo(()=>N?Kd.resolveLine({dialogue:N.dialogue,node:N.node,fallbackText:N.fallbackText,seedOverride:N.seedOverride}):null,[N]),H=c.useCallback(g=>{if(!g.questEffect)return null;const v=t.find(E=>{var k;return E.id===((k=g.questEffect)==null?void 0:k.questId)});if(!v)return null;switch(g.questEffect.effect){case"start":if(v.isCompleted)return"alreadyCompleted";if(v.isActive)return"alreadyActive";break;case"complete":if(v.isCompleted)return"alreadyCompleted";if(!v.isActive)return"notActive";if(_n(v))return"objectivesIncomplete";break;case"update":if(g.questEffect.objectiveId){const E=v.objectives.find(k=>{var w;return k.id===((w=g.questEffect)==null?void 0:w.objectiveId)});if(E!=null&&E.isCompleted)return"objectiveCompleted"}break}return null},[t]),L=c.useCallback(g=>{if(!g.questEffect)return!0;const v=t.find(E=>{var k;return E.id===((k=g.questEffect)==null?void 0:k.questId)});if(!v)return!1;switch(g.questEffect.effect){case"start":return!v.isActive&&!v.isCompleted;case"complete":return v.isActive&&!v.isCompleted&&!_n(v);case"update":return!v.isActive||v.isCompleted?!1:g.questEffect.objectiveId?!v.objectives.some(E=>{var k;return E.id===((k=g.questEffect)==null?void 0:k.objectiveId)&&E.isCompleted}):!0;default:return!0}},[t]),X=c.useCallback(g=>H(g)?!0:g.skillCheck?!Qd(i,g):!1,[H,i]),re=c.useMemo(()=>b?b.options.filter(L):[],[b,L]),pe=c.useCallback(g=>{X(g)||(S(g),g.nextNodeId?e(Qi(g.nextNodeId)):e(tn()))},[e,S,X]);if(c.useEffect(()=>{if(!b)return;const g=E=>{var $;if(E.target instanceof HTMLElement&&(E.target.tagName==="INPUT"||E.target.tagName==="TEXTAREA"||E.target.getAttribute("contenteditable")==="true"))return;let k=null;if(/^[0-9]$/.test(E.key))k=Number(E.key);else if(($=E.code)!=null&&$.startsWith("Numpad")){const le=Number(E.code.replace("Numpad",""));k=Number.isNaN(le)?null:le}if(k===null||k<1)return;const w=k-1,q=re[w];q&&(E.preventDefault(),E.stopPropagation(),typeof E.stopImmediatePropagation=="function"&&E.stopImmediatePropagation(),pe(q))},v={capture:!0};return window.addEventListener("keydown",g,v),()=>{window.removeEventListener("keydown",g,v)}},[b,pe,re]),!x||!P||!b)return null;const F=(_==null?void 0:_.text)??(b==null?void 0:b.text)??"...";return o.jsx("div",{style:{position:"absolute",inset:0,display:"flex",alignItems:"flex-end",justifyContent:"center",pointerEvents:"none"},children:o.jsxs("div",{style:{width:"min(620px, 90%)",marginBottom:"calc(var(--bottom-panel-height, 0px) + 2.5rem)",background:"linear-gradient(160deg, rgba(15, 23, 42, 0.94), rgba(15, 23, 42, 0.78))",border:"1px solid rgba(148, 163, 184, 0.35)",borderRadius:"18px",padding:"1.5rem 1.7rem",color:"#e2e8f0",fontFamily:"'DM Sans', 'Inter', sans-serif",boxShadow:"0 28px 48px rgba(15, 23, 42, 0.55)",pointerEvents:"auto",display:"flex",flexDirection:"column",gap:"1.2rem"},children:[o.jsxs("div",{children:[o.jsx("span",{style:{display:"block",fontSize:"0.72rem",letterSpacing:"0.28em",textTransform:"uppercase",color:"rgba(148, 163, 184, 0.85)",marginBottom:"0.35rem"},children:P.npcId}),o.jsx("h2",{style:{fontSize:"1.28rem",fontWeight:700,margin:0,color:"#f8fafc"},children:F})]}),o.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"0.75rem"},children:re.map((g,v)=>{const E=X(g),k=g.skillCheck?`${u(g.skillCheck.skill,g.skillCheck.domain??"attribute")} ${g.skillCheck.threshold}`:null,w=H(g),q=w?a.dialogueOverlay.questLocks[w]:k?E?a.dialogueOverlay.requiresSkill(k):a.dialogueOverlay.checkSkill(k):null;return o.jsxs("button",{type:"button",onClick:()=>pe(g),onMouseEnter:()=>!E&&f(v),onMouseLeave:()=>f(null),style:{border:E?"1px solid rgba(148, 163, 184, 0.3)":p===v?"1px solid rgba(96, 165, 250, 0.7)":"1px solid rgba(96, 165, 250, 0.4)",borderRadius:"12px",padding:"0.85rem 1rem",background:E?"linear-gradient(135deg, rgba(15, 23, 42, 0.65), rgba(30, 41, 59, 0.75))":p===v?"linear-gradient(135deg, rgba(37, 99, 235, 0.35), rgba(56, 189, 248, 0.3))":"linear-gradient(135deg, rgba(37, 99, 235, 0.22), rgba(56, 189, 248, 0.18))",color:E?"rgba(148, 163, 184, 0.8)":"#e2e8f0",fontSize:"0.9rem",textAlign:"left",cursor:E?"not-allowed":"pointer",display:"flex",gap:"0.6rem",alignItems:"center",opacity:E?.75:1,pointerEvents:E?"none":"auto",boxShadow:E?"none":p===v?"0 0 20px rgba(56, 189, 248, 0.4), 0 4px 12px rgba(0, 0, 0, 0.3)":"0 0 8px rgba(56, 189, 248, 0.15)",transform:p===v&&!E?"translateY(-2px)":"translateY(0)",transition:"all 0.2s cubic-bezier(0.4, 0, 0.2, 1)"},children:[o.jsx("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:"1.25rem",height:"1.25rem",borderRadius:"50%",background:E?"rgba(148, 163, 184, 0.25)":"rgba(96, 165, 250, 0.35)",color:E?"#cbd5f5":"#bfdbfe",fontWeight:600,fontSize:"0.75rem"},children:v+1}),o.jsx("span",{style:{flex:1},children:g.text}),q&&o.jsx("span",{style:{fontSize:"0.68rem",textTransform:"uppercase",letterSpacing:"0.16em",color:E?"#f87171":"#5eead4"},children:q})]},`${g.text}-${v}`)})}),o.jsx("span",{style:{fontSize:"0.68rem",color:"rgba(148, 163, 184, 0.7)",textAlign:"right",letterSpacing:"0.22em",textTransform:"uppercase"},children:a.dialogueOverlay.escHint})]})})},bu=(...e)=>e.filter(Boolean).join(" "),xu=({showCompleted:e=!1})=>{const t=C(x=>x.quests.quests),n=C(x=>x.settings.locale),r=je(n),s=t.filter(x=>x.isActive&&!x.isCompleted),a=t.filter(x=>x.isCompleted).sort((x,y)=>x.name.localeCompare(y.name)),l=e?a:a.slice(0,1),i=s.length>0,d=e?l.length>0:!1,p=e?s.length+l.length>2:s.length>1,f=(x,y)=>x<=0?null:n==="en"?x>1?`${x} ${y}s`:`${x} ${y}`:`${x} ${y}`,u=x=>{const y=t.find(_=>_.id===x);if(!y)return null;const M=y.rewards.filter(_=>_.type==="currency").reduce((_,H)=>_+H.amount,0),P=y.rewards.filter(_=>_.type==="experience").reduce((_,H)=>_+H.amount,0),b=y.rewards.filter(_=>_.type==="item"),N=[M?r.questLog.currencyLabel(M):null,P?r.questLog.experienceLabel(P):null,...b.map(_=>f(Math.max(1,_.amount||1),_.id??r.questLog.supplyFallback))].filter(Boolean);return N.length===0?null:o.jsxs("div",{className:"text-[0.68rem] uppercase tracking-[0.18em] text-[#34d399]",children:[r.questLog.rewardsHeading,": ",N.join(" • ")]})},h=x=>o.jsxs("div",{className:"hud-ops-card hud-ops-card--active flex flex-col gap-3.5 p-[0.95rem]",children:[o.jsx("div",{className:"text-[0.92rem] font-semibold tracking-[0.08em] text-slate-50",children:x.name}),o.jsx("p",{className:"hud-ops-text-muted text-[0.78rem] leading-[1.55]",children:x.description}),o.jsx("div",{className:"flex flex-col gap-3",children:x.objectives.map(y=>o.jsxs("div",{className:"flex items-start gap-[0.55rem] text-[0.76rem] text-[#cbd5f5]",children:[o.jsx("span",{"aria-hidden":"true",className:"hud-ops-objective-check mt-[2px]","data-completed":y.isCompleted,children:"✓"}),o.jsx("span",{className:"flex-1 leading-tight",children:y.description}),y.count&&o.jsxs("span",{className:"text-[0.65rem] uppercase tracking-[0.16em] text-[#facc15]",children:[y.currentCount??0,"/",y.count]})]},y.id))}),u(x.id)]},x.id),S=x=>o.jsxs("div",{className:"hud-ops-card hud-ops-card--completed flex flex-col gap-3.5 p-[0.9rem]",children:[o.jsxs("div",{className:"flex items-center justify-between gap-[0.75rem]",children:[o.jsx("div",{className:"text-[0.85rem] font-semibold tracking-[0.05em] text-[#ede9fe]",children:x.name}),o.jsx("span",{"aria-hidden":"true",className:"hud-ops-complete-badge inline-flex h-[1.25rem] w-[1.25rem] items-center justify-center rounded-[0.35rem] text-[0.78rem] font-bold",children:"✓"})]}),o.jsx("p",{className:"hud-ops-text-muted text-[0.74rem] leading-[1.6]",children:x.description})]},x.id);return!i&&!d?o.jsx("div",{className:"hud-ops-empty flex flex-1 items-center justify-center text-xs italic",children:r.questLog.empty}):o.jsxs("div",{className:bu("flex flex-col gap-3.5 pr-1",p?"overflow-y-auto":"overflow-y-hidden"),children:[i&&s.map(x=>h(x)),e&&d&&l.map(x=>S(x))]})},Fs=jt.memo(xu),on={cyan:"#38bdf8",textPrimary:"#f8fafc",textSecondary:"rgba(226, 232, 240, 0.78)",textMuted:"rgba(148, 163, 184, 0.72)"},qf={background:"rgba(15, 23, 42, 0.6)",borderRadius:"12px",border:"1px solid rgba(148, 163, 184, 0.18)",padding:"0.8rem",boxShadow:"inset 0 1px 0 rgba(148, 163, 184, 0.18)"},Yf={display:"flex",flexDirection:"column",gap:"0.14rem"},Kf={fontSize:"0.52rem",letterSpacing:"0.19em",textTransform:"uppercase",color:"rgba(148, 163, 184, 0.72)"},Xf={fontSize:"0.72rem",fontWeight:600,letterSpacing:"0.05em",color:"#f8fafc",margin:0},Qf={fontFamily:'"DM Sans", "Inter", sans-serif',fontSize:"0.85rem",fontWeight:700,color:on.textPrimary},Zf={fontFamily:'"DM Sans", "Inter", sans-serif',fontSize:"0.62rem",color:on.textMuted},Jf=(e,t)=>({background:`linear-gradient(135deg, ${e}, ${t})`,WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text"}),wu=(e,t=8)=>({textShadow:`0 0 ${t}px ${e}, 0 0 ${t*2}px ${e}40`}),Bs=24,vu=e=>{if(!e)return null;const t=e.canvasDisplayWidth/(e.canvasWidth||1),n=e.canvasDisplayHeight/(e.canvasHeight||1);return{x:e.canvasLeft+e.screenX*t,y:e.canvasTop+e.screenY*n}},Su=()=>{const[e,t]=c.useState(null),n=c.useRef(null),r=c.useCallback(s=>{n.current=s;const a=vu(s);a&&t(a)},[]);return c.useEffect(()=>{if(typeof window<"u"){const s=window.__getawayPlayerScreenPosition;s&&r(s)}},[r]),c.useEffect(()=>{const s=a=>{r(a.detail)};return window.addEventListener(nn,s),()=>window.removeEventListener(nn,s)},[r]),c.useEffect(()=>{const s=()=>{n.current&&r(n.current)};return window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[r]),e},Iu=({notification:e,onComplete:t})=>{const[n,r]=c.useState(!1);c.useEffect(()=>{const i=setTimeout(()=>r(!0),10),d=setTimeout(()=>{r(!1),setTimeout(()=>t(e.id),200)},2200);return()=>{clearTimeout(i),clearTimeout(d)}},[e.id,t]);const s={display:"inline-flex",alignItems:"center",gap:"0.28rem",padding:"0.28rem 0.45rem",minWidth:"fit-content",background:"linear-gradient(150deg, rgba(7, 13, 26, 0.92) 0%, rgba(12, 148, 136, 0.58) 100%)",border:"1px solid rgba(56, 189, 248, 0.45)",borderRadius:"999px",boxShadow:"0 10px 18px -16px rgba(13, 148, 136, 0.55)",opacity:n?1:0,transform:n?"translateY(0)":"translateY(10px)",transition:"opacity 0.18s ease-out, transform 0.18s ease-out",pointerEvents:"none"},a={fontSize:"0.9rem",fontWeight:800,letterSpacing:"0.16em",textTransform:"uppercase",color:on.textPrimary,...wu(on.cyan,6)},l={fontSize:"0.55rem",fontWeight:700,letterSpacing:"0.24em",textTransform:"uppercase",color:"rgba(148, 233, 255, 0.92)"};return o.jsxs("div",{style:s,children:[o.jsxs("span",{style:a,children:["+",e.amount]}),o.jsx("span",{style:l,children:"XP"})]})},ku=({notifications:e,onDismiss:t})=>{const n=Su(),r=c.useMemo(()=>({right:28,top:72}),[]);return o.jsx(o.Fragment,{children:e.map((s,a)=>{const l=n&&typeof window<"u"?(()=>{const i=(S,x,y)=>Math.min(Math.max(S,x),y),d=window.innerWidth||r.right*2,p=window.innerHeight||r.top*2,f=i(n.x,24,d-24),u=i(n.y,24,p-24),h=i(u-56-a*Bs,16,p-16);return{position:"fixed",left:f,top:h,transform:"translateX(-50%)",zIndex:9998,pointerEvents:"none"}})():{position:"fixed",right:`${r.right}px`,top:`${r.top+a*Bs}px`,zIndex:9998,pointerEvents:"none"};return o.jsx("div",{style:l,children:o.jsx(Iu,{notification:s,onComplete:t})},s.id)})})},Eu=()=>{const{currentMapArea:e,inCombat:t,engagementMode:n}=C(h=>h.world),r=C(h=>h.surveillance.hud),s=C(h=>!!h.settings.reputationSystemsEnabled),a=C(h=>h.world.currentMapArea.zoneId),l=C(h=>{var S;return s?(S=h.suspicion.zones[a])==null?void 0:S.heat:void 0}),[i,d]=c.useState(()=>new Date),p=n==="stealth",f=n==="dialog",u=c.useMemo(()=>{const h=(r==null?void 0:r.detectionProgress)??0,S=(l==null?void 0:l.totalHeat)??0,x=Math.max(0,Math.min(100,Math.round(S)));return Math.max(h,x)},[r==null?void 0:r.detectionProgress,l==null?void 0:l.totalHeat]);return c.useEffect(()=>{const h=window.setInterval(()=>d(new Date),1e3);return()=>window.clearInterval(h)},[]),o.jsxs("div",{className:"pointer-events-none absolute inset-0 select-none font-mono uppercase tracking-[0.18em] text-[#38bdf8]",children:[o.jsx("div",{className:"hud-corner","data-position":"top-left"}),o.jsx("div",{className:"hud-corner","data-position":"top-right"}),o.jsx("div",{className:"hud-corner","data-position":"bottom-right"}),o.jsx("div",{className:"hud-corner","data-position":"bottom-left"}),o.jsxs("div",{className:"hud-frame-top",children:[o.jsxs("div",{className:"hud-frame-chip","data-state":t?"alert":p?"stealth":"idle",children:[o.jsx("span",{className:"text-[0.45rem]",children:"●"}),o.jsx("span",{children:t?"COMBAT":p?"STEALTH":f?"DIALOG":"TACTICAL"})]}),o.jsxs("div",{className:"hud-frame-chip",children:[o.jsx("span",{children:"LOC"}),o.jsx("span",{className:"text-slate-100",children:(e==null?void 0:e.id)??"UNKNOWN"})]}),o.jsx("div",{className:"hud-frame-chip",children:o.jsx("span",{children:i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"})})})]}),o.jsx("div",{className:"hud-threat","data-alert":t?"true":"false",children:p?o.jsxs("span",{children:["DETECTION: ",u,"%"]}):f?o.jsx(o.Fragment,{children:"DIALOG MODE ACTIVE"}):o.jsxs(o.Fragment,{children:["THREAT LEVEL: ",t?"HOSTILE":"CLEAR"]})}),o.jsx("div",{className:"hud-frame-line","data-orientation":"top"}),o.jsx("div",{className:"hud-frame-line","data-orientation":"bottom"})]})},Tu=({value:e,gridX:t,gridY:n,type:r,label:s,onComplete:a})=>{const[l,i]=c.useState(!0),[d,p]=c.useState(null),f=c.useRef(null),u=C(b=>b.player.data.position),h=c.useCallback(b=>{if(!b)return;f.current=b;const N=t-u.x,_=n-u.y,H=64,L=H,X=H/2,re=(N-_)*(L/2),pe=(N+_)*(X/2),F=b.worldX+re,g=b.worldY+pe,v=b.worldX-b.screenX/b.zoom,E=b.worldY-b.screenY/b.zoom,k=(F-v)*b.zoom,w=(g-E)*b.zoom,q=b.canvasDisplayWidth/b.canvasWidth,$=b.canvasDisplayHeight/b.canvasHeight,le=b.canvasLeft+k*q,fe=b.canvasTop+w*$;p({x:le,y:fe})},[t,n,u.x,u.y]);if(c.useEffect(()=>{if(typeof window<"u"){const b=window.__getawayPlayerScreenPosition;b&&h(b)}},[h]),c.useEffect(()=>{const b=N=>{h(N.detail)};return window.addEventListener(nn,b),()=>window.removeEventListener(nn,b)},[h]),c.useEffect(()=>{const b=setTimeout(()=>{i(!1),a==null||a()},1500);return()=>clearTimeout(b)},[a]),!l||!d)return null;const x=(()=>{switch(r){case"damage":return{color:"#ef4444",glow:"rgba(239, 68, 68, 0.8)",prefix:"-",scale:1};case"heal":return{color:"#34d399",glow:"rgba(52, 211, 153, 0.8)",prefix:"+",scale:1};case"crit":return{color:"#fbbf24",glow:"rgba(251, 191, 36, 0.9)",prefix:"-",scale:1.4};case"miss":return{color:"#94a3b8",glow:"rgba(148, 163, 184, 0.6)",prefix:"",scale:.9};case"block":return{color:"#38bdf8",glow:"rgba(56, 189, 248, 0.8)",prefix:"",scale:1};case"pickup":return{color:"#22d3ee",glow:"rgba(34, 211, 238, 0.85)",prefix:"+",scale:1.05};default:return{color:"#ffffff",glow:"rgba(255, 255, 255, 0.6)",prefix:"",scale:1}}})(),y=r==="miss"?"MISS":r==="block"?"BLOCK":r==="pickup"?`PICKED UP: ${e>1?`${e}x `:""}${s??(e===1?"ITEM":"ITEMS")}`:`${x.prefix}${e}`,M={position:"fixed",left:`${d.x}px`,top:`${d.y}px`,transform:"translate(-50%, -100%)",pointerEvents:"none",userSelect:"none",zIndex:1e4,animation:"floatUp 1.5s cubic-bezier(0.4, 0, 0.2, 1) forwards"},P={fontSize:`${1.2*x.scale}rem`,fontWeight:r==="crit"?900:800,color:x.color,textShadow:`0 0 12px ${x.glow}, 0 0 6px ${x.glow}, 0 2px 4px rgba(0, 0, 0, 0.8)`,fontFamily:'"DM Mono", "IBM Plex Mono", monospace',letterSpacing:"0.05em",WebkitTextStroke:r==="crit"?`1px ${x.color}dd`:"none"};return o.jsxs(o.Fragment,{children:[o.jsx("style",{children:`
        @keyframes floatUp {
          0% {
            transform: translateY(0) scale(${x.scale*.8});
            opacity: 0;
          }
          20% {
            opacity: 1;
          }
          100% {
            transform: translateY(-60px) scale(${x.scale});
            opacity: 0;
          }
        }
      `}),o.jsx("div",{style:M,children:o.jsx("span",{style:P,children:y})})]})},Cu=({active:e,type:t="damage",intensity:n=.6,duration:r=300})=>{const[s,a]=c.useState(!1);if(c.useEffect(()=>{if(e){a(!0);const p=setTimeout(()=>{a(!1)},r);return()=>clearTimeout(p)}},[e,r]),!s)return null;const d={...{position:"absolute",inset:0,pointerEvents:"none",zIndex:9999,animation:`hitFlash ${r}ms ease-out forwards`},...(()=>{switch(t){case"damage":return{background:`radial-gradient(circle at center, rgba(239, 68, 68, ${Math.max(0,n*.22)}) 0%, rgba(239, 68, 68, 0) 65%)`,mixBlendMode:"screen"};case"heal":return{background:`rgba(52, 211, 153, ${n})`,mixBlendMode:"lighten"};case"crit":return{background:`rgba(251, 191, 36, ${n*.8})`,mixBlendMode:"screen"};case"block":return{background:`rgba(56, 189, 248, ${n*.7})`,mixBlendMode:"screen"};default:return{background:`rgba(255, 255, 255, ${n})`,mixBlendMode:"screen"}}})()};return o.jsxs(o.Fragment,{children:[o.jsx("style",{children:`
        @keyframes hitFlash {
          0% {
            opacity: 1;
          }
          100% {
            opacity: 0;
          }
        }
      `}),o.jsx("div",{style:d})]})},Mu=()=>{const e=Le(),{floatingNumbers:t,activeFlashId:n,hitFlashes:r}=C(a=>a.combatFeedback),s=r.find(a=>a.id===n);return o.jsxs(o.Fragment,{children:[s&&o.jsx(Cu,{active:!0,type:s.type,intensity:s.intensity,duration:s.duration}),t.map(a=>o.jsx(Tu,{value:a.value,gridX:a.gridX,gridY:a.gridY,type:a.type,label:a.label,onComplete:()=>e(Ji(a.id))},a.id))]})},Pu={position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",pointerEvents:"none",zIndex:20},Ru={padding:"1.8rem 3rem",borderRadius:"18px",background:"rgba(15, 23, 42, 0.85)",border:"1px solid rgba(248, 250, 252, 0.35)",boxShadow:"0 40px 60px rgba(15, 23, 42, 0.55)",display:"flex",flexDirection:"column",alignItems:"center",gap:"0.6rem",textAlign:"center",color:"#f8fafc",letterSpacing:"0.28em",textTransform:"uppercase"},Au={fontSize:"1.6rem",fontWeight:800},Du={fontSize:"0.85rem",fontWeight:600,opacity:.8},_u=()=>{const e=Le(),t=C(n=>n.surveillance.curfewBanner.visible);return c.useEffect(()=>{if(!t)return;const n=window.setTimeout(()=>{e(Ys({visible:!1,timestamp:Date.now()}))},3e3);return()=>{window.clearTimeout(n)}},[t,e]),t?o.jsx("div",{style:Pu,"aria-live":"assertive","aria-atomic":"true",children:o.jsxs("div",{style:Ru,role:"alert",children:[o.jsx("span",{style:Au,children:"Curfew Active"}),o.jsx("span",{style:Du,children:"Surveillance Engaged"})]})}):null},Lu=e=>e.hudLayout.override,ju=Y([Lu,e=>e.world.inCombat],(e,t)=>e||(t?"combat":"exploration")),Nu=()=>{const e=Le(),t=C(Ne),n=C(sr),r=c.useRef(!1),s=c.useRef(!1);return c.useEffect(()=>{const a=(t==null?void 0:t.allPrimaryComplete)??!1;a&&!r.current&&!n&&e(ea()),r.current=a},[t==null?void 0:t.allPrimaryComplete,n,e]),c.useEffect(()=>{if(!t){s.current=!1;return}n&&!s.current&&(ad({level:t.level,levelId:t.levelId,name:t.name}),e(Zt({type:"missionCompletion",missionId:t.levelId})),s.current=!0),n||(s.current=!1)},[e,n,t]),null},ir=e=>!!e.settings.reputationSystemsEnabled,Ou={resistance:0,corpsec:0,scavengers:0},zu=[],Fu=[],zo=e=>e.player.data.factionReputation,Bu=e=>e.player.pendingFactionEvents;Y(zo,ir,(e,t)=>t?e:Ou);const Wu=Y(Bu,ir,(e,t)=>!t||e.length===0?zu:e),ep=Y(zo,ir,(e,t)=>t?ta().map(({id:r})=>{const s=ra(r),a=na(r,e[r]??s.definition.defaultReputation);return{factionId:r,name:s.definition.name,description:s.definition.description,value:a.value,standingId:a.standing.id,standingLabel:a.standing.label,color:a.standing.color,icon:a.standing.icon,effects:a.effects,nextThreshold:a.nextThreshold}}):Fu),Hu={position:"fixed",top:"80px",right:"28px",display:"flex",flexDirection:"column",gap:"0.45rem",zIndex:9999,pointerEvents:"none"},$u=e=>({minWidth:"220px",maxWidth:"280px",borderRadius:"12px",border:`1px solid ${e}`,background:"rgba(15, 23, 42, 0.92)",boxShadow:"0 18px 32px rgba(2, 6, 23, 0.45)",padding:"0.55rem 0.7rem",display:"flex",flexDirection:"column",gap:"0.28rem",color:"rgba(226, 232, 240, 0.95)",pointerEvents:"auto"}),Gu={fontSize:"0.64rem",letterSpacing:"0.12em",textTransform:"uppercase"},Ws={fontSize:"0.58rem",lineHeight:1.35,color:"rgba(203, 213, 225, 0.92)"},Hs=e=>e===0?"±0":`${e>0?"+":""}${e}`,Uu=4200,Vu=()=>{const e=Le(),t=C(Wu),n=C(f=>f.settings.locale),r=C(f=>!!f.settings.reputationSystemsEnabled),s=c.useMemo(()=>je(n),[n]),a=s.playerStatus.factions,[l,i]=c.useState([]),d=c.useRef({}),p=c.useCallback(f=>{i(h=>h.filter(S=>S.id!==f));const u=d.current[f];u&&(window.clearTimeout(u),delete d.current[f])},[]);return c.useEffect(()=>{if(!r){Object.values(d.current).forEach(u=>window.clearTimeout(u)),d.current={},i(u=>u.length>0?[]:u);return}if(!t.length)return;const f=[];t.forEach(u=>{const h=a[u.factionId]??u.factionId,S=u.standingChanges.find(F=>F.factionId===u.factionId),x=u.standingChanges.find(F=>F.factionId!==u.factionId),y=Object.entries(u.rivalDeltas??{}),M=y.length>0?y[0]:void 0,P=u.reason?s.factionToast.reasons[u.reason]??u.reason:void 0,b=Hs(u.delta),N=S?en(n,S.nextStanding):void 0,_=N?s.factionToast.standingChange(N):void 0,H=x?en(n,x.nextStanding):void 0,L=M?s.factionToast.rivalChange(a[M[0]]??M[0],Hs(M[1]),H):void 0,X=s.factionToast.reputationChange(h,b,P),re=`${u.factionId}-${u.timestamp}`,pe=u.delta>0?"rgba(56, 189, 248, 0.65)":u.delta<0?"rgba(248, 113, 113, 0.65)":"rgba(148, 163, 184, 0.65)";f.push({id:re,factionId:u.factionId,message:X,standingNote:_,rivalNote:L,color:pe}),e(O(X)),_&&_!==X&&e(O(_)),L&&e(O(L))}),i(u=>[...u,...f].slice(-6)),f.forEach(u=>{const h=window.setTimeout(()=>p(u.id),Uu);d.current[u.id]=h}),e(sa())},[e,t,a,n,p,s.factionToast,r]),c.useEffect(()=>()=>{Object.values(d.current).forEach(f=>window.clearTimeout(f)),d.current={}},[]),!r||l.length===0?null:o.jsx("div",{style:Hu,"aria-live":"polite","aria-atomic":"false",children:l.map(f=>o.jsxs("div",{style:$u(f.color),role:"status","aria-live":"polite",children:[o.jsx("span",{style:Gu,children:f.message}),f.standingNote&&o.jsx("span",{style:Ws,children:f.standingNote}),f.rivalNote&&o.jsx("span",{style:Ws,children:f.rivalNote})]},f.id))})},qu={position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(15, 23, 42, 0.86)",backdropFilter:"blur(6px)",zIndex:20,padding:"1.5rem"},Yu={width:"min(520px, 92vw)",borderRadius:"18px",border:"1px solid rgba(94, 234, 212, 0.2)",background:"linear-gradient(135deg, rgba(6, 15, 28, 0.95), rgba(13, 31, 48, 0.92))",color:"#f8fafc",fontFamily:"'DM Mono', 'IBM Plex Mono', monospace",boxShadow:"0 40px 68px rgba(2, 6, 23, 0.55)",display:"flex",flexDirection:"column",gap:"1.2rem",padding:"2rem 2.2rem"},Ku={display:"flex",gap:"0.75rem"},$s={all:"unset",cursor:"pointer",flex:1,padding:"0.7rem 1.2rem",borderRadius:"999px",letterSpacing:"0.15em",fontSize:"0.72rem",fontWeight:700,textTransform:"uppercase",textAlign:"center",minWidth:0},Xu=({open:e,levelName:t,missionStrings:n,primaryObjectives:r,sideObjectives:s,onContinue:a,onDefer:l})=>{if(!e)return null;const i=r.filter(p=>p.isComplete),d=s.filter(p=>!p.isComplete);return o.jsx("div",{role:"dialog","aria-modal":"true",style:qu,children:o.jsxs("div",{style:Yu,children:[o.jsxs("header",{style:{display:"flex",flexDirection:"column",gap:"0.4rem"},children:[o.jsx("span",{style:{fontSize:"0.7rem",letterSpacing:"0.28em",color:"rgba(94, 234, 212, 0.75)",textTransform:"uppercase"},children:n.accomplishedTitle}),o.jsx("h2",{style:{fontSize:"1.35rem",fontWeight:700,letterSpacing:"0.08em",margin:0},children:n.accomplishedSubtitle(t)})]}),o.jsxs("section",{style:{display:"flex",flexDirection:"column",gap:"0.9rem"},children:[o.jsxs("div",{style:{border:"1px solid rgba(148, 163, 184, 0.22)",borderRadius:"14px",padding:"0.9rem 1.1rem",background:"rgba(15, 23, 42, 0.68)",display:"flex",flexDirection:"column",gap:"0.6rem"},children:[o.jsx("span",{style:{fontSize:"0.7rem",color:"rgba(148, 163, 184, 0.78)"},children:n.primarySummaryLabel}),i.length===0?o.jsx("span",{style:{fontSize:"0.72rem",color:"rgba(226, 232, 240, 0.86)"},children:"—"}):o.jsx("ul",{style:{margin:0,padding:0,listStyle:"none",display:"flex",flexDirection:"column",gap:"0.45rem"},children:i.map(p=>o.jsxs("li",{style:{display:"flex",gap:"0.55rem",alignItems:"flex-start",fontSize:"0.74rem",color:"rgba(226, 232, 240, 0.9)",lineHeight:1.35},children:[o.jsx("span",{"aria-hidden":!0,style:{width:"0.9rem",height:"0.9rem",borderRadius:"999px",display:"inline-flex",alignItems:"center",justifyContent:"center",background:"linear-gradient(135deg, rgba(56, 189, 248, 0.55), rgba(94, 234, 212, 0.55))",color:"#02111f",fontSize:"0.62rem",fontWeight:700,border:"1px solid rgba(94, 234, 212, 0.5)"},children:"✓"}),o.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"0.2rem",flex:1},children:[o.jsx("span",{style:{fontWeight:600},children:p.label}),p.summary&&o.jsx("span",{style:{fontSize:"0.66rem",color:"rgba(203, 213, 225, 0.82)"},children:p.summary})]})]},p.id))})]}),o.jsxs("div",{style:{border:"1px solid rgba(148, 163, 184, 0.22)",borderRadius:"14px",padding:"0.9rem 1.1rem",background:"rgba(15, 23, 42, 0.6)",display:"flex",flexDirection:"column",gap:"0.65rem"},children:[o.jsx("span",{style:{fontSize:"0.7rem",color:"rgba(148, 163, 184, 0.78)"},children:n.sideReminder}),d.length===0?o.jsx("span",{style:{fontSize:"0.72rem",color:"rgba(226, 232, 240, 0.88)"},children:"—"}):o.jsx("ul",{style:{margin:0,paddingLeft:"1.1rem",display:"flex",flexDirection:"column",gap:"0.35rem",fontSize:"0.72rem",color:"rgba(226, 232, 240, 0.88)",listStyle:"disc"},children:d.map(p=>o.jsx("li",{children:p.label},p.id))})]}),o.jsx("span",{style:{fontSize:"0.64rem",color:"rgba(148, 163, 184, 0.65)"},children:n.deferHint})]}),o.jsxs("div",{style:Ku,children:[o.jsx("button",{type:"button",onClick:a,style:{...$s,border:"1px solid rgba(94, 234, 212, 0.5)",background:"linear-gradient(135deg, rgba(56, 189, 248, 0.7), rgba(94, 234, 212, 0.65))",color:"#02111f",boxShadow:"0 20px 36px rgba(13, 148, 136, 0.35)"},children:n.continueCta}),o.jsx("button",{type:"button",onClick:l,style:{...$s,border:"1px solid rgba(148, 163, 184, 0.45)",background:"rgba(15, 23, 42, 0.75)",color:"rgba(226, 232, 240, 0.9)"},children:n.deferCta})]})]})})},Qu=()=>{const e=Le(),t=C(f=>f.settings.locale),n=C(Ne),r=C(f=>f.missions),s=C(sr),a=C($c),l=je(t),i=s&&!a,d=()=>{if(!n)return;const f=r.levels[r.currentLevelIndex+1],u=(f==null?void 0:f.zoneId)??null;ld({level:n.level,levelId:n.levelId,name:n.name,nextLevel:(f==null?void 0:f.level)??n.level+1,nextLevelId:f==null?void 0:f.levelId}),e(ia()),u&&e(aa({zoneId:u}))},p=()=>{e(oa())};return o.jsx(Xu,{open:i,levelName:(n==null?void 0:n.name)??"Current Sector",missionStrings:l.mission,primaryObjectives:(n==null?void 0:n.primary)??[],sideObjectives:(n==null?void 0:n.side)??[],onContinue:d,onDefer:p})},Zu=[],Ju={width:"min(360px, 32vw)",minWidth:"280px",padding:"0.85rem 1rem 1.1rem",borderRadius:"16px",background:"linear-gradient(165deg, rgba(10,17,32,0.93), rgba(15,23,42,0.9))",border:"1px solid rgba(56,189,248,0.28)",boxShadow:"0 18px 36px rgba(15,23,42,0.55)",display:"flex",flexDirection:"column",gap:"0.72rem",pointerEvents:"auto"},ef={display:"flex",alignItems:"center",justifyContent:"space-between",fontSize:"0.62rem",letterSpacing:"0.22em",textTransform:"uppercase",color:"#94a3b8"},tf={display:"inline-flex",gap:"0.42rem",alignItems:"center",fontSize:"0.62rem",letterSpacing:"0.18em"},nf={fontWeight:700,fontSize:"0.78rem",color:"#38bdf8"},rf={opacity:.8,color:"#cbd5f5"},sf=e=>({width:"100%",display:"flex",alignItems:"center",justifyContent:"center",padding:"0.52rem 1rem",borderRadius:"12px",fontWeight:700,letterSpacing:"0.22em",fontSize:"0.76rem",textTransform:"uppercase",color:e?"#0f172a":"#f8fafc",background:e?"linear-gradient(135deg, #38bdf8, #60a5fa)":"linear-gradient(135deg, rgba(248,113,113,0.85), rgba(239,68,68,0.95))",boxShadow:e?"0 0 18px rgba(56,189,248,0.6), 0 14px 24px -10px rgba(56,189,248,0.55)":"0 0 18px rgba(239,68,68,0.6), 0 14px 24px -10px rgba(239,68,68,0.55)"}),of={display:"flex",flexDirection:"column",gap:"0.65rem",padding:"0.9rem 1rem 0.85rem",borderRadius:"14px",background:"linear-gradient(155deg, rgba(15,23,42,0.92), rgba(30,41,59,0.8))",border:"1px solid rgba(56,189,248,0.18)",boxShadow:"0 16px 32px rgba(15,23,42,0.45)"},af={display:"flex",justifyContent:"space-between",alignItems:"center",fontSize:"0.68rem",letterSpacing:"0.16em",color:"#9ca3c6",textTransform:"uppercase"},lf=e=>({fontSize:"0.98rem",fontWeight:600,color:e?"#fda4af":"#f8fafc",textShadow:e?"0 0 12px rgba(248,113,113,0.45)":"none"}),cf={position:"relative",height:"9px",borderRadius:"999px",background:"linear-gradient(90deg, rgba(30,41,59,0.9), rgba(11,16,28,0.85))",overflow:"hidden",boxShadow:"inset 0 0 8px rgba(15,23,42,0.6)"},df=e=>({position:"absolute",top:0,left:0,height:"100%",width:`${Math.max(0,Math.min(1,e))*100}%`,background:"linear-gradient(90deg, rgba(96,165,250,0.95), rgba(56,189,248,0.85))",boxShadow:"0 0 16px rgba(56,189,248,0.38)",transition:"width 160ms ease-out"}),uf=e=>{const t={off:{border:"rgba(148,163,184,0.32)",glow:"rgba(148,163,184,0.22)",background:"linear-gradient(135deg, rgba(15,23,42,0.86), rgba(30,41,59,0.78))",label:"#cbd5f5",state:"#94a3b8",dot:"#64748b"},running:{border:"rgba(34,197,94,0.55)",glow:"rgba(34,197,94,0.45)",background:"linear-gradient(135deg, rgba(22,163,74,0.25), rgba(74,222,128,0.18))",label:"#d1fae5",state:"#86efac",dot:"#34d399"},paused:{border:"rgba(250,204,21,0.55)",glow:"rgba(250,204,21,0.38)",background:"linear-gradient(135deg, rgba(120,53,15,0.28), rgba(217,119,6,0.22))",label:"#fef3c7",state:"#fde68a",dot:"#fbbf24"}}[e];return{width:"100%",display:"flex",alignItems:"center",justifyContent:"space-between",padding:"0.52rem 0.9rem",borderRadius:"12px",border:`1px solid ${t.border}`,background:t.background,color:t.label,fontWeight:500,fontSize:"0.72rem",letterSpacing:"0.16em",textTransform:"uppercase",cursor:"pointer",boxShadow:`0 0 22px ${t.glow}`,transition:"transform 120ms ease, box-shadow 120ms ease, border-color 160ms ease"}},ff={display:"flex",flexDirection:"column",alignItems:"flex-start",gap:"0.14rem"},pf={fontSize:"0.58rem",letterSpacing:"0.3em",opacity:.74},mf=e=>({fontSize:"0.84rem",letterSpacing:"0.14em",color:{off:"#cbd5f5",running:"#bbf7d0",paused:"#fde68a"}[e]}),gf=e=>{const t={off:{background:"#64748b",shadow:"rgba(100,116,139,0.35)"},running:{background:"#34d399",shadow:"rgba(52,211,153,0.55)"},paused:{background:"#fbbf24",shadow:"rgba(251,191,36,0.45)"}};return{width:"0.6rem",height:"0.6rem",borderRadius:"50%",background:t[e].background,boxShadow:`0 0 14px ${t[e].shadow}`}},hf={display:"flex",flexDirection:"column",gap:"0.5rem",padding:"0.82rem 0.95rem",borderRadius:"14px",background:"linear-gradient(160deg, rgba(17,24,39,0.86), rgba(15,23,42,0.9))",border:"1px solid rgba(99,102,241,0.22)",boxShadow:"0 16px 32px rgba(15,23,42,0.42)"},yf={display:"block",fontSize:"0.58rem",letterSpacing:"0.24em",color:"#808bb2",textTransform:"uppercase"},bf={display:"grid",gridTemplateColumns:"minmax(0, 1fr) minmax(0, 1.5fr) auto",alignItems:"center",gap:"0.6rem",fontSize:"0.72rem",color:"#d1dcff"},xf={position:"relative",height:"6px",borderRadius:"999px",background:"rgba(71,85,105,0.45)",overflow:"hidden"},wf=e=>({position:"absolute",inset:0,width:`${Math.max(0,Math.min(1,e))*100}%`,background:"linear-gradient(90deg, rgba(239,68,68,0.85), rgba(248,113,113,0.78))",boxShadow:"0 0 12px rgba(248,113,113,0.32)",transition:"width 160ms ease-out"}),vf={fontSize:"0.66rem",opacity:.84,minWidth:"44px",textAlign:"right"},Sf=()=>{const e=Le(),t=C(L=>L.settings.locale),n=C(L=>L.autoBattle.status),r=C(L=>L.world.inCombat),s=C(L=>L.world.isPlayerTurn),a=C(L=>L.settings.autoBattleEnabled),l=C(L=>L.player.data.actionPoints),i=C(L=>L.player.data.maxActionPoints),d=C(L=>{var X;return((X=L.world.currentMapArea)==null?void 0:X.entities.enemies)??Zu}),p=je(t),f=c.useMemo(()=>d.filter(L=>L.health>0),[d]),u=f.length,h=c.useMemo(()=>f.slice().sort((L,X)=>X.actionPoints-L.actionPoints).slice(0,4),[f]),[S,x]=c.useState(l),y=c.useRef(S),M=c.useRef(null);if(c.useEffect(()=>{y.current=S},[S]),c.useEffect(()=>{const L=l;if(M.current&&(window.clearTimeout(M.current),M.current=null),!r){x(L);return}if(!(a&&n==="running")||L>=y.current){x(L);return}const re=()=>{const pe=y.current;if(pe<=L){M.current=null;return}x(pe-1),M.current=window.setTimeout(re,70)};return M.current=window.setTimeout(re,60),()=>{M.current&&(window.clearTimeout(M.current),M.current=null)}},[l,r,a,n]),c.useEffect(()=>()=>{M.current&&window.clearTimeout(M.current)},[]),!r)return null;const P=Math.max(0,i),b=P>0?Math.max(0,Math.min(1,S/P)):0,N=()=>{e(zn(!a))},H=a?n==="paused"?"paused":n==="running"?"running":"off":"off";return o.jsxs("div",{style:Ju,"data-testid":"combat-control-widget",children:[o.jsxs("div",{style:ef,children:[o.jsx("span",{children:p.turnTracker.heading.toUpperCase()}),o.jsxs("span",{style:tf,children:[o.jsx("span",{style:nf,children:u}),o.jsx("span",{style:rf,children:p.turnTracker.hostileReadout.toUpperCase()})]})]}),o.jsx("div",{style:sf(s),children:s?p.turnTracker.playerTurn:p.turnTracker.enemyTurn}),o.jsxs("div",{style:of,children:[o.jsxs("div",{style:af,children:[o.jsx("span",{children:p.playerStatus.actionPointsLabel}),o.jsxs("span",{style:lf(S===0),children:[S,"/",i]})]}),o.jsx("div",{style:cf,children:o.jsx("div",{style:df(b)})})]}),o.jsxs("button",{type:"button",onClick:N,style:uf(H),"aria-pressed":a,"aria-label":p.autoBattle.toggleLabel,children:[o.jsxs("span",{style:ff,children:[o.jsx("span",{style:pf,children:p.autoBattle.heading.toUpperCase()}),o.jsx("span",{style:mf(H),children:H==="off"?p.autoBattle.hudToggleOffLabel:p.autoBattle.hudToggleOnLabel})]}),o.jsx("span",{style:gf(H)})]}),o.jsxs("div",{style:hf,children:[o.jsx("span",{style:yf,children:p.turnTracker.hostileReadout.toUpperCase()}),o.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"0.55rem"},children:h.length>0?h.map(L=>{const X=L.maxActionPoints>0?Math.max(0,Math.min(1,L.actionPoints/L.maxActionPoints)):0;return o.jsxs("div",{style:bf,children:[o.jsx("span",{style:{fontWeight:600,overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"},title:L.name,children:L.name}),o.jsx("div",{style:xf,children:o.jsx("div",{style:wf(X)})}),o.jsxs("span",{style:vf,children:[L.actionPoints,"/",L.maxActionPoints]})]},L.id)}):o.jsx("span",{style:{fontSize:"0.68rem",color:"#9ca3c6",textAlign:"center",letterSpacing:"0.1em"},children:p.turnTracker.playerTurn.toUpperCase()})})]})]})},If=c.lazy(()=>yt(()=>import("./GameMenu-CRkn8vdw.js"),__vite__mapDeps([0,1,2,3,4,5]))),kf=c.lazy(()=>yt(()=>import("./CharacterCreationScreen-Ckd8C67r.js"),__vite__mapDeps([6,1,2,4,3,5,7]))),Ef=c.lazy(()=>yt(()=>import("./CharacterScreen-CZ1DLOOx.js"),__vite__mapDeps([8,1,2,3,4,7]))),Tf=c.lazy(()=>yt(()=>import("./LevelUpModal-BrZdRYeo.js"),__vite__mapDeps([9,1,2,5,4,3])).then(e=>({default:e.LevelUpModal}))),Cf=c.lazy(()=>yt(()=>import("./PerkSelectionPanel-BTuSXLKQ.js"),__vite__mapDeps([10,1,2,3,4]))),Mf=c.lazy(()=>yt(()=>import("./LevelUpPointAllocationPanel-4xWsjv2w.js"),__vite__mapDeps([11,1,2,4,3,5]))),Gs=Qs("App"),Pf={margin:0,padding:0,width:"100vw",height:"100vh",overflow:"hidden",position:"relative",backgroundColor:"var(--color-gunmetal-900)",color:"var(--color-hud-text)",fontFamily:"var(--font-mono)"},Rf={position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",background:"var(--hud-stage-background)"},Ln=260,Af=320,Df={flex:"1 1 auto",minWidth:0,height:"100%",position:"relative",overflow:"hidden"},_f={position:"absolute",top:"1.25rem",left:"1.25rem",display:"flex",flexDirection:"column",alignItems:"flex-start",gap:"0.75rem",zIndex:5,pointerEvents:"auto"},Lf={position:"absolute",top:"1.25rem",left:"50%",transform:"translateX(-50%)",display:"flex",flexDirection:"column",alignItems:"center",gap:"0.75rem",zIndex:6,pointerEvents:"auto"},jf={position:"absolute",top:"1.25rem",right:"1.25rem",display:"flex",flexDirection:"column",alignItems:"flex-end",gap:"0.75rem",zIndex:6,pointerEvents:"none"},Nf={all:"unset",display:"flex",alignItems:"center",justifyContent:"space-between",gap:"0.5rem",padding:"0.7rem 0.9rem",boxSizing:"border-box",borderRadius:"14px",border:"var(--hud-command-button-border)",background:"var(--hud-command-button-bg)",boxShadow:"var(--hud-command-button-shadow)",color:"var(--hud-command-button-text)",fontFamily:"var(--font-mono)",fontSize:"0.7rem",letterSpacing:"0.14em",textTransform:"uppercase",cursor:"pointer",pointerEvents:"auto",transition:"transform 0.16s ease, box-shadow 0.16s ease, border-color 0.16s ease, color 0.16s ease"},Of={fontSize:"0.78rem",letterSpacing:"0.2em",color:"inherit"},zf={fontSize:"0.62rem",letterSpacing:"0.24em",color:"var(--hud-command-button-text-muted)",textTransform:"uppercase"},Ff=({onOpenMenu:e,onToggleCharacter:t,showMenu:n,characterOpen:r,levelPanelCollapsed:s,onToggleLevelPanel:a,hudLayoutPreset:l})=>{const i=C(F=>F.settings.locale),d=C(F=>F.settings.testMode),p=C(F=>F.world.inCombat),f=je(i),u=C(F=>{var g;return((g=F.world.currentMapArea)==null?void 0:g.zoneId)??null}),h=l==="combat",[S,x]=c.useState(!1),[y,M]=c.useState(null),P=c.useRef(null),[b,N]=c.useState(null),[_,H]=c.useState(Ln);c.useEffect(()=>{n&&x(!1)},[n]),c.useEffect(()=>{p&&x(!1)},[p]),c.useEffect(()=>{if(typeof window>"u"||typeof ResizeObserver>"u")return;const F=P.current;if(!F)return;const g=new ResizeObserver(v=>{const E=v[0];if(!E)return;const k=Math.round(E.contentRect.height);N(w=>w===k?w:k)});return g.observe(F),()=>g.disconnect()},[]),c.useEffect(()=>{const F=P.current;if(!F)return;const g=Math.round(F.getBoundingClientRect().height);N(v=>v===g?v:g)},[]),c.useEffect(()=>{if(!b){H(Ln);return}if(typeof window>"u"){H(b);return}const g=(parseFloat(window.getComputedStyle(document.documentElement).fontSize||"16")||16)*1.3,v=Math.round(b+g),E=Math.min(Math.max(v,Ln),Af);H(k=>k===E?k:E)},[b]);const L=()=>{x(F=>!F)},X=S?f.shell.completedToggleClose:f.shell.completedToggleOpen;return c.useEffect(()=>{if(!(typeof document>"u"))return _?document.documentElement.style.setProperty("--bottom-panel-height",`${_}px`):document.documentElement.style.removeProperty("--bottom-panel-height"),()=>{typeof document<"u"&&document.documentElement.style.removeProperty("--bottom-panel-height")}},[_]),o.jsxs("div",{style:Rf,className:"command-shell-stage","data-hud-layout":l,children:[o.jsxs("div",{style:Df,children:[o.jsx(Eu,{}),o.jsx(ya,{onRendererInfo:M}),o.jsx(uc,{}),o.jsxs("div",{style:_f,children:[o.jsxs("button",{type:"button",onClick:e,style:{...Nf,width:"90vw",maxWidth:"240px"},"data-testid":"menu-overlay-button","aria-label":f.shell.menuButton,title:f.shell.menuButton,onMouseEnter:F=>{F.currentTarget.style.transform="translateY(-2px)",F.currentTarget.style.boxShadow="var(--hud-command-button-shadow-hover)",F.currentTarget.style.borderColor="var(--hud-command-button-border-hover)",F.currentTarget.style.color="var(--hud-command-button-text-hover)"},onMouseLeave:F=>{F.currentTarget.style.transform="translateY(0)",F.currentTarget.style.boxShadow="var(--hud-command-button-shadow)",F.currentTarget.style.borderColor="var(--hud-command-button-border-rest)",F.currentTarget.style.color="var(--hud-command-button-text)"},onFocus:F=>{F.currentTarget.style.boxShadow="var(--hud-command-button-shadow-focus)",F.currentTarget.style.borderColor="var(--hud-command-button-border-focus)"},onBlur:F=>{F.currentTarget.style.boxShadow="var(--hud-command-button-shadow)",F.currentTarget.style.borderColor="var(--hud-command-button-border-rest)"},children:[o.jsx("span",{style:Of,children:f.shell.menuButton}),o.jsx("span",{style:zf,children:"ESC"})]}),o.jsx(Gc,{collapsed:s,onToggle:a}),d?o.jsx(So,{zoneId:u,rendererInfo:y}):null]}),o.jsx("div",{style:Lf,children:o.jsx(Sf,{})}),o.jsx("div",{style:jf,children:o.jsx("div",{style:{pointerEvents:"auto"},children:o.jsx(xc,{})})}),o.jsx(yu,{}),o.jsx(Mu,{})]}),o.jsxs("div",{className:"hud-bottom-dock","data-hud-layout":l,children:[o.jsx("div",{className:"hud-bottom-lane hud-bottom-lane--map",children:o.jsx("div",{className:"hud-bottom-lane-card",children:o.jsx("div",{className:"hud-bottom-card-surface",children:o.jsx(Nc,{className:"hud-bottom-map-card",variant:"frameless",children:o.jsx(Lc,{})})})})}),o.jsx("div",{className:"hud-bottom-lane hud-bottom-lane--status",ref:P,"data-hud-emphasis":h?"true":void 0,children:o.jsx("div",{className:"hud-bottom-lane-card",children:o.jsx("div",{className:"hud-bottom-card-surface",children:o.jsx(yc,{onOpenCharacter:t,characterOpen:r,variant:"frameless"})})})}),o.jsx("div",{className:"hud-bottom-lane hud-bottom-lane--george",children:o.jsx("div",{className:"hud-bottom-lane-card",children:o.jsx("div",{className:"hud-bottom-card-surface",children:o.jsx(yd,{})})})}),o.jsxs("div",{className:"hud-bottom-lane hud-bottom-lane--ops",children:[o.jsx("div",{className:"hud-bottom-lane-card",children:o.jsxs("div",{className:"hud-bottom-card-surface",children:[o.jsx("div",{className:"hud-bottom-quests",children:o.jsx(Fs,{})}),o.jsx("div",{className:"hud-bottom-control-row",children:o.jsx("button",{type:"button",className:"hud-bottom-toggle",onClick:L,"aria-expanded":S,"aria-controls":"command-objective-overlay",children:X})})]})}),o.jsx("div",{id:"command-objective-overlay",className:"hud-bottom-overlay","data-expanded":S,children:o.jsx("div",{className:"hud-bottom-overlay__scroll",children:o.jsx(Fs,{showCompleted:!0})})})]})]})]})},Us=()=>{if(typeof window>"u")return!1;try{return!!window.localStorage.getItem(eo)}catch(e){return console.warn("[App] Failed to read persisted game state",e),!1}},Jt=e=>pa().filter(t=>!e.perks.includes(t.id)),jn=e=>Jt(e).map(t=>ma(e,t)).filter(t=>t.canSelect);function Bf(){const[e,t]=c.useState(!1),[n,r]=c.useState(!0),[s,a]=c.useState(!1),[l,i]=c.useState(()=>Us()),[d,p]=c.useState(null),[f,u]=c.useState([]),[h,S]=c.useState(!1),[x,y]=c.useState(0),[M,P]=c.useState(!1),[b,N]=c.useState(!1),[_,H]=c.useState(!1),[L,X]=c.useState(!0),re=C(ju),pe=C(V=>!!V.settings.reputationSystemsEnabled);c.useEffect(()=>{Gs.debug("Component mounted"),Gs.debug("Store state:",xe.getState())},[]),c.useEffect(()=>xe.subscribe(()=>{const J=xe.getState(),ae=J.player.pendingLevelUpEvents;p(D=>D||(ae.length>0?ae[0]:null));const me=J.player.data.pendingPerkSelections;y(me);const se=J.player.xpNotifications??[];u(se)}),[]),c.useEffect(()=>{if(n){if(e){i(!0);return}i(Us())}},[n,e]),c.useEffect(()=>{if(typeof window>"u")return;const V=new URLSearchParams(window.location.search);if(V.get("poc")!=="esb"||e||s)return;try{window.localStorage.removeItem(eo)}catch{}i(!1),r(!1);const J={name:V.get("pocName")??"Deus",attributes:Or,backgroundId:"corpsec_defector",visualPreset:"default"};g(J)},[e,s]),c.useEffect(()=>{e&&window.requestAnimationFrame(()=>{window.dispatchEvent(new Event("resize"))})},[e]),c.useEffect(()=>{(n||s)&&S(!1)},[n,s]),c.useEffect(()=>{const V=J=>{J.key.toLowerCase()==="c"&&e&&!n&&!s&&S(ae=>!ae),J.key.toLowerCase()==="l"&&e&&!n&&!s&&X(ae=>!ae)};return window.addEventListener("keydown",V),()=>window.removeEventListener("keydown",V)},[e,n,s]);const F=()=>{r(!1),a(!0)},g=V=>{xe.dispatch(la());const J=V.attributes??Or,ae=V.backgroundId??"corpsec_defector";xe.dispatch(ca({name:V.name,skills:J,backgroundId:ae,visualPreset:V.visualPreset}));const me=xe.getState(),{logs:se}=Xe(me.settings.locale);xe.dispatch(O(`${se.operationStart} - Call sign: ${V.name}`));const D=me.quests.quests.find(ce=>ce.id==="quest_market_cache");D&&!D.isActive&&!D.isCompleted&&(xe.dispatch(Js(D.id)),xe.dispatch(O(se.questAccepted(D.name)))),a(!1),t(!0),i(!0)},v=()=>{a(!1),r(!0)},E=()=>{xe.dispatch(da()),t(!0),r(!1),i(!0)};c.useEffect(()=>{if(!e)return;const V=J=>{if(J.key!=="Escape")return;if(J.preventDefault(),h){S(!1),b&&N(!1);return}if(!!xe.getState().quests.activeDialogue.dialogueId){xe.dispatch(tn());return}if(n){E();return}s||r(!0)};return window.addEventListener("keydown",V),()=>window.removeEventListener("keydown",V)},[e,n,s,h,b]);const k=()=>{if(!e){r(!0);return}if(n){E();return}if(!!xe.getState().quests.activeDialogue.dialogueId){xe.dispatch(tn());return}r(!0)},w=()=>{!e||n||s||S(V=>!V)},q=()=>{if(!d)return;const J=xe.getState().player.data,ae=J.pendingPerkSelections,me=Jt(J),se=jn(J),D=ae>0,ce=se.length>0,ke=J.skillPoints>0||J.attributePoints>0;N(D||ke),xe.dispatch(ua()),p(null),D&&me.length>0?(ce||console.info("[LevelUp] Perk selections available but current requirements are unmet. Player may need to allocate points first."),P(!0)):(D&&me.length===0&&xe.dispatch(Sn()),ke?H(!0):N(!1))},$=()=>{if(P(!1),!b)return;const V=xe.getState().player.data,J=V.pendingPerkSelections,ae=V.skillPoints>0||V.attributePoints>0,me=Jt(V),se=jn(V);if(J>0&&se.length===0&&me.length===0&&xe.dispatch(Sn()),ae){H(!0);return}N(!1)},le=()=>{S(!1),b&&N(!1)},fe=()=>{H(!1);const V=xe.getState().player.data,J=V.pendingPerkSelections,ae=Jt(V),me=jn(V);if(J>0&&me.length>0){P(!0);return}J>0&&me.length===0&&ae.length===0&&xe.dispatch(Sn()),N(!1)},he=V=>{xe.dispatch(fa(V))};return o.jsxs(o.Fragment,{children:[o.jsx(Nu,{}),pe&&o.jsx(Vu,{}),o.jsxs("div",{style:Pf,children:[e&&o.jsx(Ff,{onOpenMenu:k,onToggleCharacter:w,showMenu:n,characterOpen:h,levelPanelCollapsed:L,onToggleLevelPanel:()=>X(V=>!V),hudLayoutPreset:re}),o.jsx(_u,{})]}),o.jsxs(c.Suspense,{fallback:null,children:[n&&o.jsx(If,{onStartNewGame:F,onContinue:E,hasActiveGame:e||l}),s&&o.jsx(kf,{onComplete:g,onCancel:v}),d&&o.jsx(Tf,{newLevel:d.newLevel,skillPointsEarned:d.skillPointsEarned,attributePointsEarned:d.attributePointsEarned,perksUnlocked:d.perksUnlocked,onContinue:q}),o.jsx(Cf,{open:M,pendingSelections:x,onClose:$}),_&&o.jsx(Mf,{onComplete:fe}),o.jsx(Ef,{open:h,onClose:le}),o.jsx(Qu,{})]}),o.jsx(ku,{notifications:f,onDismiss:he})]})}function Wf(){return o.jsx(Vo,{store:xe,children:o.jsx(Bf,{})})}qo.createRoot(document.getElementById("root")).render(o.jsx(c.StrictMode,{children:o.jsx(Wf,{})}));export{yc as P,Yf as a,Kf as b,qf as c,Xf as d,Qf as e,ep as f,Jf as g,on as n,Zf as s};
