var Ga=Object.defineProperty;var za=(e,t,i)=>t in e?Ga(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var y=(e,t,i)=>za(e,typeof t!="symbol"?t+"":t,i);import{P}from"./phaser-DkaA9Y8j.js";import{v as se,g as pt,a as Ua,e as Ka,i as jt,c as ja,b as $a,d as Ya,f as $t,D as Ie,L as Za,Q as Xa,h as Qa,P as Ja,j as Tn,k as Rn,l as er,m as tr,n as As,o as Is}from"./game-content-DAoogAxc.js";import{c as Q,a as ir,b as sr,d as nr}from"./vendor-Cc93p67d.js";const Ke=Object.freeze({qualityPreset:"balanced",lightsEnabled:!1,bloom:{enabled:!1,color:16777215,offsetX:0,offsetY:0,blurStrength:0,strength:0,steps:0},vignette:{enabled:!1,x:.5,y:.5,radius:1,strength:0},colorMatrix:{enabled:!1,saturation:0,brightness:1,contrast:0,hue:0}});let ae={qualityPreset:Ke.qualityPreset,lightsEnabled:Ke.lightsEnabled,bloom:{...Ke.bloom},vignette:{...Ke.vignette},colorMatrix:{...Ke.colorMatrix}};const vi=new Set,ar=()=>{vi.forEach(e=>e(ae))},Jt=e=>{ae={qualityPreset:e.qualityPreset??ae.qualityPreset,lightsEnabled:e.lightsEnabled??ae.lightsEnabled,bloom:{...ae.bloom,...e.bloom??{}},vignette:{...ae.vignette,...e.vignette??{}},colorMatrix:{...ae.colorMatrix,...e.colorMatrix??{}}},ar()},rr=e=>e==="performance"?{bloomStrengthCap:.18,vignetteCap:.22,colorMatrixEnabled:!1,maxFogBands:2,maxEmissiveZones:6,wetReflectionAlpha:.08,occlusionFadeFloor:.56}:e==="cinematic"?{bloomStrengthCap:.48,vignetteCap:.44,colorMatrixEnabled:!0,maxFogBands:6,maxEmissiveZones:14,wetReflectionAlpha:.2,occlusionFadeFloor:.38}:{bloomStrengthCap:.32,vignetteCap:.34,colorMatrixEnabled:!0,maxFogBands:4,maxEmissiveZones:10,wetReflectionAlpha:.14,occlusionFadeFloor:.48},xs=e=>rr(e),En=e=>(vi.add(e),e(ae),()=>{vi.delete(e)}),or=(e,t)=>{t.enabled&&e.postFX.addBloom(t.color,t.offsetX,t.offsetY,t.blurStrength,t.strength,t.steps)},lr=(e,t)=>{t.enabled&&e.postFX.addVignette(t.x,t.y,t.radius,t.strength)},cr=(e,t)=>{if(!t.enabled)return;const i=e.postFX.addColorMatrix();let s=!1;const n=a=>{a(s),s=!0};t.saturation!==0&&n(a=>i.saturate(t.saturation,a)),t.hue!==0&&n(a=>i.hue(t.hue,a)),t.contrast!==0&&n(a=>i.contrast(t.contrast,a)),t.brightness!==1&&n(a=>i.brightness(t.brightness,a))},dr=e=>{e.clearFX(),or(e,ae.bloom),lr(e,ae.vignette),cr(e,ae.colorMatrix)},ur=e=>{const i=En(()=>dr(e));return()=>{i(),e.clearFX()}};var L=(e=>(e.IDLE="idle",e.SUSPICIOUS="suspicious",e.INVESTIGATING="investigating",e.ALARMED="alarmed",e))(L||{}),ne=(e=>(e.IDLE="idle",e.SUSPICIOUS="suspicious",e.ALARMED="alarmed",e.DISABLED="disabled",e))(ne||{}),R=(e=>(e.FLOOR="floor",e.WALL="wall",e.DOOR="door",e.COVER="cover",e.WATER="water",e.TRAP="trap",e))(R||{});const J=5,ee=10,_n=[{id:"combat",label:"Combat",blurb:"Disciplines that determine battlefield performance and weapon mastery.",skills:[{id:"smallGuns",name:"Small Guns",branch:"combat",maxValue:100,increment:J,taggedIncrement:ee,description:"Training with ballistic pistols, SMGs, and rifles.",effectSummary:"+0.5% hit chance per point with ballistic weapons."},{id:"energyWeapons",name:"Energy Weapons",branch:"combat",maxValue:100,increment:J,taggedIncrement:ee,description:"Mastery of beam, laser, and plasma weapon systems.",effectSummary:"+0.4% hit chance and +0.3% crit chance per point with energy weapons."},{id:"meleeCombat",name:"Melee Combat",branch:"combat",maxValue:100,increment:J,taggedIncrement:ee,description:"Close-quarters tactics for blades, clubs, and unarmed strikes.",effectSummary:"+0.3% melee hit chance per point and +1 damage per 10 points."},{id:"explosives",name:"Explosives",branch:"combat",maxValue:100,increment:J,taggedIncrement:ee,description:"Deployment of grenades, mines, and shaped charges.",effectSummary:"+0.25% throw accuracy per point and +1 tile radius per 25 points."}]},{id:"tech",label:"Tech",blurb:"System infiltration, fabrication, and field engineering aptitudes.",skills:[{id:"hacking",name:"Hacking",branch:"tech",maxValue:100,increment:J,taggedIncrement:ee,description:"Bypass security systems and crack encrypted terminals.",effectSummary:"Unlocks advanced intrusion dialogue choices and minigames (stub).",stub:!0},{id:"engineering",name:"Engineering",branch:"tech",maxValue:100,increment:J,taggedIncrement:ee,description:"Maintain drones, turrets, and battlefield gadgets.",effectSummary:"Improves deployable durability and crafting options (stub).",stub:!0},{id:"science",name:"Science",branch:"tech",maxValue:100,increment:J,taggedIncrement:ee,description:"Chemical analysis and experimental tech research.",effectSummary:"Boosts chem crafting and anomaly research (stub).",stub:!0}]},{id:"survival",label:"Survival",blurb:"Field medicine, stealth, and salvage expertise.",skills:[{id:"medicine",name:"Medicine",branch:"survival",maxValue:100,increment:J,taggedIncrement:ee,description:"Treat injuries and synthesize bio-stims under fire.",effectSummary:"Increases healing efficiency and unlocks aid recipes (stub).",stub:!0},{id:"stealth",name:"Stealth",branch:"survival",maxValue:100,increment:J,taggedIncrement:ee,description:"Avoid detection and blend into hostile zones.",effectSummary:"Improves detection thresholds and noise damping (stub).",stub:!0},{id:"scavenging",name:"Scavenging",branch:"survival",maxValue:100,increment:J,taggedIncrement:ee,description:"Recover components and rare materials from ruins.",effectSummary:"Increases loot yields and salvage spots (stub).",stub:!0}]},{id:"social",label:"Social",blurb:"Command presence, negotiation, and underground influence.",skills:[{id:"persuasion",name:"Persuasion",branch:"social",maxValue:100,increment:J,taggedIncrement:ee,description:"Convince allies and sway neutral factions.",effectSummary:"Unlocks diplomatic dialogue options and better rewards (stub).",stub:!0},{id:"intimidation",name:"Intimidation",branch:"social",maxValue:100,increment:J,taggedIncrement:ee,description:"Force compliance through presence and threat.",effectSummary:"Unlocks threat-based dialogue paths (stub).",stub:!0},{id:"barter",name:"Barter",branch:"social",maxValue:100,increment:J,taggedIncrement:ee,description:"Broker deals and hustle black-market channels.",effectSummary:"Improves vendor prices and trade availability (stub).",stub:!0}]}],hr=_n.flatMap(e=>e.skills).reduce((e,t)=>(e[t.id]=t,e),{});_n.reduce((e,t)=>(e[t.id]=t,e),{});const bi=e=>{const t=hr[e];if(!t)throw new Error(`[skills] Unknown skill id: ${e}`);return t},zi=(e,t)=>e.skillTraining[t]??0,pr=(e,t)=>e.taggedSkillIds.includes(t),mt=(e,t=100)=>!Number.isFinite(e)||e<0?0:Math.min(t,e),ip=(e,t)=>{const i=bi(t);return pr(e,t)?i.taggedIncrement:i.increment},Dn=e=>e?e.skillType??(e.range<=1?"meleeCombat":"smallGuns"):"meleeCombat",Ln=e=>mt(e)*.5,Ui=e=>{const t=mt(e);return{hit:t*.4,crit:t*.3}},Ki=e=>{const t=mt(e);return{hit:t*.35,damage:Math.floor(t/10)}},Fn=e=>{const t=mt(e);return{accuracy:t*.25,radius:Math.floor(t/25)}},sp=(e,t)=>{const i=mt(t);switch(e){case"smallGuns":return`Hit chance bonus +${Ln(i).toFixed(1)}% with ballistic weapons`;case"energyWeapons":{const s=Ui(i);return`Hit +${s.hit.toFixed(1)}% / Crit +${s.crit.toFixed(1)}% with energy weapons`}case"meleeCombat":{const s=Ki(i);return`Hit +${s.hit.toFixed(1)}% / Damage +${s.damage}`}case"explosives":{const s=Fn(i),n=s.radius===1?"tile":"tiles";return`Throw accuracy +${s.accuracy.toFixed(1)}%, blast radius +${s.radius} ${n}`}default:return"Specialisation effects coming online soon."}},Cs=10,Yt=64,mr=(e,t)=>{const i=[];for(let s=0;s<t;s++){i[s]=[];for(let n=0;n<e;n++)i[s][n]={type:R.FLOOR,position:{x:n,y:s},isWalkable:!0,provideCover:!1}}return i},Bn=(e,t=Cs,i=Cs,s={})=>{const n=mr(t,i);for(let a=0;a<t;a++)n[0][a].type=R.WALL,n[0][a].isWalkable=!1,n[i-1][a].type=R.WALL,n[i-1][a].isWalkable=!1;for(let a=0;a<i;a++)n[a][0].type=R.WALL,n[a][0].isWalkable=!1,n[a][t-1].type=R.WALL,n[a][t-1].isWalkable=!1;return{id:se(),name:e,zoneId:s.zoneId??"unknown_zone",level:s.level??0,objectives:s.objectives??[],isInterior:s.isInterior??!1,factionRequirement:s.factionRequirement,displayName:s.displayName,summary:s.summary,dangerRating:s.dangerRating,hazards:s.hazards??[],width:t,height:i,tiles:n,entities:{enemies:[],npcs:[],items:[]}}},gr=(e,t)=>{const i=[...e.tiles];for(const s of t)s.y>=0&&s.y<e.height&&s.x>=0&&s.x<e.width&&(i[s.y][s.x]={...i[s.y][s.x],type:R.WALL,isWalkable:!1});return{...e,tiles:i}},fr=(e,t)=>{const i=[...e.tiles];for(const s of t)s.y>=0&&s.y<e.height&&s.x>=0&&s.x<e.width&&(i[s.y][s.x]={...i[s.y][s.x],type:R.COVER,provideCover:!0,isWalkable:!0});return{...e,tiles:i}},yr=(e,t,i)=>{if(!ze(t,e))return e;const s=e.tiles.map((n,a)=>n.map((r,o)=>a===t.y&&o===t.x?{...r,cover:{...i},provideCover:!0}:r));return{...e,tiles:s}},ze=(e,t)=>e.x>=0&&e.x<t.width&&e.y>=0&&e.y<t.height,Ae=(e,t,i,s=[],n={})=>{if(!ze(e,t))return!1;const a=t.tiles[e.y][e.x];if(!a.isWalkable||i&&a.skillRequirement&&zi(i,a.skillRequirement.skill)<a.skillRequirement.threshold)return!1;const{npcs:r=[],ignoreNpcIds:o=[]}=n;return!(i&&i.position.x===e.x&&i.position.y===e.y||s.some(l=>l.position.x===e.x&&l.position.y===e.y)||r.some(l=>!o.includes(l.id)&&l.position.x===e.x&&l.position.y===e.y))},On=(e,t,i,s=[])=>[{x:e.x+1,y:e.y},{x:e.x-1,y:e.y},{x:e.x,y:e.y+1},{x:e.x,y:e.y-1}].filter(a=>Ae(a,t,i,s)),ji=(e,t,i,s=[])=>{if(Ae(e,t,i,s))return e;const n=new Set,a=[e],r=l=>`${l.x},${l.y}`;n.add(r(e));const o=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}];for(;a.length>0;){const l=a.shift();if(!l)break;for(const c of o){const d={x:l.x+c.x,y:l.y+c.y},u=r(d);if(!n.has(u)&&(n.add(u),!!ze(d,t))){if(Ae(d,t,i,s))return d;a.push(d)}}}return null},me=(e,t)=>e.perks.includes(t),Sr=e=>e?e.range>1:!1,vr=e=>me(e,"steadyHands")?.1:0,br=e=>me(e,"toughness")?3:0,$i=e=>me(e,"gunFu")?e.perkRuntime.gunFuShotsThisTurn<=0:!1,wr=e=>me(e,"gunFu")?{...e,perkRuntime:{...e.perkRuntime,gunFuShotsThisTurn:e.perkRuntime.gunFuShotsThisTurn+1}}:e,Pr=e=>me(e,"gunFu")?{...e,perkRuntime:{...e.perkRuntime,gunFuShotsThisTurn:0}}:e,ei=e=>me(e,"adrenalineRush")?(e.maxHealth>0?e.health/e.maxHealth:0)<=.3&&e.perkRuntime.adrenalineRushTurnsRemaining<=0:!1,ti=e=>me(e,"adrenalineRush")?{...e,actionPoints:Math.min(e.actionPoints+2,e.maxActionPoints+2),perkRuntime:{...e.perkRuntime,adrenalineRushTurnsRemaining:3}}:e,Mr=e=>{if(!me(e,"adrenalineRush"))return e;const t=Math.max(0,e.perkRuntime.adrenalineRushTurnsRemaining-1);return{...e,actionPoints:Math.min(e.actionPoints+2,e.maxActionPoints+2),perkRuntime:{...e.perkRuntime,adrenalineRushTurnsRemaining:t}}},Ar=e=>!me(e,"ghost")||e.perkRuntime.ghostInvisibilityTurns<=0?e:{...e,perkRuntime:{...e.perkRuntime,ghostInvisibilityTurns:Math.max(0,e.perkRuntime.ghostInvisibilityTurns-1)}},Yi=e=>{const t={strengthBonus:0,perceptionBonus:0,enduranceBonus:0,charismaBonus:0,intelligenceBonus:0,agilityBonus:0,luckBonus:0,totalArmorRating:0,totalAPPenalty:0,totalDamageBonus:0},{weapon:i,armor:s}=e.equipped;return i&&i.statModifiers&&ks(t,i.statModifiers),s&&(t.totalArmorRating+=s.protection||0,s.statModifiers&&ks(t,s.statModifiers)),t};function ks(e,t){e.strengthBonus=(e.strengthBonus||0)+(t.strengthBonus||0),e.perceptionBonus=(e.perceptionBonus||0)+(t.perceptionBonus||0),e.enduranceBonus=(e.enduranceBonus||0)+(t.enduranceBonus||0),e.charismaBonus=(e.charismaBonus||0)+(t.charismaBonus||0),e.intelligenceBonus=(e.intelligenceBonus||0)+(t.intelligenceBonus||0),e.agilityBonus=(e.agilityBonus||0)+(t.agilityBonus||0),e.luckBonus=(e.luckBonus||0)+(t.luckBonus||0),e.totalArmorRating=(e.totalArmorRating||0)+(t.armorRating||0),e.totalAPPenalty=(e.totalAPPenalty||0)+(t.apPenalty||0),e.totalDamageBonus=(e.totalDamageBonus||0)+(t.damageBonus||0)}const Ir=(e,t)=>({strength:e.strength+(t.strengthBonus||0),perception:e.perception+(t.perceptionBonus||0),endurance:e.endurance+(t.enduranceBonus||0),charisma:e.charisma+(t.charismaBonus||0),intelligence:e.intelligence+(t.intelligenceBonus||0),agility:e.agility+(t.agilityBonus||0),luck:e.luck+(t.luckBonus||0)}),xr=e=>Yi(e).totalArmorRating+br(e),Cr=(e,t)=>{const i=t.totalAPPenalty||0,s=e-i;return Math.max(1,Math.floor(s))},kr=(e,t,i=0)=>e+(t.totalDamageBonus||0)+i,Tr=(e,t)=>{const i=e-t;return Math.max(1,i)},Zi=e=>{const{strength:t,perception:i,endurance:s,charisma:n,intelligence:a,agility:r,luck:o}=e;return{maxHP:50+s*10,baseAP:6+Math.floor((r-5)*.5),maxStamina:50+s*5,carryWeight:25+t*5,criticalChance:5+i*2+o*2,dialogueThresholdBonus:Math.floor(n/2),skillPointsPerLevel:3+Math.floor(a/3),hitChanceModifier:(i-5)*3,dodgeChance:(r-5)*2,meleeDamageBonus:Math.floor(t/2)}},Je=e=>50+e*10,et=e=>6+Math.floor((e-5)*.5),pe=e=>50+e*5,tt=e=>25+e*5,np=(e,t,i=0)=>!Number.isFinite(e)||!Number.isFinite(t)||!Number.isFinite(i)?(console.warn("[StatCalculations] Invalid skill check parameters:",{attributeValue:e,threshold:t,bonus:i}),!1):e+i>=t,Rr=e=>{const t=Yi(e),i=Ir(e.skills,t),s=Zi(i),n=Cr(s.baseAP,t);return{...s,baseAP:n}},Er=(e,t,i)=>Number.isNaN(e)||!Number.isFinite(e)?0:Math.max(t,Math.min(i,Math.round(e))),te=e=>Er(e,-100,100),re=[{id:"hostile",label:"Hostile",min:-100,max:-61,color:"#ef4444",icon:"⚠️"},{id:"unfriendly",label:"Unfriendly",min:-60,max:-20,color:"#f97316",icon:"⚠"},{id:"neutral",label:"Neutral",min:-19,max:19,color:"#94a3b8",icon:"•"},{id:"friendly",label:"Friendly",min:20,max:59,color:"#4ade80",icon:"★"},{id:"allied",label:"Allied",min:60,max:100,color:"#facc15",icon:"✪"}],Nn=re.reduce((e,t)=>(e[t.id]=t,e),{hostile:re[0],unfriendly:re[1],neutral:re[2],friendly:re[3],allied:re[4]}),fe=e=>{const t=te(e);for(const i of re)if(t>=i.min&&t<=i.max)return i;return Nn.neutral},ap=e=>fe(e),_r=e=>{const t=fe(e),i=re.findIndex(n=>n.id===t.id);if(i<0||i===re.length-1)return null;const s=re[i+1];return{standing:s,requiredValue:s.min}},De={resistance:{definition:{id:"resistance",name:"Resistance",description:"Anti-regime saboteurs coordinating from hidden cells throughout the slums.",rivalId:"corpsec",defaultReputation:10},effects:{hostile:["Resistance ambush teams hunt you on sight.","Safe houses barred and support staff evacuate when you enter a cell."],unfriendly:["Handlers refuse new operations and keep patrol intel off the record.","Markets charge +50% and watchers shadow your movements."],neutral:["Standard trade access with baseline mission availability."],friendly:["Safe house quartermasters grant -25% discounts.","Resistance fire teams can reinforce nearby encounters.","Access to special sabotage contracts."],allied:["Leadership shares prototype gear and strategic intel.","Full access to command safe houses and staging areas.","Resistance commits strike units to the final mission."]}},corpsec:{definition:{id:"corpsec",name:"CorpSec",description:"Corporate security forces enforcing curfew and regime edicts downtown.",rivalId:"resistance",defaultReputation:-20},effects:{hostile:["CorpSec strike teams engage immediately and post bounties.","Checkpoints sealed; city travel heavily restricted."],unfriendly:["CorpSec enforcers tail you and random searches increase.","Vendor prices +50% and contracts withdrawn."],neutral:["Standard patrol scrutiny with access to routine contracts."],friendly:["Access to restricted checkpoints and heavy weapon requisitions.","CorpSec officers provide enforcement support nearby."],allied:["CorpSec elevates you to trusted asset status.","Elite armories and armored escorts unlocked for the endgame assault."]}},scavengers:{definition:{id:"scavengers",name:"Scavengers",description:"Resourceful traders running the black markets threading the slums and tunnels.",defaultReputation:0},effects:{hostile:["Black market shuts you out and bounty hunters look to cash in."],unfriendly:["Merchants hike prices by 50% and fence only low-tier goods.","Rumours and location intel dry up."],neutral:["Regular trade access with standard supply lists."],friendly:["Negotiated prices drop 25% and rare stock appears more often.","Vehicle parts and crafting materials offered reliably."],allied:["Exclusive caches, contraband routes, and crew hire options unlocked.","Scavengers lend munitions support during the finale."]}}},rp=e=>De[e],Dr=()=>Object.values(De).map(e=>e.definition),Lr=(e,t)=>De[e].effects[t],Fr=e=>{const t={resistance:De.resistance.definition.defaultReputation,corpsec:De.corpsec.definition.defaultReputation,scavengers:De.scavengers.definition.defaultReputation};return e?{resistance:te(e.resistance??t.resistance),corpsec:te(e.corpsec??t.corpsec),scavengers:te(e.scavengers??t.scavengers)}:t},Br=-70,Or=60,Nr=.5,Hn=(e,t,i)=>{const s=Fr(e),n=[],a=te(e[t]??s[t]),r=fe(a),o=te(a+i),l=fe(o);s[t]=o,l.id!==r.id&&n.push({factionId:t,previousStanding:r.id,nextStanding:l.id});const c={},d=De[t].definition.rivalId;if(d){const u=te(e[d]??s[d]),h=fe(u),g=-Math.round(i*Nr);if(g!==0){const p=te(u+g),m=p-u;if(m!==0){s[d]=p,c[d]=m;const f=fe(p);f.id!==h.id&&n.push({factionId:d,previousStanding:h.id,nextStanding:f.id})}}if(o>=Or){const p=te(Br);if(s[d]>p){const m=fe(s[d]),f=p-s[d];s[d]=p,c[d]=(c[d]??0)+f;const b=fe(s[d]);b.id!==m.id&&n.push({factionId:d,previousStanding:m.id,nextStanding:b.id})}}}return{values:s,primaryDelta:o-a,rivalDeltas:c,standingChanges:n}},Hr=(e,t,i)=>{const s=te(e[t]);return Hn(e,t,te(i)-s)},op=(e,t)=>{const i=fe(t);return{value:t,standing:i,effects:Lr(e,i.id),nextThreshold:_r(t)}},lp=e=>re.findIndex(t=>t.id===e),Wr={en:{hostile:"Hostile",unfriendly:"Unfriendly",neutral:"Neutral",friendly:"Friendly",allied:"Allied"},uk:{hostile:"Ворог",unfriendly:"Недружній",neutral:"Нейтральний",friendly:"Союзний",allied:"Союз"}},cp=(e,t)=>{var i;return((i=Wr[e])==null?void 0:i[t])??Nn[t].label},gt={strength:5,perception:5,endurance:5,charisma:5,intelligence:5,agility:5,luck:5},Ts=Je(gt.endurance),Rs=et(gt.agility),qr=tt(gt.strength),Es=pe(gt.endurance),Vr=Dr().reduce((e,t)=>(e[t.id]=t.defaultReputation,e),{resistance:0,corpsec:0,scavengers:0}),Gr=()=>({smallGuns:0,energyWeapons:0,meleeCombat:0,explosives:0,hacking:0,engineering:0,science:0,medicine:0,stealth:0,scavenging:0,persuasion:0,intimidation:0,barter:0}),Ht=()=>({alignment:"earnest",flags:{earnest:1,sarcastic:0,ruthless:0,stoic:0},lastUpdated:0}),Y={id:se(),name:"Player",position:{x:3,y:1},facing:"south",coverOrientation:null,suppression:0,health:Ts,maxHealth:Ts,actionPoints:Rs,maxActionPoints:Rs,stamina:Es,maxStamina:Es,isExhausted:!1,movementProfile:"normal",stealthModeEnabled:!1,stealthCooldownExpiresAt:null,skills:gt,skillTraining:Gr(),taggedSkillIds:[],level:1,experience:0,credits:0,skillPoints:0,attributePoints:0,backgroundId:void 0,perks:[],pendingPerkSelections:0,karma:0,personality:Ht(),factionReputation:{...Vr},appearancePreset:void 0,inventory:{items:[],maxWeight:qr,currentWeight:0,hotbar:[null,null,null,null,null]},equipped:{weapon:void 0,armor:void 0,accessory:void 0,secondaryWeapon:void 0,meleeWeapon:void 0,bodyArmor:void 0,helmet:void 0,accessory1:void 0,accessory2:void 0},equippedSlots:{},activeWeaponSlot:"primaryWeapon",perkRuntime:{gunFuShotsThisTurn:0,adrenalineRushTurnsRemaining:0,ghostInvisibilityTurns:0,ghostConsumed:!1},encumbrance:{level:"normal",percentage:0,movementApMultiplier:1,attackApMultiplier:1}},Xi=e=>e<=1?0:Math.floor(100*e*(1+e*.15)),zr=e=>3+Math.floor(e/3),Ur=e=>e>0,Kr=e=>e>0&&e%2===0,jr=(e,t)=>{const i=Xi(t+1);return e>=i},$r=e=>{let t=0,i=0,s=0,n=0;const a={...e};for(;jr(a.experience,a.level);){const r=Xi(a.level+1);a.experience-=r,a.level+=1,t++;const o=zr(a.skills.intelligence);i+=o,Ur(a.level)&&s++,Kr(a.level)&&n++,a.maxHealth+=5,a.health=a.maxHealth,a.maxStamina=pe(a.skills.endurance),a.stamina=a.maxStamina,a.isExhausted=!1,a.level%5===0&&(a.maxActionPoints+=1,a.actionPoints=a.maxActionPoints)}return{player:a,levelsGained:t,skillPointsAwarded:i,attributePointsAwarded:s,perksUnlocked:n}},Yr=(e,t)=>({...e,experience:Math.max(0,e.experience+t)}),dp=(e,t)=>{const i=Xi(t+1);return`${e} / ${i} XP`},Zr=[{id:"corpsec_defector",name:"Corpsec Defector",tagline:"Turned the regime’s training against them.",description:["Former security officer who leaked patrol routes until the alarms sounded on you.","You know their formations by heart and still dream in evac sirens."],factionAdjustments:{resistance:10,corpsec:-20},startingEquipment:[{type:"catalog",definitionId:"weapon_corpsec_service_pistol",equip:!0},{type:"catalog",definitionId:"armor_kevlar_vest",equip:!0},{type:"catalog",definitionId:"misc_corpsec_credentials"},{type:"catalog",definitionId:"consumable_basic_repair_kit",quantity:1}]},{id:"street_urchin",name:"Street Urchin",tagline:"Raised by alleys, guided by whispers.",description:["You hustled the markets since curfew was a bedtime story.","Lockpicks, fast feet, and favor debts keep you breathing."],factionAdjustments:{scavengers:10},startingEquipment:[{type:"catalog",definitionId:"weapon_shiv_knife",equip:!0},{type:"catalog",definitionId:"armor_layered_leather_jacket",equip:!0},{type:"catalog",definitionId:"misc_lockpick_set"},{type:"catalog",definitionId:"consumable_basic_repair_kit",quantity:1}]},{id:"underground_hacker",name:"Underground Hacker",tagline:"Screensaver by day, blackout by night.",description:["Your code toppled curfew drones before dawn.","Signal ghosts and failsafe exploits follow in your wake."],factionAdjustments:{resistance:15,corpsec:-10},startingEquipment:[{type:"catalog",definitionId:"misc_custom_deck"},{type:"catalog",definitionId:"misc_emp_charge"},{type:"catalog",definitionId:"armor_utility_hoodie",equip:!0},{type:"catalog",definitionId:"consumable_basic_repair_kit",quantity:1}]},{id:"wasteland_scavenger",name:"Wasteland Scavenger",tagline:"Dust lungs, steady hands, endless caches.",description:["You crossed toxic badlands with nothing but a crowbar and spite.","Trade routes and buried caches live in your head like lullabies."],factionAdjustments:{scavengers:10,resistance:5},startingEquipment:[{type:"catalog",definitionId:"weapon_industrial_crowbar",equip:!0},{type:"catalog",definitionId:"misc_gas_mask"},{type:"catalog",definitionId:"consumable_field_medkit",quantity:1},{type:"catalog",definitionId:"consumable_basic_repair_kit",quantity:1}]}],Xr=Object.fromEntries(Zr.map(e=>[e.id,e])),_s={damageMultiplier:1,hitChanceBonus:0,critChanceBonus:0,magazineSizeMultiplier:1,silenced:!1},Wt=(e,t)=>e?(t??e.attachedMods??[]).reduce((s,n)=>{var a,r;try{const l=pt(n.modId).effect;l.damageMultiplier!==void 0&&(s.damageMultiplier*=l.damageMultiplier),l.hitChanceBonus!==void 0&&(s.hitChanceBonus+=l.hitChanceBonus),l.hitChancePenalty!==void 0&&(s.hitChanceBonus-=l.hitChancePenalty),l.critChanceBonus!==void 0&&(s.critChanceBonus+=l.critChanceBonus),l.magazineSizeMultiplier!==void 0&&(s.magazineSizeMultiplier*=l.magazineSizeMultiplier),l.armorPiercingFactor!==void 0&&(s.armorPiercingFactor=s.armorPiercingFactor!==void 0?Math.min(s.armorPiercingFactor,l.armorPiercingFactor):l.armorPiercingFactor),(l.silenced||(a=l.addTags)!=null&&a.includes("silenced"))&&(s.silenced=!0),(r=l.addTags)!=null&&r.includes("armorPiercing")&&(s.armorPiercingFactor=s.armorPiercingFactor??.5)}catch{}return s},{..._s}):{..._s},up=(e,t,i)=>{if(!e)return{compatible:!1,reason:"Weapon not found"};if(!(e.modSlots??[]).includes(i))return{compatible:!1,reason:"This weapon has no matching slot."};const n=pt(t);if(n.slot!==i)return{compatible:!1,reason:"Mod slot mismatch."};const a=e.weaponType??"pistol";return n.compatibleWeaponTypes.includes(a)?{compatible:!0}:{compatible:!1,reason:"Not compatible with this weapon type."}},Qr=(e,t)=>({id:se(),amount:e,reason:t}),Jr=(e,t,i,s)=>({newLevel:e,skillPointsEarned:t,attributePointsEarned:i,perksUnlocked:s}),ii=1e-4,eo={normal:{movement:1,attack:1},heavy:{movement:1.25,attack:1.1,warning:"Pack weight is slowing you. You will bleed AP if you keep hauling this much."},overloaded:{movement:2,attack:1.25,warning:"Overloaded. Movement now chews double AP until you off-load gear."},immobile:{movement:Number.POSITIVE_INFINITY,attack:Number.POSITIVE_INFINITY,warning:"You are pinned by your gear. Drop items before you can move or fight."}},to=e=>!Number.isFinite(e)||Number.isNaN(e)?0:Math.max(0,Math.round(e*100)/100),io=e=>e>=120-ii?"immobile":e>=100-ii?"overloaded":e>=80-ii?"heavy":"normal",so=(e,t,i)=>{const s=t<=0?1:t,n=e/s*100,a=to(n),r=io(a),o=eo[r],l=o.warning??((i==null?void 0:i.level)===r?i==null?void 0:i.warning:void 0);return{level:r,percentage:a,movementApMultiplier:o.movement,attackApMultiplier:o.attack,warning:l}},no=e=>e.level==="immobile"||e.movementApMultiplier===Number.POSITIVE_INFINITY,hp={sprintTile:2,strenuousInteraction:1},ao=3,ro=.3,oo=.4,qe=(e,t)=>!Number.isFinite(e)||!Number.isFinite(t)||t<=0||e<0?0:e>t?t:e,Wn=(e,t)=>!Number.isFinite(e)||!Number.isFinite(t)||t<=0?0:Math.max(0,Math.min(1,e/t)),lo=(e,t)=>Wn(e,t)<ro,co=(e,t)=>Wn(e,t)>oo,it=(e,t)=>{var i;return((i=e==null?void 0:e.tags)==null?void 0:i.includes(t))??!1},si=e=>it(e,"twoHanded"),lt=2,wi=()=>{const e={...Y,id:se(),position:{...Y.position},skills:{...Y.skills},skillTraining:{...Y.skillTraining},taggedSkillIds:[...Y.taggedSkillIds],inventory:{items:[],maxWeight:Y.inventory.maxWeight,currentWeight:0,hotbar:[null,null,null,null,null]},karma:Y.karma,personality:Ht(),equipped:{weapon:void 0,armor:void 0,accessory:void 0,secondaryWeapon:void 0,meleeWeapon:void 0,bodyArmor:void 0,helmet:void 0,accessory1:void 0,accessory2:void 0},equippedSlots:{},activeWeaponSlot:"primaryWeapon",factionReputation:{...Y.factionReputation},perks:[...Y.perks],pendingPerkSelections:Y.pendingPerkSelections,backgroundId:void 0,appearancePreset:Y.appearancePreset,perkRuntime:{...Y.perkRuntime},encumbrance:{level:"normal",percentage:0,movementApMultiplier:1,attackApMultiplier:1}};return Fe(e),Be(e),e},G={version:lt,data:wi(),pendingLevelUpEvents:[],xpNotifications:[],pendingFactionEvents:[]},Te=e=>Math.max(1,Math.min(10,Math.round(e))),uo=e=>Math.round(e*100)/100,Pi=5,ho=["primaryWeapon","secondaryWeapon","meleeWeapon","bodyArmor","helmet","accessory1","accessory2"],po=20,mo=e=>e.primaryDelta!==0||Object.values(e.rivalDeltas).some(t=>t!==0)||e.standingChanges.length>0,go=(e,t)=>{e.pendingFactionEvents.push(t),e.pendingFactionEvents.length>po&&e.pendingFactionEvents.shift()},Ds=(e,t,i,s)=>{mo(i)&&go(e,{factionId:t,delta:i.primaryDelta,updatedValue:e.data.factionReputation[t],rivalDeltas:i.rivalDeltas,standingChanges:i.standingChanges,reason:s==null?void 0:s.reason,source:s==null?void 0:s.source,timestamp:Date.now()})};function He(e){if(!Number.isFinite(e.maxStamina)||e.maxStamina<=0){e.maxStamina=0,e.stamina=0,e.isExhausted=!1;return}if(e.stamina=qe(e.stamina,e.maxStamina),lo(e.stamina,e.maxStamina)){e.isExhausted=!0;return}if(e.isExhausted&&co(e.stamina,e.maxStamina)){e.isExhausted=!1;return}!e.isExhausted&&e.stamina>=e.maxStamina&&(e.isExhausted=!1)}function Re(e,t,i={}){const s=i.preserveRatio??!0,n=Number.isFinite(t)&&t>0?Math.floor(t):0,a=Number.isFinite(e.maxStamina)&&e.maxStamina>0?e.maxStamina:0;let r;if(!s||a===0||n===0)r=n;else{const o=Math.max(0,Math.min(1,qe(e.stamina,a)/a));r=Math.floor(n*o)}e.maxStamina=n,e.stamina=n===0?0:qe(r,n),He(e)}function Fe(e){(!Number.isFinite(e.maxStamina)||e.maxStamina<0)&&(e.maxStamina=pe(e.skills.endurance)),Number.isFinite(e.stamina)?e.stamina=qe(e.stamina,e.maxStamina):e.stamina=e.maxStamina,typeof e.isExhausted!="boolean"&&(e.isExhausted=!1),He(e)}const Qi=e=>{const t=e?[...e]:[];for(;t.length<Pi;)t.push(null);return t.slice(0,Pi)},Zt=e=>{if(!e)return 0;if(!e.stackable)return 1;const t=e.quantity??1;return!Number.isFinite(t)||t<=0?1:Math.floor(t)},fo=e=>typeof globalThis.structuredClone=="function"?globalThis.structuredClone(e):JSON.parse(JSON.stringify(e));function Be(e){e.movementProfile!=="silent"&&e.movementProfile!=="sprint"&&(e.movementProfile="normal"),typeof e.stealthModeEnabled!="boolean"&&(e.stealthModeEnabled=!1),e.stealthCooldownExpiresAt!==null&&(!Number.isFinite(e.stealthCooldownExpiresAt)||e.stealthCooldownExpiresAt<0)&&(e.stealthCooldownExpiresAt=null)}const qn=e=>e.damage!==void 0,Vn=e=>e.protection!==void 0,yo=(e,t)=>{const i=new Set,s=[],n=(a,r)=>{if(!a||i.has(a.id)||!a.durability)return;const o=a.durability.max;if(!Number.isFinite(o)||o<=0)return;const l=a.durability.current;if(l>=o||t==="weapon"&&!qn(a)||t==="armor"&&!Vn(a))return;const c=l<=0?0:Math.max(0,Math.min(1,l/o));i.add(a.id),s.push({item:a,ratio:c,equipped:r})};return n(e.equipped.weapon,!0),n(e.equipped.secondaryWeapon,!0),n(e.equipped.meleeWeapon,!0),n(e.equipped.bodyArmor,!0),n(e.equipped.helmet,!0),e.equippedSlots&&Object.values(e.equippedSlots).forEach(a=>n(a,!0)),e.inventory.items.forEach(a=>n(a,!1)),s},So=(e,t)=>{var s;const i=yo(e,t);return i.length===0?null:(i.sort((n,a)=>n.ratio!==a.ratio?n.ratio-a.ratio:n.equipped!==a.equipped?n.equipped?-1:1:0),((s=i[0])==null?void 0:s.item.id)??null)},vo=e=>{if(e.equipSlot)return e.equipSlot;const t=e;return(Number.isFinite(t.range)?t.range:0)<=1||t.skillType==="meleeCombat"?"meleeWeapon":"primaryWeapon"},le=(e,t)=>{if(!e)return e;const i={...e};if(qn(i)){const s=i.durability,n=Number.isFinite(s==null?void 0:s.max)&&((s==null?void 0:s.max)??0)>0?Math.round(s.max):100,a=Number.isFinite(s==null?void 0:s.current)?Math.max(0,Math.round(s.current)):n;i.durability={max:n,current:Math.min(n,a)},i.equipSlot=t??vo(i)}else if(Vn(i)){const s=i.durability,n=Number.isFinite(s==null?void 0:s.max)&&((s==null?void 0:s.max)??0)>0?Math.round(s.max):120,a=Number.isFinite(s==null?void 0:s.current)?Math.max(0,Math.round(s.current)):n;i.durability={max:n,current:Math.min(n,a)},i.equipSlot=t??"bodyArmor"}else t&&(i.equipSlot=t);if(i.stackable){const s=Zt(i)||1;i.quantity=s,(!Number.isFinite(i.maxStack)||i.maxStack===void 0||i.maxStack<=0)&&(i.maxStack=Math.max(5,s))}else delete i.quantity,delete i.maxStack;return Number.isFinite(i.weight)||(i.weight=0),Number.isFinite(i.value)||(i.value=0),i},bo=e=>{const t=e.reduce((i,s)=>{const n=Number.isFinite(s.weight)?s.weight:0;return i+n*Zt(s)},0);return uo(t)},ie=e=>{e.inventory.items=e.inventory.items.map(s=>le(s)??s);const t=bo(e.inventory.items),i=Qi(e.inventory.hotbar);e.inventory={...e.inventory,currentWeight:t,hotbar:i},e.encumbrance=so(e.inventory.currentWeight,e.inventory.maxWeight,e.encumbrance)},wo=(e,t)=>e.inventory.items.reduce((i,s)=>{if(s.definitionId!==t)return i;const n=s.stackable?s.quantity??1:1;return i+n},0),Po=(e,t,i)=>{if(i<=0)return!0;let s=i;return e.inventory.items=e.inventory.items.reduce((n,a)=>{if(s<=0||a.definitionId!==t)return n.push(a),n;if(a.stackable){const r=a.quantity??1;return r>s?(n.push({...a,quantity:r-s}),s=0):s-=r,n}return s-=1,s<0&&(s=0),n},[]),ie(e),s===0},Mo=(e,t)=>{if(t.find(s=>wo(e,s.id)<s.quantity))return!1;for(const s of t)if(!Po(e,s.id,s.quantity))return!1;return!0},Ji=(e,t)=>{const i=e.inventory.items.findIndex(n=>n.id===t);if(i===-1)return;const[s]=e.inventory.items.splice(i,1);return s},Gn=(e,t)=>t||(e.equipSlot?e.equipSlot:"damage"in e?"primaryWeapon":"protection"in e?"bodyArmor":null),qt=e=>e.modSlots?e.modSlots:(e.weaponType??"pistol")==="melee"?[]:["barrel","magazine","optics"],zn=e=>{const t=e.magazineSize??0;if(t<=0)return e;const i=Wt(e),s=Math.max(1,Math.round(t*(i.magazineSizeMultiplier??1))),n=e.currentMagazine??s;return{...e,currentMagazine:Math.max(0,Math.min(s,n))}},Ao=(e,t)=>{const i=[...e.attachedMods??[]],s=i.findIndex(a=>a.slot===t);if(s===-1)return{updated:{...e,modSlots:qt(e)}};const[n]=i.splice(s,1);return{updated:{...e,attachedMods:i,modSlots:qt(e),currentMagazine:zn(e).currentMagazine},detachedModId:n.modId}},Io=(e,t)=>{const i=pt(t),s=qt(e),n=[...e.attachedMods??[]],a=n.findIndex(o=>o.slot===i.slot);let r;return a!==-1&&(r=n[a].modId,n.splice(a,1)),n.push({slot:i.slot,modId:t}),{updated:{...e,attachedMods:n,modSlots:s,currentMagazine:zn(e).currentMagazine},replacedModId:r}},xo=(e,t)=>{var l;const i=pt(t.modId),s=t.feePaid??0;if(i.crafting.station==="workbench"&&!t.atWorkbench||s>0&&e.credits<s)return!1;const n=((l=e.skillTraining)==null?void 0:l.engineering)??0;if(!Number.isFinite(n)||n<i.crafting.level)return!1;const a=i.crafting.inputs.map(c=>({id:c.id,quantity:c.quantity}));if(!Mo(e,a))return!1;s>0&&(e.credits-=s);const o=jt(t.modId);return e.inventory.items.push(o),ie(e),!0},Me=(e,t,i)=>{switch(t){case"primaryWeapon":e.equipped.weapon=i;break;case"secondaryWeapon":e.equipped.secondaryWeapon=i;break;case"meleeWeapon":e.equipped.meleeWeapon=i;break;case"bodyArmor":e.equipped.bodyArmor=i,e.equipped.armor=i;break;case"helmet":e.equipped.helmet=i;break;case"accessory1":e.equipped.accessory1=i;break;case"accessory2":e.equipped.accessory2=i;break}e.equippedSlots||(e.equippedSlots={}),i?e.equippedSlots[t]=i:e.equippedSlots&&delete e.equippedSlots[t]},rt=(e,t)=>{if(e.equippedSlots&&e.equippedSlots[t])return e.equippedSlots[t];switch(t){case"primaryWeapon":return e.equipped.weapon;case"secondaryWeapon":return e.equipped.secondaryWeapon;case"meleeWeapon":return e.equipped.meleeWeapon;case"bodyArmor":return e.equipped.bodyArmor??e.equipped.armor;case"helmet":return e.equipped.helmet;case"accessory1":return e.equipped.accessory1;case"accessory2":return e.equipped.accessory2;default:return}},Vt=e=>{const t={...e},i=e;return Array.isArray(i.attachedMods)&&(t.attachedMods=[...i.attachedMods]),t},ft=(e,t)=>{const i=e.inventory.items.findIndex(s=>s.id===t);if(i!==-1)return{location:"inventory",item:e.inventory.items[i],index:i};for(const s of ho){const n=rt(e,s);if(n&&n.id===t)return{location:"equipped",item:n,slot:s}}},Un=(e,t,i)=>{if(t.location==="inventory"){e.inventory.items[t.index]=i;return}Me(e,t.slot,i),e.equippedSlots&&(e.equippedSlots[t.slot]=i)},ni=(e,t)=>{const{itemId:i,slot:s}=t,n=e.inventory.items.find(c=>c.id===i);if(!n||n.isQuestItem||n.stackable||n.durability&&n.durability.current<=0)return!1;const a=Gn(n,s);if(!a)return!1;const r="damage"in n?n:void 0;if(a==="secondaryWeapon"){if(r&&si(r))return!1;const c=rt(e,"primaryWeapon");if(si(c))return!1}const o=Ji(e,i);if(!o)return!1;const l=rt(e,a);if(l&&e.inventory.items.push(Vt(l)),a==="primaryWeapon"&&"damage"in o&&si(o)){const c=rt(e,"secondaryWeapon");c&&(e.inventory.items.push(Vt(c)),Me(e,"secondaryWeapon",void 0),e.activeWeaponSlot==="secondaryWeapon"&&(e.activeWeaponSlot="primaryWeapon"))}return Me(e,a,o),(a==="primaryWeapon"||a==="secondaryWeapon"||a==="meleeWeapon")&&(e.activeWeaponSlot=a),ie(e),!0},ai=(e,t)=>{const{slot:i}=t,s=rt(e,i);return s?(e.inventory.items.push(Vt(s)),Me(e,i,void 0),i===e.activeWeaponSlot&&(e.activeWeaponSlot="primaryWeapon"),ie(e),!0):!1},Kn=(e,t)=>{const{itemId:i,amount:s}=t;if(!Number.isFinite(s)||s<=0)return!1;const n=ft(e,i);if(!n||!n.item.durability)return!1;const a=Math.floor(s),r=n.item.durability;return r.current=Math.min(r.max,r.current+a),n.location==="equipped"&&Me(e,n.slot,n.item),!0},Co=(e,t)=>{const{itemId:i,quantity:s}=t;if(!Number.isFinite(s)||s<=0)return;const n=ft(e,i);if(!n||n.location!=="inventory")return;const a=n.item;if(!a.stackable)return;const r=Zt(a),o=Math.floor(s);if(o>=r)return;const l=Vt(a);l.id=se(),l.quantity=o;const c=r-o;return a.quantity=c<=1?void 0:c,a.quantity===void 0&&delete a.quantity,e.inventory.items.push(l),ie(e),l},ko=(e,t)=>{const{slotIndex:i,itemId:s}=t;if(!Number.isInteger(i)||i<0||i>=Pi)return!1;if(e.inventory.hotbar=Qi(e.inventory.hotbar),s!==null){const n=ft(e,s);if(!n||n.location!=="inventory")return!1;e.inventory.hotbar=e.inventory.hotbar.map((a,r)=>a===s&&r!==i?null:a),e.inventory.hotbar[i]=s}else e.inventory.hotbar[i]=null;return!0},To=(e,t)=>{const{weaponId:i,modItemId:s}=t,n=ft(e,i);if(!n||!("damage"in n.item))return!1;const a=n.item,r=e.inventory.items.find(p=>p.id===s&&p.weaponModId);if(!r||!r.weaponModId)return!1;const o=r.weaponModId,l=pt(o),c=a.weaponType??"pistol";if(!qt(a).includes(l.slot)||!l.compatibleWeaponTypes.includes(c)||!Ji(e,s))return!1;const{updated:h,replacedModId:g}=Io(a,o);return g&&e.inventory.items.push(jt(g)),Un(e,n,h),ie(e),!0},Ro=(e,t)=>{const{weaponId:i,slot:s}=t,n=ft(e,i);if(!n||!("damage"in n.item))return!1;const a=n.item,{updated:r,detachedModId:o}=Ao(a,s);return o?(e.inventory.items.push(jt(o)),Un(e,n,r),ie(e),!0):!1},Eo=(e,t)=>{e.inventory.hotbar=Qi(e.inventory.hotbar);const i=e.inventory.items.findIndex(c=>c.id===t);if(i===-1)return!1;const s=e.inventory.items[i];if(!s||!("effect"in s))return!1;const n=s,a=n.effect;let r=null,o=0;if(a.type==="repair"&&(o=Math.floor(a.value??0),o<=0||(r=So(e,a.target??"any"),!r)))return!1;let l=!1;if(s.stackable){const c=Zt(s);if(c<=1)e.inventory.items.splice(i,1),l=!0;else{const d=c-1;d<=1?delete n.quantity:n.quantity=d}}else e.inventory.items.splice(i,1),l=!0;switch(l&&(e.inventory.hotbar=e.inventory.hotbar.map(c=>c===t?null:c)),a.type){case"health":{const c=Number.isFinite(a.value)?a.value:0;e.health=Math.min(e.maxHealth,Math.max(0,e.health+c));break}case"actionPoints":{const c=Number.isFinite(a.value)?a.value:0;e.actionPoints=Math.min(e.maxActionPoints,Math.max(0,e.actionPoints+c));break}case"stat":{if(a.statAffected){const c=e.skills[a.statAffected]??0,d=Number.isFinite(a.value)?a.value:0;e.skills[a.statAffected]=c+d}break}case"repair":{r&&Kn(e,{itemId:r,amount:o});break}}return ie(e),!0},_o=(e,t)=>{switch(t.type){case"catalog":{const i=jt(t.definitionId,{quantity:t.quantity,durability:t.durability});if(t.equip){const s=Gn(i);if(s){Me(e,s,i),(s==="primaryWeapon"||s==="secondaryWeapon"||s==="meleeWeapon")&&(e.activeWeaponSlot=s);break}}e.inventory.items.push(i);break}case"weapon":{const i=Ya(t.name,t.damage,t.range,t.apCost,t.weight,t.statModifiers,t.skillType);t.equip?Me(e,"primaryWeapon",i):e.inventory.items.push(i);break}case"armor":{const i=$a(t.name,t.protection,t.weight,t.statModifiers);t.equip?Me(e,"bodyArmor",i):e.inventory.items.push(i);break}case"consumable":{const i=ja(t.name,t.effectType,t.value,{statAffected:t.statAffected,weight:t.weight,target:t.target,stackable:t.stackable,maxStack:t.maxStack,quantity:t.quantity});e.inventory.items.push(i);break}case"item":{const i={id:se(),name:t.name,description:t.description,weight:t.weight,value:Math.max(10,Math.round(t.weight*15)),isQuestItem:!!t.isQuestItem};e.inventory.items.push(i);break}}ie(e)},jn=Q({name:"player",initialState:G,reducers:{initializeCharacter:(e,t)=>{const{name:i,skills:s,backgroundId:n,visualPreset:a}=t.payload,r={strength:Te(s.strength),perception:Te(s.perception),endurance:Te(s.endurance),charisma:Te(s.charisma),intelligence:Te(s.intelligence),agility:Te(s.agility),luck:Te(s.luck)},o=Zi(r),l=Xr[n],c=wi();c.name=i,c.appearancePreset=a,c.skills=r,c.maxHealth=o.maxHP,c.health=o.maxHP,c.maxActionPoints=o.baseAP,c.actionPoints=o.baseAP,c.maxStamina=o.maxStamina,c.stamina=o.maxStamina,c.isExhausted=!1,He(c),c.inventory={items:[],maxWeight:o.carryWeight,currentWeight:0,hotbar:[null,null,null,null,null]},c.equipped={weapon:void 0,armor:void 0,accessory:void 0,secondaryWeapon:void 0,meleeWeapon:void 0,bodyArmor:void 0,helmet:void 0,accessory1:void 0,accessory2:void 0},c.equippedSlots={},c.activeWeaponSlot="primaryWeapon",c.perks=[],c.pendingPerkSelections=0,c.backgroundId=n,c.factionReputation={resistance:0,corpsec:0,scavengers:0},c.perkRuntime={gunFuShotsThisTurn:0,adrenalineRushTurnsRemaining:0,ghostInvisibilityTurns:0,ghostConsumed:!1},l&&(l.perk&&c.perks.push(l.perk.id),Object.entries(l.factionAdjustments).forEach(([d,u])=>{const h=d,g=u??0,p=c.factionReputation[h]??0;c.factionReputation[h]=te(p+g)}),l.startingEquipment.forEach(d=>_o(c,d))),e.data=c,e.data.encumbrance={level:"normal",percentage:0,movementApMultiplier:1,attackApMultiplier:1}},adjustFactionReputation:(e,t)=>{const{factionId:i,delta:s,reason:n,source:a}=t.payload;if(!Number.isFinite(s)||s===0)return;const r=Hn(e.data.factionReputation,i,s);e.data.factionReputation={...r.values},Ds(e,i,r,{reason:n,source:a})},setFactionReputation:(e,t)=>{const{factionId:i,value:s,reason:n,source:a}=t.payload,r=Hr(e.data.factionReputation,i,s);e.data.factionReputation={...r.values},Ds(e,i,r,{reason:n,source:a})},consumeFactionReputationEvents:e=>{e.pendingFactionEvents=[]},adjustPersonalityTrait:(e,t)=>{const{trait:i,delta:s,source:n}=t.payload;e.data.personality||(e.data.personality=Ht());const a={...e.data.personality.flags},r=a[i]??0,o=Math.max(-5,Math.min(5,r+s));a[i]=o,e.data.personality={...e.data.personality,flags:a,lastUpdated:Date.now(),lastChangeSource:n??"storylet"}},movePlayer:(e,t)=>{if(e.data.encumbrance.level==="immobile")return;const i=e.data.position;if(e.data.position=t.payload,i){const s=t.payload.x-i.x,n=t.payload.y-i.y;(s!==0||n!==0)&&(Math.abs(s)>=Math.abs(n)?e.data.facing=s>=0?"east":"west":e.data.facing=n>=0?"south":"north")}e.data.coverOrientation=null,e.data.suppression=e.data.suppression??0},updateHealth:(e,t)=>{e.data.health=Math.max(0,Math.min(e.data.maxHealth,e.data.health+t.payload)),ei(e.data)&&(e.data=ti(e.data))},setHealth:(e,t)=>{e.data.health=Math.max(0,Math.min(e.data.maxHealth,t.payload)),ei(e.data)&&(e.data=ti(e.data))},updateActionPoints:(e,t)=>{e.data.actionPoints=Math.max(0,Math.min(e.data.maxActionPoints,e.data.actionPoints+t.payload))},resetActionPoints:e=>{e.data.actionPoints=e.data.maxActionPoints},consumeStamina:(e,t)=>{Fe(e.data),Be(e.data);const i=t.payload;if(!Number.isFinite(i)||i<=0)return;const s=Math.max(0,Math.floor(i));e.data.stamina=qe(e.data.stamina-s,e.data.maxStamina),He(e.data)},regenerateStamina:(e,t)=>{Fe(e.data),Be(e.data);const i=t.payload??ao;if(!Number.isFinite(i)||i<=0){He(e.data);return}const s=Math.max(0,Math.floor(i));e.data.stamina=qe(e.data.stamina+s,e.data.maxStamina),He(e.data)},updateMaxStamina:e=>{Fe(e.data),Be(e.data);const t=pe(e.data.skills.endurance);Re(e.data,t,{preserveRatio:!0})},addExperience:(e,t)=>{const i=typeof t.payload=="number"?{amount:t.payload}:t.payload,s=i.amount;if(!Number.isFinite(s)||s===0)return;e.data=Yr(e.data,s);const n=$r(e.data);if(e.data=n.player,Fe(e.data),Be(e.data),n.skillPointsAwarded>0&&(e.data.skillPoints+=n.skillPointsAwarded),n.attributePointsAwarded>0&&(e.data.attributePoints+=n.attributePointsAwarded),n.perksUnlocked>0&&(e.data.pendingPerkSelections+=n.perksUnlocked),n.levelsGained>0&&(e.pendingLevelUpEvents.push(Jr(e.data.level,n.skillPointsAwarded,n.attributePointsAwarded,n.perksUnlocked)),Re(e.data,pe(e.data.skills.endurance),{preserveRatio:!1})),s>0){const a=i.reason??"Experience gained",r=e.xpNotifications??[];e.xpNotifications=[...r,Qr(s,a)]}},addCredits:(e,t)=>{e.data.credits=Math.max(0,e.data.credits+t.payload)},setKarma:(e,t)=>{const i=Math.max(-1e3,Math.min(1e3,t.payload));e.data.karma=i,e.data.personality.lastUpdated=Date.now(),e.data.personality.lastChangeSource="karma:set"},adjustKarma:(e,t)=>{const i=Math.max(-1e3,Math.min(1e3,e.data.karma+t.payload));e.data.karma=i,e.data.personality.lastUpdated=Date.now(),e.data.personality.lastChangeSource="karma:adjust"},removeXPNotification:(e,t)=>{const i=e.xpNotifications??[];e.xpNotifications=i.filter(s=>s.id!==t.payload)},levelUp:e=>{e.data.level+=1,e.data.maxHealth+=10,e.data.health=e.data.maxHealth,e.data.maxActionPoints+=1,e.data.actionPoints=e.data.maxActionPoints;const t=pe(e.data.skills.endurance);Re(e.data,t,{preserveRatio:!1})},updateSkill:(e,t)=>{const{skill:i,amount:s}=t.payload;e.data.skills[i]=Math.max(1,Math.min(10,e.data.skills[i]+s));const n=e.data.skills,a=Je(n.endurance),r=et(n.agility),o=tt(n.strength),l=pe(n.endurance),c=Number.isFinite(e.data.health)?e.data.health:0,d=Number.isFinite(e.data.maxHealth)&&e.data.maxHealth>0?e.data.maxHealth:1,u=c/d;e.data.maxHealth=a;const h=Math.floor(a*u);e.data.health=Math.max(0,Math.min(Number.isFinite(h)?h:a,a)),e.data.maxActionPoints=r,e.data.actionPoints=Math.min(e.data.actionPoints,r),e.data.inventory.maxWeight=o,Re(e.data,l,{preserveRatio:!0})},setSkill:(e,t)=>{const{skill:i,value:s}=t.payload;e.data.skills[i]=Math.max(1,Math.min(10,s));const n=e.data.skills;e.data.maxHealth=Je(n.endurance),e.data.health=e.data.maxHealth,e.data.maxActionPoints=et(n.agility),e.data.actionPoints=e.data.maxActionPoints,e.data.inventory.maxWeight=tt(n.strength),Re(e.data,pe(n.endurance),{preserveRatio:!1})},addItem:(e,t)=>{e.data.inventory.items.push(t.payload),ie(e.data)},removeItem:(e,t)=>{const i=t.payload;Ji(e.data,i)&&ie(e.data)},resetPlayer:e=>{e.version=lt,e.data=wi(),e.pendingLevelUpEvents=[],e.xpNotifications=[],e.pendingFactionEvents=[]},setPlayerData:(e,t)=>{const i=fo(t.payload);if(e.version=lt,e.data=i,e.data.factionReputation||(e.data.factionReputation={...Y.factionReputation}),["resistance","corpsec","scavengers"].forEach(n=>{const a=Y.factionReputation[n]??0,r=e.data.factionReputation[n];e.data.factionReputation[n]=te(typeof r=="number"?r:a)}),e.pendingFactionEvents=[],e.data.perkRuntime||(e.data.perkRuntime={gunFuShotsThisTurn:0,adrenalineRushTurnsRemaining:0,ghostInvisibilityTurns:0,ghostConsumed:!1}),e.data.inventory.hotbar||(e.data.inventory.hotbar=[null,null,null,null,null]),e.data.equipped?e.data.equipped={...e.data.equipped}:e.data.equipped={},e.data.equippedSlots||(e.data.equippedSlots={}),e.data.activeWeaponSlot||(e.data.activeWeaponSlot="primaryWeapon"),e.data.encumbrance||(e.data.encumbrance={level:"normal",percentage:0,movementApMultiplier:1,attackApMultiplier:1}),!e.data.personality)e.data.personality=Ht();else{const n=e.data.personality.flags??{};e.data.personality={...e.data.personality,flags:{earnest:n.earnest??0,sarcastic:n.sarcastic??0,ruthless:n.ruthless??0,stoic:n.stoic??0},lastUpdated:e.data.personality.lastUpdated??0}}e.data.inventory.items=e.data.inventory.items.map(n=>le(n)??n),e.data.equipped.weapon=le(e.data.equipped.weapon,"primaryWeapon"),e.data.equipped.secondaryWeapon=le(e.data.equipped.secondaryWeapon,"secondaryWeapon"),e.data.equipped.meleeWeapon=le(e.data.equipped.meleeWeapon,"meleeWeapon"),e.data.equipped.bodyArmor=le(e.data.equipped.bodyArmor,"bodyArmor"),e.data.equipped.helmet=le(e.data.equipped.helmet,"helmet"),e.data.equipped.accessory1=le(e.data.equipped.accessory1,"accessory1"),e.data.equipped.accessory2=le(e.data.equipped.accessory2,"accessory2");const s=e.data.equippedSlots??{};e.data.equippedSlots=s,Object.entries(s).forEach(([n,a])=>{if(!a)return;const r=le(a,n);s[n]=r}),Fe(e.data),Be(e.data),ie(e.data),ei(e.data)&&(e.data=ti(e.data))},setMovementProfile:(e,t)=>{e.data.movementProfile=t.payload},setStealthState:(e,t)=>{e.data.stealthModeEnabled=t.payload.enabled,"cooldownExpiresAt"in t.payload&&(e.data.stealthCooldownExpiresAt=t.payload.cooldownExpiresAt??null)},equipItem:(e,t)=>{ni(e.data,t.payload)},unequipItem:(e,t)=>{ai(e.data,t.payload)},repairItem:(e,t)=>{Kn(e.data,t.payload)},splitStack:(e,t)=>{Co(e.data,t.payload)},assignHotbarSlot:(e,t)=>{ko(e.data,t.payload),ie(e.data)},attachWeaponMod:(e,t)=>{To(e.data,t.payload)},detachWeaponMod:(e,t)=>{Ro(e.data,t.payload)},craftWeaponMod:(e,t)=>{xo(e.data,t.payload)},useInventoryItem:(e,t)=>{Eo(e.data,t.payload)},equipWeapon:(e,t)=>{ni(e.data,{itemId:t.payload,slot:"primaryWeapon"})},equipArmor:(e,t)=>{ni(e.data,{itemId:t.payload,slot:"bodyArmor"})},unequipWeapon:e=>{ai(e.data,{slot:"primaryWeapon"})},unequipArmor:e=>{ai(e.data,{slot:"bodyArmor"})},consumeLevelUpEvent:e=>{e.pendingLevelUpEvents.shift()},clearPendingPerkSelections:e=>{e.data.pendingPerkSelections=0},selectPerk:(e,t)=>{const i=t.payload;if(e.data.pendingPerkSelections<=0||e.data.perks.includes(i))return;const s=Ua(i);if(Ka(e.data,s).canSelect)switch(e.data.perks.push(i),e.data.pendingPerkSelections=Math.max(0,e.data.pendingPerkSelections-1),i){case"gunFu":e.data.perkRuntime.gunFuShotsThisTurn=0;break;case"adrenalineRush":e.data.perkRuntime.adrenalineRushTurnsRemaining=0;break;case"ghost":e.data.perkRuntime.ghostConsumed=!1,e.data.perkRuntime.ghostInvisibilityTurns=0;break}},beginPlayerTurn:e=>{e.data=Pr(e.data),e.data.perkRuntime.adrenalineRushTurnsRemaining>0&&(e.data=Mr(e.data)),e.data.perkRuntime.ghostInvisibilityTurns>0&&(e.data=Ar(e.data))},spendSkillPoints:(e,t)=>{const i=t.payload;e.data.skillPoints>=i&&i>0&&(e.data.skillPoints-=i)},allocateSkillPointToSkill:(e,t)=>{const i=t.payload;if(e.data.skillPoints<=0)return;const s=bi(i),n=e.data.skillTraining[i]??0,r=e.data.taggedSkillIds.includes(i)?s.taggedIncrement:s.increment;n>=s.maxValue||n+r>s.maxValue||(e.data.skillTraining[i]=n+r,e.data.skillPoints-=1)},refundSkillPointFromSkill:(e,t)=>{const i=t.payload,s=bi(i),n=e.data.skillTraining[i]??0;if(n<=0)return;const r=e.data.taggedSkillIds.includes(i)?s.taggedIncrement:s.increment,o=n-r;o<0||(e.data.skillTraining[i]=o,e.data.skillPoints+=1)},spendAttributePoint:(e,t)=>{const i=t.payload;if(e.data.attributePoints<=0||e.data.skills[i]>=10)return;e.data.attributePoints-=1,e.data.skills[i]+=1;const s=e.data.skills,n=Je(s.endurance),a=et(s.agility),r=tt(s.strength),o=pe(s.endurance),l=Number.isFinite(e.data.health)?e.data.health:0,c=Number.isFinite(e.data.maxHealth)&&e.data.maxHealth>0?e.data.maxHealth:1,d=l/c;e.data.maxHealth=n;const u=Math.floor(n*d);e.data.health=Math.max(0,Math.min(Number.isFinite(u)?u:n,n)),e.data.maxActionPoints=a,e.data.actionPoints=Math.min(e.data.actionPoints,a),e.data.inventory.maxWeight=r,Re(e.data,o,{preserveRatio:!0})},refundAttributePoint:(e,t)=>{const i=t.payload;if(e.data.skills[i]<=1)return;e.data.attributePoints+=1,e.data.skills[i]-=1;const n=e.data.skills,a=Je(n.endurance),r=et(n.agility),o=tt(n.strength),l=pe(n.endurance),c=Number.isFinite(e.data.health)?e.data.health:0,d=Number.isFinite(e.data.maxHealth)&&e.data.maxHealth>0?e.data.maxHealth:1,u=c/d;e.data.maxHealth=a;const h=Math.floor(a*u);e.data.health=Math.max(0,Math.min(Number.isFinite(h)?h:a,a)),e.data.maxActionPoints=r,e.data.actionPoints=Math.min(e.data.actionPoints,r),e.data.inventory.maxWeight=o,Re(e.data,l,{preserveRatio:!0})}}}),{initializeCharacter:pp,movePlayer:Do,updateHealth:Lo,setHealth:mp,updateActionPoints:Ls,resetActionPoints:gp,consumeStamina:fp,regenerateStamina:yp,updateMaxStamina:Sp,addExperience:vp,addCredits:bp,setKarma:wp,adjustKarma:Pp,adjustFactionReputation:Fo,setFactionReputation:Mp,consumeFactionReputationEvents:Ap,adjustPersonalityTrait:Bo,removeXPNotification:Ip,levelUp:xp,updateSkill:Cp,setSkill:kp,addItem:Tp,removeItem:Rp,equipItem:Ep,unequipItem:_p,repairItem:Dp,splitStack:Lp,assignHotbarSlot:Fp,attachWeaponMod:Bp,detachWeaponMod:Op,craftWeaponMod:Np,useInventoryItem:Hp,resetPlayer:Wp,setPlayerData:Oo,setMovementProfile:qp,setStealthState:Vp,equipWeapon:Gp,equipArmor:zp,unequipWeapon:Up,unequipArmor:Kp,consumeLevelUpEvent:jp,clearPendingPerkSelections:$p,selectPerk:Yp,beginPlayerTurn:Zp,spendSkillPoints:Xp,spendAttributePoint:Qp,refundAttributePoint:Jp,allocateSkillPointToSkill:em,refundSkillPointFromSkill:tm}=jn.actions,No=jn.reducer,ot="corpsec-sentinel",N=e=>({kind:"lineOfSight",state:"chase",weight:0,...e}),Ho=[N({kind:"lineOfSight",state:"attack",weight:3}),N({kind:"lineOfSight",state:"chase",weight:2}),N({kind:"lostLineOfSight",state:"search",weight:2}),N({kind:"healthBelow",state:"flee",threshold:.35,weight:3}),N({kind:"suppressionAbove",state:"panic",threshold:.6,weight:2}),N({kind:"alertAtLeast",state:"attack",alert:L.INVESTIGATING,weight:1.5}),N({kind:"alertBelow",state:"patrol",alert:L.SUSPICIOUS,weight:1}),N({kind:"distanceBelow",state:"attack",tiles:2,weight:2.5}),N({kind:"distanceAbove",state:"patrol",tiles:8,weight:1.2}),{kind:"healthBelow",state:"attack",threshold:.4,weight:-3},{kind:"healthBelow",state:"chase",threshold:.4,weight:-3},{kind:"healthBelow",state:"panic",threshold:.35,weight:2}],Wo=[N({kind:"lineOfSight",state:"attack",weight:4}),N({kind:"lineOfSight",state:"chase",weight:3}),N({kind:"lostLineOfSight",state:"search",weight:1.5}),N({kind:"healthBelow",state:"panic",threshold:.25,weight:2}),N({kind:"suppressionAbove",state:"flee",threshold:.8,weight:2}),N({kind:"alertAtLeast",state:"attack",alert:L.ALARMED,weight:2}),N({kind:"directorAtLeast",state:"panic",threshold:.8,weight:1.5})],qo=[N({kind:"lineOfSight",state:"chase",weight:1.5}),N({kind:"lostLineOfSight",state:"search",weight:3}),N({kind:"healthBelow",state:"flee",threshold:.5,weight:3}),N({kind:"alertBelow",state:"patrol",alert:L.SUSPICIOUS,weight:2}),N({kind:"distanceAbove",state:"patrol",tiles:6,weight:1.5}),N({kind:"distanceBelow",state:"inspectNoise",tiles:4,weight:1.2})],ri=(e,t)=>({id:e,initialState:"patrol",baseWeights:{idle:.5,patrol:3,chase:1,search:1,attack:.5,inspectNoise:.5,flee:.2,panic:.1},cooldowns:{panic:12e3,flee:8e3,inspectNoise:2e3},minimumSelectableWeight:.05,...t}),Mi={[ot]:{id:ot,label:"CorpSec Sentinel",description:"Baseline guard tuned for perimeter patrols; favours holding ground until line of sight is confirmed.",fsm:ri(ot,{baseWeights:{idle:.6,patrol:3.5,chase:.3,search:.9,attack:.9,inspectNoise:.6,flee:.4,panic:.2},utilityModifiers:Ho})},"corpsec-enforcer":{id:"corpsec-enforcer",label:"CorpSec Enforcer",description:"Aggressive shock troops that lean into panic suppression and rapid response.",fsm:ri("corpsec-enforcer",{initialState:"patrol",baseWeights:{idle:.2,patrol:2.5,chase:1.5,search:.6,attack:1.2,inspectNoise:.4,flee:.2,panic:.4},utilityModifiers:Wo,cooldowns:{panic:1e4,flee:6e3,inspectNoise:1500}})},"corpsec-watchman":{id:"corpsec-watchman",label:"CorpSec Watchman",description:"Cautious sentry who prioritises searching and calling in reinforcements.",fsm:ri("corpsec-watchman",{baseWeights:{idle:1,patrol:2.5,chase:.6,search:1.4,attack:.5,inspectNoise:.8,flee:.5,panic:.2},utilityModifiers:qo,cooldowns:{panic:12e3,flee:9e3,inspectNoise:2500}})}},Vo=e=>Mi[e],Fs={zoneId:"unknown_zone",name:"Unknown Sector",level:0,danger:"low",hazards:[],objectives:[],summary:"No reconnaissance available for this zone."},Bs={downtown_checkpoint:{zoneId:"downtown_checkpoint",name:"Slums Command Grid",level:0,danger:"moderate",hazards:["CorpSec curfew sweeps after sundown","Autonomous patrol drones scanning alleys","Tight choke points with improvised barricades"],objectives:["Recover Lira's contraband cache from the downtown evidence lockers.","Decrypt the surveillance manifests Archivist Naila smuggled out.","Re-establish Brant's courier drop routes across the grid before curfew.","Black out the CorpSec camera grid guarding the barricades.","Map patrol drone loops and assign safe counter-routes.","Restock Medic Yara's rebel clinic with field medkits.","Ambush the transit patrol escorting the sweep captain."],summary:"Primary resistance staging ground on the edge of Downtown. Expect constant patrol loops and rapid curfew escalations once alarms trip."},gov_complex:{zoneId:"gov_complex",name:"Downtown Governance Ring",level:1,danger:"high",hazards:["Omnidirectional camera grids with rapid resync pulses","CorpSec riot squads supported by shield drones","Encrypted checkpoints requiring forged credentials"],objectives:["Breaching the executive archives for blackmail dossiers","Subverting curfew order terminals","Exfiltrating detained resistance couriers"],summary:"Corporate command nerve centre governing the city core. Security density spikes during curfew and when alert level rises above Suspicious."},corporate_plaza:{zoneId:"corporate_plaza",name:"Skyline Transit Spire",level:1,danger:"moderate",hazards:["Precision sniper nests covering rooftop routes","Kinetic response teams dispatched via mag-rails","Marketing holo projectors causing navigation glare"],objectives:["Sabotage skyline transit relays to halt corporate reinforcements","Secure encrypted comm relays for resistance broadcasts","Extract high-value defectors under corporate escort"],summary:"Vertical plaza bridging transit hubs and corporate towers. Movement is exposed but offers vantage points if you neutralise overwatch nests."},industrial_corridor:{zoneId:"industrial_corridor",name:"Industrial Wasteland",level:2,danger:"critical",hazards:["Toxic smog plumes reducing visibility and draining health","Open radiation pockets around collapsed reactors","Unstable power conduits causing electrical surges","Hostile scavenger clans with improvised explosives"],objectives:["Stabilise the resistance refinery outpost","Disrupt CorpSec convoy routes feeding the upper city","Recover prototype filtration tech before corp retrieval teams arrive"],summary:"Decommissioned industrial belt now weaponised by corp security. Navigation requires filtration gear and constant hazard monitoring."},resistance_safehouse:{zoneId:"resistance_safehouse",name:"Resistance Safehouse Network",level:0,danger:"low",hazards:["Tight corridors with limited firing lanes"],objectives:["Resupply from hidden caches","Brief with cell leadership for mission intel","Coordinate evac routes ahead of major operations"],summary:"Hidden safehouse offering respite between sorties. Minimal patrol risk but expect limited mobility and quick extraction drills."}},Go=e=>e.includes("::")?e.split("::")[0]??e:e,$n=e=>{if(!e)return Fs;const t=Bs[e];if(t)return t;const i=Bs[Go(e)];return i||{...Fs,zoneId:e}},zo={performance:{maxDecorPropsPerBuilding:2,maxAmbientGlows:12,enableAnimatedHazards:!1,enableHighDensityLabels:!1,maxFogBands:2,maxEmissiveZones:6,wetReflectionAlpha:.08,occlusionFadeFloor:.56},balanced:{maxDecorPropsPerBuilding:4,maxAmbientGlows:24,enableAnimatedHazards:!0,enableHighDensityLabels:!0,maxFogBands:4,maxEmissiveZones:10,wetReflectionAlpha:.14,occlusionFadeFloor:.48},cinematic:{maxDecorPropsPerBuilding:6,maxAmbientGlows:36,enableAnimatedHazards:!0,enableHighDensityLabels:!0,maxFogBands:6,maxEmissiveZones:14,wetReflectionAlpha:.2,occlusionFadeFloor:.38}},Os=(e,t,i,s,n,a,r,o,l,c,d,u,h,g)=>({district:e,signageStyle:t,propDensity:i,facadePattern:s,lotPattern:n,massingStyle:a,massingHeight:r,accentHex:o,glowHex:l,trimHex:c,atmosphereHex:d,signagePrimaryHex:u,signageSecondaryHex:h,backdropHex:g}),Yn={downtown:Os("downtown","corp_holo","medium","ribbed","plaza","block",1.8,"#38bdf8","#67e8f9","#b6f7ff","#081126","#9beafe","#67e8f9","#0d1b2a"),slums:Os("slums","slums_neon","medium","banded","market","stacked",1,"#f97316","#fb923c","#ffd08d","#170c09","#6ff2ff","#9c8cff","#0b1220")},Uo={player:{role:"player",baseColor:988970,outlineColor:6333946,primaryColor:3900150,accentColor:6809849,glowColor:3718648,columnHeight:1.65,widthScale:.78,heightScale:.5,depthOffset:12},friendlyNpc:{role:"friendlyNpc",baseColor:1713208,outlineColor:2282478,primaryColor:959977,accentColor:6809849,glowColor:2282478,columnHeight:1.35,widthScale:.74,heightScale:.48,depthOffset:9},hostileNpc:{role:"hostileNpc",baseColor:2758171,outlineColor:15680580,primaryColor:14427686,accentColor:16347926,glowColor:16478597,columnHeight:1.4,widthScale:.75,heightScale:.49,depthOffset:9},interactiveNpc:{role:"interactiveNpc",baseColor:1057336,outlineColor:10980346,primaryColor:9133302,accentColor:2282478,glowColor:12616956,columnHeight:1.45,widthScale:.77,heightScale:.5,depthOffset:10}},es=e=>({id:"noir-vector-v1",preset:e,qualityBudget:zo[e],tilePalettes:{floorEven:1317418,floorOdd:1844280,wallEven:3096416,wallOdd:2569554,coverEven:2640722,coverOdd:2244423,waterEven:1066081,waterOdd:997200,trapEven:5644612,trapOdd:4528694,doorEven:3093058,doorOdd:2369333},districtDefaults:Yn,entityProfiles:Uo}),Ft=(e,t,i)=>{const n=Yn[e==="downtown"?"downtown":"slums"],a=t??n.signageStyle,r=i??n.propDensity;return a==="corp_brass"?{...n,signageStyle:a,propDensity:r,facadePattern:"chevron",lotPattern:"plaza",massingStyle:"block",massingHeight:2,accentHex:"#f3ca75",glowHex:"#fbbf24",trimHex:"#ffe4a3",atmosphereHex:"#1a140a",signagePrimaryHex:"#f3ca75",signageSecondaryHex:"#f9e2af",backdropHex:"#1a140a"}:a==="slums_scrap"?{...n,signageStyle:a,propDensity:r,facadePattern:"solid",lotPattern:"service",massingStyle:"block",massingHeight:.95,accentHex:"#f97316",glowHex:"#fb923c",trimHex:"#ffd299",atmosphereHex:"#190f08",signagePrimaryHex:"#f97316",signageSecondaryHex:"#fb923c",backdropHex:"#190f08"}:{...n,signageStyle:a,propDensity:r}},Ns=["solid","ribbed","banded","chevron"],Ko=["ribbed","chevron"],jo=["solid","banded"],$o=["plaza","service"],Yo=["market","service"],Zo=["block"],Xo=["stacked","block"],Qo=e=>{let t=0;for(let i=0;i<e.length;i+=1)t=t*31+e.charCodeAt(i)>>>0;return t},oi=e=>Math.max(0,Math.min(255,Math.round(e))),Pt=(e,t)=>{const i=e.startsWith("#")?e.slice(1):e;if(i.length!==6)return e;const s=parseInt(i.slice(0,2),16),n=parseInt(i.slice(2,4),16),a=parseInt(i.slice(4,6),16),r=t*255;return`#${[oi(s+r),oi(n+r),oi(a+r)].map(l=>l.toString(16).padStart(2,"0")).join("")}`},Jo=e=>{const t={};return e.forEach(i=>{const s=Ft(i.district,i.signageStyle,i.propDensity),n=Qo(`${i.id}:${i.name}`),a=i.district==="downtown"?"downtown":"slums",r=a==="downtown"?Ko:jo,o=a==="downtown"?$o:Yo,l=a==="downtown"?Zo:Xo,c=r[n%r.length]??Ns[n%Ns.length],d=o[(n>>1)%o.length]??s.lotPattern,u=l[(n>>2)%l.length]??s.massingStyle,h=a==="downtown"?1.45:1,g=(n%7-3)*.09,p=Math.max(.85,h+g),m=a==="downtown"?(n%5-2)*.05:(n%7-3)*.06;t[i.id]={...s,facadePattern:c,lotPattern:d,massingStyle:u,massingHeight:p,accentHex:Pt(s.accentHex,m),glowHex:Pt(s.glowHex,m*.7),trimHex:Pt(s.trimHex,m*.45),atmosphereHex:Pt(s.atmosphereHex,m*.28)}}),{profilesByBuildingId:t}},el=96,tl=72,il=e=>e>=24&&e<=26||e>=60&&e<=62,sl=e=>e>=20&&e<=21||e>=44&&e<=45,nl=(e,t)=>il(e)||sl(t),al=(e,t)=>t.some(i=>{const{from:s,to:n}=i.footprint;return e.x>=s.x&&e.x<=n.x&&e.y>=s.y&&e.y<=n.y}),rl=(e,t,i,s)=>{const n=Bn(e,t,i,{level:s.level,isInterior:!0,zoneId:s.zoneId,factionRequirement:s.factionRequirement,displayName:s.displayName,summary:s.summary,dangerRating:s.dangerRating,hazards:s.hazards}),a={x:Math.floor(t/2),y:i-1},r={x:a.x,y:Math.max(1,a.y-1)},o=n.tiles[a.y][a.x];return o.type=R.DOOR,o.isWalkable=!0,{area:n,entryPosition:r,doorPosition:a}},ol=(e,t,i)=>{const s=[],n=[];return i.forEach(a=>{var d,u;const{from:r,to:o}=a.footprint;for(let h=r.y;h<=o.y;h++)for(let g=r.x;g<=o.x;g++){const p=(d=e.tiles[h])==null?void 0:d[g];p&&p.type===R.DOOR&&(p.type=R.WALL,p.isWalkable=!1)}const l=(u=e.tiles[a.door.y])==null?void 0:u[a.door.x];if(!l)return;l.type=R.DOOR,l.isWalkable=!0;const c=rl(`${t} :: ${a.name}`,a.interior.width,a.interior.height,{level:e.level??0,zoneId:`${e.zoneId}::interior`,factionRequirement:a.factionRequirement,displayName:`${t} :: ${a.name}`,summary:e.summary,dangerRating:e.dangerRating,hazards:e.hazards});n.push(c.area),s.push({fromAreaId:e.id,fromPosition:{...a.door},toAreaId:c.area.id,toPosition:{...c.entryPosition}}),s.push({fromAreaId:c.area.id,fromPosition:{...c.doorPosition},toAreaId:e.id,toPosition:{...a.door}})}),{connections:s,interiors:n}},ll=e=>e,cl=(e,t,i,s,n,a,r)=>{const o=Bn(e,el,tl,{level:0,objectives:i,zoneId:t}),l=$n(t),c={...o,name:l.name,displayName:l.name,level:l.level,objectives:l.objectives.length?l.objectives:o.objectives,dangerRating:l.danger,hazards:l.hazards,summary:l.summary},d=[],u=(w,C,F,q)=>{for(let ge=C;ge<=q;ge++)for(let xe=w;xe<=F;xe++)nl(xe,ge)||d.push({x:xe,y:ge})};s.forEach(w=>{u(w.footprint.from.x,w.footprint.from.y,w.footprint.to.x,w.footprint.to.y)});const h=gr(c,d),p=n.map(w=>w.position).filter(w=>{var F;const C=(F=h.tiles[w.y])==null?void 0:F[w.x];return C?C.isWalkable:!1}),m=fr(h,p),f=new Set(p.map(w=>`${w.x}:${w.y}`)),b=n.reduce((w,C)=>{if(!C.profile)return w;const F=`${C.position.x}:${C.position.y}`;return f.has(F)?yr(w,C.position,C.profile):w},m),S=ll(b),M=Jo(s),v=s.map(w=>({id:w.id,name:w.name,signageStyle:w.signageStyle,district:w.district,propDensity:w.propDensity,encounterProfile:w.encounterProfile,workbench:w.workbench,footprint:{from:{...w.footprint.from},to:{...w.footprint.to}},door:{...w.door},visualProfile:M.profilesByBuildingId[w.id]?{facadePattern:M.profilesByBuildingId[w.id].facadePattern,lotPattern:M.profilesByBuildingId[w.id].lotPattern,massingStyle:M.profilesByBuildingId[w.id].massingStyle,massingHeight:M.profilesByBuildingId[w.id].massingHeight,accentHex:M.profilesByBuildingId[w.id].accentHex,glowHex:M.profilesByBuildingId[w.id].glowHex,trimHex:M.profilesByBuildingId[w.id].trimHex,atmosphereHex:M.profilesByBuildingId[w.id].atmosphereHex,signagePrimaryHex:M.profilesByBuildingId[w.id].signagePrimaryHex,signageSecondaryHex:M.profilesByBuildingId[w.id].signageSecondaryHex,backdropHex:M.profilesByBuildingId[w.id].backdropHex}:void 0}));S.buildings=v;const A=w=>{var F;const C=(F=S.tiles[w.y])==null?void 0:F[w.x];return!C||!C.isWalkable||C.type===R.DOOR||C.type===R.WALL?!1:!al(w,s)},I=w=>{const C=ji(w,S)??w;return A(C)?C:On(C,S).find(ge=>A(ge))??null};a.forEach(w=>{const C=I(w.position);C&&S.entities.npcs.push({...w,id:se(),position:C})});const x=p.length?p:[{x:32,y:74},{x:84,y:28},{x:54,y:64}];r.forEach((w,C)=>{const F=x[C%x.length],q=I(F)??F;S.entities.items.push({...w,id:se(),position:q})});const{connections:T,interiors:O}=ol(S,e,s);return O.forEach(w=>{w.level=w.level??0,w.objectives=w.objectives??[]}),{area:S,connections:T,interiorAreas:O}},dl=({locale:e})=>{const t=$t(e),i=cl(t.world.areaName,t.world.zoneId,t.world.objectives,t.buildingDefinitions,t.coverSpots.all,t.npcBlueprints,t.itemBlueprints),s=i.area,a=[...i.interiorAreas].reduce((r,o)=>(r[o.id]=o,r),{[s.id]:s});return{slumsArea:s,mapAreas:a,connections:[...i.connections]}},H={cycleDuration:300,timeMultiplier:1,morningStartTime:0,dayStartTime:.1,eveningStartTime:.4,dayEndTime:.5},Ve=(e,t=H)=>{const i=e%t.cycleDuration/t.cycleDuration;return i>=t.morningStartTime&&i<t.dayStartTime?"morning":i>=t.dayStartTime&&i<t.eveningStartTime?"day":i>=t.eveningStartTime&&i<t.dayEndTime?"evening":"night"},ul=(e,t=H)=>{const i=e%t.cycleDuration/t.cycleDuration;return i>=t.morningStartTime&&i<t.dayStartTime?.4+(i-t.morningStartTime)/(t.dayStartTime-t.morningStartTime)*.6:i>=t.dayStartTime&&i<t.eveningStartTime?1:i>=t.eveningStartTime&&i<t.dayEndTime?1-(i-t.eveningStartTime)/(t.dayEndTime-t.eveningStartTime)*.6:.2},hl=(e,t=H)=>{const i=Ve(e,t),s=ul(e,t);switch(i){case"morning":return`rgba(180, 208, 255, ${(1-s)*.22})`;case"day":return"rgba(255, 255, 255, 0)";case"evening":return`rgba(214, 179, 255, ${(1-s)*.28})`;case"night":return`rgba(18, 30, 64, ${.72*(1-s)})`;default:return"rgba(0, 0, 0, 0)"}},ct=(e,t=H)=>Ve(e,t)==="night";var li={};const pl=()=>{},ml=()=>typeof process<"u"?"production":"development",gl=()=>[typeof process<"u"?li==null?void 0:li.ENABLE_VERBOSE_LOGS:void 0,typeof globalThis<"u"?globalThis.__ENABLE_VERBOSE_LOGS:void 0].some(t=>typeof t=="string"?t.toLowerCase()==="true":t===!0),fl=!gl()&&ml()==="test",yl=e=>{const t=console[e]??console.log;return typeof t=="function"?t.bind(console):console.log.bind(console)},Mt=(e,t)=>{const i=yl(e);return fl&&(e==="debug"||e==="info")?pl:(...s)=>{i(`[${t}]`,...s)}},ts=e=>({debug:Mt("debug",e),info:Mt("info",e),warn:Mt("warn",e),error:Mt("error",e)});ts("app");const ce=ts("worldSlice"),Sl=()=>({flags:{gangHeat:"low",curfewLevel:0,supplyScarcity:"norm",blackoutTier:"none"},weather:{presetId:null,rainIntensity:0,thunderActive:!1,sirenLoop:!1,updatedAt:0,timeOfDay:null},signage:{},rumorSets:{},notes:[]}),vl=(e,t)=>(e.buildings??[]).some(i=>{const{from:s,to:n}=i.footprint;return t.x>=s.x&&t.x<=n.x&&t.y>=s.y&&t.y<=n.y}),bl=e=>({id:se(),name:e,position:{x:34,y:24},facing:"west",coverOrientation:null,suppression:0,maxHealth:45,health:45,actionPoints:4,maxActionPoints:4,damage:7,attackRange:2,isHostile:!0,visionCone:{range:10,angle:90,direction:180},alertLevel:L.IDLE,alertProgress:0,lastKnownPlayerPosition:null,aiProfileId:ot,aiState:"patrol",aiLastTransitionAt:0,aiCooldowns:{}}),im=Math.floor(H.dayEndTime*H.cycleDuration),wl=Math.floor(H.dayStartTime*H.cycleDuration),Zn=Math.floor((H.dayStartTime+H.eveningStartTime)/2*H.cycleDuration),Xn=e=>{const t=dl({locale:e}),i=$t(e),s=t.slumsArea,n=bl(i.world.initialEnemyName),a=ji(n.position,s);a&&(n.position=a),s.entities.enemies.push(n),ce.debug("Initial map generated with enemy:",n);const r=Zn;return{currentMapArea:s,mapAreas:t.mapAreas,mapConnections:t.connections,currentTime:r,timeOfDay:Ve(r,H),curfewActive:ct(r,H),inCombat:!1,isPlayerTurn:!0,turnCount:1,globalAlertLevel:L.IDLE,reinforcementsScheduled:!1,environment:Sl(),engagementMode:"none",workbenchAvailable:!1,workbenchStatus:{available:!1,note:"No workbench nearby"}}},Pl=Xn(Ie),Qn=Q({name:"world",initialState:Pl,reducers:{setEnvironmentFlags:(e,t)=>{e.environment.flags={...e.environment.flags,...t.payload}},setWorkbenchAvailable:(e,t)=>{e.workbenchAvailable=t.payload,e.workbenchStatus={available:t.payload,note:t.payload?void 0:"No workbench nearby"}},setWorkbenchStatus:(e,t)=>{e.workbenchStatus={...t.payload},e.workbenchAvailable=t.payload.available},applyEnvironmentWeather:(e,t)=>{e.environment.weather={...t.payload}},applyEnvironmentSignage:(e,t)=>{const{signId:i,snapshot:s}=t.payload;e.environment.signage={...e.environment.signage,[i]:{...s}}},removeEnvironmentSignage:(e,t)=>{const i={...e.environment.signage};delete i[t.payload],e.environment.signage=i},applyEnvironmentRumorSet:(e,t)=>{const{groupId:i,snapshot:s}=t.payload;e.environment.rumorSets={...e.environment.rumorSets,[i]:{...s}}},removeEnvironmentRumorSet:(e,t)=>{const i={...e.environment.rumorSets};delete i[t.payload],e.environment.rumorSets=i},registerEnvironmentalNote:(e,t)=>{const i=t.payload,s=e.environment.notes.findIndex(n=>n.instanceId===i.instanceId);s>=0?e.environment.notes[s]={...i}:e.environment.notes.push({...i})},clearEnvironmentalNotesForArea:(e,t)=>{const i=t.payload;e.environment.notes=e.environment.notes.filter(s=>s.areaId!==i)},setNpcAmbientProfile:(e,t)=>{const{profile:i,match:s}=t.payload,{dialogueId:n,name:a}=s,r=o=>{let l=!1;const c=o.map(d=>{const u=n?d.dialogueId===n:!1,h=a?d.name===a:!1;return!u&&!h?d:(l=!0,{...d,ambientProfile:i?{...i}:void 0})});return l?c:o};e.currentMapArea.entities.npcs=r(e.currentMapArea.entities.npcs),Object.values(e.mapAreas).forEach(o=>{o.entities.npcs=r(o.entities.npcs)})},setMapArea:(e,t)=>{e.currentMapArea=t.payload,e.inCombat=!1,e.isPlayerTurn=!0,e.turnCount=1,e.engagementMode="none",e.workbenchAvailable=!1,e.workbenchStatus={available:!1,note:"No workbench nearby"}},setCurrentMapAreaZoneMetadata:(e,t)=>{const i=$n(t.payload.zoneId),s=e.currentMapArea;s.zoneId=i.zoneId,s.name=i.name,s.displayName=i.name,s.level=i.level,s.summary=i.summary,s.dangerRating=i.danger,s.hazards=[...i.hazards],s.objectives=[...i.objectives],e.workbenchAvailable=!1,e.workbenchStatus={available:!1,note:"No workbench nearby"};const n=e.mapAreas[s.id];n&&(n.zoneId=s.zoneId,n.name=s.name,n.displayName=s.displayName,n.level=s.level,n.summary=s.summary,n.dangerRating=s.dangerRating,n.hazards=[...s.hazards],n.objectives=[...s.objectives])},updateGameTime:(e,t)=>{e.currentTime+=t.payload,e.timeOfDay=Ve(e.currentTime,H),e.curfewActive=ct(e.currentTime,H),e.curfewActive?e.environment.flags.curfewLevel=e.reinforcementsScheduled?3:2:e.environment.flags.curfewLevel=0,e.environment.flags.blackoutTier!=="rolling"&&(e.environment.flags.blackoutTier=e.curfewActive?"brownout":"none")},setGameTime:(e,t)=>{e.currentTime=t.payload,e.timeOfDay=Ve(e.currentTime,H),e.curfewActive=ct(e.currentTime,H),e.curfewActive?e.environment.flags.curfewLevel=e.reinforcementsScheduled?3:2:e.environment.flags.curfewLevel=0,e.environment.flags.blackoutTier!=="rolling"&&(e.environment.flags.blackoutTier=e.curfewActive?"brownout":"none")},enterCombat:e=>{if(!e.inCombat){if(e.currentMapArea.entities.enemies.filter(i=>i.health>0).length===0){ce.debug("Cannot enter combat: no living enemies");return}ce.debug("Entering Combat Mode"),e.inCombat=!0,e.isPlayerTurn=!0,e.turnCount=1,e.engagementMode="combat"}},exitCombat:e=>{e.inCombat&&(ce.debug("Exiting Combat Mode"),e.inCombat=!1,e.isPlayerTurn=!0,e.turnCount=1,e.engagementMode="none")},setEngagementMode:(e,t)=>{e.engagementMode=t.payload},switchTurn:e=>{e.inCombat&&(e.isPlayerTurn=!e.isPlayerTurn,e.isPlayerTurn?(e.turnCount++,ce.debug(`switchTurn: Starting Player Turn ${e.turnCount}`)):(ce.debug(`switchTurn: Starting Enemy Turn (during Player Turn ${e.turnCount})`),ce.debug("switchTurn: Resetting AP for all living enemies"),e.currentMapArea.entities.enemies.forEach((t,i)=>{t.health>0&&(e.currentMapArea.entities.enemies[i].actionPoints=t.maxActionPoints)})))},updateEnemy:(e,t)=>{const i=t.payload,s=a=>{const r=a.entities.enemies.findIndex(o=>o.id===i.id);return r===-1?!1:(i.health<=0?a.entities.enemies.splice(r,1):a.entities.enemies[r]=i,a.entities.enemies=[...a.entities.enemies],!0)};ce.debug("updateEnemy reducer running",{enemyId:i.id,health:i.health});const n=s(e.currentMapArea);Object.values(e.mapAreas).forEach(a=>{const r=s(a);!n&&r&&a.id===e.currentMapArea.id&&(e.currentMapArea.entities.enemies=[...e.currentMapArea.entities.enemies])}),i.health<=0&&(ce.debug(`updateEnemy: Enemy ${i.id} removed from all areas.`),e.currentMapArea.entities.enemies.filter(r=>r.health>0).length===0&&(ce.debug("updateEnemy: No living enemies remain. Clearing combat state."),e.inCombat=!1,e.isPlayerTurn=!0,e.turnCount=1))},addEnemy:(e,t)=>{const i={...t.payload};let s=ji(i.position,e.currentMapArea);s||(s=On(i.position,e.currentMapArea,void 0,[]).find(r=>e.currentMapArea.entities.enemies.every(o=>o.position.x!==r.x||o.position.y!==r.y))??i.position),i.position=s,e.currentMapArea.entities.enemies.push(i),e.currentMapArea.entities.enemies=[...e.currentMapArea.entities.enemies]},removeEnemy:(e,t)=>{const i=t.payload;e.currentMapArea.entities.enemies=e.currentMapArea.entities.enemies.filter(s=>s.id!==i),e.currentMapArea.entities.enemies=[...e.currentMapArea.entities.enemies]},updateNPC:(e,t)=>{const i=t.payload,s=e.currentMapArea.entities.npcs.findIndex(n=>n.id===i.id);s!==-1&&(e.currentMapArea.entities.npcs[s]=i,e.currentMapArea.entities.npcs=[...e.currentMapArea.entities.npcs])},addNPC:(e,t)=>{e.currentMapArea.entities.npcs.push(t.payload),e.currentMapArea.entities.npcs=[...e.currentMapArea.entities.npcs]},removeNPC:(e,t)=>{const i=t.payload;e.currentMapArea.entities.npcs=e.currentMapArea.entities.npcs.filter(s=>s.id!==i),e.currentMapArea.entities.npcs=[...e.currentMapArea.entities.npcs]},addItemToMap:(e,t)=>{var r;const{item:i,position:s}=t.payload,n=(r=e.currentMapArea.tiles[s.y])==null?void 0:r[s.x];if(!n||!n.isWalkable||n.type===R.DOOR||n.type===R.WALL||vl(e.currentMapArea,s))return;const a={...i,position:s};e.currentMapArea.entities.items.push(a)},removeItemFromMap:(e,t)=>{const i=t.payload;e.currentMapArea.entities.items=e.currentMapArea.entities.items.filter(s=>s.id!==i)},removeItemInstanceFromMap:(e,t)=>{const{id:i,position:s,name:n}=t.payload,a=e.currentMapArea.entities.items,r=a.filter(o=>{var d,u;const l=!!(i&&o.id===i),c=!!(s&&((d=o.position)==null?void 0:d.x)===s.x&&((u=o.position)==null?void 0:u.y)===s.y&&(!n||o.name===n));return!(l||c)});r.length!==a.length&&(e.currentMapArea.entities.items=r)},applyLocaleToWorld:(e,t)=>Xn(t.payload),setGlobalAlertLevel:(e,t)=>{e.globalAlertLevel=t.payload;const i=t.payload===L.ALARMED?"high":t.payload===L.IDLE?"low":"med",s=t.payload===L.ALARMED?"rationed":t.payload===L.IDLE?"norm":"tight";e.environment.flags.gangHeat=i,e.environment.flags.supplyScarcity=s,t.payload===L.ALARMED?(e.environment.flags.blackoutTier="rolling",e.environment.flags.curfewLevel=Math.max(e.environment.flags.curfewLevel,3)):e.environment.flags.blackoutTier==="rolling"&&(e.environment.flags.blackoutTier=e.curfewActive?"brownout":"none",e.environment.flags.curfewLevel=e.curfewActive?2:0)},scheduleReinforcements:e=>{e.reinforcementsScheduled=!0,e.environment.flags.curfewLevel=3,e.globalAlertLevel===L.ALARMED&&(e.environment.flags.blackoutTier="rolling")},clearReinforcementsSchedule:e=>{e.reinforcementsScheduled=!1,e.environment.flags.curfewLevel=e.curfewActive?2:0,e.environment.flags.blackoutTier!=="rolling"&&(e.environment.flags.blackoutTier=e.curfewActive?"brownout":"none")}}}),{setEnvironmentFlags:sm,applyEnvironmentWeather:nm,applyEnvironmentSignage:am,removeEnvironmentSignage:rm,applyEnvironmentRumorSet:om,removeEnvironmentRumorSet:lm,registerEnvironmentalNote:cm,clearEnvironmentalNotesForArea:dm,setNpcAmbientProfile:um,setMapArea:hm,setCurrentMapAreaZoneMetadata:pm,updateGameTime:Jn,setGameTime:Ml,enterCombat:mm,exitCombat:gm,switchTurn:At,updateEnemy:Al,addEnemy:fm,removeEnemy:ym,updateNPC:Sm,addNPC:vm,removeNPC:bm,addItemToMap:wm,removeItemFromMap:Pm,removeItemInstanceFromMap:Mm,applyLocaleToWorld:Il,setGlobalAlertLevel:Am,scheduleReinforcements:Im,clearReinforcementsSchedule:xm,setEngagementMode:Cm,setWorkbenchAvailable:km,setWorkbenchStatus:Tm}=Qn.actions,ea=Qn.reducer,Ai=e=>{const t=$t(e);return{quests:t.quests,dialogues:t.dialogues,activeDialogue:{dialogueId:null,currentNodeId:null},lastBriefing:{dialogueId:null,nodeId:null}}},xl=Ai(Ie),ta=Q({name:"quests",initialState:xl,reducers:{addQuest:(e,t)=>{e.quests.push(t.payload)},updateQuest:(e,t)=>{const i=t.payload,s=e.quests.findIndex(n=>n.id===i.id);s!==-1&&(e.quests[s]=i)},startQuest:(e,t)=>{const i=t.payload,s=e.quests.find(n=>n.id===i);s&&!s.isActive&&!s.isCompleted&&(s.isActive=!0)},completeQuest:(e,t)=>{const i=t.payload,s=e.quests.find(n=>n.id===i);s&&s.isActive&&(s.isActive=!1,s.isCompleted=!0)},updateObjectiveStatus:(e,t)=>{const{questId:i,objectiveId:s,isCompleted:n}=t.payload,a=e.quests.find(r=>r.id===i);if(a){const r=a.objectives.find(o=>o.id===s);r&&(r.isCompleted=n)}},updateObjectiveCounter:(e,t)=>{const{questId:i,objectiveId:s,count:n}=t.payload,a=e.quests.find(r=>r.id===i);if(a){const r=a.objectives.find(o=>o.id===s);if(r&&(r.type==="collect"||r.type==="kill")){const o=r.count||1,l=(r.currentCount||0)+n;r.currentCount=Math.min(l,o),r.currentCount>=o&&(r.isCompleted=!0)}}},addDialogue:(e,t)=>{e.dialogues.push(t.payload)},startDialogue:(e,t)=>{const{dialogueId:i,nodeId:s}=t.payload;e.activeDialogue={dialogueId:i,currentNodeId:s},e.lastBriefing={dialogueId:i,nodeId:s}},setDialogueNode:(e,t)=>{e.activeDialogue.currentNodeId=t.payload,t.payload&&(e.lastBriefing={dialogueId:e.activeDialogue.dialogueId,nodeId:t.payload})},endDialogue:e=>{e.activeDialogue={dialogueId:null,currentNodeId:null}},resetQuests:(e,t)=>Ai(t.payload??Ie),applyLocaleToQuests:(e,t)=>Ai(t.payload)}}),{addQuest:Rm,updateQuest:Em,startQuest:_m,completeQuest:Dm,updateObjectiveStatus:Lm,updateObjectiveCounter:Fm,addDialogue:Bm,startDialogue:Om,setDialogueNode:Nm,endDialogue:Hm,resetQuests:Wm,applyLocaleToQuests:Cl}=ta.actions,kl=ta.reducer,Tl={id:"level0_recover_cache",resourceKey:"missions.level0.recover_cache",levelKey:"levels.slums_command_grid",kind:"primary",questKeys:["quests.market_cache"],relatedNpcKeys:["npcs.lira_smuggler"],generatedSceneKeys:["scenes.level0.recover_cache.ambush_route"]},Rl={id:"level0_decrypt_manifests",resourceKey:"missions.level0.decrypt_manifests",levelKey:"levels.slums_command_grid",kind:"primary",questKeys:["quests.datapad_truth"],relatedNpcKeys:["npcs.archivist_naila"]},El={id:"level0_rebuild_courier_network",resourceKey:"missions.level0.rebuild_courier_network",levelKey:"levels.slums_command_grid",kind:"primary",questKeys:["quests.courier_network"],relatedNpcKeys:["npcs.courier_brant"]},_l={id:"level0_blackout_camera_grid",resourceKey:"missions.level0.blackout_camera_grid",levelKey:"levels.slums_command_grid",kind:"side",questKeys:["quests.equipment_sabotage"],factionTag:"resistance",relatedNpcKeys:["npcs.firebrand_juno"]},Dl={id:"level0_map_drone_patrols",resourceKey:"missions.level0.map_drone_patrols",levelKey:"levels.slums_command_grid",kind:"side",questKeys:["quests.drone_recon"],relatedNpcKeys:["npcs.drone_handler_kesh"]},Ll={id:"level0_restock_rebel_clinic",resourceKey:"missions.level0.restock_rebel_clinic",levelKey:"levels.slums_command_grid",kind:"side",questKeys:["quests.medkit_supplies"],relatedNpcKeys:["npcs.medic_yara"]},Fl={id:"level0_clear_transit_patrol",resourceKey:"missions.level0.clear_transit_patrol",levelKey:"levels.slums_command_grid",kind:"side",questKeys:["quests.combat_patrol"],relatedNpcKeys:["npcs.captain_reyna"]},Bl={id:"level1_seize_governance_archives",resourceKey:"missions.level1.seize_governance_archives",levelKey:"levels.downtown_governance_ring",kind:"primary",questKeys:["quests.government_archives"],relatedNpcKeys:[]},Ol={id:"level1_override_curfew_terminals",resourceKey:"missions.level1.override_curfew_terminals",levelKey:"levels.downtown_governance_ring",kind:"primary",questKeys:["quests.curfew_override"],relatedNpcKeys:[]},Nl={id:"level1_extract_detained_couriers",resourceKey:"missions.level1.extract_detained_couriers",levelKey:"levels.downtown_governance_ring",kind:"primary",questKeys:["quests.prison_break"],relatedNpcKeys:[]},Hl={id:"level1_hijack_camera_resync",resourceKey:"missions.level1.hijack_camera_resync",levelKey:"levels.downtown_governance_ring",kind:"side",questKeys:["quests.camera_resync"],relatedNpcKeys:[]},Wl={id:"level1_divert_supply_convoys",resourceKey:"missions.level1.divert_supply_convoys",levelKey:"levels.downtown_governance_ring",kind:"side",questKeys:["quests.supply_diversion"],relatedNpcKeys:[]},ql={id:"level1_broadcast_resistance_propaganda",resourceKey:"missions.level1.broadcast_resistance_propaganda",levelKey:"levels.downtown_governance_ring",kind:"side",questKeys:["quests.plaza_broadcast"],relatedNpcKeys:[]},Vl={id:"level2_stabilise_refinery_outpost",resourceKey:"missions.level2.stabilise_refinery_outpost",levelKey:"levels.industrial_wasteland",kind:"primary",questKeys:["quests.refinery_stabilization"],relatedNpcKeys:[]},Gl={id:"level2_cripple_convoy_routes",resourceKey:"missions.level2.cripple_convoy_routes",levelKey:"levels.industrial_wasteland",kind:"primary",questKeys:["quests.convoy_ambush"],relatedNpcKeys:[]},zl={id:"level2_recover_filtration_core",resourceKey:"missions.level2.recover_filtration_core",levelKey:"levels.industrial_wasteland",kind:"primary",questKeys:["quests.filtration_recovery"],relatedNpcKeys:[]},Ul={id:"level2_broker_scavenger_truce",resourceKey:"missions.level2.broker_scavenger_truce",levelKey:"levels.industrial_wasteland",kind:"side",questKeys:["quests.scavenger_truce"],factionTag:"scavengers",relatedNpcKeys:[]},Kl={id:"level2_stabilise_power_grid",resourceKey:"missions.level2.stabilise_power_grid",levelKey:"levels.industrial_wasteland",kind:"side",questKeys:["quests.power_grid"],relatedNpcKeys:[]},jl={id:"level2_secure_evacuation_lanes",resourceKey:"missions.level2.secure_evacuation_lanes",levelKey:"levels.industrial_wasteland",kind:"side",questKeys:["quests.industrial_evac"],relatedNpcKeys:[]},$l=[Tl,Rl,El,_l,Dl,Ll,Fl,Bl,Ol,Nl,Hl,Wl,ql,Vl,Gl,zl,Ul,Kl,jl],Yl=$l.reduce((e,t)=>(e[t.resourceKey]=t,e),{}),Zl=e=>{const t=Yl[e];if(!t)throw new Error(`Unknown mission resource key: ${e}`);return t},Xl=(e,t)=>{const i=t.missions[e.resourceKey];if(!i)throw new Error(`Missing locale entry for mission ${e.resourceKey}`);const s=e.questKeys.map(n=>{const a=Xa[n];if(!a)throw new Error(`Mission ${e.resourceKey} references unknown quest key ${n}`);return a.id});return{id:e.id,label:i.label,summary:i.summary,questIds:s,kind:e.kind,recommendedLevel:e.recommendedLevel,factionTag:e.factionTag}},Ql=(e,t)=>{const i=t.levels[e.resourceKey],s=e.missionKeys.map(Zl).map(n=>Xl(n,t));return{level:e.order,levelId:e.id,name:(i==null?void 0:i.name)??e.id,zoneId:e.zoneKey,objectives:s}},Jl=e=>{const t=Qa(e);return Za.map(i=>Ql(i,t))},ec=e=>Jl(e).map(i=>({level:i.level,levelId:i.levelId,name:i.name,zoneId:i.zoneId,objectives:i.objectives.map(s=>({...s,questIds:[...s.questIds]}))})),Ii=(e=Ie)=>({levels:ec(e),currentLevelIndex:0,pendingAdvance:!1,celebrationAcknowledged:!1,lastMissionCompletedAt:null}),tc=Ii(Ie),ia=Q({name:"missions",initialState:tc,reducers:{missionAccomplished(e){e.pendingAdvance||(e.pendingAdvance=!0,e.celebrationAcknowledged=!1,e.lastMissionCompletedAt=Date.now())},acknowledgeMissionAccomplished(e){e.celebrationAcknowledged=!0},deferMissionAdvance(e){e.celebrationAcknowledged=!0},showMissionAdvancePrompt(e){e.pendingAdvance&&(e.celebrationAcknowledged=!1)},advanceToNextLevel(e){e.currentLevelIndex<e.levels.length-1&&(e.currentLevelIndex+=1),e.pendingAdvance=!1,e.celebrationAcknowledged=!1},resetMissions:(e,t)=>Ii(t.payload??Ie),applyLocaleToMissions:(e,t)=>Ii(t.payload)}}),{missionAccomplished:qm,acknowledgeMissionAccomplished:Vm,deferMissionAdvance:Gm,showMissionAdvancePrompt:zm,advanceToNextLevel:Um,resetMissions:Km,applyLocaleToMissions:ic}=ia.actions,sc=ia.reducer,nc={messages:[]},sa=Q({name:"log",initialState:nc,reducers:{addLogMessage(e,t){const s=[...e.messages,t.payload];s.length>50&&s.shift(),e.messages=s,console.log(`[Log] ${t.payload}`)},clearLog(e){e.messages=[]}},extraReducers:e=>{e.addCase(Ml,(t,i)=>{ct(i.payload,H)&&t.messages.length===0&&(t.messages=["Searchlights pin you in the open—duck inside before the patrols lock on."])})}}),{addLogMessage:we,clearLog:jm}=sa.actions,ac=sa.reducer,ci=e=>e,xi={balanced:ci({id:"balanced",label:"Balanced",description:"Evaluates offence and defence evenly. Prioritises clear shots, keeps moderate AP reserve, and falls back to cover if health dips.",weights:{attackBias:1,focusLowestHealth:.75,focusOverwatchThreat:.85,maintainCover:.8,pursuitAggression:.65,consumableAggression:.5,retreatBias:.6},thresholds:{panicHealthFraction:.35,apReserve:1,minimumConsumableCharges:1}}),aggressive:ci({id:"aggressive",label:"Aggressive",description:"Closes distance, spends AP rapidly, and consumes resources to finish priority targets. Retreats only when near death.",weights:{attackBias:1.35,focusLowestHealth:1.1,focusOverwatchThreat:.7,maintainCover:.35,pursuitAggression:1.2,consumableAggression:1,retreatBias:.2},thresholds:{panicHealthFraction:.2,apReserve:0,minimumConsumableCharges:0}}),defensive:ci({id:"defensive",label:"Defensive",description:"Holds positions with strong cover, conserves consumables, and only advances when safe. Will disengage early if health drops.",weights:{attackBias:.6,focusLowestHealth:.55,focusOverwatchThreat:1.25,maintainCover:1.6,pursuitAggression:.3,consumableAggression:.25,retreatBias:1.4},thresholds:{panicHealthFraction:.5,apReserve:2,minimumConsumableCharges:2}})},rc="balanced",$m=Object.keys(xi),Hs=e=>xi[e]??xi.balanced,oc={locale:Ie,testMode:!1,autoBattleEnabled:!1,autoBattleProfile:rc,visualQualityPreset:"balanced",lightsEnabled:!1,autoStealthEnabled:!1,reputationSystemsEnabled:!1},na=Q({name:"settings",initialState:oc,reducers:{setLocale:(e,t)=>{e.locale=t.payload},setTestMode:(e,t)=>{e.testMode=t.payload},setAutoBattleEnabled:(e,t)=>{e.autoBattleEnabled=t.payload},setAutoBattleProfile:(e,t)=>{e.autoBattleProfile=t.payload},setVisualQualityPreset:(e,t)=>{e.visualQualityPreset=t.payload},setLightsEnabled:(e,t)=>{e.lightsEnabled=t.payload},setAutoStealthEnabled:(e,t)=>{e.autoStealthEnabled=t.payload},setReputationSystemsEnabled:(e,t)=>{e.reputationSystemsEnabled=t.payload}}}),{setLocale:Ym,setTestMode:Zm,setAutoBattleEnabled:Xm,setAutoBattleProfile:Qm,setVisualQualityPreset:Jm,setLightsEnabled:Ws,setAutoStealthEnabled:eg,setReputationSystemsEnabled:tg}=na.actions,aa=na.reducer,lc={floatingNumbers:[],hitFlashes:[],activeFlashId:null},ra=Q({name:"combatFeedback",initialState:lc,reducers:{addFloatingNumber:(e,t)=>{e.floatingNumbers.push(t.payload)},removeFloatingNumber:(e,t)=>{e.floatingNumbers=e.floatingNumbers.filter(i=>i.id!==t.payload)},triggerHitFlash:(e,t)=>{e.activeFlashId=t.payload.id,e.hitFlashes.push(t.payload)},clearHitFlash:e=>{e.activeFlashId=null,e.hitFlashes=[]},clearAllFeedback:e=>{e.floatingNumbers=[],e.hitFlashes=[],e.activeFlashId=null}}}),{addFloatingNumber:cc,removeFloatingNumber:ig,triggerHitFlash:sg,clearHitFlash:ng,clearAllFeedback:ag}=ra.actions,dc=ra.reducer,uc=()=>({overlayEnabled:!0,camerasNearby:0,detectionProgress:0,activeCameraId:null,alertState:ne.IDLE,networkAlertActive:!1,networkAlertExpiresAt:null}),qs={zones:{},hud:uc(),curfewBanner:{visible:!1,lastActivatedAt:null}},oa=Q({name:"surveillance",initialState:qs,reducers:{registerZoneCameras:(e,t)=>{const{areaId:i,zoneId:s,cameras:n,timestamp:a}=t.payload,r=n.reduce((o,l)=>(o[l.id]={...l},o),{});e.zones[i]={areaId:i,zoneId:s,cameras:r,networkAlert:null,lastUpdatedAt:a}},updateCameraState:(e,t)=>{const{areaId:i,cameraId:s,changes:n,timestamp:a}=t.payload,r=e.zones[i];if(!r)return;const o=r.cameras[s];o&&(r.cameras[s]={...o,...n},r.lastUpdatedAt=a)},setCameraNetworkAlert:(e,t)=>{const{areaId:i,alert:s}=t.payload,n=e.zones[i];n&&(n.networkAlert=s?{...s}:null)},updateHudState:(e,t)=>{const i=t.payload;e.hud={...e.hud,...i},typeof i.networkAlertActive=="boolean"&&!i.networkAlertActive&&(e.hud.networkAlertExpiresAt=null),typeof i.networkAlertExpiresAt=="number"&&(e.hud.networkAlertActive=!0)},setOverlayEnabled:(e,t)=>{e.hud.overlayEnabled=t.payload.enabled},setCurfewBanner:(e,t)=>{e.curfewBanner.visible=t.payload.visible,t.payload.visible&&(e.curfewBanner.lastActivatedAt=t.payload.timestamp)},clearZoneCameras:(e,t)=>{const{areaId:i}=t.payload;delete e.zones[i]},resetSurveillanceState:()=>qs}}),{registerZoneCameras:rg,updateCameraState:og,setCameraNetworkAlert:lg,updateHudState:cg,setOverlayEnabled:dg,setCurfewBanner:ug,clearZoneCameras:hg,resetSurveillanceState:pg}=oa.actions,la=oa.reducer,hc=[{id:"npc_lira_vendor",name:"Lira the Smuggler",kind:"contact",tags:["resistance","strategist","ally","bonded","quartermaster"],traits:["resistance","strategist","bonded"],factionId:"resistance",relationship:"bonded"},{id:"npc_archivist_naila",name:"Archivist Naila",kind:"contact",tags:["resistance","scholar","ally"],traits:["scholar","resistance"],factionId:"resistance",relationship:"ally"},{id:"npc_courier_brant",name:"Courier Brant",kind:"contact",tags:["resistance","runner","ally"],traits:["runner","ally"],factionId:"resistance",relationship:"ally"},{id:"npc_firebrand_juno",name:"Firebrand Juno",kind:"contact",tags:["resistance","agitator","ally","witness"],traits:["agitator"],factionId:"resistance",relationship:"ally"},{id:"npc_seraph_warden",name:"Seraph Warden",kind:"contact",tags:["corpsec","warden","rival"],traits:["corpsec","rival"],factionId:"corpsec",relationship:"rival"},{id:"npc_drone_handler_kesh",name:"Drone Handler Kesh",kind:"contact",tags:["resistance","tech","ally"],traits:["technician"],factionId:"resistance",relationship:"ally"}],pc={npc_lira_vendor:{tags:["resistance","ally","quartermaster","bonded"],traits:["strategist","bonded"],relationship:"bonded",factionId:"resistance"},npc_archivist_naila:{tags:["resistance","ally","scholar"],traits:["scholar"],relationship:"ally",factionId:"resistance"},npc_courier_brant:{tags:["resistance","ally","runner"],traits:["runner"],relationship:"ally",factionId:"resistance"},npc_firebrand_juno:{tags:["resistance","ally","agitator"],traits:["agitator"],relationship:"ally",factionId:"resistance"},npc_seraph_warden:{tags:["corpsec","rival","warden"],traits:["corpsec","rival"],relationship:"rival",factionId:"corpsec"},npc_drone_handler_kesh:{tags:["resistance","ally","tech"],traits:["technician"],relationship:"ally",factionId:"resistance"},npc_medic_yara:{tags:["resistance","ally","medic"],traits:["medic"],relationship:"ally",factionId:"resistance"},npc_captain_reyna:{tags:["resistance","ally","commander"],traits:["commander"],relationship:"ally",factionId:"resistance"}},Ci=(e,t)=>{e.has(t.id)||e.set(t.id,{...t,tags:[...t.tags],traits:[...t.traits]})},mc=(e,t,i)=>{const s=e.get(t.id);if(!s){Ci(e,t);return}s.tags=Array.from(new Set([...s.tags,...t.tags])),s.traits=Array.from(new Set([...s.traits,...t.traits]))},gc=({player:e,npcs:t})=>{var a;const i=new Map;hc.forEach(r=>Ci(i,r));const s=e.maxHealth>0?e.maxHealth*.65:e.maxHealth,n={id:e.id,name:e.name||"Operative",kind:"player",tags:["player","operative","ally"],traits:[((a=e.personality)==null?void 0:a.alignment)??"earnest"],factionId:"resistance",wounded:e.health<s,relationship:"ally",backgroundId:e.backgroundId};return e.backgroundId&&n.tags.push(e.backgroundId),e.perks.length>0&&n.tags.push("perked"),Ci(i,n),t.forEach(r=>{const o=r.dialogueId??r.id;if(!o)return;const l={id:o,name:r.name,kind:r.isInteractive?"contact":"npc",tags:["npc",r.isInteractive?"ally":"witness"],traits:[],wounded:r.health<r.maxHealth,relationship:r.isInteractive?"ally":"witness"},c=pc[o];c&&(l.tags.push(...c.tags),c.traits&&l.traits.push(...c.traits),c.relationship&&(l.relationship=c.relationship),c.factionId&&(l.factionId=c.factionId)),mc(i,l)}),Array.from(i.values())},Vs=(e,t,i)=>{var n;if(t.requiredTags&&!t.requiredTags.every(a=>i.tags.includes(a))||t.forbiddenTags&&t.forbiddenTags.some(a=>i.tags.includes(a))||t.requiredTraits&&!t.requiredTraits.every(a=>i.traits.includes(a))||t.forbiddenTraits&&t.forbiddenTraits.some(a=>i.traits.includes(a))||i.wounded&&t.allowWounded===!1)return null;let s=1;return t.preferredTags&&t.preferredTags.forEach(a=>{i.tags.includes(a)&&(s+=2)}),t.requiredTraits&&(s+=t.requiredTraits.length),i.relationship&&((n=t.preferredTags)!=null&&n.includes(i.relationship))&&(s+=1.5),i.kind==="player"&&e!=="protagonist"&&(s-=.25),s},fc=(e,t)=>{const i=[...t],s={},n=new Set;let a=0;const r=t.find(o=>o.kind==="player");for(const o of e.roles){let l=null;for(const c of i){if(c.kind!=="player"&&n.has(c.id))continue;const d=Vs(o.id,o,c);d!=null&&(!l||d>l.score)&&(l={roleId:o.id,actor:c,score:d})}if(!l&&o.fallbackToPlayer&&r){const c=Vs(o.id,o,r);c!=null&&(l={roleId:o.id,actor:r,score:Math.max(.5,c)})}if(!l)return null;s[o.id]=l.actor,a+=l.score,l.actor.kind!=="player"&&n.add(l.actor.id)}return{resolvedRoles:s,totalScore:a}},yc=(e,t,i)=>!e.conditions||e.conditions.length===0?!0:e.conditions.every(s=>{var n;switch(s.type){case"roleTrait":{const a=t[s.roleId];return a?a.traits.includes(s.trait):!1}case"roleTag":{const a=t[s.roleId];return a?a.tags.includes(s.tag):!1}case"roleRelationship":{const a=t[s.roleId];return a?a.relationship===s.relationship:!1}case"roleStatus":{const a=t[s.roleId];return s.status==="wounded"?!!(a!=null&&a.wounded):!1}case"contextTag":return!!((n=i.tags)!=null&&n.includes(s.tag));case"contextArc":return i.arc===s.arc;default:return!1}}),Sc=(e,t,i)=>{let s=null,n=-1/0;for(const a of e.branches){if(!yc(a,t,i))continue;const r=a.weight??1;(!s||r>n)&&(s=a,n=r)}return s??e.branches[0]??null},vc=(e,t)=>e.triggers.some(i=>{if(i.type!==t.type)return!1;if(i.tags&&i.tags.length>0){const s=t.tags??[];return i.tags.every(n=>s.includes(n))}return!0}),bc=(e,t,i,s)=>{const n=e.entries[t.id];return!!(n!=null&&n.cooldownExpiresAt&&n.cooldownExpiresAt>s||t.cooldown.perLocation&&i&&e.lastSeenByLocation[i]===t.id&&n!=null&&n.cooldownExpiresAt&&n.cooldownExpiresAt>s)},wc=({plays:e,runtime:t,trigger:i,actorPool:s,now:n,locationId:a})=>{let r=null,o=-1/0;for(const l of e){if(l.arc!==i.arc||!vc(l,i)||bc(t,l,a,n))continue;const c=fc(l,s);if(!c)continue;const d=Sc(l,c.resolvedRoles,i);if(!d)continue;const u=t.entries[l.id];let h=(l.weight??1)+c.totalScore+(d.weight??1);u&&(h-=u.timesTriggered*.75),h>o&&(o=h,r={storyletId:l.id,play:l,branch:d,outcome:d.outcome,resolvedRoles:c.resolvedRoles,context:i,timestamp:n,cooldownExpiresAt:n+l.cooldown.durationMs})}return r},Pc=e=>e<=0?"act1_setup":e===1?"act2_escalation":"act3_finale",ca=[{id:"firelight_ambush",arc:"act1_setup",titleKey:"storylets.firelight_ambush.title",synopsisKey:"storylets.firelight_ambush.synopsis",tags:["ambush","resistance","omen"],triggers:[{type:"missionCompletion",tags:["resistance"],intensity:"medium"}],roles:[{id:"protagonist",titleKey:"storylets.roles.protagonist",preferredTags:["operative","player"],fallbackToPlayer:!0,allowWounded:!0},{id:"mentor",titleKey:"storylets.roles.mentor",requiredTags:["resistance"],preferredTags:["strategist","quartermaster"]},{id:"witness",titleKey:"storylets.roles.witness",preferredTags:["civilian","witness"],allowWounded:!1,fallbackToPlayer:!0}],branches:[{id:"scarred_victory",weight:2,conditions:[{type:"roleStatus",roleId:"protagonist",status:"wounded"}],outcome:{id:"scarred_victory",localizationKey:"storylets.firelight_ambush.outcomes.scarred_victory",variantKey:"wounded",effects:[{type:"faction",factionId:"resistance",delta:8,reason:"storylet:firelight_ambush"},{type:"log",logKey:"storylets.firelight_ambush.log.wounded",severity:"info"}],tags:["injury","loyalty"]}},{id:"clean_sweep",outcome:{id:"clean_sweep",localizationKey:"storylets.firelight_ambush.outcomes.clean_sweep",effects:[{type:"faction",factionId:"resistance",delta:5,reason:"storylet:firelight_ambush"},{type:"log",logKey:"storylets.firelight_ambush.log.clean",severity:"info"}],tags:["loyalty"]}}],cooldown:{durationMs:1e3*60*20,perLocation:!0},weight:3},{id:"neon_bivouac",arc:"act2_escalation",titleKey:"storylets.neon_bivouac.title",synopsisKey:"storylets.neon_bivouac.synopsis",tags:["relationship","rest","memory"],triggers:[{type:"campfireRest",tags:["rest"],intensity:"low"}],roles:[{id:"protagonist",titleKey:"storylets.roles.protagonist",preferredTags:["operative","player"],fallbackToPlayer:!0,allowWounded:!0},{id:"confidant",titleKey:"storylets.roles.confidant",requiredTags:["ally"],preferredTags:["bonded","scholar","strategist"],allowWounded:!0}],branches:[{id:"bond_renewed",weight:3,conditions:[{type:"roleRelationship",roleId:"confidant",relationship:"bonded"}],outcome:{id:"bond_renewed",localizationKey:"storylets.neon_bivouac.outcomes.bond_renewed",variantKey:"bonded",effects:[{type:"log",logKey:"storylets.neon_bivouac.log.bonded",severity:"info"},{type:"traitDelta",target:"player",trait:"earnest",delta:1}],tags:["relationship","loyalty"]}},{id:"quiet_distance",outcome:{id:"quiet_distance",localizationKey:"storylets.neon_bivouac.outcomes.quiet_distance",effects:[{type:"log",logKey:"storylets.neon_bivouac.log.distance",severity:"info"}],tags:["memory"]}}],cooldown:{durationMs:1e3*60*30,perLocation:!0},weight:2},{id:"serrated_omen",arc:"act3_finale",titleKey:"storylets.serrated_omen.title",synopsisKey:"storylets.serrated_omen.synopsis",tags:["ambush","corpsec","injury","omen"],triggers:[{type:"patrolAmbush",tags:["corpsec","ambush"],intensity:"high"}],roles:[{id:"protagonist",titleKey:"storylets.roles.protagonist",preferredTags:["operative","player"],fallbackToPlayer:!0,allowWounded:!0},{id:"rival",titleKey:"storylets.roles.rival",requiredTags:["corpsec"],preferredTags:["rival","warden"],allowWounded:!0},{id:"witness",titleKey:"storylets.roles.witness",preferredTags:["resistance","ally"],allowWounded:!0,fallbackToPlayer:!1}],branches:[{id:"rivalry_ignites",weight:2,conditions:[{type:"roleRelationship",roleId:"rival",relationship:"rival"}],outcome:{id:"rivalry_ignites",localizationKey:"storylets.serrated_omen.outcomes.rivalry_ignites",variantKey:"rival",effects:[{type:"faction",factionId:"corpsec",delta:-10,reason:"storylet:serrated_omen"},{type:"playerHealth",delta:-4,allowKO:!1},{type:"log",logKey:"storylets.serrated_omen.log.rival",severity:"warning"}],tags:["injury","corpsec"]}},{id:"shadows_scatter",outcome:{id:"shadows_scatter",localizationKey:"storylets.serrated_omen.outcomes.shadows_scatter",effects:[{type:"log",logKey:"storylets.serrated_omen.log.default",severity:"info"}],tags:["ambush"]}}],cooldown:{durationMs:1e3*60*25,perLocation:!0},weight:3}];ca.reduce((e,t)=>(e[t.id]=t,e),{});const Mc=()=>ca,da={roles:{protagonist:"Operative",mentor:"Mentor",witness:"Witness",confidant:"Confidant",rival:"Rival"},plays:{firelight_ambush:{title:"Firelight Ambush",synopsis:"After the crates are reclaimed, the cell huddles around a burn barrel to measure the cost of provoking CorpSec patrols.",roles:{protagonist:"Operative",mentor:"Quartermaster",witness:"Runner"},outcomes:{scarred_victory:{base:{narrative:"{mentor} studies the bandaged gouge across {protagonist}’s ribs. “You took the hit so the crates could run. That balance clears.”",logLine:"Lira marks your scars as the price of keeping the supply line alive."},variants:{wounded:{narrative:"{mentor} catches {protagonist} before they slide to the bricks. She seals the fresh wound, the firelight flickering across the stimulant foam. “Next patrol never makes it to the siren,” she vows, voice steady for {witness}’s sake.",logLine:"Lira steadies you, promising the next patrol will never raise an alarm."}}},clean_sweep:{base:{narrative:"The burn barrel sends sparks up past the transit rails. {protagonist} tips confiscated batons into the fire while {mentor} and {witness} sketch new blind spots across a soot-streaked map.",logLine:"The cell celebrates the clean strike and notebooks fill with new patrol gaps."}}}},neon_bivouac:{title:"Neon Bivouac",synopsis:"The crew slumps beneath a humming holo-ad, sharing contraband rations while the grid cools. Stories trade faster than the battered thermos.",roles:{protagonist:"Operative",confidant:"Confidant"},outcomes:{bond_renewed:{base:{narrative:"{confidant} nudges a tin mug into {protagonist}’s hands. “Remember the rooftops in District Eight?” The laugh that follows is low and unguarded, the neon glow framing two conspirators instead of soldiers.",logLine:"{confidant} shares an old war story and the bivouac feels like home again."},variants:{bonded:{narrative:"{confidant} leans shoulder to shoulder with {protagonist}, the steam from the thermos curling between matching scars. “When we ran the Gridfall evac we swore never to sleep alone on watch again. Still true.”",logLine:"{confidant} reaffirms the pact forged during Gridfall and your bond deepens."}}},quiet_distance:{base:{narrative:"The neon hum fills the silence between {protagonist} and {confidant}. They trade reports instead of memories, each syllable an inventory count that never strays into feeling.",logLine:"Camp chatter stays clipped—nerves too raw for stories tonight."}}}},serrated_omen:{title:"Serrated Omen",synopsis:"A CorpSec counter-sweep slams into the team on their way back through the alleys. The clash leaves a metallic stink and unanswered questions.",roles:{protagonist:"Operative",rival:"Adversary",witness:"Witness"},outcomes:{rivalry_ignites:{base:{narrative:"{rival}’s monofilament blade sparks off the barricade, carving a groove through {protagonist}’s armor. “I told you the curfew rites were mine to enforce,” she hisses, visor fractured yet unyielding.",logLine:"Seraph Warden carves a warning across your armor and vows the next hunt will finish it."},variants:{rival:{narrative:"{rival} vents ozone from her pauldrons, the mask reflecting {protagonist}’s blood. “You survived my ambush twice. Next time I bring witnesses.” {witness} pulls you back before the second strike lands.",logLine:"Seraph Warden leaves you bleeding but breathing—her promise of a final duel hangs heavy."}}},shadows_scatter:{base:{narrative:"Sirens bloom and the alleys dissolve into darkness. {protagonist} fires blind, smoke swallowing {rival} while {witness} drags the wounded out before drones arrive.",logLine:"You slip the net, but CorpSec frequencies crackle with renewed suspicion."}}}}},logs:{"storylets.firelight_ambush.log.wounded":"Lira steadies you, promising the next patrol will never raise an alarm.","storylets.firelight_ambush.log.clean":"The cell celebrates the clean strike and notebooks fill with new patrol gaps.","storylets.neon_bivouac.log.bonded":"Sharing Gridfall memories, your confidant reminds you why the fire still burns.","storylets.neon_bivouac.log.distance":"Camp chatter stays clipped—nerves too raw for stories tonight.","storylets.serrated_omen.log.rival":"Seraph Warden leaves you bleeding but breathing—her promise of a final duel hangs heavy.","storylets.serrated_omen.log.default":"You lose her in the smoke, but CorpSec channels crackle with orders to tighten the cordon."}},Ac={roles:{protagonist:"Оперативник",mentor:"Кураторка",witness:"Свідок",confidant:"Довірена особа",rival:"Суперниця"},plays:{firelight_ambush:{title:"Засідка у вогнях",synopsis:"Після повернення контрабандних ящиків осередок гріється біля бочки й рахує ціну, яку доведеться платити за розлючені патрулі CorpSec.",roles:{protagonist:"Оперативник",mentor:"Квартирмейстерка",witness:"Розвідник"},outcomes:{scarred_victory:{base:{narrative:"{mentor} розглядає перев’язаний поріз на ребрах {protagonist}. «Ти прийняв удар, щоб вантаж дійшов. Рахунок закрито».",logLine:"Ліра фіксує шрам як обов’язкову плату за живу лінію постачання."},variants:{wounded:{narrative:"{mentor} підхоплює {protagonist}, поки той не впав на бруківку. Вона заливає свіже поранення піною, іскри від вогню тремтять у її очах. «Наступний патруль не доживе до сирени», — кидає вона, щоб заспокоїти {witness}.",logLine:"Ліра підтримує тебе й клянеться, що наступний патруль навіть не встигне подати тривогу."}}},clean_sweep:{base:{narrative:"Жар від бочки освітлює спорядження. {protagonist} кидає конфісковані кийки у вогонь, поки {mentor} та {witness} малюють нові «сліпі зони» на закіптюженій мапі.",logLine:"Осередок святкує чисту операцію й занотовує нові прогалини у патрулях."}}}},neon_bivouac:{title:"Неоновий бівак",synopsis:"Команда притискається під гудінням голографічної реклами, ділячись пайками та історіями, поки мережа остигає.",roles:{protagonist:"Оперативник",confidant:"Довірена особа"},outcomes:{bond_renewed:{base:{narrative:"{confidant} підсовує {protagonist} розігрітий кухоль. «Пам’ятаєш дахи у Восьмому секторі?» Сміх глухий і теплий, неонове сяйво робить із них двох змовників, а не солдатів.",logLine:"{confidant} ділиться старою історією, і бівак знову відчувається домом."},variants:{bonded:{narrative:"{confidant} торкається плечем до плеча {protagonist}, пара від термоса обвішує їхні парні шрами. «На евакуації Gridfall ми поклялися не стояти на варті на самоті. Обіцянка діє», — шепоче вона.",logLine:"{confidant} нагадує про клятву часів Gridfall, і ваш зв’язок міцнішає."}}},quiet_distance:{base:{narrative:"Неонове гудіння заповнює паузу між {protagonist} та {confidant}. Вони обмінюються лише рапортами, кожне слово — це інвентаризація без жодної емоції.",logLine:"Розмови біля вогню уривчасті — нерви надто натягнуті для спогадів."}}}},serrated_omen:{title:"Зазубрений знак",synopsis:"Контр-рейд CorpSec накриває групу у провулках. Металевий присмак зависає в повітрі, залишаючи запитання без відповіді.",roles:{protagonist:"Оперативник",rival:"Суперниця",witness:"Свідок"},outcomes:{rivalry_ignites:{base:{narrative:"Лезо {rival} креслить іскри по барикаді, розрізаючи броню {protagonist}. «Комендантська година — моя прерогатива», — шипить вона крізь тріснутий візор.",logLine:"Сераф-варден залишає поріз на твоїй броні й обіцяє, що наступне полювання буде останнім."},variants:{rival:{narrative:"{rival} випускає озон із наплічників, маска віддзеркалює кров {protagonist}. «Двічі ти вислизнув. Наступного разу я приведу свідків». {witness} шарпає тебе назад, перш ніж вона наносить другий удар.",logLine:"Сераф-варден залишає тебе пораненим, але живим — і призначає фінальний двобій."}}},shadows_scatter:{base:{narrative:"Сирени розквітають, провулки ковтає дим. {protagonist} стріляє навмання, {rival} губиться в тіні, поки {witness} витягує поранених до прибуття дронів.",logLine:"Вам вдається вислизнути, але частоти CorpSec гудуть новими наказами посилити патрулі."}}}}},logs:{"storylets.firelight_ambush.log.wounded":"Ліра підтримує тебе й клянеться, що наступний патруль не встигне підняти тривогу.","storylets.firelight_ambush.log.clean":"Осередок святкує чисту операцію й занотовує нові прогалини у патрулях.","storylets.neon_bivouac.log.bonded":"Довірена особа ділиться спогадами Gridfall, і вогник знову обіцяє тепло.","storylets.neon_bivouac.log.distance":"Розмови біля вогню уривчасті — нерви надто натягнуті для спогадів.","storylets.serrated_omen.log.rival":"Сераф-варден залишає тебе пораненим, але живим, і призначає фінальний двобій.","storylets.serrated_omen.log.default":"Вам вдається вислизнути, але частоти CorpSec гудуть новими наказами посилити патрулі."}},Ic={en:da,uk:Ac},ua=e=>Ic[e]??da,Bt=(e,t)=>e.replace(/\{([\w\d_]+)\}/g,(i,s)=>t[s]??`{${s}}`),xc=(e,t)=>!t||!e.variants?e.base:e.variants[t]??e.base,Gs={entries:{},lastSeenByLocation:{},queue:[]},ha=Q({name:"storylets",initialState:Gs,reducers:{enqueueStorylet(e,t){const{resolution:i,queueItem:s,locationId:n}=t.payload,a=e.entries[i.storyletId]??{storyletId:i.storyletId,lastTriggeredAt:null,cooldownExpiresAt:null,timesTriggered:0};a.lastTriggeredAt=i.timestamp,a.cooldownExpiresAt=i.cooldownExpiresAt,a.timesTriggered+=1,e.entries[i.storyletId]=a,n&&(e.lastSeenByLocation[n]=i.storyletId),e.queue.push(s)},dequeueStorylet(e,t){const i=t.payload;if(!i){e.queue.shift();return}e.queue=e.queue.filter(s=>s.id!==i)},clearStorylets:()=>Gs}}),{enqueueStorylet:Cc,dequeueStorylet:mg,clearStorylets:gg}=ha.actions,kc=ha.reducer,Tc=(e,t,i)=>{var o;const s=Pc(t.missions.currentLevelIndex),n=e.locationId??((o=t.world.currentMapArea)==null?void 0:o.id),a=new Set(e.tags??[]);e.type==="patrolAmbush"&&a.add("ambush"),e.type==="campfireRest"&&(a.add("rest"),a.add("relationship"));const r=t.player.data;return r.maxHealth>0&&r.health<r.maxHealth*.7&&a.add("injury"),{type:e.type,arc:s,timestamp:i,locationId:n,missionId:e.missionId,tags:Array.from(a)}},Rc=e=>({entries:{...e.entries},lastSeenByLocation:{...e.lastSeenByLocation}}),Ec=(e,t)=>{const s=ua(t).plays[e.storyletId],n={},a={};Object.entries(e.resolvedRoles).forEach(([u,h])=>{n[u]=h.name,a[u]={id:h.id,name:h.name,relationship:h.relationship}});const r=s==null?void 0:s.outcomes[e.branch.id],o=r?xc(r,e.outcome.variantKey):void 0,l=o?Bt(o.narrative,n):"",c=o!=null&&o.epilogue?Bt(o.epilogue,n):void 0,d=o!=null&&o.logLine?Bt(o.logLine,n):void 0;return{id:se(),storyletId:e.storyletId,branchId:e.branch.id,title:(s==null?void 0:s.title)??e.play.id,synopsis:(s==null?void 0:s.synopsis)??"",narrative:l,epilogue:c,logLine:d,resolvedRoles:a,triggeredAt:e.timestamp,locale:t,outcomeLocalizationKey:e.outcome.localizationKey,variantKey:e.outcome.variantKey}},_c=(e,t,i,s)=>{const n=ua(t),a={};Object.entries(e.resolvedRoles).forEach(([r,o])=>{a[r]=o.name}),e.outcome.effects.forEach(r=>{switch(r.type){case"log":{const o=n.logs[r.logKey]??e.play.titleKey??r.logKey,l=Bt(o,a);i(we(l));break}case"faction":{if(!s)break;i(Fo({factionId:r.factionId,delta:r.delta,reason:r.reason??"storylet",source:e.storyletId}));break}case"playerHealth":{i(Lo(r.delta));break}case"traitDelta":{r.target==="player"&&i(Bo({trait:r.trait,delta:r.delta,source:e.storyletId}));break}}})},fg=e=>(t,i)=>{var h;const s=i(),n=Date.now(),a=((h=s.settings)==null?void 0:h.locale)??Ie,r=Tc(e,s,n),o=Rc(s.storylets),l=Mc(),c=gc({player:s.player.data,npcs:s.world.currentMapArea.entities.npcs}),d=wc({plays:l,runtime:o,trigger:r,actorPool:c,now:n,locationId:r.locationId});if(!d)return;_c(d,a,t,!!s.settings.reputationSystemsEnabled);const u=Ec(d,a);t(Cc({resolution:d,queueItem:u,locationId:r.locationId}))},ki=(e,t,i)=>!Number.isFinite(e)||e<t?t:e>i?i:e,yg=e=>{if(!Number.isFinite(e))return 0;const t=e%360;return t<0?t+360:t},Sg=(e,t)=>!Number.isFinite(e)||!Number.isFinite(t)?0:(t-e+540)%360-180,vg=(e,t,i)=>!Number.isFinite(e)||!Number.isFinite(t)||!Number.isFinite(i)?e:e+(t-e)*i,bg=e=>Number.isFinite(e)?e*(180/Math.PI):0,pa=(e,t,i)=>`${e}:${t}:${i}`,Se=e=>ki(e,0,1),ma=e=>{const{baseCertainty:t,distanceModifier:i,lightingModifier:s,disguiseModifier:n,postureModifier:a}=e,r=t*Se(i)*Se(s)*Se(n)*Se(a);return Se(r)},Dc=(e,t)=>{var s;const i=ma(e);return{id:pa(e.witnessId,e.targetId,e.recognitionChannel),witnessId:e.witnessId,witnessLabel:e.witnessLabel??e.witnessId,targetId:e.targetId,zoneId:e.zoneId,areaId:e.areaId,source:e.source,recognitionChannel:e.recognitionChannel,certainty:i,halfLifeSeconds:t.halfLifeSeconds,firstSeenAt:e.timestamp,lastSeenAt:e.timestamp,reinforcedAt:void 0,reported:e.reported??!1,suppressed:((s=e.existing)==null?void 0:s.suppressed)??!1,proximityWeight:Se(e.distanceModifier),location:e.location}},Lc=(e,t,i)=>{var r;const s=ma(t),n=s*i.reinforcementBonus,a=Se(Math.max(e.certainty,s)+n);return{...e,witnessLabel:t.witnessLabel??e.witnessLabel??e.witnessId,certainty:a,lastSeenAt:t.timestamp,reinforcedAt:t.timestamp,reported:e.reported||t.reported,suppressed:((r=t.existing)==null?void 0:r.suppressed)??e.suppressed,proximityWeight:Se(Math.max(e.proximityWeight,t.distanceModifier)),location:t.location??e.location}},Fc=(e,t,i)=>{if(t<=0||e.certainty<=0)return{memory:{...e},pruned:e.certainty<i.certaintyFloor};const s=e.halfLifeSeconds>0?e.halfLifeSeconds:i.halfLifeSeconds,n=t/s,a=Math.pow(.5,n);let r=Se(e.certainty*a);e.suppressed&&(r*=i.suppressionPenalty);const o=r<i.certaintyFloor;return{memory:{...e,certainty:r},pruned:o}},zs=e=>({id:e.id,witnessId:e.witnessId,witnessLabel:e.witnessLabel,targetId:e.targetId,zoneId:e.zoneId,areaId:e.areaId,source:e.source,recognitionChannel:e.recognitionChannel,certainty:e.certainty,halfLifeSeconds:e.halfLifeSeconds,firstSeenAt:e.firstSeenAt,lastSeenAt:e.lastSeenAt,reinforcedAt:e.reinforcedAt,reported:e.reported,suppressed:e.suppressed,proximityWeight:e.proximityWeight}),Ti=e=>({id:e.id,witnessId:e.witnessId,witnessLabel:e.witnessLabel,targetId:e.targetId,zoneId:e.zoneId,areaId:e.areaId,source:e.source,recognitionChannel:e.recognitionChannel,certainty:e.certainty,halfLifeSeconds:e.halfLifeSeconds,firstSeenAt:e.firstSeenAt,lastSeenAt:e.lastSeenAt,reinforcedAt:e.reinforcedAt,reported:e.reported,suppressed:e.suppressed,proximityWeight:e.proximityWeight}),Bc=(e,t)=>{const i=Math.pow(ki(e.proximityWeight,0,1),t.proximityExponent),s=e.reported?t.reportMultiplier:1;return ki(e.certainty*i*s,0,1.5)},Oc=(e,t)=>e>=t.tierThresholds.crackdown?"crackdown":e>=t.tierThresholds.tracking?"tracking":"calm",Nc=(e,t,i)=>{if(t.length===0)return{zoneId:e,totalHeat:0,tier:"calm",leadingWitnessIds:[]};const s=t.filter(c=>c.suppressed?!1:c.certainty>=i.certaintyFloor);if(s.length===0)return{zoneId:e,totalHeat:0,tier:"calm",leadingWitnessIds:[]};const n=s.map(c=>({memory:c,weight:Bc(c,i)})).sort((c,d)=>d.weight-c.weight),a=i.topK>0?i.topK:5,r=n.slice(0,a),o=r.reduce((c,d)=>c+d.weight,0),l=Oc(o,i);return{zoneId:e,totalHeat:o,tier:l,leadingWitnessIds:r.map(c=>c.memory.id)}},Ri=3600,Gt={id:"default",label:"Baseline Urban Patrols",halfLifeSeconds:72*Ri,certaintyFloor:.05,reinforcementBonus:.4,reportMultiplier:1.25,suppressionPenalty:.4,topK:5,proximityExponent:.85,tierThresholds:{tracking:.4,crackdown:.75}},Hc={downtown:{...Gt,id:"downtown",label:"Downtown Grid Hyper-Patrol",halfLifeSeconds:60*Ri,reportMultiplier:1.35,topK:6},industrial:{...Gt,id:"industrial",label:"Industrial Wasteland Patrol",halfLifeSeconds:96*Ri,suppressionPenalty:.55}},Ei=e=>e?Hc[e]??Gt:Gt,_i=1,Wc=(e,t)=>({zoneId:e,memories:{},heat:{zoneId:e,totalHeat:0,tier:"calm",leadingWitnessIds:[]},lastUpdatedAt:t,lastObservationAt:null}),is=()=>({version:_i,zones:{},paused:!1,lastTickAt:null}),qc=is(),Us=e=>{switch(e){case"calm":return 0;case"tracking":return 1;case"crackdown":return 2;default:return 0}},It=e=>{const t=Ei(e.zoneId),i=Object.values(e.memories).map(s=>Ti(s));return Nc(e.zoneId,i,t)},ga=Q({name:"suspicion",initialState:qc,reducers:{ingestObservation:(e,t)=>{if(e.paused)return;const i=t.payload,s=i.zoneId,n=i.witnessLabel??i.witnessId,a=i.timestamp,r=e.zones[s]??(e.zones[s]=Wc(s,a)),o=Ei(s),l=pa(i.witnessId,i.targetId,i.recognitionChannel),c=r.memories[l],d=c?Ti(c):void 0,u={...i,witnessLabel:n,existing:d},h=d?Lc(d,u,o):Dc(u,o);r.memories[l]=zs(h),r.heat=It(r),r.lastObservationAt=a,r.lastUpdatedAt=a,e.lastTickAt=a},applySuspicionDecay:(e,t)=>{if(e.paused)return;const{elapsedSeconds:i,timestamp:s}=t.payload;i<=0||(Object.values(e.zones).forEach(n=>{const a=Ei(n.zoneId),r={};let o=!1;Object.entries(n.memories).forEach(([l,c])=>{const d=Ti(c),{memory:u,pruned:h}=Fc(d,i,a);if(h){o=!0;return}o=o||u.certainty!==c.certainty,r[l]=zs(u)}),o&&(n.memories=r,n.heat=It(n),n.lastUpdatedAt=s)}),e.lastTickAt=s)},setSuspicionPaused:(e,t)=>{e.paused=t.payload},suppressWitnessMemory:(e,t)=>{const{zoneId:i,memoryId:s,suppressed:n}=t.payload,a=e.zones[i];if(!a)return;const r=a.memories[s];r&&r.suppressed!==n&&(a.memories[s]={...r,suppressed:n},a.heat=It(a))},purgeWitnessMemories:(e,t)=>{const{witnessId:i,zoneId:s}=t.payload;(s?[s]:Object.keys(e.zones)).forEach(a=>{const r=e.zones[a];if(!r)return;const o=Object.keys(r.memories).length;if(o===0)return;const l={};Object.entries(r.memories).forEach(([c,d])=>{d.witnessId!==i&&(l[c]=d)}),Object.keys(l).length!==o&&(r.memories=l,r.heat=It(r))})},resetSuspicionState:()=>is()}}),{ingestObservation:wg,applySuspicionDecay:fa,setSuspicionPaused:Pg,suppressWitnessMemory:Mg,purgeWitnessMemories:Ag,resetSuspicionState:Ig}=ga.actions,xg=e=>{let t="calm";return Object.values(e).forEach(i=>{Us(i.heat.tier)>Us(t)&&(t=i.heat.tier)}),t},Vc=ga.reducer,Gc={status:"idle",reason:null,lastDecision:null},ya=Q({name:"autoBattle",initialState:Gc,reducers:{setAutoBattleStatus:(e,t)=>{e.status=t.payload.status,e.reason=t.payload.reason??null,e.status!=="running"&&(e.lastDecision=e.lastDecision?{...e.lastDecision,timestamp:Date.now()}:e.lastDecision)},recordAutoBattleDecision:(e,t)=>{e.lastDecision=t.payload,e.status="running",e.reason=null},clearAutoBattleDecision:e=>{e.lastDecision=null}}}),{setAutoBattleStatus:Ks,recordAutoBattleDecision:zc,clearAutoBattleDecision:Cg}=ya.actions,Uc=ya.reducer,Ot=e=>Math.max(Tn,Math.min(Rn,e)),di=e=>{const t=Ot(e),i=er.find(s=>t>=s.min&&t<=s.max);return(i==null?void 0:i.tier)??"calm"},Di=1,Sa=()=>({version:Di,value:12,tier:"calm",lastUpdatedAt:null,frozen:!1,respiteUntil:null,decayBoostUntil:null,decayBoostPerSecond:0,cooldowns:{},lastSnapshot:null}),Kc=Sa(),jc=()=>Q({name:"paranoia",initialState:Kc,reducers:{resetParanoiaState:()=>Sa(),tickParanoia:(e,t)=>{const{deltaMs:i,timestamp:s,decayMultiplier:n}=t.payload;if(e.frozen||i<=0){e.lastUpdatedAt=s;return}const a=Math.max(0,i)/1e3;if(a===0){e.lastUpdatedAt=s;return}const r=Math.max(0,n??1);let o=tr*r;e.decayBoostUntil&&s<e.decayBoostUntil?o+=Math.max(0,e.decayBoostPerSecond):e.decayBoostUntil&&s>=e.decayBoostUntil&&(e.decayBoostUntil=null,e.decayBoostPerSecond=0);const l=a*o;if(l>0){const c=Ot(e.value-l);e.value=c,e.tier=di(c),e.lastSnapshot={timestamp:s,delta:-l,breakdown:{gains:{},losses:{passive:l},spikes:{}},value:c,tier:e.tier}}e.lastUpdatedAt=s},applyParanoiaStimuli:(e,t)=>{const{timestamp:i,delta:s,breakdown:n,deltaMs:a}=t.payload;if(!Number.isFinite(s)||s===0&&!n)return;let r=s;e.frozen&&r>0&&(r=0);const c=1.1*Math.max(.1,(a??1e3)/1e3);r>0&&e.respiteUntil&&i<e.respiteUntil&&(r=Math.min(r,Ja.respite.maxGainPerTick)),r=Math.max(-c,Math.min(c,r));const d=Ot(e.value+r);e.value=d,e.tier=di(d),e.lastUpdatedAt=i,n&&(e.lastSnapshot={timestamp:i,delta:r,breakdown:n,value:d,tier:e.tier})},applyParanoiaRelief:(e,t)=>{const{amount:i,timestamp:s,cooldownKey:n,cooldownMs:a}=t.payload,r=Math.max(0,i);if(r===0)return;if(n&&a){const l=e.cooldowns[n];if(typeof l=="number"&&l>s)return;e.cooldowns[n]=s+a}const o=Ot(e.value-r);e.value=o,e.tier=di(o),e.lastUpdatedAt=s,e.lastSnapshot={timestamp:s,delta:-r,breakdown:{gains:{},losses:{relief:r},spikes:{}},value:o,tier:e.tier}},setParanoiaRespite:(e,t)=>{const{durationMs:i,timestamp:s}=t.payload,n=Math.max(0,i);e.respiteUntil=s+n},setParanoiaDecayBoost:(e,t)=>{const{amountPerSecond:i,durationMs:s,timestamp:n}=t.payload;if(i<=0||s<=0){e.decayBoostUntil=null,e.decayBoostPerSecond=0;return}e.decayBoostPerSecond=i,e.decayBoostUntil=n+s},setParanoiaFrozen:(e,t)=>{e.frozen=t.payload},clearParanoiaSnapshot:e=>{e.lastSnapshot=null}}}),va=jc(),{resetParanoiaState:$c,tickParanoia:kg,applyParanoiaStimuli:Tg,applyParanoiaRelief:Rg,setParanoiaRespite:Eg,setParanoiaDecayBoost:_g,setParanoiaFrozen:Dg,clearParanoiaSnapshot:Lg}=va.actions,ba=va.reducer,yt=["heroic","cruel","sneaky","intimidating","competent"],Li=1,Yc={heroic:60*45,cruel:60*50,sneaky:60*35,intimidating:60*40,competent:60*55},Zc=.45,Xc=.25,js=5,dt=100,$s=60*90,Qc=.1,Jc=5,Ys=6,Ge={minor:.4,moderate:.65,major:.85,legendary:1},ed=.1,td=yt.reduce((e,t)=>(e[t]=0,e),{}),Zs=12,_=(e,t,i)=>Number.isFinite(e)?Math.max(t,Math.min(i,e)):t,Xs=(e,t,i)=>e+(t-e)*i,wa=(e,t)=>{const i=e.x-t.x,s=e.y-t.y;return Math.sqrt(i*i+s*s)},ss=e=>{const t=Math.floor(e.x/Zs),i=Math.floor(e.y/Zs);return`${t}:${i}`},id=(e,t,i,s)=>{const n=t.x-e.x,a=t.y-e.y,r=Math.sqrt(n*n+a*a),o=Math.max(1,Math.floor(r/i));for(let l=1;l<=o;l+=1){const c=l/(o+1);s({x:Xs(e.x,t.x,c),y:Xs(e.y,t.y,c)})}},sd=(e,t,i)=>{let s=0,n=0;const a=o=>{if(!o){s+=1;return}!o.isWalkable||o.type===R.WALL?s+=1:o.type===R.DOOR&&(s+=.5)};if(id(t,i,1.25,o=>{var d;const l=Math.round(o.x),c=Math.round(o.y);a((d=e.tiles[c])==null?void 0:d[l]),n+=1}),n===0)return 1;const r=s/n;return _(1-r,.1,1)},xt={base:.7,noiseLevel:.6,lightingFactor:.85,disguiseFactor:.8},nd=e=>({base:_((e==null?void 0:e.base)??xt.base,0,1),noiseLevel:_((e==null?void 0:e.noiseLevel)??xt.noiseLevel,0,1),lightingFactor:_((e==null?void 0:e.lightingFactor)??xt.lightingFactor,0,1),disguiseFactor:_((e==null?void 0:e.disguiseFactor)??xt.disguiseFactor,0,1),crowdDensity:_((e==null?void 0:e.crowdDensity)??.5,0,1)}),ad=e=>yt.reduce((t,i)=>{const s=e[i];return typeof s=="number"&&Number.isFinite(s)&&s!==0&&(t[i]=_(s,-30,30)),t},{}),rd=e=>{const t=se(),i=typeof e.timestamp=="number"?e.timestamp:Date.now(),s=e.cellId??ss(e.position),n=nd(e.visibility),a=Ge[e.intensity]??Ge.minor,r=ad(Object.keys(e.traits??{}).reduce((o,l)=>{var c;if(yt.includes(l)){const d=l;o[d]=_(((c=e.traits)==null?void 0:c[d])??0,-40,40)*a}return o},{}));return{id:t,actorId:e.actorId,actorLabel:e.actorLabel??"Player",zoneId:e.zoneId,cellId:s,position:{...e.position},intensity:e.intensity,traits:r,tags:[...e.tags],timestamp:i,visibility:n,metadata:e.metadata?{...e.metadata}:void 0}},od=24,Qs={resistance:{heroic:1,cruel:-.6,sneaky:.25,intimidating:-.1,competent:.5},corpsec:{heroic:-.2,cruel:.4,sneaky:-.4,intimidating:.8,competent:.6},scavengers:{heroic:.2,cruel:.1,sneaky:.8,intimidating:.3,competent:.4},civilians:{heroic:.8,cruel:-.8,sneaky:-.1,intimidating:-.2,competent:.4}},ld=(e,t)=>{var a,r,o;const i=e.reputationBias??Qs[t??""]??Qs.civilians,s=(a=e.socialTags)!=null&&a.includes("gossip_hub")?.35:.55,n=(r=e.socialTags)!=null&&r.includes("gossip_hub")?.75:(o=e.socialTags)!=null&&o.includes("guard")?.25:.5;return{traitWeights:{...i},skepticism:_(s,.15,.85),appetiteForRumors:_(n,.15,.9)}},cd=(e,t)=>{var i,s,n;return e.factionId?e.factionId:(i=e.socialTags)!=null&&i.includes("corpsec")?"corpsec":(s=e.socialTags)!=null&&s.includes("scavenger")?"scavengers":(n=e.socialTags)!=null&&n.includes("resistance")?"resistance":t},dd=(e,t)=>_(e*t,.2,1.1),ud=(e,t)=>_(e-(typeof t=="number"?t:0),.25,1),hd=({visibilityScore:e,distanceFactor:t,lineOfSight:i,npc:s})=>{var r,o;const n=(r=s.socialTags)!=null&&r.includes("sentinel")?.15:(o=s.socialTags)!=null&&o.includes("guard")?.1:0,a=e*.65+t*.2+i*.15+n;return _(a,0,1)},pd=({event:e,mapArea:t,npcs:i,ambientLighting:s,ambientNoise:n,disguisePenalty:a,maxDistance:r=od,visibilityThreshold:o=Zc})=>{const l=i??t.entities.npcs;return l.length?l.map(c=>{var A;const d=wa(c.position,e.position);if(d>r)return null;const u=_(1-d/(r+1),0,1),h=sd(t,c.position,e.position),g=dd(s,e.visibility.lightingFactor),p=_(n*.35+e.visibility.noiseLevel*.65,.1,1),m=ud(e.visibility.disguiseFactor,a),f=_(e.visibility.base*u*h*g*(.5+p*.5)*(1-(1-m)*.6),0,1);if(f<Xc)return null;const b=cd(c,((A=t.factionRequirement)==null?void 0:A.factionId)??null),S=ld(c,b),M=hd({visibilityScore:f,distanceFactor:u,lineOfSight:h,npc:c}),v=f<o;return{witnessId:c.id,name:c.name,factionId:b,zoneId:e.zoneId,cellId:ss(c.position),position:{...c.position},distance:d,lineOfSight:h,distanceFactor:u,lightingFactor:g,noiseFactor:p,disguiseFactor:m,visibilityScore:f,baseConfidence:M,isRumorOnly:v,bias:S}}).filter(c=>!!c).sort((c,d)=>d.visibilityScore-c.visibilityScore):[]},md=(e,t,i)=>{var n;const s=(n=t.traitWeights)==null?void 0:n[e];return typeof s=="number"&&s!==0?i*s:i},gd=(e,t,i,s)=>{const n=i?.45+(1-s.appetiteForRumors)*.3:0,r=e*_(t/30,.25,1)*(1-s.skepticism)*(1-n);return _(r,0,1)},fd=(e,t,i,s)=>{if(t===0)return null;const n=gd(i,Math.abs(t),s.isRumorOnly,s.bias);return n<ed?null:{trait:e,delta:t,confidence:n,source:s.isRumorOnly?"rumor":"witness"}},yd=({event:e,candidates:t,timestamp:i})=>{if(!t.length)return[];const s=e.traits??{},n=Ge[e.intensity]??Ge.minor,a=typeof i=="number"?i:e.timestamp;return t.map(r=>{const o=_(r.baseConfidence*(r.isRumorOnly?.65:1),0,1),l=Object.entries(s).map(([d,u])=>{const h=d,g=md(h,r.bias,u??0)*n*(r.isRumorOnly?.6:1);return fd(h,g,o,r)}).filter(d=>d?d.delta!==0:!1);if(!l.length)return null;const c=_(l.reduce((d,u)=>d+u.confidence,0)/l.length,0,1);return{id:se(),eventId:e.id,witnessId:r.witnessId,witnessName:r.name,factionId:r.factionId,zoneId:r.zoneId,cellId:r.cellId,timestamp:a,visibilityScore:r.visibilityScore,confidence:c,isRumorOnly:r.isRumorOnly,traits:l}}).filter(r=>!!r)},Pa=22,Sd=5,vd=(e,t,i)=>({id:`${e}::${t}`,fromId:e,toId:t,weight:_(i,.05,1),latencySeconds:_(60*(1.2-i),20,120),remainingEnergy:Ys*i,maxEnergy:Ys,lastSharedAt:null}),bd=(e,t,i)=>{var a;let s=_(1-i/(Pa+1),0,1);const n=(a=e.socialTags)==null?void 0:a.filter(r=>{var o;return(o=t.socialTags)==null?void 0:o.includes(r)});return n!=null&&n.length&&(s+=n.length*.08),e.factionId&&t.factionId&&e.factionId===t.factionId&&(s+=.15),_(s,0,1)},wd=({mapArea:e,npcs:t})=>{const i=t??e.entities.npcs;if(i.length<2)return[];const s=[];return i.forEach(n=>{i.filter(r=>r.id!==n.id).map(r=>{const o=wa(n.position,r.position);if(o>Pa)return null;const l=bd(n,r,o);return l<=0?null:{other:r,weight:l}}).filter(r=>!!r).sort((r,o)=>o.weight-r.weight).slice(0,Sd).forEach(({other:r,weight:o})=>{s.push(vd(n.id,r.id,o))})}),s},Pd=(e,t)=>{const i=_(Math.abs(e)/dt,0,1);return _(i*t,0,1)},Md=(e,t,i)=>`${e}:${t}:${i}`,Ad=(e,t)=>{if(!t.length)return[];const i={},s=Ge[e.intensity]??Ge.minor;return t.forEach(n=>{n.traits.forEach(a=>{const r=Pd(a.delta,a.confidence)*s;if(r<=Qc)return;const o=n.witnessId,l=a.delta>=0?1:-1;i[o]||(i[o]={carrierId:o,cellId:n.cellId,zoneId:n.zoneId,rumors:[]});const c=Md(o,a.trait,e.id);i[o].rumors.push({id:c,eventId:e.id,originWitnessId:n.witnessId,carrierId:o,trait:a.trait,polarity:l,strength:_(r,0,1),confidence:_(a.confidence,0,1),ttlSeconds:$s,decayRate:1/$s,lastUpdatedAt:n.timestamp,originCellId:n.cellId,originZoneId:n.zoneId,intensity:e.intensity})})}),Object.values(i).map(n=>({...n,rumors:n.rumors.slice(0,Jc)}))},Id=()=>{const e=Date.now();return yt.reduce((t,i)=>(t[i]={value:td[i]??0,confidence:0,lastUpdatedAt:e,decaySeconds:Yc[i]??60*45,sources:[]},t),{})},xd=(e,t,i,s,n,a)=>({id:e,scope:t,label:i,factionId:n,cellId:a,traits:Id(),updatedAt:s}),Cd={version:Li,events:{},witnessRecords:{},recordsByEvent:{},profiles:{},carriers:{},edges:{},debug:{heatmapEnabled:!1},lastTickAt:null},kd=(e,t,i,s,n,a,r)=>{let o=e.profiles[t];return o||(o=xd(t,s,i,n,a,r),e.profiles[t]=o),o},Td=(e,t,i)=>{const s=e.traits[t.trait];s&&(s.value=_(s.value+t.delta,-dt,dt),s.confidence=_(s.confidence+t.confidence*(1-s.confidence*.5),0,1),s.lastUpdatedAt=i,t.sourceRecordId&&(s.sources.unshift(t.sourceRecordId),s.sources.length>js&&(s.sources.length=js)),e.updatedAt=i)},Js=(e,t,i)=>{t.forEach(s=>{const n=s.scopeId,a=s.scope==="witness"?`Witness::${s.scopeId}`:s.scope==="cell"?`Cell ${s.scopeId}`:`Faction ${s.scopeId}`,r=kd(e,n,a,s.scope,i,s.scope==="faction"?s.factionId:null,s.scope==="cell"?s.cellId:null);Td(r,s,i)})},en=(e,t)=>{t.forEach(i=>{e.carriers[i.carrierId]={carrierId:i.carrierId,cellId:i.cellId,zoneId:i.zoneId,rumors:i.rumors.map(s=>({...s}))}})},tn=(e,t)=>{t.forEach(i=>{const s=e.edges[i.id];e.edges[i.id]=s?{...s,remainingEnergy:i.remainingEnergy,lastSharedAt:i.lastSharedAt??s.lastSharedAt}:{...i}})},Rd=(e,t,i)=>{yt.forEach(s=>{const n=e.traits[s];if(!n)return;const a=_(t/n.decaySeconds,0,1);if(a<=0)return;const r=n.value*a*.5;n.value=_(n.value-r,-dt,dt),n.confidence=_(n.confidence*(1-a*.6),0,1),n.lastUpdatedAt=i,Math.abs(n.value)<.01&&(n.value=0),n.confidence<.02&&(n.confidence=0,n.sources=[])}),e.updatedAt=i},sn=e=>{Object.entries(e.carriers).forEach(([t,i])=>{i.rumors.length||delete e.carriers[t]})},Ma=Q({name:"reputation",initialState:Cd,reducers:{applyEventIntegration:(e,t)=>{const{event:i,records:s,profileMutations:n,carriers:a,edges:r}=t.payload;e.events[i.id]=i,e.recordsByEvent[i.id]=s.map(o=>o.id),s.forEach(o=>{e.witnessRecords[o.id]=o}),Js(e,n,i.timestamp),en(e,a),tn(e,r),sn(e),e.lastTickAt=i.timestamp},applyDecay:(e,t)=>{const{timestamp:i,elapsedSeconds:s}=t.payload;Object.values(e.profiles).forEach(n=>Rd(n,s,i)),Object.values(e.edges).forEach(n=>{n.remainingEnergy=_(Math.min(n.remainingEnergy+s*.05,n.maxEnergy),0,n.maxEnergy)}),e.lastTickAt=i},applyPropagationResult:(e,t)=>{const{carriers:i,edges:s,profileMutations:n}=t.payload;en(e,i),tn(e,s),sn(e);const a=Date.now();Js(e,n,a),e.lastTickAt=a},toggleReputationHeatmap:(e,t)=>{e.debug.heatmapEnabled=t.payload},setInspectorTarget:(e,t)=>{e.debug.inspectorTargetId=t.payload}}}),{applyEventIntegration:Ed,applyDecay:Fg,applyPropagationResult:Bg,toggleReputationHeatmap:Og,setInspectorTarget:Ng}=Ma.actions,Fi=Ma.reducer,_d=(e,t)=>{const i=t==="night"?.55:t==="evening"||t==="morning"?.75:1;return e.flags.blackoutTier==="rolling"?i*.4:e.flags.blackoutTier==="brownout"?i*.65:i},Dd=e=>{switch(e.flags.gangHeat){case"high":return .85;case"med":return .7;default:return .55}},Ld=e=>{var a;const t=((a=e.skillTraining)==null?void 0:a.stealth)??0,i=e.skills.agility??5,s=Math.min(t/160,.25),n=Math.max(0,(i-6)*.03);return _(.4-(s+n),0,.4)},Fd=e=>{const t=[];return e.forEach(i=>{i.traits.forEach(s=>{const n=s.confidence;t.push({scopeId:i.witnessId,scope:"witness",factionId:i.factionId,cellId:i.cellId,trait:s.trait,delta:s.delta,confidence:s.confidence,sourceRecordId:i.id,witnessId:i.witnessId}),i.factionId&&t.push({scopeId:i.factionId,scope:"faction",factionId:i.factionId,cellId:null,trait:s.trait,delta:s.delta*(.55+n*.2),confidence:s.confidence*.7,sourceRecordId:i.id,witnessId:i.witnessId}),t.push({scopeId:i.cellId,scope:"cell",factionId:i.factionId,cellId:i.cellId,trait:s.trait,delta:s.delta*(.7+n*.15),confidence:s.confidence*.8,sourceRecordId:i.id,witnessId:i.witnessId})})}),t},Hg=e=>(t,i)=>{const s=i();if(!s.settings.reputationSystemsEnabled)return;const n=s.world,a=s.player.data,r=e.mapArea??n.currentMapArea,o=e.ambientLighting??_d(n.environment,n.timeOfDay),l=e.ambientNoise??Dd(n.environment),c=e.disguisePenalty??Ld(a),d=rd({...e,zoneId:e.zoneId??r.zoneId??n.currentMapArea.zoneId,cellId:e.cellId??ss(e.position)}),u=pd({event:d,mapArea:r,npcs:e.npcsOverride,ambientLighting:o,ambientNoise:l,disguisePenalty:c});if(!u.length)return;const h=yd({event:d,candidates:u,timestamp:d.timestamp}),g=Fd(h),p=Ad(d,h),m=wd({mapArea:r});t(Ed({event:d,records:h,profileMutations:g,carriers:p,edges:m}))},Bd={override:null},Aa=Q({name:"hudLayout",initialState:Bd,reducers:{setHudLayoutOverride:(e,t)=>{e.override=t.payload},clearHudLayoutOverride:e=>{e.override=null}}}),{setHudLayoutOverride:Wg,clearHudLayoutOverride:qg}=Aa.actions,Od=Aa.reducer;var Nd={};const ns="the-getaway-state",Ia=typeof window<"u",nn=typeof process<"u"&&typeof Nd.JEST_WORKER_ID<"u",Hd={player:No,world:ea,quests:kl,log:ac,settings:aa,autoBattle:Uc,combatFeedback:dc,missions:sc,surveillance:la,storylets:kc,suspicion:Vc,paranoia:ba,reputation:Fi,hudLayout:Od},je=ir(Hd),Wd=sr("app/resetGame"),Vg=ns,Ct=(e,t)=>Array.isArray(e)?[...e]:[...t],qd=e=>{if(!e)return{...G,version:lt,data:{...G.data,perks:[...G.data.perks],perkRuntime:{...G.data.perkRuntime},factionReputation:{...G.data.factionReputation}},pendingLevelUpEvents:[...G.pendingLevelUpEvents],xpNotifications:[...G.xpNotifications],pendingFactionEvents:[...G.pendingFactionEvents]};const t=e.data??null,i={...G.data,...t??{},perks:Ct(t==null?void 0:t.perks,G.data.perks),perkRuntime:{...G.data.perkRuntime,...(t==null?void 0:t.perkRuntime)??{}},factionReputation:{...G.data.factionReputation,...(t==null?void 0:t.factionReputation)??{}}};return{version:lt,data:i,pendingLevelUpEvents:Ct(e.pendingLevelUpEvents,G.pendingLevelUpEvents),xpNotifications:Ct(e.xpNotifications,G.xpNotifications),pendingFactionEvents:Ct(e.pendingFactionEvents,G.pendingFactionEvents)}},Vd=e=>{if(!e||e.version!==Di)return ba(void 0,$c());const t=typeof e.value=="number"?e.value:0,i=Number.isFinite(t)?t:0,s=Math.max(Tn,Math.min(Rn,i)),n=Number.isFinite(e.decayBoostPerSecond)?Math.max(0,e.decayBoostPerSecond):0;return{version:Di,value:s,tier:e.tier??"calm",lastUpdatedAt:typeof e.lastUpdatedAt=="number"?e.lastUpdatedAt:null,frozen:!!e.frozen,respiteUntil:typeof e.respiteUntil=="number"?e.respiteUntil:null,decayBoostUntil:typeof e.decayBoostUntil=="number"?e.decayBoostUntil:null,decayBoostPerSecond:n,cooldowns:{...e.cooldowns??{}},lastSnapshot:e.lastSnapshot??null}},Gd=e=>({zoneId:e.zoneId,memories:{...e.memories},heat:{zoneId:e.heat.zoneId,totalHeat:e.heat.totalHeat,tier:e.heat.tier,leadingWitnessIds:[...e.heat.leadingWitnessIds]},lastUpdatedAt:e.lastUpdatedAt,lastObservationAt:e.lastObservationAt}),zd=e=>{if(!e||e.version!==_i)return is();const t={};return e.zones&&Object.entries(e.zones).forEach(([i,s])=>{s&&(t[i]=Gd(s))}),{version:_i,zones:t,paused:!!e.paused,lastTickAt:typeof e.lastTickAt=="number"?e.lastTickAt:null}},Ud=e=>{if(!e||e.version!==Li)return Fi(void 0,{type:"@@INIT"});const t=Fi(void 0,{type:"@@INIT"});return{...t,...e,events:{...e.events??{}},witnessRecords:{...e.witnessRecords??{}},recordsByEvent:{...e.recordsByEvent??{}},profiles:{...e.profiles??{}},carriers:{...e.carriers??{}},edges:{...e.edges??{}},debug:{...t.debug,...e.debug??{}},lastTickAt:typeof e.lastTickAt=="number"?e.lastTickAt:null,version:Li}},Kd=e=>{const t=ea(void 0,{type:"@@INIT"});if(!e)return t;const i={...e,environment:{...e.environment,flags:{...e.environment.flags},weather:{...e.environment.weather},signage:{...e.environment.signage},rumorSets:{...e.environment.rumorSets??{}},notes:Array.isArray(e.environment.notes)?[...e.environment.notes]:[...t.environment.notes]}},s=Zn||wl;return i.currentTime=s,i.timeOfDay=Ve(s,H),i.curfewActive=ct(s,H),i},jd=e=>{const t=la(void 0,{type:"@@INIT"});return e?{zones:e.zones?{...e.zones}:{},hud:{...t.hud,...e.hud??{},overlayEnabled:!0},curfewBanner:e.curfewBanner?{...e.curfewBanner}:{...t.curfewBanner}}:t},$d=e=>{const t=aa(void 0,{type:"@@INIT"});return e?{...t,...e,visualQualityPreset:e.visualQualityPreset??t.visualQualityPreset}:t},Yd=()=>{if(Ia)try{const e=window.localStorage.getItem(ns);return e?JSON.parse(e):void 0}catch(e){console.warn("[store] Failed to load state from localStorage:",e);return}},Zd=e=>{if(Ia)try{const t=JSON.stringify(e);window.localStorage.setItem(ns,t)}catch(t){console.warn("[store] Failed to save state to localStorage:",t)}},Xd=e=>{if(e)return{...e,player:qd(e.player),suspicion:zd(e.suspicion),paranoia:Vd(e.paranoia),world:Kd(e.world),surveillance:jd(e.surveillance),reputation:Ud(e.reputation),settings:$d(e.settings)}},Qd=(e,t)=>{if(Wd.match(t)){const i=e==null?void 0:e.settings;let s=je(void 0,t);return i&&(s=je(s,Cl(i.locale)),s=je(s,Il(i.locale)),s=je(s,ic(i.locale)),s={...s,settings:i}),s}return je(e,t)},Jd=Yd(),eu=Xd(Jd),D=nr({reducer:Qd,preloadedState:eu,middleware:e=>e({serializableCheck:nn?!1:{ignoredActions:["app/resetGame"],warnAfter:128},immutableCheck:nn?!1:{warnAfter:128}})});D.subscribe(()=>{const e=D.getState(),t={player:e.player,world:e.world,quests:e.quests,log:e.log,settings:e.settings,autoBattle:e.autoBattle,combatFeedback:e.combatFeedback,missions:e.missions,surveillance:e.surveillance,storylets:e.storylets,suspicion:e.suspicion,paranoia:e.paranoia,reputation:e.reputation,hudLayout:e.hudLayout};Zd(t)});const ui=1023,W=Object.freeze({TILE_BASE:0,TILE_OVERLAY:48,PROP_LOW:96,PROP_TALL:128,CHARACTER_BASE:160,CHARACTER:192,EFFECT:224,FLOATING_UI:256,PATH_PREVIEW:288,OVERLAY:960,DEBUG:992}),Oe=Object.freeze({BACKDROP:-20,MAP_BASE:-5,VISION_OVERLAY:2,PATH_PREVIEW:4,COVER_DEBUG:5,DAY_NIGHT_OVERLAY:100}),as=(e,t,i=0)=>{const s=(Math.floor(e)&ui)>>>0,n=Math.floor(t),a=P.Math.Clamp(Math.floor(i),-ui,ui);return(n<<10)+s+a};class tu{constructor(t){y(this,"registrations",new Map);y(this,"destroyed",!1);this.scene=t,this.handlePreUpdate=this.handlePreUpdate.bind(this),this.destroy=this.destroy.bind(this),this.scene.events.on(P.Scenes.Events.PRE_UPDATE,this.handlePreUpdate),this.scene.events.once(P.Scenes.Events.SHUTDOWN,this.destroy)}registerStatic(t,i){if(this.registrations.has(t))return;const s={target:t,staticDepth:i};this.attachRegistration(t,s),this.applyRegistration(s)}getRegistration(t){return this.registrations.get(t)}refresh(t){const i=this.registrations.get(t);i&&this.applyRegistration(i)}unregister(t){this.registrations.delete(t)}destroy(){this.destroyed||(this.destroyed=!0,this.scene.events.off(P.Scenes.Events.PRE_UPDATE,this.handlePreUpdate),this.scene.events.off(P.Scenes.Events.SHUTDOWN,this.destroy),this.registrations.clear())}upsertDynamic(t,i,s){const n=this.registrations.get(t);if(n){n.dynamicPoint=i,n.dynamicBias=s,n.staticDepth=void 0,this.applyRegistration(n);return}const a={target:t,dynamicPoint:i,dynamicBias:s};this.attachRegistration(t,a),this.applyRegistration(a)}attachRegistration(t,i){this.registrations.set(t,i),t.once(P.GameObjects.Events.DESTROY,()=>this.unregister(t))}handlePreUpdate(){this.destroyed||this.registrations.forEach(t=>{t.dynamicPoint&&this.applyRegistration(t)})}applyRegistration(t){const{target:i,staticDepth:s,dynamicPoint:n}=t;let a=s;n&&(a=as(n.x,n.y,t.dynamicBias??0)),!(a===void 0||a===t.lastApplied)&&(i.setDepth(a),t.lastApplied=a)}}const xa=(e,t,i,s,n)=>{if(e){const a={x:i,y:s};e.upsertDynamic(t,a,n)}else t.setDepth(as(i,s,n))},Le=(e,t,i)=>Math.max(t,Math.min(i,e)),iu=e=>({r:e>>16&255,g:e>>8&255,b:e&255}),an=(e,t,i)=>(e&255)<<16|(t&255)<<8|i&255,ue=(e=Yt)=>{const t=e,i=e/2;return{tileWidth:t,tileHeight:i,halfTileWidth:t/2,halfTileHeight:i/2}},de=(e,t,i,s,n=Yt)=>{const a=ue(n),r=(e-t)*a.halfTileWidth+i,o=(e+t)*a.halfTileHeight+s;return{x:r,y:o}},Z=(e,t,i,s)=>{const n=i/2,a=s/2;return[{x:e,y:t-a},{x:e+n,y:t},{x:e,y:t+a},{x:e-n,y:t}]},k=(e,t)=>{const{r:i,g:s,b:n}=iu(e);if(t>=0){const c=Le(Math.round(i+(255-i)*t),0,255),d=Le(Math.round(s+(255-s)*t),0,255),u=Le(Math.round(n+(255-n)*t),0,255);return an(c,d,u)}const a=Math.max(0,1+t),r=Le(Math.round(i*a),0,255),o=Le(Math.round(s*a),0,255),l=Le(Math.round(n*a),0,255);return an(r,o,l)};class su{constructor(t,i=Yt,s){y(this,"originX",0);y(this,"originY",0);this.scene=t,this.tileSize=i,this.depthManager=s}assignDepth(t,i,s,n){xa(this.depthManager,t,i,s,n)}setIsoOrigin(t,i){return this.originX=t,this.originY=i,this}createCrate(t,i,s={}){const n=ue(this.tileSize),{x:a,y:r}=de(t,i,this.originX,this.originY,this.tileSize),o=s.scale??.55,l=s.height??.65,c=s.alpha??1,d=s.tint??9262372,u=k(d,.2),h=k(d,-.12),g=k(d,-.35),p=this.scene.add.graphics();p.setAlpha(c);const m=n.tileHeight*l,f=n.tileWidth*o,b=n.tileHeight*o,S=Z(a,r-m,f,b),M=Z(a,r,f,b),v=[M[3],M[0],S[0],S[3]],A=[M[0],M[1],S[1],S[0]];return p.fillStyle(h,1),p.fillPoints(v,!0),p.fillStyle(k(h,-.05),1),p.fillPoints(A,!0),p.fillStyle(u,1),p.fillPoints(S,!0),p.lineStyle(1.2,g,.8),p.strokePoints(M,!0),p.strokePoints(S,!0),this.assignDepth(p,a,r,W.PROP_LOW),p}createHighlightDiamond(t,i,s={}){const{x:n,y:a}=de(t,i,this.originX,this.originY,this.tileSize),r=ue(this.tileSize),o=r.tileWidth*(s.widthScale??1),l=r.tileHeight*(s.heightScale??1),c=s.color??6333946,d=s.alpha??.3,u=Z(n,a,o,l),h=this.scene.add.graphics();return h.fillStyle(c,d),h.fillPoints(u,!0),h.lineStyle(1.5,k(c,.2),d+.2),h.strokePoints(u,!0),this.assignDepth(h,n,a,W.TILE_OVERLAY),h}createCharacterBase(t,i,s={}){const n=this.scene.add.graphics();return this.updateCharacterBase(n,t,i,s),n}createBarricade(t,i,s={}){const n=ue(this.tileSize),{x:a,y:r}=de(t,i,this.originX,this.originY,this.tileSize),o=s.tint??4937059,l=n.tileWidth*(s.widthScale??.9),c=n.tileHeight*.32*(s.height??1),d=n.tileHeight*.34,u=Z(a,r-c,l,d).map(S=>new P.Geom.Point(S.x,S.y)),h=Z(a,r,l,d).map(S=>new P.Geom.Point(S.x,S.y)),g=[h[3],h[0],u[0],u[3]],p=[h[0],h[1],u[1],u[0]],m=[h[1],h[2],u[2],u[1]],f=this.scene.add.graphics();f.fillStyle(o,.96),f.fillPoints(m,!0),f.fillStyle(o,.92),f.fillPoints(g,!0),f.fillStyle(o,.88),f.fillPoints(p,!0),f.lineStyle(1.5,k(o,.18),.9),f.strokePoints(h,!0),f.strokePoints(u,!0);const b=W.PROP_TALL+(s.depthOffset??0);return this.assignDepth(f,a,r,b),f}createStreetLight(t,i,s={}){const n=ue(this.tileSize),{x:a,y:r}=de(t,i,this.originX,this.originY,this.tileSize),o=s.baseColor??988970,l=s.poleColor??1976635,c=s.glowColor??3718648,d=s.height??1.2,u=s.widthScale??.42,h=this.scene.add.container(a,r),g=this.scene.add.graphics(),p=Z(0,0,n.tileWidth*u,n.tileHeight*.32).map(x=>new P.Geom.Point(x.x,x.y));g.fillStyle(o,.95),g.fillPoints(p,!0),g.lineStyle(1.2,k(o,.18),.9),g.strokePoints(p,!0);const m=this.scene.add.graphics(),f=n.tileHeight*(1.8*d),b=Math.max(2,n.tileWidth*.05);m.fillStyle(l,1),m.fillRect(-b/2,-f,b,f),m.setAlpha(.95);const S=this.scene.add.graphics(),M=n.tileWidth*.55,v=n.tileHeight*.3,A=Z(0,-f,M,v).map(x=>new P.Geom.Point(x.x,x.y));S.fillStyle(k(c,-.4),.96),S.fillPoints(A,!0),S.lineStyle(1.2,k(c,.2),.9),S.strokePoints(A,!0);const I=this.scene.add.graphics();return I.fillStyle(c,s.glowAlpha??.22),I.fillEllipse(0,n.tileHeight*.05,n.tileWidth*.9,n.tileHeight*.36),I.setBlendMode(P.BlendModes.ADD),h.add([I,g,m,S]),this.assignDepth(h,a,r,W.PROP_TALL+16),h}createBillboard(t,i,s={}){const n=ue(this.tileSize),{x:a,y:r}=de(t,i,this.originX,this.originY,this.tileSize),o=s.baseColor??1120295,l=s.glowColor??3718648,c=s.panelColor??k(l,-.2),d=s.accentColor??k(l,.25),u=s.widthScale??.9,h=s.heightScale??1.1,g=this.scene.add.container(a,r),p=this.scene.add.graphics(),m=Z(0,0,n.tileWidth*.45,n.tileHeight*.28).map(T=>new P.Geom.Point(T.x,T.y));p.fillStyle(o,.94),p.fillPoints(m,!0),p.lineStyle(1.3,k(o,.15),.9),p.strokePoints(m,!0);const f=this.scene.add.graphics(),b=n.tileHeight*1.35*h,S=Math.max(2,n.tileWidth*.04);f.fillStyle(k(o,.1),1),f.fillRect(-S/2,-b,S,b);const M=this.scene.add.graphics(),v=n.tileWidth*u,A=n.tileHeight*.6*h,I=[new P.Geom.Point(-v/2,-b),new P.Geom.Point(v/2,-b-A*.18),new P.Geom.Point(v/2,-b-A),new P.Geom.Point(-v/2,-b-A*.82)];M.fillStyle(c,.93),M.fillPoints(I,!0),M.lineStyle(1.6,d,.95),M.strokePoints(I,!0);const x=this.scene.add.graphics();return x.fillStyle(l,s.glowAlpha??.25),x.fillEllipse(0,-b-A*.6,v*1.1,A*1.4),x.setBlendMode(P.BlendModes.ADD),g.add([x,p,f,M]),this.assignDepth(g,a,r,W.PROP_TALL+12),g}createPulsingHighlight(t,i,s={}){var I,x;const n=ue(this.tileSize),{x:a,y:r}=de(t,i,this.originX,this.originY,this.tileSize),o=n.tileWidth*(s.widthScale??.8),l=n.tileHeight*(s.heightScale??.8),c=s.color??3718648,d=s.alpha??.2,u=s.pulseColor??k(c,.1),h=s.pulseScale??1.18,g=((I=s.pulseAlpha)==null?void 0:I.from)??d,p=((x=s.pulseAlpha)==null?void 0:x.to)??.05,m=s.duration??1350,f=s.depthOffset??5,b=this.scene.add.container(a,r),S=(T,O,w)=>{const C=Z(0,0,o,l).map(F=>new P.Geom.Point(F.x,F.y));T.clear(),T.fillStyle(O,w),T.fillPoints(C,!0),T.lineStyle(1.3,k(O,.2),Math.min(1,w+.1)),T.strokePoints(C,!0)},M=this.scene.add.graphics();S(M,c,d);const v=this.scene.add.graphics();S(v,u,g),b.add([v,M]),this.assignDepth(b,a,r,W.EFFECT+f);const A=this.scene.tweens.add({targets:v,alpha:{from:g,to:p},scaleX:{from:1,to:h},scaleY:{from:1,to:h},duration:m,ease:"Sine.easeInOut",yoyo:!0,repeat:-1});return b.setData("pulseTween",A),b.once(P.GameObjects.Events.DESTROY,()=>{A&&A.isPlaying()&&A.stop()}),b}createSpriteTile(t,i,s,n={}){var a,r;return this.createIsoSprite(t,i,s,{textureKey:n.textureKey,depthBias:n.depthBias??W.TILE_BASE,origin:{x:((a=n.origin)==null?void 0:a.x)??.5,y:((r=n.origin)==null?void 0:r.y)??.5},normalTextureKey:n.normalTextureKey})}createSpriteProp(t,i,s,n={}){var a,r;return this.createIsoSprite(t,i,s,{textureKey:n.textureKey,depthBias:n.depthBias??W.PROP_TALL,origin:{x:((a=n.origin)==null?void 0:a.x)??.5,y:((r=n.origin)==null?void 0:r.y)??.85},normalTextureKey:n.normalTextureKey})}positionSprite(t,i,s,n){const{x:a,y:r}=de(i,s,this.originX,this.originY,this.tileSize);t.setPosition(a,r);const o=n??t.getData("isoDepthBias")??W.PROP_TALL;this.assignDepth(t,a,r,o),t.setData("isoGrid",{x:i,y:s})}updateCharacterBase(t,i,s,n){const a=t.getData("isoOptions")??{},r={baseColor:(n==null?void 0:n.baseColor)??a.baseColor??1120295,outlineColor:(n==null?void 0:n.outlineColor)??a.outlineColor??k(1120295,.25),alpha:(n==null?void 0:n.alpha)??a.alpha??.85,widthScale:(n==null?void 0:n.widthScale)??a.widthScale??.82,heightScale:(n==null?void 0:n.heightScale)??a.heightScale??.6,depthOffset:(n==null?void 0:n.depthOffset)??a.depthOffset??2};t.setData("isoOptions",r);const{x:o,y:l}=de(i,s,this.originX,this.originY,this.tileSize),c=ue(this.tileSize),d=c.tileWidth*(r.widthScale??1),u=c.tileHeight*(r.heightScale??1),h=Z(o,l,d,u);t.clear(),t.fillStyle(r.baseColor??1120295,r.alpha??.85),t.fillPoints(h,!0),t.lineStyle(1.4,r.outlineColor??k(r.baseColor??1120295,.25),(r.alpha??.85)+.1),t.strokePoints(h,!0);const g=W.CHARACTER_BASE+(r.depthOffset??0);this.assignDepth(t,o,l,g)}createCharacterToken(t,i,s={}){const n=this.scene.add.container(0,0),a=ue(this.tileSize),r=a.tileWidth*(s.widthScale??.8),o=a.tileHeight*(s.heightScale??.5),l=a.tileHeight*(s.columnHeight??1.4),c=Math.max(.55,1-l/(a.tileHeight*3)),d=s.haloRadius??a.tileWidth*.55,u=s.baseColor??1120295,h=s.outlineColor??k(u,.25),g=s.primaryColor??3718648,p=s.accentColor??k(g,.2),m=s.glowColor??g,f=this.scene.add.graphics(),b=Z(0,0,r,o).map(w=>new P.Geom.Point(w.x,w.y));f.fillStyle(u,s.alpha??.92),f.fillPoints(b,!0),f.lineStyle(1.4,h,.9),f.strokePoints(b,!0);const S=this.scene.add.graphics(),M=Z(0,-l,r*c,o*c).map(w=>new P.Geom.Point(w.x,w.y)),v=b,A=[v[1],v[2],M[2],M[1]],I=[v[2],v[3],M[3],M[2]];S.fillStyle(k(g,-.4),.96),S.fillPoints(I,!0),S.fillStyle(k(g,-.25),.98),S.fillPoints(A,!0),S.lineStyle(1.1,k(g,.1),.88),S.strokePoints(I,!0),S.strokePoints(A,!0);const x=this.scene.add.graphics();x.fillStyle(p,.92),x.fillPoints(M,!0),x.lineStyle(1.2,k(p,.3),.95),x.strokePoints(M,!0);const T=this.scene.add.graphics();T.fillStyle(m,.2),T.fillEllipse(0,a.tileHeight*.1,d,d*.45),T.setBlendMode(P.BlendModes.ADD),n.add([T,f,S,x]);const O={container:n,base:f,column:S,beacon:x,halo:T,depthOffset:s.depthOffset??6,options:s};return this.positionCharacterToken(O,t,i),O}positionCharacterToken(t,i,s){const{x:n,y:a}=de(i,s,this.originX,this.originY,this.tileSize);t.container.setPosition(n,a);const r=W.CHARACTER+(t.depthOffset??0);this.assignDepth(t.container,n,a,r)}createIsoSprite(t,i,s,n){var d,u;const a=n.textureKey??"props",r=n.depthBias??W.PROP_TALL,o=this.scene.add.image(0,0,a,s),l=((d=n.origin)==null?void 0:d.x)??.5,c=((u=n.origin)==null?void 0:u.y)??.5;return o.setOrigin(l,c),o.setData("isoDepthBias",r),n.normalTextureKey&&(o.setData("isoNormalTexture",n.normalTextureKey),o.setData("isoLightingApplied",!1)),this.positionSprite(o,t,i,r),o}applyLightingToSprite(t,i){if(!t||!t.getData("isoNormalTexture"))return;const n=t.getData("isoLightingApplied")===!0,a=this.scene.game.renderer instanceof P.Renderer.WebGL.WebGLRenderer;i&&a&&!n?(t.setPipeline("Light2D"),t.setData("isoLightingApplied",!0)):(!i||!a)&&n&&(t.resetPipeline(),t.setData("isoLightingApplied",!1))}}class rn{constructor(){y(this,"disposables",[]);y(this,"disposed",!1)}add(t){if(this.disposed){t();return}this.disposables.push(t)}dispose(){if(!this.disposed)for(this.disposed=!0;this.disposables.length>0;){const t=this.disposables.pop();if(t)try{t()}catch(i){console.error("[DisposableBag] Failed to dispose resource.",i)}}}}const nu=(e,t,i)=>{const s=(o,l,c)=>{window.addEventListener(o,l,c),i.add(()=>window.removeEventListener(o,l,c))},n=(o,l,c)=>{document.addEventListener(o,l,c),i.add(()=>document.removeEventListener(o,l,c))},a=(o,l,c)=>{e.scale.on(o,l,c),i.add(()=>e.scale.off(o,l,c))},r=(o,l,c)=>{e.input&&(e.input.on(o,l,c),i.add(()=>{var d;(d=e.input)==null||d.off(o,l,c)}))};return{scene:e,getState:t.getState,dispatch:t.dispatch,disposables:i,listenWindow:s,listenDocument:n,listenScale:a,listenInput:r}};class au{constructor(t){y(this,"modulesByKey",new Map);y(this,"orderedModules",[]);y(this,"orderDirty",!1);this.context=t}register(t){if(this.modulesByKey.has(t.key))throw new Error(`[SceneModuleRegistry] Duplicate module key "${t.key}".`);t.init(this.context),this.modulesByKey.set(t.key,t),this.orderDirty=!0}getOrderedModules(){if(!this.orderDirty)return this.orderedModules;const t=Array.from(this.modulesByKey.keys()),i=new Map(t.map((o,l)=>[o,l])),s=new Map(t.map(o=>[o,0])),n=new Map(t.map(o=>[o,[]]));this.modulesByKey.forEach(o=>{(o.dependsOn??[]).forEach(c=>{var d;if(!this.modulesByKey.has(c))throw new Error(`[SceneModuleRegistry] Module "${o.key}" depends on missing module "${c}".`);s.set(o.key,(s.get(o.key)??0)+1),(d=n.get(c))==null||d.push(o.key)})});const a=t.filter(o=>(s.get(o)??0)===0),r=[];for(;a.length>0;){const o=a.shift();if(!o)continue;r.push(o),(n.get(o)??[]).forEach(c=>{const d=(s.get(c)??0)-1;s.set(c,d),d===0&&(a.push(c),a.sort((u,h)=>(i.get(u)??0)-(i.get(h)??0)))})}if(r.length!==this.modulesByKey.size){const o=t.filter(l=>(s.get(l)??0)>0);throw new Error(`[SceneModuleRegistry] Dependency cycle detected: ${o.join(" -> ")}.`)}return this.orderedModules=r.map(o=>{const l=this.modulesByKey.get(o);if(!l)throw new Error(`[SceneModuleRegistry] Internal error: module "${o}" not found.`);return l}),this.orderDirty=!1,this.orderedModules}onCreate(){this.getOrderedModules().forEach(t=>{var i;(i=t.onCreate)==null||i.call(t)})}onStateChange(t,i){this.getOrderedModules().forEach(s=>{var n;(n=s.onStateChange)==null||n.call(s,t,i)})}onResize(){this.getOrderedModules().forEach(t=>{var i;(i=t.onResize)==null||i.call(t)})}onUpdate(t,i){this.getOrderedModules().forEach(s=>{var n;(n=s.onUpdate)==null||n.call(s,t,i)})}onShutdown(){var i;const t=this.getOrderedModules();for(let s=t.length-1;s>=0;s-=1){const n=t[s];n&&((i=n.onShutdown)==null||i.call(n))}this.modulesByKey.clear(),this.orderedModules=[],this.orderDirty=!1}}const ru=1.25,hi=.6,kt=2.3,ou=6,on=.08,lu=1.28,cu=.22,du=340,j=(e,t)=>Reflect.get(e,t),Tt=(e,t)=>{const i=j(e,t);if(i==null)throw new Error(`[CameraModule] Missing required scene value: ${t}`);return i},ln=(e,t,i)=>{const s=j(e,t);return typeof s=="number"?s:i},K=(e,t,...i)=>{const s=j(e,t);if(typeof s!="function")throw new Error(`[CameraModule] Missing required scene method: ${t}`);return s.apply(e,i)},uu=e=>({cameras:Tt(e,"cameras"),scale:Tt(e,"scale"),sys:Tt(e,"sys"),tweens:Tt(e,"tweens"),getCurrentMapArea:()=>j(e,"currentMapArea")??null,getPlayerInitialPosition:()=>j(e,"playerInitialPosition"),getPlayerTokenContainer:()=>{const t=j(e,"playerToken");return t==null?void 0:t.container},getTileSize:()=>ln(e,"tileSize",0),setIsoOrigin:(t,i)=>{Reflect.set(e,"isoOriginX",t),Reflect.set(e,"isoOriginY",i)},ensureIsoFactory:()=>{K(e,"ensureIsoFactory")},ensureVisualPipeline:()=>{K(e,"ensureVisualPipeline")},getIsoMetrics:()=>K(e,"getIsoMetrics"),calculatePixelPosition:(t,i)=>K(e,"calculatePixelPosition",t,i),computeIsoBounds:()=>K(e,"computeIsoBounds"),renderStaticProps:()=>{K(e,"renderStaticProps")},drawBackdrop:()=>{K(e,"drawBackdrop")},drawMap:t=>{K(e,"drawMap",t)},drawBuildingMasses:()=>{K(e,"drawBuildingMasses")},drawBuildingLabels:()=>{K(e,"drawBuildingLabels")},clearPathPreview:()=>{K(e,"clearPathPreview")},resizeDayNightOverlay:()=>{K(e,"resizeDayNightOverlay")},applyOverlayZoom:()=>{K(e,"applyOverlayZoom")},emitViewportUpdate:()=>{K(e,"emitViewportUpdate")},dispatchPlayerScreenPosition:()=>{K(e,"dispatchPlayerScreenPosition")},isInCombat:()=>!!j(e,"inCombat"),readRuntimeState:()=>({isCameraFollowingPlayer:!!j(e,"isCameraFollowingPlayer"),hasInitialZoomApplied:!!j(e,"hasInitialZoomApplied"),userAdjustedZoom:!!j(e,"userAdjustedZoom"),pendingCameraRestore:!!j(e,"pendingCameraRestore"),preCombatZoom:j(e,"preCombatZoom")??null,preCombatUserAdjusted:!!j(e,"preCombatUserAdjusted"),pendingRestoreUserAdjusted:j(e,"pendingRestoreUserAdjusted")??null,baselineCameraZoom:ln(e,"baselineCameraZoom",1),cameraZoomTween:j(e,"cameraZoomTween")??null}),writeRuntimeState:t=>{Reflect.set(e,"isCameraFollowingPlayer",t.isCameraFollowingPlayer),Reflect.set(e,"hasInitialZoomApplied",t.hasInitialZoomApplied),Reflect.set(e,"userAdjustedZoom",t.userAdjustedZoom),Reflect.set(e,"pendingCameraRestore",t.pendingCameraRestore),Reflect.set(e,"preCombatZoom",t.preCombatZoom),Reflect.set(e,"preCombatUserAdjusted",t.preCombatUserAdjusted),Reflect.set(e,"pendingRestoreUserAdjusted",t.pendingRestoreUserAdjusted),Reflect.set(e,"baselineCameraZoom",t.baselineCameraZoom),Reflect.set(e,"cameraZoomTween",t.cameraZoomTween)}}),hu=()=>({isCameraFollowingPlayer:!1,hasInitialZoomApplied:!1,userAdjustedZoom:!1,pendingCameraRestore:!1,preCombatZoom:null,preCombatUserAdjusted:!1,pendingRestoreUserAdjusted:null,baselineCameraZoom:1,cameraZoomTween:null});class pu{constructor(t,i){y(this,"key","camera");y(this,"context");y(this,"ports");y(this,"runtimeState");y(this,"handleWheel",(t,i,s,n)=>{if(!this.ports.sys.isActive())return;const a=this.ports.cameras.main,r=n>0?.82:1.18,o=a.zoom,l=P.Math.Clamp(o*r,hi,kt);if(Math.abs(l-o)<5e-4)return;this.ports.isInCombat()||(this.runtimeState.userAdjustedZoom=!0),this.stopCameraZoomTween();let c=null;if(this.runtimeState.isCameraFollowingPlayer||(c=a.getWorldPoint(t.x,t.y)),a.setZoom(l),this.runtimeState.isCameraFollowingPlayer)a.setDeadzone(Math.max(120,this.ports.scale.width*.22),Math.max(160,this.ports.scale.height*.28)),this.recenterCameraOnPlayer();else{const d=a.getWorldPoint(t.x,t.y),u=((c==null?void 0:c.x)??0)-d.x,h=((c==null?void 0:c.y)??0)-d.y;a.scrollX+=u,a.scrollY+=h,this.clampCameraToBounds(a)}this.ports.applyOverlayZoom(),this.ports.emitViewportUpdate(),this.ports.isInCombat()||(this.runtimeState.baselineCameraZoom=l),this.pushRuntimeStateToPorts()});var s,n;this.ports=i??uu(t),this.runtimeState={...hu(),...(n=(s=this.ports).readRuntimeState)==null?void 0:n.call(s)},this.pushRuntimeStateToPorts()}init(t){this.context=t}onCreate(){this.context.listenInput("wheel",this.handleWheel)}onResize(){this.ports.sys.isActive()&&this.ports.getCurrentMapArea()&&(this.setupCameraAndMap(),this.enablePlayerCameraFollow(),this.ports.resizeDayNightOverlay())}onShutdown(){this.stopCameraZoomTween()}setupCameraAndMap(){const t=this.ports.getCurrentMapArea();if(!t)return;const{width:i,height:s}=t,{tileHeight:n,halfTileWidth:a,halfTileHeight:r}=this.ports.getIsoMetrics(),o=this.ports.scale.width,l=this.ports.scale.height;this.ports.setIsoOrigin((s-1)*a,n),this.ports.ensureIsoFactory(),this.ports.ensureVisualPipeline();const c=(i+s)*a,d=(i+s)*r,u=o/c,h=l/d,g=Math.min(u,h),p=P.Math.Clamp(g*ru,hi,kt),m=this.ports.cameras.main,f=this.runtimeState.pendingCameraRestore||!!this.runtimeState.cameraZoomTween;this.ports.isInCombat()||(this.runtimeState.hasInitialZoomApplied?!this.runtimeState.userAdjustedZoom&&!f&&Math.abs(m.zoom-p)>8e-4&&(this.runtimeState.userAdjustedZoom=!1,this.animateCameraZoom(p)):f||m.setZoom(p));const b=this.ports.computeIsoBounds(),S=this.ports.getTileSize()*ou;m.setBounds(b.minX-S,b.minY-S,b.maxX-b.minX+S*2,b.maxY-b.minY+S*2);const M=(i-1)/2,v=(s-1)/2,A=this.ports.calculatePixelPosition(M,v),I=this.ports.getPlayerInitialPosition(),T=(I?this.ports.calculatePixelPosition(I.x,I.y):null)??A;this.runtimeState.isCameraFollowingPlayer?this.recenterCameraOnPlayer():m.centerOn(T.x,T.y+n*.25),this.ports.renderStaticProps(),this.ports.drawBackdrop(),this.ports.drawMap(t.tiles),this.ports.drawBuildingMasses(),this.ports.drawBuildingLabels(),this.ports.clearPathPreview(),this.ports.resizeDayNightOverlay(),this.ports.emitViewportUpdate(),!this.ports.isInCombat()&&!f&&(this.runtimeState.baselineCameraZoom=m.zoom),this.runtimeState.hasInitialZoomApplied=!0,this.pushRuntimeStateToPorts()}enablePlayerCameraFollow(){const t=this.ports.getPlayerTokenContainer();if(!t||!this.ports.sys.isActive())return;const i=this.ports.cameras.main;this.runtimeState.isCameraFollowingPlayer||i.startFollow(t,!1,on,on),i.setDeadzone(Math.max(120,this.ports.scale.width*.22),Math.max(160,this.ports.scale.height*.28)),this.runtimeState.isCameraFollowingPlayer=!0,this.pushRuntimeStateToPorts(),this.recenterCameraOnPlayer(),this.ports.dispatchPlayerScreenPosition()}recenterCameraOnPlayer(){const t=this.ports.getPlayerTokenContainer();if(!t||!this.ports.sys.isActive())return;this.ports.cameras.main.centerOn(t.x,t.y),this.ports.dispatchPlayerScreenPosition()}isFollowingPlayer(){return this.runtimeState.isCameraFollowingPlayer}clampCameraToBounds(t){const i=t.getBounds();if(!i)return;const s=t.width/t.zoom,n=t.height/t.zoom,a=i.x,r=i.x+Math.max(0,i.width-s),o=i.y,l=i.y+Math.max(0,i.height-n);t.scrollX=P.Math.Clamp(t.scrollX,a,r),t.scrollY=P.Math.Clamp(t.scrollY,o,l)}clampCameraCenterTarget(t,i){const s=this.ports.cameras.main,n=s.getBounds();if(!n)return{x:t,y:i};const a=s.worldView.width,r=s.worldView.height,o=a/2,l=r/2,c=n.x+o,d=n.x+Math.max(o,n.width-o),u=n.y+l,h=n.y+Math.max(l,n.height-l),g=P.Math.Clamp(t,c,Math.max(c,d)),p=P.Math.Clamp(i,u,Math.max(u,h));return{x:g,y:p}}focusCameraOnGridPosition(t,i,s=!0){if(!this.ports.sys.isActive()||!this.ports.getCurrentMapArea())return;const n=this.ports.getIsoMetrics(),a=this.ports.calculatePixelPosition(t,i),r=a.x,o=a.y+n.halfTileHeight,{x:l,y:c}=this.clampCameraCenterTarget(r,o),d=this.ports.cameras.main;this.runtimeState.isCameraFollowingPlayer=!1,this.pushRuntimeStateToPorts(),d.stopFollow();const u=()=>{this.clampCameraToBounds(d),this.ports.emitViewportUpdate()};s?d.pan(l,c,300,"Sine.easeInOut",!1,(h,g)=>{this.ports.emitViewportUpdate(),g===1&&u()}):(d.centerOn(l,c),u())}stopCameraZoomTween(){this.runtimeState.cameraZoomTween&&(this.runtimeState.cameraZoomTween.remove(),this.runtimeState.cameraZoomTween=null,this.runtimeState.pendingCameraRestore&&(this.runtimeState.pendingCameraRestore=!1,this.runtimeState.pendingRestoreUserAdjusted!==null&&(this.runtimeState.userAdjustedZoom=this.runtimeState.pendingRestoreUserAdjusted),this.runtimeState.preCombatZoom=null,this.runtimeState.preCombatUserAdjusted=!1,this.runtimeState.pendingRestoreUserAdjusted=null),this.pushRuntimeStateToPorts())}animateCameraZoom(t){if(!this.ports.sys.isActive())return;const i=this.ports.cameras.main;if(!i)return;const s=P.Math.Clamp(t,hi,kt),n=i.zoom;if(this.stopCameraZoomTween(),Math.abs(n-s)<5e-4){i.setZoom(s),this.ports.applyOverlayZoom(),this.ports.emitViewportUpdate(),this.ports.isInCombat()||(this.runtimeState.baselineCameraZoom=i.zoom),this.runtimeState.pendingCameraRestore&&(this.runtimeState.pendingCameraRestore=!1,this.runtimeState.pendingRestoreUserAdjusted!==null&&(this.runtimeState.userAdjustedZoom=this.runtimeState.pendingRestoreUserAdjusted),this.runtimeState.preCombatZoom=null,this.runtimeState.preCombatUserAdjusted=!1,this.runtimeState.pendingRestoreUserAdjusted=null),this.pushRuntimeStateToPorts();return}this.runtimeState.cameraZoomTween=this.ports.tweens.add({targets:i,zoom:s,duration:du,ease:"Sine.easeInOut",onUpdate:()=>{this.ports.applyOverlayZoom(),this.ports.emitViewportUpdate()},onComplete:()=>{this.runtimeState.cameraZoomTween=null,this.ports.isInCombat()||(this.runtimeState.baselineCameraZoom=i.zoom),this.runtimeState.pendingCameraRestore&&(this.runtimeState.pendingCameraRestore=!1,this.runtimeState.pendingRestoreUserAdjusted!==null&&(this.runtimeState.userAdjustedZoom=this.runtimeState.pendingRestoreUserAdjusted),this.runtimeState.preCombatZoom=null,this.runtimeState.preCombatUserAdjusted=!1,this.runtimeState.pendingRestoreUserAdjusted=null),this.pushRuntimeStateToPorts()}}),this.pushRuntimeStateToPorts()}zoomCameraForCombat(){const t=this.ports.cameras.main;if(!t)return;this.runtimeState.pendingCameraRestore=!1;const i=t.zoom;this.runtimeState.preCombatZoom===null&&(this.runtimeState.preCombatZoom=i,this.runtimeState.preCombatUserAdjusted=this.runtimeState.userAdjustedZoom),this.runtimeState.baselineCameraZoom=i;const s=Math.min(kt,Math.max(i*lu,i+cu));this.runtimeState.userAdjustedZoom=!1,this.pushRuntimeStateToPorts(),this.animateCameraZoom(s)}restoreCameraAfterCombat(){const t=this.ports.cameras.main;if(!t)return;const i=this.runtimeState.preCombatZoom??this.runtimeState.baselineCameraZoom??t.zoom;this.runtimeState.pendingRestoreUserAdjusted=this.runtimeState.preCombatUserAdjusted,this.runtimeState.userAdjustedZoom=!0,this.runtimeState.pendingCameraRestore=!0,this.pushRuntimeStateToPorts(),this.animateCameraZoom(i)}resetForMapTransition(){this.runtimeState.hasInitialZoomApplied=!1,this.runtimeState.userAdjustedZoom=!1,this.runtimeState.pendingCameraRestore=!1,this.runtimeState.preCombatZoom=null,this.runtimeState.preCombatUserAdjusted=!1,this.runtimeState.pendingRestoreUserAdjusted=null,this.pushRuntimeStateToPorts()}pushRuntimeStateToPorts(){var t,i;(i=(t=this.ports).writeRuntimeState)==null||i.call(t,this.runtimeState)}}const Ca=.5,Bi=5,rs=(e,t)=>Reflect.get(e,t),$e=(e,t,i)=>{const s=rs(e,t);return typeof s=="number"?s:i},Rt=(e,t,...i)=>{const s=rs(e,t);if(typeof s!="function")throw new Error(`[ClockModule] Missing required scene method: ${t}`);return s.apply(e,i)},mu=e=>({getCurrentGameTime:()=>$e(e,"currentGameTime",D.getState().world.currentTime),getAtmosphereRedrawBucket:()=>$e(e,"lastAtmosphereRedrawBucket",-1),setAtmosphereRedrawBucket:t=>{Reflect.set(e,"lastAtmosphereRedrawBucket",t)},signalAtmosphereRedraw:()=>{const t=rs(e,"currentMapArea");t&&(Rt(e,"drawBackdrop"),Rt(e,"drawMap",t.tiles))},signalOverlayUpdate:()=>{Rt(e,"updateDayNightOverlay")},signalOcclusionUpdate:()=>{Rt(e,"applyOcclusionReadability")},dispatchGameTime:t=>{D.dispatch(Jn(t))},shouldApplySuspicionDecay:()=>!!D.getState().settings.reputationSystemsEnabled,dispatchSuspicionDecay:(t,i)=>{D.dispatch(fa({elapsedSeconds:t,timestamp:i}))},readRuntimeState:()=>({currentGameTime:$e(e,"currentGameTime",D.getState().world.currentTime),timeDispatchAccumulator:$e(e,"timeDispatchAccumulator",0),lastAtmosphereRedrawBucket:$e(e,"lastAtmosphereRedrawBucket",-1),dispatchCadenceSeconds:Ca,atmosphereBucketSeconds:Bi}),writeRuntimeState:t=>{Reflect.set(e,"currentGameTime",t.currentGameTime),Reflect.set(e,"timeDispatchAccumulator",t.timeDispatchAccumulator),Reflect.set(e,"lastAtmosphereRedrawBucket",t.lastAtmosphereRedrawBucket)}}),gu=e=>({currentGameTime:e,timeDispatchAccumulator:0,lastAtmosphereRedrawBucket:Math.floor(e/Bi),dispatchCadenceSeconds:Ca,atmosphereBucketSeconds:Bi});class fu{constructor(t,i){y(this,"key","clock");y(this,"dependsOn",["stateSync","worldRender","dayNightOverlay"]);y(this,"ports");y(this,"runtimeState");var s,n;this.ports=i??mu(t),this.runtimeState={...gu(this.ports.getCurrentGameTime()),...(n=(s=this.ports).readRuntimeState)==null?void 0:n.call(s)},this.runtimeState.lastAtmosphereRedrawBucket<0&&(this.runtimeState.lastAtmosphereRedrawBucket=Math.floor(this.runtimeState.currentGameTime/this.runtimeState.atmosphereBucketSeconds)),this.ports.setAtmosphereRedrawBucket(this.runtimeState.lastAtmosphereRedrawBucket),this.pushRuntimeStateToPorts()}init(t){}onStateChange(t,i){const s=i.world.currentTime;Math.abs(s-this.runtimeState.currentGameTime)>1e-4&&(this.runtimeState.currentGameTime=s,this.pushRuntimeStateToPorts())}onUpdate(t,i){const s=i/1e3;if(!Number.isFinite(s)||s<=0)return;this.runtimeState.currentGameTime+=s,this.runtimeState.timeDispatchAccumulator+=s;const n=Math.floor(this.runtimeState.currentGameTime/this.runtimeState.atmosphereBucketSeconds),a=this.ports.getAtmosphereRedrawBucket();if(n!==a&&(this.runtimeState.lastAtmosphereRedrawBucket=n,this.ports.setAtmosphereRedrawBucket(n),this.ports.signalAtmosphereRedraw()),this.ports.signalOverlayUpdate(),this.ports.signalOcclusionUpdate(),this.runtimeState.timeDispatchAccumulator>=this.runtimeState.dispatchCadenceSeconds){const r=this.runtimeState.timeDispatchAccumulator;this.ports.dispatchGameTime(r),this.ports.shouldApplySuspicionDecay()&&this.ports.dispatchSuspicionDecay(r,this.runtimeState.currentGameTime),this.runtimeState.timeDispatchAccumulator=0}this.pushRuntimeStateToPorts()}getCurrentGameTime(){return this.runtimeState.currentGameTime}pushRuntimeStateToPorts(){var t,i;(i=(t=this.ports).writeRuntimeState)==null||i.call(t,this.runtimeState)}}const yu=.28,Su=16777215,Xt=(e,t)=>Reflect.get(e,t),Et=(e,t)=>{const i=Xt(e,t);if(i==null)throw new Error(`[DayNightOverlayModule] Missing required scene value: ${t}`);return i},vu=(e,t,i)=>{const s=Xt(e,t);return typeof s=="number"?s:i},cn=(e,t,...i)=>{const s=Xt(e,t);if(typeof s!="function")throw new Error(`[DayNightOverlayModule] Missing required scene method: ${t}`);return s.apply(e,i)},bu=e=>({add:Et(e,"add"),cameras:Et(e,"cameras"),scale:Et(e,"scale"),sys:Et(e,"sys"),getCurrentGameTime:()=>vu(e,"currentGameTime",0),isInCombat:()=>!!Xt(e,"inCombat"),resolveAtmosphereProfile:t=>cn(e,"resolveAtmosphereProfile",t),registerStaticDepth:(t,i)=>{cn(e,"registerStaticDepth",t,i)}});class wu{constructor(t,i){y(this,"key","dayNightOverlay");y(this,"context");y(this,"overlay");y(this,"ports");y(this,"handleVisibilityChange",()=>{var t;this.ports.sys.isActive()&&document.visibilityState==="visible"&&(this.resizeDayNightOverlay(),this.updateDayNightOverlay(),(t=this.overlay)==null||t.setVisible(!0))});this.ports=i??bu(t)}init(t){this.context=t}onCreate(){this.context.listenDocument("visibilitychange",this.handleVisibilityChange)}onShutdown(){this.overlay&&(this.overlay.destroy(),this.overlay=void 0)}initializeDayNightOverlay(){const t=this.ports.scale.width,i=this.ports.scale.height,s=this.ports.add.rectangle(0,0,t,i,0,0);s.setOrigin(.5,.5),s.setScrollFactor(0),this.ports.registerStaticDepth(s,Oe.DAY_NIGHT_OVERLAY),s.setBlendMode(P.BlendModes.MULTIPLY),s.setSize(t,i),s.setDisplaySize(t,i),this.overlay=s,this.applyOverlayZoom()}applyOverlayZoom(){const t=this.overlay;if(!t)return;const s=1/(this.ports.cameras.main.zoom||1);t.setScale(s,s),t.setPosition(this.ports.scale.width/2,this.ports.scale.height/2)}resizeDayNightOverlay(){const t=this.overlay;if(!t)return;const i=this.ports.scale.width,s=this.ports.scale.height;t.setSize(i,s),t.setDisplaySize(i,s),this.applyOverlayZoom()}updateDayNightOverlay(){const t=this.overlay;if(!t)return;const i=hl(this.ports.getCurrentGameTime(),H),s=this.ports.resolveAtmosphereProfile(i),n=this.ports.isInCombat(),a=n?Math.min(s.overlayAlpha,yu):s.overlayAlpha,r=n?Su:s.overlayColor;t.setFillStyle(r,a)}}const Pu="isoTileSelected",Oi="isoPathPreview",Mu="minimapViewportClick",Au="minimapStateUpdate",Iu="minimapZoomUpdate",Gg="minimapPathPreview",xu="minimapObjectiveFocus",Cu="playerScreenPositionUpdate",ku="pickupStateSync",X=(e,t)=>Reflect.get(e,t),be=(e,t)=>{const i=X(e,t);if(i==null)throw new Error(`[EntityRenderModule] Missing required scene value: ${t}`);return i},Ye=(e,t,...i)=>{const s=X(e,t);if(typeof s!="function")throw new Error(`[EntityRenderModule] Missing required scene method: ${t}`);return s.apply(e,i)},Tu=e=>({add:be(e,"add"),cameras:be(e,"cameras"),game:be(e,"game"),scale:be(e,"scale"),sys:be(e,"sys"),hasMapGraphics:()=>!!X(e,"mapGraphics"),ensureIsoFactory:()=>{Ye(e,"ensureIsoFactory")},getIsoMetrics:()=>Ye(e,"getIsoMetrics"),calculatePixelPosition:(t,i)=>Ye(e,"calculatePixelPosition",t,i),syncDepth:(t,i,s,n)=>{Ye(e,"syncDepth",t,i,s,n)},enablePlayerCameraFollow:()=>{Ye(e,"enablePlayerCameraFollow")},isInCombat:()=>!!X(e,"inCombat"),isCameraFollowingPlayer:()=>!!X(e,"isCameraFollowingPlayer"),createCharacterToken:(t,i,s)=>{const n=X(e,"characterRigFactory");let a;if(n)a=n.createToken(t,i,s);else{const r=be(e,"isoFactory"),o=be(e,"visualTheme");a=r.createCharacterToken(i,s,o.entityProfiles[t])}if(!a)throw new Error("[EntityRenderModule] Failed to create character token.");return a},positionCharacterToken:(t,i,s)=>{const n=X(e,"characterRigFactory");if(n){n.positionToken(t,i,s);return}be(e,"isoFactory").positionCharacterToken(t,i,s)},readRuntimeState:()=>({playerToken:X(e,"playerToken"),playerNameLabel:X(e,"playerNameLabel"),playerVitalsIndicator:X(e,"playerVitalsIndicator"),enemySprites:X(e,"enemySprites")??new Map,npcSprites:X(e,"npcSprites")??new Map,lastPlayerGridPosition:X(e,"lastPlayerGridPosition")??null,lastPlayerScreenDetail:X(e,"lastPlayerScreenDetail")}),writeRuntimeState:t=>{Reflect.set(e,"playerToken",t.playerToken),Reflect.set(e,"playerNameLabel",t.playerNameLabel),Reflect.set(e,"playerVitalsIndicator",t.playerVitalsIndicator),Reflect.set(e,"enemySprites",t.enemySprites),Reflect.set(e,"npcSprites",t.npcSprites),Reflect.set(e,"lastPlayerGridPosition",t.lastPlayerGridPosition),Reflect.set(e,"lastPlayerScreenDetail",t.lastPlayerScreenDetail)}}),Ru=()=>({playerToken:void 0,playerNameLabel:void 0,playerVitalsIndicator:void 0,enemySprites:new Map,npcSprites:new Map,lastPlayerGridPosition:null,lastPlayerScreenDetail:void 0});class Eu{constructor(t,i){y(this,"key","entityRender");y(this,"ports");y(this,"runtimeState");this.ports=i??Tu(t),this.runtimeState=Ru(),this.pullRuntimeStateFromPorts(),this.pushRuntimeStateToPorts()}init(){}onUpdate(){this.dispatchPlayerScreenPosition()}onShutdown(){this.pullRuntimeStateFromPorts(),this.clearEntities(),this.runtimeState.playerToken&&(this.runtimeState.playerToken.container.destroy(!0),this.runtimeState.playerToken=void 0),this.runtimeState.playerNameLabel&&(this.runtimeState.playerNameLabel.destroy(),this.runtimeState.playerNameLabel=void 0),this.runtimeState.lastPlayerGridPosition=null,this.runtimeState.lastPlayerScreenDetail=void 0,this.destroyPlayerVitalsIndicator(),this.pushRuntimeStateToPorts()}initializePlayer(t,i){if(this.pullRuntimeStateFromPorts(),!t)return!1;this.ports.ensureIsoFactory(),this.runtimeState.playerToken=this.ports.createCharacterToken("player",t.x,t.y);const s=this.ports.getIsoMetrics(),n=this.ports.calculatePixelPosition(t.x,t.y);return this.runtimeState.playerNameLabel=this.createCharacterNameLabel(i,3718648,14),this.positionCharacterLabel(this.runtimeState.playerNameLabel,n.x,n.y,s.tileHeight*1.6),this.runtimeState.lastPlayerGridPosition={...t},this.pushRuntimeStateToPorts(),!0}getPlayerTokenContainer(){var t;return this.pullRuntimeStateFromPorts(),(t=this.runtimeState.playerToken)==null?void 0:t.container}getLastPlayerGridPosition(){return this.pullRuntimeStateFromPorts(),this.runtimeState.lastPlayerGridPosition}getRuntimeStateSnapshot(){return this.pullRuntimeStateFromPorts(),this.runtimeState}updatePlayerPosition(t){if(this.pullRuntimeStateFromPorts(),!this.runtimeState.playerToken){console.warn("[MainScene] Player token not available for position update.");return}const i=!this.runtimeState.lastPlayerGridPosition||this.runtimeState.lastPlayerGridPosition.x!==t.x||this.runtimeState.lastPlayerGridPosition.y!==t.y;this.ports.ensureIsoFactory(),this.ports.positionCharacterToken(this.runtimeState.playerToken,t.x,t.y);const s=this.ports.calculatePixelPosition(t.x,t.y);if(this.dispatchPlayerScreenPosition(),this.runtimeState.playerNameLabel){const n=this.ports.getIsoMetrics();this.positionCharacterLabel(this.runtimeState.playerNameLabel,s.x,s.y,n.tileHeight*1.6)}i&&(this.runtimeState.lastPlayerGridPosition={...t},this.ports.isCameraFollowingPlayer()||this.ports.enablePlayerCameraFollow()),this.pushRuntimeStateToPorts()}updatePlayerVitalsIndicator(t,i,s){if(this.pullRuntimeStateFromPorts(),!this.ports.isInCombat()){this.destroyPlayerVitalsIndicator();return}if(!this.runtimeState.playerToken||!this.ports.sys.isActive())return;const n=this.ports.getIsoMetrics(),a=this.ports.calculatePixelPosition(t.x,t.y),r=n.tileWidth*.38,o=Math.max(4,n.tileHeight*.08),l=a.x-r/2,c=a.y-n.tileHeight*.7,d=s>0?Math.max(0,Math.min(1,i/s)):0;this.runtimeState.playerVitalsIndicator||(this.runtimeState.playerVitalsIndicator=this.ports.add.graphics());const u=this.runtimeState.playerVitalsIndicator;u.clear(),u.fillStyle(988970,.82),u.fillRoundedRect(l,c,r,o,Math.min(4,o)),d>0&&(u.fillStyle(3718648,1),u.fillRoundedRect(l+1,c+1,(r-2)*d,Math.max(1,o-2),Math.max(2,o-2))),this.ports.syncDepth(u,a.x,a.y,W.FLOATING_UI+9),this.pushRuntimeStateToPorts()}destroyPlayerVitalsIndicator(){this.pullRuntimeStateFromPorts(),this.runtimeState.playerVitalsIndicator&&(this.runtimeState.playerVitalsIndicator.destroy(),this.runtimeState.playerVitalsIndicator=void 0,this.pushRuntimeStateToPorts())}updateEnemies(t){if(this.pullRuntimeStateFromPorts(),!this.ports.hasMapGraphics()||!this.ports.sys.isActive())return;this.ports.ensureIsoFactory(),this.runtimeState.enemySprites.forEach(s=>{s.markedForRemoval=!0});const i=this.ports.getIsoMetrics();for(const s of t){const n=this.runtimeState.enemySprites.get(s.id),a=this.ports.calculatePixelPosition(s.position.x,s.position.y);if(!n){if(s.health<=0)continue;const r=this.ports.createCharacterToken("hostileNpc",s.position.x,s.position.y),o=this.ports.add.graphics();o.setVisible(!1);const l=this.createCharacterNameLabel(s.name??"Hostile",15680580);this.positionCharacterLabel(l,a.x,a.y,i.tileHeight*1.45),this.runtimeState.enemySprites.set(s.id,{token:r,healthBar:o,nameLabel:l,markedForRemoval:!1});const c=this.runtimeState.enemySprites.get(s.id);c&&this.updateEnemyHealthBar(c,a,i,s);continue}if(s.health<=0){n.markedForRemoval=!0;continue}this.ports.positionCharacterToken(n.token,s.position.x,s.position.y),n.markedForRemoval=!1,this.positionCharacterLabel(n.nameLabel,a.x,a.y,i.tileHeight*1.45),this.updateEnemyHealthBar(n,a,i,s)}this.runtimeState.enemySprites.forEach((s,n)=>{s.markedForRemoval&&(s.token.container.destroy(!0),s.healthBar.destroy(),s.nameLabel.destroy(),this.runtimeState.enemySprites.delete(n))}),this.pushRuntimeStateToPorts()}updateNpcs(t){if(this.pullRuntimeStateFromPorts(),!this.ports.sys.isActive())return;this.runtimeState.npcSprites.forEach(s=>{s.markedForRemoval=!0}),this.ports.ensureIsoFactory();const i=this.ports.getIsoMetrics();for(const s of t){const n=this.runtimeState.npcSprites.get(s.id),a=this.ports.calculatePixelPosition(s.position.x,s.position.y);if(!n){const r=s.isInteractive?"interactiveNpc":"friendlyNpc",o=this.ports.createCharacterToken(r,s.position.x,s.position.y),l=this.createCharacterNameLabel(s.name??"Civilian",s.isInteractive?2282478:9741240);this.positionCharacterLabel(l,a.x,a.y,i.tileHeight*1.35);const c={token:o,nameLabel:l,markedForRemoval:!1};this.runtimeState.npcSprites.set(s.id,c),this.updateNpcCombatIndicator(c,a,i,s);continue}this.ports.positionCharacterToken(n.token,s.position.x,s.position.y),n.markedForRemoval=!1,this.positionCharacterLabel(n.nameLabel,a.x,a.y,i.tileHeight*1.35),this.updateNpcCombatIndicator(n,a,i,s)}this.runtimeState.npcSprites.forEach((s,n)=>{s.markedForRemoval&&(s.token.container.destroy(!0),s.nameLabel.destroy(),s.indicator&&s.indicator.destroy(),this.runtimeState.npcSprites.delete(n))}),this.pushRuntimeStateToPorts()}clearForMapTransition(){this.pullRuntimeStateFromPorts(),this.clearEntities(),this.runtimeState.lastPlayerScreenDetail=void 0,this.runtimeState.lastPlayerGridPosition=null,this.destroyPlayerVitalsIndicator(),this.pushRuntimeStateToPorts()}resetCombatIndicators(){this.pullRuntimeStateFromPorts(),this.destroyPlayerVitalsIndicator(),this.runtimeState.enemySprites.forEach(t=>{t.healthBar.clear(),t.healthBar.setVisible(!1)}),this.runtimeState.npcSprites.forEach(t=>{t.indicator&&(t.indicator.destroy(),t.indicator=void 0)}),this.pushRuntimeStateToPorts()}createCharacterNameLabel(t,i,s=12){const n=this.ports.add.text(0,0,t.toUpperCase(),{fontFamily:'Orbitron, "DM Sans", sans-serif',fontSize:`${s}px`,fontStyle:"700",color:this.colorToHex(16317180),align:"center"});return n.setOrigin(.5,1),n.setStroke(this.colorToHex(i),1.4),n.setShadow(0,0,this.colorToHex(i),8,!0,!0),n.setBlendMode(P.BlendModes.ADD),n.setAlpha(.95),n}positionCharacterLabel(t,i,s,n){t.setPosition(i,s-n),t.setDepth(as(i,s,W.OVERLAY))}dispatchPlayerScreenPosition(){var h;if(this.pullRuntimeStateFromPorts(),!this.runtimeState.playerToken||!this.ports.sys.isActive())return;const t=this.ports.cameras.main,i=this.runtimeState.playerToken.container,s=i.x,n=i.y,a=(s-t.worldView.x)*t.zoom,r=(n-t.worldView.y)*t.zoom,o=(h=this.ports.game.canvas)==null?void 0:h.getBoundingClientRect(),l=(o==null?void 0:o.width)??this.ports.scale.width,c=(o==null?void 0:o.height)??this.ports.scale.height,d={worldX:s,worldY:n,screenX:a,screenY:r,canvasWidth:this.ports.scale.width,canvasHeight:this.ports.scale.height,canvasDisplayWidth:l,canvasDisplayHeight:c,canvasLeft:(o==null?void 0:o.left)??0,canvasTop:(o==null?void 0:o.top)??0,zoom:t.zoom,timestamp:typeof performance<"u"?performance.now():Date.now()},u=this.runtimeState.lastPlayerScreenDetail;u&&Math.abs(u.screenX-d.screenX)<.5&&Math.abs(u.screenY-d.screenY)<.5&&Math.abs(u.zoom-d.zoom)<1e-4&&u.canvasWidth===d.canvasWidth&&u.canvasHeight===d.canvasHeight||(this.runtimeState.lastPlayerScreenDetail=d,this.pushRuntimeStateToPorts(),typeof window<"u"&&(window.__getawayPlayerScreenPosition=d,window.dispatchEvent(new CustomEvent(Cu,{detail:d}))))}updateNpcCombatIndicator(t,i,s,n){if(!this.ports.isInCombat()||!n.isInteractive){t.indicator&&(t.indicator.destroy(),t.indicator=void 0);return}t.indicator||(t.indicator=this.ports.add.graphics());const a=t.indicator,r=s.tileWidth*.26,o=Math.max(3,s.tileHeight*.06),l=i.x-r/2,c=i.y-s.tileHeight*.68;a.clear(),a.fillStyle(1059395,.82),a.fillRoundedRect(l,c,r,o,Math.min(3,o)),a.fillStyle(2278750,1),a.fillRoundedRect(l+1,c+1,r-2,Math.max(1,o-2),Math.max(2,o-2)),this.ports.syncDepth(a,i.x,i.y,W.FLOATING_UI+6)}updateEnemyHealthBar(t,i,s,n){const a=t.healthBar;if(!this.ports.isInCombat()){a.clear(),a.setVisible(!1);return}a.setVisible(!0);const r=s.tileWidth*.38,o=Math.max(4,s.tileHeight*.08),l=i.x-r/2,c=i.y-s.tileHeight*.75,d=n.maxHealth>0?P.Math.Clamp(n.health/n.maxHealth,0,1):0;a.clear(),a.fillStyle(4136221,.88),a.fillRoundedRect(l,c,r,o,Math.min(4,o)),d>0&&(a.fillStyle(15680580,1),a.fillRoundedRect(l+1,c+1,(r-2)*d,Math.max(1,o-2),Math.max(2,o-2))),this.ports.syncDepth(a,i.x,i.y,W.FLOATING_UI+7)}pullRuntimeStateFromPorts(){var i,s;const t=(s=(i=this.ports).readRuntimeState)==null?void 0:s.call(i);t&&(t.playerToken!==void 0&&(this.runtimeState.playerToken=t.playerToken),t.playerNameLabel!==void 0&&(this.runtimeState.playerNameLabel=t.playerNameLabel),this.runtimeState.playerVitalsIndicator=t.playerVitalsIndicator,t.enemySprites&&(this.runtimeState.enemySprites=t.enemySprites),t.npcSprites&&(this.runtimeState.npcSprites=t.npcSprites),t.lastPlayerGridPosition!==void 0&&(this.runtimeState.lastPlayerGridPosition=t.lastPlayerGridPosition),this.runtimeState.lastPlayerScreenDetail=t.lastPlayerScreenDetail)}pushRuntimeStateToPorts(){var t,i;(i=(t=this.ports).writeRuntimeState)==null||i.call(t,this.runtimeState)}clearEntities(){this.runtimeState.enemySprites.forEach(t=>{t.token.container.destroy(!0),t.healthBar.destroy(),t.nameLabel.destroy()}),this.runtimeState.enemySprites.clear(),this.runtimeState.npcSprites.forEach(t=>{t.token.container.destroy(!0),t.nameLabel.destroy(),t.indicator&&(t.indicator.destroy(),t.indicator=void 0)}),this.runtimeState.npcSprites.clear()}colorToHex(t){return`#${t.toString(16).padStart(6,"0")}`}}const Ni=5,ut=2,dn=1,_u="south",un=0,Du=["none","half","full"],Lu={none:1,half:.75,full:.55},Fu={none:0,half:-.2,full:-.4},Bu=()=>{var e;try{switch(((e=D.getState().paranoia)==null?void 0:e.tier)??"calm"){case"uneasy":return-.05;case"on_edge":return-.1;case"panicked":return-.15;case"breakdown":return-.25;default:return 0}}catch{return 0}},zt=e=>Du.indexOf(e),hn=(e,t)=>zt(t)>zt(e)?t:e,Qt=(e,t)=>{const i=t.x-e.x,s=t.y-e.y;if(Math.abs(i)>=Math.abs(s)){if(i>0)return"east";if(i<0)return"west"}return s>0?"south":s<0?"north":_u},ka=(e,t)=>e?e[t]??"none":"none",Ou=e=>{if(!e)return null;let t="north",i="none";return["north","east","south","west"].forEach(s=>{const n=ka(e,s);zt(n)>zt(i)&&(i=n,t=s)}),i==="none"?null:t},Ta=(e,t)=>{var i,s;if(e)return(s=(i=e.tiles[t.y])==null?void 0:i[t.x])==null?void 0:s.cover},Ra=e=>typeof e=="boolean"?{isBehindCover:e}:e?{isBehindCover:!!e.isBehindCover,mapArea:e.mapArea}:{isBehindCover:!1},Ea=(e,t,i)=>{let s=i.isBehindCover?"half":"none";const n=Qt(t.position,e.position),a=Ta(i.mapArea,t.position);return s=hn(s,ka(a,n)),t.coverOrientation&&t.coverOrientation===n&&(s=hn(s,"half")),{level:s,attackDirection:n}},_a=(e,t)=>({...e,facing:t}),Hi=(e,t)=>{if(!t)return{...e,coverOrientation:e.coverOrientation??null,suppression:e.suppression??un};const i=Ta(t,e.position);return{...e,coverOrientation:Ou(i),suppression:e.suppression??un}},St=(e,t,i)=>{const s=Qt(t,e.position),n=_a(e,s);return Hi(n,i)};let Nu=()=>Math.random();const pn=()=>{const e=Nu();if(!Number.isFinite(e)||Number.isNaN(e))throw new Error("[CombatSystem] Random generator must return a finite number between 0 and 1.");if(e<0||e>1)throw new Error("[CombatSystem] Random generator must return a value between 0 and 1.");return e},mn=e=>({...e,equipped:{...e.equipped},encumbrance:{...e.encumbrance},inventory:{...e.inventory,items:[...e.inventory.items],hotbar:[...e.inventory.hotbar]},equippedSlots:e.equippedSlots?{...e.equippedSlots}:{},perkRuntime:{...e.perkRuntime}}),Wi=.25,st=e=>{const t=e==null?void 0:e.durability;if(!t||t.max<=0)return 1;const i=t.current/t.max;return Number.isFinite(i)?Math.max(0,Math.min(1,i)):1},gn=e=>{const t=st(e);return t<=0?0:t<=Wi?.75:t<=.5?.9:1},fn=(e,t=1)=>{if(!e.durability)return e;const i=Math.max(0,e.durability.current-t);return{...e,durability:{...e.durability,current:i}}},yn=(e,t,i,s,n)=>{if(s>0&&n===0){e.push({type:t==="weapon"?"weaponBroken":"armorBroken",message:t==="weapon"?`${i} has broken—switch weapons or repair it to continue fighting.`:`${i} is shredded! Incoming damage will hit you directly.`});return}s>Wi&&n<=Wi&&n>0&&e.push({type:t==="weapon"?"weaponDamaged":"armorDamaged",message:t==="weapon"?`${i} is about to fail. Repair it soon to avoid misfires.`:`${i} can barely absorb hits—seek repairs immediately.`})},Hu=(e,t)=>{const i=e.encumbrance,s=(i==null?void 0:i.attackApMultiplier)??1;if(!Number.isFinite(s))return Number.POSITIVE_INFINITY;const n=Math.ceil(t*Math.max(s,0));return Math.max(0,n)},Da=e=>{var t;if("skills"in e){const i=e;if(no(i.encumbrance))return Number.POSITIVE_INFINITY;const s=((t=i.encumbrance)==null?void 0:t.movementApMultiplier)??1;return Number.isFinite(s)?Math.max(1,Math.ceil(dn*Math.max(s,0))):Number.POSITIVE_INFINITY}return dn},Wu=e=>{var t;if("skills"in e){const i=e,s=((t=i.equipped.weapon)==null?void 0:t.apCost)??ut,n=Math.max(0,s);return $i(i)?0:Hu(i,n)}return ut},qu=(e,t)=>{const i=Math.abs(e.x-t.x),s=Math.abs(e.y-t.y);return i===1&&s===0||i===0&&s===1},_e=(e,t,i)=>{if(!Number.isFinite(i)||i<=0)return console.warn("[CombatSystem] Invalid attack range:",i),!1;const s=Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));return s>0&&s<=i},Vu=(e,t)=>Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)),oe=(e,t)=>Math.abs(t.x-e.x)+Math.abs(t.y-e.y),qi=e=>{try{return Rr(e)}catch(t){return console.warn("[CombatSystem] Failed to calculate equipment-aware stats, falling back to base attributes.",t),Zi(e.skills)}},Gu=(e,t,i)=>{const s=Ra(i),{level:n,attackDirection:a}=Ea(e,t,s),r=Vu(e.position,t.position);let o=.65-r*.05;if(o+=Fu[n],"skills"in e){const d=e,u=qi(d);o+=u.hitChanceModifier/100;const h=Wt(d.equipped.weapon);o+=h.hitChanceBonus;const g=Dn(d.equipped.weapon),p=zi(d,g);switch(g){case"smallGuns":{o+=Ln(p)/100;break}case"energyWeapons":{const m=Ui(p);o+=m.hit/100;break}case"meleeCombat":{const m=Ki(p);o+=m.hit/100;break}case"explosives":{const m=Fn(p);o+=m.accuracy/100;break}}Sr(d.equipped.weapon)&&(o+=vr(d))}if("skills"in t){const d=qi(t);o-=d.dodgeChance/100}const l=Bu();l!==0&&(o+=l);const c=Math.max(.1,Math.min(.95,o));return console.log("[CombatSystem] calculateHitChance:",{attacker:e.id,target:t.id,distance:r,attackDirection:a,coverLevel:n,finalHitChance:c}),c},La=(e,t,i)=>{var F,q,ge,xe,ps,ms,gs,fs,ys,Ss;const s=Ra(i),n=Ea(e,t,s),a=Wu(e);if(!Number.isFinite(a)||e.actionPoints<a)return{success:!1,damage:0,isCritical:!1,newAttacker:e,newTarget:t,events:void 0};if("skills"in e){const E=e.equipped.weapon;if(E!=null&&E.durability&&E.durability.current<=0)return{success:!1,damage:0,isCritical:!1,newAttacker:e,newTarget:t,events:[{type:"weaponBroken",message:`${E.name} is inoperable—repair or swap weapons before attacking.`}]}}const r=[],o=Gu(e,t,s),c=pn()<=o;let d=0,u=!1,h=e,g;const p=Qt(e.position,t.position);let m,f=1,b=!1,S=!1,M=!1,v=!1,A,I=Wt(),x=0,T=0;if("skills"in e){if(m=e.equipped.weapon,f=gn(m),b=it(m,"silenced"),S=it(m,"armorPiercing"),M=it(m,"energy"),v=it(m,"hollowPoint"),I=Wt(m),m){const z=m.magazineSize??0;x=z>0?Math.max(1,Math.round(z*(I.magazineSizeMultiplier??1))):0,T=x>0?Math.min(x,m.currentMagazine??x):0,x>0&&T<=0&&(T=x)}b=b||I.silenced,I.armorPiercingFactor!==void 0&&(S=!0,A=I.armorPiercingFactor)}let O=1,w,C=0;if("skills"in t){const z=t;w=z.equipped.bodyArmor??z.equipped.armor,O=gn(w),C=Math.max(0,Math.round(xr(z)))}if(c){let z=0;if("skills"in e){const E=e,Ce=qi(E),U=Yi(E),Ue=(m==null?void 0:m.damage)??Ni,Va=!m||m.range<=1?Ce.meleeDamageBonus:0,bs=Dn(m),ws=zi(E,bs);let bt=kr(Ue,U,Va);switch(bs){case"energyWeapons":{z=Ui(ws).crit;break}case"meleeCombat":{const ke=Ki(ws);bt+=ke.damage;break}}bt=Math.max(0,bt);let wt=f;wt*=I.damageMultiplier??1,wt*=Lu[n.level],v&&(wt*=C>0?.5:1.25),d=Math.round(bt*wt),d=Math.max(0,d),I.critChanceBonus&&(z+=I.critChanceBonus);const Ps=Math.max(0,Math.min(95,Ce.criticalChance+z));let Ms=!1;if(!("skills"in t)&&me(E,"executioner")){const ke=t;ke.maxHealth>0&&ke.health<=ke.maxHealth*.25&&(d=Math.round(d*1.5),Ms=!0,u=!0)}!Ms&&Ps>0&&pn()<=Ps/100&&(d=Math.round(d*1.5),u=!0)}else d="damage"in e?e.damage:Ni;if("skills"in t&&d>0){let E=Math.round(C*O);S&&E>0&&(E=Math.max(0,Math.floor(E*(A??.5)))),M&&(E=0),E>0&&(d=Tr(d,E))}}if("skills"in t){const z=t,E=mn(z);if(E.health=Math.max(0,z.health-d),c&&(w!=null&&w.durability)){const Ce=st(w),U=fn(w,1),Ue=st(U);yn(r,"armor",U.name,Ce,Ue),((F=E.equipped.bodyArmor)==null?void 0:F.id)===w.id&&(E.equipped.bodyArmor=U),((q=E.equipped.armor)==null?void 0:q.id)===w.id&&(E.equipped.armor=U),((xe=(ge=E.equippedSlots)==null?void 0:ge.bodyArmor)==null?void 0:xe.id)===w.id&&(E.equippedSlots.bodyArmor=U)}g=E}else g={...t,health:Math.max(0,t.health-d)};if("skills"in e){const E=mn(e);if(m){const Ce=st(m),U=fn(m,1),Ue=st(U);if(m.durability&&yn(r,"weapon",U.name,Ce,Ue),x>0){const vs=Math.max(0,Math.min(x,T-1));U.currentMagazine=vs}E.equipped.weapon=U,((ms=(ps=E.equippedSlots)==null?void 0:ps.primaryWeapon)==null?void 0:ms.id)===m.id&&(E.equippedSlots.primaryWeapon=U),((fs=(gs=E.equippedSlots)==null?void 0:gs.secondaryWeapon)==null?void 0:fs.id)===m.id&&(E.equippedSlots.secondaryWeapon=U),((Ss=(ys=E.equippedSlots)==null?void 0:ys.meleeWeapon)==null?void 0:Ss.id)===m.id&&(E.equippedSlots.meleeWeapon=U)}m&&m.range>1&&!b&&r.push({type:"weaponNoise",message:`${m.name} echoes loudly—nearby hostiles are on edge.`}),E.actionPoints=Math.max(0,E.actionPoints-a),h=wr(E)}else h={...e,actionPoints:Math.max(0,e.actionPoints-a)};return{success:c,damage:d,isCritical:u,newAttacker:Hi(_a(h,p),s.mapArea),newTarget:Hi(g,s.mapArea),events:r.length>0?r:void 0}},os=(e,t,i,s,n)=>{const a=Da(e);if(!Number.isFinite(a)||e.actionPoints<a||!qu(e.position,t))return!1;const r=n.filter(l=>l.id!==e.id),o=e.id===s.id?{...s,position:{x:-1,y:-1}}:s;return Ae(t,i,o,r)},vt=(e,t)=>{const i=Da(e);return!Number.isFinite(i)||i===Number.POSITIVE_INFINITY?e:{...e,position:t,actionPoints:Math.max(0,e.actionPoints-i)}},We=(e,t)=>Reflect.get(e,t),pi=(e,t)=>{const i=We(e,t);if(i==null)throw new Error(`[InputModule] Missing required scene value: ${t}`);return i},Ze=(e,t,...i)=>{const s=We(e,t);if(typeof s!="function")throw new Error(`[InputModule] Missing required scene method: ${t}`);return s.apply(e,i)},zu=e=>({cameras:pi(e,"cameras"),sys:pi(e,"sys"),pathGraphics:pi(e,"pathGraphics"),getCurrentMapArea:()=>We(e,"currentMapArea")??null,setCurrentMapArea:t=>{Reflect.set(e,"currentMapArea",t)},getPlayerInitialPosition:()=>We(e,"playerInitialPosition"),getLastPlayerGridPosition:()=>We(e,"lastPlayerGridPosition")??null,getCoverDebugGraphics:()=>We(e,"coverDebugGraphics"),worldToGrid:(t,i)=>Ze(e,"worldToGrid",t,i),getIsoMetrics:()=>Ze(e,"getIsoMetrics"),calculatePixelPosition:(t,i)=>Ze(e,"calculatePixelPosition",t,i),getDiamondPoints:(t,i,s,n)=>Ze(e,"getDiamondPoints",t,i,s,n),renderStaticProps:()=>{Ze(e,"renderStaticProps")}});class Uu{constructor(t,i){y(this,"key","input");y(this,"context");y(this,"ports");y(this,"handlePickupStateSync",t=>{var n;const i=t,s=this.ports.getCurrentMapArea();!this.ports.sys.isActive()||!s||(n=i.detail)!=null&&n.areaId&&i.detail.areaId!==s.id||(this.ports.setCurrentMapArea(this.context.getState().world.currentMapArea),this.ports.renderStaticProps())});y(this,"handlePathPreview",t=>{if(!this.ports.sys.isActive())return;const s=t.detail;if(!s){this.clearPathPreview();return}const n=this.ports.getCurrentMapArea();if(!n||s.areaId!==n.id){this.clearPathPreview();return}if(this.ports.pathGraphics.clear(),!s.path||s.path.length===0)return;const{tileWidth:a,tileHeight:r}=this.ports.getIsoMetrics(),o=s.path.length;s.path.forEach((c,d)=>{const u=this.ports.calculatePixelPosition(c.x,c.y),h=d===s.path.length-1?.8:.55,g=this.ports.getDiamondPoints(u.x,u.y,a*h,r*h);let p,m;d===s.path.length-1?(p=16762967,m=.5):o<=3?(p=3462041,m=.32):o<=6?(p=16498468,m=.35):o<=9?(p=16486972,m=.38):(p=16281969,m=.4),this.ports.pathGraphics.fillStyle(p,m),this.ports.pathGraphics.fillPoints(g,!0)});const l=s.path[s.path.length-1];this.renderCoverPreview(l)});this.ports=i??zu(t)}init(t){this.context=t}onCreate(){this.context.listenWindow(Oi,this.handlePathPreview),this.context.listenWindow(ku,this.handlePickupStateSync),this.context.listenInput("pointerdown",this.handlePointerDown,this)}handlePointerDown(t){const i=this.ports.getCurrentMapArea();if(!i||!this.ports.sys.isActive()||!t.leftButtonDown())return;const s=this.ports.cameras.main.getWorldPoint(t.x,t.y),n=this.ports.worldToGrid(s.x,s.y);if(!n)return;const{x:a,y:r}=n;if(a<0||r<0||a>=i.width||r>=i.height)return;const o=i.tiles[r][a];!o.isWalkable&&o.type!==R.DOOR||window.dispatchEvent(new CustomEvent(Pu,{detail:{position:n,areaId:i.id}}))}clearPathPreview(){var t;(t=this.ports.pathGraphics)==null||t.clear(),this.renderCoverPreview()}renderCoverPreview(t){var S;const i=this.ports.getCoverDebugGraphics();if(!i)return;i.clear();const s=this.ports.getCurrentMapArea();if(!t||!s){i.setVisible(!1);return}const n=this.ports.getLastPlayerGridPosition()??this.ports.getPlayerInitialPosition();if(!n){i.setVisible(!1);return}const a=(S=s.tiles[t.y])==null?void 0:S[t.x];if(!(a!=null&&a.cover)){i.setVisible(!1);return}const r=Qt(t,n),o=a.cover[r];if(!o||o==="none"){i.setVisible(!1);return}const{tileWidth:l,tileHeight:c}=this.ports.getIsoMetrics(),d=this.ports.calculatePixelPosition(t.x,t.y),u=this.ports.getDiamondPoints(d.x,d.y,l*.7,c*.7),[h,g,p,m]=u,f=o==="full"?3718648:16498468,b=o==="full"?.35:.25;switch(i.fillStyle(f,b),r){case"north":i.fillTriangle(h.x,h.y,g.x,g.y,m.x,m.y);break;case"south":i.fillTriangle(p.x,p.y,g.x,g.y,m.x,m.y);break;case"east":i.fillTriangle(g.x,g.y,h.x,h.y,p.x,p.y);break;case"west":i.fillTriangle(m.x,m.y,p.x,p.y,h.x,h.y);break}i.fillCircle(d.x,d.y,c*.08),i.setVisible(!0)}}const ye=(e,t,i)=>i<t?t:Math.min(Math.max(e,t),i),nt=(e,t=4)=>{const i=10**t;return Math.round(e*i)/i},Sn=2,Ku=(e,t,i,s,n)=>{const a=e.map(o=>`${o.id}:${o.position.x}:${o.position.y}:${o.health}`).join("|"),r=t.map(o=>`${o.id}:${o.position.x}:${o.position.y}`).join("|");return`${i??"player"}:${s}:${n}::${a}::${r}`},ju=e=>e.map(t=>`${t.id}:${t.x}:${t.y}:${t.status}`).join("|"),$u=()=>typeof window>"u"?1:window.devicePixelRatio||1,Yu=(e,t,i)=>{const s=t/Math.max(1,e.width),n=i/Math.max(1,e.height),a=Math.min(s,n),r=Math.max(.6,Math.min(4,a||Sn));return Number.isFinite(r)&&r>0?r:Sn},Zu=(e,t)=>{const i=Math.max(1,t.width),s=Math.max(1,t.height),n=Math.max(1e-4,e.width),a=Math.max(1e-4,e.height),r=e.x+n/2,o=e.y+a/2,l=.001,c=Math.max(l,n),d=Math.max(l,a),u=Math.min(i,c),h=Math.min(s,d),g=u/2,p=h/2,m=g,f=Math.max(g,i-g),b=p,S=Math.max(p,s-p),M=ye(r,m,f),v=ye(o,b,S),A=nt(u),I=nt(h),x=ye(M,A/2,Math.max(A/2,i-A/2)),T=ye(v,I/2,Math.max(I/2,s-I/2)),O=ye(nt(x-A/2),0,Math.max(0,i-A)),w=ye(nt(T-I/2),0,Math.max(0,s-I));return{x:O,y:w,width:A,height:I,zoom:e.zoom}};class Xu{constructor(t){y(this,"scene",null);y(this,"viewport",null);y(this,"tileSignature",null);y(this,"config");y(this,"lastRenderState",null);this.config={maxCanvasWidth:(t==null?void 0:t.maxCanvasWidth)??180,maxCanvasHeight:(t==null?void 0:t.maxCanvasHeight)??160,minZoom:(t==null?void 0:t.minZoom)??.6,maxZoom:(t==null?void 0:t.maxZoom)??3}}bindScene(t){this.scene=t}setViewport(t){this.viewport=t}setCanvasBounds(t,i){const s=Number.isFinite(t)?Math.floor(t):0,n=Number.isFinite(i)?Math.floor(i):0;if(s<=0||n<=0)return!1;const a=ye(s,120,4096),r=ye(n,80,4096);return a===this.config.maxCanvasWidth&&r===this.config.maxCanvasHeight?!1:(this.config={...this.config,maxCanvasWidth:a,maxCanvasHeight:r},!0)}compose(t,i,s){var w,C;const n=t.world.currentMapArea;if(!n)return null;const a=Yu(n,this.config.maxCanvasWidth,this.config.maxCanvasHeight),r=nt(a*ye(i,this.config.minZoom,this.config.maxZoom)),o=Math.ceil(n.width*r),l=Math.ceil(n.height*r),c=$u(),d=t.player.data,u=t.world.currentMapArea.entities.enemies,h=t.world.currentMapArea.entities.npcs,g=t.world.currentMapArea.entities.items,p=t.surveillance.zones[n.id],m=Ku(u,h,d.id,d.position.x,d.position.y),f=p?this.buildCameras(p.cameras):[],b=this.createCameraSignature(f),S=n.tiles;let M=((w=this.tileSignature)==null?void 0:w.version)??0;(!this.tileSignature||this.tileSignature.areaId!==n.id||this.tileSignature.ref!==S)&&(M+=1,this.tileSignature={areaId:n.id,ref:S,version:M});const v=this.viewport??{x:0,y:0,width:Math.min(n.width,Math.ceil(n.width*.4)),height:Math.min(n.height,Math.ceil(n.height*.4)),zoom:this.scene?this.scene.cameras.main.zoom:1},A=Zu(v,n);this.viewport=A;const I=this.buildObjectives(g),x=ju(I),T=s&&s.length?s.map(F=>`${F.x}:${F.y}`).join("|"):"",O={version:(((C=this.lastRenderState)==null?void 0:C.version)??0)+1,areaId:n.id,areaName:n.name,mapWidth:n.width,mapHeight:n.height,logicalWidth:o,logicalHeight:l,tileScale:r,devicePixelRatio:c,baseTileScale:a,userZoom:r/a,tileVersion:M,tiles:S,entities:this.buildEntities(d.id??"player",d.position.x,d.position.y,u,h),entitiesSignature:m,cameras:f,camerasSignature:b,viewport:A,curfewActive:t.world.curfewActive,timestamp:Date.now(),path:s??void 0,pathSignature:T,objectiveMarkers:I,objectivesSignature:x,dirtyLayers:this.resolveDirtyLayers({tileVersion:M,entitySignature:m,cameraSignature:b,objectivesSignature:x,pathSignature:T,viewport:A,curfewActive:t.world.curfewActive,tileScale:r,areaId:n.id})};return this.lastRenderState=O,O}buildEntities(t,i,s,n,a){const r=[{id:t,kind:"player",x:i,y:s,status:"active"}];return n.forEach(o=>{r.push({id:o.id,kind:"enemy",x:o.position.x,y:o.position.y,status:o.health>0?"active":"inactive"})}),a.forEach(o=>{r.push({id:o.id,kind:"npc",x:o.position.x,y:o.position.y,status:"active"})}),r}buildCameras(t){return Object.values(t).map(i=>({id:i.id,type:i.type,x:i.position.x,y:i.position.y,alertState:i.alertState,isActive:i.isActive}))}createCameraSignature(t){return t.length?t.map(i=>`${i.id}:${i.type}:${i.x}:${i.y}:${i.alertState}:${i.isActive?1:0}`).join("|"):""}buildObjectives(t){return t.filter(i=>!!i.position).map(i=>({id:i.id,label:i.name,x:i.position.x,y:i.position.y,status:"active"}))}resolveDirtyLayers(t){const i=this.lastRenderState;if(!i)return{tiles:!0,overlays:!0,entities:!0,viewport:!0,path:!!t.pathSignature};const s=i.areaId!==t.areaId,n=i.tileScale!==t.tileScale,a=s||i.tileVersion!==t.tileVersion||n,r=s||i.camerasSignature!==t.cameraSignature||n,o=s||i.entitiesSignature!==t.entitySignature||n||r,l=s||i.objectivesSignature!==t.objectivesSignature||n,c=s||i.viewport.x!==t.viewport.x||i.viewport.y!==t.viewport.y||i.viewport.width!==t.viewport.width||i.viewport.height!==t.viewport.height||i.viewport.zoom!==t.viewport.zoom||i.tileScale!==t.tileScale,d=i.pathSignature!==t.pathSignature||n,u=s||i.curfewActive!==t.curfewActive||l||c;return{tiles:a,overlays:u,entities:o||l,viewport:c,path:d}}}const Qu=typeof window<"u"?window.requestAnimationFrame.bind(window):void 0,vn=typeof window<"u"?window.cancelAnimationFrame.bind(window):void 0,Ju=(e,t,i)=>i<t?t:Math.min(Math.max(e,t),i);class eh extends EventTarget{constructor(){super(...arguments);y(this,"scene",null);y(this,"storeUnsubscribe",null);y(this,"pendingFrame",null);y(this,"pendingStoreUpdate",!1);y(this,"pendingViewportUpdate",!1);y(this,"controller",new Xu);y(this,"lastState",null);y(this,"userZoom",1);y(this,"minZoom",.6);y(this,"maxZoom",3);y(this,"lastPath",null);y(this,"raf",Qu);y(this,"handlePathPreview",i=>{const s=i.detail,a=D.getState().world.currentMapArea;if(!a||s.areaId!==a.id)return;const r=s.path??[];this.lastPath=r.length?r:null,this.pendingStoreUpdate=!0,this.scheduleBroadcast()})}initialize(i){this.scene!==i&&(this.shutdown(),this.scene=i,this.controller.bindScene(i),this.storeUnsubscribe=D.subscribe(()=>{this.pendingStoreUpdate=!0,this.scheduleBroadcast()}),typeof window<"u"&&window.addEventListener(Oi,this.handlePathPreview),this.pendingStoreUpdate=!0,this.scheduleBroadcast(!0))}shutdown(){this.storeUnsubscribe&&(this.storeUnsubscribe(),this.storeUnsubscribe=null),this.pendingFrame!==null&&this.raf&&vn&&vn(this.pendingFrame),this.pendingFrame=null,this.controller.bindScene(null),this.scene=null,typeof window<"u"&&window.removeEventListener(Oi,this.handlePathPreview)}getState(){return this.lastState}updateViewport(i){this.controller.setViewport({x:i.x,y:i.y,width:i.width,height:i.height,zoom:i.zoom}),this.pendingViewportUpdate=!0,this.scheduleBroadcast()}emitInteraction(i){if(this.scene)switch(i.type){case Mu:{const s=i.animate??!0;this.scene.focusCameraOnGridPosition(i.gridX,i.gridY,s);break}case xu:{const s=i.animate??!0;this.scene.focusCameraOnGridPosition(i.target.x,i.target.y,s);break}}}setZoom(i){const s=Ju(i,this.minZoom,this.maxZoom);Math.abs(s-this.userZoom)<1e-4||(this.userZoom=s,this.pendingStoreUpdate=!0,this.dispatchEvent(new CustomEvent(Iu,{detail:{zoom:this.userZoom}})),this.scheduleBroadcast())}adjustZoom(i){this.setZoom(this.userZoom+i)}getZoom(){return this.userZoom}centerOnPlayer(i=!0){if(!this.scene)return;const n=D.getState().player.data.position;this.scene.focusCameraOnGridPosition(n.x,n.y,i)}setCanvasBounds(i,s){this.controller.setCanvasBounds(i,s)&&(this.pendingStoreUpdate=!0,this.scheduleBroadcast())}requestImmediateState(){this.pendingStoreUpdate=!0,this.scheduleBroadcast(!0)}scheduleBroadcast(i=!1){if(i||!this.raf){this.broadcast();return}this.pendingFrame===null&&(this.pendingFrame=this.raf(()=>{this.pendingFrame=null,this.broadcast()}))}composeState(){return this.controller.compose(D.getState(),this.userZoom,this.lastPath)}broadcast(){if(!this.pendingStoreUpdate&&!this.pendingViewportUpdate)return;const i=this.composeState();if(this.pendingStoreUpdate=!1,this.pendingViewportUpdate=!1,!i)return;const s=this.shouldEmit(i);this.lastState=i,s&&this.dispatchEvent(new CustomEvent(Au,{detail:i}))}shouldEmit(i){if(!this.lastState)return!0;const s=this.lastState;if(i.areaId!==s.areaId)return!0;const n=i.dirtyLayers;return n.tiles||n.entities||n.overlays||n.viewport||n.path}}const mi=new eh,ls=(e,t)=>Reflect.get(e,t),bn=(e,t)=>{const i=ls(e,t);if(i==null)throw new Error(`[MinimapBridgeModule] Missing required scene value: ${t}`);return i},th=(e,t,...i)=>{const s=ls(e,t);if(typeof s!="function")throw new Error(`[MinimapBridgeModule] Missing required scene method: ${t}`);return s.apply(e,i)},ih=e=>({cameras:bn(e,"cameras"),sys:bn(e,"sys"),getCurrentMapArea:()=>ls(e,"currentMapArea")??null,worldToGridContinuous:(t,i)=>th(e,"worldToGridContinuous",t,i)});class sh{constructor(t,i){y(this,"key","minimapBridge");y(this,"ports");this.scene=t,this.ports=i??ih(t)}init(t){}onCreate(){mi.initialize(this.scene)}onShutdown(){mi.shutdown()}emitViewportUpdate(){if(!this.ports.getCurrentMapArea()||!this.ports.sys.isActive())return;const i=this.ports.cameras.main,s=i.worldView,n=this.ports.worldToGridContinuous(s.x,s.y),a=this.ports.worldToGridContinuous(s.x+s.width,s.y),r=this.ports.worldToGridContinuous(s.x,s.y+s.height),o=this.ports.worldToGridContinuous(s.x+s.width,s.y+s.height);if(!n||!a||!r||!o)return;const l=(n.x+a.x+r.x+o.x)/4,c=(n.y+a.y+r.y+o.y)/4,d=[Math.abs(a.x-n.x),Math.abs(o.x-r.x)].filter(b=>Number.isFinite(b)),u=[Math.abs(r.y-n.y),Math.abs(o.y-a.y)].filter(b=>Number.isFinite(b)),h=d.length?d.reduce((b,S)=>b+S,0)/d.length:0,g=u.length?u.reduce((b,S)=>b+S,0)/u.length:0,p=Math.max(1e-4,h),m=Math.max(1e-4,g),f={x:l-p/2,y:c-m/2,width:p,height:m};mi.updateViewport({...f,zoom:i.zoom})}}const he=(e,t)=>Reflect.get(e,t),nh=(e,t)=>{const i=he(e,t);if(i==null)throw new Error(`[StateSyncModule] Missing required scene value: ${t}`);return i},V=(e,t,...i)=>{const s=he(e,t);if(typeof s!="function")throw new Error(`[StateSyncModule] Missing required scene method: ${t}`);return s.apply(e,i)},ah=e=>({sys:nh(e,"sys"),getCurrentMapArea:()=>he(e,"currentMapArea")??null,setCurrentMapArea:t=>{Reflect.set(e,"currentMapArea",t)},getItemMarkerSignature:t=>V(e,"getItemMarkerSignature",t),renderStaticProps:()=>{V(e,"renderStaticProps")},updateDayNightOverlay:()=>{V(e,"updateDayNightOverlay")},updatePlayerPosition:t=>{V(e,"updatePlayerPosition",t)},updatePlayerVitalsIndicator:(t,i,s)=>{V(e,"updatePlayerVitalsIndicator",t,i,s)},updateEnemies:t=>{V(e,"updateEnemies",t)},updateNpcs:t=>{V(e,"updateNpcs",t)},renderVisionCones:()=>{V(e,"renderVisionCones")},updateSurveillanceCameras:(t,i)=>{V(e,"updateSurveillanceCameras",t,i)},zoomCameraForCombat:()=>{V(e,"zoomCameraForCombat")},restoreCameraAfterCombat:()=>{V(e,"restoreCameraAfterCombat")},destroyPlayerVitalsIndicator:()=>{V(e,"destroyPlayerVitalsIndicator")},destroyCameraSprites:()=>{V(e,"destroyCameraSprites")},setupCameraAndMap:()=>{V(e,"setupCameraAndMap")},clearPathPreview:()=>{V(e,"clearPathPreview")},enablePlayerCameraFollow:()=>{V(e,"enablePlayerCameraFollow")},resetCameraRuntimeStateForMapTransition:()=>{var i;const t=he(e,"cameraModule");(i=t==null?void 0:t.resetForMapTransition)==null||i.call(t)},clearEntityRuntimeStateForMapTransition:()=>{var i;const t=he(e,"entityRenderModule");(i=t==null?void 0:t.clearForMapTransition)==null||i.call(t)},clearWorldRuntimeStateForMapTransition:()=>{var i;const t=he(e,"worldRenderModule");(i=t==null?void 0:t.clearForMapTransition)==null||i.call(t)},resetEntityCombatIndicators:()=>{var i;const t=he(e,"entityRenderModule");(i=t==null?void 0:t.resetCombatIndicators)==null||i.call(t)},readRuntimeState:()=>{const t=he(e,"currentMapArea");return{curfewActive:!!he(e,"curfewActive"),inCombat:!!he(e,"inCombat"),lastMapAreaId:(t==null?void 0:t.id)??null,isMapTransitionPending:!1}},writeRuntimeState:t=>{Reflect.set(e,"curfewActive",t.curfewActive),Reflect.set(e,"inCombat",t.inCombat)}}),rh=()=>({curfewActive:!1,inCombat:!1,lastMapAreaId:null,isMapTransitionPending:!1});class oh{constructor(t,i){y(this,"key","stateSync");y(this,"ports");y(this,"runtimeState");var s,n;this.ports=i??ah(t),this.runtimeState={...rh(),...(n=(s=this.ports).readRuntimeState)==null?void 0:n.call(s)},this.pushRuntimeStateToPorts()}init(){}isInCombat(){return this.runtimeState.inCombat}isCurfewActive(){return this.runtimeState.curfewActive}onStateChange(t,i){var m,f,b,S,M,v,A,I,x,T,O,w;const s=this.ports.getCurrentMapArea();if(!this.ports.sys.isActive()||!s)return;const n=i.player.data,a=i.world,r=a.currentMapArea.entities.enemies,o=this.runtimeState.inCombat;if(this.runtimeState.inCombat=a.inCombat,this.runtimeState.inCombat&&!o&&this.ports.zoomCameraForCombat(),!this.runtimeState.inCombat&&o&&(this.ports.restoreCameraAfterCombat(),this.ports.destroyPlayerVitalsIndicator(),(f=(m=this.ports).resetEntityCombatIndicators)==null||f.call(m)),this.ports.updateDayNightOverlay(),!a.currentMapArea||!s){this.pushRuntimeStateToPorts();return}const l=a.currentMapArea,c=this.runtimeState.lastMapAreaId??s.id,d=l.id;this.runtimeState.isMapTransitionPending=c!==d,this.runtimeState.isMapTransitionPending&&((S=(b=this.ports).resetCameraRuntimeStateForMapTransition)==null||S.call(b),(v=(M=this.ports).clearEntityRuntimeStateForMapTransition)==null||v.call(M),(I=(A=this.ports).clearWorldRuntimeStateForMapTransition)==null||I.call(A),this.ports.destroyCameraSprites(),this.ports.setCurrentMapArea(l),this.ports.setupCameraAndMap(),this.ports.clearPathPreview(),this.ports.enablePlayerCameraFollow(),this.runtimeState.lastMapAreaId=d,this.runtimeState.isMapTransitionPending=!1);const u=this.ports.getItemMarkerSignature(s);this.ports.setCurrentMapArea(l);const h=this.ports.getItemMarkerSignature(l);u!==h&&this.ports.renderStaticProps(),this.runtimeState.curfewActive=a.curfewActive,this.ports.updatePlayerPosition(n.position),this.ports.updatePlayerVitalsIndicator(n.position,n.health,n.maxHealth),this.ports.updateEnemies(r),this.ports.updateNpcs(l.entities.npcs),this.ports.renderVisionCones();const g=(T=(x=i.surveillance)==null?void 0:x.zones)==null?void 0:T[l.id],p=((w=(O=i.surveillance)==null?void 0:O.hud)==null?void 0:w.overlayEnabled)??!1;this.ports.updateSurveillanceCameras(g,p),this.runtimeState.lastMapAreaId=d,this.pushRuntimeStateToPorts()}pushRuntimeStateToPorts(){var t,i;(i=(t=this.ports).writeRuntimeState)==null||i.call(t,this.runtimeState)}}const Ne={suspicionThreshold:30,investigationThreshold:60,alarmThreshold:100,progressGainPerTick:10,progressDecayPerTick:5,reinforcementDelay:2e3},Fa=(e,t,i)=>{const s=t.x-e.x,n=t.y-e.y;if(Math.sqrt(s*s+n*n)>i.range)return!1;const o=(Math.atan2(n,s)*(180/Math.PI)+360)%360,l=(i.direction+360)%360;let c=Math.abs(o-l);return c>180&&(c=360-c),c<=i.angle/2},Ba=(e,t,i)=>{const s=lh(e,t);for(const n of s){if(n.x===e.x&&n.y===e.y||n.x===t.x&&n.y===t.y)continue;if(n.x<0||n.y<0||n.y>=i.height||n.x>=i.width)return!1;const a=i.tiles[n.y][n.x];if(!a.isWalkable&&a.type!=="cover")return!1}return!0},lh=(e,t)=>{const i=[];let s=Math.floor(e.x),n=Math.floor(e.y);const a=Math.floor(t.x),r=Math.floor(t.y),o=Math.abs(a-s),l=Math.abs(r-n),c=s<a?1:-1,d=n<r?1:-1;let u=o-l;for(;i.push({x:s,y:n}),!(s===a&&n===r);){const h=2*u;h>-l&&(u-=l,s+=c),h<o&&(u+=o,n+=d)}return i},Oa=(e,t,i)=>!e.visionCone||!Fa(e.position,t.position,e.visionCone)?!1:Ba(e.position,t.position,i),ch=(e,t,i=1)=>{const s=e.alertProgress??0;let n=s;if(t){const o=Ne.progressGainPerTick*Math.max(0,i);n=Math.min(100,s+o)}else n=Math.max(0,s-Ne.progressDecayPerTick);let a=L.IDLE;n>=Ne.alarmThreshold?a=L.ALARMED:n>=Ne.investigationThreshold?a=L.INVESTIGATING:n>=Ne.suspicionThreshold&&(a=L.SUSPICIOUS);const r=t?void 0:e.lastKnownPlayerPosition;return{...e,alertProgress:n,alertLevel:a,lastKnownPlayerPosition:r}},dh=(e,t)=>{if(!e.visionCone)return e;const i=t.x-e.position.x,s=t.y-e.position.y,a=(Math.atan2(s,i)*(180/Math.PI)+360)%360;return{...e,visionCone:{...e.visionCone,direction:a}}},uh=(e,t,i)=>{const s=[],{range:n}=t;for(let a=-n;a<=n;a++)for(let r=-n;r<=n;r++){const o={x:e.x+r,y:e.y+a};o.x<0||o.y<0||o.y>=i.height||o.x>=i.width||Fa(e,o,t)&&Ba(e,o,i)&&s.push(o)}return s},wn=P.Math.DEG_TO_RAD,Xe={[ne.IDLE]:{fill:3900150,alpha:.15},[ne.SUSPICIOUS]:{fill:16436245,alpha:.22},[ne.ALARMED]:{fill:15680580,alpha:.3},[ne.DISABLED]:{fill:6583435,alpha:.12}};class hh extends P.GameObjects.Container{constructor(i,s,n,a){super(i,s,n);y(this,"housing");y(this,"lens");y(this,"led");y(this,"cone");y(this,"ledTween",null);y(this,"rangePixels");y(this,"fieldOfView");y(this,"direction");y(this,"tileSize");y(this,"isActiveSprite",!1);y(this,"alertState",ne.DISABLED);y(this,"overlayVisible",!1);const{tileSize:r,rangeTiles:o,fieldOfView:l,initialDirection:c}=a;this.tileSize=r,this.fieldOfView=l,this.direction=c,this.rangePixels=o*r,this.housing=i.add.rectangle(0,0,r*.5,r*.35,3355443,1),this.housing.setOrigin(.5,.5),this.lens=i.add.ellipse(r*.15,0,r*.22,r*.16,0,1),this.lens.setStrokeStyle(1,2042167,.6),this.led=i.add.circle(-r*.18,-r*.08,r*.12,16711680,1),this.led.setAlpha(0),this.cone=i.add.graphics(),this.cone.setAlpha(0),this.cone.setDepth(-1),this.add([this.cone,this.housing,this.lens,this.led]),this.setSize(r,r),this.scene.add.existing(this),this.drawVisionCone(),this.setAlertState(ne.DISABLED)}setActiveState(i){this.isActiveSprite!==i&&(this.isActiveSprite=i,i?this.ledTween?this.ledTween.resume():this.ledTween=this.scene.tweens.add({targets:this.led,alpha:{from:1,to:.3},duration:1e3,ease:"Sine.easeInOut",yoyo:!0,repeat:-1}):(this.ledTween&&this.ledTween.pause(),this.led.setAlpha(0)),this.refreshConeAlpha())}setAlertState(i){this.alertState=i;const{fill:s}=Xe[i];this.drawVisionCone(s),this.isActiveSprite&&i!==ne.DISABLED?this.led.setFillStyle(i===ne.ALARMED?16731471:2282478,1):i===ne.DISABLED&&this.led.setFillStyle(6583435,.8),this.refreshConeAlpha()}setDirection(i){this.direction=i,this.drawVisionCone(),this.refreshConeAlpha()}setRangeTiles(i){this.rangePixels=i*this.tileSize,this.drawVisionCone(),this.refreshConeAlpha()}updateVision(i){this.cone.setPosition(i.x-this.x,i.y-this.y)}setOverlayVisible(i){this.overlayVisible!==i&&(this.overlayVisible=i,this.refreshConeAlpha())}destroy(i){this.ledTween&&(this.ledTween.stop(),this.ledTween.remove(),this.ledTween=null),super.destroy(i)}drawVisionCone(i){const s=i??Xe[this.alertState].fill;this.cone.clear();const n=(this.direction-this.fieldOfView/2)*wn,a=(this.direction+this.fieldOfView/2)*wn;this.cone.fillStyle(s,Xe[this.alertState].alpha),this.cone.slice(0,0,this.rangePixels,n,a,!1),this.cone.fillPath(),this.cone.lineStyle(1.2,s,Math.min(.65,Xe[this.alertState].alpha+.1)),this.cone.beginPath(),this.cone.moveTo(0,0),this.cone.arc(0,0,this.rangePixels,n,a,!1),this.cone.closePath(),this.cone.strokePath()}refreshConeAlpha(){const s=this.isActiveSprite&&this.overlayVisible&&this.alertState!==ne.DISABLED?Xe[this.alertState].alpha:0;this.cone.setAlpha(s)}}const Nt=(e,t)=>Reflect.get(e,t),gi=(e,t,...i)=>{const s=Nt(e,t);if(typeof s!="function")throw new Error(`[SurveillanceRenderModule] Missing required scene method: ${t}`);return s.apply(e,i)},ph=e=>({getCurrentMapArea:()=>Nt(e,"currentMapArea")??null,getVisionConeGraphics:()=>Nt(e,"visionConeGraphics"),getTileSize:()=>{const t=Nt(e,"tileSize");return typeof t=="number"?t:0},getIsoMetrics:()=>gi(e,"getIsoMetrics"),calculatePixelPosition:(t,i)=>gi(e,"calculatePixelPosition",t,i),syncDepth:(t,i,s,n)=>{gi(e,"syncDepth",t,i,s,n)}});class mh{constructor(t,i){y(this,"key","surveillanceRender");y(this,"cameraSprites",new Map);y(this,"ports");this.scene=t,this.ports=i??ph(t)}init(t){}onShutdown(){this.clearCameraSprites()}clearCameraSprites(){this.cameraSprites.forEach(t=>{t.destroy(!0)}),this.cameraSprites.clear()}renderVisionCones(){const t=this.ports.getCurrentMapArea(),i=this.ports.getVisionConeGraphics();if(!t||!i)return;i.clear();const s=t.entities.enemies,n=this.ports.getIsoMetrics();s.forEach(a=>{if(!a.visionCone||a.health<=0)return;const r=uh(a.position,a.visionCone,t);if(r.length===0)return;let o=16776960,l=.1;switch(a.alertLevel){case L.SUSPICIOUS:o=16755200,l=.15;break;case L.INVESTIGATING:o=16737792,l=.2;break;case L.ALARMED:o=16711680,l=.25;break;default:o=16776960,l=.1}i.fillStyle(o,l),r.forEach(c=>{const d=this.ports.calculatePixelPosition(c.x,c.y),u=[d.x,d.y-n.tileHeight/2,d.x+n.tileWidth/2,d.y,d.x,d.y+n.tileHeight/2,d.x-n.tileWidth/2,d.y];i.fillPoints(u,!0)})})}updateSurveillanceCameras(t,i=!1){const s=this.ports.getCurrentMapArea();if(!t||!s){this.cameraSprites.size>0&&this.clearCameraSprites();return}const n=new Set(this.cameraSprites.keys()),a=this.ports.getIsoMetrics();Object.values(t.cameras).forEach(r=>{n.delete(r.id);const o=this.ports.calculatePixelPosition(r.position.x,r.position.y);let l=this.cameraSprites.get(r.id);l?(l.setPosition(o.x,o.y),l.setRangeTiles(r.range)):(l=new hh(this.scene,o.x,o.y,{tileSize:this.ports.getTileSize(),rangeTiles:r.range,fieldOfView:r.fieldOfView,initialDirection:r.currentDirection}),this.cameraSprites.set(r.id,l));const c=W.PROP_TALL+Math.round(a.tileHeight*.5);this.ports.syncDepth(l,o.x,o.y,c),l.setOverlayVisible(i),l.setActiveState(r.isActive),l.setAlertState(r.alertState),l.setDirection(r.currentDirection)}),n.forEach(r=>{const o=this.cameraSprites.get(r);o&&o.destroy(!0),this.cameraSprites.delete(r)})}}class gh{constructor(t,i){y(this,"wetReflectionAlpha");y(this,"emissiveIntensity");this.graphics=t,this.theme=i,this.wetReflectionAlpha=i.qualityBudget.wetReflectionAlpha,this.emissiveIntensity=.35}setAtmosphereProfile(t){this.wetReflectionAlpha=P.Math.Clamp(t.wetReflectionAlpha,0,.4),this.emissiveIntensity=P.Math.Clamp(t.emissiveIntensity,0,1)}drawTile(t,i){const s=i.groundOnly?{...t,type:R.FLOOR}:t,n=this.getTileBaseColor(s,i.gridX,i.gridY),a=((i.gridX*13^i.gridY*9)%9-4)*.01,r=k(n,a);if(this.drawGround(s,i,r),!i.groundOnly)switch(t.type){case R.COVER:this.drawCover(t,i,r);break;case R.WALL:this.drawWallVolume(t,i,r);break;case R.DOOR:this.drawDoorPortal(t,i,r);break;case R.WATER:case R.TRAP:this.drawHazardVariant(t,i,r);break}}drawGround(t,i,s){const n=this.getPoints(i.center.x,i.center.y,i.tileWidth,i.tileHeight),r=((Math.floor(i.gridX/4)^Math.floor(i.gridY/4))%5-2)*.03,o=k(s,r),l=k(o,.2),c=k(o,-.22);this.graphics.fillStyle(o,1),this.graphics.fillPoints(n,!0);const[d,u,h,g]=n,p=new P.Geom.Point(i.center.x,i.center.y);this.graphics.fillStyle(l,.35),this.graphics.fillPoints([d,u,p],!0),this.graphics.fillPoints([d,p,g],!0),this.graphics.fillStyle(c,.3),this.graphics.fillPoints([h,u,p],!0),this.graphics.fillPoints([h,p,g],!0),this.graphics.lineStyle(1,k(o,-.3),.42),this.graphics.strokePoints(n,!0),t.type===R.FLOOR?(i.gridX%5===0||i.gridY%5===0?(this.graphics.lineStyle(1.1,6809849,.12),this.graphics.strokePoints([d,p,h],!1),this.graphics.strokePoints([g,p,u],!1)):(i.gridX+i.gridY)%4===0&&(this.graphics.lineStyle(.85,3718648,.08),this.graphics.strokePoints(n,!0)),this.drawRoadReflection(t,i,n)):(t.type===R.COVER||t.type===R.WALL)&&(this.graphics.lineStyle(.9,16317180,.08),this.graphics.strokePoints(n,!0))}drawCover(t,i,s){const n=this.getElevationProfile(.5,i.tileWidth,i.tileHeight),a=this.getPoints(i.center.x,i.center.y,i.tileWidth,i.tileHeight),r=this.getPoints(i.center.x,i.center.y-n.heightOffset,n.topWidth,n.topHeight),o=[a[1],a[2],r[2],r[1]],l=[a[2],a[3],r[3],r[2]];this.graphics.fillStyle(k(s,-.15),.98),this.graphics.fillPoints(l,!0),this.graphics.fillStyle(k(s,-.08),.98),this.graphics.fillPoints(o,!0),this.graphics.fillStyle(k(s,.2),.95),this.graphics.fillPoints(r,!0),this.graphics.lineStyle(1.1,16498468,.3),this.graphics.strokePoints(r,!0)}drawWallVolume(t,i,s){const n=this.getElevationProfile(1.2,i.tileWidth,i.tileHeight),a=this.getPoints(i.center.x,i.center.y,i.tileWidth,i.tileHeight),r=this.getPoints(i.center.x,i.center.y-n.heightOffset,n.topWidth,n.topHeight),o=[a[1],a[2],r[2],r[1]],l=[a[2],a[3],r[3],r[2]];this.graphics.fillStyle(k(s,-.28),1),this.graphics.fillPoints(l,!0),this.graphics.fillStyle(k(s,-.16),1),this.graphics.fillPoints(o,!0);const c=k(s,.18);this.graphics.fillStyle(c,1),this.graphics.fillPoints(r,!0),this.graphics.lineStyle(1.2,2282478,.18),this.graphics.strokePoints(r,!0);const[d,u,h,g]=a,[p,m,f,b]=r;this.graphics.lineStyle(1,8246268,.2),this.graphics.strokePoints([g,b],!1),this.graphics.strokePoints([h,f],!1),this.graphics.strokePoints([u,m],!1),this.graphics.strokePoints([d,p],!1)}drawDoorPortal(t,i,s){const n=this.getPoints(i.center.x,i.center.y,i.tileWidth,i.tileHeight),[a,r,o,l]=n,c=this.lerpPoint(a,l,.22),d=this.lerpPoint(a,r,.22),u=this.lerpPoint(o,r,.3),h=this.lerpPoint(o,l,.3);this.graphics.fillStyle(k(s,-.2),.96),this.graphics.fillPoints([c,d,u,h],!0);const g=this.lerpPoint(c,h,.12),p=this.lerpPoint(d,u,.12),m=this.lerpPoint(d,u,.86),f=this.lerpPoint(c,h,.86);this.graphics.fillStyle(988970,.84),this.graphics.fillPoints([g,p,m,f],!0),this.graphics.lineStyle(1.3,3718648,.4),this.graphics.strokePoints([g,p],!1)}drawHazardVariant(t,i,s){const n=this.getPoints(i.center.x,i.center.y,i.tileWidth*.72,i.tileHeight*.72);if(t.type===R.WATER){const r=this.theme.qualityBudget.enableAnimatedHazards?.22+.12*(.5+.5*Math.sin(Date.now()%2e3/2e3*Math.PI*2)):.2;this.graphics.fillStyle(k(s,.2),r),this.graphics.fillPoints(n,!0),this.graphics.lineStyle(1,6809849,.22),this.graphics.strokePoints(n,!0);return}const a=this.theme.qualityBudget.enableAnimatedHazards?.18+.1*(.5+.5*Math.sin(Date.now()%1500/1500*Math.PI*2)):.18;this.graphics.fillStyle(k(s,.35),a),this.graphics.fillPoints(n,!0),this.graphics.lineStyle(1.1,16020150,.35),this.graphics.strokePoints(n,!0)}getTileBaseColor(t,i,s){const n=(i+s)%2===0,a=this.theme.tilePalettes;switch(t.type){case R.WALL:return n?a.wallEven:a.wallOdd;case R.COVER:return n?a.coverEven:a.coverOdd;case R.WATER:return n?a.waterEven:a.waterOdd;case R.TRAP:return n?a.trapEven:a.trapOdd;case R.DOOR:return n?a.doorEven:a.doorOdd;default:return n?a.floorEven:a.floorOdd}}getElevationProfile(t,i,s){return{heightOffset:s*(.48+t*.78),topWidth:i*Math.max(.7,1-t*.08),topHeight:s*Math.max(.62,1-t*.1)}}lerpPoint(t,i,s){return new P.Geom.Point(P.Math.Linear(t.x,i.x,s),P.Math.Linear(t.y,i.y,s))}getPoints(t,i,s,n){return Z(t,i,s,n).map(a=>new P.Geom.Point(a.x,a.y))}drawRoadReflection(t,i,s){if(!t.isWalkable||this.wetReflectionAlpha<=.01)return;const[n,a,r,o]=s,l=((i.gridX*11+i.gridY*17)%9-4)*.04,c=P.Math.Clamp(this.wetReflectionAlpha*(.7+this.emissiveIntensity*.65),.03,.28),d=k(6809849,-.12+l),u=k(16486972,-.25+l*.7);this.graphics.lineStyle(1,d,c),this.graphics.strokePoints([this.lerpPoint(o,n,.3),this.lerpPoint(r,a,.3)],!1),this.graphics.lineStyle(.8,u,c*.6),this.graphics.strokePoints([this.lerpPoint(n,a,.55),this.lerpPoint(o,r,.55)],!1)}}class fh{constructor(t,i){this.scene=t,this.theme=i}createMassing(t,i,s){const n=this.scene.add.container(s.center.x,s.center.y),a=this.scene.add.graphics(),r=this.scene.add.graphics(),o=this.scene.add.graphics(),l=this.toLocal(s.center,s.footprint),c=s.widthTiles+s.depthTiles,d=i.district==="downtown"?.78:.7,u=s.tileHeight*Math.max(.58,i.massingHeight*d),h=i.district==="downtown"?.03:.015,g=this.createRoof(l,u,h);return this.drawBaseShadow(a,l),this.drawBody(r,o,i,l,g),this.drawDistrictDetails(o,i,l,g,c),n.add([a,r,o]),n}createLabel(t,i,s,n){const a=this.scene.add.container(i.x,i.y-s*.24),r=this.scene.add.text(0,0,t.name,{fontFamily:'Orbitron, "DM Sans", sans-serif',fontSize:this.theme.qualityBudget.enableHighDensityLabels?"13px":"11px",fontStyle:"700",color:n.signagePrimaryHex,stroke:n.signageSecondaryHex,strokeThickness:1.6,align:"center"});r.setOrigin(.5),r.setShadow(0,0,n.glowHex,8,!0,!0);const c=this.scene.add.rectangle(0,0,r.width+14,r.height+8,this.hexToColor(n.backdropHex),.58);return c.setStrokeStyle(1.1,this.hexToColor(n.signageSecondaryHex),.72),a.add([c,r]),a}drawBaseShadow(t,i){t.fillStyle(132622,.14),t.fillPoints([i.top,i.right,i.bottom,i.left],!0)}drawBody(t,i,s,n,a){const r=[n.right,n.bottom,a.bottom,a.right],o=[n.bottom,n.left,a.left,a.bottom],l=[n.left,n.top,a.top,a.left],c=this.hexToColor(s.backdropHex),d=k(c,-.06),u=k(c,-.13),h=k(c,-.1),g=k(c,.03);t.fillStyle(h,.72),t.fillPoints(l,!0),t.fillStyle(d,.74),t.fillPoints(r,!0),t.fillStyle(u,.78),t.fillPoints(o,!0),t.fillStyle(g,.8),t.fillPoints([a.top,a.right,a.bottom,a.left],!0),t.lineStyle(1.2,this.hexToColor(s.trimHex),.24),t.strokePoints([a.top,a.right,a.bottom,a.left],!0),i.lineStyle(1,this.hexToColor(s.trimHex),.16),i.strokePoints([n.bottom,a.bottom],!1),i.strokePoints([n.left,a.left],!1),i.strokePoints([n.right,a.right],!1)}drawDistrictDetails(t,i,s,n,a){const r=[s.right,s.bottom,n.bottom,n.right],o=[s.bottom,s.left,n.left,n.bottom];if(i.district==="downtown"){const g=Math.max(4,Math.min(10,Math.floor(a*.8))),p=Math.max(3,Math.min(8,Math.floor(i.massingHeight*1.7))),m=this.hexToColor(i.signageSecondaryHex);this.drawFaceGrid(t,o,g,p,m,.2),this.drawFaceGrid(t,r,g,p,m,.16),t.lineStyle(1,this.hexToColor(i.signagePrimaryHex),.36),t.strokePoints([n.left,n.bottom,n.right],!1);return}const l=this.hexToColor(i.accentHex);t.lineStyle(1,l,.2);const c=this.lerpPoint(o[0],o[3],.44),d=this.lerpPoint(o[1],o[2],.44);t.strokePoints([c,d],!1);const u=this.lerpPoint(r[0],r[3],.36),h=this.lerpPoint(r[1],r[2],.36);t.strokePoints([u,h],!1)}drawFaceGrid(t,i,s,n,a,r){t.lineStyle(1,a,r);for(let o=1;o<s;o+=1){const l=o/s,c=this.lerpPoint(i[0],i[1],l),d=this.lerpPoint(i[3],i[2],l);t.strokePoints([c,d],!1)}for(let o=1;o<n;o+=1){const l=o/n,c=this.lerpPoint(i[0],i[3],l),d=this.lerpPoint(i[1],i[2],l);t.strokePoints([c,d],!1)}}createRoof(t,i,s){return{top:this.liftAndInset(t.top,i,s),right:this.liftAndInset(t.right,i,s),bottom:this.liftAndInset(t.bottom,i,s),left:this.liftAndInset(t.left,i,s)}}liftAndInset(t,i,s){return new P.Geom.Point(t.x*(1-s),t.y*(1-s)-i)}toLocal(t,i){const s=n=>new P.Geom.Point(n.x-t.x,n.y-t.y);return{top:s(i.top),right:s(i.right),bottom:s(i.bottom),left:s(i.left)}}lerpPoint(t,i,s){return new P.Geom.Point(P.Math.Linear(t.x,i.x,s),P.Math.Linear(t.y,i.y,s))}hexToColor(t){return P.Display.Color.HexStringToColor(t).color}}const yh=(e,t)=>{const i=e.entityProfiles[t];return{baseColor:i.baseColor,outlineColor:i.outlineColor,primaryColor:i.primaryColor,accentColor:i.accentColor,glowColor:i.glowColor,columnHeight:i.columnHeight,widthScale:i.widthScale,heightScale:i.heightScale,depthOffset:i.depthOffset}};class Sh{constructor(t,i){y(this,"motionByToken",new WeakMap);this.isoFactory=t,this.theme=i}createToken(t,i,s){const n=this.isoFactory.createCharacterToken(i,s,yh(this.theme,t));return this.decorateToken(t,n),this.motionByToken.set(n,{lastX:i,lastY:s,cadence:Math.abs(i*17+s*31)%11*.23}),n}positionToken(t,i,s){this.isoFactory.positionCharacterToken(t,i,s);const n=this.motionByToken.get(t),a=t.container.getData("rigShell"),r=t.container.getData("rigStride");if(!n||!a||!r)return;const o=i-n.lastX,l=s-n.lastY;if(o!==0||l!==0){n.cadence+=.55;const d=P.Math.Clamp(o*.22,-.24,.24);a.setRotation(d),t.container.scaleX=o<0?-1:1,r.setAlpha(.28+Math.min(.42,Math.abs(o)*.2+Math.abs(l)*.2)),r.setScale(1+Math.abs(o)*.1,1+Math.abs(l)*.08),t.halo.setAlpha(.2+Math.min(.16,(Math.abs(o)+Math.abs(l))*.08))}else n.cadence+=.08,a.setRotation(a.rotation*.86),r.setAlpha(Math.max(.12,r.alpha*.85)),r.setScale(P.Math.Linear(r.scaleX,1,.25),P.Math.Linear(r.scaleY,1,.25)),t.halo.setAlpha(P.Math.Linear(t.halo.alpha,.2,.2));a.y=-2+Math.sin(n.cadence)*1.8,t.beacon.y=-Math.sin(n.cadence+.45)*1.25,n.lastX=i,n.lastY=s}decorateToken(t,i){const s=this.theme.entityProfiles[t],n=i.container.scene.add.graphics(),a=i.container.scene.add.graphics(),r=i.container.scene.add.graphics(),o=16*s.widthScale,l=24*s.columnHeight*.64;switch(n.fillStyle(k(s.primaryColor,-.2),.9),n.lineStyle(1.2,s.outlineColor,.95),n.fillEllipse(0,-l*.3,o,l),n.strokeEllipse(0,-l*.3,o,l),a.fillStyle(s.accentColor,.94),a.lineStyle(1,k(s.accentColor,.35),.92),r.fillStyle(s.glowColor,.18),r.fillEllipse(0,2.5,21*s.widthScale,8.4*s.heightScale),r.setBlendMode(P.BlendModes.ADD),t){case"player":n.fillStyle(k(s.accentColor,-.15),.95),n.fillTriangle(0,-l*1.08,-4.4,-l*.64,4.4,-l*.64),a.fillTriangle(0,-l*.96,-3.4,-l*.7,3.4,-l*.7);break;case"hostileNpc":n.fillStyle(k(s.primaryColor,-.34),.98),n.fillRect(-o*.55,-l*.75,o*1.1,l*.32),a.fillTriangle(-4.5,-l*.85,-8.2,-l*.58,-2.2,-l*.58),a.fillTriangle(4.5,-l*.85,2.2,-l*.58,8.2,-l*.58);break;case"interactiveNpc":n.fillStyle(k(s.primaryColor,.08),.95),n.fillEllipse(0,-l*.86,o*.88,o*.72),a.fillStyle(s.accentColor,.9),a.fillCircle(0,-l*1.02,3.2),a.fillRect(-.8,-l*.96,1.6,9.6);break;case"friendlyNpc":default:n.fillStyle(k(s.primaryColor,.04),.92),n.fillEllipse(0,-l*.87,o*.92,o*.62),a.fillTriangle(0,-l*.96,-3.8,-l*.78,3.8,-l*.78);break}i.container.addAt(n,2),i.container.add(a),i.container.add(r),i.container.setData("rigShell",n),i.container.setData("rigStride",r);const c=i.container.scene.tweens.add({targets:a,alpha:{from:.4,to:.95},yoyo:!0,repeat:-1,duration:920+(t==="hostileNpc"?180:0),ease:"Sine.easeInOut"});i.container.once(P.GameObjects.Events.DESTROY,()=>{c.isPlaying()&&c.stop()})}}const Pe=e=>P.Math.Clamp(e,0,1),$=(e,t,i)=>{const s=P.Display.Color.ValueToColor(e),n=P.Display.Color.ValueToColor(t),a=Pe(i),r=P.Math.Linear(s.red,n.red,a),o=P.Math.Linear(s.green,n.green,a),l=P.Math.Linear(s.blue,n.blue,a);return P.Display.Color.GetColor(r,o,l)},vh=e=>{if(!e)return null;const t=e.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([0-9.]+)\)/i);if(!t)return null;const[,i,s,n,a]=t;return{color:P.Display.Color.GetColor(Number(i),Number(s),Number(n)),alpha:Pe(Number(a))}};class bh{constructor(t){this.theme=t}resolveAtmosphereProfile(t){const i=Pe(t.districtWeight),s=t.timeSeconds%180/180*Math.PI*2,a=1-Pe(.5+.5*Math.sin(s-Math.PI*.5)),r=$(1323092,728122,a*.45),o=$(4071715,2166805,a*.42),l=$(o,r,i),c=$(l,396053,.3+a*.38),d=$(l,792880,.24+i*.22+a*.24),u=$(1707796,926264,i*.58),h=$(593173,1189440,i*.62),g=Math.max(1,this.theme.qualityBudget.maxFogBands),p=[];for(let A=0;A<g;A+=1){const I=(A+1)/(g+1),x=$(2760230,1522266,i*.7+I*.2),T=Pe((.16+a*.12)*(1-I*.72));p.push({widthFactor:1.1+I*.95,heightFactor:.34+I*.28,yFactor:.66+I*.2,color:x,alpha:T})}const m=Pe(.28+a*.56+i*.12+this.theme.qualityBudget.maxEmissiveZones*.012),f=Pe(this.theme.qualityBudget.wetReflectionAlpha*(.68+a*.65)),b=vh(t.baseOverlayRgba),S=$(725536,2298136,1-i),M=b?$(b.color,S,.22+a*.26):S,v=Pe(((b==null?void 0:b.alpha)??.12+a*.32)*(.9+a*.2));return{gradientTopLeft:c,gradientTopRight:d,gradientBottomLeft:u,gradientBottomRight:h,skylineDowntownColor:$(2051962,1391198,a*.45),skylineSlumsColor:$(5909034,3808548,a*.4),skylineColumns:this.theme.preset==="cinematic"?34:this.theme.preset==="balanced"?30:24,skylineSplit:P.Math.Clamp(.24+i*.52,.2,.82),skylineAlphaBase:.22+a*.16,skylineAlphaVariance:.12,horizonGlowColor:$(6105141,2972550,i),horizonGlowAlpha:.14+a*.1,lowerHazeColor:$(329485,659485,i*.4),lowerHazeAlpha:.42+a*.2,fogBands:p,emissiveIntensity:m,wetReflectionAlpha:f,overlayColor:M,overlayAlpha:v}}}const _t=20,Pn=1.06;class wh{constructor(){y(this,"previousFrameMassAlpha",new WeakMap);y(this,"previousFrameEntityVisuals",new WeakMap)}applyOcclusionReadability(t){const i=P.Math.Clamp(t.occlusionFadeFloor,.2,.9),s=P.Math.Clamp(.14+t.emissiveIntensity*.3,.12,.5);this.restorePreviousFrameState(t),t.masses.forEach(n=>{this.previousFrameMassAlpha.has(n.container)||this.previousFrameMassAlpha.set(n.container,n.container.alpha)}),t.masses.forEach(n=>{const a=new P.Geom.Rectangle(n.bounds.x-_t,n.bounds.y-_t,n.bounds.width+_t*2,n.bounds.height+_t*2),r=t.entities.filter(o=>a.contains(o.pixelX,o.pixelY));r.length&&(this.previousFrameMassAlpha.has(n.container)||this.previousFrameMassAlpha.set(n.container,n.container.alpha),n.container.setAlpha(Math.min(n.container.alpha,i)),r.forEach(o=>{var d,u,h,g,p;const l=o.token.container;this.previousFrameEntityVisuals.has(l)||this.previousFrameEntityVisuals.set(l,{haloAlpha:o.token.halo.alpha,beaconAlpha:o.token.beacon.alpha,nameAlpha:((d=o.nameLabel)==null?void 0:d.alpha)??1,nameScaleX:((u=o.nameLabel)==null?void 0:u.scaleX)??1,nameScaleY:((h=o.nameLabel)==null?void 0:h.scaleY)??1,healthAlpha:((g=o.healthBar)==null?void 0:g.alpha)??1,indicatorAlpha:((p=o.indicator)==null?void 0:p.alpha)??1});const c=o.token;c.halo.setAlpha(Math.max(c.halo.alpha,.28+s)),c.beacon.setAlpha(Math.max(c.beacon.alpha,.36+s*.75)),o.nameLabel&&(o.nameLabel.setAlpha(1),o.nameLabel.setScale(Math.max(o.nameLabel.scaleX,Pn),Math.max(o.nameLabel.scaleY,Pn))),o.healthBar&&o.healthBar.visible&&o.healthBar.setAlpha(Math.max(o.healthBar.alpha,.94)),o.indicator&&o.indicator.visible&&o.indicator.setAlpha(Math.max(o.indicator.alpha,.94))}))})}restorePreviousFrameState(t){t.masses.forEach(i=>{const s=this.previousFrameMassAlpha.get(i.container);typeof s=="number"&&i.container.setAlpha(s),this.previousFrameMassAlpha.delete(i.container)}),t.entities.forEach(i=>{this.restoreEntityBaseState(i)})}restoreEntityBaseState(t){const i=t.token.container,s=this.previousFrameEntityVisuals.get(i);s&&(t.token.halo.setAlpha(s.haloAlpha),t.token.beacon.setAlpha(s.beaconAlpha),t.nameLabel&&(t.nameLabel.setAlpha(s.nameAlpha),t.nameLabel.setScale(s.nameScaleX,s.nameScaleY)),t.healthBar&&t.healthBar.setAlpha(s.healthAlpha),t.indicator&&t.indicator.setAlpha(s.indicatorAlpha),this.previousFrameEntityVisuals.delete(i))}}const Mn={"items.corporate_keycard":"Keycard","items.encrypted_datapad":"Datapad","items.transit_tokens":"Transit Token","items.abandoned_medkit":"Medkit","items.holo_projector_lens":"Lens","items.saboteur_charge_kit":"Charge Kit"},An={misc_corporate_keycard:"Keycard",misc_encrypted_datapad:"Datapad",misc_transit_tokens:"Transit Token",misc_abandoned_medkit:"Medkit",misc_holo_projector_lens:"Lens",misc_saboteur_charge_kit:"Charge Kit"},Ph=e=>e.resourceKey&&Mn[e.resourceKey]?Mn[e.resourceKey]:e.definitionId&&An[e.definitionId]?An[e.definitionId]:e.name,B=(e,t)=>Reflect.get(e,t),Dt=(e,t)=>{const i=B(e,t);if(i==null)throw new Error(`[WorldRenderModule] Missing required scene value: ${t}`);return i},Lt=(e,t,i)=>{const s=B(e,t);return typeof s=="number"?s:i},Qe=(e,t,...i)=>{const s=B(e,t);if(typeof s!="function")throw new Error(`[WorldRenderModule] Missing required scene method: ${t}`);return s.apply(e,i)},Mh=()=>({visualTheme:es("balanced"),tilePainter:void 0,buildingPainter:void 0,characterRigFactory:void 0,atmosphereDirector:void 0,occlusionReadabilityController:void 0,buildingVisualProfiles:{},buildingLabels:[],buildingMassings:[],buildingMassingEntries:[],currentAtmosphereProfile:void 0,lastAtmosphereRedrawBucket:-1,lastItemMarkerSignature:""}),Ah=e=>({add:Dt(e,"add"),game:Dt(e,"game"),lights:Dt(e,"lights"),mapGraphics:Dt(e,"mapGraphics"),getBackdropGraphics:()=>B(e,"backdropGraphics"),getCurrentMapArea:()=>B(e,"currentMapArea")??null,getCurrentGameTime:()=>Lt(e,"currentGameTime",0),getTileSize:()=>Lt(e,"tileSize",0),getIsoFactory:()=>B(e,"isoFactory"),ensureIsoFactory:()=>{Qe(e,"ensureIsoFactory")},getIsoMetrics:()=>Qe(e,"getIsoMetrics"),calculatePixelPosition:(t,i)=>Qe(e,"calculatePixelPosition",t,i),syncDepth:(t,i,s,n)=>{Qe(e,"syncDepth",t,i,s,n)},renderVisionCones:()=>{Qe(e,"renderVisionCones")},getStaticPropGroup:()=>B(e,"staticPropGroup"),setStaticPropGroup:t=>{Reflect.set(e,"staticPropGroup",t)},getLightsFeatureEnabled:()=>!!B(e,"lightsFeatureEnabled"),setLightsFeatureEnabled:t=>{Reflect.set(e,"lightsFeatureEnabled",t)},getDemoLampGrid:()=>B(e,"demoLampGrid"),setDemoLampGrid:t=>{Reflect.set(e,"demoLampGrid",t)},getDemoPointLight:()=>B(e,"demoPointLight"),setDemoPointLight:t=>{Reflect.set(e,"demoPointLight",t)},getLightingAmbientColor:()=>Lt(e,"lightingAmbientColor",988970),readEntityRuntimeState:()=>({playerToken:B(e,"playerToken"),playerNameLabel:B(e,"playerNameLabel"),enemySprites:B(e,"enemySprites")??new Map,npcSprites:B(e,"npcSprites")??new Map}),readRuntimeState:()=>({visualTheme:B(e,"visualTheme")??es("balanced"),tilePainter:B(e,"tilePainter"),buildingPainter:B(e,"buildingPainter"),characterRigFactory:B(e,"characterRigFactory"),atmosphereDirector:B(e,"atmosphereDirector"),occlusionReadabilityController:B(e,"occlusionReadabilityController"),buildingVisualProfiles:B(e,"buildingVisualProfiles")??{},buildingLabels:B(e,"buildingLabels")??[],buildingMassings:B(e,"buildingMassings")??[],buildingMassingEntries:B(e,"buildingMassingEntries")??[],currentAtmosphereProfile:B(e,"currentAtmosphereProfile"),lastAtmosphereRedrawBucket:Lt(e,"lastAtmosphereRedrawBucket",-1),lastItemMarkerSignature:B(e,"lastItemMarkerSignature")??""}),writeRuntimeState:t=>{Reflect.set(e,"visualTheme",t.visualTheme),Reflect.set(e,"tilePainter",t.tilePainter),Reflect.set(e,"buildingPainter",t.buildingPainter),Reflect.set(e,"characterRigFactory",t.characterRigFactory),Reflect.set(e,"atmosphereDirector",t.atmosphereDirector),Reflect.set(e,"occlusionReadabilityController",t.occlusionReadabilityController),Reflect.set(e,"buildingVisualProfiles",t.buildingVisualProfiles),Reflect.set(e,"buildingLabels",t.buildingLabels),Reflect.set(e,"buildingMassings",t.buildingMassings),Reflect.set(e,"buildingMassingEntries",t.buildingMassingEntries),Reflect.set(e,"currentAtmosphereProfile",t.currentAtmosphereProfile),Reflect.set(e,"lastAtmosphereRedrawBucket",t.lastAtmosphereRedrawBucket),Reflect.set(e,"lastItemMarkerSignature",t.lastItemMarkerSignature)}});class Ih{constructor(t,i){y(this,"key","worldRender");y(this,"ports");y(this,"runtimeState");var s,n;this.scene=t,this.ports=i??Ah(t),this.runtimeState={...Mh(),...(n=(s=this.ports).readRuntimeState)==null?void 0:n.call(s)},this.pushRuntimeStateToPorts()}init(){}onShutdown(){this.clearForMapTransition(),this.disableLighting(!0)}createCharacterToken(t,i,s){if(this.ensureVisualPipeline(),this.ports.ensureIsoFactory(),this.runtimeState.characterRigFactory)return this.runtimeState.characterRigFactory.createToken(t,i,s);const n=this.ports.getIsoFactory();if(!n)throw new Error("[WorldRenderModule] IsoObjectFactory not available while creating character token.");return n.createCharacterToken(i,s,this.runtimeState.visualTheme.entityProfiles[t])}positionCharacterToken(t,i,s){if(this.runtimeState.characterRigFactory){this.runtimeState.characterRigFactory.positionToken(t,i,s);return}const n=this.ports.getIsoFactory();if(!n)throw new Error("[WorldRenderModule] IsoObjectFactory not available while positioning character token.");n.positionCharacterToken(t,i,s)}getAtmosphereRedrawBucket(){return this.runtimeState.lastAtmosphereRedrawBucket}setAtmosphereRedrawBucket(t){this.runtimeState.lastAtmosphereRedrawBucket=t,this.pushRuntimeStateToPorts()}ensureVisualPipeline(){const t=D.getState().settings.visualQualityPreset,i=!this.runtimeState.visualTheme||this.runtimeState.visualTheme.preset!==t;(!this.runtimeState.visualTheme||this.runtimeState.visualTheme.preset!==t)&&(this.runtimeState.visualTheme=es(t)),this.ports.mapGraphics&&(!this.runtimeState.tilePainter||i)&&(this.runtimeState.tilePainter=new gh(this.ports.mapGraphics,this.runtimeState.visualTheme)),(!this.runtimeState.buildingPainter||i)&&(this.runtimeState.buildingPainter=new fh(this.scene,this.runtimeState.visualTheme)),(!this.runtimeState.atmosphereDirector||i)&&(this.runtimeState.atmosphereDirector=new bh(this.runtimeState.visualTheme),this.runtimeState.lastAtmosphereRedrawBucket=-1),(!this.runtimeState.occlusionReadabilityController||i)&&(this.runtimeState.occlusionReadabilityController=new wh);const s=this.ports.getIsoFactory();s&&(!this.runtimeState.characterRigFactory||i)&&(this.runtimeState.characterRigFactory=new Sh(s,this.runtimeState.visualTheme));const n=this.ports.getCurrentMapArea();if(n!=null&&n.buildings){const a={};n.buildings.forEach(r=>{const o=Ft(r.district,r.signageStyle,r.propDensity);a[r.id]=r.visualProfile?{district:r.district==="downtown"?"downtown":"slums",signageStyle:r.signageStyle??o.signageStyle,propDensity:r.propDensity??o.propDensity,facadePattern:r.visualProfile.facadePattern??o.facadePattern,lotPattern:r.visualProfile.lotPattern??o.lotPattern,massingStyle:r.visualProfile.massingStyle??o.massingStyle,massingHeight:r.visualProfile.massingHeight??o.massingHeight,accentHex:r.visualProfile.accentHex??o.accentHex,glowHex:r.visualProfile.glowHex??o.glowHex,trimHex:r.visualProfile.trimHex??o.trimHex,atmosphereHex:r.visualProfile.atmosphereHex??o.atmosphereHex,signagePrimaryHex:r.visualProfile.signagePrimaryHex??o.signagePrimaryHex,signageSecondaryHex:r.visualProfile.signageSecondaryHex??o.signageSecondaryHex,backdropHex:r.visualProfile.backdropHex??o.backdropHex}:o}),this.runtimeState.buildingVisualProfiles=a}else this.runtimeState.buildingVisualProfiles={};this.pushRuntimeStateToPorts()}renderStaticProps(){const t=this.ports.getStaticPropGroup();if(t&&t.clear(!0,!0),this.ports.setDemoLampGrid(void 0),this.destroyDemoPointLight(),!this.ports.getIsoFactory()||!this.ports.getCurrentMapArea())return;this.ensureVisualPipeline(),this.ports.getStaticPropGroup()||this.ports.setStaticPropGroup(this.ports.add.group());const i=l=>{var c;l&&((c=this.ports.getStaticPropGroup())==null||c.add(l))},s=this.ports.getCurrentMapArea();if(!s)return;const n=(s.entities.npcs??[]).filter(l=>l.isInteractive),a=(s.entities.items??[]).filter(l=>!!l.position),r=this.ports.getIsoFactory();if(!r)return;const o=this.ports.getIsoMetrics();n.forEach(l=>{i(r.createPulsingHighlight(l.position.x,l.position.y,{color:2282478,alpha:.14,pulseColor:8246268,pulseAlpha:{from:.26,to:.05},pulseScale:1.22,widthScale:.58,heightScale:.58,depthOffset:9,duration:1400}))}),a.forEach(l=>{const c=l.isQuestItem?16436245:2282478,d=l.isQuestItem?16774079:8246268,u=this.ports.calculatePixelPosition(l.position.x,l.position.y),h=Ph(l);i(r.createPulsingHighlight(l.position.x,l.position.y,{color:c,alpha:l.isQuestItem?.24:.22,pulseColor:d,pulseAlpha:{from:l.isQuestItem?.34:.3,to:.08},pulseScale:l.isQuestItem?1.28:1.22,widthScale:.72,heightScale:.72,depthOffset:8,duration:l.isQuestItem?1150:1300}));const g=this.ports.add.text(u.x,u.y-o.tileHeight*.7,h,{fontFamily:'Orbitron, "DM Sans", sans-serif',fontSize:"10px",fontStyle:"700",color:l.isQuestItem?"#fde68a":"#dbeafe",align:"center"});g.setOrigin(.5,1),g.setStroke(l.isQuestItem?"#f59e0b":"#0284c7",1.1),g.setShadow(0,0,l.isQuestItem?"#f59e0b":"#38bdf8",8,!0,!0),this.ports.syncDepth(g,u.x,u.y,W.FLOATING_UI+14),i(g)}),this.ports.getLightsFeatureEnabled()&&this.rebuildLightingDemoLight(),this.runtimeState.lastItemMarkerSignature=this.getItemMarkerSignature(s),this.pushRuntimeStateToPorts()}getItemMarkerSignature(t){if(!t)return"";const i=(t.entities.items??[]).filter(s=>!!s.position);return i.length===0?"":i.map(s=>`${s.id??s.name}@${s.position.x},${s.position.y}`).sort().join("|")}applyLightingSettings(t){var a;const i=(a=this.runtimeState.visualTheme)==null?void 0:a.preset;(!this.runtimeState.visualTheme||i!==t.qualityPreset)&&(this.ensureVisualPipeline(),this.refreshVisualLayers());const s=xs(t.qualityPreset),n=t.lightsEnabled&&t.qualityPreset!=="performance";if(n&&!this.hasLightPipelineSupport()){console.warn("[MainScene] Light2D not supported by current renderer; disabling lighting toggle."),D.dispatch(Ws(!1)),Jt({lightsEnabled:!1}),this.disableLighting(!0);return}n?this.enableLighting():this.disableLighting(),!s.colorMatrixEnabled&&t.colorMatrix.enabled&&Jt({colorMatrix:{enabled:!1}})}refreshVisualLayers(){const t=this.ports.getCurrentMapArea();t&&(this.runtimeState.currentAtmosphereProfile=void 0,this.drawBackdrop(),this.drawMap(t.tiles),this.drawBuildingMasses(),this.drawBuildingLabels(),this.renderStaticProps(),this.ports.renderVisionCones(),this.applyOcclusionReadability(),this.pushRuntimeStateToPorts())}drawMap(t){var o,l,c;if(!this.ports.mapGraphics)return;this.ensureVisualPipeline();const i=this.resolveAtmosphereProfile();(o=this.runtimeState.tilePainter)==null||o.setAtmosphereProfile({wetReflectionAlpha:i.wetReflectionAlpha,emissiveIntensity:i.emissiveIntensity}),this.ports.mapGraphics.clear();const{tileWidth:s,tileHeight:n}=this.ports.getIsoMetrics(),a=this.ports.getCurrentMapArea(),r=new Set;(l=a==null?void 0:a.buildings)==null||l.forEach(d=>{for(let u=d.footprint.from.y;u<=d.footprint.to.y;u+=1)for(let h=d.footprint.from.x;h<=d.footprint.to.x;h+=1)r.add(`${h}:${u}`)});for(let d=0;d<t.length;d+=1)for(let u=0;u<t[0].length;u+=1){const h=t[d][u],g=this.ports.calculatePixelPosition(u,d),p=((c=a==null?void 0:a.zoneId)==null?void 0:c.startsWith("downtown_checkpoint"))&&h.type===R.COVER,m=r.has(`${u}:${d}`),f=p||m&&(h.type===R.WALL||h.type===R.COVER||h.type===R.DOOR);this.renderTile(h,g,s,n,u,d,f)}}drawBuildingMasses(){var a;this.runtimeState.buildingMassings.forEach(r=>r.destroy(!0)),this.runtimeState.buildingMassings=[],this.runtimeState.buildingMassingEntries=[];const t=this.ports.getCurrentMapArea();if(!((a=t==null?void 0:t.buildings)!=null&&a.length)||!this.runtimeState.buildingPainter){this.pushRuntimeStateToPorts();return}this.ensureVisualPipeline();const i=this.runtimeState.buildingPainter;if(!i)return;const{tileWidth:s,tileHeight:n}=this.ports.getIsoMetrics();t.buildings.forEach(r=>{const o=this.runtimeState.buildingVisualProfiles[r.id]??Ft(r.district,r.signageStyle,r.propDensity),l=r.footprint.to.x-r.footprint.from.x+1,c=r.footprint.to.y-r.footprint.from.y+1,d=this.ports.calculatePixelPosition(r.footprint.from.x,r.footprint.from.y),u=this.ports.calculatePixelPosition(r.footprint.to.x,r.footprint.from.y),h=this.ports.calculatePixelPosition(r.footprint.to.x,r.footprint.to.y),g=this.ports.calculatePixelPosition(r.footprint.from.x,r.footprint.to.y),p={top:new P.Geom.Point(d.x,d.y-n*.5),right:new P.Geom.Point(u.x+s*.5,u.y),bottom:new P.Geom.Point(h.x,h.y+n*.5),left:new P.Geom.Point(g.x-s*.5,g.y)},m={x:(p.top.x+p.right.x+p.bottom.x+p.left.x)/4,y:(p.top.y+p.right.y+p.bottom.y+p.left.y)/4},f=i.createMassing(r,o,{center:m,tileHeight:n,widthTiles:l,depthTiles:c,footprint:p});f.setScrollFactor(1),this.ports.syncDepth(f,p.bottom.x,p.bottom.y,W.PROP_TALL+Math.round(o.massingHeight*12)),this.runtimeState.buildingMassings.push(f);const b=o.district==="downtown"?.78:.7,S=n*Math.max(.58,o.massingHeight*b),M=Math.min(p.top.x,p.right.x,p.bottom.x,p.left.x),v=Math.max(p.top.x,p.right.x,p.bottom.x,p.left.x),A=Math.min(p.top.y-S,p.right.y-S,p.bottom.y-S,p.left.y-S),I=Math.max(p.top.y,p.right.y,p.bottom.y,p.left.y);this.runtimeState.buildingMassingEntries.push({id:r.id,container:f,bounds:new P.Geom.Rectangle(M,A,Math.max(1,v-M),Math.max(1,I-A))})}),this.pushRuntimeStateToPorts()}drawBuildingLabels(){this.runtimeState.buildingLabels.forEach(s=>s.destroy(!0)),this.runtimeState.buildingLabels=[];const t=this.ports.getCurrentMapArea();if(!(t!=null&&t.buildings)||t.buildings.length===0){this.pushRuntimeStateToPorts();return}this.ensureVisualPipeline();const{tileHeight:i}=this.ports.getIsoMetrics();t.buildings.forEach(s=>{const n=this.runtimeState.buildingVisualProfiles[s.id]??Ft(s.district,s.signageStyle,s.propDensity),a=(s.footprint.from.x+s.footprint.to.x)/2,r=Math.min(s.footprint.from.y,s.door.y)-.4,o=this.ports.calculatePixelPosition(a,r),l=i*(.8+n.massingHeight*.18),c=this.runtimeState.buildingPainter?this.runtimeState.buildingPainter.createLabel(s,o,l,n):this.ports.add.container(o.x,o.y-i*.2);c.setScrollFactor(1),this.ports.syncDepth(c,o.x,o.y,W.FLOATING_UI+20),this.runtimeState.buildingLabels.push(c)}),this.pushRuntimeStateToPorts()}resolveAtmosphereProfile(t){if(this.ensureVisualPipeline(),!this.runtimeState.atmosphereDirector)throw new Error("AtmosphereDirector is not initialized.");const i=this.runtimeState.atmosphereDirector.resolveAtmosphereProfile({districtWeight:this.resolveDistrictWeight(),timeSeconds:this.ports.getCurrentGameTime(),baseOverlayRgba:t}),s=xs(this.runtimeState.visualTheme.preset);return this.runtimeState.currentAtmosphereProfile={...i,fogBands:i.fogBands.slice(0,s.maxFogBands),emissiveIntensity:P.Math.Clamp(i.emissiveIntensity,0,1),wetReflectionAlpha:P.Math.Clamp(i.wetReflectionAlpha,0,s.wetReflectionAlpha)},this.pushRuntimeStateToPorts(),this.runtimeState.currentAtmosphereProfile}applyOcclusionReadability(){var n,a,r,o;if(!this.runtimeState.occlusionReadabilityController||!this.runtimeState.buildingMassingEntries.length)return;const t=(a=(n=this.ports).readEntityRuntimeState)==null?void 0:a.call(n),i=[];t!=null&&t.playerToken&&i.push({id:"player",pixelX:t.playerToken.container.x,pixelY:t.playerToken.container.y,token:t.playerToken,nameLabel:t.playerNameLabel}),(r=t==null?void 0:t.enemySprites)==null||r.forEach((l,c)=>{i.push({id:c,pixelX:l.token.container.x,pixelY:l.token.container.y,token:l.token,nameLabel:l.nameLabel,healthBar:l.healthBar})}),(o=t==null?void 0:t.npcSprites)==null||o.forEach((l,c)=>{i.push({id:c,pixelX:l.token.container.x,pixelY:l.token.container.y,token:l.token,nameLabel:l.nameLabel,indicator:l.indicator})});const s=this.runtimeState.currentAtmosphereProfile??this.resolveAtmosphereProfile();this.runtimeState.occlusionReadabilityController.applyOcclusionReadability({masses:this.runtimeState.buildingMassingEntries,entities:i,occlusionFadeFloor:this.runtimeState.visualTheme.qualityBudget.occlusionFadeFloor,emissiveIntensity:s.emissiveIntensity})}drawBackdrop(){const t=this.ports.getBackdropGraphics(),i=this.ports.getCurrentMapArea();if(!t||!i)return;const s=this.computeIsoBounds(),n=this.ports.getTileSize()*4,a=s.maxX-s.minX+n*2,r=s.maxY-s.minY+n*2,o=s.minX-n,l=s.minY-n,c=this.resolveAtmosphereProfile(),d=c.skylineSplit;t.clear(),t.fillGradientStyle(c.gradientTopLeft,c.gradientTopRight,c.gradientBottomLeft,c.gradientBottomRight,1,1,1,1),t.fillRect(o,l,a,r);const u=l+r*.52,h=c.skylineColumns,g=c.skylineDowntownColor,p=c.skylineSlumsColor;for(let f=0;f<h;f+=1){const b=f/h,S=o+b*a,M=.68+f*13%7*.08,v=a/h*M,A=f*29%11/11,I=r*(.12+A*.28)*(b<d?1.12:.78),x=b<d?.78:.26,T=P.Display.Color.Interpolate.ColorWithColor(P.Display.Color.ValueToColor(p),P.Display.Color.ValueToColor(g),1,x),O=P.Display.Color.GetColor(T.r,T.g,T.b);t.fillStyle(O,c.skylineAlphaBase+A*c.skylineAlphaVariance),t.fillRect(S,u-I,v,I),t.fillStyle(k(O,.12),.14+c.emissiveIntensity*.1),t.fillRect(S+v*.72,u-I,v*.16,I)}const m=l+r*.35;t.fillStyle(c.horizonGlowColor,c.horizonGlowAlpha),t.fillEllipse(o+a/2,m,a*1.08,r*.52),t.fillStyle(c.lowerHazeColor,c.lowerHazeAlpha),t.fillRect(o,l+r*.6,a,r*.6),c.fogBands.forEach(f=>{f.alpha<=0||(t.lineStyle(2,f.color,f.alpha),t.strokeEllipse(o+a/2,l+r*f.yFactor,a*f.widthFactor,r*f.heightFactor))})}computeIsoBounds(){const t=this.ports.getCurrentMapArea();if(!t)return{minX:0,maxX:0,minY:0,maxY:0};const{width:i,height:s}=t,n=[this.ports.calculatePixelPosition(0,0),this.ports.calculatePixelPosition(i-1,0),this.ports.calculatePixelPosition(0,s-1),this.ports.calculatePixelPosition(i-1,s-1)];return{minX:Math.min(...n.map(a=>a.x)),maxX:Math.max(...n.map(a=>a.x)),minY:Math.min(...n.map(a=>a.y)),maxY:Math.max(...n.map(a=>a.y))}}hasLightPipelineSupport(){return this.ports.game.renderer instanceof P.Renderer.WebGL.WebGLRenderer}enableLighting(){if(!this.hasLightPipelineSupport()){console.warn("[MainScene] WebGL renderer unavailable; Light2D disabled."),this.ports.setLightsFeatureEnabled(!1),D.dispatch(Ws(!1)),Jt({lightsEnabled:!1});return}if(this.ports.getLightsFeatureEnabled()){this.rebuildLightingDemoLight();return}this.ports.lights.enable().setAmbientColor(this.ports.getLightingAmbientColor()),this.ports.setLightsFeatureEnabled(!0),this.rebuildLightingDemoLight()}disableLighting(t=!1){if(!this.ports.getLightsFeatureEnabled()&&!t){this.destroyDemoPointLight();return}if(this.destroyDemoPointLight(),this.hasLightPipelineSupport()){const i=this.ports.lights;typeof i.removeAll=="function"&&i.removeAll(),this.ports.lights.disable()}this.ports.setLightsFeatureEnabled(!1)}rebuildLightingDemoLight(){const t=this.ports.getDemoLampGrid();if(!this.ports.getLightsFeatureEnabled()||!t){this.destroyDemoPointLight();return}const{x:i,y:s}=this.ports.calculatePixelPosition(t.x,t.y),n=s-this.ports.getTileSize()*.35,a=this.ports.getTileSize()*1.6,r=.4,o=this.ports.getDemoPointLight();if(!o){const l=this.ports.add.pointlight(i,n,8246268,a,r);l.setScrollFactor(1),this.ports.setDemoPointLight(l);return}o.setPosition(i,n),o.radius=a,o.intensity=r}destroyDemoPointLight(){const t=this.ports.getDemoPointLight();t&&(t.destroy(),this.ports.setDemoPointLight(void 0))}clearForMapTransition(){this.runtimeState.buildingLabels.forEach(t=>t.destroy(!0)),this.runtimeState.buildingLabels=[],this.runtimeState.buildingMassings.forEach(t=>t.destroy(!0)),this.runtimeState.buildingMassings=[],this.runtimeState.buildingMassingEntries=[],this.runtimeState.currentAtmosphereProfile=void 0,this.runtimeState.lastAtmosphereRedrawBucket=-1,this.runtimeState.lastItemMarkerSignature="",this.pushRuntimeStateToPorts()}renderTile(t,i,s,n,a,r,o=!1){var l;this.ensureVisualPipeline(),(l=this.runtimeState.tilePainter)==null||l.drawTile(t,{center:i,tileWidth:s,tileHeight:n,gridX:a,gridY:r,groundOnly:o})}resolveDistrictWeight(){const t=Object.values(this.runtimeState.buildingVisualProfiles);return t.length?t.filter(s=>s.district==="downtown").length/t.length:.5}pushRuntimeStateToPorts(){var t,i;(i=(t=this.ports).writeRuntimeState)==null||i.call(t,this.runtimeState)}}class zg extends P.Scene{constructor(){super({key:"MainScene"});y(this,"tileSize",Yt);y(this,"depthManager");y(this,"mapGraphics");y(this,"backdropGraphics");y(this,"pathGraphics");y(this,"visionConeGraphics");y(this,"coverDebugGraphics");y(this,"currentMapArea",null);y(this,"playerInitialPosition");y(this,"isoOriginX",0);y(this,"isoOriginY",0);y(this,"isoFactory");y(this,"staticPropGroup");y(this,"lightsFeatureEnabled",!1);y(this,"demoLampGrid");y(this,"demoPointLight");y(this,"lightingAmbientColor",988970);y(this,"unsubscribe",null);y(this,"disposeVisualSettings");y(this,"disposeLightingSettings");y(this,"moduleDisposables",new rn);y(this,"sceneModuleRegistry");y(this,"dayNightOverlayModule");y(this,"minimapBridgeModule");y(this,"surveillanceRenderModule");y(this,"worldRenderModule");y(this,"entityRenderModule");y(this,"inputModule");y(this,"cameraModule");y(this,"stateSyncModule");y(this,"clockModule");y(this,"lastStoreSnapshot",D.getState())}init(i){this.currentMapArea=i.mapArea,this.playerInitialPosition=i.playerPosition}create(){if(!this.currentMapArea){console.error("[MainScene] currentMapArea is null on create!");return}this.cameras.main.setBackgroundColor(1710618),this.depthManager=new tu(this),this.backdropGraphics=this.add.graphics(),this.registerStaticDepth(this.backdropGraphics,Oe.BACKDROP),this.mapGraphics=this.add.graphics(),this.registerStaticDepth(this.mapGraphics,Oe.MAP_BASE),this.visionConeGraphics=this.add.graphics(),this.registerStaticDepth(this.visionConeGraphics,Oe.VISION_OVERLAY),this.pathGraphics=this.add.graphics(),this.registerStaticDepth(this.pathGraphics,Oe.PATH_PREVIEW),this.coverDebugGraphics=this.add.graphics(),this.registerStaticDepth(this.coverDebugGraphics,Oe.COVER_DEBUG),this.coverDebugGraphics.setVisible(!1),this.initializeSceneModules(),this.worldRenderModule.ensureVisualPipeline(),this.cameraModule.setupCameraAndMap(),this.dayNightOverlayModule.initializeDayNightOverlay(),this.dayNightOverlayModule.updateDayNightOverlay(),this.cameras.main.setRoundPixels(!1),this.disposeVisualSettings=ur(this.cameras.main),this.disposeLightingSettings=En(n=>{this.applyLightingSettings(n)}),this.events.once(P.Scenes.Events.SHUTDOWN,this.cleanupScene,this);const i=D.getState().player.data.name??"Operative";this.entityRenderModule.initializePlayer(this.playerInitialPosition,i)?this.cameraModule.enablePlayerCameraFollow():console.error("[MainScene] playerInitialPosition is null"),this.unsubscribe=D.subscribe(this.handleStateChange.bind(this)),this.lastStoreSnapshot=D.getState(),this.queueInitialStateSync()}shutdown(){this.cleanupScene()}update(i,s){var n;this.sys.isActive()&&((n=this.sceneModuleRegistry)==null||n.onUpdate(i,s))}worldToGrid(i,s){const{halfTileWidth:n,halfTileHeight:a}=this.getIsoMetrics(),r=i-this.isoOriginX,o=s-this.isoOriginY,l=(o/a+r/n)*.5,c=(o/a-r/n)*.5,d=Math.round(l),u=Math.round(c);return Number.isNaN(d)||Number.isNaN(u)?null:{x:d,y:u}}worldToGridContinuous(i,s){const{halfTileWidth:n,halfTileHeight:a}=this.getIsoMetrics(),r=i-this.isoOriginX,o=s-this.isoOriginY,l=(o/a+r/n)*.5,c=(o/a-r/n)*.5;return!Number.isFinite(l)||!Number.isFinite(c)?null:{x:l,y:c}}emitViewportUpdate(){this.minimapBridgeModule.emitViewportUpdate()}focusCameraOnGridPosition(i,s,n=!0){this.cameraModule.focusCameraOnGridPosition(i,s,n)}initializeSceneModules(){this.moduleDisposables.dispose(),this.moduleDisposables=new rn,this.dayNightOverlayModule=new wu(this,{add:this.add,cameras:this.cameras,scale:this.scale,sys:this.sys,getCurrentGameTime:()=>{var s;return((s=this.clockModule)==null?void 0:s.getCurrentGameTime())??D.getState().world.currentTime},isInCombat:()=>{var s;return((s=this.stateSyncModule)==null?void 0:s.isInCombat())??D.getState().world.inCombat},resolveAtmosphereProfile:s=>this.worldRenderModule.resolveAtmosphereProfile(s),registerStaticDepth:(s,n)=>this.registerStaticDepth(s,n)}),this.minimapBridgeModule=new sh(this,{cameras:this.cameras,sys:this.sys,getCurrentMapArea:()=>this.currentMapArea,worldToGridContinuous:(s,n)=>this.worldToGridContinuous(s,n)}),this.surveillanceRenderModule=new mh(this,{getCurrentMapArea:()=>this.currentMapArea,getVisionConeGraphics:()=>this.visionConeGraphics,getTileSize:()=>this.tileSize,getIsoMetrics:()=>this.getIsoMetrics(),calculatePixelPosition:(s,n)=>this.calculatePixelPosition(s,n),syncDepth:(s,n,a,r)=>this.syncDepth(s,n,a,r)}),this.worldRenderModule=new Ih(this,{add:this.add,game:this.game,lights:this.lights,mapGraphics:this.mapGraphics,getBackdropGraphics:()=>this.backdropGraphics,getCurrentMapArea:()=>this.currentMapArea,getCurrentGameTime:()=>{var s;return((s=this.clockModule)==null?void 0:s.getCurrentGameTime())??D.getState().world.currentTime},getTileSize:()=>this.tileSize,getIsoFactory:()=>this.isoFactory,ensureIsoFactory:()=>this.ensureIsoFactory(),getIsoMetrics:()=>this.getIsoMetrics(),calculatePixelPosition:(s,n)=>this.calculatePixelPosition(s,n),syncDepth:(s,n,a,r)=>this.syncDepth(s,n,a,r),renderVisionCones:()=>this.surveillanceRenderModule.renderVisionCones(),getStaticPropGroup:()=>this.staticPropGroup,setStaticPropGroup:s=>{this.staticPropGroup=s},getLightsFeatureEnabled:()=>this.lightsFeatureEnabled,setLightsFeatureEnabled:s=>{this.lightsFeatureEnabled=s},getDemoLampGrid:()=>this.demoLampGrid,setDemoLampGrid:s=>{this.demoLampGrid=s},getDemoPointLight:()=>this.demoPointLight,setDemoPointLight:s=>{this.demoPointLight=s},getLightingAmbientColor:()=>this.lightingAmbientColor,readEntityRuntimeState:()=>this.entityRenderModule.getRuntimeStateSnapshot()}),this.entityRenderModule=new Eu(this,{add:this.add,cameras:this.cameras,game:this.game,scale:this.scale,sys:this.sys,hasMapGraphics:()=>!!this.mapGraphics,ensureIsoFactory:()=>this.ensureIsoFactory(),getIsoMetrics:()=>this.getIsoMetrics(),calculatePixelPosition:(s,n)=>this.calculatePixelPosition(s,n),syncDepth:(s,n,a,r)=>this.syncDepth(s,n,a,r),enablePlayerCameraFollow:()=>this.cameraModule.enablePlayerCameraFollow(),isInCombat:()=>this.stateSyncModule.isInCombat(),isCameraFollowingPlayer:()=>this.cameraModule.isFollowingPlayer(),createCharacterToken:(s,n,a)=>this.worldRenderModule.createCharacterToken(s,n,a),positionCharacterToken:(s,n,a)=>this.worldRenderModule.positionCharacterToken(s,n,a)}),this.inputModule=new Uu(this,{cameras:this.cameras,sys:this.sys,pathGraphics:this.pathGraphics,getCurrentMapArea:()=>this.currentMapArea,setCurrentMapArea:s=>{this.currentMapArea=s},getPlayerInitialPosition:()=>this.playerInitialPosition,getLastPlayerGridPosition:()=>this.entityRenderModule.getLastPlayerGridPosition(),getCoverDebugGraphics:()=>this.coverDebugGraphics,worldToGrid:(s,n)=>this.worldToGrid(s,n),getIsoMetrics:()=>this.getIsoMetrics(),calculatePixelPosition:(s,n)=>this.calculatePixelPosition(s,n),getDiamondPoints:(s,n,a,r)=>this.getDiamondPoints(s,n,a,r),renderStaticProps:()=>this.worldRenderModule.renderStaticProps()}),this.cameraModule=new pu(this,{cameras:this.cameras,scale:this.scale,sys:this.sys,tweens:this.tweens,getCurrentMapArea:()=>this.currentMapArea,getPlayerInitialPosition:()=>this.playerInitialPosition,getPlayerTokenContainer:()=>this.entityRenderModule.getPlayerTokenContainer(),getTileSize:()=>this.tileSize,setIsoOrigin:(s,n)=>{this.isoOriginX=s,this.isoOriginY=n},ensureIsoFactory:()=>this.ensureIsoFactory(),ensureVisualPipeline:()=>this.worldRenderModule.ensureVisualPipeline(),getIsoMetrics:()=>this.getIsoMetrics(),calculatePixelPosition:(s,n)=>this.calculatePixelPosition(s,n),computeIsoBounds:()=>this.worldRenderModule.computeIsoBounds(),renderStaticProps:()=>this.worldRenderModule.renderStaticProps(),drawBackdrop:()=>this.worldRenderModule.drawBackdrop(),drawMap:s=>this.worldRenderModule.drawMap(s),drawBuildingMasses:()=>this.worldRenderModule.drawBuildingMasses(),drawBuildingLabels:()=>this.worldRenderModule.drawBuildingLabels(),clearPathPreview:()=>this.inputModule.clearPathPreview(),resizeDayNightOverlay:()=>this.dayNightOverlayModule.resizeDayNightOverlay(),applyOverlayZoom:()=>this.dayNightOverlayModule.applyOverlayZoom(),emitViewportUpdate:()=>this.minimapBridgeModule.emitViewportUpdate(),dispatchPlayerScreenPosition:()=>this.entityRenderModule.dispatchPlayerScreenPosition(),isInCombat:()=>this.stateSyncModule.isInCombat()}),this.stateSyncModule=new oh(this,{sys:this.sys,getCurrentMapArea:()=>this.currentMapArea,setCurrentMapArea:s=>{this.currentMapArea=s},getItemMarkerSignature:s=>this.worldRenderModule.getItemMarkerSignature(s),renderStaticProps:()=>this.worldRenderModule.renderStaticProps(),updateDayNightOverlay:()=>this.dayNightOverlayModule.updateDayNightOverlay(),updatePlayerPosition:s=>this.entityRenderModule.updatePlayerPosition(s),updatePlayerVitalsIndicator:(s,n,a)=>this.entityRenderModule.updatePlayerVitalsIndicator(s,n,a),updateEnemies:s=>this.entityRenderModule.updateEnemies(s),updateNpcs:s=>this.entityRenderModule.updateNpcs(s),renderVisionCones:()=>this.surveillanceRenderModule.renderVisionCones(),updateSurveillanceCameras:(s,n)=>this.surveillanceRenderModule.updateSurveillanceCameras(s,n??!1),zoomCameraForCombat:()=>this.cameraModule.zoomCameraForCombat(),restoreCameraAfterCombat:()=>this.cameraModule.restoreCameraAfterCombat(),destroyPlayerVitalsIndicator:()=>this.entityRenderModule.destroyPlayerVitalsIndicator(),destroyCameraSprites:()=>this.surveillanceRenderModule.clearCameraSprites(),setupCameraAndMap:()=>this.cameraModule.setupCameraAndMap(),clearPathPreview:()=>this.inputModule.clearPathPreview(),enablePlayerCameraFollow:()=>this.cameraModule.enablePlayerCameraFollow(),resetCameraRuntimeStateForMapTransition:()=>this.cameraModule.resetForMapTransition(),clearEntityRuntimeStateForMapTransition:()=>this.entityRenderModule.clearForMapTransition(),clearWorldRuntimeStateForMapTransition:()=>this.worldRenderModule.clearForMapTransition(),resetEntityCombatIndicators:()=>this.entityRenderModule.resetCombatIndicators(),readRuntimeState:()=>{var s;return{curfewActive:D.getState().world.curfewActive,inCombat:D.getState().world.inCombat,lastMapAreaId:((s=this.currentMapArea)==null?void 0:s.id)??null,isMapTransitionPending:!1}}}),this.clockModule=new fu(this,{getCurrentGameTime:()=>D.getState().world.currentTime,getAtmosphereRedrawBucket:()=>this.worldRenderModule.getAtmosphereRedrawBucket(),setAtmosphereRedrawBucket:s=>this.worldRenderModule.setAtmosphereRedrawBucket(s),signalAtmosphereRedraw:()=>{this.currentMapArea&&(this.worldRenderModule.drawBackdrop(),this.worldRenderModule.drawMap(this.currentMapArea.tiles))},signalOverlayUpdate:()=>this.dayNightOverlayModule.updateDayNightOverlay(),signalOcclusionUpdate:()=>this.worldRenderModule.applyOcclusionReadability(),dispatchGameTime:s=>{D.dispatch(Jn(s))},shouldApplySuspicionDecay:()=>!!D.getState().settings.reputationSystemsEnabled,dispatchSuspicionDecay:(s,n)=>{D.dispatch(fa({elapsedSeconds:s,timestamp:n}))},readRuntimeState:()=>({currentGameTime:D.getState().world.currentTime,timeDispatchAccumulator:0,lastAtmosphereRedrawBucket:this.worldRenderModule.getAtmosphereRedrawBucket(),dispatchCadenceSeconds:.5,atmosphereBucketSeconds:5})});const i=nu(this,{getState:()=>D.getState(),dispatch:D.dispatch},this.moduleDisposables);this.sceneModuleRegistry=new au(i),this.sceneModuleRegistry.register(this.dayNightOverlayModule),this.sceneModuleRegistry.register(this.minimapBridgeModule),this.sceneModuleRegistry.register(this.surveillanceRenderModule),this.sceneModuleRegistry.register(this.worldRenderModule),this.sceneModuleRegistry.register(this.entityRenderModule),this.sceneModuleRegistry.register(this.inputModule),this.sceneModuleRegistry.register(this.cameraModule),this.sceneModuleRegistry.register(this.stateSyncModule),this.sceneModuleRegistry.register(this.clockModule),this.sceneModuleRegistry.onCreate(),i.listenScale("resize",this.handleResize,this)}queueInitialStateSync(){setTimeout(()=>{var s;if(!this.sys.isActive())return;const i=D.getState();(s=this.sceneModuleRegistry)==null||s.onStateChange(i,i)},0)}handleStateChange(){var s;if(!this.sys.isActive()||!this.currentMapArea)return;const i=D.getState();(s=this.sceneModuleRegistry)==null||s.onStateChange(this.lastStoreSnapshot,i),this.lastStoreSnapshot=i}cleanupScene(){var i,s;(i=this.sceneModuleRegistry)==null||i.onShutdown(),this.sceneModuleRegistry=void 0,this.moduleDisposables.dispose(),this.disposeVisualSettings&&(this.disposeVisualSettings(),this.disposeVisualSettings=void 0),this.disposeLightingSettings&&(this.disposeLightingSettings(),this.disposeLightingSettings=void 0),this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null),(s=this.coverDebugGraphics)==null||s.destroy(),this.coverDebugGraphics=void 0}handleResize(){var i;(i=this.sceneModuleRegistry)==null||i.onResize()}applyLightingSettings(i){this.worldRenderModule.applyLightingSettings(i)}ensureIsoFactory(){this.isoFactory||(this.isoFactory=new su(this,this.tileSize,this.depthManager)),this.isoFactory.setIsoOrigin(this.isoOriginX,this.isoOriginY)}registerStaticDepth(i,s){this.depthManager.registerStatic(i,s)}syncDepth(i,s,n,a){xa(this.depthManager,i,s,n,a)}calculatePixelPosition(i,s){return de(i,s,this.isoOriginX,this.isoOriginY,this.tileSize)}getIsoMetrics(){return ue(this.tileSize)}getDiamondPoints(i,s,n,a){return Z(i,s,n,a).map(r=>new P.Geom.Point(r.x,r.y))}}class Ug extends P.Scene{constructor(){super({key:"BootScene"})}preload(){this.load.atlas("props","atlases/props.png","atlases/props.json"),this.load.image("lamp_slim_a_n","normals/lamp_slim_a_n.png")}create(){console.log("[BootScene] create: Fetching initial state and starting MainScene...");const t=D.getState(),i=t.world.currentMapArea,s=t.player.data.position,n=this.textures.get("props"),a=this.textures.get("lamp_slim_a_n");if(n&&a&&n.dataSource.length===0){const c=a.getSourceImage();n.setDataSource(c),this.textures.remove("lamp_slim_a_n")}i||console.error("[BootScene] Error: initialMapArea is null or undefined in Redux state!"),s||console.error("[BootScene] Error: initialPlayerPosition is null or undefined in Redux state!");const r=t.settings.locale,l=$t(r).buildingDefinitions;this.scene.start("MainScene",{mapArea:i,playerPosition:s,buildings:l})}}const fi=e=>`${e.x},${e.y}`,cs=(e,t,i,s={})=>{if(e.x===t.x&&e.y===t.y)return[];const n=s.allowDiagonals?[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1},{x:1,y:1},{x:-1,y:-1},{x:1,y:-1},{x:-1,y:1}]:[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}],a=new Set,r=[{position:e,path:[]}];a.add(fi(e));const{player:o,enemies:l=[],blockedPositions:c=[],npcs:d=[],ignoreNpcIds:u=[]}=s,h=new Set(c.map(fi)),g=p=>p.x>=0&&p.y>=0&&p.x<i.width&&p.y<i.height;for(;r.length>0;){const p=r.shift();if(!p)break;for(const m of n){const f={x:p.position.x+m.x,y:p.position.y+m.y};if(!g(f))continue;const b=fi(f);if(a.has(b))continue;const S=f.x===t.x&&f.y===t.y,M=i.tiles[f.y][f.x];if(!M||!M.isWalkable)continue;if(S){const A=o?o.position.x===f.x&&o.position.y===f.y:!1,I=l.some(T=>T.position.x===f.x&&T.position.y===f.y),x=d.some(T=>!u.includes(T.id)&&T.position.x===f.x&&T.position.y===f.y);if(A||I||x)continue}else if(h.has(b)||!Ae(f,i,o,l,{npcs:d,ignoreNpcIds:u}))continue;const v=[...p.path,f];if(S)return v;a.add(b),r.push({position:f,path:v})}}return[]},Na=4294967295,xh=e=>()=>{let t=e+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/(Na+1)},ht=e=>{let t=1779033703^e.length;for(let i=0;i<e.length;i+=1)t=Math.imul(t^e.charCodeAt(i),3432918353),t=t<<13|t>>>19;return(Math.imul(t^t>>>16,2246822507)^Math.imul(t^t>>>13,3266489909))>>>0},ds=(e,t=0)=>{const i=Math.floor(t)>>>0,s=ht(e)^i,n=xh(s||1),a=()=>n();return{next:a,nextInRange:(r,o)=>{if(o<=r)return r;const l=a();return r+l*(o-r)},fork:r=>{const o=Math.floor(a()*Na);return ds(`${e}:${r}`,o)}}},ve=["idle","patrol","chase","search","attack","inspectNoise","flee","panic"],In=e=>e?ve.reduce((t,i)=>(typeof e[i]=="number"&&(t[i]=e[i]),t),{}):{},Ch=e=>ve.reduce((t,i)=>{const s=e[i];return t[i]=typeof s=="number"?Math.max(0,s):0,t},{}),kh=(e,t,i,s)=>{if(!(!t||t.length===0))for(const n of t){const{state:a,weight:r}=n;let o=0;switch(n.kind){case"healthBelow":i.healthRatio<=n.threshold&&(o=r);break;case"healthAbove":i.healthRatio>=n.threshold&&(o=r);break;case"lineOfSight":i.hasLineOfSight&&(o=r);break;case"lostLineOfSight":i.hasLineOfSight||(o=r);break;case"alertAtLeast":(i.alertLevel??0)>=n.alert&&(o=r);break;case"alertBelow":(i.alertLevel??0)<n.alert&&(o=r);break;case"suppressionAbove":i.suppressionRatio>=n.threshold&&(o=r);break;case"distanceBelow":i.distanceToPlayer<=n.tiles&&(o=r);break;case"distanceAbove":i.distanceToPlayer>=n.tiles&&(o=r);break;case"directorAtLeast":typeof i.directorIntensity=="number"&&i.directorIntensity>=n.threshold&&(o=r);break}if(o!==0){const l=Math.max(0,(e[a]??0)+o);e[a]=l,s[a]=(s[a]??0)+o}}},Th=(e,t,i)=>{ve.forEach(s=>{const n=t[s];typeof n=="number"&&n>i&&(e[s]=0)})},Rh=(e,t)=>{t<=0||ve.forEach(i=>{e[i]>0&&e[i]<t&&(e[i]=t)})},Eh=(e,t)=>{let i=0;if(ve.forEach(a=>{i+=e[a]}),i<=0)return"idle";const s=t()*i;let n=0;for(const a of ve)if(n+=e[a],s<=n)return a;return ve[ve.length-1]},_h=(e,t,i,s)=>{const n=t==null?void 0:t[i];typeof n=="number"&&n>0&&(e[i]=s+n)},Dh=(e,t)=>{const i=(t==null?void 0:t.personalitySeed)??ht(e.id),s=ds(`${e.id}:${i}`,i);let n=(t==null?void 0:t.currentState)??e.initialState,a=(t==null?void 0:t.lastTransitionAt)??0;const r=In(t==null?void 0:t.cooldowns),o=e.cooldowns??{},l=e.minimumSelectableWeight??0;return{getState:()=>n,getSnapshot:()=>({currentState:n,lastTransitionAt:a,cooldowns:In(r),personalitySeed:i}),step:(h,g)=>{const p=Ch(e.baseWeights),m=ve.reduce((v,A)=>(v[A]=0,v),{});kh(p,e.utilityModifiers,h,m),Th(p,r,h.now),Rh(p,l),p[n]>0&&(p[n]+=.5);const f=Eh(p,s.next),b=n;f!==n&&(_h(r,o,f,h.now),n=f,a=h.now);const S={previousState:b,selectedState:f,weights:p,utilityBreakdown:m,now:h.now},M=g==null?void 0:g[f];return M&&M(h,S),{state:f,metadata:S}}}},Lh=e=>{const t=e.suppression??0;return t<=0?0:Math.max(0,Math.min(1,t/100))},Fh=({enemy:e,player:t,mapArea:i,squad:s,npcs:n,hasLineOfSight:a,now:r})=>({enemy:e,player:t,mapArea:i,squad:s,civilians:n,hasLineOfSight:a,distanceToPlayer:oe(e.position,t.position),tookRecentDamage:e.health<e.maxHealth,healthRatio:e.maxHealth>0?e.health/e.maxHealth:0,suppressionRatio:Lh(e),alertLevel:e.alertLevel,lastKnownPlayerPosition:e.lastKnownPlayerPosition,directorIntensity:void 0,now:r}),Bh=(e,t)=>({currentState:e.aiState??t,lastTransitionAt:e.aiLastTransitionAt??0,cooldowns:e.aiCooldowns??{},personalitySeed:e.aiPersonalitySeed??ht(e.id)}),Oh=(e,t,i,s)=>({...e,aiProfileId:t,aiState:i.currentState,aiLastTransitionAt:i.lastTransitionAt,aiCooldowns:i.cooldowns,aiPersonalitySeed:i.personalitySeed,aiTelemetry:{state:s.selectedState,previousState:s.previousState,weights:{...s.weights},utilities:{...s.utilityBreakdown},updatedAt:s.now}}),at=(e,t,i,s)=>{if(!_e(e.position,t.position,e.attackRange))return null;if(e.actionPoints<ut)return{enemy:{...e,actionPoints:0},player:t,action:"no_ap"};const n=s.some(c=>c.x===t.position.x&&c.y===t.position.y),a=La(e,t,{isBehindCover:n,mapArea:i});let r=e,o=t;a.newAttacker.id===e.id&&(r=a.newAttacker),a.newTarget.id===t.id&&(o=a.newTarget);const l=a.success?"attack":"attack_missed";return{enemy:r,player:o,action:l,isCritical:a.isCritical}},Nh=(e,t,i,s,n,a)=>{if(!ze(t,i))return null;const r=n.filter(l=>l.id!==e.id),o=cs(e.position,t,i,{player:s,enemies:r,npcs:a});return o.length===0?null:o[0]},Ee=(e,t,i,s,n)=>{const a=Gi(e,t,i,s,n);if(!a)return null;const r=vt(e,a);return{enemy:St(r,e.position,i),player:t,action:"move"}},Vi=(e,t,i,s,n,a)=>{const r=Vh(e,t,i,s,n,a);if(!r)return null;const o=vt(e,r);return{enemy:St(o,e.position,i),player:t,action:"seek_cover"}},Ha=(e,t,i,s,n)=>{if(!e.lastKnownPlayerPosition)return null;const a=Nh(e,e.lastKnownPlayerPosition,i,t,s,n);if(!a)return null;const r=vt(e,a);return{enemy:St(r,e.position,i),player:t,action:"search"}},xn=(e,t,i,s,n,a,r)=>{const o=us(e.position),l=s.filter(m=>m.id!==e.id),c=o.filter(m=>os(e,m,i,t,l));if(c.length===0)return null;const d=ds(a,r),u=Math.floor(d.nextInRange(0,c.length)),h=c[u]??c[0],g=vt(e,h);return{enemy:St(g,e.position,i),player:t,action:"inspect_noise"}},Hh=(e,t)=>({enemy:{...e,actionPoints:Math.max(0,e.actionPoints-1)},player:t,action:"idle"}),Wh=(e,t,i,s,n,a,r,o)=>{switch(e){case"attack":return at(t,i,s,r);case"chase":return Ee(t,i,s,n,a);case"search":return Ha(t,i,s,n,a);case"inspectNoise":return xn(t,i,s,n,a,`${t.id}:${o.selectedState}:${o.now}`,ht(t.id));case"flee":case"panic":return Vi(t,i,s,n,r,a);case"patrol":return(t.alertLevel??L.IDLE)>=L.SUSPICIOUS?Ee(t,i,s,n,a):xn(t,i,s,n,a,`${t.id}:patrol:${o.now}`,ht(t.id));case"idle":return Hh(t,i);default:return null}},yi=(e,t)=>({enemy:{...e,actionPoints:0},player:t,action:"no_valid_move"}),qh=e=>{if(e){const t=Vo(e);if(t)return t}return Mi[ot]??Object.values(Mi)[0]},Kg=(e,t,i,s,n,a=[],r=Date.now())=>{let o={...e},l={...t};if(e.health<=0)return{enemy:o,player:l,action:"dead"};if(e.actionPoints<=0)return{enemy:o,player:l,action:"no_ap"};if(_e(e.position,t.position,e.attackRange)){const C=at(e,l,i,n);if(C)return C}const c=qh(e.aiProfileId),d=Bh(e,c.fsm.initialState),u=Dh(c.fsm,d),h=Oa(e,t,i),g=s.filter(C=>C.id!==e.id),p=Fh({enemy:e,player:t,mapArea:i,squad:g,npcs:a,hasLineOfSight:h,now:r});let m=null;const f={idle:()=>{m="idle"},patrol:()=>{m="patrol"},chase:()=>{m="chase"},search:()=>{m="search"},attack:()=>{m="attack"},inspectNoise:()=>{m="inspectNoise"},flee:()=>{m="flee"},panic:()=>{m="panic"}},{state:b,metadata:S}=u.step(p,f);let v=Wh(m??b,e,l,i,s,a,n,S)??null;if(v||(v=at(e,l,i,n)??Ee(e,l,i,s,a)??Vi(e,l,i,s,n,a)??yi(e,l)),p.hasLineOfSight){const C=v.enemy??e,F=_e(C.position,l.position,C.attackRange);if((v.action==="idle"||v.action==="inspect_noise")&&F){const q=at(C,l,i,n);q&&(v=q)}else if(v.action==="inspect_noise"&&!F){const q=Ee(C,l,i,s,a);q&&(v=q)}else if(v.action==="idle"&&!F){const q=Ee(C,l,i,s,a);q&&(v=q)}}if(!p.hasLineOfSight&&v.action==="idle"){const C=Ee(e,l,i,s,a);C&&(v=C)}if(!p.hasLineOfSight&&v.action==="inspect_noise"){const C=Ha(e,l,i,s,a)??Ee(e,l,i,s,a);C&&(v=C)}if(p.healthRatio<=.4&&v.action!=="seek_cover"){const C=Vi(e,l,i,s,n,a);C&&(v=C)}if(v.action==="move"&&v.enemy&&v.enemy.position.x===e.position.x&&v.enemy.position.y===e.position.y){const C=Gi(v.enemy,l,i,s,a);if(C){const F=vt(v.enemy,C);v={...v,enemy:St(F,v.enemy.position,i)}}}const A=v.enemy??e,I=_e(A.position,l.position,A.attackRange),x=!!Gi(A,l,i,s,a);v.action==="idle"&&!I&&!x&&(v=yi(A,l));const T=v.enemy??A,O=_e(T.position,l.position,T.attackRange);if(p.hasLineOfSight&&O&&!["attack","attack_missed","seek_cover","flee","dead","no_ap"].includes(v.action)){const C=at(T,l,i,n);C&&(v=C)}v.action==="idle"&&!p.hasLineOfSight&&!I&&(v=yi(v.enemy??e,l));const w=u.getSnapshot();return o=Oh(v.enemy,c.id,w,S),l=v.player,{...v,enemy:o,player:l}},Gi=(e,t,i,s,n=[])=>{const a=s.filter(h=>h.id!==e.id),r=Math.max(1,Math.ceil(e.attackRange)),o=[];for(let h=-r;h<=r;h+=1)for(let g=-r;g<=r;g+=1){if(h===0&&g===0)continue;const p={x:t.position.x+h,y:t.position.y+g};ze(p,i)&&_e(p,t.position,e.attackRange)&&o.push(p)}const l=o.sort((h,g)=>{const p=oe(e.position,h),m=oe(e.position,g);return p-m});let c=null;for(const h of l){if(!Ae(h,i,t,a,{npcs:n}))continue;const g=cs(e.position,h,i,{player:t,enemies:a,npcs:n});if(g.length!==0&&(!c||g.length<c.length)&&(c=g,g.length===1))break}if(c&&c.length>0)return c[0];const u=us(e.position).filter(h=>os(e,h,i,t,a));return u.length===0?null:u.reduce((h,g)=>{const p=oe(g,t.position),m=oe(h,t.position);return p<m?g:h},u[0])},Vh=(e,t,i,s,n,a=[])=>{var h,g;if(n.length===0||(g=(h=i.tiles[e.position.y])==null?void 0:h[e.position.x])!=null&&g.provideCover)return null;const r=s.filter(p=>p.id!==e.id);let o=null;for(const p of n){if(!ze(p,i)||!Ae(p,i,t,r,{npcs:a}))continue;const m=cs(e.position,p,i,{player:t,enemies:r,npcs:a});if(m.length!==0&&(!o||m.length<o.length)&&(o=m,m.length===1))break}if(o&&o.length>0)return o[0];const c=us(e.position).filter(p=>os(e,p,i,t,r));if(c.length===0)return null;const d=c.filter(p=>n.some(m=>m.x===p.x&&m.y===p.y));if(d.length>0)return d[0];const u=Gh(e.position,n);return u?c.reduce((p,m)=>{const f=oe(m,u),b=oe(p,u);return f<b?m:p},c[0]):null},Gh=(e,t)=>t.length===0?null:t.reduce((i,s)=>{const n=oe(e,s),a=oe(e,i);return n<a?s:i},t[0]),us=e=>[{x:e.x+1,y:e.y},{x:e.x-1,y:e.y},{x:e.x,y:e.y+1},{x:e.x,y:e.y-1}],jg=(e,t,i,s=1)=>{let n=L.IDLE;const a=[];return{updatedEnemies:e.map(o=>{if(!o.visionCone)return a.push({enemy:o,playerVisible:!1}),o;const l=Oa(o,t,i);let c=ch(o,l,s);if(l&&(c=dh(c,t.position),c.lastKnownPlayerPosition=t.position),a.push({enemy:c,playerVisible:l}),c.alertLevel){const d=Ut(c.alertLevel),u=Ut(n);d>u&&(n=c.alertLevel)}return c}),maxAlertLevel:n,guardPerception:a}},Ut=e=>{switch(e){case L.IDLE:return 0;case L.SUSPICIOUS:return 1;case L.INVESTIGATING:return 2;case L.ALARMED:return 3;default:return 0}},$g=(e,t)=>{const i=Ut(e);if(Ut(t)<=i)return null;switch(t){case L.SUSPICIOUS:return"alertSuspicious";case L.INVESTIGATING:return"alertInvestigating";case L.ALARMED:return"alertAlarmed";default:return null}},Yg=(e,t)=>e===L.ALARMED&&!t,Zg=()=>Ne.reinforcementDelay,zh=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}],Kt=(e,t)=>{var s;const i=(s=e.tiles[t.y])==null?void 0:s[t.x];return i?i.cover?1:i.provideCover?.75:0:0},Uh=e=>{var t;return((t=e.equipped.weapon)==null?void 0:t.damage)??Ni},Wa=e=>{var t;return((t=e.equipped.weapon)==null?void 0:t.range)??1},Kh=e=>{var n;const t=((n=e.equipped.weapon)==null?void 0:n.apCost)??ut,i=Number.isFinite(e.encumbrance.attackApMultiplier)?Math.max(e.encumbrance.attackApMultiplier,0):Number.POSITIVE_INFINITY,s=$i(e)?0:Math.ceil(Math.max(0,t)*i);return Number.isFinite(s)?s:Number.POSITIVE_INFINITY},hs=e=>e.filter(t=>t.health>0),Cn=(e,t)=>t.length===0?Number.POSITIVE_INFINITY:t.reduce((i,s)=>{const n=oe(e,s.position);return n<i?n:i},Number.POSITIVE_INFINITY),qa=e=>Number.isFinite(e)?e:Number.NEGATIVE_INFINITY,jh=(e,t)=>{const{player:i,enemies:s,map:n,profile:a}=e,r=hs(s),o=Kh(i);if(!Number.isFinite(o)||o>i.actionPoints)return[];const l=Uh(i),c=Wa(i),d=Kt(n,i.position);return r.filter(u=>_e(i.position,u.position,c)).map(u=>{const h=oe(i.position,u.position),g=u.maxHealth>0?u.health/u.maxHealth:1,p=Kt(n,u.position),m=l*(p>0?.75:1),f=(1-g)*a.weights.focusLowestHealth*m,b=a.weights.focusOverwatchThreat*u.damage*.05,S=d<.5?.25:0,M=t?a.weights.retreatBias*(m*.2+(d<.5?2:0)):0,v=i.actionPoints-o,A=v<a.thresholds.apReserve?(a.thresholds.apReserve-v)*.4:0,I=a.weights.attackBias*m+f+b-S-M-A,x=[];return x.push(`Distance ${h}`),x.push(`Expected damage ${m.toFixed(1)}`),f>.1&&x.push("Target vulnerable"),M>.1&&x.push("Panic dampening attack"),A>.1&&x.push("Preserve AP reserve"),{type:"attack",targetId:u.id,targetName:u.name,targetPosition:u.position,expectedDamage:m,apCost:o,distance:h,score:qa(I),summary:`Attack ${u.name}`,rationale:x}})},$h=(e,t)=>{const{player:i,enemies:s,map:n,profile:a}=e;if(i.actionPoints<=0)return[];const r=hs(s);if(r.length===0)return[];const o=Kt(n,i.position),l=Cn(i.position,r),c=Wa(i),d=[];return zh.forEach(u=>{const h={x:i.position.x+u.x,y:i.position.y+u.y};if(!Ae(h,n,i,r))return;const g=Kt(n,h),p=Math.max(0,g-o),m=Cn(h,r),f=l>0?l-m:0,b=a.weights.pursuitAggression*(c>0?f/c:0),S=t||a.weights.retreatBias>.8?a.weights.retreatBias*Math.max(0,m-l):0,M=a.weights.maintainCover*g,v=i.actionPoints-1,A=v<a.thresholds.apReserve?(a.thresholds.apReserve-v)*.35:0,I=M+b+S-Math.max(0,-f)*.1-A,x=[];p>.01?x.push("Gain cover"):g>.4&&x.push("Maintain cover"),f>.2&&x.push("Advance on target"),S>.2&&x.push("Create distance"),A>.1&&x.push("Hold AP reserve"),d.push({type:"move",destination:h,coverGain:p,distanceToNearestEnemy:m,apCost:1,score:qa(I),summary:p>0?"Move to cover":"Reposition",rationale:x})}),d},Yh=()=>({type:"wait",score:-.5,summary:"Hold position",rationale:["No advantageous action"]}),Zh=e=>{const{player:t,profile:i,enemies:s}=e;if(hs(s).length===0)return{type:"wait",score:Number.NEGATIVE_INFINITY,summary:"No targets",rationale:["No living enemies"]};const r=(t.maxHealth>0?t.health/t.maxHealth:1)<=i.thresholds.panicHealthFraction,o=jh(e,r),l=$h(e,r),c=Yh();return[...o,...l,c].reduce((h,g)=>!h||g.score>h.score?g:h,null)??c},Xh=ts("AutoBattleController"),kn=(e,t)=>{if(!e)return t.hudPauseReasons.none;switch(e){case"manual_input":return t.hudPauseReasons.manualInput;case"dialogue":return t.hudPauseReasons.dialogue;case"objective":return t.hudPauseReasons.objective;case"resources":return t.hudPauseReasons.resources;case"ap":return t.hudPauseReasons.ap;case"settings":default:return t.hudPauseReasons.none}},Si=220;class Xg{constructor(t,i){y(this,"dispatch");y(this,"getState");y(this,"lastSignature",null);y(this,"currentStatus","idle");y(this,"currentReason",null);y(this,"manualOverride",!1);y(this,"turnStartTimestamp",null);y(this,"lastProcessedTurn",null);y(this,"pendingBufferTimeout",null);this.dispatch=t,this.getState=i.getState.bind(i)}notifyManualOverride(t){this.manualOverride=!0,this.lastSignature=null;const s=this.getState().settings.locale,n=As(s).autoBattle,a=Is(s).logs,r=kn(t,n);this.dispatch(Ks({status:"paused",reason:t})),this.dispatch(we(a.autoBattlePaused(r))),this.currentStatus="paused",this.currentReason=t}update(t){if(!t.enabled){this.resetStatus("idle",null,t),this.manualOverride=!1,this.lastSignature=null,this.clearTurnBuffer(),this.lastProcessedTurn=null;return}if(this.manualOverride){this.resetStatus("paused","manual_input",t),this.clearTurnBuffer();return}if(t.isPlayerTurn){if(this.lastProcessedTurn!==t.turnCount){this.lastProcessedTurn=t.turnCount,this.turnStartTimestamp=this.now(),this.lastSignature=null,this.resetStatus("idle",null,t),this.scheduleBufferedUpdate(Si);return}if(this.turnStartTimestamp!==null){const l=this.now()-this.turnStartTimestamp;if(l<Si){this.scheduleBufferedUpdate(Si-l);return}}}else this.clearTurnBuffer();const i=Hs(t.profileId),s=i.label,n=this.resolveFailSafe(t);if(n){this.resetStatus("paused",n,t),this.lastSignature=null,this.clearTurnBuffer();return}const a=this.buildSignature(t);if(a===this.lastSignature)return;const r=Zh({player:t.player,enemies:t.enemies,map:t.mapArea,profile:i});this.dispatch(zc(this.buildDecisionSummary(r,i.id))),this.resetStatus("running",null,t);const o=this.buildDecisionDescription(r);this.dispatch(we(t.logStrings.autoBattleDecision(s,o))),this.executeDecision(r,t),this.lastSignature=a}clearTurnBuffer(){this.pendingBufferTimeout!==null&&(window.clearTimeout(this.pendingBufferTimeout),this.pendingBufferTimeout=null),this.turnStartTimestamp=null}scheduleBufferedUpdate(t){const i=Math.max(0,Math.round(t));this.pendingBufferTimeout!==null&&window.clearTimeout(this.pendingBufferTimeout),this.pendingBufferTimeout=window.setTimeout(()=>{this.pendingBufferTimeout=null;const s=this.buildContextFromStore();s&&this.update(s)},i)}buildContextFromStore(){const t=this.getState(),{autoBattleEnabled:i,autoBattleProfile:s,locale:n}=t.settings,a=t.world,r=a.currentMapArea??null;return{enabled:i,profileId:s,player:t.player.data,enemies:(r==null?void 0:r.entities.enemies)??[],mapArea:r,inCombat:a.inCombat,isPlayerTurn:a.isPlayerTurn,turnCount:a.turnCount,activeDialogueId:t.quests.activeDialogue.dialogueId,logStrings:Is(n).logs,autoBattleStrings:As(n).autoBattle}}now(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}resolveFailSafe(t){return!t.inCombat||!t.isPlayerTurn||!t.mapArea?"settings":t.player.actionPoints<=0?"ap":t.activeDialogueId?"dialogue":t.enemies.some(i=>i.health>0)?null:"settings"}resetStatus(t,i,s){if(!(this.currentStatus===t&&this.currentReason===i)){if(this.currentStatus=t,this.currentReason=i,this.dispatch(Ks({status:t,reason:i})),t==="running"){this.dispatch(we(s.logStrings.autoBattleEngaged(Hs(s.profileId).label)));return}if(t==="paused"){const n=kn(i,s.autoBattleStrings);this.dispatch(we(s.logStrings.autoBattlePaused(n)))}}}buildSignature(t){const{player:i}=t;return[t.turnCount,i.actionPoints,i.position.x,i.position.y,t.enemies.map(s=>`${s.id}:${s.health}`).join("|")].join(":")}buildDecisionSummary(t,i){return{profileId:i,action:t.summary,targetId:t.type==="attack"?t.targetId:void 0,targetName:t.type==="attack"?t.targetName:void 0,score:t.score,explanation:t.rationale.join(", "),timestamp:Date.now()}}buildDecisionDescription(t){const i=t.rationale.length>0?t.rationale[0]:"";return i?`${t.summary} (${i})`:t.summary}executeDecision(t,i){switch(t.type){case"attack":this.executeAttack(t,i);break;case"move":this.executeMove(t,i);break;case"wait":default:this.executeWait(i);break}}executeAttack(t,i){var u;const s=this.getState(),n=s.player.data,a=s.world.currentMapArea.entities.enemies.find(h=>h.id===t.targetId);if(!a||a.health<=0){Xh.warn("Attack target no longer valid; falling back to wait",{targetId:t.targetId}),this.executeWait(i);return}const r=s.world.currentMapArea,o=(u=r.tiles[a.position.y])==null?void 0:u[a.position.x],l=(o==null?void 0:o.provideCover)??!1,c=La(n,a,{isBehindCover:l,mapArea:r});this.dispatch(Oo(c.newAttacker)),this.dispatch(Al(c.newTarget)),c.events&&c.events.forEach(h=>this.dispatch(we(h.message))),c.success?(this.dispatch(we(i.logStrings.hitEnemy(t.targetName,Math.round(c.damage??t.expectedDamage)))),this.dispatch(cc({id:se(),value:Math.round(c.damage??t.expectedDamage),gridX:a.position.x,gridY:a.position.y,type:c.isCritical?"crit":"damage"}))):this.dispatch(we(i.logStrings.missedEnemy(t.targetName))),c.newAttacker.actionPoints<=0&&this.dispatch(At())}executeMove(t,i){this.dispatch(Do(t.destination)),this.dispatch(Ls(-t.apCost)),i.player.actionPoints-t.apCost<=0&&this.dispatch(At())}executeWait(t){const i=$i(t.player)?0:ut;t.player.actionPoints<=i?this.dispatch(At()):(this.dispatch(Ls(-t.player.actionPoints)),this.dispatch(At()))}}export{Ag as $,L as A,Ug as B,ne as C,Ml as D,Zn as E,wl as F,Hg as G,H,Og as I,ts as J,Zg as K,Om as L,zg as M,im as N,yp as O,fp as P,Vp as Q,yt as R,hp as S,qp as T,Ph as U,Tp as V,Mm as W,ku as X,cc as Y,Fm as Z,Cm as _,hg as a,qm as a$,Rg as a0,_g as a1,Xg as a2,Pu as a3,Oi as a4,Gg as a5,cs as a6,Ae as a7,R as a8,ap as a9,gm as aA,fg as aB,Ls as aC,dg as aD,Tg as aE,kg as aF,Tm as aG,Sm as aH,Xr as aI,dp as aJ,vp as aK,Xi as aL,mi as aM,Au as aN,Mu as aO,zm as aP,np as aQ,Rr as aR,Zi as aS,bp as aT,Lm as aU,Dm as aV,_m as aW,Nm as aX,bi as aY,Cu as aZ,ig as a_,lp as aa,cp as ab,hm as ac,Do as ad,mm as ae,Pg as af,jg as ag,Ne as ah,Al as ai,wg as aj,$g as ak,Yg as al,fm as am,gp as an,At as ao,xm as ap,Kg as aq,sg as ar,Oo as as,Zp as at,ut as au,$i as av,_e as aw,La as ax,Xm as ay,Hm as az,rg as b,Dr as b0,op as b1,rp as b2,Ap as b3,Gm as b4,Um as b5,pm as b6,D as b7,Vg as b8,ag as b9,_p as bA,Wt as bB,Dp as bC,Hp as bD,Fp as bE,Op as bF,up as bG,Bp as bH,Np as bI,Yp as bJ,Jp as bK,Wd as ba,gt as bb,pp as bc,jp as bd,$p as be,Ip as bf,$m as bg,Ym as bh,Cl as bi,Il as bj,ic as bk,Qm as bl,Ws as bm,Wg as bn,Zr as bo,Yi as bp,Ir as bq,Qp as br,_n as bs,sp as bt,zi as bu,pr as bv,ip as bw,tm as bx,em as by,Ep as bz,ki as c,og as d,ug as e,we as f,lg as g,cg as h,Im as i,Am as j,Fa as k,vg as l,Ba as m,om as n,um as o,nm as p,am as q,bg as r,Sg as s,cm as t,Jt as u,xg as v,yg as w,Ti as x,Ei as y,Ng as z};
