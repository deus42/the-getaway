var pa=Object.defineProperty;var ma=(e,t,i)=>t in e?pa(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var f=(e,t,i)=>ma(e,typeof t!="symbol"?t+"":t,i);import{P}from"./phaser-DkaA9Y8j.js";import{v as Q,g as tt,a as ga,e as fa,i as Tt,c as ya,b as va,d as ba,f as Et,D as ve,L as Sa,Q as wa,h as Pa,P as Ma,j as ts,k as is,l as Aa,m as xa,n as Ji,o as en}from"./game-content-DAoogAxc.js";import{c as j,a as Ia,b as ka,d as Ca}from"./vendor-Cc93p67d.js";const Be=Object.freeze({qualityPreset:"balanced",lightsEnabled:!1,bloom:{enabled:!1,color:16777215,offsetX:0,offsetY:0,blurStrength:0,strength:0,steps:0},vignette:{enabled:!1,x:.5,y:.5,radius:1,strength:0},colorMatrix:{enabled:!1,saturation:0,brightness:1,contrast:0,hue:0}});let ee={qualityPreset:Be.qualityPreset,lightsEnabled:Be.lightsEnabled,bloom:{...Be.bloom},vignette:{...Be.vignette},colorMatrix:{...Be.colorMatrix}};const Qt=new Set,Ta=()=>{Qt.forEach(e=>e(ee))},Dt=e=>{ee={qualityPreset:e.qualityPreset??ee.qualityPreset,lightsEnabled:e.lightsEnabled??ee.lightsEnabled,bloom:{...ee.bloom,...e.bloom??{}},vignette:{...ee.vignette,...e.vignette??{}},colorMatrix:{...ee.colorMatrix,...e.colorMatrix??{}}},Ta()},Ea=e=>e==="performance"?{bloomStrengthCap:.18,vignetteCap:.22,colorMatrixEnabled:!1,maxFogBands:2,maxEmissiveZones:6,wetReflectionAlpha:.08,occlusionFadeFloor:.56}:e==="cinematic"?{bloomStrengthCap:.48,vignetteCap:.44,colorMatrixEnabled:!0,maxFogBands:6,maxEmissiveZones:14,wetReflectionAlpha:.2,occlusionFadeFloor:.38}:{bloomStrengthCap:.32,vignetteCap:.34,colorMatrixEnabled:!0,maxFogBands:4,maxEmissiveZones:10,wetReflectionAlpha:.14,occlusionFadeFloor:.48},tn=e=>Ea(e),ns=e=>(Qt.add(e),e(ee),()=>{Qt.delete(e)}),Ra=(e,t)=>{t.enabled&&e.postFX.addBloom(t.color,t.offsetX,t.offsetY,t.blurStrength,t.strength,t.steps)},_a=(e,t)=>{t.enabled&&e.postFX.addVignette(t.x,t.y,t.radius,t.strength)},La=(e,t)=>{if(!t.enabled)return;const i=e.postFX.addColorMatrix();let n=!1;const s=a=>{a(n),n=!0};t.saturation!==0&&s(a=>i.saturate(t.saturation,a)),t.hue!==0&&s(a=>i.hue(t.hue,a)),t.contrast!==0&&s(a=>i.contrast(t.contrast,a)),t.brightness!==1&&s(a=>i.brightness(t.brightness,a))},Da=e=>{e.clearFX(),Ra(e,ee.bloom),_a(e,ee.vignette),La(e,ee.colorMatrix)},Oa=e=>{const i=ns(()=>Da(e));return()=>{i(),e.clearFX()}};var L=(e=>(e.IDLE="idle",e.SUSPICIOUS="suspicious",e.INVESTIGATING="investigating",e.ALARMED="alarmed",e))(L||{}),J=(e=>(e.IDLE="idle",e.SUSPICIOUS="suspicious",e.ALARMED="alarmed",e.DISABLED="disabled",e))(J||{}),E=(e=>(e.FLOOR="floor",e.WALL="wall",e.DOOR="door",e.COVER="cover",e.WATER="water",e.TRAP="trap",e))(E||{});const Y=5,$=10,ss=[{id:"combat",label:"Combat",blurb:"Disciplines that determine battlefield performance and weapon mastery.",skills:[{id:"smallGuns",name:"Small Guns",branch:"combat",maxValue:100,increment:Y,taggedIncrement:$,description:"Training with ballistic pistols, SMGs, and rifles.",effectSummary:"+0.5% hit chance per point with ballistic weapons."},{id:"energyWeapons",name:"Energy Weapons",branch:"combat",maxValue:100,increment:Y,taggedIncrement:$,description:"Mastery of beam, laser, and plasma weapon systems.",effectSummary:"+0.4% hit chance and +0.3% crit chance per point with energy weapons."},{id:"meleeCombat",name:"Melee Combat",branch:"combat",maxValue:100,increment:Y,taggedIncrement:$,description:"Close-quarters tactics for blades, clubs, and unarmed strikes.",effectSummary:"+0.3% melee hit chance per point and +1 damage per 10 points."},{id:"explosives",name:"Explosives",branch:"combat",maxValue:100,increment:Y,taggedIncrement:$,description:"Deployment of grenades, mines, and shaped charges.",effectSummary:"+0.25% throw accuracy per point and +1 tile radius per 25 points."}]},{id:"tech",label:"Tech",blurb:"System infiltration, fabrication, and field engineering aptitudes.",skills:[{id:"hacking",name:"Hacking",branch:"tech",maxValue:100,increment:Y,taggedIncrement:$,description:"Bypass security systems and crack encrypted terminals.",effectSummary:"Unlocks advanced intrusion dialogue choices and minigames (stub).",stub:!0},{id:"engineering",name:"Engineering",branch:"tech",maxValue:100,increment:Y,taggedIncrement:$,description:"Maintain drones, turrets, and battlefield gadgets.",effectSummary:"Improves deployable durability and crafting options (stub).",stub:!0},{id:"science",name:"Science",branch:"tech",maxValue:100,increment:Y,taggedIncrement:$,description:"Chemical analysis and experimental tech research.",effectSummary:"Boosts chem crafting and anomaly research (stub).",stub:!0}]},{id:"survival",label:"Survival",blurb:"Field medicine, stealth, and salvage expertise.",skills:[{id:"medicine",name:"Medicine",branch:"survival",maxValue:100,increment:Y,taggedIncrement:$,description:"Treat injuries and synthesize bio-stims under fire.",effectSummary:"Increases healing efficiency and unlocks aid recipes (stub).",stub:!0},{id:"stealth",name:"Stealth",branch:"survival",maxValue:100,increment:Y,taggedIncrement:$,description:"Avoid detection and blend into hostile zones.",effectSummary:"Improves detection thresholds and noise damping (stub).",stub:!0},{id:"scavenging",name:"Scavenging",branch:"survival",maxValue:100,increment:Y,taggedIncrement:$,description:"Recover components and rare materials from ruins.",effectSummary:"Increases loot yields and salvage spots (stub).",stub:!0}]},{id:"social",label:"Social",blurb:"Command presence, negotiation, and underground influence.",skills:[{id:"persuasion",name:"Persuasion",branch:"social",maxValue:100,increment:Y,taggedIncrement:$,description:"Convince allies and sway neutral factions.",effectSummary:"Unlocks diplomatic dialogue options and better rewards (stub).",stub:!0},{id:"intimidation",name:"Intimidation",branch:"social",maxValue:100,increment:Y,taggedIncrement:$,description:"Force compliance through presence and threat.",effectSummary:"Unlocks threat-based dialogue paths (stub).",stub:!0},{id:"barter",name:"Barter",branch:"social",maxValue:100,increment:Y,taggedIncrement:$,description:"Broker deals and hustle black-market channels.",effectSummary:"Improves vendor prices and trade availability (stub).",stub:!0}]}],Na=ss.flatMap(e=>e.skills).reduce((e,t)=>(e[t.id]=t,e),{});ss.reduce((e,t)=>(e[t.id]=t,e),{});const Jt=e=>{const t=Na[e];if(!t)throw new Error(`[skills] Unknown skill id: ${e}`);return t},Pi=(e,t)=>e.skillTraining[t]??0,Fa=(e,t)=>e.taggedSkillIds.includes(t),it=(e,t=100)=>!Number.isFinite(e)||e<0?0:Math.min(t,e),dh=(e,t)=>{const i=Jt(t);return Fa(e,t)?i.taggedIncrement:i.increment},as=e=>e?e.skillType??(e.range<=1?"meleeCombat":"smallGuns"):"meleeCombat",os=e=>it(e)*.5,Mi=e=>{const t=it(e);return{hit:t*.4,crit:t*.3}},Ai=e=>{const t=it(e);return{hit:t*.35,damage:Math.floor(t/10)}},rs=e=>{const t=it(e);return{accuracy:t*.25,radius:Math.floor(t/25)}},uh=(e,t)=>{const i=it(t);switch(e){case"smallGuns":return`Hit chance bonus +${os(i).toFixed(1)}% with ballistic weapons`;case"energyWeapons":{const n=Mi(i);return`Hit +${n.hit.toFixed(1)}% / Crit +${n.crit.toFixed(1)}% with energy weapons`}case"meleeCombat":{const n=Ai(i);return`Hit +${n.hit.toFixed(1)}% / Damage +${n.damage}`}case"explosives":{const n=rs(i),s=n.radius===1?"tile":"tiles";return`Throw accuracy +${n.accuracy.toFixed(1)}%, blast radius +${n.radius} ${s}`}default:return"Specialisation effects coming online soon."}},nn=10,Rt=64,Ba=(e,t)=>{const i=[];for(let n=0;n<t;n++){i[n]=[];for(let s=0;s<e;s++)i[n][s]={type:E.FLOOR,position:{x:s,y:n},isWalkable:!0,provideCover:!1}}return i},ls=(e,t=nn,i=nn,n={})=>{const s=Ba(t,i);for(let a=0;a<t;a++)s[0][a].type=E.WALL,s[0][a].isWalkable=!1,s[i-1][a].type=E.WALL,s[i-1][a].isWalkable=!1;for(let a=0;a<i;a++)s[a][0].type=E.WALL,s[a][0].isWalkable=!1,s[a][t-1].type=E.WALL,s[a][t-1].isWalkable=!1;return{id:Q(),name:e,zoneId:n.zoneId??"unknown_zone",level:n.level??0,objectives:n.objectives??[],isInterior:n.isInterior??!1,factionRequirement:n.factionRequirement,displayName:n.displayName,summary:n.summary,dangerRating:n.dangerRating,hazards:n.hazards??[],width:t,height:i,tiles:s,entities:{enemies:[],npcs:[],items:[]}}},Ha=(e,t)=>{const i=[...e.tiles];for(const n of t)n.y>=0&&n.y<e.height&&n.x>=0&&n.x<e.width&&(i[n.y][n.x]={...i[n.y][n.x],type:E.WALL,isWalkable:!1});return{...e,tiles:i}},Wa=(e,t)=>{const i=[...e.tiles];for(const n of t)n.y>=0&&n.y<e.height&&n.x>=0&&n.x<e.width&&(i[n.y][n.x]={...i[n.y][n.x],type:E.COVER,provideCover:!0,isWalkable:!0});return{...e,tiles:i}},qa=(e,t,i)=>{if(!Ne(t,e))return e;const n=e.tiles.map((s,a)=>s.map((o,r)=>a===t.y&&r===t.x?{...o,cover:{...i},provideCover:!0}:o));return{...e,tiles:n}},Ne=(e,t)=>e.x>=0&&e.x<t.width&&e.y>=0&&e.y<t.height,ye=(e,t,i,n=[],s={})=>{if(!Ne(e,t))return!1;const a=t.tiles[e.y][e.x];if(!a.isWalkable||i&&a.skillRequirement&&Pi(i,a.skillRequirement.skill)<a.skillRequirement.threshold)return!1;const{npcs:o=[],ignoreNpcIds:r=[]}=s;return!(i&&i.position.x===e.x&&i.position.y===e.y||n.some(l=>l.position.x===e.x&&l.position.y===e.y)||o.some(l=>!r.includes(l.id)&&l.position.x===e.x&&l.position.y===e.y))},cs=(e,t,i,n=[])=>[{x:e.x+1,y:e.y},{x:e.x-1,y:e.y},{x:e.x,y:e.y+1},{x:e.x,y:e.y-1}].filter(a=>ye(a,t,i,n)),xi=(e,t,i,n=[])=>{if(ye(e,t,i,n))return e;const s=new Set,a=[e],o=l=>`${l.x},${l.y}`;s.add(o(e));const r=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}];for(;a.length>0;){const l=a.shift();if(!l)break;for(const c of r){const d={x:l.x+c.x,y:l.y+c.y},u=o(d);if(!s.has(u)&&(s.add(u),!!Ne(d,t))){if(ye(d,t,i,n))return d;a.push(d)}}}return null},le=(e,t)=>e.perks.includes(t),za=e=>e?e.range>1:!1,Va=e=>le(e,"steadyHands")?.1:0,Ga=e=>le(e,"toughness")?3:0,Ii=e=>le(e,"gunFu")?e.perkRuntime.gunFuShotsThisTurn<=0:!1,Ua=e=>le(e,"gunFu")?{...e,perkRuntime:{...e.perkRuntime,gunFuShotsThisTurn:e.perkRuntime.gunFuShotsThisTurn+1}}:e,Ka=e=>le(e,"gunFu")?{...e,perkRuntime:{...e.perkRuntime,gunFuShotsThisTurn:0}}:e,Ot=e=>le(e,"adrenalineRush")?(e.maxHealth>0?e.health/e.maxHealth:0)<=.3&&e.perkRuntime.adrenalineRushTurnsRemaining<=0:!1,Nt=e=>le(e,"adrenalineRush")?{...e,actionPoints:Math.min(e.actionPoints+2,e.maxActionPoints+2),perkRuntime:{...e.perkRuntime,adrenalineRushTurnsRemaining:3}}:e,ja=e=>{if(!le(e,"adrenalineRush"))return e;const t=Math.max(0,e.perkRuntime.adrenalineRushTurnsRemaining-1);return{...e,actionPoints:Math.min(e.actionPoints+2,e.maxActionPoints+2),perkRuntime:{...e.perkRuntime,adrenalineRushTurnsRemaining:t}}},Ya=e=>!le(e,"ghost")||e.perkRuntime.ghostInvisibilityTurns<=0?e:{...e,perkRuntime:{...e.perkRuntime,ghostInvisibilityTurns:Math.max(0,e.perkRuntime.ghostInvisibilityTurns-1)}},ki=e=>{const t={strengthBonus:0,perceptionBonus:0,enduranceBonus:0,charismaBonus:0,intelligenceBonus:0,agilityBonus:0,luckBonus:0,totalArmorRating:0,totalAPPenalty:0,totalDamageBonus:0},{weapon:i,armor:n}=e.equipped;return i&&i.statModifiers&&sn(t,i.statModifiers),n&&(t.totalArmorRating+=n.protection||0,n.statModifiers&&sn(t,n.statModifiers)),t};function sn(e,t){e.strengthBonus=(e.strengthBonus||0)+(t.strengthBonus||0),e.perceptionBonus=(e.perceptionBonus||0)+(t.perceptionBonus||0),e.enduranceBonus=(e.enduranceBonus||0)+(t.enduranceBonus||0),e.charismaBonus=(e.charismaBonus||0)+(t.charismaBonus||0),e.intelligenceBonus=(e.intelligenceBonus||0)+(t.intelligenceBonus||0),e.agilityBonus=(e.agilityBonus||0)+(t.agilityBonus||0),e.luckBonus=(e.luckBonus||0)+(t.luckBonus||0),e.totalArmorRating=(e.totalArmorRating||0)+(t.armorRating||0),e.totalAPPenalty=(e.totalAPPenalty||0)+(t.apPenalty||0),e.totalDamageBonus=(e.totalDamageBonus||0)+(t.damageBonus||0)}const $a=(e,t)=>({strength:e.strength+(t.strengthBonus||0),perception:e.perception+(t.perceptionBonus||0),endurance:e.endurance+(t.enduranceBonus||0),charisma:e.charisma+(t.charismaBonus||0),intelligence:e.intelligence+(t.intelligenceBonus||0),agility:e.agility+(t.agilityBonus||0),luck:e.luck+(t.luckBonus||0)}),Za=e=>ki(e).totalArmorRating+Ga(e),Xa=(e,t)=>{const i=t.totalAPPenalty||0,n=e-i;return Math.max(1,Math.floor(n))},Qa=(e,t,i=0)=>e+(t.totalDamageBonus||0)+i,Ja=(e,t)=>{const i=e-t;return Math.max(1,i)},Ci=e=>{const{strength:t,perception:i,endurance:n,charisma:s,intelligence:a,agility:o,luck:r}=e;return{maxHP:50+n*10,baseAP:6+Math.floor((o-5)*.5),maxStamina:50+n*5,carryWeight:25+t*5,criticalChance:5+i*2+r*2,dialogueThresholdBonus:Math.floor(s/2),skillPointsPerLevel:3+Math.floor(a/3),hitChanceModifier:(i-5)*3,dodgeChance:(o-5)*2,meleeDamageBonus:Math.floor(t/2)}},qe=e=>50+e*10,ze=e=>6+Math.floor((e-5)*.5),re=e=>50+e*5,Ve=e=>25+e*5,hh=(e,t,i=0)=>!Number.isFinite(e)||!Number.isFinite(t)||!Number.isFinite(i)?(console.warn("[StatCalculations] Invalid skill check parameters:",{attributeValue:e,threshold:t,bonus:i}),!1):e+i>=t,eo=e=>{const t=ki(e),i=$a(e.skills,t),n=Ci(i),s=Xa(n.baseAP,t);return{...n,baseAP:s}},to=(e,t,i)=>Number.isNaN(e)||!Number.isFinite(e)?0:Math.max(t,Math.min(i,Math.round(e))),Z=e=>to(e,-100,100),te=[{id:"hostile",label:"Hostile",min:-100,max:-61,color:"#ef4444",icon:"⚠️"},{id:"unfriendly",label:"Unfriendly",min:-60,max:-20,color:"#f97316",icon:"⚠"},{id:"neutral",label:"Neutral",min:-19,max:19,color:"#94a3b8",icon:"•"},{id:"friendly",label:"Friendly",min:20,max:59,color:"#4ade80",icon:"★"},{id:"allied",label:"Allied",min:60,max:100,color:"#facc15",icon:"✪"}],ds=te.reduce((e,t)=>(e[t.id]=t,e),{hostile:te[0],unfriendly:te[1],neutral:te[2],friendly:te[3],allied:te[4]}),de=e=>{const t=Z(e);for(const i of te)if(t>=i.min&&t<=i.max)return i;return ds.neutral},ph=e=>de(e),io=e=>{const t=de(e),i=te.findIndex(s=>s.id===t.id);if(i<0||i===te.length-1)return null;const n=te[i+1];return{standing:n,requiredValue:n.min}},Ie={resistance:{definition:{id:"resistance",name:"Resistance",description:"Anti-regime saboteurs coordinating from hidden cells throughout the slums.",rivalId:"corpsec",defaultReputation:10},effects:{hostile:["Resistance ambush teams hunt you on sight.","Safe houses barred and support staff evacuate when you enter a cell."],unfriendly:["Handlers refuse new operations and keep patrol intel off the record.","Markets charge +50% and watchers shadow your movements."],neutral:["Standard trade access with baseline mission availability."],friendly:["Safe house quartermasters grant -25% discounts.","Resistance fire teams can reinforce nearby encounters.","Access to special sabotage contracts."],allied:["Leadership shares prototype gear and strategic intel.","Full access to command safe houses and staging areas.","Resistance commits strike units to the final mission."]}},corpsec:{definition:{id:"corpsec",name:"CorpSec",description:"Corporate security forces enforcing curfew and regime edicts downtown.",rivalId:"resistance",defaultReputation:-20},effects:{hostile:["CorpSec strike teams engage immediately and post bounties.","Checkpoints sealed; city travel heavily restricted."],unfriendly:["CorpSec enforcers tail you and random searches increase.","Vendor prices +50% and contracts withdrawn."],neutral:["Standard patrol scrutiny with access to routine contracts."],friendly:["Access to restricted checkpoints and heavy weapon requisitions.","CorpSec officers provide enforcement support nearby."],allied:["CorpSec elevates you to trusted asset status.","Elite armories and armored escorts unlocked for the endgame assault."]}},scavengers:{definition:{id:"scavengers",name:"Scavengers",description:"Resourceful traders running the black markets threading the slums and tunnels.",defaultReputation:0},effects:{hostile:["Black market shuts you out and bounty hunters look to cash in."],unfriendly:["Merchants hike prices by 50% and fence only low-tier goods.","Rumours and location intel dry up."],neutral:["Regular trade access with standard supply lists."],friendly:["Negotiated prices drop 25% and rare stock appears more often.","Vehicle parts and crafting materials offered reliably."],allied:["Exclusive caches, contraband routes, and crew hire options unlocked.","Scavengers lend munitions support during the finale."]}}},mh=e=>Ie[e],no=()=>Object.values(Ie).map(e=>e.definition),so=(e,t)=>Ie[e].effects[t],ao=e=>{const t={resistance:Ie.resistance.definition.defaultReputation,corpsec:Ie.corpsec.definition.defaultReputation,scavengers:Ie.scavengers.definition.defaultReputation};return e?{resistance:Z(e.resistance??t.resistance),corpsec:Z(e.corpsec??t.corpsec),scavengers:Z(e.scavengers??t.scavengers)}:t},oo=-70,ro=60,lo=.5,us=(e,t,i)=>{const n=ao(e),s=[],a=Z(e[t]??n[t]),o=de(a),r=Z(a+i),l=de(r);n[t]=r,l.id!==o.id&&s.push({factionId:t,previousStanding:o.id,nextStanding:l.id});const c={},d=Ie[t].definition.rivalId;if(d){const u=Z(e[d]??n[d]),h=de(u),g=-Math.round(i*lo);if(g!==0){const p=Z(u+g),m=p-u;if(m!==0){n[d]=p,c[d]=m;const y=de(p);y.id!==h.id&&s.push({factionId:d,previousStanding:h.id,nextStanding:y.id})}}if(r>=ro){const p=Z(oo);if(n[d]>p){const m=de(n[d]),y=p-n[d];n[d]=p,c[d]=(c[d]??0)+y;const v=de(n[d]);v.id!==m.id&&s.push({factionId:d,previousStanding:m.id,nextStanding:v.id})}}}return{values:n,primaryDelta:r-a,rivalDeltas:c,standingChanges:s}},co=(e,t,i)=>{const n=Z(e[t]);return us(e,t,Z(i)-n)},gh=(e,t)=>{const i=de(t);return{value:t,standing:i,effects:so(e,i.id),nextThreshold:io(t)}},fh=e=>te.findIndex(t=>t.id===e),uo={en:{hostile:"Hostile",unfriendly:"Unfriendly",neutral:"Neutral",friendly:"Friendly",allied:"Allied"},uk:{hostile:"Ворог",unfriendly:"Недружній",neutral:"Нейтральний",friendly:"Союзний",allied:"Союз"}},yh=(e,t)=>{var i;return((i=uo[e])==null?void 0:i[t])??ds[t].label},nt={strength:5,perception:5,endurance:5,charisma:5,intelligence:5,agility:5,luck:5},an=qe(nt.endurance),on=ze(nt.agility),ho=Ve(nt.strength),rn=re(nt.endurance),po=no().reduce((e,t)=>(e[t.id]=t.defaultReputation,e),{resistance:0,corpsec:0,scavengers:0}),mo=()=>({smallGuns:0,energyWeapons:0,meleeCombat:0,explosives:0,hacking:0,engineering:0,science:0,medicine:0,stealth:0,scavenging:0,persuasion:0,intimidation:0,barter:0}),wt=()=>({alignment:"earnest",flags:{earnest:1,sarcastic:0,ruthless:0,stoic:0},lastUpdated:0}),U={id:Q(),name:"Player",position:{x:3,y:1},facing:"south",coverOrientation:null,suppression:0,health:an,maxHealth:an,actionPoints:on,maxActionPoints:on,stamina:rn,maxStamina:rn,isExhausted:!1,movementProfile:"normal",stealthModeEnabled:!1,stealthCooldownExpiresAt:null,skills:nt,skillTraining:mo(),taggedSkillIds:[],level:1,experience:0,credits:0,skillPoints:0,attributePoints:0,backgroundId:void 0,perks:[],pendingPerkSelections:0,karma:0,personality:wt(),factionReputation:{...po},appearancePreset:void 0,inventory:{items:[],maxWeight:ho,currentWeight:0,hotbar:[null,null,null,null,null]},equipped:{weapon:void 0,armor:void 0,accessory:void 0,secondaryWeapon:void 0,meleeWeapon:void 0,bodyArmor:void 0,helmet:void 0,accessory1:void 0,accessory2:void 0},equippedSlots:{},activeWeaponSlot:"primaryWeapon",perkRuntime:{gunFuShotsThisTurn:0,adrenalineRushTurnsRemaining:0,ghostInvisibilityTurns:0,ghostConsumed:!1},encumbrance:{level:"normal",percentage:0,movementApMultiplier:1,attackApMultiplier:1}},Ti=e=>e<=1?0:Math.floor(100*e*(1+e*.15)),go=e=>3+Math.floor(e/3),fo=e=>e>0,yo=e=>e>0&&e%2===0,vo=(e,t)=>{const i=Ti(t+1);return e>=i},bo=e=>{let t=0,i=0,n=0,s=0;const a={...e};for(;vo(a.experience,a.level);){const o=Ti(a.level+1);a.experience-=o,a.level+=1,t++;const r=go(a.skills.intelligence);i+=r,fo(a.level)&&n++,yo(a.level)&&s++,a.maxHealth+=5,a.health=a.maxHealth,a.maxStamina=re(a.skills.endurance),a.stamina=a.maxStamina,a.isExhausted=!1,a.level%5===0&&(a.maxActionPoints+=1,a.actionPoints=a.maxActionPoints)}return{player:a,levelsGained:t,skillPointsAwarded:i,attributePointsAwarded:n,perksUnlocked:s}},So=(e,t)=>({...e,experience:Math.max(0,e.experience+t)}),vh=(e,t)=>{const i=Ti(t+1);return`${e} / ${i} XP`},wo=[{id:"corpsec_defector",name:"Corpsec Defector",tagline:"Turned the regime’s training against them.",description:["Former security officer who leaked patrol routes until the alarms sounded on you.","You know their formations by heart and still dream in evac sirens."],factionAdjustments:{resistance:10,corpsec:-20},startingEquipment:[{type:"catalog",definitionId:"weapon_corpsec_service_pistol",equip:!0},{type:"catalog",definitionId:"armor_kevlar_vest",equip:!0},{type:"catalog",definitionId:"misc_corpsec_credentials"},{type:"catalog",definitionId:"consumable_basic_repair_kit",quantity:1}]},{id:"street_urchin",name:"Street Urchin",tagline:"Raised by alleys, guided by whispers.",description:["You hustled the markets since curfew was a bedtime story.","Lockpicks, fast feet, and favor debts keep you breathing."],factionAdjustments:{scavengers:10},startingEquipment:[{type:"catalog",definitionId:"weapon_shiv_knife",equip:!0},{type:"catalog",definitionId:"armor_layered_leather_jacket",equip:!0},{type:"catalog",definitionId:"misc_lockpick_set"},{type:"catalog",definitionId:"consumable_basic_repair_kit",quantity:1}]},{id:"underground_hacker",name:"Underground Hacker",tagline:"Screensaver by day, blackout by night.",description:["Your code toppled curfew drones before dawn.","Signal ghosts and failsafe exploits follow in your wake."],factionAdjustments:{resistance:15,corpsec:-10},startingEquipment:[{type:"catalog",definitionId:"misc_custom_deck"},{type:"catalog",definitionId:"misc_emp_charge"},{type:"catalog",definitionId:"armor_utility_hoodie",equip:!0},{type:"catalog",definitionId:"consumable_basic_repair_kit",quantity:1}]},{id:"wasteland_scavenger",name:"Wasteland Scavenger",tagline:"Dust lungs, steady hands, endless caches.",description:["You crossed toxic badlands with nothing but a crowbar and spite.","Trade routes and buried caches live in your head like lullabies."],factionAdjustments:{scavengers:10,resistance:5},startingEquipment:[{type:"catalog",definitionId:"weapon_industrial_crowbar",equip:!0},{type:"catalog",definitionId:"misc_gas_mask"},{type:"catalog",definitionId:"consumable_field_medkit",quantity:1},{type:"catalog",definitionId:"consumable_basic_repair_kit",quantity:1}]}],Po=Object.fromEntries(wo.map(e=>[e.id,e])),ln={damageMultiplier:1,hitChanceBonus:0,critChanceBonus:0,magazineSizeMultiplier:1,silenced:!1},Pt=(e,t)=>e?(t??e.attachedMods??[]).reduce((n,s)=>{var a,o;try{const l=tt(s.modId).effect;l.damageMultiplier!==void 0&&(n.damageMultiplier*=l.damageMultiplier),l.hitChanceBonus!==void 0&&(n.hitChanceBonus+=l.hitChanceBonus),l.hitChancePenalty!==void 0&&(n.hitChanceBonus-=l.hitChancePenalty),l.critChanceBonus!==void 0&&(n.critChanceBonus+=l.critChanceBonus),l.magazineSizeMultiplier!==void 0&&(n.magazineSizeMultiplier*=l.magazineSizeMultiplier),l.armorPiercingFactor!==void 0&&(n.armorPiercingFactor=n.armorPiercingFactor!==void 0?Math.min(n.armorPiercingFactor,l.armorPiercingFactor):l.armorPiercingFactor),(l.silenced||(a=l.addTags)!=null&&a.includes("silenced"))&&(n.silenced=!0),(o=l.addTags)!=null&&o.includes("armorPiercing")&&(n.armorPiercingFactor=n.armorPiercingFactor??.5)}catch{}return n},{...ln}):{...ln},bh=(e,t,i)=>{if(!e)return{compatible:!1,reason:"Weapon not found"};if(!(e.modSlots??[]).includes(i))return{compatible:!1,reason:"This weapon has no matching slot."};const s=tt(t);if(s.slot!==i)return{compatible:!1,reason:"Mod slot mismatch."};const a=e.weaponType??"pistol";return s.compatibleWeaponTypes.includes(a)?{compatible:!0}:{compatible:!1,reason:"Not compatible with this weapon type."}},Mo=(e,t)=>({id:Q(),amount:e,reason:t}),Ao=(e,t,i,n)=>({newLevel:e,skillPointsEarned:t,attributePointsEarned:i,perksUnlocked:n}),Ft=1e-4,xo={normal:{movement:1,attack:1},heavy:{movement:1.25,attack:1.1,warning:"Pack weight is slowing you. You will bleed AP if you keep hauling this much."},overloaded:{movement:2,attack:1.25,warning:"Overloaded. Movement now chews double AP until you off-load gear."},immobile:{movement:Number.POSITIVE_INFINITY,attack:Number.POSITIVE_INFINITY,warning:"You are pinned by your gear. Drop items before you can move or fight."}},Io=e=>!Number.isFinite(e)||Number.isNaN(e)?0:Math.max(0,Math.round(e*100)/100),ko=e=>e>=120-Ft?"immobile":e>=100-Ft?"overloaded":e>=80-Ft?"heavy":"normal",Co=(e,t,i)=>{const n=t<=0?1:t,s=e/n*100,a=Io(s),o=ko(a),r=xo[o],l=r.warning??((i==null?void 0:i.level)===o?i==null?void 0:i.warning:void 0);return{level:o,percentage:a,movementApMultiplier:r.movement,attackApMultiplier:r.attack,warning:l}},To=e=>e.level==="immobile"||e.movementApMultiplier===Number.POSITIVE_INFINITY,Sh={sprintTile:2,strenuousInteraction:1},Eo=3,Ro=.3,_o=.4,Le=(e,t)=>!Number.isFinite(e)||!Number.isFinite(t)||t<=0||e<0?0:e>t?t:e,hs=(e,t)=>!Number.isFinite(e)||!Number.isFinite(t)||t<=0?0:Math.max(0,Math.min(1,e/t)),Lo=(e,t)=>hs(e,t)<Ro,Do=(e,t)=>hs(e,t)>_o,Ge=(e,t)=>{var i;return((i=e==null?void 0:e.tags)==null?void 0:i.includes(t))??!1},Bt=e=>Ge(e,"twoHanded"),Ze=2,ei=()=>{const e={...U,id:Q(),position:{...U.position},skills:{...U.skills},skillTraining:{...U.skillTraining},taggedSkillIds:[...U.taggedSkillIds],inventory:{items:[],maxWeight:U.inventory.maxWeight,currentWeight:0,hotbar:[null,null,null,null,null]},karma:U.karma,personality:wt(),equipped:{weapon:void 0,armor:void 0,accessory:void 0,secondaryWeapon:void 0,meleeWeapon:void 0,bodyArmor:void 0,helmet:void 0,accessory1:void 0,accessory2:void 0},equippedSlots:{},activeWeaponSlot:"primaryWeapon",factionReputation:{...U.factionReputation},perks:[...U.perks],pendingPerkSelections:U.pendingPerkSelections,backgroundId:void 0,appearancePreset:U.appearancePreset,perkRuntime:{...U.perkRuntime},encumbrance:{level:"normal",percentage:0,movementApMultiplier:1,attackApMultiplier:1}};return Ce(e),Te(e),e},q={version:Ze,data:ei(),pendingLevelUpEvents:[],xpNotifications:[],pendingFactionEvents:[]},Pe=e=>Math.max(1,Math.min(10,Math.round(e))),Oo=e=>Math.round(e*100)/100,ti=5,No=["primaryWeapon","secondaryWeapon","meleeWeapon","bodyArmor","helmet","accessory1","accessory2"],Fo=20,Bo=e=>e.primaryDelta!==0||Object.values(e.rivalDeltas).some(t=>t!==0)||e.standingChanges.length>0,Ho=(e,t)=>{e.pendingFactionEvents.push(t),e.pendingFactionEvents.length>Fo&&e.pendingFactionEvents.shift()},cn=(e,t,i,n)=>{Bo(i)&&Ho(e,{factionId:t,delta:i.primaryDelta,updatedValue:e.data.factionReputation[t],rivalDeltas:i.rivalDeltas,standingChanges:i.standingChanges,reason:n==null?void 0:n.reason,source:n==null?void 0:n.source,timestamp:Date.now()})};function _e(e){if(!Number.isFinite(e.maxStamina)||e.maxStamina<=0){e.maxStamina=0,e.stamina=0,e.isExhausted=!1;return}if(e.stamina=Le(e.stamina,e.maxStamina),Lo(e.stamina,e.maxStamina)){e.isExhausted=!0;return}if(e.isExhausted&&Do(e.stamina,e.maxStamina)){e.isExhausted=!1;return}!e.isExhausted&&e.stamina>=e.maxStamina&&(e.isExhausted=!1)}function Me(e,t,i={}){const n=i.preserveRatio??!0,s=Number.isFinite(t)&&t>0?Math.floor(t):0,a=Number.isFinite(e.maxStamina)&&e.maxStamina>0?e.maxStamina:0;let o;if(!n||a===0||s===0)o=s;else{const r=Math.max(0,Math.min(1,Le(e.stamina,a)/a));o=Math.floor(s*r)}e.maxStamina=s,e.stamina=s===0?0:Le(o,s),_e(e)}function Ce(e){(!Number.isFinite(e.maxStamina)||e.maxStamina<0)&&(e.maxStamina=re(e.skills.endurance)),Number.isFinite(e.stamina)?e.stamina=Le(e.stamina,e.maxStamina):e.stamina=e.maxStamina,typeof e.isExhausted!="boolean"&&(e.isExhausted=!1),_e(e)}const Ei=e=>{const t=e?[...e]:[];for(;t.length<ti;)t.push(null);return t.slice(0,ti)},_t=e=>{if(!e)return 0;if(!e.stackable)return 1;const t=e.quantity??1;return!Number.isFinite(t)||t<=0?1:Math.floor(t)},Wo=e=>typeof globalThis.structuredClone=="function"?globalThis.structuredClone(e):JSON.parse(JSON.stringify(e));function Te(e){e.movementProfile!=="silent"&&e.movementProfile!=="sprint"&&(e.movementProfile="normal"),typeof e.stealthModeEnabled!="boolean"&&(e.stealthModeEnabled=!1),e.stealthCooldownExpiresAt!==null&&(!Number.isFinite(e.stealthCooldownExpiresAt)||e.stealthCooldownExpiresAt<0)&&(e.stealthCooldownExpiresAt=null)}const ps=e=>e.damage!==void 0,ms=e=>e.protection!==void 0,qo=(e,t)=>{const i=new Set,n=[],s=(a,o)=>{if(!a||i.has(a.id)||!a.durability)return;const r=a.durability.max;if(!Number.isFinite(r)||r<=0)return;const l=a.durability.current;if(l>=r||t==="weapon"&&!ps(a)||t==="armor"&&!ms(a))return;const c=l<=0?0:Math.max(0,Math.min(1,l/r));i.add(a.id),n.push({item:a,ratio:c,equipped:o})};return s(e.equipped.weapon,!0),s(e.equipped.secondaryWeapon,!0),s(e.equipped.meleeWeapon,!0),s(e.equipped.bodyArmor,!0),s(e.equipped.helmet,!0),e.equippedSlots&&Object.values(e.equippedSlots).forEach(a=>s(a,!0)),e.inventory.items.forEach(a=>s(a,!1)),n},zo=(e,t)=>{var n;const i=qo(e,t);return i.length===0?null:(i.sort((s,a)=>s.ratio!==a.ratio?s.ratio-a.ratio:s.equipped!==a.equipped?s.equipped?-1:1:0),((n=i[0])==null?void 0:n.item.id)??null)},Vo=e=>{if(e.equipSlot)return e.equipSlot;const t=e;return(Number.isFinite(t.range)?t.range:0)<=1||t.skillType==="meleeCombat"?"meleeWeapon":"primaryWeapon"},ne=(e,t)=>{if(!e)return e;const i={...e};if(ps(i)){const n=i.durability,s=Number.isFinite(n==null?void 0:n.max)&&((n==null?void 0:n.max)??0)>0?Math.round(n.max):100,a=Number.isFinite(n==null?void 0:n.current)?Math.max(0,Math.round(n.current)):s;i.durability={max:s,current:Math.min(s,a)},i.equipSlot=t??Vo(i)}else if(ms(i)){const n=i.durability,s=Number.isFinite(n==null?void 0:n.max)&&((n==null?void 0:n.max)??0)>0?Math.round(n.max):120,a=Number.isFinite(n==null?void 0:n.current)?Math.max(0,Math.round(n.current)):s;i.durability={max:s,current:Math.min(s,a)},i.equipSlot=t??"bodyArmor"}else t&&(i.equipSlot=t);if(i.stackable){const n=_t(i)||1;i.quantity=n,(!Number.isFinite(i.maxStack)||i.maxStack===void 0||i.maxStack<=0)&&(i.maxStack=Math.max(5,n))}else delete i.quantity,delete i.maxStack;return Number.isFinite(i.weight)||(i.weight=0),Number.isFinite(i.value)||(i.value=0),i},Go=e=>{const t=e.reduce((i,n)=>{const s=Number.isFinite(n.weight)?n.weight:0;return i+s*_t(n)},0);return Oo(t)},X=e=>{e.inventory.items=e.inventory.items.map(n=>ne(n)??n);const t=Go(e.inventory.items),i=Ei(e.inventory.hotbar);e.inventory={...e.inventory,currentWeight:t,hotbar:i},e.encumbrance=Co(e.inventory.currentWeight,e.inventory.maxWeight,e.encumbrance)},Uo=(e,t)=>e.inventory.items.reduce((i,n)=>{if(n.definitionId!==t)return i;const s=n.stackable?n.quantity??1:1;return i+s},0),Ko=(e,t,i)=>{if(i<=0)return!0;let n=i;return e.inventory.items=e.inventory.items.reduce((s,a)=>{if(n<=0||a.definitionId!==t)return s.push(a),s;if(a.stackable){const o=a.quantity??1;return o>n?(s.push({...a,quantity:o-n}),n=0):n-=o,s}return n-=1,n<0&&(n=0),s},[]),X(e),n===0},jo=(e,t)=>{if(t.find(n=>Uo(e,n.id)<n.quantity))return!1;for(const n of t)if(!Ko(e,n.id,n.quantity))return!1;return!0},Ri=(e,t)=>{const i=e.inventory.items.findIndex(s=>s.id===t);if(i===-1)return;const[n]=e.inventory.items.splice(i,1);return n},gs=(e,t)=>t||(e.equipSlot?e.equipSlot:"damage"in e?"primaryWeapon":"protection"in e?"bodyArmor":null),Mt=e=>e.modSlots?e.modSlots:(e.weaponType??"pistol")==="melee"?[]:["barrel","magazine","optics"],fs=e=>{const t=e.magazineSize??0;if(t<=0)return e;const i=Pt(e),n=Math.max(1,Math.round(t*(i.magazineSizeMultiplier??1))),s=e.currentMagazine??n;return{...e,currentMagazine:Math.max(0,Math.min(n,s))}},Yo=(e,t)=>{const i=[...e.attachedMods??[]],n=i.findIndex(a=>a.slot===t);if(n===-1)return{updated:{...e,modSlots:Mt(e)}};const[s]=i.splice(n,1);return{updated:{...e,attachedMods:i,modSlots:Mt(e),currentMagazine:fs(e).currentMagazine},detachedModId:s.modId}},$o=(e,t)=>{const i=tt(t),n=Mt(e),s=[...e.attachedMods??[]],a=s.findIndex(r=>r.slot===i.slot);let o;return a!==-1&&(o=s[a].modId,s.splice(a,1)),s.push({slot:i.slot,modId:t}),{updated:{...e,attachedMods:s,modSlots:n,currentMagazine:fs(e).currentMagazine},replacedModId:o}},Zo=(e,t)=>{var l;const i=tt(t.modId),n=t.feePaid??0;if(i.crafting.station==="workbench"&&!t.atWorkbench||n>0&&e.credits<n)return!1;const s=((l=e.skillTraining)==null?void 0:l.engineering)??0;if(!Number.isFinite(s)||s<i.crafting.level)return!1;const a=i.crafting.inputs.map(c=>({id:c.id,quantity:c.quantity}));if(!jo(e,a))return!1;n>0&&(e.credits-=n);const r=Tt(t.modId);return e.inventory.items.push(r),X(e),!0},fe=(e,t,i)=>{switch(t){case"primaryWeapon":e.equipped.weapon=i;break;case"secondaryWeapon":e.equipped.secondaryWeapon=i;break;case"meleeWeapon":e.equipped.meleeWeapon=i;break;case"bodyArmor":e.equipped.bodyArmor=i,e.equipped.armor=i;break;case"helmet":e.equipped.helmet=i;break;case"accessory1":e.equipped.accessory1=i;break;case"accessory2":e.equipped.accessory2=i;break}e.equippedSlots||(e.equippedSlots={}),i?e.equippedSlots[t]=i:e.equippedSlots&&delete e.equippedSlots[t]},Ye=(e,t)=>{if(e.equippedSlots&&e.equippedSlots[t])return e.equippedSlots[t];switch(t){case"primaryWeapon":return e.equipped.weapon;case"secondaryWeapon":return e.equipped.secondaryWeapon;case"meleeWeapon":return e.equipped.meleeWeapon;case"bodyArmor":return e.equipped.bodyArmor??e.equipped.armor;case"helmet":return e.equipped.helmet;case"accessory1":return e.equipped.accessory1;case"accessory2":return e.equipped.accessory2;default:return}},At=e=>{const t={...e},i=e;return Array.isArray(i.attachedMods)&&(t.attachedMods=[...i.attachedMods]),t},st=(e,t)=>{const i=e.inventory.items.findIndex(n=>n.id===t);if(i!==-1)return{location:"inventory",item:e.inventory.items[i],index:i};for(const n of No){const s=Ye(e,n);if(s&&s.id===t)return{location:"equipped",item:s,slot:n}}},ys=(e,t,i)=>{if(t.location==="inventory"){e.inventory.items[t.index]=i;return}fe(e,t.slot,i),e.equippedSlots&&(e.equippedSlots[t.slot]=i)},Ht=(e,t)=>{const{itemId:i,slot:n}=t,s=e.inventory.items.find(c=>c.id===i);if(!s||s.isQuestItem||s.stackable||s.durability&&s.durability.current<=0)return!1;const a=gs(s,n);if(!a)return!1;const o="damage"in s?s:void 0;if(a==="secondaryWeapon"){if(o&&Bt(o))return!1;const c=Ye(e,"primaryWeapon");if(Bt(c))return!1}const r=Ri(e,i);if(!r)return!1;const l=Ye(e,a);if(l&&e.inventory.items.push(At(l)),a==="primaryWeapon"&&"damage"in r&&Bt(r)){const c=Ye(e,"secondaryWeapon");c&&(e.inventory.items.push(At(c)),fe(e,"secondaryWeapon",void 0),e.activeWeaponSlot==="secondaryWeapon"&&(e.activeWeaponSlot="primaryWeapon"))}return fe(e,a,r),(a==="primaryWeapon"||a==="secondaryWeapon"||a==="meleeWeapon")&&(e.activeWeaponSlot=a),X(e),!0},Wt=(e,t)=>{const{slot:i}=t,n=Ye(e,i);return n?(e.inventory.items.push(At(n)),fe(e,i,void 0),i===e.activeWeaponSlot&&(e.activeWeaponSlot="primaryWeapon"),X(e),!0):!1},vs=(e,t)=>{const{itemId:i,amount:n}=t;if(!Number.isFinite(n)||n<=0)return!1;const s=st(e,i);if(!s||!s.item.durability)return!1;const a=Math.floor(n),o=s.item.durability;return o.current=Math.min(o.max,o.current+a),s.location==="equipped"&&fe(e,s.slot,s.item),!0},Xo=(e,t)=>{const{itemId:i,quantity:n}=t;if(!Number.isFinite(n)||n<=0)return;const s=st(e,i);if(!s||s.location!=="inventory")return;const a=s.item;if(!a.stackable)return;const o=_t(a),r=Math.floor(n);if(r>=o)return;const l=At(a);l.id=Q(),l.quantity=r;const c=o-r;return a.quantity=c<=1?void 0:c,a.quantity===void 0&&delete a.quantity,e.inventory.items.push(l),X(e),l},Qo=(e,t)=>{const{slotIndex:i,itemId:n}=t;if(!Number.isInteger(i)||i<0||i>=ti)return!1;if(e.inventory.hotbar=Ei(e.inventory.hotbar),n!==null){const s=st(e,n);if(!s||s.location!=="inventory")return!1;e.inventory.hotbar=e.inventory.hotbar.map((a,o)=>a===n&&o!==i?null:a),e.inventory.hotbar[i]=n}else e.inventory.hotbar[i]=null;return!0},Jo=(e,t)=>{const{weaponId:i,modItemId:n}=t,s=st(e,i);if(!s||!("damage"in s.item))return!1;const a=s.item,o=e.inventory.items.find(p=>p.id===n&&p.weaponModId);if(!o||!o.weaponModId)return!1;const r=o.weaponModId,l=tt(r),c=a.weaponType??"pistol";if(!Mt(a).includes(l.slot)||!l.compatibleWeaponTypes.includes(c)||!Ri(e,n))return!1;const{updated:h,replacedModId:g}=$o(a,r);return g&&e.inventory.items.push(Tt(g)),ys(e,s,h),X(e),!0},er=(e,t)=>{const{weaponId:i,slot:n}=t,s=st(e,i);if(!s||!("damage"in s.item))return!1;const a=s.item,{updated:o,detachedModId:r}=Yo(a,n);return r?(e.inventory.items.push(Tt(r)),ys(e,s,o),X(e),!0):!1},tr=(e,t)=>{e.inventory.hotbar=Ei(e.inventory.hotbar);const i=e.inventory.items.findIndex(c=>c.id===t);if(i===-1)return!1;const n=e.inventory.items[i];if(!n||!("effect"in n))return!1;const s=n,a=s.effect;let o=null,r=0;if(a.type==="repair"&&(r=Math.floor(a.value??0),r<=0||(o=zo(e,a.target??"any"),!o)))return!1;let l=!1;if(n.stackable){const c=_t(n);if(c<=1)e.inventory.items.splice(i,1),l=!0;else{const d=c-1;d<=1?delete s.quantity:s.quantity=d}}else e.inventory.items.splice(i,1),l=!0;switch(l&&(e.inventory.hotbar=e.inventory.hotbar.map(c=>c===t?null:c)),a.type){case"health":{const c=Number.isFinite(a.value)?a.value:0;e.health=Math.min(e.maxHealth,Math.max(0,e.health+c));break}case"actionPoints":{const c=Number.isFinite(a.value)?a.value:0;e.actionPoints=Math.min(e.maxActionPoints,Math.max(0,e.actionPoints+c));break}case"stat":{if(a.statAffected){const c=e.skills[a.statAffected]??0,d=Number.isFinite(a.value)?a.value:0;e.skills[a.statAffected]=c+d}break}case"repair":{o&&vs(e,{itemId:o,amount:r});break}}return X(e),!0},ir=(e,t)=>{switch(t.type){case"catalog":{const i=Tt(t.definitionId,{quantity:t.quantity,durability:t.durability});if(t.equip){const n=gs(i);if(n){fe(e,n,i),(n==="primaryWeapon"||n==="secondaryWeapon"||n==="meleeWeapon")&&(e.activeWeaponSlot=n);break}}e.inventory.items.push(i);break}case"weapon":{const i=ba(t.name,t.damage,t.range,t.apCost,t.weight,t.statModifiers,t.skillType);t.equip?fe(e,"primaryWeapon",i):e.inventory.items.push(i);break}case"armor":{const i=va(t.name,t.protection,t.weight,t.statModifiers);t.equip?fe(e,"bodyArmor",i):e.inventory.items.push(i);break}case"consumable":{const i=ya(t.name,t.effectType,t.value,{statAffected:t.statAffected,weight:t.weight,target:t.target,stackable:t.stackable,maxStack:t.maxStack,quantity:t.quantity});e.inventory.items.push(i);break}case"item":{const i={id:Q(),name:t.name,description:t.description,weight:t.weight,value:Math.max(10,Math.round(t.weight*15)),isQuestItem:!!t.isQuestItem};e.inventory.items.push(i);break}}X(e)},bs=j({name:"player",initialState:q,reducers:{initializeCharacter:(e,t)=>{const{name:i,skills:n,backgroundId:s,visualPreset:a}=t.payload,o={strength:Pe(n.strength),perception:Pe(n.perception),endurance:Pe(n.endurance),charisma:Pe(n.charisma),intelligence:Pe(n.intelligence),agility:Pe(n.agility),luck:Pe(n.luck)},r=Ci(o),l=Po[s],c=ei();c.name=i,c.appearancePreset=a,c.skills=o,c.maxHealth=r.maxHP,c.health=r.maxHP,c.maxActionPoints=r.baseAP,c.actionPoints=r.baseAP,c.maxStamina=r.maxStamina,c.stamina=r.maxStamina,c.isExhausted=!1,_e(c),c.inventory={items:[],maxWeight:r.carryWeight,currentWeight:0,hotbar:[null,null,null,null,null]},c.equipped={weapon:void 0,armor:void 0,accessory:void 0,secondaryWeapon:void 0,meleeWeapon:void 0,bodyArmor:void 0,helmet:void 0,accessory1:void 0,accessory2:void 0},c.equippedSlots={},c.activeWeaponSlot="primaryWeapon",c.perks=[],c.pendingPerkSelections=0,c.backgroundId=s,c.factionReputation={resistance:0,corpsec:0,scavengers:0},c.perkRuntime={gunFuShotsThisTurn:0,adrenalineRushTurnsRemaining:0,ghostInvisibilityTurns:0,ghostConsumed:!1},l&&(l.perk&&c.perks.push(l.perk.id),Object.entries(l.factionAdjustments).forEach(([d,u])=>{const h=d,g=u??0,p=c.factionReputation[h]??0;c.factionReputation[h]=Z(p+g)}),l.startingEquipment.forEach(d=>ir(c,d))),e.data=c,e.data.encumbrance={level:"normal",percentage:0,movementApMultiplier:1,attackApMultiplier:1}},adjustFactionReputation:(e,t)=>{const{factionId:i,delta:n,reason:s,source:a}=t.payload;if(!Number.isFinite(n)||n===0)return;const o=us(e.data.factionReputation,i,n);e.data.factionReputation={...o.values},cn(e,i,o,{reason:s,source:a})},setFactionReputation:(e,t)=>{const{factionId:i,value:n,reason:s,source:a}=t.payload,o=co(e.data.factionReputation,i,n);e.data.factionReputation={...o.values},cn(e,i,o,{reason:s,source:a})},consumeFactionReputationEvents:e=>{e.pendingFactionEvents=[]},adjustPersonalityTrait:(e,t)=>{const{trait:i,delta:n,source:s}=t.payload;e.data.personality||(e.data.personality=wt());const a={...e.data.personality.flags},o=a[i]??0,r=Math.max(-5,Math.min(5,o+n));a[i]=r,e.data.personality={...e.data.personality,flags:a,lastUpdated:Date.now(),lastChangeSource:s??"storylet"}},movePlayer:(e,t)=>{if(e.data.encumbrance.level==="immobile")return;const i=e.data.position;if(e.data.position=t.payload,i){const n=t.payload.x-i.x,s=t.payload.y-i.y;(n!==0||s!==0)&&(Math.abs(n)>=Math.abs(s)?e.data.facing=n>=0?"east":"west":e.data.facing=s>=0?"south":"north")}e.data.coverOrientation=null,e.data.suppression=e.data.suppression??0},updateHealth:(e,t)=>{e.data.health=Math.max(0,Math.min(e.data.maxHealth,e.data.health+t.payload)),Ot(e.data)&&(e.data=Nt(e.data))},setHealth:(e,t)=>{e.data.health=Math.max(0,Math.min(e.data.maxHealth,t.payload)),Ot(e.data)&&(e.data=Nt(e.data))},updateActionPoints:(e,t)=>{e.data.actionPoints=Math.max(0,Math.min(e.data.maxActionPoints,e.data.actionPoints+t.payload))},resetActionPoints:e=>{e.data.actionPoints=e.data.maxActionPoints},consumeStamina:(e,t)=>{Ce(e.data),Te(e.data);const i=t.payload;if(!Number.isFinite(i)||i<=0)return;const n=Math.max(0,Math.floor(i));e.data.stamina=Le(e.data.stamina-n,e.data.maxStamina),_e(e.data)},regenerateStamina:(e,t)=>{Ce(e.data),Te(e.data);const i=t.payload??Eo;if(!Number.isFinite(i)||i<=0){_e(e.data);return}const n=Math.max(0,Math.floor(i));e.data.stamina=Le(e.data.stamina+n,e.data.maxStamina),_e(e.data)},updateMaxStamina:e=>{Ce(e.data),Te(e.data);const t=re(e.data.skills.endurance);Me(e.data,t,{preserveRatio:!0})},addExperience:(e,t)=>{const i=typeof t.payload=="number"?{amount:t.payload}:t.payload,n=i.amount;if(!Number.isFinite(n)||n===0)return;e.data=So(e.data,n);const s=bo(e.data);if(e.data=s.player,Ce(e.data),Te(e.data),s.skillPointsAwarded>0&&(e.data.skillPoints+=s.skillPointsAwarded),s.attributePointsAwarded>0&&(e.data.attributePoints+=s.attributePointsAwarded),s.perksUnlocked>0&&(e.data.pendingPerkSelections+=s.perksUnlocked),s.levelsGained>0&&(e.pendingLevelUpEvents.push(Ao(e.data.level,s.skillPointsAwarded,s.attributePointsAwarded,s.perksUnlocked)),Me(e.data,re(e.data.skills.endurance),{preserveRatio:!1})),n>0){const a=i.reason??"Experience gained",o=e.xpNotifications??[];e.xpNotifications=[...o,Mo(n,a)]}},addCredits:(e,t)=>{e.data.credits=Math.max(0,e.data.credits+t.payload)},setKarma:(e,t)=>{const i=Math.max(-1e3,Math.min(1e3,t.payload));e.data.karma=i,e.data.personality.lastUpdated=Date.now(),e.data.personality.lastChangeSource="karma:set"},adjustKarma:(e,t)=>{const i=Math.max(-1e3,Math.min(1e3,e.data.karma+t.payload));e.data.karma=i,e.data.personality.lastUpdated=Date.now(),e.data.personality.lastChangeSource="karma:adjust"},removeXPNotification:(e,t)=>{const i=e.xpNotifications??[];e.xpNotifications=i.filter(n=>n.id!==t.payload)},levelUp:e=>{e.data.level+=1,e.data.maxHealth+=10,e.data.health=e.data.maxHealth,e.data.maxActionPoints+=1,e.data.actionPoints=e.data.maxActionPoints;const t=re(e.data.skills.endurance);Me(e.data,t,{preserveRatio:!1})},updateSkill:(e,t)=>{const{skill:i,amount:n}=t.payload;e.data.skills[i]=Math.max(1,Math.min(10,e.data.skills[i]+n));const s=e.data.skills,a=qe(s.endurance),o=ze(s.agility),r=Ve(s.strength),l=re(s.endurance),c=Number.isFinite(e.data.health)?e.data.health:0,d=Number.isFinite(e.data.maxHealth)&&e.data.maxHealth>0?e.data.maxHealth:1,u=c/d;e.data.maxHealth=a;const h=Math.floor(a*u);e.data.health=Math.max(0,Math.min(Number.isFinite(h)?h:a,a)),e.data.maxActionPoints=o,e.data.actionPoints=Math.min(e.data.actionPoints,o),e.data.inventory.maxWeight=r,Me(e.data,l,{preserveRatio:!0})},setSkill:(e,t)=>{const{skill:i,value:n}=t.payload;e.data.skills[i]=Math.max(1,Math.min(10,n));const s=e.data.skills;e.data.maxHealth=qe(s.endurance),e.data.health=e.data.maxHealth,e.data.maxActionPoints=ze(s.agility),e.data.actionPoints=e.data.maxActionPoints,e.data.inventory.maxWeight=Ve(s.strength),Me(e.data,re(s.endurance),{preserveRatio:!1})},addItem:(e,t)=>{e.data.inventory.items.push(t.payload),X(e.data)},removeItem:(e,t)=>{const i=t.payload;Ri(e.data,i)&&X(e.data)},resetPlayer:e=>{e.version=Ze,e.data=ei(),e.pendingLevelUpEvents=[],e.xpNotifications=[],e.pendingFactionEvents=[]},setPlayerData:(e,t)=>{const i=Wo(t.payload);if(e.version=Ze,e.data=i,e.data.factionReputation||(e.data.factionReputation={...U.factionReputation}),["resistance","corpsec","scavengers"].forEach(s=>{const a=U.factionReputation[s]??0,o=e.data.factionReputation[s];e.data.factionReputation[s]=Z(typeof o=="number"?o:a)}),e.pendingFactionEvents=[],e.data.perkRuntime||(e.data.perkRuntime={gunFuShotsThisTurn:0,adrenalineRushTurnsRemaining:0,ghostInvisibilityTurns:0,ghostConsumed:!1}),e.data.inventory.hotbar||(e.data.inventory.hotbar=[null,null,null,null,null]),e.data.equipped?e.data.equipped={...e.data.equipped}:e.data.equipped={},e.data.equippedSlots||(e.data.equippedSlots={}),e.data.activeWeaponSlot||(e.data.activeWeaponSlot="primaryWeapon"),e.data.encumbrance||(e.data.encumbrance={level:"normal",percentage:0,movementApMultiplier:1,attackApMultiplier:1}),!e.data.personality)e.data.personality=wt();else{const s=e.data.personality.flags??{};e.data.personality={...e.data.personality,flags:{earnest:s.earnest??0,sarcastic:s.sarcastic??0,ruthless:s.ruthless??0,stoic:s.stoic??0},lastUpdated:e.data.personality.lastUpdated??0}}e.data.inventory.items=e.data.inventory.items.map(s=>ne(s)??s),e.data.equipped.weapon=ne(e.data.equipped.weapon,"primaryWeapon"),e.data.equipped.secondaryWeapon=ne(e.data.equipped.secondaryWeapon,"secondaryWeapon"),e.data.equipped.meleeWeapon=ne(e.data.equipped.meleeWeapon,"meleeWeapon"),e.data.equipped.bodyArmor=ne(e.data.equipped.bodyArmor,"bodyArmor"),e.data.equipped.helmet=ne(e.data.equipped.helmet,"helmet"),e.data.equipped.accessory1=ne(e.data.equipped.accessory1,"accessory1"),e.data.equipped.accessory2=ne(e.data.equipped.accessory2,"accessory2");const n=e.data.equippedSlots??{};e.data.equippedSlots=n,Object.entries(n).forEach(([s,a])=>{if(!a)return;const o=ne(a,s);n[s]=o}),Ce(e.data),Te(e.data),X(e.data),Ot(e.data)&&(e.data=Nt(e.data))},setMovementProfile:(e,t)=>{e.data.movementProfile=t.payload},setStealthState:(e,t)=>{e.data.stealthModeEnabled=t.payload.enabled,"cooldownExpiresAt"in t.payload&&(e.data.stealthCooldownExpiresAt=t.payload.cooldownExpiresAt??null)},equipItem:(e,t)=>{Ht(e.data,t.payload)},unequipItem:(e,t)=>{Wt(e.data,t.payload)},repairItem:(e,t)=>{vs(e.data,t.payload)},splitStack:(e,t)=>{Xo(e.data,t.payload)},assignHotbarSlot:(e,t)=>{Qo(e.data,t.payload),X(e.data)},attachWeaponMod:(e,t)=>{Jo(e.data,t.payload)},detachWeaponMod:(e,t)=>{er(e.data,t.payload)},craftWeaponMod:(e,t)=>{Zo(e.data,t.payload)},useInventoryItem:(e,t)=>{tr(e.data,t.payload)},equipWeapon:(e,t)=>{Ht(e.data,{itemId:t.payload,slot:"primaryWeapon"})},equipArmor:(e,t)=>{Ht(e.data,{itemId:t.payload,slot:"bodyArmor"})},unequipWeapon:e=>{Wt(e.data,{slot:"primaryWeapon"})},unequipArmor:e=>{Wt(e.data,{slot:"bodyArmor"})},consumeLevelUpEvent:e=>{e.pendingLevelUpEvents.shift()},clearPendingPerkSelections:e=>{e.data.pendingPerkSelections=0},selectPerk:(e,t)=>{const i=t.payload;if(e.data.pendingPerkSelections<=0||e.data.perks.includes(i))return;const n=ga(i);if(fa(e.data,n).canSelect)switch(e.data.perks.push(i),e.data.pendingPerkSelections=Math.max(0,e.data.pendingPerkSelections-1),i){case"gunFu":e.data.perkRuntime.gunFuShotsThisTurn=0;break;case"adrenalineRush":e.data.perkRuntime.adrenalineRushTurnsRemaining=0;break;case"ghost":e.data.perkRuntime.ghostConsumed=!1,e.data.perkRuntime.ghostInvisibilityTurns=0;break}},beginPlayerTurn:e=>{e.data=Ka(e.data),e.data.perkRuntime.adrenalineRushTurnsRemaining>0&&(e.data=ja(e.data)),e.data.perkRuntime.ghostInvisibilityTurns>0&&(e.data=Ya(e.data))},spendSkillPoints:(e,t)=>{const i=t.payload;e.data.skillPoints>=i&&i>0&&(e.data.skillPoints-=i)},allocateSkillPointToSkill:(e,t)=>{const i=t.payload;if(e.data.skillPoints<=0)return;const n=Jt(i),s=e.data.skillTraining[i]??0,o=e.data.taggedSkillIds.includes(i)?n.taggedIncrement:n.increment;s>=n.maxValue||s+o>n.maxValue||(e.data.skillTraining[i]=s+o,e.data.skillPoints-=1)},refundSkillPointFromSkill:(e,t)=>{const i=t.payload,n=Jt(i),s=e.data.skillTraining[i]??0;if(s<=0)return;const o=e.data.taggedSkillIds.includes(i)?n.taggedIncrement:n.increment,r=s-o;r<0||(e.data.skillTraining[i]=r,e.data.skillPoints+=1)},spendAttributePoint:(e,t)=>{const i=t.payload;if(e.data.attributePoints<=0||e.data.skills[i]>=10)return;e.data.attributePoints-=1,e.data.skills[i]+=1;const n=e.data.skills,s=qe(n.endurance),a=ze(n.agility),o=Ve(n.strength),r=re(n.endurance),l=Number.isFinite(e.data.health)?e.data.health:0,c=Number.isFinite(e.data.maxHealth)&&e.data.maxHealth>0?e.data.maxHealth:1,d=l/c;e.data.maxHealth=s;const u=Math.floor(s*d);e.data.health=Math.max(0,Math.min(Number.isFinite(u)?u:s,s)),e.data.maxActionPoints=a,e.data.actionPoints=Math.min(e.data.actionPoints,a),e.data.inventory.maxWeight=o,Me(e.data,r,{preserveRatio:!0})},refundAttributePoint:(e,t)=>{const i=t.payload;if(e.data.skills[i]<=1)return;e.data.attributePoints+=1,e.data.skills[i]-=1;const s=e.data.skills,a=qe(s.endurance),o=ze(s.agility),r=Ve(s.strength),l=re(s.endurance),c=Number.isFinite(e.data.health)?e.data.health:0,d=Number.isFinite(e.data.maxHealth)&&e.data.maxHealth>0?e.data.maxHealth:1,u=c/d;e.data.maxHealth=a;const h=Math.floor(a*u);e.data.health=Math.max(0,Math.min(Number.isFinite(h)?h:a,a)),e.data.maxActionPoints=o,e.data.actionPoints=Math.min(e.data.actionPoints,o),e.data.inventory.maxWeight=r,Me(e.data,l,{preserveRatio:!0})}}}),{initializeCharacter:wh,movePlayer:nr,updateHealth:sr,setHealth:Ph,updateActionPoints:dn,resetActionPoints:Mh,consumeStamina:Ah,regenerateStamina:xh,updateMaxStamina:Ih,addExperience:kh,addCredits:Ch,setKarma:Th,adjustKarma:Eh,adjustFactionReputation:ar,setFactionReputation:Rh,consumeFactionReputationEvents:_h,adjustPersonalityTrait:or,removeXPNotification:Lh,levelUp:Dh,updateSkill:Oh,setSkill:Nh,addItem:Fh,removeItem:Bh,equipItem:Hh,unequipItem:Wh,repairItem:qh,splitStack:zh,assignHotbarSlot:Vh,attachWeaponMod:Gh,detachWeaponMod:Uh,craftWeaponMod:Kh,useInventoryItem:jh,resetPlayer:Yh,setPlayerData:rr,setMovementProfile:$h,setStealthState:Zh,equipWeapon:Xh,equipArmor:Qh,unequipWeapon:Jh,unequipArmor:ep,consumeLevelUpEvent:tp,clearPendingPerkSelections:ip,selectPerk:np,beginPlayerTurn:sp,spendSkillPoints:ap,spendAttributePoint:op,refundAttributePoint:rp,allocateSkillPointToSkill:lp,refundSkillPointFromSkill:cp}=bs.actions,lr=bs.reducer,$e="corpsec-sentinel",N=e=>({kind:"lineOfSight",state:"chase",weight:0,...e}),cr=[N({kind:"lineOfSight",state:"attack",weight:3}),N({kind:"lineOfSight",state:"chase",weight:2}),N({kind:"lostLineOfSight",state:"search",weight:2}),N({kind:"healthBelow",state:"flee",threshold:.35,weight:3}),N({kind:"suppressionAbove",state:"panic",threshold:.6,weight:2}),N({kind:"alertAtLeast",state:"attack",alert:L.INVESTIGATING,weight:1.5}),N({kind:"alertBelow",state:"patrol",alert:L.SUSPICIOUS,weight:1}),N({kind:"distanceBelow",state:"attack",tiles:2,weight:2.5}),N({kind:"distanceAbove",state:"patrol",tiles:8,weight:1.2}),{kind:"healthBelow",state:"attack",threshold:.4,weight:-3},{kind:"healthBelow",state:"chase",threshold:.4,weight:-3},{kind:"healthBelow",state:"panic",threshold:.35,weight:2}],dr=[N({kind:"lineOfSight",state:"attack",weight:4}),N({kind:"lineOfSight",state:"chase",weight:3}),N({kind:"lostLineOfSight",state:"search",weight:1.5}),N({kind:"healthBelow",state:"panic",threshold:.25,weight:2}),N({kind:"suppressionAbove",state:"flee",threshold:.8,weight:2}),N({kind:"alertAtLeast",state:"attack",alert:L.ALARMED,weight:2}),N({kind:"directorAtLeast",state:"panic",threshold:.8,weight:1.5})],ur=[N({kind:"lineOfSight",state:"chase",weight:1.5}),N({kind:"lostLineOfSight",state:"search",weight:3}),N({kind:"healthBelow",state:"flee",threshold:.5,weight:3}),N({kind:"alertBelow",state:"patrol",alert:L.SUSPICIOUS,weight:2}),N({kind:"distanceAbove",state:"patrol",tiles:6,weight:1.5}),N({kind:"distanceBelow",state:"inspectNoise",tiles:4,weight:1.2})],qt=(e,t)=>({id:e,initialState:"patrol",baseWeights:{idle:.5,patrol:3,chase:1,search:1,attack:.5,inspectNoise:.5,flee:.2,panic:.1},cooldowns:{panic:12e3,flee:8e3,inspectNoise:2e3},minimumSelectableWeight:.05,...t}),ii={[$e]:{id:$e,label:"CorpSec Sentinel",description:"Baseline guard tuned for perimeter patrols; favours holding ground until line of sight is confirmed.",fsm:qt($e,{baseWeights:{idle:.6,patrol:3.5,chase:.3,search:.9,attack:.9,inspectNoise:.6,flee:.4,panic:.2},utilityModifiers:cr})},"corpsec-enforcer":{id:"corpsec-enforcer",label:"CorpSec Enforcer",description:"Aggressive shock troops that lean into panic suppression and rapid response.",fsm:qt("corpsec-enforcer",{initialState:"patrol",baseWeights:{idle:.2,patrol:2.5,chase:1.5,search:.6,attack:1.2,inspectNoise:.4,flee:.2,panic:.4},utilityModifiers:dr,cooldowns:{panic:1e4,flee:6e3,inspectNoise:1500}})},"corpsec-watchman":{id:"corpsec-watchman",label:"CorpSec Watchman",description:"Cautious sentry who prioritises searching and calling in reinforcements.",fsm:qt("corpsec-watchman",{baseWeights:{idle:1,patrol:2.5,chase:.6,search:1.4,attack:.5,inspectNoise:.8,flee:.5,panic:.2},utilityModifiers:ur,cooldowns:{panic:12e3,flee:9e3,inspectNoise:2500}})}},hr=e=>ii[e],un={zoneId:"unknown_zone",name:"Unknown Sector",level:0,danger:"low",hazards:[],objectives:[],summary:"No reconnaissance available for this zone."},hn={downtown_checkpoint:{zoneId:"downtown_checkpoint",name:"Slums Command Grid",level:0,danger:"moderate",hazards:["CorpSec curfew sweeps after sundown","Autonomous patrol drones scanning alleys","Tight choke points with improvised barricades"],objectives:["Recover Lira's contraband cache from the downtown evidence lockers.","Decrypt the surveillance manifests Archivist Naila smuggled out.","Re-establish Brant's courier drop routes across the grid before curfew.","Black out the CorpSec camera grid guarding the barricades.","Map patrol drone loops and assign safe counter-routes.","Restock Medic Yara's rebel clinic with field medkits.","Ambush the transit patrol escorting the sweep captain."],summary:"Primary resistance staging ground on the edge of Downtown. Expect constant patrol loops and rapid curfew escalations once alarms trip."},gov_complex:{zoneId:"gov_complex",name:"Downtown Governance Ring",level:1,danger:"high",hazards:["Omnidirectional camera grids with rapid resync pulses","CorpSec riot squads supported by shield drones","Encrypted checkpoints requiring forged credentials"],objectives:["Breaching the executive archives for blackmail dossiers","Subverting curfew order terminals","Exfiltrating detained resistance couriers"],summary:"Corporate command nerve centre governing the city core. Security density spikes during curfew and when alert level rises above Suspicious."},corporate_plaza:{zoneId:"corporate_plaza",name:"Skyline Transit Spire",level:1,danger:"moderate",hazards:["Precision sniper nests covering rooftop routes","Kinetic response teams dispatched via mag-rails","Marketing holo projectors causing navigation glare"],objectives:["Sabotage skyline transit relays to halt corporate reinforcements","Secure encrypted comm relays for resistance broadcasts","Extract high-value defectors under corporate escort"],summary:"Vertical plaza bridging transit hubs and corporate towers. Movement is exposed but offers vantage points if you neutralise overwatch nests."},industrial_corridor:{zoneId:"industrial_corridor",name:"Industrial Wasteland",level:2,danger:"critical",hazards:["Toxic smog plumes reducing visibility and draining health","Open radiation pockets around collapsed reactors","Unstable power conduits causing electrical surges","Hostile scavenger clans with improvised explosives"],objectives:["Stabilise the resistance refinery outpost","Disrupt CorpSec convoy routes feeding the upper city","Recover prototype filtration tech before corp retrieval teams arrive"],summary:"Decommissioned industrial belt now weaponised by corp security. Navigation requires filtration gear and constant hazard monitoring."},resistance_safehouse:{zoneId:"resistance_safehouse",name:"Resistance Safehouse Network",level:0,danger:"low",hazards:["Tight corridors with limited firing lanes"],objectives:["Resupply from hidden caches","Brief with cell leadership for mission intel","Coordinate evac routes ahead of major operations"],summary:"Hidden safehouse offering respite between sorties. Minimal patrol risk but expect limited mobility and quick extraction drills."}},pr=e=>e.includes("::")?e.split("::")[0]??e:e,Ss=e=>{if(!e)return un;const t=hn[e];if(t)return t;const i=hn[pr(e)];return i||{...un,zoneId:e}},mr={performance:{maxDecorPropsPerBuilding:2,maxAmbientGlows:12,enableAnimatedHazards:!1,enableHighDensityLabels:!1,maxFogBands:2,maxEmissiveZones:6,wetReflectionAlpha:.08,occlusionFadeFloor:.56},balanced:{maxDecorPropsPerBuilding:4,maxAmbientGlows:24,enableAnimatedHazards:!0,enableHighDensityLabels:!0,maxFogBands:4,maxEmissiveZones:10,wetReflectionAlpha:.14,occlusionFadeFloor:.48},cinematic:{maxDecorPropsPerBuilding:6,maxAmbientGlows:36,enableAnimatedHazards:!0,enableHighDensityLabels:!0,maxFogBands:6,maxEmissiveZones:14,wetReflectionAlpha:.2,occlusionFadeFloor:.38}},pn=(e,t,i,n,s,a,o,r,l,c,d,u,h,g)=>({district:e,signageStyle:t,propDensity:i,facadePattern:n,lotPattern:s,massingStyle:a,massingHeight:o,accentHex:r,glowHex:l,trimHex:c,atmosphereHex:d,signagePrimaryHex:u,signageSecondaryHex:h,backdropHex:g}),ws={downtown:pn("downtown","corp_holo","medium","ribbed","plaza","block",1.8,"#38bdf8","#67e8f9","#b6f7ff","#081126","#9beafe","#67e8f9","#0d1b2a"),slums:pn("slums","slums_neon","medium","banded","market","stacked",1,"#f97316","#fb923c","#ffd08d","#170c09","#6ff2ff","#9c8cff","#0b1220")},gr={player:{role:"player",baseColor:988970,outlineColor:6333946,primaryColor:3900150,accentColor:6809849,glowColor:3718648,columnHeight:1.65,widthScale:.78,heightScale:.5,depthOffset:12},friendlyNpc:{role:"friendlyNpc",baseColor:1713208,outlineColor:2282478,primaryColor:959977,accentColor:6809849,glowColor:2282478,columnHeight:1.35,widthScale:.74,heightScale:.48,depthOffset:9},hostileNpc:{role:"hostileNpc",baseColor:2758171,outlineColor:15680580,primaryColor:14427686,accentColor:16347926,glowColor:16478597,columnHeight:1.4,widthScale:.75,heightScale:.49,depthOffset:9},interactiveNpc:{role:"interactiveNpc",baseColor:1057336,outlineColor:10980346,primaryColor:9133302,accentColor:2282478,glowColor:12616956,columnHeight:1.45,widthScale:.77,heightScale:.5,depthOffset:10}},fr=e=>({id:"noir-vector-v1",preset:e,qualityBudget:mr[e],tilePalettes:{floorEven:1317418,floorOdd:1844280,wallEven:3096416,wallOdd:2569554,coverEven:2640722,coverOdd:2244423,waterEven:1066081,waterOdd:997200,trapEven:5644612,trapOdd:4528694,doorEven:3093058,doorOdd:2369333},districtDefaults:ws,entityProfiles:gr}),vt=(e,t,i)=>{const s=ws[e==="downtown"?"downtown":"slums"],a=t??s.signageStyle,o=i??s.propDensity;return a==="corp_brass"?{...s,signageStyle:a,propDensity:o,facadePattern:"chevron",lotPattern:"plaza",massingStyle:"block",massingHeight:2,accentHex:"#f3ca75",glowHex:"#fbbf24",trimHex:"#ffe4a3",atmosphereHex:"#1a140a",signagePrimaryHex:"#f3ca75",signageSecondaryHex:"#f9e2af",backdropHex:"#1a140a"}:a==="slums_scrap"?{...s,signageStyle:a,propDensity:o,facadePattern:"solid",lotPattern:"service",massingStyle:"block",massingHeight:.95,accentHex:"#f97316",glowHex:"#fb923c",trimHex:"#ffd299",atmosphereHex:"#190f08",signagePrimaryHex:"#f97316",signageSecondaryHex:"#fb923c",backdropHex:"#190f08"}:{...s,signageStyle:a,propDensity:o}},mn=["solid","ribbed","banded","chevron"],yr=["ribbed","chevron"],vr=["solid","banded"],br=["plaza","service"],Sr=["market","service"],wr=["block"],Pr=["stacked","block"],Mr=e=>{let t=0;for(let i=0;i<e.length;i+=1)t=t*31+e.charCodeAt(i)>>>0;return t},zt=e=>Math.max(0,Math.min(255,Math.round(e))),dt=(e,t)=>{const i=e.startsWith("#")?e.slice(1):e;if(i.length!==6)return e;const n=parseInt(i.slice(0,2),16),s=parseInt(i.slice(2,4),16),a=parseInt(i.slice(4,6),16),o=t*255;return`#${[zt(n+o),zt(s+o),zt(a+o)].map(l=>l.toString(16).padStart(2,"0")).join("")}`},Ar=e=>{const t={};return e.forEach(i=>{const n=vt(i.district,i.signageStyle,i.propDensity),s=Mr(`${i.id}:${i.name}`),a=i.district==="downtown"?"downtown":"slums",o=a==="downtown"?yr:vr,r=a==="downtown"?br:Sr,l=a==="downtown"?wr:Pr,c=o[s%o.length]??mn[s%mn.length],d=r[(s>>1)%r.length]??n.lotPattern,u=l[(s>>2)%l.length]??n.massingStyle,h=a==="downtown"?1.45:1,g=(s%7-3)*.09,p=Math.max(.85,h+g),m=a==="downtown"?(s%5-2)*.05:(s%7-3)*.06;t[i.id]={...n,facadePattern:c,lotPattern:d,massingStyle:u,massingHeight:p,accentHex:dt(n.accentHex,m),glowHex:dt(n.glowHex,m*.7),trimHex:dt(n.trimHex,m*.45),atmosphereHex:dt(n.atmosphereHex,m*.28)}}),{profilesByBuildingId:t}},xr=96,Ir=72,kr=e=>e>=24&&e<=26||e>=60&&e<=62,Cr=e=>e>=20&&e<=21||e>=44&&e<=45,Tr=(e,t)=>kr(e)||Cr(t),Er=(e,t)=>t.some(i=>{const{from:n,to:s}=i.footprint;return e.x>=n.x&&e.x<=s.x&&e.y>=n.y&&e.y<=s.y}),Rr=(e,t,i,n)=>{const s=ls(e,t,i,{level:n.level,isInterior:!0,zoneId:n.zoneId,factionRequirement:n.factionRequirement,displayName:n.displayName,summary:n.summary,dangerRating:n.dangerRating,hazards:n.hazards}),a={x:Math.floor(t/2),y:i-1},o={x:a.x,y:Math.max(1,a.y-1)},r=s.tiles[a.y][a.x];return r.type=E.DOOR,r.isWalkable=!0,{area:s,entryPosition:o,doorPosition:a}},_r=(e,t,i)=>{const n=[],s=[];return i.forEach(a=>{var d,u;const{from:o,to:r}=a.footprint;for(let h=o.y;h<=r.y;h++)for(let g=o.x;g<=r.x;g++){const p=(d=e.tiles[h])==null?void 0:d[g];p&&p.type===E.DOOR&&(p.type=E.WALL,p.isWalkable=!1)}const l=(u=e.tiles[a.door.y])==null?void 0:u[a.door.x];if(!l)return;l.type=E.DOOR,l.isWalkable=!0;const c=Rr(`${t} :: ${a.name}`,a.interior.width,a.interior.height,{level:e.level??0,zoneId:`${e.zoneId}::interior`,factionRequirement:a.factionRequirement,displayName:`${t} :: ${a.name}`,summary:e.summary,dangerRating:e.dangerRating,hazards:e.hazards});s.push(c.area),n.push({fromAreaId:e.id,fromPosition:{...a.door},toAreaId:c.area.id,toPosition:{...c.entryPosition}}),n.push({fromAreaId:c.area.id,fromPosition:{...c.doorPosition},toAreaId:e.id,toPosition:{...a.door}})}),{connections:n,interiors:s}},Lr=e=>e,Dr=(e,t,i,n,s,a,o)=>{const r=ls(e,xr,Ir,{level:0,objectives:i,zoneId:t}),l=Ss(t),c={...r,name:l.name,displayName:l.name,level:l.level,objectives:l.objectives.length?l.objectives:r.objectives,dangerRating:l.danger,hazards:l.hazards,summary:l.summary},d=[],u=(w,I,D,W)=>{for(let ce=I;ce<=W;ce++)for(let be=w;be<=D;be++)Tr(be,ce)||d.push({x:be,y:ce})};n.forEach(w=>{u(w.footprint.from.x,w.footprint.from.y,w.footprint.to.x,w.footprint.to.y)});const h=Ha(c,d),p=s.map(w=>w.position).filter(w=>{var D;const I=(D=h.tiles[w.y])==null?void 0:D[w.x];return I?I.isWalkable:!1}),m=Wa(h,p),y=new Set(p.map(w=>`${w.x}:${w.y}`)),v=s.reduce((w,I)=>{if(!I.profile)return w;const D=`${I.position.x}:${I.position.y}`;return y.has(D)?qa(w,I.position,I.profile):w},m),S=Lr(v),M=Ar(n),b=n.map(w=>({id:w.id,name:w.name,signageStyle:w.signageStyle,district:w.district,propDensity:w.propDensity,encounterProfile:w.encounterProfile,workbench:w.workbench,footprint:{from:{...w.footprint.from},to:{...w.footprint.to}},door:{...w.door},visualProfile:M.profilesByBuildingId[w.id]?{facadePattern:M.profilesByBuildingId[w.id].facadePattern,lotPattern:M.profilesByBuildingId[w.id].lotPattern,massingStyle:M.profilesByBuildingId[w.id].massingStyle,massingHeight:M.profilesByBuildingId[w.id].massingHeight,accentHex:M.profilesByBuildingId[w.id].accentHex,glowHex:M.profilesByBuildingId[w.id].glowHex,trimHex:M.profilesByBuildingId[w.id].trimHex,atmosphereHex:M.profilesByBuildingId[w.id].atmosphereHex,signagePrimaryHex:M.profilesByBuildingId[w.id].signagePrimaryHex,signageSecondaryHex:M.profilesByBuildingId[w.id].signageSecondaryHex,backdropHex:M.profilesByBuildingId[w.id].backdropHex}:void 0}));S.buildings=b;const A=w=>{var D;const I=(D=S.tiles[w.y])==null?void 0:D[w.x];return!I||!I.isWalkable||I.type===E.DOOR||I.type===E.WALL?!1:!Er(w,n)},k=w=>{const I=xi(w,S)??w;return A(I)?I:cs(I,S).find(ce=>A(ce))??null};a.forEach(w=>{const I=k(w.position);I&&S.entities.npcs.push({...w,id:Q(),position:I})});const x=p.length?p:[{x:32,y:74},{x:84,y:28},{x:54,y:64}];o.forEach((w,I)=>{const D=x[I%x.length],W=k(D)??D;S.entities.items.push({...w,id:Q(),position:W})});const{connections:T,interiors:H}=_r(S,e,n);return H.forEach(w=>{w.level=w.level??0,w.objectives=w.objectives??[]}),{area:S,connections:T,interiorAreas:H}},Or=({locale:e})=>{const t=Et(e),i=Dr(t.world.areaName,t.world.zoneId,t.world.objectives,t.buildingDefinitions,t.coverSpots.all,t.npcBlueprints,t.itemBlueprints),n=i.area,a=[...i.interiorAreas].reduce((o,r)=>(o[r.id]=r,o),{[n.id]:n});return{slumsArea:n,mapAreas:a,connections:[...i.connections]}},F={cycleDuration:300,timeMultiplier:1,morningStartTime:0,dayStartTime:.1,eveningStartTime:.4,dayEndTime:.5},De=(e,t=F)=>{const i=e%t.cycleDuration/t.cycleDuration;return i>=t.morningStartTime&&i<t.dayStartTime?"morning":i>=t.dayStartTime&&i<t.eveningStartTime?"day":i>=t.eveningStartTime&&i<t.dayEndTime?"evening":"night"},Nr=(e,t=F)=>{const i=e%t.cycleDuration/t.cycleDuration;return i>=t.morningStartTime&&i<t.dayStartTime?.4+(i-t.morningStartTime)/(t.dayStartTime-t.morningStartTime)*.6:i>=t.dayStartTime&&i<t.eveningStartTime?1:i>=t.eveningStartTime&&i<t.dayEndTime?1-(i-t.eveningStartTime)/(t.dayEndTime-t.eveningStartTime)*.6:.2},Fr=(e,t=F)=>{const i=De(e,t),n=Nr(e,t);switch(i){case"morning":return`rgba(180, 208, 255, ${(1-n)*.22})`;case"day":return"rgba(255, 255, 255, 0)";case"evening":return`rgba(214, 179, 255, ${(1-n)*.28})`;case"night":return`rgba(18, 30, 64, ${.72*(1-n)})`;default:return"rgba(0, 0, 0, 0)"}},Xe=(e,t=F)=>De(e,t)==="night";var Vt={};const Br=()=>{},Hr=()=>typeof process<"u"?"production":"development",Wr=()=>[typeof process<"u"?Vt==null?void 0:Vt.ENABLE_VERBOSE_LOGS:void 0,typeof globalThis<"u"?globalThis.__ENABLE_VERBOSE_LOGS:void 0].some(t=>typeof t=="string"?t.toLowerCase()==="true":t===!0),qr=!Wr()&&Hr()==="test",zr=e=>{const t=console[e]??console.log;return typeof t=="function"?t.bind(console):console.log.bind(console)},ut=(e,t)=>{const i=zr(e);return qr&&(e==="debug"||e==="info")?Br:(...n)=>{i(`[${t}]`,...n)}},_i=e=>({debug:ut("debug",e),info:ut("info",e),warn:ut("warn",e),error:ut("error",e)});_i("app");const se=_i("worldSlice"),Vr=()=>({flags:{gangHeat:"low",curfewLevel:0,supplyScarcity:"norm",blackoutTier:"none"},weather:{presetId:null,rainIntensity:0,thunderActive:!1,sirenLoop:!1,updatedAt:0,timeOfDay:null},signage:{},rumorSets:{},notes:[]}),Gr=(e,t)=>(e.buildings??[]).some(i=>{const{from:n,to:s}=i.footprint;return t.x>=n.x&&t.x<=s.x&&t.y>=n.y&&t.y<=s.y}),Ur=e=>({id:Q(),name:e,position:{x:34,y:24},facing:"west",coverOrientation:null,suppression:0,maxHealth:45,health:45,actionPoints:4,maxActionPoints:4,damage:7,attackRange:2,isHostile:!0,visionCone:{range:10,angle:90,direction:180},alertLevel:L.IDLE,alertProgress:0,lastKnownPlayerPosition:null,aiProfileId:$e,aiState:"patrol",aiLastTransitionAt:0,aiCooldowns:{}}),dp=Math.floor(F.dayEndTime*F.cycleDuration),Kr=Math.floor(F.dayStartTime*F.cycleDuration),Ps=Math.floor((F.dayStartTime+F.eveningStartTime)/2*F.cycleDuration),Ms=e=>{const t=Or({locale:e}),i=Et(e),n=t.slumsArea,s=Ur(i.world.initialEnemyName),a=xi(s.position,n);a&&(s.position=a),n.entities.enemies.push(s),se.debug("Initial map generated with enemy:",s);const o=Ps;return{currentMapArea:n,mapAreas:t.mapAreas,mapConnections:t.connections,currentTime:o,timeOfDay:De(o,F),curfewActive:Xe(o,F),inCombat:!1,isPlayerTurn:!0,turnCount:1,globalAlertLevel:L.IDLE,reinforcementsScheduled:!1,environment:Vr(),engagementMode:"none",workbenchAvailable:!1,workbenchStatus:{available:!1,note:"No workbench nearby"}}},jr=Ms(ve),As=j({name:"world",initialState:jr,reducers:{setEnvironmentFlags:(e,t)=>{e.environment.flags={...e.environment.flags,...t.payload}},setWorkbenchAvailable:(e,t)=>{e.workbenchAvailable=t.payload,e.workbenchStatus={available:t.payload,note:t.payload?void 0:"No workbench nearby"}},setWorkbenchStatus:(e,t)=>{e.workbenchStatus={...t.payload},e.workbenchAvailable=t.payload.available},applyEnvironmentWeather:(e,t)=>{e.environment.weather={...t.payload}},applyEnvironmentSignage:(e,t)=>{const{signId:i,snapshot:n}=t.payload;e.environment.signage={...e.environment.signage,[i]:{...n}}},removeEnvironmentSignage:(e,t)=>{const i={...e.environment.signage};delete i[t.payload],e.environment.signage=i},applyEnvironmentRumorSet:(e,t)=>{const{groupId:i,snapshot:n}=t.payload;e.environment.rumorSets={...e.environment.rumorSets,[i]:{...n}}},removeEnvironmentRumorSet:(e,t)=>{const i={...e.environment.rumorSets};delete i[t.payload],e.environment.rumorSets=i},registerEnvironmentalNote:(e,t)=>{const i=t.payload,n=e.environment.notes.findIndex(s=>s.instanceId===i.instanceId);n>=0?e.environment.notes[n]={...i}:e.environment.notes.push({...i})},clearEnvironmentalNotesForArea:(e,t)=>{const i=t.payload;e.environment.notes=e.environment.notes.filter(n=>n.areaId!==i)},setNpcAmbientProfile:(e,t)=>{const{profile:i,match:n}=t.payload,{dialogueId:s,name:a}=n,o=r=>{let l=!1;const c=r.map(d=>{const u=s?d.dialogueId===s:!1,h=a?d.name===a:!1;return!u&&!h?d:(l=!0,{...d,ambientProfile:i?{...i}:void 0})});return l?c:r};e.currentMapArea.entities.npcs=o(e.currentMapArea.entities.npcs),Object.values(e.mapAreas).forEach(r=>{r.entities.npcs=o(r.entities.npcs)})},setMapArea:(e,t)=>{e.currentMapArea=t.payload,e.inCombat=!1,e.isPlayerTurn=!0,e.turnCount=1,e.engagementMode="none",e.workbenchAvailable=!1,e.workbenchStatus={available:!1,note:"No workbench nearby"}},setCurrentMapAreaZoneMetadata:(e,t)=>{const i=Ss(t.payload.zoneId),n=e.currentMapArea;n.zoneId=i.zoneId,n.name=i.name,n.displayName=i.name,n.level=i.level,n.summary=i.summary,n.dangerRating=i.danger,n.hazards=[...i.hazards],n.objectives=[...i.objectives],e.workbenchAvailable=!1,e.workbenchStatus={available:!1,note:"No workbench nearby"};const s=e.mapAreas[n.id];s&&(s.zoneId=n.zoneId,s.name=n.name,s.displayName=n.displayName,s.level=n.level,s.summary=n.summary,s.dangerRating=n.dangerRating,s.hazards=[...n.hazards],s.objectives=[...n.objectives])},updateGameTime:(e,t)=>{e.currentTime+=t.payload,e.timeOfDay=De(e.currentTime,F),e.curfewActive=Xe(e.currentTime,F),e.curfewActive?e.environment.flags.curfewLevel=e.reinforcementsScheduled?3:2:e.environment.flags.curfewLevel=0,e.environment.flags.blackoutTier!=="rolling"&&(e.environment.flags.blackoutTier=e.curfewActive?"brownout":"none")},setGameTime:(e,t)=>{e.currentTime=t.payload,e.timeOfDay=De(e.currentTime,F),e.curfewActive=Xe(e.currentTime,F),e.curfewActive?e.environment.flags.curfewLevel=e.reinforcementsScheduled?3:2:e.environment.flags.curfewLevel=0,e.environment.flags.blackoutTier!=="rolling"&&(e.environment.flags.blackoutTier=e.curfewActive?"brownout":"none")},enterCombat:e=>{if(!e.inCombat){if(e.currentMapArea.entities.enemies.filter(i=>i.health>0).length===0){se.debug("Cannot enter combat: no living enemies");return}se.debug("Entering Combat Mode"),e.inCombat=!0,e.isPlayerTurn=!0,e.turnCount=1,e.engagementMode="combat"}},exitCombat:e=>{e.inCombat&&(se.debug("Exiting Combat Mode"),e.inCombat=!1,e.isPlayerTurn=!0,e.turnCount=1,e.engagementMode="none")},setEngagementMode:(e,t)=>{e.engagementMode=t.payload},switchTurn:e=>{e.inCombat&&(e.isPlayerTurn=!e.isPlayerTurn,e.isPlayerTurn?(e.turnCount++,se.debug(`switchTurn: Starting Player Turn ${e.turnCount}`)):(se.debug(`switchTurn: Starting Enemy Turn (during Player Turn ${e.turnCount})`),se.debug("switchTurn: Resetting AP for all living enemies"),e.currentMapArea.entities.enemies.forEach((t,i)=>{t.health>0&&(e.currentMapArea.entities.enemies[i].actionPoints=t.maxActionPoints)})))},updateEnemy:(e,t)=>{const i=t.payload,n=a=>{const o=a.entities.enemies.findIndex(r=>r.id===i.id);return o===-1?!1:(i.health<=0?a.entities.enemies.splice(o,1):a.entities.enemies[o]=i,a.entities.enemies=[...a.entities.enemies],!0)};se.debug("updateEnemy reducer running",{enemyId:i.id,health:i.health});const s=n(e.currentMapArea);Object.values(e.mapAreas).forEach(a=>{const o=n(a);!s&&o&&a.id===e.currentMapArea.id&&(e.currentMapArea.entities.enemies=[...e.currentMapArea.entities.enemies])}),i.health<=0&&(se.debug(`updateEnemy: Enemy ${i.id} removed from all areas.`),e.currentMapArea.entities.enemies.filter(o=>o.health>0).length===0&&(se.debug("updateEnemy: No living enemies remain. Clearing combat state."),e.inCombat=!1,e.isPlayerTurn=!0,e.turnCount=1))},addEnemy:(e,t)=>{const i={...t.payload};let n=xi(i.position,e.currentMapArea);n||(n=cs(i.position,e.currentMapArea,void 0,[]).find(o=>e.currentMapArea.entities.enemies.every(r=>r.position.x!==o.x||r.position.y!==o.y))??i.position),i.position=n,e.currentMapArea.entities.enemies.push(i),e.currentMapArea.entities.enemies=[...e.currentMapArea.entities.enemies]},removeEnemy:(e,t)=>{const i=t.payload;e.currentMapArea.entities.enemies=e.currentMapArea.entities.enemies.filter(n=>n.id!==i),e.currentMapArea.entities.enemies=[...e.currentMapArea.entities.enemies]},updateNPC:(e,t)=>{const i=t.payload,n=e.currentMapArea.entities.npcs.findIndex(s=>s.id===i.id);n!==-1&&(e.currentMapArea.entities.npcs[n]=i,e.currentMapArea.entities.npcs=[...e.currentMapArea.entities.npcs])},addNPC:(e,t)=>{e.currentMapArea.entities.npcs.push(t.payload),e.currentMapArea.entities.npcs=[...e.currentMapArea.entities.npcs]},removeNPC:(e,t)=>{const i=t.payload;e.currentMapArea.entities.npcs=e.currentMapArea.entities.npcs.filter(n=>n.id!==i),e.currentMapArea.entities.npcs=[...e.currentMapArea.entities.npcs]},addItemToMap:(e,t)=>{var o;const{item:i,position:n}=t.payload,s=(o=e.currentMapArea.tiles[n.y])==null?void 0:o[n.x];if(!s||!s.isWalkable||s.type===E.DOOR||s.type===E.WALL||Gr(e.currentMapArea,n))return;const a={...i,position:n};e.currentMapArea.entities.items.push(a)},removeItemFromMap:(e,t)=>{const i=t.payload;e.currentMapArea.entities.items=e.currentMapArea.entities.items.filter(n=>n.id!==i)},removeItemInstanceFromMap:(e,t)=>{const{id:i,position:n,name:s}=t.payload,a=e.currentMapArea.entities.items,o=a.filter(r=>{var d,u;const l=!!(i&&r.id===i),c=!!(n&&((d=r.position)==null?void 0:d.x)===n.x&&((u=r.position)==null?void 0:u.y)===n.y&&(!s||r.name===s));return!(l||c)});o.length!==a.length&&(e.currentMapArea.entities.items=o)},applyLocaleToWorld:(e,t)=>Ms(t.payload),setGlobalAlertLevel:(e,t)=>{e.globalAlertLevel=t.payload;const i=t.payload===L.ALARMED?"high":t.payload===L.IDLE?"low":"med",n=t.payload===L.ALARMED?"rationed":t.payload===L.IDLE?"norm":"tight";e.environment.flags.gangHeat=i,e.environment.flags.supplyScarcity=n,t.payload===L.ALARMED?(e.environment.flags.blackoutTier="rolling",e.environment.flags.curfewLevel=Math.max(e.environment.flags.curfewLevel,3)):e.environment.flags.blackoutTier==="rolling"&&(e.environment.flags.blackoutTier=e.curfewActive?"brownout":"none",e.environment.flags.curfewLevel=e.curfewActive?2:0)},scheduleReinforcements:e=>{e.reinforcementsScheduled=!0,e.environment.flags.curfewLevel=3,e.globalAlertLevel===L.ALARMED&&(e.environment.flags.blackoutTier="rolling")},clearReinforcementsSchedule:e=>{e.reinforcementsScheduled=!1,e.environment.flags.curfewLevel=e.curfewActive?2:0,e.environment.flags.blackoutTier!=="rolling"&&(e.environment.flags.blackoutTier=e.curfewActive?"brownout":"none")}}}),{setEnvironmentFlags:up,applyEnvironmentWeather:hp,applyEnvironmentSignage:pp,removeEnvironmentSignage:mp,applyEnvironmentRumorSet:gp,removeEnvironmentRumorSet:fp,registerEnvironmentalNote:yp,clearEnvironmentalNotesForArea:vp,setNpcAmbientProfile:bp,setMapArea:Sp,setCurrentMapAreaZoneMetadata:wp,updateGameTime:Yr,setGameTime:$r,enterCombat:Pp,exitCombat:Mp,switchTurn:ht,updateEnemy:Zr,addEnemy:Ap,removeEnemy:xp,updateNPC:Ip,addNPC:kp,removeNPC:Cp,addItemToMap:Tp,removeItemFromMap:Ep,removeItemInstanceFromMap:Rp,applyLocaleToWorld:Xr,setGlobalAlertLevel:_p,scheduleReinforcements:Lp,clearReinforcementsSchedule:Dp,setEngagementMode:Op,setWorkbenchAvailable:Np,setWorkbenchStatus:Fp}=As.actions,xs=As.reducer,ni=e=>{const t=Et(e);return{quests:t.quests,dialogues:t.dialogues,activeDialogue:{dialogueId:null,currentNodeId:null},lastBriefing:{dialogueId:null,nodeId:null}}},Qr=ni(ve),Is=j({name:"quests",initialState:Qr,reducers:{addQuest:(e,t)=>{e.quests.push(t.payload)},updateQuest:(e,t)=>{const i=t.payload,n=e.quests.findIndex(s=>s.id===i.id);n!==-1&&(e.quests[n]=i)},startQuest:(e,t)=>{const i=t.payload,n=e.quests.find(s=>s.id===i);n&&!n.isActive&&!n.isCompleted&&(n.isActive=!0)},completeQuest:(e,t)=>{const i=t.payload,n=e.quests.find(s=>s.id===i);n&&n.isActive&&(n.isActive=!1,n.isCompleted=!0)},updateObjectiveStatus:(e,t)=>{const{questId:i,objectiveId:n,isCompleted:s}=t.payload,a=e.quests.find(o=>o.id===i);if(a){const o=a.objectives.find(r=>r.id===n);o&&(o.isCompleted=s)}},updateObjectiveCounter:(e,t)=>{const{questId:i,objectiveId:n,count:s}=t.payload,a=e.quests.find(o=>o.id===i);if(a){const o=a.objectives.find(r=>r.id===n);if(o&&(o.type==="collect"||o.type==="kill")){const r=o.count||1,l=(o.currentCount||0)+s;o.currentCount=Math.min(l,r),o.currentCount>=r&&(o.isCompleted=!0)}}},addDialogue:(e,t)=>{e.dialogues.push(t.payload)},startDialogue:(e,t)=>{const{dialogueId:i,nodeId:n}=t.payload;e.activeDialogue={dialogueId:i,currentNodeId:n},e.lastBriefing={dialogueId:i,nodeId:n}},setDialogueNode:(e,t)=>{e.activeDialogue.currentNodeId=t.payload,t.payload&&(e.lastBriefing={dialogueId:e.activeDialogue.dialogueId,nodeId:t.payload})},endDialogue:e=>{e.activeDialogue={dialogueId:null,currentNodeId:null}},resetQuests:(e,t)=>ni(t.payload??ve),applyLocaleToQuests:(e,t)=>ni(t.payload)}}),{addQuest:Bp,updateQuest:Hp,startQuest:Wp,completeQuest:qp,updateObjectiveStatus:zp,updateObjectiveCounter:Vp,addDialogue:Gp,startDialogue:Up,setDialogueNode:Kp,endDialogue:jp,resetQuests:Yp,applyLocaleToQuests:Jr}=Is.actions,el=Is.reducer,tl={id:"level0_recover_cache",resourceKey:"missions.level0.recover_cache",levelKey:"levels.slums_command_grid",kind:"primary",questKeys:["quests.market_cache"],relatedNpcKeys:["npcs.lira_smuggler"],generatedSceneKeys:["scenes.level0.recover_cache.ambush_route"]},il={id:"level0_decrypt_manifests",resourceKey:"missions.level0.decrypt_manifests",levelKey:"levels.slums_command_grid",kind:"primary",questKeys:["quests.datapad_truth"],relatedNpcKeys:["npcs.archivist_naila"]},nl={id:"level0_rebuild_courier_network",resourceKey:"missions.level0.rebuild_courier_network",levelKey:"levels.slums_command_grid",kind:"primary",questKeys:["quests.courier_network"],relatedNpcKeys:["npcs.courier_brant"]},sl={id:"level0_blackout_camera_grid",resourceKey:"missions.level0.blackout_camera_grid",levelKey:"levels.slums_command_grid",kind:"side",questKeys:["quests.equipment_sabotage"],factionTag:"resistance",relatedNpcKeys:["npcs.firebrand_juno"]},al={id:"level0_map_drone_patrols",resourceKey:"missions.level0.map_drone_patrols",levelKey:"levels.slums_command_grid",kind:"side",questKeys:["quests.drone_recon"],relatedNpcKeys:["npcs.drone_handler_kesh"]},ol={id:"level0_restock_rebel_clinic",resourceKey:"missions.level0.restock_rebel_clinic",levelKey:"levels.slums_command_grid",kind:"side",questKeys:["quests.medkit_supplies"],relatedNpcKeys:["npcs.medic_yara"]},rl={id:"level0_clear_transit_patrol",resourceKey:"missions.level0.clear_transit_patrol",levelKey:"levels.slums_command_grid",kind:"side",questKeys:["quests.combat_patrol"],relatedNpcKeys:["npcs.captain_reyna"]},ll={id:"level1_seize_governance_archives",resourceKey:"missions.level1.seize_governance_archives",levelKey:"levels.downtown_governance_ring",kind:"primary",questKeys:["quests.government_archives"],relatedNpcKeys:[]},cl={id:"level1_override_curfew_terminals",resourceKey:"missions.level1.override_curfew_terminals",levelKey:"levels.downtown_governance_ring",kind:"primary",questKeys:["quests.curfew_override"],relatedNpcKeys:[]},dl={id:"level1_extract_detained_couriers",resourceKey:"missions.level1.extract_detained_couriers",levelKey:"levels.downtown_governance_ring",kind:"primary",questKeys:["quests.prison_break"],relatedNpcKeys:[]},ul={id:"level1_hijack_camera_resync",resourceKey:"missions.level1.hijack_camera_resync",levelKey:"levels.downtown_governance_ring",kind:"side",questKeys:["quests.camera_resync"],relatedNpcKeys:[]},hl={id:"level1_divert_supply_convoys",resourceKey:"missions.level1.divert_supply_convoys",levelKey:"levels.downtown_governance_ring",kind:"side",questKeys:["quests.supply_diversion"],relatedNpcKeys:[]},pl={id:"level1_broadcast_resistance_propaganda",resourceKey:"missions.level1.broadcast_resistance_propaganda",levelKey:"levels.downtown_governance_ring",kind:"side",questKeys:["quests.plaza_broadcast"],relatedNpcKeys:[]},ml={id:"level2_stabilise_refinery_outpost",resourceKey:"missions.level2.stabilise_refinery_outpost",levelKey:"levels.industrial_wasteland",kind:"primary",questKeys:["quests.refinery_stabilization"],relatedNpcKeys:[]},gl={id:"level2_cripple_convoy_routes",resourceKey:"missions.level2.cripple_convoy_routes",levelKey:"levels.industrial_wasteland",kind:"primary",questKeys:["quests.convoy_ambush"],relatedNpcKeys:[]},fl={id:"level2_recover_filtration_core",resourceKey:"missions.level2.recover_filtration_core",levelKey:"levels.industrial_wasteland",kind:"primary",questKeys:["quests.filtration_recovery"],relatedNpcKeys:[]},yl={id:"level2_broker_scavenger_truce",resourceKey:"missions.level2.broker_scavenger_truce",levelKey:"levels.industrial_wasteland",kind:"side",questKeys:["quests.scavenger_truce"],factionTag:"scavengers",relatedNpcKeys:[]},vl={id:"level2_stabilise_power_grid",resourceKey:"missions.level2.stabilise_power_grid",levelKey:"levels.industrial_wasteland",kind:"side",questKeys:["quests.power_grid"],relatedNpcKeys:[]},bl={id:"level2_secure_evacuation_lanes",resourceKey:"missions.level2.secure_evacuation_lanes",levelKey:"levels.industrial_wasteland",kind:"side",questKeys:["quests.industrial_evac"],relatedNpcKeys:[]},Sl=[tl,il,nl,sl,al,ol,rl,ll,cl,dl,ul,hl,pl,ml,gl,fl,yl,vl,bl],wl=Sl.reduce((e,t)=>(e[t.resourceKey]=t,e),{}),Pl=e=>{const t=wl[e];if(!t)throw new Error(`Unknown mission resource key: ${e}`);return t},Ml=(e,t)=>{const i=t.missions[e.resourceKey];if(!i)throw new Error(`Missing locale entry for mission ${e.resourceKey}`);const n=e.questKeys.map(s=>{const a=wa[s];if(!a)throw new Error(`Mission ${e.resourceKey} references unknown quest key ${s}`);return a.id});return{id:e.id,label:i.label,summary:i.summary,questIds:n,kind:e.kind,recommendedLevel:e.recommendedLevel,factionTag:e.factionTag}},Al=(e,t)=>{const i=t.levels[e.resourceKey],n=e.missionKeys.map(Pl).map(s=>Ml(s,t));return{level:e.order,levelId:e.id,name:(i==null?void 0:i.name)??e.id,zoneId:e.zoneKey,objectives:n}},xl=e=>{const t=Pa(e);return Sa.map(i=>Al(i,t))},Il=e=>xl(e).map(i=>({level:i.level,levelId:i.levelId,name:i.name,zoneId:i.zoneId,objectives:i.objectives.map(n=>({...n,questIds:[...n.questIds]}))})),si=(e=ve)=>({levels:Il(e),currentLevelIndex:0,pendingAdvance:!1,celebrationAcknowledged:!1,lastMissionCompletedAt:null}),kl=si(ve),ks=j({name:"missions",initialState:kl,reducers:{missionAccomplished(e){e.pendingAdvance||(e.pendingAdvance=!0,e.celebrationAcknowledged=!1,e.lastMissionCompletedAt=Date.now())},acknowledgeMissionAccomplished(e){e.celebrationAcknowledged=!0},deferMissionAdvance(e){e.celebrationAcknowledged=!0},showMissionAdvancePrompt(e){e.pendingAdvance&&(e.celebrationAcknowledged=!1)},advanceToNextLevel(e){e.currentLevelIndex<e.levels.length-1&&(e.currentLevelIndex+=1),e.pendingAdvance=!1,e.celebrationAcknowledged=!1},resetMissions:(e,t)=>si(t.payload??ve),applyLocaleToMissions:(e,t)=>si(t.payload)}}),{missionAccomplished:$p,acknowledgeMissionAccomplished:Zp,deferMissionAdvance:Xp,showMissionAdvancePrompt:Qp,advanceToNextLevel:Jp,resetMissions:em,applyLocaleToMissions:Cl}=ks.actions,Tl=ks.reducer,El={messages:[]},Cs=j({name:"log",initialState:El,reducers:{addLogMessage(e,t){const n=[...e.messages,t.payload];n.length>50&&n.shift(),e.messages=n,console.log(`[Log] ${t.payload}`)},clearLog(e){e.messages=[]}},extraReducers:e=>{e.addCase($r,(t,i)=>{Xe(i.payload,F)&&t.messages.length===0&&(t.messages=["Searchlights pin you in the open—duck inside before the patrols lock on."])})}}),{addLogMessage:me,clearLog:tm}=Cs.actions,Rl=Cs.reducer,Gt=e=>e,ai={balanced:Gt({id:"balanced",label:"Balanced",description:"Evaluates offence and defence evenly. Prioritises clear shots, keeps moderate AP reserve, and falls back to cover if health dips.",weights:{attackBias:1,focusLowestHealth:.75,focusOverwatchThreat:.85,maintainCover:.8,pursuitAggression:.65,consumableAggression:.5,retreatBias:.6},thresholds:{panicHealthFraction:.35,apReserve:1,minimumConsumableCharges:1}}),aggressive:Gt({id:"aggressive",label:"Aggressive",description:"Closes distance, spends AP rapidly, and consumes resources to finish priority targets. Retreats only when near death.",weights:{attackBias:1.35,focusLowestHealth:1.1,focusOverwatchThreat:.7,maintainCover:.35,pursuitAggression:1.2,consumableAggression:1,retreatBias:.2},thresholds:{panicHealthFraction:.2,apReserve:0,minimumConsumableCharges:0}}),defensive:Gt({id:"defensive",label:"Defensive",description:"Holds positions with strong cover, conserves consumables, and only advances when safe. Will disengage early if health drops.",weights:{attackBias:.6,focusLowestHealth:.55,focusOverwatchThreat:1.25,maintainCover:1.6,pursuitAggression:.3,consumableAggression:.25,retreatBias:1.4},thresholds:{panicHealthFraction:.5,apReserve:2,minimumConsumableCharges:2}})},_l="balanced",im=Object.keys(ai),gn=e=>ai[e]??ai.balanced,Ll={locale:ve,testMode:!1,autoBattleEnabled:!1,autoBattleProfile:_l,visualQualityPreset:"balanced",lightsEnabled:!1,autoStealthEnabled:!1,reputationSystemsEnabled:!1},Ts=j({name:"settings",initialState:Ll,reducers:{setLocale:(e,t)=>{e.locale=t.payload},setTestMode:(e,t)=>{e.testMode=t.payload},setAutoBattleEnabled:(e,t)=>{e.autoBattleEnabled=t.payload},setAutoBattleProfile:(e,t)=>{e.autoBattleProfile=t.payload},setVisualQualityPreset:(e,t)=>{e.visualQualityPreset=t.payload},setLightsEnabled:(e,t)=>{e.lightsEnabled=t.payload},setAutoStealthEnabled:(e,t)=>{e.autoStealthEnabled=t.payload},setReputationSystemsEnabled:(e,t)=>{e.reputationSystemsEnabled=t.payload}}}),{setLocale:nm,setTestMode:sm,setAutoBattleEnabled:am,setAutoBattleProfile:om,setVisualQualityPreset:rm,setLightsEnabled:fn,setAutoStealthEnabled:lm,setReputationSystemsEnabled:cm}=Ts.actions,Es=Ts.reducer,Dl={floatingNumbers:[],hitFlashes:[],activeFlashId:null},Rs=j({name:"combatFeedback",initialState:Dl,reducers:{addFloatingNumber:(e,t)=>{e.floatingNumbers.push(t.payload)},removeFloatingNumber:(e,t)=>{e.floatingNumbers=e.floatingNumbers.filter(i=>i.id!==t.payload)},triggerHitFlash:(e,t)=>{e.activeFlashId=t.payload.id,e.hitFlashes.push(t.payload)},clearHitFlash:e=>{e.activeFlashId=null,e.hitFlashes=[]},clearAllFeedback:e=>{e.floatingNumbers=[],e.hitFlashes=[],e.activeFlashId=null}}}),{addFloatingNumber:Ol,removeFloatingNumber:dm,triggerHitFlash:um,clearHitFlash:hm,clearAllFeedback:pm}=Rs.actions,Nl=Rs.reducer,Fl=()=>({overlayEnabled:!0,camerasNearby:0,detectionProgress:0,activeCameraId:null,alertState:J.IDLE,networkAlertActive:!1,networkAlertExpiresAt:null}),yn={zones:{},hud:Fl(),curfewBanner:{visible:!1,lastActivatedAt:null}},_s=j({name:"surveillance",initialState:yn,reducers:{registerZoneCameras:(e,t)=>{const{areaId:i,zoneId:n,cameras:s,timestamp:a}=t.payload,o=s.reduce((r,l)=>(r[l.id]={...l},r),{});e.zones[i]={areaId:i,zoneId:n,cameras:o,networkAlert:null,lastUpdatedAt:a}},updateCameraState:(e,t)=>{const{areaId:i,cameraId:n,changes:s,timestamp:a}=t.payload,o=e.zones[i];if(!o)return;const r=o.cameras[n];r&&(o.cameras[n]={...r,...s},o.lastUpdatedAt=a)},setCameraNetworkAlert:(e,t)=>{const{areaId:i,alert:n}=t.payload,s=e.zones[i];s&&(s.networkAlert=n?{...n}:null)},updateHudState:(e,t)=>{const i=t.payload;e.hud={...e.hud,...i},typeof i.networkAlertActive=="boolean"&&!i.networkAlertActive&&(e.hud.networkAlertExpiresAt=null),typeof i.networkAlertExpiresAt=="number"&&(e.hud.networkAlertActive=!0)},setOverlayEnabled:(e,t)=>{e.hud.overlayEnabled=t.payload.enabled},setCurfewBanner:(e,t)=>{e.curfewBanner.visible=t.payload.visible,t.payload.visible&&(e.curfewBanner.lastActivatedAt=t.payload.timestamp)},clearZoneCameras:(e,t)=>{const{areaId:i}=t.payload;delete e.zones[i]},resetSurveillanceState:()=>yn}}),{registerZoneCameras:mm,updateCameraState:gm,setCameraNetworkAlert:fm,updateHudState:ym,setOverlayEnabled:vm,setCurfewBanner:bm,clearZoneCameras:Sm,resetSurveillanceState:wm}=_s.actions,Ls=_s.reducer,Bl=[{id:"npc_lira_vendor",name:"Lira the Smuggler",kind:"contact",tags:["resistance","strategist","ally","bonded","quartermaster"],traits:["resistance","strategist","bonded"],factionId:"resistance",relationship:"bonded"},{id:"npc_archivist_naila",name:"Archivist Naila",kind:"contact",tags:["resistance","scholar","ally"],traits:["scholar","resistance"],factionId:"resistance",relationship:"ally"},{id:"npc_courier_brant",name:"Courier Brant",kind:"contact",tags:["resistance","runner","ally"],traits:["runner","ally"],factionId:"resistance",relationship:"ally"},{id:"npc_firebrand_juno",name:"Firebrand Juno",kind:"contact",tags:["resistance","agitator","ally","witness"],traits:["agitator"],factionId:"resistance",relationship:"ally"},{id:"npc_seraph_warden",name:"Seraph Warden",kind:"contact",tags:["corpsec","warden","rival"],traits:["corpsec","rival"],factionId:"corpsec",relationship:"rival"},{id:"npc_drone_handler_kesh",name:"Drone Handler Kesh",kind:"contact",tags:["resistance","tech","ally"],traits:["technician"],factionId:"resistance",relationship:"ally"}],Hl={npc_lira_vendor:{tags:["resistance","ally","quartermaster","bonded"],traits:["strategist","bonded"],relationship:"bonded",factionId:"resistance"},npc_archivist_naila:{tags:["resistance","ally","scholar"],traits:["scholar"],relationship:"ally",factionId:"resistance"},npc_courier_brant:{tags:["resistance","ally","runner"],traits:["runner"],relationship:"ally",factionId:"resistance"},npc_firebrand_juno:{tags:["resistance","ally","agitator"],traits:["agitator"],relationship:"ally",factionId:"resistance"},npc_seraph_warden:{tags:["corpsec","rival","warden"],traits:["corpsec","rival"],relationship:"rival",factionId:"corpsec"},npc_drone_handler_kesh:{tags:["resistance","ally","tech"],traits:["technician"],relationship:"ally",factionId:"resistance"},npc_medic_yara:{tags:["resistance","ally","medic"],traits:["medic"],relationship:"ally",factionId:"resistance"},npc_captain_reyna:{tags:["resistance","ally","commander"],traits:["commander"],relationship:"ally",factionId:"resistance"}},oi=(e,t)=>{e.has(t.id)||e.set(t.id,{...t,tags:[...t.tags],traits:[...t.traits]})},Wl=(e,t,i)=>{const n=e.get(t.id);if(!n){oi(e,t);return}n.tags=Array.from(new Set([...n.tags,...t.tags])),n.traits=Array.from(new Set([...n.traits,...t.traits]))},ql=({player:e,npcs:t})=>{var a;const i=new Map;Bl.forEach(o=>oi(i,o));const n=e.maxHealth>0?e.maxHealth*.65:e.maxHealth,s={id:e.id,name:e.name||"Operative",kind:"player",tags:["player","operative","ally"],traits:[((a=e.personality)==null?void 0:a.alignment)??"earnest"],factionId:"resistance",wounded:e.health<n,relationship:"ally",backgroundId:e.backgroundId};return e.backgroundId&&s.tags.push(e.backgroundId),e.perks.length>0&&s.tags.push("perked"),oi(i,s),t.forEach(o=>{const r=o.dialogueId??o.id;if(!r)return;const l={id:r,name:o.name,kind:o.isInteractive?"contact":"npc",tags:["npc",o.isInteractive?"ally":"witness"],traits:[],wounded:o.health<o.maxHealth,relationship:o.isInteractive?"ally":"witness"},c=Hl[r];c&&(l.tags.push(...c.tags),c.traits&&l.traits.push(...c.traits),c.relationship&&(l.relationship=c.relationship),c.factionId&&(l.factionId=c.factionId)),Wl(i,l)}),Array.from(i.values())},vn=(e,t,i)=>{var s;if(t.requiredTags&&!t.requiredTags.every(a=>i.tags.includes(a))||t.forbiddenTags&&t.forbiddenTags.some(a=>i.tags.includes(a))||t.requiredTraits&&!t.requiredTraits.every(a=>i.traits.includes(a))||t.forbiddenTraits&&t.forbiddenTraits.some(a=>i.traits.includes(a))||i.wounded&&t.allowWounded===!1)return null;let n=1;return t.preferredTags&&t.preferredTags.forEach(a=>{i.tags.includes(a)&&(n+=2)}),t.requiredTraits&&(n+=t.requiredTraits.length),i.relationship&&((s=t.preferredTags)!=null&&s.includes(i.relationship))&&(n+=1.5),i.kind==="player"&&e!=="protagonist"&&(n-=.25),n},zl=(e,t)=>{const i=[...t],n={},s=new Set;let a=0;const o=t.find(r=>r.kind==="player");for(const r of e.roles){let l=null;for(const c of i){if(c.kind!=="player"&&s.has(c.id))continue;const d=vn(r.id,r,c);d!=null&&(!l||d>l.score)&&(l={roleId:r.id,actor:c,score:d})}if(!l&&r.fallbackToPlayer&&o){const c=vn(r.id,r,o);c!=null&&(l={roleId:r.id,actor:o,score:Math.max(.5,c)})}if(!l)return null;n[r.id]=l.actor,a+=l.score,l.actor.kind!=="player"&&s.add(l.actor.id)}return{resolvedRoles:n,totalScore:a}},Vl=(e,t,i)=>!e.conditions||e.conditions.length===0?!0:e.conditions.every(n=>{var s;switch(n.type){case"roleTrait":{const a=t[n.roleId];return a?a.traits.includes(n.trait):!1}case"roleTag":{const a=t[n.roleId];return a?a.tags.includes(n.tag):!1}case"roleRelationship":{const a=t[n.roleId];return a?a.relationship===n.relationship:!1}case"roleStatus":{const a=t[n.roleId];return n.status==="wounded"?!!(a!=null&&a.wounded):!1}case"contextTag":return!!((s=i.tags)!=null&&s.includes(n.tag));case"contextArc":return i.arc===n.arc;default:return!1}}),Gl=(e,t,i)=>{let n=null,s=-1/0;for(const a of e.branches){if(!Vl(a,t,i))continue;const o=a.weight??1;(!n||o>s)&&(n=a,s=o)}return n??e.branches[0]??null},Ul=(e,t)=>e.triggers.some(i=>{if(i.type!==t.type)return!1;if(i.tags&&i.tags.length>0){const n=t.tags??[];return i.tags.every(s=>n.includes(s))}return!0}),Kl=(e,t,i,n)=>{const s=e.entries[t.id];return!!(s!=null&&s.cooldownExpiresAt&&s.cooldownExpiresAt>n||t.cooldown.perLocation&&i&&e.lastSeenByLocation[i]===t.id&&s!=null&&s.cooldownExpiresAt&&s.cooldownExpiresAt>n)},jl=({plays:e,runtime:t,trigger:i,actorPool:n,now:s,locationId:a})=>{let o=null,r=-1/0;for(const l of e){if(l.arc!==i.arc||!Ul(l,i)||Kl(t,l,a,s))continue;const c=zl(l,n);if(!c)continue;const d=Gl(l,c.resolvedRoles,i);if(!d)continue;const u=t.entries[l.id];let h=(l.weight??1)+c.totalScore+(d.weight??1);u&&(h-=u.timesTriggered*.75),h>r&&(r=h,o={storyletId:l.id,play:l,branch:d,outcome:d.outcome,resolvedRoles:c.resolvedRoles,context:i,timestamp:s,cooldownExpiresAt:s+l.cooldown.durationMs})}return o},Yl=e=>e<=0?"act1_setup":e===1?"act2_escalation":"act3_finale",Ds=[{id:"firelight_ambush",arc:"act1_setup",titleKey:"storylets.firelight_ambush.title",synopsisKey:"storylets.firelight_ambush.synopsis",tags:["ambush","resistance","omen"],triggers:[{type:"missionCompletion",tags:["resistance"],intensity:"medium"}],roles:[{id:"protagonist",titleKey:"storylets.roles.protagonist",preferredTags:["operative","player"],fallbackToPlayer:!0,allowWounded:!0},{id:"mentor",titleKey:"storylets.roles.mentor",requiredTags:["resistance"],preferredTags:["strategist","quartermaster"]},{id:"witness",titleKey:"storylets.roles.witness",preferredTags:["civilian","witness"],allowWounded:!1,fallbackToPlayer:!0}],branches:[{id:"scarred_victory",weight:2,conditions:[{type:"roleStatus",roleId:"protagonist",status:"wounded"}],outcome:{id:"scarred_victory",localizationKey:"storylets.firelight_ambush.outcomes.scarred_victory",variantKey:"wounded",effects:[{type:"faction",factionId:"resistance",delta:8,reason:"storylet:firelight_ambush"},{type:"log",logKey:"storylets.firelight_ambush.log.wounded",severity:"info"}],tags:["injury","loyalty"]}},{id:"clean_sweep",outcome:{id:"clean_sweep",localizationKey:"storylets.firelight_ambush.outcomes.clean_sweep",effects:[{type:"faction",factionId:"resistance",delta:5,reason:"storylet:firelight_ambush"},{type:"log",logKey:"storylets.firelight_ambush.log.clean",severity:"info"}],tags:["loyalty"]}}],cooldown:{durationMs:1e3*60*20,perLocation:!0},weight:3},{id:"neon_bivouac",arc:"act2_escalation",titleKey:"storylets.neon_bivouac.title",synopsisKey:"storylets.neon_bivouac.synopsis",tags:["relationship","rest","memory"],triggers:[{type:"campfireRest",tags:["rest"],intensity:"low"}],roles:[{id:"protagonist",titleKey:"storylets.roles.protagonist",preferredTags:["operative","player"],fallbackToPlayer:!0,allowWounded:!0},{id:"confidant",titleKey:"storylets.roles.confidant",requiredTags:["ally"],preferredTags:["bonded","scholar","strategist"],allowWounded:!0}],branches:[{id:"bond_renewed",weight:3,conditions:[{type:"roleRelationship",roleId:"confidant",relationship:"bonded"}],outcome:{id:"bond_renewed",localizationKey:"storylets.neon_bivouac.outcomes.bond_renewed",variantKey:"bonded",effects:[{type:"log",logKey:"storylets.neon_bivouac.log.bonded",severity:"info"},{type:"traitDelta",target:"player",trait:"earnest",delta:1}],tags:["relationship","loyalty"]}},{id:"quiet_distance",outcome:{id:"quiet_distance",localizationKey:"storylets.neon_bivouac.outcomes.quiet_distance",effects:[{type:"log",logKey:"storylets.neon_bivouac.log.distance",severity:"info"}],tags:["memory"]}}],cooldown:{durationMs:1e3*60*30,perLocation:!0},weight:2},{id:"serrated_omen",arc:"act3_finale",titleKey:"storylets.serrated_omen.title",synopsisKey:"storylets.serrated_omen.synopsis",tags:["ambush","corpsec","injury","omen"],triggers:[{type:"patrolAmbush",tags:["corpsec","ambush"],intensity:"high"}],roles:[{id:"protagonist",titleKey:"storylets.roles.protagonist",preferredTags:["operative","player"],fallbackToPlayer:!0,allowWounded:!0},{id:"rival",titleKey:"storylets.roles.rival",requiredTags:["corpsec"],preferredTags:["rival","warden"],allowWounded:!0},{id:"witness",titleKey:"storylets.roles.witness",preferredTags:["resistance","ally"],allowWounded:!0,fallbackToPlayer:!1}],branches:[{id:"rivalry_ignites",weight:2,conditions:[{type:"roleRelationship",roleId:"rival",relationship:"rival"}],outcome:{id:"rivalry_ignites",localizationKey:"storylets.serrated_omen.outcomes.rivalry_ignites",variantKey:"rival",effects:[{type:"faction",factionId:"corpsec",delta:-10,reason:"storylet:serrated_omen"},{type:"playerHealth",delta:-4,allowKO:!1},{type:"log",logKey:"storylets.serrated_omen.log.rival",severity:"warning"}],tags:["injury","corpsec"]}},{id:"shadows_scatter",outcome:{id:"shadows_scatter",localizationKey:"storylets.serrated_omen.outcomes.shadows_scatter",effects:[{type:"log",logKey:"storylets.serrated_omen.log.default",severity:"info"}],tags:["ambush"]}}],cooldown:{durationMs:1e3*60*25,perLocation:!0},weight:3}];Ds.reduce((e,t)=>(e[t.id]=t,e),{});const $l=()=>Ds,Os={roles:{protagonist:"Operative",mentor:"Mentor",witness:"Witness",confidant:"Confidant",rival:"Rival"},plays:{firelight_ambush:{title:"Firelight Ambush",synopsis:"After the crates are reclaimed, the cell huddles around a burn barrel to measure the cost of provoking CorpSec patrols.",roles:{protagonist:"Operative",mentor:"Quartermaster",witness:"Runner"},outcomes:{scarred_victory:{base:{narrative:"{mentor} studies the bandaged gouge across {protagonist}’s ribs. “You took the hit so the crates could run. That balance clears.”",logLine:"Lira marks your scars as the price of keeping the supply line alive."},variants:{wounded:{narrative:"{mentor} catches {protagonist} before they slide to the bricks. She seals the fresh wound, the firelight flickering across the stimulant foam. “Next patrol never makes it to the siren,” she vows, voice steady for {witness}’s sake.",logLine:"Lira steadies you, promising the next patrol will never raise an alarm."}}},clean_sweep:{base:{narrative:"The burn barrel sends sparks up past the transit rails. {protagonist} tips confiscated batons into the fire while {mentor} and {witness} sketch new blind spots across a soot-streaked map.",logLine:"The cell celebrates the clean strike and notebooks fill with new patrol gaps."}}}},neon_bivouac:{title:"Neon Bivouac",synopsis:"The crew slumps beneath a humming holo-ad, sharing contraband rations while the grid cools. Stories trade faster than the battered thermos.",roles:{protagonist:"Operative",confidant:"Confidant"},outcomes:{bond_renewed:{base:{narrative:"{confidant} nudges a tin mug into {protagonist}’s hands. “Remember the rooftops in District Eight?” The laugh that follows is low and unguarded, the neon glow framing two conspirators instead of soldiers.",logLine:"{confidant} shares an old war story and the bivouac feels like home again."},variants:{bonded:{narrative:"{confidant} leans shoulder to shoulder with {protagonist}, the steam from the thermos curling between matching scars. “When we ran the Gridfall evac we swore never to sleep alone on watch again. Still true.”",logLine:"{confidant} reaffirms the pact forged during Gridfall and your bond deepens."}}},quiet_distance:{base:{narrative:"The neon hum fills the silence between {protagonist} and {confidant}. They trade reports instead of memories, each syllable an inventory count that never strays into feeling.",logLine:"Camp chatter stays clipped—nerves too raw for stories tonight."}}}},serrated_omen:{title:"Serrated Omen",synopsis:"A CorpSec counter-sweep slams into the team on their way back through the alleys. The clash leaves a metallic stink and unanswered questions.",roles:{protagonist:"Operative",rival:"Adversary",witness:"Witness"},outcomes:{rivalry_ignites:{base:{narrative:"{rival}’s monofilament blade sparks off the barricade, carving a groove through {protagonist}’s armor. “I told you the curfew rites were mine to enforce,” she hisses, visor fractured yet unyielding.",logLine:"Seraph Warden carves a warning across your armor and vows the next hunt will finish it."},variants:{rival:{narrative:"{rival} vents ozone from her pauldrons, the mask reflecting {protagonist}’s blood. “You survived my ambush twice. Next time I bring witnesses.” {witness} pulls you back before the second strike lands.",logLine:"Seraph Warden leaves you bleeding but breathing—her promise of a final duel hangs heavy."}}},shadows_scatter:{base:{narrative:"Sirens bloom and the alleys dissolve into darkness. {protagonist} fires blind, smoke swallowing {rival} while {witness} drags the wounded out before drones arrive.",logLine:"You slip the net, but CorpSec frequencies crackle with renewed suspicion."}}}}},logs:{"storylets.firelight_ambush.log.wounded":"Lira steadies you, promising the next patrol will never raise an alarm.","storylets.firelight_ambush.log.clean":"The cell celebrates the clean strike and notebooks fill with new patrol gaps.","storylets.neon_bivouac.log.bonded":"Sharing Gridfall memories, your confidant reminds you why the fire still burns.","storylets.neon_bivouac.log.distance":"Camp chatter stays clipped—nerves too raw for stories tonight.","storylets.serrated_omen.log.rival":"Seraph Warden leaves you bleeding but breathing—her promise of a final duel hangs heavy.","storylets.serrated_omen.log.default":"You lose her in the smoke, but CorpSec channels crackle with orders to tighten the cordon."}},Zl={roles:{protagonist:"Оперативник",mentor:"Кураторка",witness:"Свідок",confidant:"Довірена особа",rival:"Суперниця"},plays:{firelight_ambush:{title:"Засідка у вогнях",synopsis:"Після повернення контрабандних ящиків осередок гріється біля бочки й рахує ціну, яку доведеться платити за розлючені патрулі CorpSec.",roles:{protagonist:"Оперативник",mentor:"Квартирмейстерка",witness:"Розвідник"},outcomes:{scarred_victory:{base:{narrative:"{mentor} розглядає перев’язаний поріз на ребрах {protagonist}. «Ти прийняв удар, щоб вантаж дійшов. Рахунок закрито».",logLine:"Ліра фіксує шрам як обов’язкову плату за живу лінію постачання."},variants:{wounded:{narrative:"{mentor} підхоплює {protagonist}, поки той не впав на бруківку. Вона заливає свіже поранення піною, іскри від вогню тремтять у її очах. «Наступний патруль не доживе до сирени», — кидає вона, щоб заспокоїти {witness}.",logLine:"Ліра підтримує тебе й клянеться, що наступний патруль навіть не встигне подати тривогу."}}},clean_sweep:{base:{narrative:"Жар від бочки освітлює спорядження. {protagonist} кидає конфісковані кийки у вогонь, поки {mentor} та {witness} малюють нові «сліпі зони» на закіптюженій мапі.",logLine:"Осередок святкує чисту операцію й занотовує нові прогалини у патрулях."}}}},neon_bivouac:{title:"Неоновий бівак",synopsis:"Команда притискається під гудінням голографічної реклами, ділячись пайками та історіями, поки мережа остигає.",roles:{protagonist:"Оперативник",confidant:"Довірена особа"},outcomes:{bond_renewed:{base:{narrative:"{confidant} підсовує {protagonist} розігрітий кухоль. «Пам’ятаєш дахи у Восьмому секторі?» Сміх глухий і теплий, неонове сяйво робить із них двох змовників, а не солдатів.",logLine:"{confidant} ділиться старою історією, і бівак знову відчувається домом."},variants:{bonded:{narrative:"{confidant} торкається плечем до плеча {protagonist}, пара від термоса обвішує їхні парні шрами. «На евакуації Gridfall ми поклялися не стояти на варті на самоті. Обіцянка діє», — шепоче вона.",logLine:"{confidant} нагадує про клятву часів Gridfall, і ваш зв’язок міцнішає."}}},quiet_distance:{base:{narrative:"Неонове гудіння заповнює паузу між {protagonist} та {confidant}. Вони обмінюються лише рапортами, кожне слово — це інвентаризація без жодної емоції.",logLine:"Розмови біля вогню уривчасті — нерви надто натягнуті для спогадів."}}}},serrated_omen:{title:"Зазубрений знак",synopsis:"Контр-рейд CorpSec накриває групу у провулках. Металевий присмак зависає в повітрі, залишаючи запитання без відповіді.",roles:{protagonist:"Оперативник",rival:"Суперниця",witness:"Свідок"},outcomes:{rivalry_ignites:{base:{narrative:"Лезо {rival} креслить іскри по барикаді, розрізаючи броню {protagonist}. «Комендантська година — моя прерогатива», — шипить вона крізь тріснутий візор.",logLine:"Сераф-варден залишає поріз на твоїй броні й обіцяє, що наступне полювання буде останнім."},variants:{rival:{narrative:"{rival} випускає озон із наплічників, маска віддзеркалює кров {protagonist}. «Двічі ти вислизнув. Наступного разу я приведу свідків». {witness} шарпає тебе назад, перш ніж вона наносить другий удар.",logLine:"Сераф-варден залишає тебе пораненим, але живим — і призначає фінальний двобій."}}},shadows_scatter:{base:{narrative:"Сирени розквітають, провулки ковтає дим. {protagonist} стріляє навмання, {rival} губиться в тіні, поки {witness} витягує поранених до прибуття дронів.",logLine:"Вам вдається вислизнути, але частоти CorpSec гудуть новими наказами посилити патрулі."}}}}},logs:{"storylets.firelight_ambush.log.wounded":"Ліра підтримує тебе й клянеться, що наступний патруль не встигне підняти тривогу.","storylets.firelight_ambush.log.clean":"Осередок святкує чисту операцію й занотовує нові прогалини у патрулях.","storylets.neon_bivouac.log.bonded":"Довірена особа ділиться спогадами Gridfall, і вогник знову обіцяє тепло.","storylets.neon_bivouac.log.distance":"Розмови біля вогню уривчасті — нерви надто натягнуті для спогадів.","storylets.serrated_omen.log.rival":"Сераф-варден залишає тебе пораненим, але живим, і призначає фінальний двобій.","storylets.serrated_omen.log.default":"Вам вдається вислизнути, але частоти CorpSec гудуть новими наказами посилити патрулі."}},Xl={en:Os,uk:Zl},Ns=e=>Xl[e]??Os,bt=(e,t)=>e.replace(/\{([\w\d_]+)\}/g,(i,n)=>t[n]??`{${n}}`),Ql=(e,t)=>!t||!e.variants?e.base:e.variants[t]??e.base,bn={entries:{},lastSeenByLocation:{},queue:[]},Fs=j({name:"storylets",initialState:bn,reducers:{enqueueStorylet(e,t){const{resolution:i,queueItem:n,locationId:s}=t.payload,a=e.entries[i.storyletId]??{storyletId:i.storyletId,lastTriggeredAt:null,cooldownExpiresAt:null,timesTriggered:0};a.lastTriggeredAt=i.timestamp,a.cooldownExpiresAt=i.cooldownExpiresAt,a.timesTriggered+=1,e.entries[i.storyletId]=a,s&&(e.lastSeenByLocation[s]=i.storyletId),e.queue.push(n)},dequeueStorylet(e,t){const i=t.payload;if(!i){e.queue.shift();return}e.queue=e.queue.filter(n=>n.id!==i)},clearStorylets:()=>bn}}),{enqueueStorylet:Jl,dequeueStorylet:Pm,clearStorylets:Mm}=Fs.actions,ec=Fs.reducer,tc=(e,t,i)=>{var r;const n=Yl(t.missions.currentLevelIndex),s=e.locationId??((r=t.world.currentMapArea)==null?void 0:r.id),a=new Set(e.tags??[]);e.type==="patrolAmbush"&&a.add("ambush"),e.type==="campfireRest"&&(a.add("rest"),a.add("relationship"));const o=t.player.data;return o.maxHealth>0&&o.health<o.maxHealth*.7&&a.add("injury"),{type:e.type,arc:n,timestamp:i,locationId:s,missionId:e.missionId,tags:Array.from(a)}},ic=e=>({entries:{...e.entries},lastSeenByLocation:{...e.lastSeenByLocation}}),nc=(e,t)=>{const n=Ns(t).plays[e.storyletId],s={},a={};Object.entries(e.resolvedRoles).forEach(([u,h])=>{s[u]=h.name,a[u]={id:h.id,name:h.name,relationship:h.relationship}});const o=n==null?void 0:n.outcomes[e.branch.id],r=o?Ql(o,e.outcome.variantKey):void 0,l=r?bt(r.narrative,s):"",c=r!=null&&r.epilogue?bt(r.epilogue,s):void 0,d=r!=null&&r.logLine?bt(r.logLine,s):void 0;return{id:Q(),storyletId:e.storyletId,branchId:e.branch.id,title:(n==null?void 0:n.title)??e.play.id,synopsis:(n==null?void 0:n.synopsis)??"",narrative:l,epilogue:c,logLine:d,resolvedRoles:a,triggeredAt:e.timestamp,locale:t,outcomeLocalizationKey:e.outcome.localizationKey,variantKey:e.outcome.variantKey}},sc=(e,t,i,n)=>{const s=Ns(t),a={};Object.entries(e.resolvedRoles).forEach(([o,r])=>{a[o]=r.name}),e.outcome.effects.forEach(o=>{switch(o.type){case"log":{const r=s.logs[o.logKey]??e.play.titleKey??o.logKey,l=bt(r,a);i(me(l));break}case"faction":{if(!n)break;i(ar({factionId:o.factionId,delta:o.delta,reason:o.reason??"storylet",source:e.storyletId}));break}case"playerHealth":{i(sr(o.delta));break}case"traitDelta":{o.target==="player"&&i(or({trait:o.trait,delta:o.delta,source:e.storyletId}));break}}})},Am=e=>(t,i)=>{var h;const n=i(),s=Date.now(),a=((h=n.settings)==null?void 0:h.locale)??ve,o=tc(e,n,s),r=ic(n.storylets),l=$l(),c=ql({player:n.player.data,npcs:n.world.currentMapArea.entities.npcs}),d=jl({plays:l,runtime:r,trigger:o,actorPool:c,now:s,locationId:o.locationId});if(!d)return;sc(d,a,t,!!n.settings.reputationSystemsEnabled);const u=nc(d,a);t(Jl({resolution:d,queueItem:u,locationId:o.locationId}))},ri=(e,t,i)=>!Number.isFinite(e)||e<t?t:e>i?i:e,xm=e=>{if(!Number.isFinite(e))return 0;const t=e%360;return t<0?t+360:t},Im=(e,t)=>!Number.isFinite(e)||!Number.isFinite(t)?0:(t-e+540)%360-180,km=(e,t,i)=>!Number.isFinite(e)||!Number.isFinite(t)||!Number.isFinite(i)?e:e+(t-e)*i,Cm=e=>Number.isFinite(e)?e*(180/Math.PI):0,Bs=(e,t,i)=>`${e}:${t}:${i}`,he=e=>ri(e,0,1),Hs=e=>{const{baseCertainty:t,distanceModifier:i,lightingModifier:n,disguiseModifier:s,postureModifier:a}=e,o=t*he(i)*he(n)*he(s)*he(a);return he(o)},ac=(e,t)=>{var n;const i=Hs(e);return{id:Bs(e.witnessId,e.targetId,e.recognitionChannel),witnessId:e.witnessId,witnessLabel:e.witnessLabel??e.witnessId,targetId:e.targetId,zoneId:e.zoneId,areaId:e.areaId,source:e.source,recognitionChannel:e.recognitionChannel,certainty:i,halfLifeSeconds:t.halfLifeSeconds,firstSeenAt:e.timestamp,lastSeenAt:e.timestamp,reinforcedAt:void 0,reported:e.reported??!1,suppressed:((n=e.existing)==null?void 0:n.suppressed)??!1,proximityWeight:he(e.distanceModifier),location:e.location}},oc=(e,t,i)=>{var o;const n=Hs(t),s=n*i.reinforcementBonus,a=he(Math.max(e.certainty,n)+s);return{...e,witnessLabel:t.witnessLabel??e.witnessLabel??e.witnessId,certainty:a,lastSeenAt:t.timestamp,reinforcedAt:t.timestamp,reported:e.reported||t.reported,suppressed:((o=t.existing)==null?void 0:o.suppressed)??e.suppressed,proximityWeight:he(Math.max(e.proximityWeight,t.distanceModifier)),location:t.location??e.location}},rc=(e,t,i)=>{if(t<=0||e.certainty<=0)return{memory:{...e},pruned:e.certainty<i.certaintyFloor};const n=e.halfLifeSeconds>0?e.halfLifeSeconds:i.halfLifeSeconds,s=t/n,a=Math.pow(.5,s);let o=he(e.certainty*a);e.suppressed&&(o*=i.suppressionPenalty);const r=o<i.certaintyFloor;return{memory:{...e,certainty:o},pruned:r}},Sn=e=>({id:e.id,witnessId:e.witnessId,witnessLabel:e.witnessLabel,targetId:e.targetId,zoneId:e.zoneId,areaId:e.areaId,source:e.source,recognitionChannel:e.recognitionChannel,certainty:e.certainty,halfLifeSeconds:e.halfLifeSeconds,firstSeenAt:e.firstSeenAt,lastSeenAt:e.lastSeenAt,reinforcedAt:e.reinforcedAt,reported:e.reported,suppressed:e.suppressed,proximityWeight:e.proximityWeight}),li=e=>({id:e.id,witnessId:e.witnessId,witnessLabel:e.witnessLabel,targetId:e.targetId,zoneId:e.zoneId,areaId:e.areaId,source:e.source,recognitionChannel:e.recognitionChannel,certainty:e.certainty,halfLifeSeconds:e.halfLifeSeconds,firstSeenAt:e.firstSeenAt,lastSeenAt:e.lastSeenAt,reinforcedAt:e.reinforcedAt,reported:e.reported,suppressed:e.suppressed,proximityWeight:e.proximityWeight}),lc=(e,t)=>{const i=Math.pow(ri(e.proximityWeight,0,1),t.proximityExponent),n=e.reported?t.reportMultiplier:1;return ri(e.certainty*i*n,0,1.5)},cc=(e,t)=>e>=t.tierThresholds.crackdown?"crackdown":e>=t.tierThresholds.tracking?"tracking":"calm",dc=(e,t,i)=>{if(t.length===0)return{zoneId:e,totalHeat:0,tier:"calm",leadingWitnessIds:[]};const n=t.filter(c=>c.suppressed?!1:c.certainty>=i.certaintyFloor);if(n.length===0)return{zoneId:e,totalHeat:0,tier:"calm",leadingWitnessIds:[]};const s=n.map(c=>({memory:c,weight:lc(c,i)})).sort((c,d)=>d.weight-c.weight),a=i.topK>0?i.topK:5,o=s.slice(0,a),r=o.reduce((c,d)=>c+d.weight,0),l=cc(r,i);return{zoneId:e,totalHeat:r,tier:l,leadingWitnessIds:o.map(c=>c.memory.id)}},ci=3600,xt={id:"default",label:"Baseline Urban Patrols",halfLifeSeconds:72*ci,certaintyFloor:.05,reinforcementBonus:.4,reportMultiplier:1.25,suppressionPenalty:.4,topK:5,proximityExponent:.85,tierThresholds:{tracking:.4,crackdown:.75}},uc={downtown:{...xt,id:"downtown",label:"Downtown Grid Hyper-Patrol",halfLifeSeconds:60*ci,reportMultiplier:1.35,topK:6},industrial:{...xt,id:"industrial",label:"Industrial Wasteland Patrol",halfLifeSeconds:96*ci,suppressionPenalty:.55}},di=e=>e?uc[e]??xt:xt,ui=1,hc=(e,t)=>({zoneId:e,memories:{},heat:{zoneId:e,totalHeat:0,tier:"calm",leadingWitnessIds:[]},lastUpdatedAt:t,lastObservationAt:null}),Li=()=>({version:ui,zones:{},paused:!1,lastTickAt:null}),pc=Li(),wn=e=>{switch(e){case"calm":return 0;case"tracking":return 1;case"crackdown":return 2;default:return 0}},pt=e=>{const t=di(e.zoneId),i=Object.values(e.memories).map(n=>li(n));return dc(e.zoneId,i,t)},Ws=j({name:"suspicion",initialState:pc,reducers:{ingestObservation:(e,t)=>{if(e.paused)return;const i=t.payload,n=i.zoneId,s=i.witnessLabel??i.witnessId,a=i.timestamp,o=e.zones[n]??(e.zones[n]=hc(n,a)),r=di(n),l=Bs(i.witnessId,i.targetId,i.recognitionChannel),c=o.memories[l],d=c?li(c):void 0,u={...i,witnessLabel:s,existing:d},h=d?oc(d,u,r):ac(u,r);o.memories[l]=Sn(h),o.heat=pt(o),o.lastObservationAt=a,o.lastUpdatedAt=a,e.lastTickAt=a},applySuspicionDecay:(e,t)=>{if(e.paused)return;const{elapsedSeconds:i,timestamp:n}=t.payload;i<=0||(Object.values(e.zones).forEach(s=>{const a=di(s.zoneId),o={};let r=!1;Object.entries(s.memories).forEach(([l,c])=>{const d=li(c),{memory:u,pruned:h}=rc(d,i,a);if(h){r=!0;return}r=r||u.certainty!==c.certainty,o[l]=Sn(u)}),r&&(s.memories=o,s.heat=pt(s),s.lastUpdatedAt=n)}),e.lastTickAt=n)},setSuspicionPaused:(e,t)=>{e.paused=t.payload},suppressWitnessMemory:(e,t)=>{const{zoneId:i,memoryId:n,suppressed:s}=t.payload,a=e.zones[i];if(!a)return;const o=a.memories[n];o&&o.suppressed!==s&&(a.memories[n]={...o,suppressed:s},a.heat=pt(a))},purgeWitnessMemories:(e,t)=>{const{witnessId:i,zoneId:n}=t.payload;(n?[n]:Object.keys(e.zones)).forEach(a=>{const o=e.zones[a];if(!o)return;const r=Object.keys(o.memories).length;if(r===0)return;const l={};Object.entries(o.memories).forEach(([c,d])=>{d.witnessId!==i&&(l[c]=d)}),Object.keys(l).length!==r&&(o.memories=l,o.heat=pt(o))})},resetSuspicionState:()=>Li()}}),{ingestObservation:Tm,applySuspicionDecay:mc,setSuspicionPaused:Em,suppressWitnessMemory:Rm,purgeWitnessMemories:_m,resetSuspicionState:Lm}=Ws.actions,Dm=e=>{let t="calm";return Object.values(e).forEach(i=>{wn(i.heat.tier)>wn(t)&&(t=i.heat.tier)}),t},gc=Ws.reducer,fc={status:"idle",reason:null,lastDecision:null},qs=j({name:"autoBattle",initialState:fc,reducers:{setAutoBattleStatus:(e,t)=>{e.status=t.payload.status,e.reason=t.payload.reason??null,e.status!=="running"&&(e.lastDecision=e.lastDecision?{...e.lastDecision,timestamp:Date.now()}:e.lastDecision)},recordAutoBattleDecision:(e,t)=>{e.lastDecision=t.payload,e.status="running",e.reason=null},clearAutoBattleDecision:e=>{e.lastDecision=null}}}),{setAutoBattleStatus:Pn,recordAutoBattleDecision:yc,clearAutoBattleDecision:Om}=qs.actions,vc=qs.reducer,St=e=>Math.max(ts,Math.min(is,e)),Ut=e=>{const t=St(e),i=Aa.find(n=>t>=n.min&&t<=n.max);return(i==null?void 0:i.tier)??"calm"},hi=1,zs=()=>({version:hi,value:12,tier:"calm",lastUpdatedAt:null,frozen:!1,respiteUntil:null,decayBoostUntil:null,decayBoostPerSecond:0,cooldowns:{},lastSnapshot:null}),bc=zs(),Sc=()=>j({name:"paranoia",initialState:bc,reducers:{resetParanoiaState:()=>zs(),tickParanoia:(e,t)=>{const{deltaMs:i,timestamp:n,decayMultiplier:s}=t.payload;if(e.frozen||i<=0){e.lastUpdatedAt=n;return}const a=Math.max(0,i)/1e3;if(a===0){e.lastUpdatedAt=n;return}const o=Math.max(0,s??1);let r=xa*o;e.decayBoostUntil&&n<e.decayBoostUntil?r+=Math.max(0,e.decayBoostPerSecond):e.decayBoostUntil&&n>=e.decayBoostUntil&&(e.decayBoostUntil=null,e.decayBoostPerSecond=0);const l=a*r;if(l>0){const c=St(e.value-l);e.value=c,e.tier=Ut(c),e.lastSnapshot={timestamp:n,delta:-l,breakdown:{gains:{},losses:{passive:l},spikes:{}},value:c,tier:e.tier}}e.lastUpdatedAt=n},applyParanoiaStimuli:(e,t)=>{const{timestamp:i,delta:n,breakdown:s,deltaMs:a}=t.payload;if(!Number.isFinite(n)||n===0&&!s)return;let o=n;e.frozen&&o>0&&(o=0);const c=1.1*Math.max(.1,(a??1e3)/1e3);o>0&&e.respiteUntil&&i<e.respiteUntil&&(o=Math.min(o,Ma.respite.maxGainPerTick)),o=Math.max(-c,Math.min(c,o));const d=St(e.value+o);e.value=d,e.tier=Ut(d),e.lastUpdatedAt=i,s&&(e.lastSnapshot={timestamp:i,delta:o,breakdown:s,value:d,tier:e.tier})},applyParanoiaRelief:(e,t)=>{const{amount:i,timestamp:n,cooldownKey:s,cooldownMs:a}=t.payload,o=Math.max(0,i);if(o===0)return;if(s&&a){const l=e.cooldowns[s];if(typeof l=="number"&&l>n)return;e.cooldowns[s]=n+a}const r=St(e.value-o);e.value=r,e.tier=Ut(r),e.lastUpdatedAt=n,e.lastSnapshot={timestamp:n,delta:-o,breakdown:{gains:{},losses:{relief:o},spikes:{}},value:r,tier:e.tier}},setParanoiaRespite:(e,t)=>{const{durationMs:i,timestamp:n}=t.payload,s=Math.max(0,i);e.respiteUntil=n+s},setParanoiaDecayBoost:(e,t)=>{const{amountPerSecond:i,durationMs:n,timestamp:s}=t.payload;if(i<=0||n<=0){e.decayBoostUntil=null,e.decayBoostPerSecond=0;return}e.decayBoostPerSecond=i,e.decayBoostUntil=s+n},setParanoiaFrozen:(e,t)=>{e.frozen=t.payload},clearParanoiaSnapshot:e=>{e.lastSnapshot=null}}}),Vs=Sc(),{resetParanoiaState:wc,tickParanoia:Nm,applyParanoiaStimuli:Fm,applyParanoiaRelief:Bm,setParanoiaRespite:Hm,setParanoiaDecayBoost:Wm,setParanoiaFrozen:qm,clearParanoiaSnapshot:zm}=Vs.actions,Gs=Vs.reducer,at=["heroic","cruel","sneaky","intimidating","competent"],pi=1,Pc={heroic:60*45,cruel:60*50,sneaky:60*35,intimidating:60*40,competent:60*55},Mc=.45,Ac=.25,Mn=5,Qe=100,An=60*90,xc=.1,Ic=5,xn=6,Oe={minor:.4,moderate:.65,major:.85,legendary:1},kc=.1,Cc=at.reduce((e,t)=>(e[t]=0,e),{}),In=12,_=(e,t,i)=>Number.isFinite(e)?Math.max(t,Math.min(i,e)):t,kn=(e,t,i)=>e+(t-e)*i,Us=(e,t)=>{const i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)},Di=e=>{const t=Math.floor(e.x/In),i=Math.floor(e.y/In);return`${t}:${i}`},Tc=(e,t,i,n)=>{const s=t.x-e.x,a=t.y-e.y,o=Math.sqrt(s*s+a*a),r=Math.max(1,Math.floor(o/i));for(let l=1;l<=r;l+=1){const c=l/(r+1);n({x:kn(e.x,t.x,c),y:kn(e.y,t.y,c)})}},Ec=(e,t,i)=>{let n=0,s=0;const a=r=>{if(!r){n+=1;return}!r.isWalkable||r.type===E.WALL?n+=1:r.type===E.DOOR&&(n+=.5)};if(Tc(t,i,1.25,r=>{var d;const l=Math.round(r.x),c=Math.round(r.y);a((d=e.tiles[c])==null?void 0:d[l]),s+=1}),s===0)return 1;const o=n/s;return _(1-o,.1,1)},mt={base:.7,noiseLevel:.6,lightingFactor:.85,disguiseFactor:.8},Rc=e=>({base:_((e==null?void 0:e.base)??mt.base,0,1),noiseLevel:_((e==null?void 0:e.noiseLevel)??mt.noiseLevel,0,1),lightingFactor:_((e==null?void 0:e.lightingFactor)??mt.lightingFactor,0,1),disguiseFactor:_((e==null?void 0:e.disguiseFactor)??mt.disguiseFactor,0,1),crowdDensity:_((e==null?void 0:e.crowdDensity)??.5,0,1)}),_c=e=>at.reduce((t,i)=>{const n=e[i];return typeof n=="number"&&Number.isFinite(n)&&n!==0&&(t[i]=_(n,-30,30)),t},{}),Lc=e=>{const t=Q(),i=typeof e.timestamp=="number"?e.timestamp:Date.now(),n=e.cellId??Di(e.position),s=Rc(e.visibility),a=Oe[e.intensity]??Oe.minor,o=_c(Object.keys(e.traits??{}).reduce((r,l)=>{var c;if(at.includes(l)){const d=l;r[d]=_(((c=e.traits)==null?void 0:c[d])??0,-40,40)*a}return r},{}));return{id:t,actorId:e.actorId,actorLabel:e.actorLabel??"Player",zoneId:e.zoneId,cellId:n,position:{...e.position},intensity:e.intensity,traits:o,tags:[...e.tags],timestamp:i,visibility:s,metadata:e.metadata?{...e.metadata}:void 0}},Dc=24,Cn={resistance:{heroic:1,cruel:-.6,sneaky:.25,intimidating:-.1,competent:.5},corpsec:{heroic:-.2,cruel:.4,sneaky:-.4,intimidating:.8,competent:.6},scavengers:{heroic:.2,cruel:.1,sneaky:.8,intimidating:.3,competent:.4},civilians:{heroic:.8,cruel:-.8,sneaky:-.1,intimidating:-.2,competent:.4}},Oc=(e,t)=>{var a,o,r;const i=e.reputationBias??Cn[t??""]??Cn.civilians,n=(a=e.socialTags)!=null&&a.includes("gossip_hub")?.35:.55,s=(o=e.socialTags)!=null&&o.includes("gossip_hub")?.75:(r=e.socialTags)!=null&&r.includes("guard")?.25:.5;return{traitWeights:{...i},skepticism:_(n,.15,.85),appetiteForRumors:_(s,.15,.9)}},Nc=(e,t)=>{var i,n,s;return e.factionId?e.factionId:(i=e.socialTags)!=null&&i.includes("corpsec")?"corpsec":(n=e.socialTags)!=null&&n.includes("scavenger")?"scavengers":(s=e.socialTags)!=null&&s.includes("resistance")?"resistance":t},Fc=(e,t)=>_(e*t,.2,1.1),Bc=(e,t)=>_(e-(typeof t=="number"?t:0),.25,1),Hc=({visibilityScore:e,distanceFactor:t,lineOfSight:i,npc:n})=>{var o,r;const s=(o=n.socialTags)!=null&&o.includes("sentinel")?.15:(r=n.socialTags)!=null&&r.includes("guard")?.1:0,a=e*.65+t*.2+i*.15+s;return _(a,0,1)},Wc=({event:e,mapArea:t,npcs:i,ambientLighting:n,ambientNoise:s,disguisePenalty:a,maxDistance:o=Dc,visibilityThreshold:r=Mc})=>{const l=i??t.entities.npcs;return l.length?l.map(c=>{var A;const d=Us(c.position,e.position);if(d>o)return null;const u=_(1-d/(o+1),0,1),h=Ec(t,c.position,e.position),g=Fc(n,e.visibility.lightingFactor),p=_(s*.35+e.visibility.noiseLevel*.65,.1,1),m=Bc(e.visibility.disguiseFactor,a),y=_(e.visibility.base*u*h*g*(.5+p*.5)*(1-(1-m)*.6),0,1);if(y<Ac)return null;const v=Nc(c,((A=t.factionRequirement)==null?void 0:A.factionId)??null),S=Oc(c,v),M=Hc({visibilityScore:y,distanceFactor:u,lineOfSight:h,npc:c}),b=y<r;return{witnessId:c.id,name:c.name,factionId:v,zoneId:e.zoneId,cellId:Di(c.position),position:{...c.position},distance:d,lineOfSight:h,distanceFactor:u,lightingFactor:g,noiseFactor:p,disguiseFactor:m,visibilityScore:y,baseConfidence:M,isRumorOnly:b,bias:S}}).filter(c=>!!c).sort((c,d)=>d.visibilityScore-c.visibilityScore):[]},qc=(e,t,i)=>{var s;const n=(s=t.traitWeights)==null?void 0:s[e];return typeof n=="number"&&n!==0?i*n:i},zc=(e,t,i,n)=>{const s=i?.45+(1-n.appetiteForRumors)*.3:0,o=e*_(t/30,.25,1)*(1-n.skepticism)*(1-s);return _(o,0,1)},Vc=(e,t,i,n)=>{if(t===0)return null;const s=zc(i,Math.abs(t),n.isRumorOnly,n.bias);return s<kc?null:{trait:e,delta:t,confidence:s,source:n.isRumorOnly?"rumor":"witness"}},Gc=({event:e,candidates:t,timestamp:i})=>{if(!t.length)return[];const n=e.traits??{},s=Oe[e.intensity]??Oe.minor,a=typeof i=="number"?i:e.timestamp;return t.map(o=>{const r=_(o.baseConfidence*(o.isRumorOnly?.65:1),0,1),l=Object.entries(n).map(([d,u])=>{const h=d,g=qc(h,o.bias,u??0)*s*(o.isRumorOnly?.6:1);return Vc(h,g,r,o)}).filter(d=>d?d.delta!==0:!1);if(!l.length)return null;const c=_(l.reduce((d,u)=>d+u.confidence,0)/l.length,0,1);return{id:Q(),eventId:e.id,witnessId:o.witnessId,witnessName:o.name,factionId:o.factionId,zoneId:o.zoneId,cellId:o.cellId,timestamp:a,visibilityScore:o.visibilityScore,confidence:c,isRumorOnly:o.isRumorOnly,traits:l}}).filter(o=>!!o)},Ks=22,Uc=5,Kc=(e,t,i)=>({id:`${e}::${t}`,fromId:e,toId:t,weight:_(i,.05,1),latencySeconds:_(60*(1.2-i),20,120),remainingEnergy:xn*i,maxEnergy:xn,lastSharedAt:null}),jc=(e,t,i)=>{var a;let n=_(1-i/(Ks+1),0,1);const s=(a=e.socialTags)==null?void 0:a.filter(o=>{var r;return(r=t.socialTags)==null?void 0:r.includes(o)});return s!=null&&s.length&&(n+=s.length*.08),e.factionId&&t.factionId&&e.factionId===t.factionId&&(n+=.15),_(n,0,1)},Yc=({mapArea:e,npcs:t})=>{const i=t??e.entities.npcs;if(i.length<2)return[];const n=[];return i.forEach(s=>{i.filter(o=>o.id!==s.id).map(o=>{const r=Us(s.position,o.position);if(r>Ks)return null;const l=jc(s,o,r);return l<=0?null:{other:o,weight:l}}).filter(o=>!!o).sort((o,r)=>r.weight-o.weight).slice(0,Uc).forEach(({other:o,weight:r})=>{n.push(Kc(s.id,o.id,r))})}),n},$c=(e,t)=>{const i=_(Math.abs(e)/Qe,0,1);return _(i*t,0,1)},Zc=(e,t,i)=>`${e}:${t}:${i}`,Xc=(e,t)=>{if(!t.length)return[];const i={},n=Oe[e.intensity]??Oe.minor;return t.forEach(s=>{s.traits.forEach(a=>{const o=$c(a.delta,a.confidence)*n;if(o<=xc)return;const r=s.witnessId,l=a.delta>=0?1:-1;i[r]||(i[r]={carrierId:r,cellId:s.cellId,zoneId:s.zoneId,rumors:[]});const c=Zc(r,a.trait,e.id);i[r].rumors.push({id:c,eventId:e.id,originWitnessId:s.witnessId,carrierId:r,trait:a.trait,polarity:l,strength:_(o,0,1),confidence:_(a.confidence,0,1),ttlSeconds:An,decayRate:1/An,lastUpdatedAt:s.timestamp,originCellId:s.cellId,originZoneId:s.zoneId,intensity:e.intensity})})}),Object.values(i).map(s=>({...s,rumors:s.rumors.slice(0,Ic)}))},Qc=()=>{const e=Date.now();return at.reduce((t,i)=>(t[i]={value:Cc[i]??0,confidence:0,lastUpdatedAt:e,decaySeconds:Pc[i]??60*45,sources:[]},t),{})},Jc=(e,t,i,n,s,a)=>({id:e,scope:t,label:i,factionId:s,cellId:a,traits:Qc(),updatedAt:n}),ed={version:pi,events:{},witnessRecords:{},recordsByEvent:{},profiles:{},carriers:{},edges:{},debug:{heatmapEnabled:!1},lastTickAt:null},td=(e,t,i,n,s,a,o)=>{let r=e.profiles[t];return r||(r=Jc(t,n,i,s,a,o),e.profiles[t]=r),r},id=(e,t,i)=>{const n=e.traits[t.trait];n&&(n.value=_(n.value+t.delta,-Qe,Qe),n.confidence=_(n.confidence+t.confidence*(1-n.confidence*.5),0,1),n.lastUpdatedAt=i,t.sourceRecordId&&(n.sources.unshift(t.sourceRecordId),n.sources.length>Mn&&(n.sources.length=Mn)),e.updatedAt=i)},Tn=(e,t,i)=>{t.forEach(n=>{const s=n.scopeId,a=n.scope==="witness"?`Witness::${n.scopeId}`:n.scope==="cell"?`Cell ${n.scopeId}`:`Faction ${n.scopeId}`,o=td(e,s,a,n.scope,i,n.scope==="faction"?n.factionId:null,n.scope==="cell"?n.cellId:null);id(o,n,i)})},En=(e,t)=>{t.forEach(i=>{e.carriers[i.carrierId]={carrierId:i.carrierId,cellId:i.cellId,zoneId:i.zoneId,rumors:i.rumors.map(n=>({...n}))}})},Rn=(e,t)=>{t.forEach(i=>{const n=e.edges[i.id];e.edges[i.id]=n?{...n,remainingEnergy:i.remainingEnergy,lastSharedAt:i.lastSharedAt??n.lastSharedAt}:{...i}})},nd=(e,t,i)=>{at.forEach(n=>{const s=e.traits[n];if(!s)return;const a=_(t/s.decaySeconds,0,1);if(a<=0)return;const o=s.value*a*.5;s.value=_(s.value-o,-Qe,Qe),s.confidence=_(s.confidence*(1-a*.6),0,1),s.lastUpdatedAt=i,Math.abs(s.value)<.01&&(s.value=0),s.confidence<.02&&(s.confidence=0,s.sources=[])}),e.updatedAt=i},_n=e=>{Object.entries(e.carriers).forEach(([t,i])=>{i.rumors.length||delete e.carriers[t]})},js=j({name:"reputation",initialState:ed,reducers:{applyEventIntegration:(e,t)=>{const{event:i,records:n,profileMutations:s,carriers:a,edges:o}=t.payload;e.events[i.id]=i,e.recordsByEvent[i.id]=n.map(r=>r.id),n.forEach(r=>{e.witnessRecords[r.id]=r}),Tn(e,s,i.timestamp),En(e,a),Rn(e,o),_n(e),e.lastTickAt=i.timestamp},applyDecay:(e,t)=>{const{timestamp:i,elapsedSeconds:n}=t.payload;Object.values(e.profiles).forEach(s=>nd(s,n,i)),Object.values(e.edges).forEach(s=>{s.remainingEnergy=_(Math.min(s.remainingEnergy+n*.05,s.maxEnergy),0,s.maxEnergy)}),e.lastTickAt=i},applyPropagationResult:(e,t)=>{const{carriers:i,edges:n,profileMutations:s}=t.payload;En(e,i),Rn(e,n),_n(e);const a=Date.now();Tn(e,s,a),e.lastTickAt=a},toggleReputationHeatmap:(e,t)=>{e.debug.heatmapEnabled=t.payload},setInspectorTarget:(e,t)=>{e.debug.inspectorTargetId=t.payload}}}),{applyEventIntegration:sd,applyDecay:Vm,applyPropagationResult:Gm,toggleReputationHeatmap:Um,setInspectorTarget:Km}=js.actions,mi=js.reducer,ad=(e,t)=>{const i=t==="night"?.55:t==="evening"||t==="morning"?.75:1;return e.flags.blackoutTier==="rolling"?i*.4:e.flags.blackoutTier==="brownout"?i*.65:i},od=e=>{switch(e.flags.gangHeat){case"high":return .85;case"med":return .7;default:return .55}},rd=e=>{var a;const t=((a=e.skillTraining)==null?void 0:a.stealth)??0,i=e.skills.agility??5,n=Math.min(t/160,.25),s=Math.max(0,(i-6)*.03);return _(.4-(n+s),0,.4)},ld=e=>{const t=[];return e.forEach(i=>{i.traits.forEach(n=>{const s=n.confidence;t.push({scopeId:i.witnessId,scope:"witness",factionId:i.factionId,cellId:i.cellId,trait:n.trait,delta:n.delta,confidence:n.confidence,sourceRecordId:i.id,witnessId:i.witnessId}),i.factionId&&t.push({scopeId:i.factionId,scope:"faction",factionId:i.factionId,cellId:null,trait:n.trait,delta:n.delta*(.55+s*.2),confidence:n.confidence*.7,sourceRecordId:i.id,witnessId:i.witnessId}),t.push({scopeId:i.cellId,scope:"cell",factionId:i.factionId,cellId:i.cellId,trait:n.trait,delta:n.delta*(.7+s*.15),confidence:n.confidence*.8,sourceRecordId:i.id,witnessId:i.witnessId})})}),t},jm=e=>(t,i)=>{const n=i();if(!n.settings.reputationSystemsEnabled)return;const s=n.world,a=n.player.data,o=e.mapArea??s.currentMapArea,r=e.ambientLighting??ad(s.environment,s.timeOfDay),l=e.ambientNoise??od(s.environment),c=e.disguisePenalty??rd(a),d=Lc({...e,zoneId:e.zoneId??o.zoneId??s.currentMapArea.zoneId,cellId:e.cellId??Di(e.position)}),u=Wc({event:d,mapArea:o,npcs:e.npcsOverride,ambientLighting:r,ambientNoise:l,disguisePenalty:c});if(!u.length)return;const h=Gc({event:d,candidates:u,timestamp:d.timestamp}),g=ld(h),p=Xc(d,h),m=Yc({mapArea:o});t(sd({event:d,records:h,profileMutations:g,carriers:p,edges:m}))},cd={override:null},Ys=j({name:"hudLayout",initialState:cd,reducers:{setHudLayoutOverride:(e,t)=>{e.override=t.payload},clearHudLayoutOverride:e=>{e.override=null}}}),{setHudLayoutOverride:Ym,clearHudLayoutOverride:$m}=Ys.actions,dd=Ys.reducer;var ud={};const Oi="the-getaway-state",$s=typeof window<"u",Ln=typeof process<"u"&&typeof ud.JEST_WORKER_ID<"u",hd={player:lr,world:xs,quests:el,log:Rl,settings:Es,autoBattle:vc,combatFeedback:Nl,missions:Tl,surveillance:Ls,storylets:ec,suspicion:gc,paranoia:Gs,reputation:mi,hudLayout:dd},He=Ia(hd),pd=ka("app/resetGame"),Zm=Oi,gt=(e,t)=>Array.isArray(e)?[...e]:[...t],md=e=>{if(!e)return{...q,version:Ze,data:{...q.data,perks:[...q.data.perks],perkRuntime:{...q.data.perkRuntime},factionReputation:{...q.data.factionReputation}},pendingLevelUpEvents:[...q.pendingLevelUpEvents],xpNotifications:[...q.xpNotifications],pendingFactionEvents:[...q.pendingFactionEvents]};const t=e.data??null,i={...q.data,...t??{},perks:gt(t==null?void 0:t.perks,q.data.perks),perkRuntime:{...q.data.perkRuntime,...(t==null?void 0:t.perkRuntime)??{}},factionReputation:{...q.data.factionReputation,...(t==null?void 0:t.factionReputation)??{}}};return{version:Ze,data:i,pendingLevelUpEvents:gt(e.pendingLevelUpEvents,q.pendingLevelUpEvents),xpNotifications:gt(e.xpNotifications,q.xpNotifications),pendingFactionEvents:gt(e.pendingFactionEvents,q.pendingFactionEvents)}},gd=e=>{if(!e||e.version!==hi)return Gs(void 0,wc());const t=typeof e.value=="number"?e.value:0,i=Number.isFinite(t)?t:0,n=Math.max(ts,Math.min(is,i)),s=Number.isFinite(e.decayBoostPerSecond)?Math.max(0,e.decayBoostPerSecond):0;return{version:hi,value:n,tier:e.tier??"calm",lastUpdatedAt:typeof e.lastUpdatedAt=="number"?e.lastUpdatedAt:null,frozen:!!e.frozen,respiteUntil:typeof e.respiteUntil=="number"?e.respiteUntil:null,decayBoostUntil:typeof e.decayBoostUntil=="number"?e.decayBoostUntil:null,decayBoostPerSecond:s,cooldowns:{...e.cooldowns??{}},lastSnapshot:e.lastSnapshot??null}},fd=e=>({zoneId:e.zoneId,memories:{...e.memories},heat:{zoneId:e.heat.zoneId,totalHeat:e.heat.totalHeat,tier:e.heat.tier,leadingWitnessIds:[...e.heat.leadingWitnessIds]},lastUpdatedAt:e.lastUpdatedAt,lastObservationAt:e.lastObservationAt}),yd=e=>{if(!e||e.version!==ui)return Li();const t={};return e.zones&&Object.entries(e.zones).forEach(([i,n])=>{n&&(t[i]=fd(n))}),{version:ui,zones:t,paused:!!e.paused,lastTickAt:typeof e.lastTickAt=="number"?e.lastTickAt:null}},vd=e=>{if(!e||e.version!==pi)return mi(void 0,{type:"@@INIT"});const t=mi(void 0,{type:"@@INIT"});return{...t,...e,events:{...e.events??{}},witnessRecords:{...e.witnessRecords??{}},recordsByEvent:{...e.recordsByEvent??{}},profiles:{...e.profiles??{}},carriers:{...e.carriers??{}},edges:{...e.edges??{}},debug:{...t.debug,...e.debug??{}},lastTickAt:typeof e.lastTickAt=="number"?e.lastTickAt:null,version:pi}},bd=e=>{const t=xs(void 0,{type:"@@INIT"});if(!e)return t;const i={...e,environment:{...e.environment,flags:{...e.environment.flags},weather:{...e.environment.weather},signage:{...e.environment.signage},rumorSets:{...e.environment.rumorSets??{}},notes:Array.isArray(e.environment.notes)?[...e.environment.notes]:[...t.environment.notes]}},n=Ps||Kr;return i.currentTime=n,i.timeOfDay=De(n,F),i.curfewActive=Xe(n,F),i},Sd=e=>{const t=Ls(void 0,{type:"@@INIT"});return e?{zones:e.zones?{...e.zones}:{},hud:{...t.hud,...e.hud??{},overlayEnabled:!0},curfewBanner:e.curfewBanner?{...e.curfewBanner}:{...t.curfewBanner}}:t},wd=e=>{const t=Es(void 0,{type:"@@INIT"});return e?{...t,...e,visualQualityPreset:e.visualQualityPreset??t.visualQualityPreset}:t},Pd=()=>{if($s)try{const e=window.localStorage.getItem(Oi);return e?JSON.parse(e):void 0}catch(e){console.warn("[store] Failed to load state from localStorage:",e);return}},Md=e=>{if($s)try{const t=JSON.stringify(e);window.localStorage.setItem(Oi,t)}catch(t){console.warn("[store] Failed to save state to localStorage:",t)}},Ad=e=>{if(e)return{...e,player:md(e.player),suspicion:yd(e.suspicion),paranoia:gd(e.paranoia),world:bd(e.world),surveillance:Sd(e.surveillance),reputation:vd(e.reputation),settings:wd(e.settings)}},xd=(e,t)=>{if(pd.match(t)){const i=e==null?void 0:e.settings;let n=He(void 0,t);return i&&(n=He(n,Jr(i.locale)),n=He(n,Xr(i.locale)),n=He(n,Cl(i.locale)),n={...n,settings:i}),n}return He(e,t)},Id=Pd(),kd=Ad(Id),O=Ca({reducer:xd,preloadedState:kd,middleware:e=>e({serializableCheck:Ln?!1:{ignoredActions:["app/resetGame"],warnAfter:128},immutableCheck:Ln?!1:{warnAfter:128}})});O.subscribe(()=>{const e=O.getState(),t={player:e.player,world:e.world,quests:e.quests,log:e.log,settings:e.settings,autoBattle:e.autoBattle,combatFeedback:e.combatFeedback,missions:e.missions,surveillance:e.surveillance,storylets:e.storylets,suspicion:e.suspicion,paranoia:e.paranoia,reputation:e.reputation,hudLayout:e.hudLayout};Md(t)});const ke=(e,t,i)=>Math.max(t,Math.min(i,e)),Cd=e=>({r:e>>16&255,g:e>>8&255,b:e&255}),Dn=(e,t,i)=>(e&255)<<16|(t&255)<<8|i&255,oe=(e=Rt)=>{const t=e,i=e/2;return{tileWidth:t,tileHeight:i,halfTileWidth:t/2,halfTileHeight:i/2}},ae=(e,t,i,n,s=Rt)=>{const a=oe(s),o=(e-t)*a.halfTileWidth+i,r=(e+t)*a.halfTileHeight+n;return{x:o,y:r}},K=(e,t,i,n)=>{const s=i/2,a=n/2;return[{x:e,y:t-a},{x:e+s,y:t},{x:e,y:t+a},{x:e-s,y:t}]},C=(e,t)=>{const{r:i,g:n,b:s}=Cd(e);if(t>=0){const c=ke(Math.round(i+(255-i)*t),0,255),d=ke(Math.round(n+(255-n)*t),0,255),u=ke(Math.round(s+(255-s)*t),0,255);return Dn(c,d,u)}const a=Math.max(0,1+t),o=ke(Math.round(i*a),0,255),r=ke(Math.round(n*a),0,255),l=ke(Math.round(s*a),0,255);return Dn(o,r,l)},Kt=1023,B=Object.freeze({TILE_BASE:0,TILE_OVERLAY:48,PROP_LOW:96,PROP_TALL:128,CHARACTER_BASE:160,CHARACTER:192,EFFECT:224,FLOATING_UI:256,PATH_PREVIEW:288,OVERLAY:960,DEBUG:992}),Ee=Object.freeze({BACKDROP:-20,MAP_BASE:-5,VISION_OVERLAY:2,PATH_PREVIEW:4,COVER_DEBUG:5,DAY_NIGHT_OVERLAY:100}),Ni=(e,t,i=0)=>{const n=(Math.floor(e)&Kt)>>>0,s=Math.floor(t),a=P.Math.Clamp(Math.floor(i),-Kt,Kt);return(s<<10)+n+a};class Td{constructor(t){f(this,"registrations",new Map);f(this,"destroyed",!1);this.scene=t,this.handlePreUpdate=this.handlePreUpdate.bind(this),this.destroy=this.destroy.bind(this),this.scene.events.on(P.Scenes.Events.PRE_UPDATE,this.handlePreUpdate),this.scene.events.once(P.Scenes.Events.SHUTDOWN,this.destroy)}registerStatic(t,i){if(this.registrations.has(t))return;const n={target:t,staticDepth:i};this.attachRegistration(t,n),this.applyRegistration(n)}getRegistration(t){return this.registrations.get(t)}refresh(t){const i=this.registrations.get(t);i&&this.applyRegistration(i)}unregister(t){this.registrations.delete(t)}destroy(){this.destroyed||(this.destroyed=!0,this.scene.events.off(P.Scenes.Events.PRE_UPDATE,this.handlePreUpdate),this.scene.events.off(P.Scenes.Events.SHUTDOWN,this.destroy),this.registrations.clear())}upsertDynamic(t,i,n){const s=this.registrations.get(t);if(s){s.dynamicPoint=i,s.dynamicBias=n,s.staticDepth=void 0,this.applyRegistration(s);return}const a={target:t,dynamicPoint:i,dynamicBias:n};this.attachRegistration(t,a),this.applyRegistration(a)}attachRegistration(t,i){this.registrations.set(t,i),t.once(P.GameObjects.Events.DESTROY,()=>this.unregister(t))}handlePreUpdate(){this.destroyed||this.registrations.forEach(t=>{t.dynamicPoint&&this.applyRegistration(t)})}applyRegistration(t){const{target:i,staticDepth:n,dynamicPoint:s}=t;let a=n;s&&(a=Ni(s.x,s.y,t.dynamicBias??0)),!(a===void 0||a===t.lastApplied)&&(i.setDepth(a),t.lastApplied=a)}}const Zs=(e,t,i,n,s)=>{if(e){const a={x:i,y:n};e.upsertDynamic(t,a,s)}else t.setDepth(Ni(i,n,s))};class Ed{constructor(t,i=Rt,n){f(this,"originX",0);f(this,"originY",0);this.scene=t,this.tileSize=i,this.depthManager=n}assignDepth(t,i,n,s){Zs(this.depthManager,t,i,n,s)}setIsoOrigin(t,i){return this.originX=t,this.originY=i,this}createCrate(t,i,n={}){const s=oe(this.tileSize),{x:a,y:o}=ae(t,i,this.originX,this.originY,this.tileSize),r=n.scale??.55,l=n.height??.65,c=n.alpha??1,d=n.tint??9262372,u=C(d,.2),h=C(d,-.12),g=C(d,-.35),p=this.scene.add.graphics();p.setAlpha(c);const m=s.tileHeight*l,y=s.tileWidth*r,v=s.tileHeight*r,S=K(a,o-m,y,v),M=K(a,o,y,v),b=[M[3],M[0],S[0],S[3]],A=[M[0],M[1],S[1],S[0]];return p.fillStyle(h,1),p.fillPoints(b,!0),p.fillStyle(C(h,-.05),1),p.fillPoints(A,!0),p.fillStyle(u,1),p.fillPoints(S,!0),p.lineStyle(1.2,g,.8),p.strokePoints(M,!0),p.strokePoints(S,!0),this.assignDepth(p,a,o,B.PROP_LOW),p}createHighlightDiamond(t,i,n={}){const{x:s,y:a}=ae(t,i,this.originX,this.originY,this.tileSize),o=oe(this.tileSize),r=o.tileWidth*(n.widthScale??1),l=o.tileHeight*(n.heightScale??1),c=n.color??6333946,d=n.alpha??.3,u=K(s,a,r,l),h=this.scene.add.graphics();return h.fillStyle(c,d),h.fillPoints(u,!0),h.lineStyle(1.5,C(c,.2),d+.2),h.strokePoints(u,!0),this.assignDepth(h,s,a,B.TILE_OVERLAY),h}createCharacterBase(t,i,n={}){const s=this.scene.add.graphics();return this.updateCharacterBase(s,t,i,n),s}createBarricade(t,i,n={}){const s=oe(this.tileSize),{x:a,y:o}=ae(t,i,this.originX,this.originY,this.tileSize),r=n.tint??4937059,l=s.tileWidth*(n.widthScale??.9),c=s.tileHeight*.32*(n.height??1),d=s.tileHeight*.34,u=K(a,o-c,l,d).map(S=>new P.Geom.Point(S.x,S.y)),h=K(a,o,l,d).map(S=>new P.Geom.Point(S.x,S.y)),g=[h[3],h[0],u[0],u[3]],p=[h[0],h[1],u[1],u[0]],m=[h[1],h[2],u[2],u[1]],y=this.scene.add.graphics();y.fillStyle(r,.96),y.fillPoints(m,!0),y.fillStyle(r,.92),y.fillPoints(g,!0),y.fillStyle(r,.88),y.fillPoints(p,!0),y.lineStyle(1.5,C(r,.18),.9),y.strokePoints(h,!0),y.strokePoints(u,!0);const v=B.PROP_TALL+(n.depthOffset??0);return this.assignDepth(y,a,o,v),y}createStreetLight(t,i,n={}){const s=oe(this.tileSize),{x:a,y:o}=ae(t,i,this.originX,this.originY,this.tileSize),r=n.baseColor??988970,l=n.poleColor??1976635,c=n.glowColor??3718648,d=n.height??1.2,u=n.widthScale??.42,h=this.scene.add.container(a,o),g=this.scene.add.graphics(),p=K(0,0,s.tileWidth*u,s.tileHeight*.32).map(x=>new P.Geom.Point(x.x,x.y));g.fillStyle(r,.95),g.fillPoints(p,!0),g.lineStyle(1.2,C(r,.18),.9),g.strokePoints(p,!0);const m=this.scene.add.graphics(),y=s.tileHeight*(1.8*d),v=Math.max(2,s.tileWidth*.05);m.fillStyle(l,1),m.fillRect(-v/2,-y,v,y),m.setAlpha(.95);const S=this.scene.add.graphics(),M=s.tileWidth*.55,b=s.tileHeight*.3,A=K(0,-y,M,b).map(x=>new P.Geom.Point(x.x,x.y));S.fillStyle(C(c,-.4),.96),S.fillPoints(A,!0),S.lineStyle(1.2,C(c,.2),.9),S.strokePoints(A,!0);const k=this.scene.add.graphics();return k.fillStyle(c,n.glowAlpha??.22),k.fillEllipse(0,s.tileHeight*.05,s.tileWidth*.9,s.tileHeight*.36),k.setBlendMode(P.BlendModes.ADD),h.add([k,g,m,S]),this.assignDepth(h,a,o,B.PROP_TALL+16),h}createBillboard(t,i,n={}){const s=oe(this.tileSize),{x:a,y:o}=ae(t,i,this.originX,this.originY,this.tileSize),r=n.baseColor??1120295,l=n.glowColor??3718648,c=n.panelColor??C(l,-.2),d=n.accentColor??C(l,.25),u=n.widthScale??.9,h=n.heightScale??1.1,g=this.scene.add.container(a,o),p=this.scene.add.graphics(),m=K(0,0,s.tileWidth*.45,s.tileHeight*.28).map(T=>new P.Geom.Point(T.x,T.y));p.fillStyle(r,.94),p.fillPoints(m,!0),p.lineStyle(1.3,C(r,.15),.9),p.strokePoints(m,!0);const y=this.scene.add.graphics(),v=s.tileHeight*1.35*h,S=Math.max(2,s.tileWidth*.04);y.fillStyle(C(r,.1),1),y.fillRect(-S/2,-v,S,v);const M=this.scene.add.graphics(),b=s.tileWidth*u,A=s.tileHeight*.6*h,k=[new P.Geom.Point(-b/2,-v),new P.Geom.Point(b/2,-v-A*.18),new P.Geom.Point(b/2,-v-A),new P.Geom.Point(-b/2,-v-A*.82)];M.fillStyle(c,.93),M.fillPoints(k,!0),M.lineStyle(1.6,d,.95),M.strokePoints(k,!0);const x=this.scene.add.graphics();return x.fillStyle(l,n.glowAlpha??.25),x.fillEllipse(0,-v-A*.6,b*1.1,A*1.4),x.setBlendMode(P.BlendModes.ADD),g.add([x,p,y,M]),this.assignDepth(g,a,o,B.PROP_TALL+12),g}createPulsingHighlight(t,i,n={}){var k,x;const s=oe(this.tileSize),{x:a,y:o}=ae(t,i,this.originX,this.originY,this.tileSize),r=s.tileWidth*(n.widthScale??.8),l=s.tileHeight*(n.heightScale??.8),c=n.color??3718648,d=n.alpha??.2,u=n.pulseColor??C(c,.1),h=n.pulseScale??1.18,g=((k=n.pulseAlpha)==null?void 0:k.from)??d,p=((x=n.pulseAlpha)==null?void 0:x.to)??.05,m=n.duration??1350,y=n.depthOffset??5,v=this.scene.add.container(a,o),S=(T,H,w)=>{const I=K(0,0,r,l).map(D=>new P.Geom.Point(D.x,D.y));T.clear(),T.fillStyle(H,w),T.fillPoints(I,!0),T.lineStyle(1.3,C(H,.2),Math.min(1,w+.1)),T.strokePoints(I,!0)},M=this.scene.add.graphics();S(M,c,d);const b=this.scene.add.graphics();S(b,u,g),v.add([b,M]),this.assignDepth(v,a,o,B.EFFECT+y);const A=this.scene.tweens.add({targets:b,alpha:{from:g,to:p},scaleX:{from:1,to:h},scaleY:{from:1,to:h},duration:m,ease:"Sine.easeInOut",yoyo:!0,repeat:-1});return v.setData("pulseTween",A),v.once(P.GameObjects.Events.DESTROY,()=>{A&&A.isPlaying()&&A.stop()}),v}createSpriteTile(t,i,n,s={}){var a,o;return this.createIsoSprite(t,i,n,{textureKey:s.textureKey,depthBias:s.depthBias??B.TILE_BASE,origin:{x:((a=s.origin)==null?void 0:a.x)??.5,y:((o=s.origin)==null?void 0:o.y)??.5},normalTextureKey:s.normalTextureKey})}createSpriteProp(t,i,n,s={}){var a,o;return this.createIsoSprite(t,i,n,{textureKey:s.textureKey,depthBias:s.depthBias??B.PROP_TALL,origin:{x:((a=s.origin)==null?void 0:a.x)??.5,y:((o=s.origin)==null?void 0:o.y)??.85},normalTextureKey:s.normalTextureKey})}positionSprite(t,i,n,s){const{x:a,y:o}=ae(i,n,this.originX,this.originY,this.tileSize);t.setPosition(a,o);const r=s??t.getData("isoDepthBias")??B.PROP_TALL;this.assignDepth(t,a,o,r),t.setData("isoGrid",{x:i,y:n})}updateCharacterBase(t,i,n,s){const a=t.getData("isoOptions")??{},o={baseColor:(s==null?void 0:s.baseColor)??a.baseColor??1120295,outlineColor:(s==null?void 0:s.outlineColor)??a.outlineColor??C(1120295,.25),alpha:(s==null?void 0:s.alpha)??a.alpha??.85,widthScale:(s==null?void 0:s.widthScale)??a.widthScale??.82,heightScale:(s==null?void 0:s.heightScale)??a.heightScale??.6,depthOffset:(s==null?void 0:s.depthOffset)??a.depthOffset??2};t.setData("isoOptions",o);const{x:r,y:l}=ae(i,n,this.originX,this.originY,this.tileSize),c=oe(this.tileSize),d=c.tileWidth*(o.widthScale??1),u=c.tileHeight*(o.heightScale??1),h=K(r,l,d,u);t.clear(),t.fillStyle(o.baseColor??1120295,o.alpha??.85),t.fillPoints(h,!0),t.lineStyle(1.4,o.outlineColor??C(o.baseColor??1120295,.25),(o.alpha??.85)+.1),t.strokePoints(h,!0);const g=B.CHARACTER_BASE+(o.depthOffset??0);this.assignDepth(t,r,l,g)}createCharacterToken(t,i,n={}){const s=this.scene.add.container(0,0),a=oe(this.tileSize),o=a.tileWidth*(n.widthScale??.8),r=a.tileHeight*(n.heightScale??.5),l=a.tileHeight*(n.columnHeight??1.4),c=Math.max(.55,1-l/(a.tileHeight*3)),d=n.haloRadius??a.tileWidth*.55,u=n.baseColor??1120295,h=n.outlineColor??C(u,.25),g=n.primaryColor??3718648,p=n.accentColor??C(g,.2),m=n.glowColor??g,y=this.scene.add.graphics(),v=K(0,0,o,r).map(w=>new P.Geom.Point(w.x,w.y));y.fillStyle(u,n.alpha??.92),y.fillPoints(v,!0),y.lineStyle(1.4,h,.9),y.strokePoints(v,!0);const S=this.scene.add.graphics(),M=K(0,-l,o*c,r*c).map(w=>new P.Geom.Point(w.x,w.y)),b=v,A=[b[1],b[2],M[2],M[1]],k=[b[2],b[3],M[3],M[2]];S.fillStyle(C(g,-.4),.96),S.fillPoints(k,!0),S.fillStyle(C(g,-.25),.98),S.fillPoints(A,!0),S.lineStyle(1.1,C(g,.1),.88),S.strokePoints(k,!0),S.strokePoints(A,!0);const x=this.scene.add.graphics();x.fillStyle(p,.92),x.fillPoints(M,!0),x.lineStyle(1.2,C(p,.3),.95),x.strokePoints(M,!0);const T=this.scene.add.graphics();T.fillStyle(m,.2),T.fillEllipse(0,a.tileHeight*.1,d,d*.45),T.setBlendMode(P.BlendModes.ADD),s.add([T,y,S,x]);const H={container:s,base:y,column:S,beacon:x,halo:T,depthOffset:n.depthOffset??6,options:n};return this.positionCharacterToken(H,t,i),H}positionCharacterToken(t,i,n){const{x:s,y:a}=ae(i,n,this.originX,this.originY,this.tileSize);t.container.setPosition(s,a);const o=B.CHARACTER+(t.depthOffset??0);this.assignDepth(t.container,s,a,o)}createIsoSprite(t,i,n,s){var d,u;const a=s.textureKey??"props",o=s.depthBias??B.PROP_TALL,r=this.scene.add.image(0,0,a,n),l=((d=s.origin)==null?void 0:d.x)??.5,c=((u=s.origin)==null?void 0:u.y)??.5;return r.setOrigin(l,c),r.setData("isoDepthBias",o),s.normalTextureKey&&(r.setData("isoNormalTexture",s.normalTextureKey),r.setData("isoLightingApplied",!1)),this.positionSprite(r,t,i,o),r}applyLightingToSprite(t,i){if(!t||!t.getData("isoNormalTexture"))return;const s=t.getData("isoLightingApplied")===!0,a=this.scene.game.renderer instanceof P.Renderer.WebGL.WebGLRenderer;i&&a&&!s?(t.setPipeline("Light2D"),t.setData("isoLightingApplied",!0)):(!i||!a)&&s&&(t.resetPipeline(),t.setData("isoLightingApplied",!1))}}const Rd=(e,t)=>{const i=e.entityProfiles[t];return{baseColor:i.baseColor,outlineColor:i.outlineColor,primaryColor:i.primaryColor,accentColor:i.accentColor,glowColor:i.glowColor,columnHeight:i.columnHeight,widthScale:i.widthScale,heightScale:i.heightScale,depthOffset:i.depthOffset}};class Xs{constructor(t,i){f(this,"motionByToken",new WeakMap);this.isoFactory=t,this.theme=i}createToken(t,i,n){const s=this.isoFactory.createCharacterToken(i,n,Rd(this.theme,t));return this.decorateToken(t,s),this.motionByToken.set(s,{lastX:i,lastY:n,cadence:Math.abs(i*17+n*31)%11*.23}),s}positionToken(t,i,n){this.isoFactory.positionCharacterToken(t,i,n);const s=this.motionByToken.get(t),a=t.container.getData("rigShell"),o=t.container.getData("rigStride");if(!s||!a||!o)return;const r=i-s.lastX,l=n-s.lastY;if(r!==0||l!==0){s.cadence+=.55;const d=P.Math.Clamp(r*.22,-.24,.24);a.setRotation(d),t.container.scaleX=r<0?-1:1,o.setAlpha(.28+Math.min(.42,Math.abs(r)*.2+Math.abs(l)*.2)),o.setScale(1+Math.abs(r)*.1,1+Math.abs(l)*.08),t.halo.setAlpha(.2+Math.min(.16,(Math.abs(r)+Math.abs(l))*.08))}else s.cadence+=.08,a.setRotation(a.rotation*.86),o.setAlpha(Math.max(.12,o.alpha*.85)),o.setScale(P.Math.Linear(o.scaleX,1,.25),P.Math.Linear(o.scaleY,1,.25)),t.halo.setAlpha(P.Math.Linear(t.halo.alpha,.2,.2));a.y=-2+Math.sin(s.cadence)*1.8,t.beacon.y=-Math.sin(s.cadence+.45)*1.25,s.lastX=i,s.lastY=n}decorateToken(t,i){const n=this.theme.entityProfiles[t],s=i.container.scene.add.graphics(),a=i.container.scene.add.graphics(),o=i.container.scene.add.graphics(),r=16*n.widthScale,l=24*n.columnHeight*.64;switch(s.fillStyle(C(n.primaryColor,-.2),.9),s.lineStyle(1.2,n.outlineColor,.95),s.fillEllipse(0,-l*.3,r,l),s.strokeEllipse(0,-l*.3,r,l),a.fillStyle(n.accentColor,.94),a.lineStyle(1,C(n.accentColor,.35),.92),o.fillStyle(n.glowColor,.18),o.fillEllipse(0,2.5,21*n.widthScale,8.4*n.heightScale),o.setBlendMode(P.BlendModes.ADD),t){case"player":s.fillStyle(C(n.accentColor,-.15),.95),s.fillTriangle(0,-l*1.08,-4.4,-l*.64,4.4,-l*.64),a.fillTriangle(0,-l*.96,-3.4,-l*.7,3.4,-l*.7);break;case"hostileNpc":s.fillStyle(C(n.primaryColor,-.34),.98),s.fillRect(-r*.55,-l*.75,r*1.1,l*.32),a.fillTriangle(-4.5,-l*.85,-8.2,-l*.58,-2.2,-l*.58),a.fillTriangle(4.5,-l*.85,2.2,-l*.58,8.2,-l*.58);break;case"interactiveNpc":s.fillStyle(C(n.primaryColor,.08),.95),s.fillEllipse(0,-l*.86,r*.88,r*.72),a.fillStyle(n.accentColor,.9),a.fillCircle(0,-l*1.02,3.2),a.fillRect(-.8,-l*.96,1.6,9.6);break;case"friendlyNpc":default:s.fillStyle(C(n.primaryColor,.04),.92),s.fillEllipse(0,-l*.87,r*.92,r*.62),a.fillTriangle(0,-l*.96,-3.8,-l*.78,3.8,-l*.78);break}i.container.addAt(s,2),i.container.add(a),i.container.add(o),i.container.setData("rigShell",s),i.container.setData("rigStride",o);const c=i.container.scene.tweens.add({targets:a,alpha:{from:.4,to:.95},yoyo:!0,repeat:-1,duration:920+(t==="hostileNpc"?180:0),ease:"Sine.easeInOut"});i.container.once(P.GameObjects.Events.DESTROY,()=>{c.isPlaying()&&c.stop()})}}class On{constructor(){f(this,"disposables",[]);f(this,"disposed",!1)}add(t){if(this.disposed){t();return}this.disposables.push(t)}dispose(){if(!this.disposed)for(this.disposed=!0;this.disposables.length>0;){const t=this.disposables.pop();if(t)try{t()}catch(i){console.error("[DisposableBag] Failed to dispose resource.",i)}}}}const _d=(e,t,i)=>{const n=(r,l,c)=>{window.addEventListener(r,l,c),i.add(()=>window.removeEventListener(r,l,c))},s=(r,l,c)=>{document.addEventListener(r,l,c),i.add(()=>document.removeEventListener(r,l,c))},a=(r,l,c)=>{e.scale.on(r,l,c),i.add(()=>e.scale.off(r,l,c))},o=(r,l,c)=>{e.input&&(e.input.on(r,l,c),i.add(()=>{var d;(d=e.input)==null||d.off(r,l,c)}))};return{scene:e,getState:t.getState,dispatch:t.dispatch,disposables:i,listenWindow:n,listenDocument:s,listenScale:a,listenInput:o}};class Ld{constructor(t){f(this,"modules",[]);this.context=t}register(t){t.init(this.context),this.modules.push(t)}onCreate(){this.modules.forEach(t=>{var i;(i=t.onCreate)==null||i.call(t)})}onStateChange(t,i){this.modules.forEach(n=>{var s;(s=n.onStateChange)==null||s.call(n,t,i)})}onResize(){this.modules.forEach(t=>{var i;(i=t.onResize)==null||i.call(t)})}onUpdate(t,i){this.modules.forEach(n=>{var s;(s=n.onUpdate)==null||s.call(n,t,i)})}onShutdown(){var t;for(let i=this.modules.length-1;i>=0;i-=1){const n=this.modules[i];n&&((t=n.onShutdown)==null||t.call(n))}this.modules.length=0}}const Dd=1.25,jt=.6,ft=2.3,Od=6,Nn=.08,Nd=1.28,Fd=.22,Bd=340;class Hd{constructor(t){f(this,"key","camera");f(this,"context");f(this,"handleWheel",(t,i,n,s)=>{const a=this.getScene();if(!a.sys.isActive())return;const o=a.cameras.main,r=s>0?.82:1.18,l=o.zoom,c=P.Math.Clamp(l*r,jt,ft);if(Math.abs(c-l)<5e-4)return;a.inCombat||(a.userAdjustedZoom=!0),this.stopCameraZoomTween();let d=null;if(a.isCameraFollowingPlayer||(d=o.getWorldPoint(t.x,t.y)),o.setZoom(c),a.isCameraFollowingPlayer)o.setDeadzone(Math.max(120,a.scale.width*.22),Math.max(160,a.scale.height*.28)),this.recenterCameraOnPlayer();else{const u=o.getWorldPoint(t.x,t.y),h=((d==null?void 0:d.x)??0)-u.x,g=((d==null?void 0:d.y)??0)-u.y;o.scrollX+=h,o.scrollY+=g,this.clampCameraToBounds(o)}a.applyOverlayZoom(),a.emitViewportUpdate(),a.inCombat||(a.baselineCameraZoom=c)});this.scene=t}init(t){this.context=t}onCreate(){this.context.listenInput("wheel",this.handleWheel)}onResize(){const t=this.getScene();t.sys.isActive()&&t.currentMapArea&&(this.setupCameraAndMap(),this.enablePlayerCameraFollow(),t.resizeDayNightOverlay())}setupCameraAndMap(){const t=this.getScene();if(!t.currentMapArea)return;const{width:i,height:n}=t.currentMapArea,{tileHeight:s,halfTileWidth:a,halfTileHeight:o}=t.getIsoMetrics(),r=t.scale.width,l=t.scale.height;t.isoOriginX=(n-1)*a,t.isoOriginY=s,t.ensureIsoFactory(),t.ensureVisualPipeline();const c=(i+n)*a,d=(i+n)*o,u=r/c,h=l/d,g=Math.min(u,h),p=P.Math.Clamp(g*Dd,jt,ft),m=t.cameras.main,y=t.pendingCameraRestore||!!t.cameraZoomTween;t.inCombat||(t.hasInitialZoomApplied?!t.userAdjustedZoom&&!y&&Math.abs(m.zoom-p)>8e-4&&(t.userAdjustedZoom=!1,this.animateCameraZoom(p)):y||m.setZoom(p));const v=t.computeIsoBounds(),S=t.tileSize*Od;m.setBounds(v.minX-S,v.minY-S,v.maxX-v.minX+S*2,v.maxY-v.minY+S*2);const M=(i-1)/2,b=(n-1)/2,A=t.calculatePixelPosition(M,b),x=(t.playerInitialPosition?t.calculatePixelPosition(t.playerInitialPosition.x,t.playerInitialPosition.y):null)??A;t.isCameraFollowingPlayer?this.recenterCameraOnPlayer():m.centerOn(x.x,x.y+s*.25),t.renderStaticProps(),t.drawBackdrop(),t.drawMap(t.currentMapArea.tiles),t.drawBuildingMasses(),t.drawBuildingLabels(),t.clearPathPreview(),t.resizeDayNightOverlay(),t.emitViewportUpdate(),!t.inCombat&&!y&&(t.baselineCameraZoom=m.zoom),t.hasInitialZoomApplied=!0}enablePlayerCameraFollow(){const t=this.getScene();if(!t.playerToken||!t.sys.isActive())return;const i=t.cameras.main;t.isCameraFollowingPlayer||i.startFollow(t.playerToken.container,!1,Nn,Nn),i.setDeadzone(Math.max(120,t.scale.width*.22),Math.max(160,t.scale.height*.28)),t.isCameraFollowingPlayer=!0,this.recenterCameraOnPlayer(),t.dispatchPlayerScreenPosition()}recenterCameraOnPlayer(){const t=this.getScene();if(!t.playerToken||!t.sys.isActive())return;t.cameras.main.centerOn(t.playerToken.container.x,t.playerToken.container.y),t.dispatchPlayerScreenPosition()}clampCameraToBounds(t){const i=t.getBounds();if(!i)return;const n=t.width/t.zoom,s=t.height/t.zoom,a=i.x,o=i.x+Math.max(0,i.width-n),r=i.y,l=i.y+Math.max(0,i.height-s);t.scrollX=P.Math.Clamp(t.scrollX,a,o),t.scrollY=P.Math.Clamp(t.scrollY,r,l)}clampCameraCenterTarget(t,i){const s=this.getScene().cameras.main,a=s.getBounds();if(!a)return{x:t,y:i};const o=s.worldView.width,r=s.worldView.height,l=o/2,c=r/2,d=a.x+l,u=a.x+Math.max(l,a.width-l),h=a.y+c,g=a.y+Math.max(c,a.height-c),p=P.Math.Clamp(t,d,Math.max(d,u)),m=P.Math.Clamp(i,h,Math.max(h,g));return{x:p,y:m}}focusCameraOnGridPosition(t,i,n=!0){const s=this.getScene();if(!s.sys.isActive()||!s.currentMapArea)return;const a=s.getIsoMetrics(),o=s.calculatePixelPosition(t,i),r=o.x,l=o.y+a.halfTileHeight,{x:c,y:d}=this.clampCameraCenterTarget(r,l),u=s.cameras.main;s.isCameraFollowingPlayer=!1,u.stopFollow();const h=()=>{this.clampCameraToBounds(u),s.emitViewportUpdate()};n?u.pan(c,d,300,"Sine.easeInOut",!1,(g,p)=>{s.emitViewportUpdate(),p===1&&h()}):(u.centerOn(c,d),h())}stopCameraZoomTween(){const t=this.getScene();t.cameraZoomTween&&(t.cameraZoomTween.remove(),t.cameraZoomTween=null,t.pendingCameraRestore&&(t.pendingCameraRestore=!1,t.pendingRestoreUserAdjusted!==null&&(t.userAdjustedZoom=t.pendingRestoreUserAdjusted),t.preCombatZoom=null,t.preCombatUserAdjusted=!1,t.pendingRestoreUserAdjusted=null))}animateCameraZoom(t){const i=this.getScene();if(!i.sys.isActive())return;const n=i.cameras.main;if(!n)return;const s=P.Math.Clamp(t,jt,ft),a=n.zoom;if(this.stopCameraZoomTween(),Math.abs(a-s)<5e-4){n.setZoom(s),i.applyOverlayZoom(),i.emitViewportUpdate(),i.inCombat||(i.baselineCameraZoom=n.zoom),i.pendingCameraRestore&&(i.pendingCameraRestore=!1,i.pendingRestoreUserAdjusted!==null&&(i.userAdjustedZoom=i.pendingRestoreUserAdjusted),i.preCombatZoom=null,i.preCombatUserAdjusted=!1,i.pendingRestoreUserAdjusted=null);return}i.cameraZoomTween=i.tweens.add({targets:n,zoom:s,duration:Bd,ease:"Sine.easeInOut",onUpdate:()=>{i.applyOverlayZoom(),i.emitViewportUpdate()},onComplete:()=>{i.cameraZoomTween=null,i.inCombat||(i.baselineCameraZoom=n.zoom),i.pendingCameraRestore&&(i.pendingCameraRestore=!1,i.pendingRestoreUserAdjusted!==null&&(i.userAdjustedZoom=i.pendingRestoreUserAdjusted),i.preCombatZoom=null,i.preCombatUserAdjusted=!1,i.pendingRestoreUserAdjusted=null)}})}zoomCameraForCombat(){const t=this.getScene(),i=t.cameras.main;if(!i)return;t.pendingCameraRestore=!1;const n=i.zoom;t.preCombatZoom===null&&(t.preCombatZoom=n,t.preCombatUserAdjusted=t.userAdjustedZoom),t.baselineCameraZoom=n;const s=Math.min(ft,Math.max(n*Nd,n+Fd));t.userAdjustedZoom=!1,this.animateCameraZoom(s)}restoreCameraAfterCombat(){const t=this.getScene(),i=t.cameras.main;if(!i)return;const n=t.preCombatZoom??t.baselineCameraZoom??i.zoom;t.pendingRestoreUserAdjusted=t.preCombatUserAdjusted,t.userAdjustedZoom=!0,t.pendingCameraRestore=!0,this.animateCameraZoom(n)}getScene(){return this.scene}}const Wd=.28,qd=16777215;class zd{constructor(t){f(this,"key","dayNightOverlay");f(this,"context");f(this,"handleVisibilityChange",()=>{var i;const t=this.getScene();t.sys.isActive()&&document.visibilityState==="visible"&&(this.resizeDayNightOverlay(),this.updateDayNightOverlay(),(i=t.dayNightOverlay)==null||i.setVisible(!0))});this.scene=t}init(t){this.context=t}onCreate(){this.context.listenDocument("visibilitychange",this.handleVisibilityChange)}initializeDayNightOverlay(){const t=this.getScene(),i=t.scale.width,n=t.scale.height;t.dayNightOverlay=t.add.rectangle(0,0,i,n,0,0),t.dayNightOverlay.setOrigin(.5,.5),t.dayNightOverlay.setScrollFactor(0),t.registerStaticDepth(t.dayNightOverlay,Ee.DAY_NIGHT_OVERLAY),t.dayNightOverlay.setBlendMode(P.BlendModes.MULTIPLY),t.dayNightOverlay.setSize(i,n),t.dayNightOverlay.setDisplaySize(i,n),this.applyOverlayZoom()}applyOverlayZoom(){const t=this.getScene();if(!t.dayNightOverlay)return;const n=1/(t.cameras.main.zoom||1);t.dayNightOverlay.setScale(n,n);const s=t.scale.width/2,a=t.scale.height/2;t.dayNightOverlay.setPosition(s,a)}resizeDayNightOverlay(){const t=this.getScene();if(!t.dayNightOverlay)return;const i=t.scale.width,n=t.scale.height;t.dayNightOverlay.setSize(i,n),t.dayNightOverlay.setDisplaySize(i,n),this.applyOverlayZoom()}updateDayNightOverlay(){const t=this.getScene();if(!t.dayNightOverlay)return;const i=Fr(t.currentGameTime,F),n=t.resolveAtmosphereProfile(i),s=t.inCombat?Math.min(n.overlayAlpha,Wd):n.overlayAlpha,a=t.inCombat?qd:n.overlayColor;t.dayNightOverlay.setFillStyle(a,s)}getScene(){return this.scene}}const Vd="isoTileSelected",gi="isoPathPreview",Gd="minimapViewportClick",Ud="minimapStateUpdate",Kd="minimapZoomUpdate",Xm="minimapPathPreview",jd="minimapObjectiveFocus",Yd="playerScreenPositionUpdate",$d="pickupStateSync";class Zd{constructor(t){f(this,"key","entityRender");this.scene=t}init(){}updatePlayerPosition(t){const i=this.getScene();if(!i.playerToken){console.warn("[MainScene] Player token not available for position update.");return}const n=!i.lastPlayerGridPosition||i.lastPlayerGridPosition.x!==t.x||i.lastPlayerGridPosition.y!==t.y;i.ensureIsoFactory(),i.characterRigFactory?i.characterRigFactory.positionToken(i.playerToken,t.x,t.y):i.isoFactory.positionCharacterToken(i.playerToken,t.x,t.y);const s=i.calculatePixelPosition(t.x,t.y);if(this.dispatchPlayerScreenPosition(),i.playerNameLabel){const a=i.getIsoMetrics();this.positionCharacterLabel(i.playerNameLabel,s.x,s.y,a.tileHeight*1.6)}n&&(i.lastPlayerGridPosition={...t},i.isCameraFollowingPlayer||i.enablePlayerCameraFollow())}updatePlayerVitalsIndicator(t,i,n){const s=this.getScene();if(!s.inCombat){this.destroyPlayerVitalsIndicator();return}if(!s.playerToken||!s.sys.isActive())return;const a=s.getIsoMetrics(),o=s.calculatePixelPosition(t.x,t.y),r=a.tileWidth*.38,l=Math.max(4,a.tileHeight*.08),c=o.x-r/2,d=o.y-a.tileHeight*.7,u=n>0?Math.max(0,Math.min(1,i/n)):0;s.playerVitalsIndicator||(s.playerVitalsIndicator=s.add.graphics());const h=s.playerVitalsIndicator;h.clear(),h.fillStyle(988970,.82),h.fillRoundedRect(c,d,r,l,Math.min(4,l)),u>0&&(h.fillStyle(3718648,1),h.fillRoundedRect(c+1,d+1,(r-2)*u,Math.max(1,l-2),Math.max(2,l-2))),s.syncDepth(h,o.x,o.y,B.FLOATING_UI+9)}destroyPlayerVitalsIndicator(){const t=this.getScene();t.playerVitalsIndicator&&(t.playerVitalsIndicator.destroy(),t.playerVitalsIndicator=void 0)}updateEnemies(t){const i=this.getScene();if(!i.mapGraphics||!i.sys.isActive())return;i.ensureIsoFactory(),i.enemySprites.forEach(s=>{s.markedForRemoval=!0});const n=i.getIsoMetrics();for(const s of t){const a=i.enemySprites.get(s.id),o=i.calculatePixelPosition(s.position.x,s.position.y);if(!a){if(s.health<=0)continue;const r=i.characterRigFactory?i.characterRigFactory.createToken("hostileNpc",s.position.x,s.position.y):i.isoFactory.createCharacterToken(s.position.x,s.position.y,i.visualTheme.entityProfiles.hostileNpc),l=i.add.graphics();l.setVisible(!1);const c=this.createCharacterNameLabel(s.name??"Hostile",15680580);this.positionCharacterLabel(c,o.x,o.y,n.tileHeight*1.45),i.enemySprites.set(s.id,{token:r,healthBar:l,nameLabel:c,markedForRemoval:!1});const d=i.enemySprites.get(s.id);d&&this.updateEnemyHealthBar(d,o,n,s);continue}if(s.health<=0){a.markedForRemoval=!0;continue}i.characterRigFactory?i.characterRigFactory.positionToken(a.token,s.position.x,s.position.y):i.isoFactory.positionCharacterToken(a.token,s.position.x,s.position.y),a.markedForRemoval=!1,this.positionCharacterLabel(a.nameLabel,o.x,o.y,n.tileHeight*1.45),this.updateEnemyHealthBar(a,o,n,s)}i.enemySprites.forEach((s,a)=>{s.markedForRemoval&&(s.token.container.destroy(!0),s.healthBar.destroy(),s.nameLabel.destroy(),i.enemySprites.delete(a))})}updateNpcs(t){const i=this.getScene();if(!i.sys.isActive())return;i.npcSprites.forEach(s=>{s.markedForRemoval=!0}),i.ensureIsoFactory();const n=i.getIsoMetrics();for(const s of t){const a=i.npcSprites.get(s.id),o=i.calculatePixelPosition(s.position.x,s.position.y);if(!a){const r=s.isInteractive?"interactiveNpc":"friendlyNpc",l=i.characterRigFactory?i.characterRigFactory.createToken(r,s.position.x,s.position.y):i.isoFactory.createCharacterToken(s.position.x,s.position.y,i.visualTheme.entityProfiles[r]),c=this.createCharacterNameLabel(s.name??"Civilian",s.isInteractive?2282478:9741240);this.positionCharacterLabel(c,o.x,o.y,n.tileHeight*1.35);const d={token:l,nameLabel:c,markedForRemoval:!1};i.npcSprites.set(s.id,d),this.updateNpcCombatIndicator(d,o,n,s);continue}i.characterRigFactory?i.characterRigFactory.positionToken(a.token,s.position.x,s.position.y):i.isoFactory.positionCharacterToken(a.token,s.position.x,s.position.y),a.markedForRemoval=!1,this.positionCharacterLabel(a.nameLabel,o.x,o.y,n.tileHeight*1.35),this.updateNpcCombatIndicator(a,o,n,s)}i.npcSprites.forEach((s,a)=>{s.markedForRemoval&&(s.token.container.destroy(!0),s.nameLabel.destroy(),s.indicator&&s.indicator.destroy(),i.npcSprites.delete(a))})}createCharacterNameLabel(t,i,n=12){const a=this.getScene().add.text(0,0,t.toUpperCase(),{fontFamily:'Orbitron, "DM Sans", sans-serif',fontSize:`${n}px`,fontStyle:"700",color:this.colorToHex(16317180),align:"center"});return a.setOrigin(.5,1),a.setStroke(this.colorToHex(i),1.4),a.setShadow(0,0,this.colorToHex(i),8,!0,!0),a.setBlendMode(P.BlendModes.ADD),a.setAlpha(.95),a}positionCharacterLabel(t,i,n,s){t.setPosition(i,n-s),t.setDepth(Ni(i,n,B.OVERLAY))}dispatchPlayerScreenPosition(){var g;const t=this.getScene();if(!t.playerToken||!t.sys.isActive())return;const i=t.cameras.main,n=t.playerToken.container,s=n.x,a=n.y,o=(s-i.worldView.x)*i.zoom,r=(a-i.worldView.y)*i.zoom,l=(g=t.game.canvas)==null?void 0:g.getBoundingClientRect(),c=(l==null?void 0:l.width)??t.scale.width,d=(l==null?void 0:l.height)??t.scale.height,u={worldX:s,worldY:a,screenX:o,screenY:r,canvasWidth:t.scale.width,canvasHeight:t.scale.height,canvasDisplayWidth:c,canvasDisplayHeight:d,canvasLeft:(l==null?void 0:l.left)??0,canvasTop:(l==null?void 0:l.top)??0,zoom:i.zoom,timestamp:typeof performance<"u"?performance.now():Date.now()},h=t.lastPlayerScreenDetail;h&&Math.abs(h.screenX-u.screenX)<.5&&Math.abs(h.screenY-u.screenY)<.5&&Math.abs(h.zoom-u.zoom)<1e-4&&h.canvasWidth===u.canvasWidth&&h.canvasHeight===u.canvasHeight||(t.lastPlayerScreenDetail=u,typeof window<"u"&&(window.__getawayPlayerScreenPosition=u,window.dispatchEvent(new CustomEvent(Yd,{detail:u}))))}updateNpcCombatIndicator(t,i,n,s){const a=this.getScene();if(!a.inCombat||!s.isInteractive){t.indicator&&(t.indicator.destroy(),t.indicator=void 0);return}t.indicator||(t.indicator=a.add.graphics());const o=t.indicator,r=n.tileWidth*.26,l=Math.max(3,n.tileHeight*.06),c=i.x-r/2,d=i.y-n.tileHeight*.68;o.clear(),o.fillStyle(1059395,.82),o.fillRoundedRect(c,d,r,l,Math.min(3,l)),o.fillStyle(2278750,1),o.fillRoundedRect(c+1,d+1,r-2,Math.max(1,l-2),Math.max(2,l-2)),a.syncDepth(o,i.x,i.y,B.FLOATING_UI+6)}updateEnemyHealthBar(t,i,n,s){const a=this.getScene(),o=t.healthBar;if(!a.inCombat){o.clear(),o.setVisible(!1);return}o.setVisible(!0);const r=n.tileWidth*.38,l=Math.max(4,n.tileHeight*.08),c=i.x-r/2,d=i.y-n.tileHeight*.75,u=s.maxHealth>0?P.Math.Clamp(s.health/s.maxHealth,0,1):0;o.clear(),o.fillStyle(4136221,.88),o.fillRoundedRect(c,d,r,l,Math.min(4,l)),u>0&&(o.fillStyle(15680580,1),o.fillRoundedRect(c+1,d+1,(r-2)*u,Math.max(1,l-2),Math.max(2,l-2))),a.syncDepth(o,i.x,i.y,B.FLOATING_UI+7)}colorToHex(t){return`#${t.toString(16).padStart(6,"0")}`}getScene(){return this.scene}}const fi=5,Je=2,Fn=1,Xd="south",Bn=0,Qd=["none","half","full"],Jd={none:1,half:.75,full:.55},eu={none:0,half:-.2,full:-.4},tu=()=>{var e;try{switch(((e=O.getState().paranoia)==null?void 0:e.tier)??"calm"){case"uneasy":return-.05;case"on_edge":return-.1;case"panicked":return-.15;case"breakdown":return-.25;default:return 0}}catch{return 0}},It=e=>Qd.indexOf(e),Hn=(e,t)=>It(t)>It(e)?t:e,Lt=(e,t)=>{const i=t.x-e.x,n=t.y-e.y;if(Math.abs(i)>=Math.abs(n)){if(i>0)return"east";if(i<0)return"west"}return n>0?"south":n<0?"north":Xd},Qs=(e,t)=>e?e[t]??"none":"none",iu=e=>{if(!e)return null;let t="north",i="none";return["north","east","south","west"].forEach(n=>{const s=Qs(e,n);It(s)>It(i)&&(i=s,t=n)}),i==="none"?null:t},Js=(e,t)=>{var i,n;if(e)return(n=(i=e.tiles[t.y])==null?void 0:i[t.x])==null?void 0:n.cover},ea=e=>typeof e=="boolean"?{isBehindCover:e}:e?{isBehindCover:!!e.isBehindCover,mapArea:e.mapArea}:{isBehindCover:!1},ta=(e,t,i)=>{let n=i.isBehindCover?"half":"none";const s=Lt(t.position,e.position),a=Js(i.mapArea,t.position);return n=Hn(n,Qs(a,s)),t.coverOrientation&&t.coverOrientation===s&&(n=Hn(n,"half")),{level:n,attackDirection:s}},ia=(e,t)=>({...e,facing:t}),yi=(e,t)=>{if(!t)return{...e,coverOrientation:e.coverOrientation??null,suppression:e.suppression??Bn};const i=Js(t,e.position);return{...e,coverOrientation:iu(i),suppression:e.suppression??Bn}},ot=(e,t,i)=>{const n=Lt(t,e.position),s=ia(e,n);return yi(s,i)};let nu=()=>Math.random();const Wn=()=>{const e=nu();if(!Number.isFinite(e)||Number.isNaN(e))throw new Error("[CombatSystem] Random generator must return a finite number between 0 and 1.");if(e<0||e>1)throw new Error("[CombatSystem] Random generator must return a value between 0 and 1.");return e},qn=e=>({...e,equipped:{...e.equipped},encumbrance:{...e.encumbrance},inventory:{...e.inventory,items:[...e.inventory.items],hotbar:[...e.inventory.hotbar]},equippedSlots:e.equippedSlots?{...e.equippedSlots}:{},perkRuntime:{...e.perkRuntime}}),vi=.25,Ue=e=>{const t=e==null?void 0:e.durability;if(!t||t.max<=0)return 1;const i=t.current/t.max;return Number.isFinite(i)?Math.max(0,Math.min(1,i)):1},zn=e=>{const t=Ue(e);return t<=0?0:t<=vi?.75:t<=.5?.9:1},Vn=(e,t=1)=>{if(!e.durability)return e;const i=Math.max(0,e.durability.current-t);return{...e,durability:{...e.durability,current:i}}},Gn=(e,t,i,n,s)=>{if(n>0&&s===0){e.push({type:t==="weapon"?"weaponBroken":"armorBroken",message:t==="weapon"?`${i} has broken—switch weapons or repair it to continue fighting.`:`${i} is shredded! Incoming damage will hit you directly.`});return}n>vi&&s<=vi&&s>0&&e.push({type:t==="weapon"?"weaponDamaged":"armorDamaged",message:t==="weapon"?`${i} is about to fail. Repair it soon to avoid misfires.`:`${i} can barely absorb hits—seek repairs immediately.`})},su=(e,t)=>{const i=e.encumbrance,n=(i==null?void 0:i.attackApMultiplier)??1;if(!Number.isFinite(n))return Number.POSITIVE_INFINITY;const s=Math.ceil(t*Math.max(n,0));return Math.max(0,s)},na=e=>{var t;if("skills"in e){const i=e;if(To(i.encumbrance))return Number.POSITIVE_INFINITY;const n=((t=i.encumbrance)==null?void 0:t.movementApMultiplier)??1;return Number.isFinite(n)?Math.max(1,Math.ceil(Fn*Math.max(n,0))):Number.POSITIVE_INFINITY}return Fn},au=e=>{var t;if("skills"in e){const i=e,n=((t=i.equipped.weapon)==null?void 0:t.apCost)??Je,s=Math.max(0,n);return Ii(i)?0:su(i,s)}return Je},ou=(e,t)=>{const i=Math.abs(e.x-t.x),n=Math.abs(e.y-t.y);return i===1&&n===0||i===0&&n===1},xe=(e,t,i)=>{if(!Number.isFinite(i)||i<=0)return console.warn("[CombatSystem] Invalid attack range:",i),!1;const n=Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));return n>0&&n<=i},ru=(e,t)=>Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)),ie=(e,t)=>Math.abs(t.x-e.x)+Math.abs(t.y-e.y),bi=e=>{try{return eo(e)}catch(t){return console.warn("[CombatSystem] Failed to calculate equipment-aware stats, falling back to base attributes.",t),Ci(e.skills)}},lu=(e,t,i)=>{const n=ea(i),{level:s,attackDirection:a}=ta(e,t,n),o=ru(e.position,t.position);let r=.65-o*.05;if(r+=eu[s],"skills"in e){const d=e,u=bi(d);r+=u.hitChanceModifier/100;const h=Pt(d.equipped.weapon);r+=h.hitChanceBonus;const g=as(d.equipped.weapon),p=Pi(d,g);switch(g){case"smallGuns":{r+=os(p)/100;break}case"energyWeapons":{const m=Mi(p);r+=m.hit/100;break}case"meleeCombat":{const m=Ai(p);r+=m.hit/100;break}case"explosives":{const m=rs(p);r+=m.accuracy/100;break}}za(d.equipped.weapon)&&(r+=Va(d))}if("skills"in t){const d=bi(t);r-=d.dodgeChance/100}const l=tu();l!==0&&(r+=l);const c=Math.max(.1,Math.min(.95,r));return console.log("[CombatSystem] calculateHitChance:",{attacker:e.id,target:t.id,distance:o,attackDirection:a,coverLevel:s,finalHitChance:c}),c},sa=(e,t,i)=>{var D,W,ce,be,zi,Vi,Gi,Ui,Ki,ji;const n=ea(i),s=ta(e,t,n),a=au(e);if(!Number.isFinite(a)||e.actionPoints<a)return{success:!1,damage:0,isCritical:!1,newAttacker:e,newTarget:t,events:void 0};if("skills"in e){const R=e.equipped.weapon;if(R!=null&&R.durability&&R.durability.current<=0)return{success:!1,damage:0,isCritical:!1,newAttacker:e,newTarget:t,events:[{type:"weaponBroken",message:`${R.name} is inoperable—repair or swap weapons before attacking.`}]}}const o=[],r=lu(e,t,n),c=Wn()<=r;let d=0,u=!1,h=e,g;const p=Lt(e.position,t.position);let m,y=1,v=!1,S=!1,M=!1,b=!1,A,k=Pt(),x=0,T=0;if("skills"in e){if(m=e.equipped.weapon,y=zn(m),v=Ge(m,"silenced"),S=Ge(m,"armorPiercing"),M=Ge(m,"energy"),b=Ge(m,"hollowPoint"),k=Pt(m),m){const z=m.magazineSize??0;x=z>0?Math.max(1,Math.round(z*(k.magazineSizeMultiplier??1))):0,T=x>0?Math.min(x,m.currentMagazine??x):0,x>0&&T<=0&&(T=x)}v=v||k.silenced,k.armorPiercingFactor!==void 0&&(S=!0,A=k.armorPiercingFactor)}let H=1,w,I=0;if("skills"in t){const z=t;w=z.equipped.bodyArmor??z.equipped.armor,H=zn(w),I=Math.max(0,Math.round(Za(z)))}if(c){let z=0;if("skills"in e){const R=e,Se=bi(R),V=ki(R),Fe=(m==null?void 0:m.damage)??fi,ha=!m||m.range<=1?Se.meleeDamageBonus:0,$i=as(m),Zi=Pi(R,$i);let lt=Qa(Fe,V,ha);switch($i){case"energyWeapons":{z=Mi(Zi).crit;break}case"meleeCombat":{const we=Ai(Zi);lt+=we.damage;break}}lt=Math.max(0,lt);let ct=y;ct*=k.damageMultiplier??1,ct*=Jd[s.level],b&&(ct*=I>0?.5:1.25),d=Math.round(lt*ct),d=Math.max(0,d),k.critChanceBonus&&(z+=k.critChanceBonus);const Xi=Math.max(0,Math.min(95,Se.criticalChance+z));let Qi=!1;if(!("skills"in t)&&le(R,"executioner")){const we=t;we.maxHealth>0&&we.health<=we.maxHealth*.25&&(d=Math.round(d*1.5),Qi=!0,u=!0)}!Qi&&Xi>0&&Wn()<=Xi/100&&(d=Math.round(d*1.5),u=!0)}else d="damage"in e?e.damage:fi;if("skills"in t&&d>0){let R=Math.round(I*H);S&&R>0&&(R=Math.max(0,Math.floor(R*(A??.5)))),M&&(R=0),R>0&&(d=Ja(d,R))}}if("skills"in t){const z=t,R=qn(z);if(R.health=Math.max(0,z.health-d),c&&(w!=null&&w.durability)){const Se=Ue(w),V=Vn(w,1),Fe=Ue(V);Gn(o,"armor",V.name,Se,Fe),((D=R.equipped.bodyArmor)==null?void 0:D.id)===w.id&&(R.equipped.bodyArmor=V),((W=R.equipped.armor)==null?void 0:W.id)===w.id&&(R.equipped.armor=V),((be=(ce=R.equippedSlots)==null?void 0:ce.bodyArmor)==null?void 0:be.id)===w.id&&(R.equippedSlots.bodyArmor=V)}g=R}else g={...t,health:Math.max(0,t.health-d)};if("skills"in e){const R=qn(e);if(m){const Se=Ue(m),V=Vn(m,1),Fe=Ue(V);if(m.durability&&Gn(o,"weapon",V.name,Se,Fe),x>0){const Yi=Math.max(0,Math.min(x,T-1));V.currentMagazine=Yi}R.equipped.weapon=V,((Vi=(zi=R.equippedSlots)==null?void 0:zi.primaryWeapon)==null?void 0:Vi.id)===m.id&&(R.equippedSlots.primaryWeapon=V),((Ui=(Gi=R.equippedSlots)==null?void 0:Gi.secondaryWeapon)==null?void 0:Ui.id)===m.id&&(R.equippedSlots.secondaryWeapon=V),((ji=(Ki=R.equippedSlots)==null?void 0:Ki.meleeWeapon)==null?void 0:ji.id)===m.id&&(R.equippedSlots.meleeWeapon=V)}m&&m.range>1&&!v&&o.push({type:"weaponNoise",message:`${m.name} echoes loudly—nearby hostiles are on edge.`}),R.actionPoints=Math.max(0,R.actionPoints-a),h=Ua(R)}else h={...e,actionPoints:Math.max(0,e.actionPoints-a)};return{success:c,damage:d,isCritical:u,newAttacker:yi(ia(h,p),n.mapArea),newTarget:yi(g,n.mapArea),events:o.length>0?o:void 0}},Fi=(e,t,i,n,s)=>{const a=na(e);if(!Number.isFinite(a)||e.actionPoints<a||!ou(e.position,t))return!1;const o=s.filter(l=>l.id!==e.id),r=e.id===n.id?{...n,position:{x:-1,y:-1}}:n;return ye(t,i,r,o)},rt=(e,t)=>{const i=na(e);return!Number.isFinite(i)||i===Number.POSITIVE_INFINITY?e:{...e,position:t,actionPoints:Math.max(0,e.actionPoints-i)}};class cu{constructor(t){f(this,"key","input");f(this,"context");f(this,"handlePickupStateSync",t=>{var s;const i=this.getScene(),n=t;!i.sys.isActive()||!i.currentMapArea||(s=n.detail)!=null&&s.areaId&&n.detail.areaId!==i.currentMapArea.id||(i.currentMapArea=this.context.getState().world.currentMapArea,i.renderStaticProps())});f(this,"handlePathPreview",t=>{const i=this.getScene();if(!i.sys.isActive())return;const s=t.detail;if(!s){this.clearPathPreview();return}if(!i.currentMapArea||s.areaId!==i.currentMapArea.id){this.clearPathPreview();return}if(i.pathGraphics.clear(),!s.path||s.path.length===0)return;const{tileWidth:a,tileHeight:o}=i.getIsoMetrics(),r=s.path.length;s.path.forEach((c,d)=>{const u=i.calculatePixelPosition(c.x,c.y),h=d===s.path.length-1?.8:.55,g=i.getDiamondPoints(u.x,u.y,a*h,o*h);let p,m;d===s.path.length-1?(p=16762967,m=.5):r<=3?(p=3462041,m=.32):r<=6?(p=16498468,m=.35):r<=9?(p=16486972,m=.38):(p=16281969,m=.4),i.pathGraphics.fillStyle(p,m),i.pathGraphics.fillPoints(g,!0)});const l=s.path[s.path.length-1];this.renderCoverPreview(l)});this.scene=t}init(t){this.context=t}onCreate(){this.context.listenWindow(gi,this.handlePathPreview),this.context.listenWindow($d,this.handlePickupStateSync),this.context.listenInput("pointerdown",this.handlePointerDown,this)}handlePointerDown(t){const i=this.getScene();if(!i.currentMapArea||!i.sys.isActive()||!t.leftButtonDown())return;const n=i.cameras.main.getWorldPoint(t.x,t.y),s=i.worldToGrid(n.x,n.y);if(!s)return;const{x:a,y:o}=s;if(a<0||o<0||a>=i.currentMapArea.width||o>=i.currentMapArea.height)return;const r=i.currentMapArea.tiles[o][a];!r.isWalkable&&r.type!==E.DOOR||window.dispatchEvent(new CustomEvent(Vd,{detail:{position:s,areaId:i.currentMapArea.id}}))}clearPathPreview(){var i;(i=this.getScene().pathGraphics)==null||i.clear(),this.renderCoverPreview()}renderCoverPreview(t){var v;const i=this.getScene();if(!i.coverDebugGraphics)return;if(i.coverDebugGraphics.clear(),!t||!i.currentMapArea){i.coverDebugGraphics.setVisible(!1);return}const n=i.lastPlayerGridPosition??i.playerInitialPosition;if(!n){i.coverDebugGraphics.setVisible(!1);return}const s=(v=i.currentMapArea.tiles[t.y])==null?void 0:v[t.x];if(!(s!=null&&s.cover)){i.coverDebugGraphics.setVisible(!1);return}const a=Lt(t,n),o=s.cover[a];if(!o||o==="none"){i.coverDebugGraphics.setVisible(!1);return}const{tileWidth:r,tileHeight:l}=i.getIsoMetrics(),c=i.calculatePixelPosition(t.x,t.y),d=i.getDiamondPoints(c.x,c.y,r*.7,l*.7),[u,h,g,p]=d,m=o==="full"?3718648:16498468,y=o==="full"?.35:.25;switch(i.coverDebugGraphics.fillStyle(m,y),a){case"north":i.coverDebugGraphics.fillTriangle(u.x,u.y,h.x,h.y,p.x,p.y);break;case"south":i.coverDebugGraphics.fillTriangle(g.x,g.y,h.x,h.y,p.x,p.y);break;case"east":i.coverDebugGraphics.fillTriangle(h.x,h.y,u.x,u.y,g.x,g.y);break;case"west":i.coverDebugGraphics.fillTriangle(p.x,p.y,g.x,g.y,u.x,u.y);break}i.coverDebugGraphics.fillCircle(c.x,c.y,l*.08),i.coverDebugGraphics.setVisible(!0)}getScene(){return this.scene}}const ue=(e,t,i)=>i<t?t:Math.min(Math.max(e,t),i),Ke=(e,t=4)=>{const i=10**t;return Math.round(e*i)/i},Un=2,du=(e,t,i,n,s)=>{const a=e.map(r=>`${r.id}:${r.position.x}:${r.position.y}:${r.health}`).join("|"),o=t.map(r=>`${r.id}:${r.position.x}:${r.position.y}`).join("|");return`${i??"player"}:${n}:${s}::${a}::${o}`},uu=e=>e.map(t=>`${t.id}:${t.x}:${t.y}:${t.status}`).join("|"),hu=()=>typeof window>"u"?1:window.devicePixelRatio||1,pu=(e,t,i)=>{const n=t/Math.max(1,e.width),s=i/Math.max(1,e.height),a=Math.min(n,s),o=Math.max(.6,Math.min(4,a||Un));return Number.isFinite(o)&&o>0?o:Un},mu=(e,t)=>{const i=Math.max(1,t.width),n=Math.max(1,t.height),s=Math.max(1e-4,e.width),a=Math.max(1e-4,e.height),o=e.x+s/2,r=e.y+a/2,l=.001,c=Math.max(l,s),d=Math.max(l,a),u=Math.min(i,c),h=Math.min(n,d),g=u/2,p=h/2,m=g,y=Math.max(g,i-g),v=p,S=Math.max(p,n-p),M=ue(o,m,y),b=ue(r,v,S),A=Ke(u),k=Ke(h),x=ue(M,A/2,Math.max(A/2,i-A/2)),T=ue(b,k/2,Math.max(k/2,n-k/2)),H=ue(Ke(x-A/2),0,Math.max(0,i-A)),w=ue(Ke(T-k/2),0,Math.max(0,n-k));return{x:H,y:w,width:A,height:k,zoom:e.zoom}};class gu{constructor(t){f(this,"scene",null);f(this,"viewport",null);f(this,"tileSignature",null);f(this,"config");f(this,"lastRenderState",null);this.config={maxCanvasWidth:(t==null?void 0:t.maxCanvasWidth)??180,maxCanvasHeight:(t==null?void 0:t.maxCanvasHeight)??160,minZoom:(t==null?void 0:t.minZoom)??.6,maxZoom:(t==null?void 0:t.maxZoom)??3}}bindScene(t){this.scene=t}setViewport(t){this.viewport=t}setCanvasBounds(t,i){const n=Number.isFinite(t)?Math.floor(t):0,s=Number.isFinite(i)?Math.floor(i):0;if(n<=0||s<=0)return!1;const a=ue(n,120,4096),o=ue(s,80,4096);return a===this.config.maxCanvasWidth&&o===this.config.maxCanvasHeight?!1:(this.config={...this.config,maxCanvasWidth:a,maxCanvasHeight:o},!0)}compose(t,i,n){var w,I;const s=t.world.currentMapArea;if(!s)return null;const a=pu(s,this.config.maxCanvasWidth,this.config.maxCanvasHeight),o=Ke(a*ue(i,this.config.minZoom,this.config.maxZoom)),r=Math.ceil(s.width*o),l=Math.ceil(s.height*o),c=hu(),d=t.player.data,u=t.world.currentMapArea.entities.enemies,h=t.world.currentMapArea.entities.npcs,g=t.world.currentMapArea.entities.items,p=t.surveillance.zones[s.id],m=du(u,h,d.id,d.position.x,d.position.y),y=p?this.buildCameras(p.cameras):[],v=this.createCameraSignature(y),S=s.tiles;let M=((w=this.tileSignature)==null?void 0:w.version)??0;(!this.tileSignature||this.tileSignature.areaId!==s.id||this.tileSignature.ref!==S)&&(M+=1,this.tileSignature={areaId:s.id,ref:S,version:M});const b=this.viewport??{x:0,y:0,width:Math.min(s.width,Math.ceil(s.width*.4)),height:Math.min(s.height,Math.ceil(s.height*.4)),zoom:this.scene?this.scene.cameras.main.zoom:1},A=mu(b,s);this.viewport=A;const k=this.buildObjectives(g),x=uu(k),T=n&&n.length?n.map(D=>`${D.x}:${D.y}`).join("|"):"",H={version:(((I=this.lastRenderState)==null?void 0:I.version)??0)+1,areaId:s.id,areaName:s.name,mapWidth:s.width,mapHeight:s.height,logicalWidth:r,logicalHeight:l,tileScale:o,devicePixelRatio:c,baseTileScale:a,userZoom:o/a,tileVersion:M,tiles:S,entities:this.buildEntities(d.id??"player",d.position.x,d.position.y,u,h),entitiesSignature:m,cameras:y,camerasSignature:v,viewport:A,curfewActive:t.world.curfewActive,timestamp:Date.now(),path:n??void 0,pathSignature:T,objectiveMarkers:k,objectivesSignature:x,dirtyLayers:this.resolveDirtyLayers({tileVersion:M,entitySignature:m,cameraSignature:v,objectivesSignature:x,pathSignature:T,viewport:A,curfewActive:t.world.curfewActive,tileScale:o,areaId:s.id})};return this.lastRenderState=H,H}buildEntities(t,i,n,s,a){const o=[{id:t,kind:"player",x:i,y:n,status:"active"}];return s.forEach(r=>{o.push({id:r.id,kind:"enemy",x:r.position.x,y:r.position.y,status:r.health>0?"active":"inactive"})}),a.forEach(r=>{o.push({id:r.id,kind:"npc",x:r.position.x,y:r.position.y,status:"active"})}),o}buildCameras(t){return Object.values(t).map(i=>({id:i.id,type:i.type,x:i.position.x,y:i.position.y,alertState:i.alertState,isActive:i.isActive}))}createCameraSignature(t){return t.length?t.map(i=>`${i.id}:${i.type}:${i.x}:${i.y}:${i.alertState}:${i.isActive?1:0}`).join("|"):""}buildObjectives(t){return t.filter(i=>!!i.position).map(i=>({id:i.id,label:i.name,x:i.position.x,y:i.position.y,status:"active"}))}resolveDirtyLayers(t){const i=this.lastRenderState;if(!i)return{tiles:!0,overlays:!0,entities:!0,viewport:!0,path:!!t.pathSignature};const n=i.areaId!==t.areaId,s=i.tileScale!==t.tileScale,a=n||i.tileVersion!==t.tileVersion||s,o=n||i.camerasSignature!==t.cameraSignature||s,r=n||i.entitiesSignature!==t.entitySignature||s||o,l=n||i.objectivesSignature!==t.objectivesSignature||s,c=n||i.viewport.x!==t.viewport.x||i.viewport.y!==t.viewport.y||i.viewport.width!==t.viewport.width||i.viewport.height!==t.viewport.height||i.viewport.zoom!==t.viewport.zoom||i.tileScale!==t.tileScale,d=i.pathSignature!==t.pathSignature||s,u=n||i.curfewActive!==t.curfewActive||l||c;return{tiles:a,overlays:u,entities:r||l,viewport:c,path:d}}}const fu=typeof window<"u"?window.requestAnimationFrame.bind(window):void 0,Kn=typeof window<"u"?window.cancelAnimationFrame.bind(window):void 0,yu=(e,t,i)=>i<t?t:Math.min(Math.max(e,t),i);class vu extends EventTarget{constructor(){super(...arguments);f(this,"scene",null);f(this,"storeUnsubscribe",null);f(this,"pendingFrame",null);f(this,"pendingStoreUpdate",!1);f(this,"pendingViewportUpdate",!1);f(this,"controller",new gu);f(this,"lastState",null);f(this,"userZoom",1);f(this,"minZoom",.6);f(this,"maxZoom",3);f(this,"lastPath",null);f(this,"raf",fu);f(this,"handlePathPreview",i=>{const n=i.detail,a=O.getState().world.currentMapArea;if(!a||n.areaId!==a.id)return;const o=n.path??[];this.lastPath=o.length?o:null,this.pendingStoreUpdate=!0,this.scheduleBroadcast()})}initialize(i){this.scene!==i&&(this.shutdown(),this.scene=i,this.controller.bindScene(i),this.storeUnsubscribe=O.subscribe(()=>{this.pendingStoreUpdate=!0,this.scheduleBroadcast()}),typeof window<"u"&&window.addEventListener(gi,this.handlePathPreview),this.pendingStoreUpdate=!0,this.scheduleBroadcast(!0))}shutdown(){this.storeUnsubscribe&&(this.storeUnsubscribe(),this.storeUnsubscribe=null),this.pendingFrame!==null&&this.raf&&Kn&&Kn(this.pendingFrame),this.pendingFrame=null,this.controller.bindScene(null),this.scene=null,typeof window<"u"&&window.removeEventListener(gi,this.handlePathPreview)}getState(){return this.lastState}updateViewport(i){this.controller.setViewport({x:i.x,y:i.y,width:i.width,height:i.height,zoom:i.zoom}),this.pendingViewportUpdate=!0,this.scheduleBroadcast()}emitInteraction(i){if(this.scene)switch(i.type){case Gd:{const n=i.animate??!0;this.scene.focusCameraOnGridPosition(i.gridX,i.gridY,n);break}case jd:{const n=i.animate??!0;this.scene.focusCameraOnGridPosition(i.target.x,i.target.y,n);break}}}setZoom(i){const n=yu(i,this.minZoom,this.maxZoom);Math.abs(n-this.userZoom)<1e-4||(this.userZoom=n,this.pendingStoreUpdate=!0,this.dispatchEvent(new CustomEvent(Kd,{detail:{zoom:this.userZoom}})),this.scheduleBroadcast())}adjustZoom(i){this.setZoom(this.userZoom+i)}getZoom(){return this.userZoom}centerOnPlayer(i=!0){if(!this.scene)return;const s=O.getState().player.data.position;this.scene.focusCameraOnGridPosition(s.x,s.y,i)}setCanvasBounds(i,n){this.controller.setCanvasBounds(i,n)&&(this.pendingStoreUpdate=!0,this.scheduleBroadcast())}requestImmediateState(){this.pendingStoreUpdate=!0,this.scheduleBroadcast(!0)}scheduleBroadcast(i=!1){if(i||!this.raf){this.broadcast();return}this.pendingFrame===null&&(this.pendingFrame=this.raf(()=>{this.pendingFrame=null,this.broadcast()}))}composeState(){return this.controller.compose(O.getState(),this.userZoom,this.lastPath)}broadcast(){if(!this.pendingStoreUpdate&&!this.pendingViewportUpdate)return;const i=this.composeState();if(this.pendingStoreUpdate=!1,this.pendingViewportUpdate=!1,!i)return;const n=this.shouldEmit(i);this.lastState=i,n&&this.dispatchEvent(new CustomEvent(Ud,{detail:i}))}shouldEmit(i){if(!this.lastState)return!0;const n=this.lastState;if(i.areaId!==n.areaId)return!0;const s=i.dirtyLayers;return s.tiles||s.entities||s.overlays||s.viewport||s.path}}const Yt=new vu;class bu{constructor(t){f(this,"key","minimapBridge");this.scene=t}init(t){}onCreate(){Yt.initialize(this.scene)}onShutdown(){Yt.shutdown()}emitViewportUpdate(){const t=this.getScene();if(!t.currentMapArea||!t.sys.isActive())return;const i=t.cameras.main,n=i.worldView,s=t.worldToGridContinuous(n.x,n.y),a=t.worldToGridContinuous(n.x+n.width,n.y),o=t.worldToGridContinuous(n.x,n.y+n.height),r=t.worldToGridContinuous(n.x+n.width,n.y+n.height);if(!s||!a||!o||!r)return;const l=(s.x+a.x+o.x+r.x)/4,c=(s.y+a.y+o.y+r.y)/4,d=[Math.abs(a.x-s.x),Math.abs(r.x-o.x)].filter(v=>Number.isFinite(v)),u=[Math.abs(o.y-s.y),Math.abs(r.y-a.y)].filter(v=>Number.isFinite(v)),h=d.length?d.reduce((v,S)=>v+S,0)/d.length:0,g=u.length?u.reduce((v,S)=>v+S,0)/u.length:0,p=Math.max(1e-4,h),m=Math.max(1e-4,g),y={x:l-p/2,y:c-m/2,width:p,height:m};Yt.updateViewport({...y,zoom:i.zoom})}getScene(){return this.scene}}class Su{constructor(t){f(this,"key","stateSync");this.scene=t}init(){}onStateChange(t,i){var h,g,p,m;const n=this.getScene();if(!n.sys.isActive()||!n.currentMapArea)return;const s=i.player.data,a=i.world,o=a.currentMapArea.entities.enemies,r=n.inCombat;if(n.inCombat=a.inCombat,n.inCombat&&!r&&n.zoomCameraForCombat(),!n.inCombat&&r&&(n.restoreCameraAfterCombat(),n.destroyPlayerVitalsIndicator(),n.enemySprites.forEach(y=>{y.healthBar.clear(),y.healthBar.setVisible(!1)}),n.npcSprites.forEach(y=>{y.indicator&&(y.indicator.destroy(),y.indicator=void 0)})),n.currentGameTime=a.currentTime,n.updateDayNightOverlay(),!a.currentMapArea||!n.currentMapArea)return;n.currentMapArea.id!==a.currentMapArea.id&&(n.hasInitialZoomApplied=!1,n.userAdjustedZoom=!1,n.preCombatZoom=null,n.preCombatUserAdjusted=!1,n.pendingRestoreUserAdjusted=null,n.currentMapArea=a.currentMapArea,n.enemySprites.forEach(y=>{y.token.container.destroy(!0),y.healthBar.destroy(),y.nameLabel.destroy()}),n.enemySprites.clear(),n.npcSprites.forEach(y=>{y.token.container.destroy(!0),y.nameLabel.destroy(),y.indicator&&y.indicator.destroy()}),n.npcSprites.clear(),n.destroyCameraSprites(),n.currentAtmosphereProfile=void 0,n.lastAtmosphereRedrawBucket=-1,n.setupCameraAndMap(),n.clearPathPreview(),n.enablePlayerCameraFollow());const l=n.lastItemMarkerSignature;n.currentMapArea=a.currentMapArea;const c=n.getItemMarkerSignature(n.currentMapArea);l!==c&&n.renderStaticProps(),n.curfewActive!==a.curfewActive&&(n.curfewActive=a.curfewActive),n.updatePlayerPosition(s.position),n.updatePlayerVitalsIndicator(s.position,s.health,s.maxHealth),n.updateEnemies(o),n.updateNpcs(a.currentMapArea.entities.npcs),n.renderVisionCones();const d=(g=(h=i.surveillance)==null?void 0:h.zones)==null?void 0:g[n.currentMapArea.id],u=((m=(p=i.surveillance)==null?void 0:p.hud)==null?void 0:m.overlayEnabled)??!1;n.updateSurveillanceCameras(d,u)}getScene(){return this.scene}}const Re={suspicionThreshold:30,investigationThreshold:60,alarmThreshold:100,progressGainPerTick:10,progressDecayPerTick:5,reinforcementDelay:2e3},aa=(e,t,i)=>{const n=t.x-e.x,s=t.y-e.y;if(Math.sqrt(n*n+s*s)>i.range)return!1;const r=(Math.atan2(s,n)*(180/Math.PI)+360)%360,l=(i.direction+360)%360;let c=Math.abs(r-l);return c>180&&(c=360-c),c<=i.angle/2},oa=(e,t,i)=>{const n=wu(e,t);for(const s of n){if(s.x===e.x&&s.y===e.y||s.x===t.x&&s.y===t.y)continue;if(s.x<0||s.y<0||s.y>=i.height||s.x>=i.width)return!1;const a=i.tiles[s.y][s.x];if(!a.isWalkable&&a.type!=="cover")return!1}return!0},wu=(e,t)=>{const i=[];let n=Math.floor(e.x),s=Math.floor(e.y);const a=Math.floor(t.x),o=Math.floor(t.y),r=Math.abs(a-n),l=Math.abs(o-s),c=n<a?1:-1,d=s<o?1:-1;let u=r-l;for(;i.push({x:n,y:s}),!(n===a&&s===o);){const h=2*u;h>-l&&(u-=l,n+=c),h<r&&(u+=r,s+=d)}return i},ra=(e,t,i)=>!e.visionCone||!aa(e.position,t.position,e.visionCone)?!1:oa(e.position,t.position,i),Pu=(e,t,i=1)=>{const n=e.alertProgress??0;let s=n;if(t){const r=Re.progressGainPerTick*Math.max(0,i);s=Math.min(100,n+r)}else s=Math.max(0,n-Re.progressDecayPerTick);let a=L.IDLE;s>=Re.alarmThreshold?a=L.ALARMED:s>=Re.investigationThreshold?a=L.INVESTIGATING:s>=Re.suspicionThreshold&&(a=L.SUSPICIOUS);const o=t?void 0:e.lastKnownPlayerPosition;return{...e,alertProgress:s,alertLevel:a,lastKnownPlayerPosition:o}},Mu=(e,t)=>{if(!e.visionCone)return e;const i=t.x-e.position.x,n=t.y-e.position.y,a=(Math.atan2(n,i)*(180/Math.PI)+360)%360;return{...e,visionCone:{...e.visionCone,direction:a}}},Au=(e,t,i)=>{const n=[],{range:s}=t;for(let a=-s;a<=s;a++)for(let o=-s;o<=s;o++){const r={x:e.x+o,y:e.y+a};r.x<0||r.y<0||r.y>=i.height||r.x>=i.width||aa(e,r,t)&&oa(e,r,i)&&n.push(r)}return n},jn=P.Math.DEG_TO_RAD,We={[J.IDLE]:{fill:3900150,alpha:.15},[J.SUSPICIOUS]:{fill:16436245,alpha:.22},[J.ALARMED]:{fill:15680580,alpha:.3},[J.DISABLED]:{fill:6583435,alpha:.12}};class xu extends P.GameObjects.Container{constructor(i,n,s,a){super(i,n,s);f(this,"housing");f(this,"lens");f(this,"led");f(this,"cone");f(this,"ledTween",null);f(this,"rangePixels");f(this,"fieldOfView");f(this,"direction");f(this,"tileSize");f(this,"isActiveSprite",!1);f(this,"alertState",J.DISABLED);f(this,"overlayVisible",!1);const{tileSize:o,rangeTiles:r,fieldOfView:l,initialDirection:c}=a;this.tileSize=o,this.fieldOfView=l,this.direction=c,this.rangePixels=r*o,this.housing=i.add.rectangle(0,0,o*.5,o*.35,3355443,1),this.housing.setOrigin(.5,.5),this.lens=i.add.ellipse(o*.15,0,o*.22,o*.16,0,1),this.lens.setStrokeStyle(1,2042167,.6),this.led=i.add.circle(-o*.18,-o*.08,o*.12,16711680,1),this.led.setAlpha(0),this.cone=i.add.graphics(),this.cone.setAlpha(0),this.cone.setDepth(-1),this.add([this.cone,this.housing,this.lens,this.led]),this.setSize(o,o),this.scene.add.existing(this),this.drawVisionCone(),this.setAlertState(J.DISABLED)}setActiveState(i){this.isActiveSprite!==i&&(this.isActiveSprite=i,i?this.ledTween?this.ledTween.resume():this.ledTween=this.scene.tweens.add({targets:this.led,alpha:{from:1,to:.3},duration:1e3,ease:"Sine.easeInOut",yoyo:!0,repeat:-1}):(this.ledTween&&this.ledTween.pause(),this.led.setAlpha(0)),this.refreshConeAlpha())}setAlertState(i){this.alertState=i;const{fill:n}=We[i];this.drawVisionCone(n),this.isActiveSprite&&i!==J.DISABLED?this.led.setFillStyle(i===J.ALARMED?16731471:2282478,1):i===J.DISABLED&&this.led.setFillStyle(6583435,.8),this.refreshConeAlpha()}setDirection(i){this.direction=i,this.drawVisionCone(),this.refreshConeAlpha()}setRangeTiles(i){this.rangePixels=i*this.tileSize,this.drawVisionCone(),this.refreshConeAlpha()}updateVision(i){this.cone.setPosition(i.x-this.x,i.y-this.y)}setOverlayVisible(i){this.overlayVisible!==i&&(this.overlayVisible=i,this.refreshConeAlpha())}destroy(i){this.ledTween&&(this.ledTween.stop(),this.ledTween.remove(),this.ledTween=null),super.destroy(i)}drawVisionCone(i){const n=i??We[this.alertState].fill;this.cone.clear();const s=(this.direction-this.fieldOfView/2)*jn,a=(this.direction+this.fieldOfView/2)*jn;this.cone.fillStyle(n,We[this.alertState].alpha),this.cone.slice(0,0,this.rangePixels,s,a,!1),this.cone.fillPath(),this.cone.lineStyle(1.2,n,Math.min(.65,We[this.alertState].alpha+.1)),this.cone.beginPath(),this.cone.moveTo(0,0),this.cone.arc(0,0,this.rangePixels,s,a,!1),this.cone.closePath(),this.cone.strokePath()}refreshConeAlpha(){const n=this.isActiveSprite&&this.overlayVisible&&this.alertState!==J.DISABLED?We[this.alertState].alpha:0;this.cone.setAlpha(n)}}class Iu{constructor(t){f(this,"key","surveillanceRender");f(this,"cameraSprites",new Map);this.scene=t}init(t){}onShutdown(){this.clearCameraSprites()}clearCameraSprites(){this.cameraSprites.forEach(t=>{t.destroy(!0)}),this.cameraSprites.clear()}renderVisionCones(){const t=this.getScene();if(!t.currentMapArea||!t.visionConeGraphics)return;const i=t.visionConeGraphics;i.clear();const n=t.currentMapArea.entities.enemies,s=t.getIsoMetrics();n.forEach(a=>{if(!a.visionCone||a.health<=0)return;const o=Au(a.position,a.visionCone,t.currentMapArea);if(o.length===0)return;let r=16776960,l=.1;switch(a.alertLevel){case L.SUSPICIOUS:r=16755200,l=.15;break;case L.INVESTIGATING:r=16737792,l=.2;break;case L.ALARMED:r=16711680,l=.25;break;default:r=16776960,l=.1}i.fillStyle(r,l),o.forEach(c=>{const d=t.calculatePixelPosition(c.x,c.y),u=[d.x,d.y-s.tileHeight/2,d.x+s.tileWidth/2,d.y,d.x,d.y+s.tileHeight/2,d.x-s.tileWidth/2,d.y];i.fillPoints(u,!0)})})}updateSurveillanceCameras(t,i=!1){const n=this.getScene();if(!t||!n.currentMapArea){this.cameraSprites.size>0&&this.clearCameraSprites();return}const s=new Set(this.cameraSprites.keys()),a=n.getIsoMetrics();Object.values(t.cameras).forEach(o=>{s.delete(o.id);const r=n.calculatePixelPosition(o.position.x,o.position.y);let l=this.cameraSprites.get(o.id);l?(l.setPosition(r.x,r.y),l.setRangeTiles(o.range)):(l=new xu(this.scene,r.x,r.y,{tileSize:n.tileSize,rangeTiles:o.range,fieldOfView:o.fieldOfView,initialDirection:o.currentDirection}),this.cameraSprites.set(o.id,l));const c=B.PROP_TALL+Math.round(a.tileHeight*.5);n.syncDepth(l,r.x,r.y,c),l.setOverlayVisible(i),l.setActiveState(o.isActive),l.setAlertState(o.alertState),l.setDirection(o.currentDirection)}),s.forEach(o=>{const r=this.cameraSprites.get(o);r&&r.destroy(!0),this.cameraSprites.delete(o)})}getScene(){return this.scene}}class ku{constructor(t,i){f(this,"wetReflectionAlpha");f(this,"emissiveIntensity");this.graphics=t,this.theme=i,this.wetReflectionAlpha=i.qualityBudget.wetReflectionAlpha,this.emissiveIntensity=.35}setAtmosphereProfile(t){this.wetReflectionAlpha=P.Math.Clamp(t.wetReflectionAlpha,0,.4),this.emissiveIntensity=P.Math.Clamp(t.emissiveIntensity,0,1)}drawTile(t,i){const n=i.groundOnly?{...t,type:E.FLOOR}:t,s=this.getTileBaseColor(n,i.gridX,i.gridY),a=((i.gridX*13^i.gridY*9)%9-4)*.01,o=C(s,a);if(this.drawGround(n,i,o),!i.groundOnly)switch(t.type){case E.COVER:this.drawCover(t,i,o);break;case E.WALL:this.drawWallVolume(t,i,o);break;case E.DOOR:this.drawDoorPortal(t,i,o);break;case E.WATER:case E.TRAP:this.drawHazardVariant(t,i,o);break}}drawGround(t,i,n){const s=this.getPoints(i.center.x,i.center.y,i.tileWidth,i.tileHeight),o=((Math.floor(i.gridX/4)^Math.floor(i.gridY/4))%5-2)*.03,r=C(n,o),l=C(r,.2),c=C(r,-.22);this.graphics.fillStyle(r,1),this.graphics.fillPoints(s,!0);const[d,u,h,g]=s,p=new P.Geom.Point(i.center.x,i.center.y);this.graphics.fillStyle(l,.35),this.graphics.fillPoints([d,u,p],!0),this.graphics.fillPoints([d,p,g],!0),this.graphics.fillStyle(c,.3),this.graphics.fillPoints([h,u,p],!0),this.graphics.fillPoints([h,p,g],!0),this.graphics.lineStyle(1,C(r,-.3),.42),this.graphics.strokePoints(s,!0),t.type===E.FLOOR?(i.gridX%5===0||i.gridY%5===0?(this.graphics.lineStyle(1.1,6809849,.12),this.graphics.strokePoints([d,p,h],!1),this.graphics.strokePoints([g,p,u],!1)):(i.gridX+i.gridY)%4===0&&(this.graphics.lineStyle(.85,3718648,.08),this.graphics.strokePoints(s,!0)),this.drawRoadReflection(t,i,s)):(t.type===E.COVER||t.type===E.WALL)&&(this.graphics.lineStyle(.9,16317180,.08),this.graphics.strokePoints(s,!0))}drawCover(t,i,n){const s=this.getElevationProfile(.5,i.tileWidth,i.tileHeight),a=this.getPoints(i.center.x,i.center.y,i.tileWidth,i.tileHeight),o=this.getPoints(i.center.x,i.center.y-s.heightOffset,s.topWidth,s.topHeight),r=[a[1],a[2],o[2],o[1]],l=[a[2],a[3],o[3],o[2]];this.graphics.fillStyle(C(n,-.15),.98),this.graphics.fillPoints(l,!0),this.graphics.fillStyle(C(n,-.08),.98),this.graphics.fillPoints(r,!0),this.graphics.fillStyle(C(n,.2),.95),this.graphics.fillPoints(o,!0),this.graphics.lineStyle(1.1,16498468,.3),this.graphics.strokePoints(o,!0)}drawWallVolume(t,i,n){const s=this.getElevationProfile(1.2,i.tileWidth,i.tileHeight),a=this.getPoints(i.center.x,i.center.y,i.tileWidth,i.tileHeight),o=this.getPoints(i.center.x,i.center.y-s.heightOffset,s.topWidth,s.topHeight),r=[a[1],a[2],o[2],o[1]],l=[a[2],a[3],o[3],o[2]];this.graphics.fillStyle(C(n,-.28),1),this.graphics.fillPoints(l,!0),this.graphics.fillStyle(C(n,-.16),1),this.graphics.fillPoints(r,!0);const c=C(n,.18);this.graphics.fillStyle(c,1),this.graphics.fillPoints(o,!0),this.graphics.lineStyle(1.2,2282478,.18),this.graphics.strokePoints(o,!0);const[d,u,h,g]=a,[p,m,y,v]=o;this.graphics.lineStyle(1,8246268,.2),this.graphics.strokePoints([g,v],!1),this.graphics.strokePoints([h,y],!1),this.graphics.strokePoints([u,m],!1),this.graphics.strokePoints([d,p],!1)}drawDoorPortal(t,i,n){const s=this.getPoints(i.center.x,i.center.y,i.tileWidth,i.tileHeight),[a,o,r,l]=s,c=this.lerpPoint(a,l,.22),d=this.lerpPoint(a,o,.22),u=this.lerpPoint(r,o,.3),h=this.lerpPoint(r,l,.3);this.graphics.fillStyle(C(n,-.2),.96),this.graphics.fillPoints([c,d,u,h],!0);const g=this.lerpPoint(c,h,.12),p=this.lerpPoint(d,u,.12),m=this.lerpPoint(d,u,.86),y=this.lerpPoint(c,h,.86);this.graphics.fillStyle(988970,.84),this.graphics.fillPoints([g,p,m,y],!0),this.graphics.lineStyle(1.3,3718648,.4),this.graphics.strokePoints([g,p],!1)}drawHazardVariant(t,i,n){const s=this.getPoints(i.center.x,i.center.y,i.tileWidth*.72,i.tileHeight*.72);if(t.type===E.WATER){const o=this.theme.qualityBudget.enableAnimatedHazards?.22+.12*(.5+.5*Math.sin(Date.now()%2e3/2e3*Math.PI*2)):.2;this.graphics.fillStyle(C(n,.2),o),this.graphics.fillPoints(s,!0),this.graphics.lineStyle(1,6809849,.22),this.graphics.strokePoints(s,!0);return}const a=this.theme.qualityBudget.enableAnimatedHazards?.18+.1*(.5+.5*Math.sin(Date.now()%1500/1500*Math.PI*2)):.18;this.graphics.fillStyle(C(n,.35),a),this.graphics.fillPoints(s,!0),this.graphics.lineStyle(1.1,16020150,.35),this.graphics.strokePoints(s,!0)}getTileBaseColor(t,i,n){const s=(i+n)%2===0,a=this.theme.tilePalettes;switch(t.type){case E.WALL:return s?a.wallEven:a.wallOdd;case E.COVER:return s?a.coverEven:a.coverOdd;case E.WATER:return s?a.waterEven:a.waterOdd;case E.TRAP:return s?a.trapEven:a.trapOdd;case E.DOOR:return s?a.doorEven:a.doorOdd;default:return s?a.floorEven:a.floorOdd}}getElevationProfile(t,i,n){return{heightOffset:n*(.48+t*.78),topWidth:i*Math.max(.7,1-t*.08),topHeight:n*Math.max(.62,1-t*.1)}}lerpPoint(t,i,n){return new P.Geom.Point(P.Math.Linear(t.x,i.x,n),P.Math.Linear(t.y,i.y,n))}getPoints(t,i,n,s){return K(t,i,n,s).map(a=>new P.Geom.Point(a.x,a.y))}drawRoadReflection(t,i,n){if(!t.isWalkable||this.wetReflectionAlpha<=.01)return;const[s,a,o,r]=n,l=((i.gridX*11+i.gridY*17)%9-4)*.04,c=P.Math.Clamp(this.wetReflectionAlpha*(.7+this.emissiveIntensity*.65),.03,.28),d=C(6809849,-.12+l),u=C(16486972,-.25+l*.7);this.graphics.lineStyle(1,d,c),this.graphics.strokePoints([this.lerpPoint(r,s,.3),this.lerpPoint(o,a,.3)],!1),this.graphics.lineStyle(.8,u,c*.6),this.graphics.strokePoints([this.lerpPoint(s,a,.55),this.lerpPoint(r,o,.55)],!1)}}class Cu{constructor(t,i){this.scene=t,this.theme=i}createMassing(t,i,n){const s=this.scene.add.container(n.center.x,n.center.y),a=this.scene.add.graphics(),o=this.scene.add.graphics(),r=this.scene.add.graphics(),l=this.toLocal(n.center,n.footprint),c=n.widthTiles+n.depthTiles,d=i.district==="downtown"?.78:.7,u=n.tileHeight*Math.max(.58,i.massingHeight*d),h=i.district==="downtown"?.03:.015,g=this.createRoof(l,u,h);return this.drawBaseShadow(a,l),this.drawBody(o,r,i,l,g),this.drawDistrictDetails(r,i,l,g,c),s.add([a,o,r]),s}createLabel(t,i,n,s){const a=this.scene.add.container(i.x,i.y-n*.24),o=this.scene.add.text(0,0,t.name,{fontFamily:'Orbitron, "DM Sans", sans-serif',fontSize:this.theme.qualityBudget.enableHighDensityLabels?"13px":"11px",fontStyle:"700",color:s.signagePrimaryHex,stroke:s.signageSecondaryHex,strokeThickness:1.6,align:"center"});o.setOrigin(.5),o.setShadow(0,0,s.glowHex,8,!0,!0);const c=this.scene.add.rectangle(0,0,o.width+14,o.height+8,this.hexToColor(s.backdropHex),.58);return c.setStrokeStyle(1.1,this.hexToColor(s.signageSecondaryHex),.72),a.add([c,o]),a}drawBaseShadow(t,i){t.fillStyle(132622,.14),t.fillPoints([i.top,i.right,i.bottom,i.left],!0)}drawBody(t,i,n,s,a){const o=[s.right,s.bottom,a.bottom,a.right],r=[s.bottom,s.left,a.left,a.bottom],l=[s.left,s.top,a.top,a.left],c=this.hexToColor(n.backdropHex),d=C(c,-.06),u=C(c,-.13),h=C(c,-.1),g=C(c,.03);t.fillStyle(h,.72),t.fillPoints(l,!0),t.fillStyle(d,.74),t.fillPoints(o,!0),t.fillStyle(u,.78),t.fillPoints(r,!0),t.fillStyle(g,.8),t.fillPoints([a.top,a.right,a.bottom,a.left],!0),t.lineStyle(1.2,this.hexToColor(n.trimHex),.24),t.strokePoints([a.top,a.right,a.bottom,a.left],!0),i.lineStyle(1,this.hexToColor(n.trimHex),.16),i.strokePoints([s.bottom,a.bottom],!1),i.strokePoints([s.left,a.left],!1),i.strokePoints([s.right,a.right],!1)}drawDistrictDetails(t,i,n,s,a){const o=[n.right,n.bottom,s.bottom,s.right],r=[n.bottom,n.left,s.left,s.bottom];if(i.district==="downtown"){const g=Math.max(4,Math.min(10,Math.floor(a*.8))),p=Math.max(3,Math.min(8,Math.floor(i.massingHeight*1.7))),m=this.hexToColor(i.signageSecondaryHex);this.drawFaceGrid(t,r,g,p,m,.2),this.drawFaceGrid(t,o,g,p,m,.16),t.lineStyle(1,this.hexToColor(i.signagePrimaryHex),.36),t.strokePoints([s.left,s.bottom,s.right],!1);return}const l=this.hexToColor(i.accentHex);t.lineStyle(1,l,.2);const c=this.lerpPoint(r[0],r[3],.44),d=this.lerpPoint(r[1],r[2],.44);t.strokePoints([c,d],!1);const u=this.lerpPoint(o[0],o[3],.36),h=this.lerpPoint(o[1],o[2],.36);t.strokePoints([u,h],!1)}drawFaceGrid(t,i,n,s,a,o){t.lineStyle(1,a,o);for(let r=1;r<n;r+=1){const l=r/n,c=this.lerpPoint(i[0],i[1],l),d=this.lerpPoint(i[3],i[2],l);t.strokePoints([c,d],!1)}for(let r=1;r<s;r+=1){const l=r/s,c=this.lerpPoint(i[0],i[3],l),d=this.lerpPoint(i[1],i[2],l);t.strokePoints([c,d],!1)}}createRoof(t,i,n){return{top:this.liftAndInset(t.top,i,n),right:this.liftAndInset(t.right,i,n),bottom:this.liftAndInset(t.bottom,i,n),left:this.liftAndInset(t.left,i,n)}}liftAndInset(t,i,n){return new P.Geom.Point(t.x*(1-n),t.y*(1-n)-i)}toLocal(t,i){const n=s=>new P.Geom.Point(s.x-t.x,s.y-t.y);return{top:n(i.top),right:n(i.right),bottom:n(i.bottom),left:n(i.left)}}lerpPoint(t,i,n){return new P.Geom.Point(P.Math.Linear(t.x,i.x,n),P.Math.Linear(t.y,i.y,n))}hexToColor(t){return P.Display.Color.HexStringToColor(t).color}}const ge=e=>P.Math.Clamp(e,0,1),G=(e,t,i)=>{const n=P.Display.Color.ValueToColor(e),s=P.Display.Color.ValueToColor(t),a=ge(i),o=P.Math.Linear(n.red,s.red,a),r=P.Math.Linear(n.green,s.green,a),l=P.Math.Linear(n.blue,s.blue,a);return P.Display.Color.GetColor(o,r,l)},Tu=e=>{if(!e)return null;const t=e.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([0-9.]+)\)/i);if(!t)return null;const[,i,n,s,a]=t;return{color:P.Display.Color.GetColor(Number(i),Number(n),Number(s)),alpha:ge(Number(a))}};class Eu{constructor(t){this.theme=t}resolveAtmosphereProfile(t){const i=ge(t.districtWeight),n=t.timeSeconds%180/180*Math.PI*2,a=1-ge(.5+.5*Math.sin(n-Math.PI*.5)),o=G(1323092,728122,a*.45),r=G(4071715,2166805,a*.42),l=G(r,o,i),c=G(l,396053,.3+a*.38),d=G(l,792880,.24+i*.22+a*.24),u=G(1707796,926264,i*.58),h=G(593173,1189440,i*.62),g=Math.max(1,this.theme.qualityBudget.maxFogBands),p=[];for(let A=0;A<g;A+=1){const k=(A+1)/(g+1),x=G(2760230,1522266,i*.7+k*.2),T=ge((.16+a*.12)*(1-k*.72));p.push({widthFactor:1.1+k*.95,heightFactor:.34+k*.28,yFactor:.66+k*.2,color:x,alpha:T})}const m=ge(.28+a*.56+i*.12+this.theme.qualityBudget.maxEmissiveZones*.012),y=ge(this.theme.qualityBudget.wetReflectionAlpha*(.68+a*.65)),v=Tu(t.baseOverlayRgba),S=G(725536,2298136,1-i),M=v?G(v.color,S,.22+a*.26):S,b=ge(((v==null?void 0:v.alpha)??.12+a*.32)*(.9+a*.2));return{gradientTopLeft:c,gradientTopRight:d,gradientBottomLeft:u,gradientBottomRight:h,skylineDowntownColor:G(2051962,1391198,a*.45),skylineSlumsColor:G(5909034,3808548,a*.4),skylineColumns:this.theme.preset==="cinematic"?34:this.theme.preset==="balanced"?30:24,skylineSplit:P.Math.Clamp(.24+i*.52,.2,.82),skylineAlphaBase:.22+a*.16,skylineAlphaVariance:.12,horizonGlowColor:G(6105141,2972550,i),horizonGlowAlpha:.14+a*.1,lowerHazeColor:G(329485,659485,i*.4),lowerHazeAlpha:.42+a*.2,fogBands:p,emissiveIntensity:m,wetReflectionAlpha:y,overlayColor:M,overlayAlpha:b}}}const yt=20,Yn=1.06;class Ru{constructor(){f(this,"previousFrameMassAlpha",new WeakMap);f(this,"previousFrameEntityVisuals",new WeakMap)}applyOcclusionReadability(t){const i=P.Math.Clamp(t.occlusionFadeFloor,.2,.9),n=P.Math.Clamp(.14+t.emissiveIntensity*.3,.12,.5);this.restorePreviousFrameState(t),t.masses.forEach(s=>{this.previousFrameMassAlpha.has(s.container)||this.previousFrameMassAlpha.set(s.container,s.container.alpha)}),t.masses.forEach(s=>{const a=new P.Geom.Rectangle(s.bounds.x-yt,s.bounds.y-yt,s.bounds.width+yt*2,s.bounds.height+yt*2),o=t.entities.filter(r=>a.contains(r.pixelX,r.pixelY));o.length&&(this.previousFrameMassAlpha.has(s.container)||this.previousFrameMassAlpha.set(s.container,s.container.alpha),s.container.setAlpha(Math.min(s.container.alpha,i)),o.forEach(r=>{var d,u,h,g,p;const l=r.token.container;this.previousFrameEntityVisuals.has(l)||this.previousFrameEntityVisuals.set(l,{haloAlpha:r.token.halo.alpha,beaconAlpha:r.token.beacon.alpha,nameAlpha:((d=r.nameLabel)==null?void 0:d.alpha)??1,nameScaleX:((u=r.nameLabel)==null?void 0:u.scaleX)??1,nameScaleY:((h=r.nameLabel)==null?void 0:h.scaleY)??1,healthAlpha:((g=r.healthBar)==null?void 0:g.alpha)??1,indicatorAlpha:((p=r.indicator)==null?void 0:p.alpha)??1});const c=r.token;c.halo.setAlpha(Math.max(c.halo.alpha,.28+n)),c.beacon.setAlpha(Math.max(c.beacon.alpha,.36+n*.75)),r.nameLabel&&(r.nameLabel.setAlpha(1),r.nameLabel.setScale(Math.max(r.nameLabel.scaleX,Yn),Math.max(r.nameLabel.scaleY,Yn))),r.healthBar&&r.healthBar.visible&&r.healthBar.setAlpha(Math.max(r.healthBar.alpha,.94)),r.indicator&&r.indicator.visible&&r.indicator.setAlpha(Math.max(r.indicator.alpha,.94))}))})}restorePreviousFrameState(t){t.masses.forEach(i=>{const n=this.previousFrameMassAlpha.get(i.container);typeof n=="number"&&i.container.setAlpha(n),this.previousFrameMassAlpha.delete(i.container)}),t.entities.forEach(i=>{this.restoreEntityBaseState(i)})}restoreEntityBaseState(t){const i=t.token.container,n=this.previousFrameEntityVisuals.get(i);n&&(t.token.halo.setAlpha(n.haloAlpha),t.token.beacon.setAlpha(n.beaconAlpha),t.nameLabel&&(t.nameLabel.setAlpha(n.nameAlpha),t.nameLabel.setScale(n.nameScaleX,n.nameScaleY)),t.healthBar&&t.healthBar.setAlpha(n.healthAlpha),t.indicator&&t.indicator.setAlpha(n.indicatorAlpha),this.previousFrameEntityVisuals.delete(i))}}const $n={"items.corporate_keycard":"Keycard","items.encrypted_datapad":"Datapad","items.transit_tokens":"Transit Token","items.abandoned_medkit":"Medkit","items.holo_projector_lens":"Lens","items.saboteur_charge_kit":"Charge Kit"},Zn={misc_corporate_keycard:"Keycard",misc_encrypted_datapad:"Datapad",misc_transit_tokens:"Transit Token",misc_abandoned_medkit:"Medkit",misc_holo_projector_lens:"Lens",misc_saboteur_charge_kit:"Charge Kit"},_u=e=>e.resourceKey&&$n[e.resourceKey]?$n[e.resourceKey]:e.definitionId&&Zn[e.definitionId]?Zn[e.definitionId]:e.name;class Lu{constructor(t){f(this,"key","worldRender");this.scene=t}init(){}ensureVisualPipeline(){var s;const t=this.getScene(),i=O.getState().settings.visualQualityPreset,n=!t.visualTheme||t.visualTheme.preset!==i;if((!t.visualTheme||t.visualTheme.preset!==i)&&(t.visualTheme=fr(i)),t.mapGraphics&&(!t.tilePainter||n)&&(t.tilePainter=new ku(t.mapGraphics,t.visualTheme)),(!t.buildingPainter||n)&&(t.buildingPainter=new Cu(this.scene,t.visualTheme)),(!t.atmosphereDirector||n)&&(t.atmosphereDirector=new Eu(t.visualTheme),t.lastAtmosphereRedrawBucket=-1),(!t.occlusionReadabilityController||n)&&(t.occlusionReadabilityController=new Ru),t.isoFactory&&(!t.characterRigFactory||n)&&(t.characterRigFactory=new Xs(t.isoFactory,t.visualTheme)),(s=t.currentMapArea)!=null&&s.buildings){const a={};t.currentMapArea.buildings.forEach(o=>{const r=vt(o.district,o.signageStyle,o.propDensity);a[o.id]=o.visualProfile?{district:o.district==="downtown"?"downtown":"slums",signageStyle:o.signageStyle??r.signageStyle,propDensity:o.propDensity??r.propDensity,facadePattern:o.visualProfile.facadePattern??r.facadePattern,lotPattern:o.visualProfile.lotPattern??r.lotPattern,massingStyle:o.visualProfile.massingStyle??r.massingStyle,massingHeight:o.visualProfile.massingHeight??r.massingHeight,accentHex:o.visualProfile.accentHex??r.accentHex,glowHex:o.visualProfile.glowHex??r.glowHex,trimHex:o.visualProfile.trimHex??r.trimHex,atmosphereHex:o.visualProfile.atmosphereHex??r.atmosphereHex,signagePrimaryHex:o.visualProfile.signagePrimaryHex??r.signagePrimaryHex,signageSecondaryHex:o.visualProfile.signageSecondaryHex??r.signageSecondaryHex,backdropHex:o.visualProfile.backdropHex??r.backdropHex}:r}),t.buildingVisualProfiles=a}else t.buildingVisualProfiles={}}renderStaticProps(){const t=this.getScene();if(t.staticPropGroup&&t.staticPropGroup.clear(!0,!0),t.demoLampGrid=void 0,this.destroyDemoPointLight(),!t.isoFactory||!t.currentMapArea)return;this.ensureVisualPipeline(),t.staticPropGroup||(t.staticPropGroup=t.add.group());const i=o=>{var r;o&&((r=t.staticPropGroup)==null||r.add(o))},n=(t.currentMapArea.entities.npcs??[]).filter(o=>o.isInteractive),s=(t.currentMapArea.entities.items??[]).filter(o=>!!o.position),a=t.getIsoMetrics();n.forEach(o=>{i(t.isoFactory.createPulsingHighlight(o.position.x,o.position.y,{color:2282478,alpha:.14,pulseColor:8246268,pulseAlpha:{from:.26,to:.05},pulseScale:1.22,widthScale:.58,heightScale:.58,depthOffset:9,duration:1400}))}),s.forEach(o=>{const r=o.isQuestItem?16436245:2282478,l=o.isQuestItem?16774079:8246268,c=t.calculatePixelPosition(o.position.x,o.position.y),d=_u(o);i(t.isoFactory.createPulsingHighlight(o.position.x,o.position.y,{color:r,alpha:o.isQuestItem?.24:.22,pulseColor:l,pulseAlpha:{from:o.isQuestItem?.34:.3,to:.08},pulseScale:o.isQuestItem?1.28:1.22,widthScale:.72,heightScale:.72,depthOffset:8,duration:o.isQuestItem?1150:1300}));const u=t.add.text(c.x,c.y-a.tileHeight*.7,d,{fontFamily:'Orbitron, "DM Sans", sans-serif',fontSize:"10px",fontStyle:"700",color:o.isQuestItem?"#fde68a":"#dbeafe",align:"center"});u.setOrigin(.5,1),u.setStroke(o.isQuestItem?"#f59e0b":"#0284c7",1.1),u.setShadow(0,0,o.isQuestItem?"#f59e0b":"#38bdf8",8,!0,!0),t.syncDepth(u,c.x,c.y,B.FLOATING_UI+14),i(u)}),t.lightsFeatureEnabled&&this.rebuildLightingDemoLight(),t.lastItemMarkerSignature=this.getItemMarkerSignature(t.currentMapArea)}getItemMarkerSignature(t){if(!t)return"";const i=(t.entities.items??[]).filter(n=>!!n.position);return i.length===0?"":i.map(n=>`${n.id??n.name}@${n.position.x},${n.position.y}`).sort().join("|")}applyLightingSettings(t){var o;const i=this.getScene(),n=(o=i.visualTheme)==null?void 0:o.preset;(!i.visualTheme||n!==t.qualityPreset)&&(this.ensureVisualPipeline(),this.refreshVisualLayers());const s=tn(t.qualityPreset),a=t.lightsEnabled&&t.qualityPreset!=="performance";if(a&&!this.hasLightPipelineSupport()){console.warn("[MainScene] Light2D not supported by current renderer; disabling lighting toggle."),O.dispatch(fn(!1)),Dt({lightsEnabled:!1}),this.disableLighting(!0);return}a?this.enableLighting():this.disableLighting(),!s.colorMatrixEnabled&&t.colorMatrix.enabled&&Dt({colorMatrix:{enabled:!1}})}refreshVisualLayers(){const t=this.getScene();t.currentMapArea&&(t.currentAtmosphereProfile=void 0,this.drawBackdrop(),this.drawMap(t.currentMapArea.tiles),this.drawBuildingMasses(),this.drawBuildingLabels(),this.renderStaticProps(),t.renderVisionCones(),this.applyOcclusionReadability())}drawMap(t){var r,l,c,d,u;const i=this.getScene();if(!i.mapGraphics)return;this.ensureVisualPipeline();const n=this.resolveAtmosphereProfile();(r=i.tilePainter)==null||r.setAtmosphereProfile({wetReflectionAlpha:n.wetReflectionAlpha,emissiveIntensity:n.emissiveIntensity}),i.mapGraphics.clear();const{tileWidth:s,tileHeight:a}=i.getIsoMetrics(),o=new Set;(c=(l=i.currentMapArea)==null?void 0:l.buildings)==null||c.forEach(h=>{for(let g=h.footprint.from.y;g<=h.footprint.to.y;g+=1)for(let p=h.footprint.from.x;p<=h.footprint.to.x;p+=1)o.add(`${p}:${g}`)});for(let h=0;h<t.length;h++)for(let g=0;g<t[0].length;g++){const p=t[h][g],m=i.calculatePixelPosition(g,h),y=((u=(d=i.currentMapArea)==null?void 0:d.zoneId)==null?void 0:u.startsWith("downtown_checkpoint"))&&p.type===E.COVER,v=o.has(`${g}:${h}`),S=y||v&&(p.type===E.WALL||p.type===E.COVER||p.type===E.DOOR);this.renderTile(p,m,s,a,g,h,S)}}drawBuildingMasses(){var a,o;const t=this.getScene();if(t.buildingMassings.forEach(r=>r.destroy(!0)),t.buildingMassings=[],t.buildingMassingEntries=[],!((o=(a=t.currentMapArea)==null?void 0:a.buildings)!=null&&o.length)||!t.buildingPainter)return;this.ensureVisualPipeline();const i=t.buildingPainter;if(!i)return;const{tileWidth:n,tileHeight:s}=t.getIsoMetrics();t.currentMapArea.buildings.forEach(r=>{const l=t.buildingVisualProfiles[r.id]??vt(r.district,r.signageStyle,r.propDensity),c=r.footprint.to.x-r.footprint.from.x+1,d=r.footprint.to.y-r.footprint.from.y+1,u=t.calculatePixelPosition(r.footprint.from.x,r.footprint.from.y),h=t.calculatePixelPosition(r.footprint.to.x,r.footprint.from.y),g=t.calculatePixelPosition(r.footprint.to.x,r.footprint.to.y),p=t.calculatePixelPosition(r.footprint.from.x,r.footprint.to.y),m={top:new P.Geom.Point(u.x,u.y-s*.5),right:new P.Geom.Point(h.x+n*.5,h.y),bottom:new P.Geom.Point(g.x,g.y+s*.5),left:new P.Geom.Point(p.x-n*.5,p.y)},y={x:(m.top.x+m.right.x+m.bottom.x+m.left.x)/4,y:(m.top.y+m.right.y+m.bottom.y+m.left.y)/4},v=i.createMassing(r,l,{center:y,tileHeight:s,widthTiles:c,depthTiles:d,footprint:m});v.setScrollFactor(1),t.syncDepth(v,m.bottom.x,m.bottom.y,B.PROP_TALL+Math.round(l.massingHeight*12)),t.buildingMassings.push(v);const S=l.district==="downtown"?.78:.7,M=s*Math.max(.58,l.massingHeight*S),b=Math.min(m.top.x,m.right.x,m.bottom.x,m.left.x),A=Math.max(m.top.x,m.right.x,m.bottom.x,m.left.x),k=Math.min(m.top.y-M,m.right.y-M,m.bottom.y-M,m.left.y-M),x=Math.max(m.top.y,m.right.y,m.bottom.y,m.left.y);t.buildingMassingEntries.push({id:r.id,container:v,bounds:new P.Geom.Rectangle(b,k,Math.max(1,A-b),Math.max(1,x-k))})})}drawBuildingLabels(){var n;const t=this.getScene();if(t.buildingLabels.forEach(s=>s.destroy(!0)),t.buildingLabels=[],!((n=t.currentMapArea)!=null&&n.buildings)||t.currentMapArea.buildings.length===0)return;this.ensureVisualPipeline();const{tileHeight:i}=t.getIsoMetrics();t.currentMapArea.buildings.forEach(s=>{const a=t.buildingVisualProfiles[s.id]??vt(s.district,s.signageStyle,s.propDensity),o=(s.footprint.from.x+s.footprint.to.x)/2,r=Math.min(s.footprint.from.y,s.door.y)-.4,l=t.calculatePixelPosition(o,r),c=i*(.8+a.massingHeight*.18),d=t.buildingPainter?t.buildingPainter.createLabel(s,l,c,a):t.add.container(l.x,l.y-i*.2);d.setScrollFactor(1),t.syncDepth(d,l.x,l.y,B.FLOATING_UI+20),t.buildingLabels.push(d)})}resolveAtmosphereProfile(t){const i=this.getScene();if(this.ensureVisualPipeline(),!i.atmosphereDirector)throw new Error("AtmosphereDirector is not initialized.");const n=i.atmosphereDirector.resolveAtmosphereProfile({districtWeight:this.resolveDistrictWeight(),timeSeconds:i.currentGameTime,baseOverlayRgba:t}),s=tn(i.visualTheme.preset);return i.currentAtmosphereProfile={...n,fogBands:n.fogBands.slice(0,s.maxFogBands),emissiveIntensity:P.Math.Clamp(n.emissiveIntensity,0,1),wetReflectionAlpha:P.Math.Clamp(n.wetReflectionAlpha,0,s.wetReflectionAlpha)},i.currentAtmosphereProfile}applyOcclusionReadability(){const t=this.getScene();if(!t.occlusionReadabilityController||!t.buildingMassingEntries.length)return;const i=[];t.playerToken&&i.push({id:"player",pixelX:t.playerToken.container.x,pixelY:t.playerToken.container.y,token:t.playerToken,nameLabel:t.playerNameLabel}),t.enemySprites.forEach((s,a)=>{i.push({id:a,pixelX:s.token.container.x,pixelY:s.token.container.y,token:s.token,nameLabel:s.nameLabel,healthBar:s.healthBar})}),t.npcSprites.forEach((s,a)=>{i.push({id:a,pixelX:s.token.container.x,pixelY:s.token.container.y,token:s.token,nameLabel:s.nameLabel,indicator:s.indicator})});const n=t.currentAtmosphereProfile??this.resolveAtmosphereProfile();t.occlusionReadabilityController.applyOcclusionReadability({masses:t.buildingMassingEntries,entities:i,occlusionFadeFloor:t.visualTheme.qualityBudget.occlusionFadeFloor,emissiveIntensity:n.emissiveIntensity})}drawBackdrop(){const t=this.getScene();if(!t.backdropGraphics||!t.currentMapArea)return;const i=this.computeIsoBounds(),n=t.tileSize*4,s=i.maxX-i.minX+n*2,a=i.maxY-i.minY+n*2,o=i.minX-n,r=i.minY-n,l=this.resolveAtmosphereProfile(),c=l.skylineSplit;t.backdropGraphics.clear(),t.backdropGraphics.fillGradientStyle(l.gradientTopLeft,l.gradientTopRight,l.gradientBottomLeft,l.gradientBottomRight,1,1,1,1),t.backdropGraphics.fillRect(o,r,s,a);const d=r+a*.52,u=l.skylineColumns,h=l.skylineDowntownColor,g=l.skylineSlumsColor;for(let m=0;m<u;m+=1){const y=m/u,v=o+y*s,S=.68+m*13%7*.08,M=s/u*S,b=m*29%11/11,A=a*(.12+b*.28)*(y<c?1.12:.78),k=y<c?.78:.26,x=P.Display.Color.Interpolate.ColorWithColor(P.Display.Color.ValueToColor(g),P.Display.Color.ValueToColor(h),1,k),T=P.Display.Color.GetColor(x.r,x.g,x.b);t.backdropGraphics.fillStyle(T,l.skylineAlphaBase+b*l.skylineAlphaVariance),t.backdropGraphics.fillRect(v,d-A,M,A),t.backdropGraphics.fillStyle(C(T,.12),.14+l.emissiveIntensity*.1),t.backdropGraphics.fillRect(v+M*.72,d-A,M*.16,A)}const p=r+a*.35;t.backdropGraphics.fillStyle(l.horizonGlowColor,l.horizonGlowAlpha),t.backdropGraphics.fillEllipse(o+s/2,p,s*1.08,a*.52),t.backdropGraphics.fillStyle(l.lowerHazeColor,l.lowerHazeAlpha),t.backdropGraphics.fillRect(o,r+a*.6,s,a*.6),l.fogBands.forEach(m=>{const y=m.alpha;y<=0||(t.backdropGraphics.lineStyle(2,m.color,y),t.backdropGraphics.strokeEllipse(o+s/2,r+a*m.yFactor,s*m.widthFactor,a*m.heightFactor))})}computeIsoBounds(){const t=this.getScene();if(!t.currentMapArea)return{minX:0,maxX:0,minY:0,maxY:0};const{width:i,height:n}=t.currentMapArea,s=[t.calculatePixelPosition(0,0),t.calculatePixelPosition(i-1,0),t.calculatePixelPosition(0,n-1),t.calculatePixelPosition(i-1,n-1)],a=Math.min(...s.map(c=>c.x)),o=Math.max(...s.map(c=>c.x)),r=Math.min(...s.map(c=>c.y)),l=Math.max(...s.map(c=>c.y));return{minX:a,maxX:o,minY:r,maxY:l}}hasLightPipelineSupport(){return this.getScene().game.renderer instanceof P.Renderer.WebGL.WebGLRenderer}enableLighting(){const t=this.getScene();if(!this.hasLightPipelineSupport()){console.warn("[MainScene] WebGL renderer unavailable; Light2D disabled."),t.lightsFeatureEnabled=!1,O.dispatch(fn(!1)),Dt({lightsEnabled:!1});return}if(t.lightsFeatureEnabled){this.rebuildLightingDemoLight();return}t.lights.enable().setAmbientColor(t.lightingAmbientColor),t.lightsFeatureEnabled=!0,this.rebuildLightingDemoLight()}disableLighting(t=!1){const i=this.getScene();if(!i.lightsFeatureEnabled&&!t){this.destroyDemoPointLight();return}if(this.destroyDemoPointLight(),this.hasLightPipelineSupport()){const n=i.lights;typeof n.removeAll=="function"&&n.removeAll(),i.lights.disable()}i.lightsFeatureEnabled=!1}rebuildLightingDemoLight(){const t=this.getScene();if(!t.lightsFeatureEnabled||!t.demoLampGrid){this.destroyDemoPointLight();return}const{x:i,y:n}=t.calculatePixelPosition(t.demoLampGrid.x,t.demoLampGrid.y),s=n-t.tileSize*.35,a=t.tileSize*1.6,o=.4;t.demoPointLight?(t.demoPointLight.setPosition(i,s),t.demoPointLight.radius=a,t.demoPointLight.intensity=o):(t.demoPointLight=t.add.pointlight(i,s,8246268,a,o),t.demoPointLight.setScrollFactor(1))}destroyDemoPointLight(){const t=this.getScene();t.demoPointLight&&(t.demoPointLight.destroy(),t.demoPointLight=void 0)}renderTile(t,i,n,s,a,o,r=!1){var c;const l=this.getScene();this.ensureVisualPipeline(),(c=l.tilePainter)==null||c.drawTile(t,{center:i,tileWidth:n,tileHeight:s,gridX:a,gridY:o,groundOnly:r})}resolveDistrictWeight(){const t=this.getScene(),i=Object.values(t.buildingVisualProfiles);return i.length?i.filter(s=>s.district==="downtown").length/i.length:.5}getScene(){return this.scene}}class Qm extends P.Scene{constructor(){super({key:"MainScene"});f(this,"tileSize",Rt);f(this,"depthManager");f(this,"mapGraphics");f(this,"backdropGraphics");f(this,"pathGraphics");f(this,"visionConeGraphics");f(this,"visualTheme");f(this,"tilePainter");f(this,"buildingPainter");f(this,"characterRigFactory");f(this,"atmosphereDirector");f(this,"occlusionReadabilityController");f(this,"currentAtmosphereProfile");f(this,"lastAtmosphereRedrawBucket",-1);f(this,"buildingVisualProfiles",{});f(this,"playerToken");f(this,"playerNameLabel");f(this,"enemySprites",new Map);f(this,"npcSprites",new Map);f(this,"coverDebugGraphics");f(this,"currentMapArea",null);f(this,"buildingLabels",[]);f(this,"buildingMassings",[]);f(this,"buildingMassingEntries",[]);f(this,"unsubscribe",null);f(this,"playerInitialPosition");f(this,"dayNightOverlay");f(this,"curfewActive",!1);f(this,"currentGameTime",0);f(this,"timeDispatchAccumulator",0);f(this,"isoOriginX",0);f(this,"isoOriginY",0);f(this,"isCameraFollowingPlayer",!1);f(this,"lastPlayerGridPosition",null);f(this,"inCombat",!1);f(this,"playerVitalsIndicator");f(this,"isoFactory");f(this,"staticPropGroup");f(this,"disposeVisualSettings");f(this,"disposeLightingSettings");f(this,"lastPlayerScreenDetail");f(this,"baselineCameraZoom",1);f(this,"cameraZoomTween",null);f(this,"lightsFeatureEnabled",!1);f(this,"demoLampGrid");f(this,"demoPointLight");f(this,"lightingAmbientColor",988970);f(this,"lastItemMarkerSignature","");f(this,"hasInitialZoomApplied",!1);f(this,"userAdjustedZoom",!1);f(this,"pendingCameraRestore",!1);f(this,"preCombatZoom",null);f(this,"preCombatUserAdjusted",!1);f(this,"pendingRestoreUserAdjusted",null);f(this,"moduleDisposables",new On);f(this,"sceneModuleRegistry");f(this,"dayNightOverlayModule",new zd(this));f(this,"minimapBridgeModule",new bu(this));f(this,"inputModule",new cu(this));f(this,"cameraModule",new Hd(this));f(this,"entityRenderModule",new Zd(this));f(this,"stateSyncModule",new Su(this));f(this,"surveillanceRenderModule",new Iu(this));f(this,"worldRenderModule",new Lu(this));f(this,"lastStoreSnapshot",O.getState())}initializeSceneModules(){this.moduleDisposables.dispose(),this.moduleDisposables=new On;const i=_d(this,{getState:()=>O.getState(),dispatch:O.dispatch},this.moduleDisposables);this.sceneModuleRegistry=new Ld(i),this.sceneModuleRegistry.register(this.dayNightOverlayModule),this.sceneModuleRegistry.register(this.minimapBridgeModule),this.sceneModuleRegistry.register(this.surveillanceRenderModule),this.sceneModuleRegistry.register(this.worldRenderModule),this.sceneModuleRegistry.register(this.entityRenderModule),this.sceneModuleRegistry.register(this.stateSyncModule),this.sceneModuleRegistry.register(this.inputModule),this.sceneModuleRegistry.register(this.cameraModule),this.sceneModuleRegistry.onCreate(),i.listenScale("resize",this.handleResize,this),this.lastStoreSnapshot=O.getState()}ensureVisualPipeline(){this.worldRenderModule.ensureVisualPipeline()}registerStaticDepth(i,n){this.depthManager.registerStatic(i,n)}syncDepth(i,n,s,a){Zs(this.depthManager,i,n,s,a)}init(i){this.currentMapArea=i.mapArea,this.playerInitialPosition=i.playerPosition,this.enemySprites=new Map,this.npcSprites=new Map,this.isCameraFollowingPlayer=!1}create(){if(!this.currentMapArea){console.error("[MainScene] currentMapArea is null on create!");return}this.cameras.main.setBackgroundColor(1710618),this.depthManager=new Td(this),this.backdropGraphics=this.add.graphics(),this.registerStaticDepth(this.backdropGraphics,Ee.BACKDROP),this.mapGraphics=this.add.graphics(),this.registerStaticDepth(this.mapGraphics,Ee.MAP_BASE),this.visionConeGraphics=this.add.graphics(),this.registerStaticDepth(this.visionConeGraphics,Ee.VISION_OVERLAY),this.pathGraphics=this.add.graphics(),this.registerStaticDepth(this.pathGraphics,Ee.PATH_PREVIEW),this.coverDebugGraphics=this.add.graphics(),this.registerStaticDepth(this.coverDebugGraphics,Ee.COVER_DEBUG),this.coverDebugGraphics.setVisible(!1),this.ensureVisualPipeline(),this.setupCameraAndMap(),this.cameras.main.setRoundPixels(!1),this.disposeVisualSettings=Oa(this.cameras.main),this.disposeLightingSettings=ns(n=>{this.applyLightingSettings(n)}),this.events.once(P.Scenes.Events.SHUTDOWN,this.cleanupScene,this);const i=O.getState().world;if(this.currentGameTime=i.currentTime,this.timeDispatchAccumulator=0,this.inCombat=i.inCombat,this.lastAtmosphereRedrawBucket=Math.floor(this.currentGameTime/5),this.currentAtmosphereProfile=void 0,this.drawBackdrop(),this.drawMap(this.currentMapArea.tiles),this.initializeDayNightOverlay(),this.updateDayNightOverlay(),this.curfewActive=i.curfewActive,this.initializeSceneModules(),this.playerInitialPosition){this.ensureIsoFactory();const n=this.characterRigFactory?this.characterRigFactory.createToken("player",this.playerInitialPosition.x,this.playerInitialPosition.y):this.isoFactory.createCharacterToken(this.playerInitialPosition.x,this.playerInitialPosition.y,this.visualTheme.entityProfiles.player);this.playerToken=n;const s=this.getIsoMetrics(),a=this.calculatePixelPosition(this.playerInitialPosition.x,this.playerInitialPosition.y),o=O.getState().player.data.name??"Operative";this.playerNameLabel=this.createCharacterNameLabel(o,3718648,14),this.positionCharacterLabel(this.playerNameLabel,a.x,a.y,s.tileHeight*1.6),this.enablePlayerCameraFollow()}else console.error("[MainScene] playerInitialPosition is null");this.unsubscribe=O.subscribe(this.handleStateChange.bind(this)),setTimeout(()=>{var n,s,a,o,r,l,c,d,u,h;if(this.sys.isActive()){const g=O.getState();(a=(s=(n=g==null?void 0:g.world)==null?void 0:n.currentMapArea)==null?void 0:s.entities)!=null&&a.enemies&&this.updateEnemies(g.world.currentMapArea.entities.enemies),(l=(r=(o=g==null?void 0:g.world)==null?void 0:o.currentMapArea)==null?void 0:r.entities)!=null&&l.npcs&&this.updateNpcs(g.world.currentMapArea.entities.npcs);const p=(d=(c=g==null?void 0:g.surveillance)==null?void 0:c.zones)==null?void 0:d[g.world.currentMapArea.id],m=((h=(u=g==null?void 0:g.surveillance)==null?void 0:u.hud)==null?void 0:h.overlayEnabled)??!1;this.updateSurveillanceCameras(p,m),this.renderVisionCones()}},0)}destroyCameraSprites(){this.surveillanceRenderModule.clearCameraSprites()}cleanupScene(){var i;(i=this.sceneModuleRegistry)==null||i.onShutdown(),this.sceneModuleRegistry=void 0,this.moduleDisposables.dispose(),this.stopCameraZoomTween(),this.disposeVisualSettings&&(this.disposeVisualSettings(),this.disposeVisualSettings=void 0),this.disposeLightingSettings&&(this.disposeLightingSettings(),this.disposeLightingSettings=void 0),this.disableLighting(!0),this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null),this.destroyPlayerVitalsIndicator(),this.destroyCameraSprites(),this.npcSprites.forEach(n=>{n.indicator&&(n.indicator.destroy(),n.indicator=void 0)}),this.buildingLabels.forEach(n=>n.destroy(!0)),this.buildingLabels=[],this.buildingMassings.forEach(n=>n.destroy(!0)),this.buildingMassings=[],this.buildingMassingEntries=[],this.currentAtmosphereProfile=void 0,this.coverDebugGraphics&&(this.coverDebugGraphics.destroy(),this.coverDebugGraphics=void 0)}handleStateChange(){var s;if(!this.sys.isActive()||!this.currentMapArea)return;const i=O.getState(),n=this.lastStoreSnapshot;(s=this.sceneModuleRegistry)==null||s.onStateChange(n,i),this.lastStoreSnapshot=i}ensureIsoFactory(){this.isoFactory||(this.isoFactory=new Ed(this,this.tileSize,this.depthManager)),this.isoFactory.setIsoOrigin(this.isoOriginX,this.isoOriginY),this.visualTheme&&(this.characterRigFactory=new Xs(this.isoFactory,this.visualTheme))}renderStaticProps(){this.worldRenderModule.renderStaticProps()}getItemMarkerSignature(i){return this.worldRenderModule.getItemMarkerSignature(i)}applyLightingSettings(i){this.worldRenderModule.applyLightingSettings(i)}disableLighting(i=!1){this.worldRenderModule.disableLighting(i)}updatePlayerPosition(i){this.entityRenderModule.updatePlayerPosition(i)}updatePlayerVitalsIndicator(i,n,s){this.entityRenderModule.updatePlayerVitalsIndicator(i,n,s)}destroyPlayerVitalsIndicator(){this.entityRenderModule.destroyPlayerVitalsIndicator()}enablePlayerCameraFollow(){this.cameraModule.enablePlayerCameraFollow()}recenterCameraOnPlayer(){this.cameraModule.recenterCameraOnPlayer()}updateEnemies(i){this.entityRenderModule.updateEnemies(i)}updateNpcs(i){this.entityRenderModule.updateNpcs(i)}renderVisionCones(){this.surveillanceRenderModule.renderVisionCones()}updateSurveillanceCameras(i,n=!1){this.surveillanceRenderModule.updateSurveillanceCameras(i,n)}shutdown(){this.cleanupScene(),this.enemySprites.forEach(i=>{i.token.container.destroy(!0),i.healthBar.destroy(),i.nameLabel.destroy()}),this.enemySprites.clear(),this.npcSprites.forEach(i=>{i.token.container.destroy(!0),i.nameLabel.destroy(),i.indicator&&i.indicator.destroy()}),this.npcSprites.clear(),this.destroyCameraSprites(),this.stopCameraZoomTween(),this.buildingLabels.forEach(i=>i.destroy(!0)),this.buildingLabels=[],this.buildingMassings.forEach(i=>i.destroy(!0)),this.buildingMassings=[],this.buildingMassingEntries=[],this.currentAtmosphereProfile=void 0,this.playerToken&&(this.playerToken.container.destroy(!0),this.playerToken=void 0,this.lastPlayerScreenDetail=void 0),this.playerNameLabel&&(this.playerNameLabel.destroy(),this.playerNameLabel=void 0),this.destroyPlayerVitalsIndicator()}drawMap(i){this.worldRenderModule.drawMap(i)}drawBuildingMasses(){this.worldRenderModule.drawBuildingMasses()}drawBuildingLabels(){this.worldRenderModule.drawBuildingLabels()}createCharacterNameLabel(i,n,s=12){return this.entityRenderModule.createCharacterNameLabel(i,n,s)}positionCharacterLabel(i,n,s,a){this.entityRenderModule.positionCharacterLabel(i,n,s,a)}calculatePixelPosition(i,n){return ae(i,n,this.isoOriginX,this.isoOriginY,this.tileSize)}dispatchPlayerScreenPosition(){this.entityRenderModule.dispatchPlayerScreenPosition()}getIsoMetrics(){return oe(this.tileSize)}getDiamondPoints(i,n,s,a){return K(i,n,s,a).map(o=>new P.Geom.Point(o.x,o.y))}worldToGrid(i,n){const{halfTileWidth:s,halfTileHeight:a}=this.getIsoMetrics(),o=i-this.isoOriginX,r=n-this.isoOriginY,l=(r/a+o/s)*.5,c=(r/a-o/s)*.5,d=Math.round(l),u=Math.round(c);return Number.isNaN(d)||Number.isNaN(u)?null:{x:d,y:u}}worldToGridContinuous(i,n){const{halfTileWidth:s,halfTileHeight:a}=this.getIsoMetrics(),o=i-this.isoOriginX,r=n-this.isoOriginY,l=(r/a+o/s)*.5,c=(r/a-o/s)*.5;return!Number.isFinite(l)||!Number.isFinite(c)?null:{x:l,y:c}}clampCameraToBounds(i){this.cameraModule.clampCameraToBounds(i)}clampCameraCenterTarget(i,n){return this.cameraModule.clampCameraCenterTarget(i,n)}clearPathPreview(){this.inputModule.clearPathPreview()}emitViewportUpdate(){this.minimapBridgeModule.emitViewportUpdate()}focusCameraOnGridPosition(i,n,s=!0){this.cameraModule.focusCameraOnGridPosition(i,n,s)}resolveAtmosphereProfile(i){return this.worldRenderModule.resolveAtmosphereProfile(i)}applyOcclusionReadability(){this.worldRenderModule.applyOcclusionReadability()}drawBackdrop(){this.worldRenderModule.drawBackdrop()}computeIsoBounds(){return this.worldRenderModule.computeIsoBounds()}handleResize(){var i;(i=this.sceneModuleRegistry)==null||i.onResize()}setupCameraAndMap(){this.cameraModule.setupCameraAndMap()}initializeDayNightOverlay(){this.dayNightOverlayModule.initializeDayNightOverlay()}applyOverlayZoom(){this.dayNightOverlayModule.applyOverlayZoom()}stopCameraZoomTween(){this.cameraModule.stopCameraZoomTween()}animateCameraZoom(i){this.cameraModule.animateCameraZoom(i)}zoomCameraForCombat(){this.cameraModule.zoomCameraForCombat()}restoreCameraAfterCombat(){this.cameraModule.restoreCameraAfterCombat()}resizeDayNightOverlay(){this.dayNightOverlayModule.resizeDayNightOverlay()}updateDayNightOverlay(){this.dayNightOverlayModule.updateDayNightOverlay()}update(i,n){var o;if(!this.sys.isActive())return;(o=this.sceneModuleRegistry)==null||o.onUpdate(i,n);const s=n/1e3;this.currentGameTime+=s,this.timeDispatchAccumulator+=s;const a=Math.floor(this.currentGameTime/5);if(a!==this.lastAtmosphereRedrawBucket&&this.currentMapArea&&(this.lastAtmosphereRedrawBucket=a,this.drawBackdrop(),this.drawMap(this.currentMapArea.tiles)),this.updateDayNightOverlay(),this.applyOcclusionReadability(),this.timeDispatchAccumulator>=.5){const r=this.timeDispatchAccumulator;O.dispatch(Yr(r)),!!O.getState().settings.reputationSystemsEnabled&&O.dispatch(mc({elapsedSeconds:r,timestamp:this.currentGameTime})),this.timeDispatchAccumulator=0}this.dispatchPlayerScreenPosition()}}class Jm extends P.Scene{constructor(){super({key:"BootScene"})}preload(){this.load.atlas("props","atlases/props.png","atlases/props.json"),this.load.image("lamp_slim_a_n","normals/lamp_slim_a_n.png")}create(){console.log("[BootScene] create: Fetching initial state and starting MainScene...");const t=O.getState(),i=t.world.currentMapArea,n=t.player.data.position,s=this.textures.get("props"),a=this.textures.get("lamp_slim_a_n");if(s&&a&&s.dataSource.length===0){const c=a.getSourceImage();s.setDataSource(c),this.textures.remove("lamp_slim_a_n")}i||console.error("[BootScene] Error: initialMapArea is null or undefined in Redux state!"),n||console.error("[BootScene] Error: initialPlayerPosition is null or undefined in Redux state!");const o=t.settings.locale,l=Et(o).buildingDefinitions;this.scene.start("MainScene",{mapArea:i,playerPosition:n,buildings:l})}}const $t=e=>`${e.x},${e.y}`,Bi=(e,t,i,n={})=>{if(e.x===t.x&&e.y===t.y)return[];const s=n.allowDiagonals?[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1},{x:1,y:1},{x:-1,y:-1},{x:1,y:-1},{x:-1,y:1}]:[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}],a=new Set,o=[{position:e,path:[]}];a.add($t(e));const{player:r,enemies:l=[],blockedPositions:c=[],npcs:d=[],ignoreNpcIds:u=[]}=n,h=new Set(c.map($t)),g=p=>p.x>=0&&p.y>=0&&p.x<i.width&&p.y<i.height;for(;o.length>0;){const p=o.shift();if(!p)break;for(const m of s){const y={x:p.position.x+m.x,y:p.position.y+m.y};if(!g(y))continue;const v=$t(y);if(a.has(v))continue;const S=y.x===t.x&&y.y===t.y,M=i.tiles[y.y][y.x];if(!M||!M.isWalkable)continue;if(S){const A=r?r.position.x===y.x&&r.position.y===y.y:!1,k=l.some(T=>T.position.x===y.x&&T.position.y===y.y),x=d.some(T=>!u.includes(T.id)&&T.position.x===y.x&&T.position.y===y.y);if(A||k||x)continue}else if(h.has(v)||!ye(y,i,r,l,{npcs:d,ignoreNpcIds:u}))continue;const b=[...p.path,y];if(S)return b;a.add(v),o.push({position:y,path:b})}}return[]},la=4294967295,Du=e=>()=>{let t=e+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/(la+1)},et=e=>{let t=1779033703^e.length;for(let i=0;i<e.length;i+=1)t=Math.imul(t^e.charCodeAt(i),3432918353),t=t<<13|t>>>19;return(Math.imul(t^t>>>16,2246822507)^Math.imul(t^t>>>13,3266489909))>>>0},Hi=(e,t=0)=>{const i=Math.floor(t)>>>0,n=et(e)^i,s=Du(n||1),a=()=>s();return{next:a,nextInRange:(o,r)=>{if(r<=o)return o;const l=a();return o+l*(r-o)},fork:o=>{const r=Math.floor(a()*la);return Hi(`${e}:${o}`,r)}}},pe=["idle","patrol","chase","search","attack","inspectNoise","flee","panic"],Xn=e=>e?pe.reduce((t,i)=>(typeof e[i]=="number"&&(t[i]=e[i]),t),{}):{},Ou=e=>pe.reduce((t,i)=>{const n=e[i];return t[i]=typeof n=="number"?Math.max(0,n):0,t},{}),Nu=(e,t,i,n)=>{if(!(!t||t.length===0))for(const s of t){const{state:a,weight:o}=s;let r=0;switch(s.kind){case"healthBelow":i.healthRatio<=s.threshold&&(r=o);break;case"healthAbove":i.healthRatio>=s.threshold&&(r=o);break;case"lineOfSight":i.hasLineOfSight&&(r=o);break;case"lostLineOfSight":i.hasLineOfSight||(r=o);break;case"alertAtLeast":(i.alertLevel??0)>=s.alert&&(r=o);break;case"alertBelow":(i.alertLevel??0)<s.alert&&(r=o);break;case"suppressionAbove":i.suppressionRatio>=s.threshold&&(r=o);break;case"distanceBelow":i.distanceToPlayer<=s.tiles&&(r=o);break;case"distanceAbove":i.distanceToPlayer>=s.tiles&&(r=o);break;case"directorAtLeast":typeof i.directorIntensity=="number"&&i.directorIntensity>=s.threshold&&(r=o);break}if(r!==0){const l=Math.max(0,(e[a]??0)+r);e[a]=l,n[a]=(n[a]??0)+r}}},Fu=(e,t,i)=>{pe.forEach(n=>{const s=t[n];typeof s=="number"&&s>i&&(e[n]=0)})},Bu=(e,t)=>{t<=0||pe.forEach(i=>{e[i]>0&&e[i]<t&&(e[i]=t)})},Hu=(e,t)=>{let i=0;if(pe.forEach(a=>{i+=e[a]}),i<=0)return"idle";const n=t()*i;let s=0;for(const a of pe)if(s+=e[a],n<=s)return a;return pe[pe.length-1]},Wu=(e,t,i,n)=>{const s=t==null?void 0:t[i];typeof s=="number"&&s>0&&(e[i]=n+s)},qu=(e,t)=>{const i=(t==null?void 0:t.personalitySeed)??et(e.id),n=Hi(`${e.id}:${i}`,i);let s=(t==null?void 0:t.currentState)??e.initialState,a=(t==null?void 0:t.lastTransitionAt)??0;const o=Xn(t==null?void 0:t.cooldowns),r=e.cooldowns??{},l=e.minimumSelectableWeight??0;return{getState:()=>s,getSnapshot:()=>({currentState:s,lastTransitionAt:a,cooldowns:Xn(o),personalitySeed:i}),step:(h,g)=>{const p=Ou(e.baseWeights),m=pe.reduce((b,A)=>(b[A]=0,b),{});Nu(p,e.utilityModifiers,h,m),Fu(p,o,h.now),Bu(p,l),p[s]>0&&(p[s]+=.5);const y=Hu(p,n.next),v=s;y!==s&&(Wu(o,r,y,h.now),s=y,a=h.now);const S={previousState:v,selectedState:y,weights:p,utilityBreakdown:m,now:h.now},M=g==null?void 0:g[y];return M&&M(h,S),{state:y,metadata:S}}}},zu=e=>{const t=e.suppression??0;return t<=0?0:Math.max(0,Math.min(1,t/100))},Vu=({enemy:e,player:t,mapArea:i,squad:n,npcs:s,hasLineOfSight:a,now:o})=>({enemy:e,player:t,mapArea:i,squad:n,civilians:s,hasLineOfSight:a,distanceToPlayer:ie(e.position,t.position),tookRecentDamage:e.health<e.maxHealth,healthRatio:e.maxHealth>0?e.health/e.maxHealth:0,suppressionRatio:zu(e),alertLevel:e.alertLevel,lastKnownPlayerPosition:e.lastKnownPlayerPosition,directorIntensity:void 0,now:o}),Gu=(e,t)=>({currentState:e.aiState??t,lastTransitionAt:e.aiLastTransitionAt??0,cooldowns:e.aiCooldowns??{},personalitySeed:e.aiPersonalitySeed??et(e.id)}),Uu=(e,t,i,n)=>({...e,aiProfileId:t,aiState:i.currentState,aiLastTransitionAt:i.lastTransitionAt,aiCooldowns:i.cooldowns,aiPersonalitySeed:i.personalitySeed,aiTelemetry:{state:n.selectedState,previousState:n.previousState,weights:{...n.weights},utilities:{...n.utilityBreakdown},updatedAt:n.now}}),je=(e,t,i,n)=>{if(!xe(e.position,t.position,e.attackRange))return null;if(e.actionPoints<Je)return{enemy:{...e,actionPoints:0},player:t,action:"no_ap"};const s=n.some(c=>c.x===t.position.x&&c.y===t.position.y),a=sa(e,t,{isBehindCover:s,mapArea:i});let o=e,r=t;a.newAttacker.id===e.id&&(o=a.newAttacker),a.newTarget.id===t.id&&(r=a.newTarget);const l=a.success?"attack":"attack_missed";return{enemy:o,player:r,action:l,isCritical:a.isCritical}},Ku=(e,t,i,n,s,a)=>{if(!Ne(t,i))return null;const o=s.filter(l=>l.id!==e.id),r=Bi(e.position,t,i,{player:n,enemies:o,npcs:a});return r.length===0?null:r[0]},Ae=(e,t,i,n,s)=>{const a=wi(e,t,i,n,s);if(!a)return null;const o=rt(e,a);return{enemy:ot(o,e.position,i),player:t,action:"move"}},Si=(e,t,i,n,s,a)=>{const o=Zu(e,t,i,n,s,a);if(!o)return null;const r=rt(e,o);return{enemy:ot(r,e.position,i),player:t,action:"seek_cover"}},ca=(e,t,i,n,s)=>{if(!e.lastKnownPlayerPosition)return null;const a=Ku(e,e.lastKnownPlayerPosition,i,t,n,s);if(!a)return null;const o=rt(e,a);return{enemy:ot(o,e.position,i),player:t,action:"search"}},Qn=(e,t,i,n,s,a,o)=>{const r=Wi(e.position),l=n.filter(m=>m.id!==e.id),c=r.filter(m=>Fi(e,m,i,t,l));if(c.length===0)return null;const d=Hi(a,o),u=Math.floor(d.nextInRange(0,c.length)),h=c[u]??c[0],g=rt(e,h);return{enemy:ot(g,e.position,i),player:t,action:"inspect_noise"}},ju=(e,t)=>({enemy:{...e,actionPoints:Math.max(0,e.actionPoints-1)},player:t,action:"idle"}),Yu=(e,t,i,n,s,a,o,r)=>{switch(e){case"attack":return je(t,i,n,o);case"chase":return Ae(t,i,n,s,a);case"search":return ca(t,i,n,s,a);case"inspectNoise":return Qn(t,i,n,s,a,`${t.id}:${r.selectedState}:${r.now}`,et(t.id));case"flee":case"panic":return Si(t,i,n,s,o,a);case"patrol":return(t.alertLevel??L.IDLE)>=L.SUSPICIOUS?Ae(t,i,n,s,a):Qn(t,i,n,s,a,`${t.id}:patrol:${r.now}`,et(t.id));case"idle":return ju(t,i);default:return null}},Zt=(e,t)=>({enemy:{...e,actionPoints:0},player:t,action:"no_valid_move"}),$u=e=>{if(e){const t=hr(e);if(t)return t}return ii[$e]??Object.values(ii)[0]},eg=(e,t,i,n,s,a=[],o=Date.now())=>{let r={...e},l={...t};if(e.health<=0)return{enemy:r,player:l,action:"dead"};if(e.actionPoints<=0)return{enemy:r,player:l,action:"no_ap"};if(xe(e.position,t.position,e.attackRange)){const I=je(e,l,i,s);if(I)return I}const c=$u(e.aiProfileId),d=Gu(e,c.fsm.initialState),u=qu(c.fsm,d),h=ra(e,t,i),g=n.filter(I=>I.id!==e.id),p=Vu({enemy:e,player:t,mapArea:i,squad:g,npcs:a,hasLineOfSight:h,now:o});let m=null;const y={idle:()=>{m="idle"},patrol:()=>{m="patrol"},chase:()=>{m="chase"},search:()=>{m="search"},attack:()=>{m="attack"},inspectNoise:()=>{m="inspectNoise"},flee:()=>{m="flee"},panic:()=>{m="panic"}},{state:v,metadata:S}=u.step(p,y);let b=Yu(m??v,e,l,i,n,a,s,S)??null;if(b||(b=je(e,l,i,s)??Ae(e,l,i,n,a)??Si(e,l,i,n,s,a)??Zt(e,l)),p.hasLineOfSight){const I=b.enemy??e,D=xe(I.position,l.position,I.attackRange);if((b.action==="idle"||b.action==="inspect_noise")&&D){const W=je(I,l,i,s);W&&(b=W)}else if(b.action==="inspect_noise"&&!D){const W=Ae(I,l,i,n,a);W&&(b=W)}else if(b.action==="idle"&&!D){const W=Ae(I,l,i,n,a);W&&(b=W)}}if(!p.hasLineOfSight&&b.action==="idle"){const I=Ae(e,l,i,n,a);I&&(b=I)}if(!p.hasLineOfSight&&b.action==="inspect_noise"){const I=ca(e,l,i,n,a)??Ae(e,l,i,n,a);I&&(b=I)}if(p.healthRatio<=.4&&b.action!=="seek_cover"){const I=Si(e,l,i,n,s,a);I&&(b=I)}if(b.action==="move"&&b.enemy&&b.enemy.position.x===e.position.x&&b.enemy.position.y===e.position.y){const I=wi(b.enemy,l,i,n,a);if(I){const D=rt(b.enemy,I);b={...b,enemy:ot(D,b.enemy.position,i)}}}const A=b.enemy??e,k=xe(A.position,l.position,A.attackRange),x=!!wi(A,l,i,n,a);b.action==="idle"&&!k&&!x&&(b=Zt(A,l));const T=b.enemy??A,H=xe(T.position,l.position,T.attackRange);if(p.hasLineOfSight&&H&&!["attack","attack_missed","seek_cover","flee","dead","no_ap"].includes(b.action)){const I=je(T,l,i,s);I&&(b=I)}b.action==="idle"&&!p.hasLineOfSight&&!k&&(b=Zt(b.enemy??e,l));const w=u.getSnapshot();return r=Uu(b.enemy,c.id,w,S),l=b.player,{...b,enemy:r,player:l}},wi=(e,t,i,n,s=[])=>{const a=n.filter(h=>h.id!==e.id),o=Math.max(1,Math.ceil(e.attackRange)),r=[];for(let h=-o;h<=o;h+=1)for(let g=-o;g<=o;g+=1){if(h===0&&g===0)continue;const p={x:t.position.x+h,y:t.position.y+g};Ne(p,i)&&xe(p,t.position,e.attackRange)&&r.push(p)}const l=r.sort((h,g)=>{const p=ie(e.position,h),m=ie(e.position,g);return p-m});let c=null;for(const h of l){if(!ye(h,i,t,a,{npcs:s}))continue;const g=Bi(e.position,h,i,{player:t,enemies:a,npcs:s});if(g.length!==0&&(!c||g.length<c.length)&&(c=g,g.length===1))break}if(c&&c.length>0)return c[0];const u=Wi(e.position).filter(h=>Fi(e,h,i,t,a));return u.length===0?null:u.reduce((h,g)=>{const p=ie(g,t.position),m=ie(h,t.position);return p<m?g:h},u[0])},Zu=(e,t,i,n,s,a=[])=>{var h,g;if(s.length===0||(g=(h=i.tiles[e.position.y])==null?void 0:h[e.position.x])!=null&&g.provideCover)return null;const o=n.filter(p=>p.id!==e.id);let r=null;for(const p of s){if(!Ne(p,i)||!ye(p,i,t,o,{npcs:a}))continue;const m=Bi(e.position,p,i,{player:t,enemies:o,npcs:a});if(m.length!==0&&(!r||m.length<r.length)&&(r=m,m.length===1))break}if(r&&r.length>0)return r[0];const c=Wi(e.position).filter(p=>Fi(e,p,i,t,o));if(c.length===0)return null;const d=c.filter(p=>s.some(m=>m.x===p.x&&m.y===p.y));if(d.length>0)return d[0];const u=Xu(e.position,s);return u?c.reduce((p,m)=>{const y=ie(m,u),v=ie(p,u);return y<v?m:p},c[0]):null},Xu=(e,t)=>t.length===0?null:t.reduce((i,n)=>{const s=ie(e,n),a=ie(e,i);return s<a?n:i},t[0]),Wi=e=>[{x:e.x+1,y:e.y},{x:e.x-1,y:e.y},{x:e.x,y:e.y+1},{x:e.x,y:e.y-1}],tg=(e,t,i,n=1)=>{let s=L.IDLE;const a=[];return{updatedEnemies:e.map(r=>{if(!r.visionCone)return a.push({enemy:r,playerVisible:!1}),r;const l=ra(r,t,i);let c=Pu(r,l,n);if(l&&(c=Mu(c,t.position),c.lastKnownPlayerPosition=t.position),a.push({enemy:c,playerVisible:l}),c.alertLevel){const d=kt(c.alertLevel),u=kt(s);d>u&&(s=c.alertLevel)}return c}),maxAlertLevel:s,guardPerception:a}},kt=e=>{switch(e){case L.IDLE:return 0;case L.SUSPICIOUS:return 1;case L.INVESTIGATING:return 2;case L.ALARMED:return 3;default:return 0}},ig=(e,t)=>{const i=kt(e);if(kt(t)<=i)return null;switch(t){case L.SUSPICIOUS:return"alertSuspicious";case L.INVESTIGATING:return"alertInvestigating";case L.ALARMED:return"alertAlarmed";default:return null}},ng=(e,t)=>e===L.ALARMED&&!t,sg=()=>Re.reinforcementDelay,Qu=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}],Ct=(e,t)=>{var n;const i=(n=e.tiles[t.y])==null?void 0:n[t.x];return i?i.cover?1:i.provideCover?.75:0:0},Ju=e=>{var t;return((t=e.equipped.weapon)==null?void 0:t.damage)??fi},da=e=>{var t;return((t=e.equipped.weapon)==null?void 0:t.range)??1},eh=e=>{var s;const t=((s=e.equipped.weapon)==null?void 0:s.apCost)??Je,i=Number.isFinite(e.encumbrance.attackApMultiplier)?Math.max(e.encumbrance.attackApMultiplier,0):Number.POSITIVE_INFINITY,n=Ii(e)?0:Math.ceil(Math.max(0,t)*i);return Number.isFinite(n)?n:Number.POSITIVE_INFINITY},qi=e=>e.filter(t=>t.health>0),Jn=(e,t)=>t.length===0?Number.POSITIVE_INFINITY:t.reduce((i,n)=>{const s=ie(e,n.position);return s<i?s:i},Number.POSITIVE_INFINITY),ua=e=>Number.isFinite(e)?e:Number.NEGATIVE_INFINITY,th=(e,t)=>{const{player:i,enemies:n,map:s,profile:a}=e,o=qi(n),r=eh(i);if(!Number.isFinite(r)||r>i.actionPoints)return[];const l=Ju(i),c=da(i),d=Ct(s,i.position);return o.filter(u=>xe(i.position,u.position,c)).map(u=>{const h=ie(i.position,u.position),g=u.maxHealth>0?u.health/u.maxHealth:1,p=Ct(s,u.position),m=l*(p>0?.75:1),y=(1-g)*a.weights.focusLowestHealth*m,v=a.weights.focusOverwatchThreat*u.damage*.05,S=d<.5?.25:0,M=t?a.weights.retreatBias*(m*.2+(d<.5?2:0)):0,b=i.actionPoints-r,A=b<a.thresholds.apReserve?(a.thresholds.apReserve-b)*.4:0,k=a.weights.attackBias*m+y+v-S-M-A,x=[];return x.push(`Distance ${h}`),x.push(`Expected damage ${m.toFixed(1)}`),y>.1&&x.push("Target vulnerable"),M>.1&&x.push("Panic dampening attack"),A>.1&&x.push("Preserve AP reserve"),{type:"attack",targetId:u.id,targetName:u.name,targetPosition:u.position,expectedDamage:m,apCost:r,distance:h,score:ua(k),summary:`Attack ${u.name}`,rationale:x}})},ih=(e,t)=>{const{player:i,enemies:n,map:s,profile:a}=e;if(i.actionPoints<=0)return[];const o=qi(n);if(o.length===0)return[];const r=Ct(s,i.position),l=Jn(i.position,o),c=da(i),d=[];return Qu.forEach(u=>{const h={x:i.position.x+u.x,y:i.position.y+u.y};if(!ye(h,s,i,o))return;const g=Ct(s,h),p=Math.max(0,g-r),m=Jn(h,o),y=l>0?l-m:0,v=a.weights.pursuitAggression*(c>0?y/c:0),S=t||a.weights.retreatBias>.8?a.weights.retreatBias*Math.max(0,m-l):0,M=a.weights.maintainCover*g,b=i.actionPoints-1,A=b<a.thresholds.apReserve?(a.thresholds.apReserve-b)*.35:0,k=M+v+S-Math.max(0,-y)*.1-A,x=[];p>.01?x.push("Gain cover"):g>.4&&x.push("Maintain cover"),y>.2&&x.push("Advance on target"),S>.2&&x.push("Create distance"),A>.1&&x.push("Hold AP reserve"),d.push({type:"move",destination:h,coverGain:p,distanceToNearestEnemy:m,apCost:1,score:ua(k),summary:p>0?"Move to cover":"Reposition",rationale:x})}),d},nh=()=>({type:"wait",score:-.5,summary:"Hold position",rationale:["No advantageous action"]}),sh=e=>{const{player:t,profile:i,enemies:n}=e;if(qi(n).length===0)return{type:"wait",score:Number.NEGATIVE_INFINITY,summary:"No targets",rationale:["No living enemies"]};const o=(t.maxHealth>0?t.health/t.maxHealth:1)<=i.thresholds.panicHealthFraction,r=th(e,o),l=ih(e,o),c=nh();return[...r,...l,c].reduce((h,g)=>!h||g.score>h.score?g:h,null)??c},ah=_i("AutoBattleController"),es=(e,t)=>{if(!e)return t.hudPauseReasons.none;switch(e){case"manual_input":return t.hudPauseReasons.manualInput;case"dialogue":return t.hudPauseReasons.dialogue;case"objective":return t.hudPauseReasons.objective;case"resources":return t.hudPauseReasons.resources;case"ap":return t.hudPauseReasons.ap;case"settings":default:return t.hudPauseReasons.none}},Xt=220;class ag{constructor(t,i){f(this,"dispatch");f(this,"getState");f(this,"lastSignature",null);f(this,"currentStatus","idle");f(this,"currentReason",null);f(this,"manualOverride",!1);f(this,"turnStartTimestamp",null);f(this,"lastProcessedTurn",null);f(this,"pendingBufferTimeout",null);this.dispatch=t,this.getState=i.getState.bind(i)}notifyManualOverride(t){this.manualOverride=!0,this.lastSignature=null;const n=this.getState().settings.locale,s=Ji(n).autoBattle,a=en(n).logs,o=es(t,s);this.dispatch(Pn({status:"paused",reason:t})),this.dispatch(me(a.autoBattlePaused(o))),this.currentStatus="paused",this.currentReason=t}update(t){if(!t.enabled){this.resetStatus("idle",null,t),this.manualOverride=!1,this.lastSignature=null,this.clearTurnBuffer(),this.lastProcessedTurn=null;return}if(this.manualOverride){this.resetStatus("paused","manual_input",t),this.clearTurnBuffer();return}if(t.isPlayerTurn){if(this.lastProcessedTurn!==t.turnCount){this.lastProcessedTurn=t.turnCount,this.turnStartTimestamp=this.now(),this.lastSignature=null,this.resetStatus("idle",null,t),this.scheduleBufferedUpdate(Xt);return}if(this.turnStartTimestamp!==null){const l=this.now()-this.turnStartTimestamp;if(l<Xt){this.scheduleBufferedUpdate(Xt-l);return}}}else this.clearTurnBuffer();const i=gn(t.profileId),n=i.label,s=this.resolveFailSafe(t);if(s){this.resetStatus("paused",s,t),this.lastSignature=null,this.clearTurnBuffer();return}const a=this.buildSignature(t);if(a===this.lastSignature)return;const o=sh({player:t.player,enemies:t.enemies,map:t.mapArea,profile:i});this.dispatch(yc(this.buildDecisionSummary(o,i.id))),this.resetStatus("running",null,t);const r=this.buildDecisionDescription(o);this.dispatch(me(t.logStrings.autoBattleDecision(n,r))),this.executeDecision(o,t),this.lastSignature=a}clearTurnBuffer(){this.pendingBufferTimeout!==null&&(window.clearTimeout(this.pendingBufferTimeout),this.pendingBufferTimeout=null),this.turnStartTimestamp=null}scheduleBufferedUpdate(t){const i=Math.max(0,Math.round(t));this.pendingBufferTimeout!==null&&window.clearTimeout(this.pendingBufferTimeout),this.pendingBufferTimeout=window.setTimeout(()=>{this.pendingBufferTimeout=null;const n=this.buildContextFromStore();n&&this.update(n)},i)}buildContextFromStore(){const t=this.getState(),{autoBattleEnabled:i,autoBattleProfile:n,locale:s}=t.settings,a=t.world,o=a.currentMapArea??null;return{enabled:i,profileId:n,player:t.player.data,enemies:(o==null?void 0:o.entities.enemies)??[],mapArea:o,inCombat:a.inCombat,isPlayerTurn:a.isPlayerTurn,turnCount:a.turnCount,activeDialogueId:t.quests.activeDialogue.dialogueId,logStrings:en(s).logs,autoBattleStrings:Ji(s).autoBattle}}now(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}resolveFailSafe(t){return!t.inCombat||!t.isPlayerTurn||!t.mapArea?"settings":t.player.actionPoints<=0?"ap":t.activeDialogueId?"dialogue":t.enemies.some(i=>i.health>0)?null:"settings"}resetStatus(t,i,n){if(!(this.currentStatus===t&&this.currentReason===i)){if(this.currentStatus=t,this.currentReason=i,this.dispatch(Pn({status:t,reason:i})),t==="running"){this.dispatch(me(n.logStrings.autoBattleEngaged(gn(n.profileId).label)));return}if(t==="paused"){const s=es(i,n.autoBattleStrings);this.dispatch(me(n.logStrings.autoBattlePaused(s)))}}}buildSignature(t){const{player:i}=t;return[t.turnCount,i.actionPoints,i.position.x,i.position.y,t.enemies.map(n=>`${n.id}:${n.health}`).join("|")].join(":")}buildDecisionSummary(t,i){return{profileId:i,action:t.summary,targetId:t.type==="attack"?t.targetId:void 0,targetName:t.type==="attack"?t.targetName:void 0,score:t.score,explanation:t.rationale.join(", "),timestamp:Date.now()}}buildDecisionDescription(t){const i=t.rationale.length>0?t.rationale[0]:"";return i?`${t.summary} (${i})`:t.summary}executeDecision(t,i){switch(t.type){case"attack":this.executeAttack(t,i);break;case"move":this.executeMove(t,i);break;case"wait":default:this.executeWait(i);break}}executeAttack(t,i){var u;const n=this.getState(),s=n.player.data,a=n.world.currentMapArea.entities.enemies.find(h=>h.id===t.targetId);if(!a||a.health<=0){ah.warn("Attack target no longer valid; falling back to wait",{targetId:t.targetId}),this.executeWait(i);return}const o=n.world.currentMapArea,r=(u=o.tiles[a.position.y])==null?void 0:u[a.position.x],l=(r==null?void 0:r.provideCover)??!1,c=sa(s,a,{isBehindCover:l,mapArea:o});this.dispatch(rr(c.newAttacker)),this.dispatch(Zr(c.newTarget)),c.events&&c.events.forEach(h=>this.dispatch(me(h.message))),c.success?(this.dispatch(me(i.logStrings.hitEnemy(t.targetName,Math.round(c.damage??t.expectedDamage)))),this.dispatch(Ol({id:Q(),value:Math.round(c.damage??t.expectedDamage),gridX:a.position.x,gridY:a.position.y,type:c.isCritical?"crit":"damage"}))):this.dispatch(me(i.logStrings.missedEnemy(t.targetName))),c.newAttacker.actionPoints<=0&&this.dispatch(ht())}executeMove(t,i){this.dispatch(nr(t.destination)),this.dispatch(dn(-t.apCost)),i.player.actionPoints-t.apCost<=0&&this.dispatch(ht())}executeWait(t){const i=Ii(t.player)?0:Je;t.player.actionPoints<=i?this.dispatch(ht()):(this.dispatch(dn(-t.player.actionPoints)),this.dispatch(ht()))}}export{_m as $,L as A,Jm as B,J as C,$r as D,Ps as E,Kr as F,jm as G,F as H,Um as I,_i as J,sg as K,Up as L,Qm as M,dp as N,xh as O,Ah as P,Zh as Q,at as R,Sh as S,$h as T,_u as U,Fh as V,Rp as W,$d as X,Ol as Y,Vp as Z,Op as _,Sm as a,$p as a$,Bm as a0,Wm as a1,ag as a2,Vd as a3,gi as a4,Xm as a5,Bi as a6,ye as a7,E as a8,ph as a9,Mp as aA,Am as aB,dn as aC,vm as aD,Fm as aE,Nm as aF,Fp as aG,Ip as aH,Po as aI,vh as aJ,kh as aK,Ti as aL,Yt as aM,Ud as aN,Gd as aO,Qp as aP,hh as aQ,eo as aR,Ci as aS,Ch as aT,zp as aU,qp as aV,Wp as aW,Kp as aX,Jt as aY,Yd as aZ,dm as a_,fh as aa,yh as ab,Sp as ac,nr as ad,Pp as ae,Em as af,tg as ag,Re as ah,Zr as ai,Tm as aj,ig as ak,ng as al,Ap as am,Mh as an,ht as ao,Dp as ap,eg as aq,um as ar,rr as as,sp as at,Je as au,Ii as av,xe as aw,sa as ax,am as ay,jp as az,mm as b,no as b0,gh as b1,mh as b2,_h as b3,Xp as b4,Jp as b5,wp as b6,O as b7,Zm as b8,pm as b9,Wh as bA,Pt as bB,qh as bC,jh as bD,Vh as bE,Uh as bF,bh as bG,Gh as bH,Kh as bI,np as bJ,rp as bK,pd as ba,nt as bb,wh as bc,tp as bd,ip as be,Lh as bf,im as bg,nm as bh,Jr as bi,Xr as bj,Cl as bk,om as bl,fn as bm,Ym as bn,wo as bo,ki as bp,$a as bq,op as br,ss as bs,uh as bt,Pi as bu,Fa as bv,dh as bw,cp as bx,lp as by,Hh as bz,ri as c,gm as d,bm as e,me as f,fm as g,ym as h,Lp as i,_p as j,aa as k,km as l,oa as m,gp as n,bp as o,hp as p,pp as q,Cm as r,Im as s,yp as t,Dt as u,Dm as v,xm as w,li as x,di as y,Km as z};
