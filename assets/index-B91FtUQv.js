const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/GameMenu-Cc2oLOFS.js","assets/vendor-Cc93p67d.js","assets/phaser-DkaA9Y8j.js","assets/game-content-BqNkj8Jh.js","assets/game-core-BhyilOjL.js","assets/EnhancedButton-DVdhyrz_.js","assets/CharacterCreationScreen-BYE7y1eW.js","assets/Tooltip-CnX58fCC.js","assets/CharacterScreen-ByXRfNzd.js","assets/LevelUpModal-wUvGPm-b.js","assets/PerkSelectionPanel-CJHwa9xc.js","assets/LevelUpPointAllocationPanel-C5HV9Ta6.js"])))=>i.map(i=>d[i]);
var Qi=Object.defineProperty;var Zi=(e,t,n)=>t in e?Qi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var Ae=(e,t,n)=>Zi(e,typeof t!="symbol"?t+"":t,n);import{r as c,u as R,j as i,e as K,f as $e,g as Ji,R as Bt,P as eo,h as to}from"./vendor-Cc93p67d.js";import{P as Be}from"./phaser-DkaA9Y8j.js";import{B as no,M as ro,u as so,C as X,w as io,l as Pr,c as Me,r as ti,s as oo,A as he,a as ao,b as lo,d as ir,e as ni,f as N,g as Dr,h as co,i as ri,j as rn,k as Un,m as Vn,n as uo,o as fo,p as mo,q as _r,t as po,v as go,x as ho,y as yo,z as si,D as bo,E as Lr,F as xo,S as jr,G as wo,H as kn,I as En,J as Tn,K as or,L as vo,N as ii,O as So,P as Io,Q as Pt,R as Dt,T as ko,U as Nr,V as Eo,W as To,X as Or,Y as Cn,Z as zr,_ as _t,$ as qt,a0 as Fr,a1 as ar,a2 as wt,a3 as an,a4 as Br,a5 as Xt,a6 as sn,a7 as Lt,a8 as Co,a9 as Mo,aa as Mn,ab as An,ac as $r,ad as Ao,ae as Ro,af as Wr,ag as xt,ah as st,ai as Po,aj as Do,ak as _o,al as Hr,am as Lo,an as jo,ao as No,ap as Rn,aq as Oo,ar as Yn,as as ln,at as zo,au as Fo,av as Bo,aw as $o,ax as Wo,ay as Ho,az as Go,aA as Uo,aB as Vo,aC as Yo,aD as Ko,aE as Kn,aF as qo,aG as oi,aH as it,aI as Gr,aJ as Xo,aK as Qo,aL as Zo,aM as Jo,aN as ea,aO as ta,aP as na,aQ as ra,aR as sa,aS as cn,aT as ia,aU as oa,aV as aa,aW as la,aX as ca,aY as da,aZ as ua,a_ as fa,a$ as ma,b0 as pa,b1 as lr,b2 as Ur,b3 as Vr,b4 as ga,b5 as ha,b6 as ya,b7 as ba,b8 as ve,b9 as ai,ba as xa,bb as wa,bc as Yr,bd as va,be as Sa,bf as Pn,bg as Ia}from"./game-core-BhyilOjL.js";import{p as tt,P as we,o as We,v as Ye,n as li,h as ka,q as Ea,e as Ta}from"./game-content-BqNkj8Jh.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();const Ca="modulepreload",Ma=function(e){return"/the-getaway/"+e},Kr={},vt=function(t,n,r){let s=Promise.resolve();if(n&&n.length>0){let l=function(f){return Promise.all(f.map(p=>Promise.resolve(p).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),d=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));s=l(n.map(f=>{if(f=Ma(f),f in Kr)return;Kr[f]=!0;const p=f.endsWith(".css"),u=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${f}"]${u}`))return;const g=document.createElement("link");if(g.rel=p?"stylesheet":Ca,p||(g.as="script"),g.crossOrigin="",g.href=f,d&&g.setAttribute("nonce",d),document.head.appendChild(g),p)return new Promise((b,C)=>{g.addEventListener("load",b),g.addEventListener("error",()=>C(new Error(`Unable to preload CSS for ${f}`)))})}))}function o(l){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=l,window.dispatchEvent(a),!a.defaultPrevented)throw l}return s.then(l=>{for(const a of l||[])a.status==="rejected"&&o(a.reason);return t().catch(o)})},Aa=({onRendererInfo:e})=>{const t=c.useRef(null),n=c.useRef(null),[r,s]=c.useState({label:"Detecting…",detail:"Negotiating renderer"}),o=c.useRef({width:0,height:0});c.useEffect(()=>{if(console.log("[GameCanvas] useEffect running"),console.log("[GameCanvas] gameContainerRef.current:",t.current),!t.current){console.error("[GameCanvas] No container ref available");return}const f=t.current.offsetWidth,p=t.current.offsetHeight;console.log("[GameCanvas] Container dimensions:",{parentWidth:f,parentHeight:p});const u=B=>{switch(B){case Be.WEBGL:return{label:"WebGL",detail:"GPU accelerated (shaders, batching)",type:B};case Be.CANVAS:return{label:"Canvas",detail:"CPU rasterization fallback",type:B};case Be.HEADLESS:return{label:"Headless",detail:"No renderer active",type:B};default:return{label:"Detecting…",detail:"Negotiating renderer",type:B}}},g=()=>{const B=n.current;if(!B||!B.renderer){s({label:"Detecting…",detail:"Negotiating renderer",type:void 0});return}const Y=u(B.renderer.type);s(Y)},b={type:Be.AUTO,width:f>0?f:800,height:p>0?p:600,backgroundColor:"#05070d",parent:t.current,scene:[no,ro],scale:{mode:Be.Scale.FIT,autoCenter:Be.Scale.CENTER_BOTH,width:f>0?f:800,height:p>0?p:600},render:{antialias:!0,pixelArt:!1,roundPixels:!1,transparent:!1,powerPreference:"high-performance"},physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!1}},pixelArt:!1,roundPixels:!1,transparent:!1};if(console.log("[GameCanvas] Phaser config:",b),!n.current)try{n.current=new Be.Game(b);const B=n.current;B.isBooted?g():B.events.once(Be.Core.Events.READY,g),console.log("[GameCanvas] Phaser game initialized successfully")}catch(B){console.error("[GameCanvas] Error initializing Phaser:",B)}let C,y=null;const A={width:f,height:p},T=(B,Y)=>{if(!n.current)return;const L=Math.max(0,Math.floor(B)),Q=Math.max(0,Math.floor(Y));if(L===0||Q===0)return;const{width:F,height:le}=o.current;if(F===L&&le===Q)return;o.current={width:L,height:Q},n.current.scale.resize(L,Q)},S=(B,Y)=>{typeof B=="number"&&typeof Y=="number"?(A.width=B,A.height=Y):t.current&&(A.width=t.current.offsetWidth,A.height=t.current.offsetHeight),y!==null&&window.clearTimeout(y),y=window.setTimeout(()=>{y=null,T(A.width,A.height)},40)},z=()=>{S()};return typeof ResizeObserver<"u"&&t.current&&(C=new ResizeObserver(B=>{const Y=B[0];Y&&S(Y.contentRect.width,Y.contentRect.height)}),C.observe(t.current)),window.addEventListener("resize",z),()=>{console.log("[GameCanvas] Cleanup running"),window.removeEventListener("resize",z),y!==null&&window.clearTimeout(y),C&&C.disconnect(),n.current&&(n.current.events.off(Be.Core.Events.READY,g),n.current.destroy(!0),n.current=null,console.log("[GameCanvas] Phaser game destroyed"))}},[]),console.log("[GameCanvas] Rendering component");const l=R(f=>f.settings.testMode),a=R(f=>f.settings.lightsEnabled),d=R(f=>f.settings.visualQualityPreset);return c.useEffect(()=>{so({lightsEnabled:a,qualityPreset:d})},[a,d]),c.useEffect(()=>{n.current&&window.requestAnimationFrame(()=>{window.dispatchEvent(new Event("resize"))})},[l]),c.useEffect(()=>{e&&e(r)},[e,r]),i.jsx("div",{style:{position:"relative",width:"100%",height:"100%",backgroundColor:"var(--color-gunmetal-900)",overflow:"hidden",display:"flex",justifyContent:"center",alignItems:"center",pointerEvents:"none"},children:i.jsx("div",{ref:t,style:{position:"absolute",width:"100%",height:"100%",top:0,left:0,right:0,bottom:0,display:"flex",justifyContent:"center",alignItems:"center",backgroundColor:"var(--color-gunmetal-900)",minWidth:"400px",minHeight:"300px",pointerEvents:"auto"}})})},Ra=()=>({type:"wait",score:0,summary:"Hold position",rationale:["No safer move available"]}),Pa=e=>Ra(),Dn=typeof window<"u"?window:globalThis;class Da{constructor(){Ae(this,"timeouts",new Set)}schedule(t,n){const r=Dn.setTimeout(()=>{this.timeouts.delete(r),t()},n);return this.timeouts.add(r),r}cancel(t){t!=null&&(Dn.clearTimeout(t),this.timeouts.delete(t))}dispose(){this.timeouts.forEach(t=>{Dn.clearTimeout(t)}),this.timeouts.clear()}}const _a=()=>new Da,Ce=["evening","night"],La=[{zoneId:"downtown_checkpoint",cameras:[{id:"downtown_training_static",type:"static",position:{x:28,y:18},range:6,fieldOfView:90,activationPhases:Ce,sweep:{angles:[300,270,240],cycleDurationMs:2600}},{id:"downtown_static_01",type:"static",position:{x:18,y:22},range:8,fieldOfView:90,activationPhases:Ce,sweep:{angles:[310,270,230],cycleDurationMs:3200}},{id:"downtown_static_02",type:"static",position:{x:52,y:20},range:8,fieldOfView:90,activationPhases:Ce,sweep:{angles:[45,90,135],cycleDurationMs:3e3}},{id:"downtown_motion_01",type:"motionSensor",position:{x:36,y:44},range:4,fieldOfView:360,activationPhases:Ce,motionRadius:4},{id:"downtown_drone_01",type:"drone",position:{x:70,y:16},range:10,fieldOfView:90,activationPhases:Ce,patrolPath:{waypoints:[{x:70,y:16},{x:78,y:28},{x:64,y:34},{x:56,y:22}],travelDurationMs:12e3},sweep:{angles:[0,45,0,-45],cycleDurationMs:2800}}]},{zoneId:"gov_complex",cameras:[{id:"gov_static_01",type:"static",position:{x:14,y:12},range:9,fieldOfView:90,activationPhases:Ce,sweep:{angles:[315,270,225,180],cycleDurationMs:3600}},{id:"gov_static_02",type:"static",position:{x:40,y:10},range:9,fieldOfView:90,activationPhases:Ce,sweep:{angles:[0,45,90],cycleDurationMs:3600}},{id:"gov_motion_01",type:"motionSensor",position:{x:27,y:26},range:4,fieldOfView:360,activationPhases:Ce,motionRadius:4},{id:"gov_motion_02",type:"motionSensor",position:{x:48,y:26},range:4,fieldOfView:360,activationPhases:Ce,motionRadius:4},{id:"gov_drone_01",type:"drone",position:{x:56,y:18},range:12,fieldOfView:90,activationPhases:Ce,patrolPath:{waypoints:[{x:56,y:18},{x:70,y:24},{x:60,y:36},{x:46,y:28}],travelDurationMs:14e3},sweep:{angles:[15,0,-15],cycleDurationMs:2600}},{id:"gov_static_03",type:"static",position:{x:32,y:6},range:9,fieldOfView:90,activationPhases:Ce,sweep:{angles:[200,240,280],cycleDurationMs:3400}}]},{zoneId:"corporate_plaza",cameras:[{id:"corp_static_01",type:"static",position:{x:12,y:12},range:8,fieldOfView:90,activationPhases:Ce,sweep:{angles:[40,0,-40],cycleDurationMs:3e3}},{id:"corp_motion_01",type:"motionSensor",position:{x:26,y:22},range:4,fieldOfView:360,activationPhases:Ce,motionRadius:4},{id:"corp_drone_01",type:"drone",position:{x:34,y:14},range:10,fieldOfView:90,activationPhases:Ce,patrolPath:{waypoints:[{x:34,y:14},{x:42,y:16},{x:40,y:28},{x:30,y:24}],travelDurationMs:1e4},sweep:{angles:[90,120,90,60],cycleDurationMs:2400}}]},{zoneId:"industrial_corridor",cameras:[{id:"ind_static_01",type:"static",position:{x:8,y:32},range:9,fieldOfView:90,activationPhases:Ce,sweep:{angles:[180,210,240],cycleDurationMs:3200}},{id:"ind_motion_01",type:"motionSensor",position:{x:22,y:40},range:4,fieldOfView:360,activationPhases:Ce,motionRadius:4}]},{zoneId:"resistance_safehouse",cameras:[]}],ja=e=>{const t=La.find(n=>n.zoneId===e);return t?t.cameras.map(n=>({...n})):[]},Na=400,Oa=3200,ci=e=>{const t=typeof e=="number"&&Number.isFinite(e)?Math.abs(e):Oa;return Math.max(Na,t)},zt=e=>{const t=io(e);return t<0?t+360:t},za=e=>{var r;const t=((r=e.sweep)==null?void 0:r.angles)??[],n=t.length>0?zt(t[0]):zt(e.fieldOfView>=360?0:e.fieldOfView/2);return{...e,alertState:X.IDLE,detectionProgress:0,isActive:!1,hackState:{},lastDetectionTimestamp:void 0,currentDirection:n,sweepDirection:1,sweepElapsedMs:0,sweepIndex:0,patrolProgressMs:0,currentWaypointIndex:0,networkAlertContributionAt:void 0,trackingPlayer:!1,trackingDirection:void 0}},di=(e,t,n,r)=>{const s=e.sweep;if(!s||s.angles.length===0)return{direction:n?r:e.currentDirection,sweepDirection:e.sweepDirection??1,sweepIndex:e.sweepIndex??0,sweepElapsedMs:e.sweepElapsedMs??0};const o=s.angles,l=o.length;if(l===1){const S=n?r+o[0]:o[0];return{direction:zt(S),sweepDirection:e.sweepDirection??1,sweepIndex:0,sweepElapsedMs:0}}let a=e.sweepDirection??1,d=Me(e.sweepIndex??0,0,l-1),f=(e.sweepElapsedMs??0)+t;const p=ci(s.cycleDurationMs)/(l-1);for(;f>=p;){f-=p;let S=d+a;S>=l?(a=-1,S=l-2):S<0&&(a=1,S=1),d=Me(S,0,l-1)}const u=Me(d+a,0,l-1),g=Me(p===0?0:f/p,0,1),b=o[d],C=o[u],y=oo(b,C),A=b+y*g,T=n?r+A:A;return{direction:zt(T),sweepDirection:a,sweepIndex:d,sweepElapsedMs:f}},ui=(e,t)=>{const n=di(e,t,!1,0);return e.currentDirection=n.direction,e.sweepDirection=n.sweepDirection,e.sweepIndex=n.sweepIndex,e.sweepElapsedMs=n.sweepElapsedMs,e},_n=(e,t)=>t===0?0:e<0?t-1:e>=t?0:e,Fa=(e,t)=>{const n=e.patrolPath;if(!n||n.waypoints.length===0)return ui(e,t);const r=n.waypoints,s=ci(n.travelDurationMs)/r.length;let o=(e.patrolProgressMs??0)+t,l=_n(e.currentWaypointIndex??0,r.length),a=_n(l+1,r.length);for(;o>=s;)o-=s,l=a,a=_n(l+1,r.length);const d=r[l],f=r[a],p=s<=0?0:Me(o/s,0,1),u=Pr(d.x,f.x,p),g=Pr(d.y,f.y,p),b=Math.atan2(f.y-d.y,f.x-d.x),C=ti(b),y=di(e,t,!0,C);return e.position={x:u,y:g},e.currentDirection=y.direction,e.currentWaypointIndex=l,e.patrolProgressMs=o,e.sweepDirection=y.sweepDirection,e.sweepIndex=y.sweepIndex,e.sweepElapsedMs=y.sweepElapsedMs,e},Ba=(e,t)=>{let n;switch(e.type){case"drone":n=Fa(e,t);break;case"motionSensor":case"static":default:n=ui(e,t);break}return n.trackingPlayer&&typeof n.trackingDirection=="number"&&(n.currentDirection=zt(n.trackingDirection)),n},$a=(e,t)=>{const{hackState:n}=e;return n?!!(n.disabledUntil&&n.disabledUntil>t):!1},Wa=(e,t)=>{const{hackState:n}=e;return!!(n!=null&&n.loopFootageUntil&&n.loopFootageUntil>t)},Ln=e=>{switch(e){case he.IDLE:return 0;case he.SUSPICIOUS:return 1;case he.INVESTIGATING:return 2;case he.ALARMED:return 3;default:return 0}},fi=(e,t)=>{const n=e.x-t.x,r=e.y-t.y;return Math.sqrt(n*n+r*r)},mi=(e,t)=>t.blackoutTier==="rolling"?.55:t.blackoutTier==="brownout"?.65:e==="night"?.7:e==="evening"||e==="morning"?.85:1,pi=e=>{var l;const t=((l=e.skillTraining)==null?void 0:l.stealth)??0,n=e.skills.agility??5,r=Math.min(t/120,.35),s=Math.max(0,(n-6)*.03),o=Math.min(.45,r+s);return Me(1-o,.55,1)},gi=e=>{switch(e.movementProfile){case"silent":return .7;case"sprint":return 1.15;default:return 1}},Ha=e=>{const t=e.label;return typeof t=="string"&&t.trim().length>0?t:e.id.split(/[_-]/g).map(n=>n.charAt(0).toUpperCase()+n.slice(1)).join(" ")},Ga=({enemy:e,player:t,mapArea:n,timeOfDay:r,environmentFlags:s,playerVisible:o,timestamp:l})=>{const a=e.visionCone;if(!a||!o)return null;const d=e.alertLevel??he.IDLE,f=fi(e.position,t.position),p=a.range||8,u=Me(.7+Ln(d)*.06,.6,.95),g=Me(1-f/(p+1),.25,1),b=mi(r,s),C=pi(t),y=gi(t);return{witnessId:e.id,witnessLabel:e.name??"Guard",targetId:t.id,zoneId:n.zoneId,areaId:n.id,timestamp:l,source:"guard",recognitionChannel:"face",baseCertainty:u,distanceModifier:g,lightingModifier:b,disguiseModifier:C,postureModifier:y,reported:Ln(d)>=Ln(he.INVESTIGATING),location:{...e.position}}},Ua=({camera:e,player:t,mapArea:n,timeOfDay:r,environmentFlags:s,timestamp:o,alertState:l})=>{const a=fi(e.position,t.position),d=e.range||8,f=l===X.ALARMED?.88:l===X.INVESTIGATING?.76:l===X.SUSPICIOUS?.65:.5,p=Me(1-a/(d+1),.3,1),u=mi(r,s),g=pi(t),b=gi(t);return{witnessId:e.id,witnessLabel:Ha(e),targetId:t.id,zoneId:n.zoneId,areaId:n.id,timestamp:o,source:"camera",recognitionChannel:"face",baseCertainty:f,distanceModifier:p,lightingModifier:u,disguiseModifier:g,postureModifier:b,reported:l===X.ALARMED,location:{...e.position}}},Va=100/3e3,qr=100/4e3,Ya=60,qn=100,Ka=6e4,qa=5*60*1e3,dn={},qe={},hi=(e,t)=>!e.activationPhases||e.activationPhases.length===0?!0:e.activationPhases.includes(t),Xa=e=>{const t=e%360;return t<0?t+360:t},Qa=(e,t)=>{const n=Math.atan2(t.position.y-e.position.y,t.position.x-e.position.x),r=ti(n);return Xa(r)},yi=(e,t)=>{const n=t.x-e.x,r=t.y-e.y;return Math.sqrt(n*n+r*r)},bi=(e,t)=>{var r;const n=(r=e.skillTraining)==null?void 0:r[t];return typeof n=="number"?n:0},Za=(e,t)=>{const n=e.type==="motionSensor"?e.motionRadius??e.range:e.range,r=bi(t,"stealth"),s=Me(r/200,0,.75);let o=n*(1-s);const l=t.movementProfile==="silent"?.8:t.movementProfile==="sprint"?1.2:1;return o*=l,t.stealthModeEnabled&&(o*=.75),Math.max(1,o)},Ja=(e,t,n,r,s,o,l)=>{if(!e.isActive)return{state:X.DISABLED,progress:0,detectionActive:!1,lastDetectionTimestamp:void 0};if($a(t,l))return{state:X.DISABLED,progress:0,detectionActive:!1,lastDetectionTimestamp:void 0};const a=Wa(t,l),d=Za(e,n),f=yi(e.position,n.position);let p=!1;if(!a)if(e.type==="motionSensor"){const C=n.movementProfile!=="silent";p=f<=d&&s&&C}else Un(e.position,n.position,{range:d,angle:e.fieldOfView,direction:e.currentDirection})&&Vn(e.position,n.position,r)&&(p=!0);let u=t.detectionProgress,g=t.lastDetectionTimestamp;if(p){const C=bi(n,"hacking"),y=Me(C/400,0,.25),A=n.movementProfile==="silent"?.7:n.movementProfile==="sprint"?1.2:1,T=n.stealthModeEnabled?.75:1;u+=Va*o*(1-y)*A*T,u=Math.min(qn,u),g=l}else{const C=t.trackingPlayer?qr*1.8:qr;u-=C*o,u=Math.max(0,u)}const b=nl(u);return b===X.ALARMED&&(u=qn),{state:b,progress:u,detectionActive:p,lastDetectionTimestamp:g}},el=(e,t,n)=>{qe[e]||(qe[e]=[]),qe[e].push({cameraId:t,timestamp:n}),qe[e]=qe[e].filter(r=>n-r.timestamp<=Ka)},tl=e=>{const t=qe[e];return t?t.length>=3:!1},Qt=e=>{switch(e){case X.ALARMED:return 4;case X.INVESTIGATING:return 3;case X.SUSPICIOUS:return 2;case X.IDLE:return 1;case X.DISABLED:default:return 0}},nl=e=>e>=qn?X.ALARMED:e>=Ya?X.INVESTIGATING:e>0?X.SUSPICIOUS:X.IDLE,rl=e=>{const{area:t,timeOfDay:n,dispatch:r,timestamp:s}=e,l=ja(t.zoneId).map(a=>{const d=za(a),f=hi(d,n);return d.isActive=f,d.alertState=f?X.IDLE:X.DISABLED,d.detectionProgress=0,d.lastDetectionTimestamp=void 0,d});r(lo({areaId:t.id,zoneId:t.zoneId,cameras:l,timestamp:s})),dn[t.id]={lastPlayerPosition:void 0,lastUpdateTimestamp:s,hudSnapshot:void 0},qe[t.id]=[]},Xr=e=>{const{areaId:t,dispatch:n}=e;n(ao({areaId:t})),delete dn[t],delete qe[t]},sl=e=>{const{zone:t,area:n,timeOfDay:r,dispatch:s,timestamp:o}=e;if(!t||!n)return;const l=[];let a=!1;Object.values(t.cameras).forEach(d=>{const f=hi(d,r);if(f===d.isActive&&(f||d.alertState===X.DISABLED&&(d.detectionProgress??0)===0))return;const p={isActive:f,detectionProgress:f?d.detectionProgress:0,lastDetectionTimestamp:f?d.lastDetectionTimestamp:void 0,alertState:f?X.IDLE:X.DISABLED,trackingPlayer:!1,trackingDirection:void 0};f?a=!0:a=a||d.isActive,l.push({cameraId:d.id,changes:p})}),l.forEach(d=>{s(ir({areaId:t.areaId,cameraId:d.cameraId,changes:d.changes,timestamp:o}))}),a&&r!=="day"&&r!=="morning"&&s(ni({visible:!0,timestamp:o}))},il=e=>{const{zone:t,mapArea:n,player:r,deltaMs:s,timestamp:o,dispatch:l,logStrings:a,reinforcementsScheduled:d,globalAlertLevel:f,timeOfDay:p,environmentFlags:u,worldTimeSeconds:g,onWitnessObservation:b}=e,C=dn[t.areaId]??{lastPlayerPosition:void 0},y=C.lastPlayerPosition,A=y?y.x!==r.position.x||y.y!==r.position.y:!1,T=k=>k.type==="motionSensor"?k.motionRadius??k.range:k.range;let S=0,z=0,B=X.IDLE,Y=null;const L=[];let Q=!1,F=!1;Object.values(t.cameras).forEach(k=>{const x={...k,position:{...k.position},hackState:{...k.hackState}};Ba(x,s);const q=Ja(x,k,r,n,A,s,o);if(x.alertState=q.state,x.detectionProgress=q.progress,x.lastDetectionTimestamp=q.lastDetectionTimestamp,x.alertState===X.DISABLED&&(x.detectionProgress=0),x.type!=="motionSensor")if(x.isActive&&q.detectionActive&&(x.alertState===X.SUSPICIOUS||x.alertState===X.INVESTIGATING||x.alertState===X.ALARMED)){const be=Qa(x,r);x.trackingPlayer=!0,x.trackingDirection=be,x.currentDirection=be}else x.trackingPlayer&&(x.trackingPlayer=!1,x.trackingDirection=void 0);else x.trackingPlayer&&(x.trackingPlayer=!1,x.trackingDirection=void 0);const G=x.alertState!==k.alertState,ie=x.currentDirection!==k.currentDirection,V=x.position.x!==k.position.x||x.position.y!==k.position.y,Z=Math.abs(x.detectionProgress-k.detectionProgress)>.1,ce=x.lastDetectionTimestamp!==k.lastDetectionTimestamp,ue=x.sweepDirection!==k.sweepDirection||x.sweepIndex!==k.sweepIndex||Math.abs((x.sweepElapsedMs??0)-(k.sweepElapsedMs??0))>.1,me=(x.trackingPlayer??!1)!==(k.trackingPlayer??!1),ye=x.trackingDirection!==k.trackingDirection;if(G&&(x.alertState===X.SUSPICIOUS||x.alertState===X.INVESTIGATING||x.alertState===X.ALARMED)){const pe=Ua({camera:x,player:r,mapArea:n,timeOfDay:p,environmentFlags:u,timestamp:g,alertState:x.alertState});b&&b(pe)}if((G||ie||V||Z||ce||ue||me||ye)&&L.push({cameraId:k.id,runtime:x,previous:k}),G&&x.alertState===X.ALARMED&&(F=!0,el(t.areaId,k.id,o)),x.isActive&&x.alertState!==X.DISABLED){const pe=T(x);yi(x.position,r.position)<=pe+.5&&(S+=1)}x.detectionProgress>z&&(z=x.detectionProgress,Y=k.id),Qt(x.alertState)>Qt(B)&&(B=x.alertState)}),L.forEach(({cameraId:k,runtime:x,previous:q})=>{const G={alertState:x.alertState,detectionProgress:x.detectionProgress,currentDirection:x.currentDirection,lastDetectionTimestamp:x.lastDetectionTimestamp,position:x.position,sweepDirection:x.sweepDirection,sweepIndex:x.sweepIndex,sweepElapsedMs:x.sweepElapsedMs,patrolProgressMs:x.patrolProgressMs,currentWaypointIndex:x.currentWaypointIndex,trackingPlayer:x.trackingPlayer,trackingDirection:x.trackingDirection};if(x.isActive||(G.detectionProgress=0,G.alertState=X.DISABLED,G.lastDetectionTimestamp=void 0,G.trackingPlayer=!1,G.trackingDirection=void 0),l(ir({areaId:t.areaId,cameraId:k,changes:G,timestamp:o})),q.alertState!==x.alertState){const ie=Qt(q.alertState);Qt(x.alertState)>ie&&(x.alertState===X.SUSPICIOUS?l(N(a.cameraAlertSuspicious)):x.alertState===X.INVESTIGATING?l(N(a.cameraAlertInvestigating)):x.alertState===X.ALARMED&&l(N(a.cameraAlertAlarmed)))}});const le=qe[t.areaId]??[];let ee=t.networkAlert;if(ee&&ee.expiresAt<=o&&(l(Dr({areaId:t.areaId,alert:null})),ee=null),!ee&&tl(t.areaId)){Q=!0;const k=le.slice(-3).map(x=>x.cameraId);ee={triggeredAt:o,expiresAt:o+qa,contributingCameraIds:k},l(Dr({areaId:t.areaId,alert:ee}))}const h={camerasNearby:S,detectionProgress:Number(Math.min(100,z).toFixed(2)),alertState:B,activeCameraId:Y,networkAlertActive:!!ee,networkAlertExpiresAt:(ee==null?void 0:ee.expiresAt)??null},w=C.hudSnapshot;(!w||w.camerasNearby!==h.camerasNearby||Math.abs(w.detectionProgress-h.detectionProgress)>.5||w.alertState!==h.alertState||w.activeCameraId!==h.activeCameraId||w.networkAlertActive!==h.networkAlertActive||w.networkAlertExpiresAt!==h.networkAlertExpiresAt)&&(l(co(h)),C.hudSnapshot=h),F&&!d?(l(N(a.reinforcementsIncoming)),l(ri()),l(rn(he.ALARMED))):Q?(l(N(a.curfewReinforcement)),l(rn(he.ALARMED))):F&&f!==he.ALARMED&&l(rn(he.ALARMED)),dn[t.areaId]={...C,lastPlayerPosition:{...r.position},lastUpdateTimestamp:o}},ot=[],ol=e=>{const t=ot.findIndex(n=>n.id===e.id);if(t>=0){ot[t]={...ot[t],...e},ot[t].fired=!1,ot[t].lastFiredAt=void 0;return}ot.push({...e})},al=e=>{e.forEach(ol)},ll=(e,t,n=Date.now())=>{const r=t();ot.forEach(s=>{s.once&&s.fired||typeof s.cooldownMs=="number"&&s.lastFiredAt!==void 0&&n-s.lastFiredAt<s.cooldownMs||!s.when(r)||(s.fire({dispatch:e,getState:t,now:n}),s.lastFiredAt=n,s.once&&(s.fired=!0))})},cl={low:[{id:"rumor.low.coyotes-logo",groupId:"slum-barflies",flag:"gangHeat",value:"low",storyFunction:"world-building",description:"Warm-up chatter when the streets are calm.",lines:["Coyotes rebranded again. Same howls, new accounting font.","CorpSec confiscated their synth-leather jackets. Fashion crime unit, I guess.","If the gang war is over, someone forgot to tell the bullet holes."]},{id:"rumor.low.tax-audit",groupId:"dock-liquor-patrons",flag:"gangHeat",value:"low",storyFunction:"foreshadow",description:"Hints at upcoming tensions despite low heat.",lines:["Heard the Coyotes scheduled a tax audit. They grow up so fast.","You know it’s quiet when the bartops stop vibrating.","Peace smells like ozone and unpaid protection money."]}],med:[{id:"rumor.med.return",groupId:"slum-barflies",flag:"gangHeat",value:"med",storyFunction:"misdirect",description:"Contradicts official statements to set up later payoffs.",lines:["Coyotes are back. Again. They brought merch this time.","Saw their lieutenant handing out coupons for muggings. 20% off with code “WHOOPS”.","If the city says everything is fine, duck."]},{id:"rumor.med.payroll",groupId:"dock-liquor-patrons",flag:"gangHeat",value:"med",storyFunction:"payoff",description:"Signals growing pressure around the docks.",lines:["Dock payroll went missing. Must have taken the scenic route through a heist.","CorpSec switched to hazard pay. They called it “enthusiasm adjustment”.","Graffiti keeps spelling “WE ARE TEMPORARY”. Someone stamped “UNTIL AUDIT COMPLETE” on top."]}],high:[{id:"rumor.high.curfew",groupId:"slum-barflies",flag:"gangHeat",value:"high",storyFunction:"foreshadow",description:"Signals impending clampdowns.",lines:["Curfew now starts before brunch. Crime brunch still sold out.","Coyotes swapped bullets for invoices. Same damage, more paperwork.","Saw CorpSec drones high-fiving. Never a good omen."]},{id:"rumor.high.wanted",groupId:"dock-liquor-patrons",flag:"gangHeat",value:"high",storyFunction:"payoff",description:"Pairs with power glitch triggers that reveal wanted posters.",lines:["CRTs keep flashing some wanted face. He already skipped town, obviously.","Dock sirens learned harmony. It’s unnerving in four-part.","When the lights flicker, we clap. Keeps the grid on edge."]}]},dl=e=>cl[e]??[],ul=[{id:"note.supply.norm.crate",flag:"supplyScarcity",value:"norm",storyFunction:"world-building",description:"Everyday logistics with a dry punchline.",preferredZoneId:"downtown_checkpoint",position:{x:28,y:26},lines:["[DATE STAMP SMEARED]","Shift log: 6 crates “medical”.","Counted 5.","Crate 6 coughing."]},{id:"note.supply.tight.ammo-iou",flag:"supplyScarcity",value:"tight",storyFunction:"misdirect",description:"Sets up later gag about returned bullets.",preferredZoneId:"downtown_checkpoint",position:{x:34,y:30},lines:["IOU: 3 bullets. Return unused.","Signed: Depot Clerk, with love.","PS: Bring wipes."]},{id:"note.supply.rationed.bullet-receipt",flag:"supplyScarcity",value:"rationed",storyFunction:"payoff",description:"Punchline for earlier IOU rumor.",preferredZoneId:"downtown_checkpoint",position:{x:36,y:28},lines:["Receipt: All three bullets returned.","Two still lodged in debtor.","Processing fee waived."]},{id:"note.curfew.tier2",flag:"curfewLevel",value:2,storyFunction:"foreshadow",description:"Hints at creeping curfew changes.",preferredZoneId:"downtown_checkpoint",position:{x:40,y:24},lines:["Memo: Curfew trial balloon.","Please begin night at 3 PM.","Public feedback: “Already dark”."]},{id:"note.gangHeat.high",flag:"gangHeat",value:"high",storyFunction:"payoff",description:"Ties to high-heat rumors.",preferredZoneId:"downtown_checkpoint",position:{x:32,y:34},lines:["Wanted poster: “Seen smiling. Suspicious.”","Reward: Half-price cola (while grid stable).","Report sightings to CO-LAW vending kiosks."]},{id:"note.gangHeat.low.suspicion-drill",flag:"gangHeat",value:"low",storyFunction:"world-building",description:"Field memo coaching crews on witness heat drills.",preferredZoneId:"downtown_checkpoint",position:{x:30,y:24},lines:["Ops memo: Trigger one patrol sighting and log the heat spike.","Break line-of-sight, watch the Suspicion Inspector cool to calm.","Report anomalies to George so the city remembers accurately."]}],fl=(e,t)=>ul.filter(n=>n.flag===e&&n.value===t),xi=[{id:"sign.blackout.none.cola",signId:"downtown.vending.primary",flag:"blackoutTier",value:"none",storyFunction:"world-building",description:"Default advertising bluster.",text:"COLA: Now with 12 essential sugars."},{id:"sign.blackout.brownout.colaw",signId:"downtown.vending.primary",flag:"blackoutTier",value:"brownout",storyFunction:"misdirect",description:"First hint the grid is lying.",text:"CO-LAW: Report loiterers, earn fizz miles."},{id:"sign.blackout.rolling.alert",signId:"downtown.vending.primary",flag:"blackoutTier",value:"rolling",storyFunction:"payoff",description:"Full propaganda mode during outages.",text:"CO-LAW: Lights out? Snitch brighter."},{id:"sign.supply.tight.milk",signId:"corner.bodega.priceboard",flag:"supplyScarcity",value:"tight",storyFunction:"foreshadow",description:"Price jumps signal scarcity.",text:"Milk: 45 credits. Bottles scowl included."},{id:"sign.supply.rationed.ammo",signId:"corner.bodega.priceboard",flag:"supplyScarcity",value:"rationed",storyFunction:"payoff",description:"Ammo “sale” becomes a comedic beat.",text:"Ammo Sale*: *Bring your own casing."}],Qr=(e,t)=>xi.filter(n=>n.flag===e&&n.value===t),ml=e=>xi.find(t=>t.id===e),cr=[{id:"weather.curfew.0",flag:"curfewLevel",value:0,rainIntensity:0,thunderActive:!1,sirenLoop:!1,storyFunction:"world-building",description:"Dry air wobble when curfew is dormant."},{id:"weather.curfew.1",flag:"curfewLevel",value:1,rainIntensity:.2,thunderActive:!1,sirenLoop:!1,storyFunction:"foreshadow",description:"Light drizzle telegraphs rising tension."},{id:"weather.curfew.2",flag:"curfewLevel",value:2,rainIntensity:.6,thunderActive:!1,sirenLoop:!0,storyFunction:"payoff",description:"Rain and sirens when curfew crosses enforcement threshold."},{id:"weather.curfew.3",flag:"curfewLevel",value:3,rainIntensity:.85,thunderActive:!0,sirenLoop:!0,storyFunction:"world-building",description:"Thunderclaps sync with decision beats at max curfew."},{id:"weather.gangHeat.high",flag:"gangHeat",value:"high",rainIntensity:.75,thunderActive:!0,sirenLoop:!0,storyFunction:"misdirect",description:"Extra thunder during high gang heat for dramatic cues."}],pl=e=>cr.find(t=>t.flag==="curfewLevel"&&typeof t.value=="number"&&t.value===e),gl=e=>cr.find(t=>t.flag==="gangHeat"&&t.value===e),hl=e=>cr.find(t=>t.id===e),Zr={"slum-barflies":[{dialogueId:"npc_lira_vendor"},{dialogueId:"npc_courier_brant"}],"dock-liquor-patrons":[{dialogueId:"npc_captain_reyna"},{dialogueId:"npc_drone_handler_kesh"}]},yl=()=>["low","med","high"].flatMap(t=>dl(t).map(r=>({id:`environment.rumor.${r.id}`,cooldownMs:1e3,when:s=>{const{flags:o,rumorSets:l}=s.world.environment;if(o.gangHeat!==t||!(r.groupId in Zr))return!1;const a=l[r.groupId];return!a||a.sourceId!==r.id},fire:({dispatch:s,getState:o,now:l})=>{const d=o().settings.locale,f=tt(d).logs,p=Zr[r.groupId];s(uo({groupId:r.groupId,snapshot:{lines:[...r.lines],storyFunction:r.storyFunction,sourceId:r.id,updatedAt:l}})),p.forEach(u=>{s(fo({match:u,profile:{lines:[...r.lines],storyFunction:r.storyFunction,sourceId:r.id,updatedAt:l}}))}),s(N(f.environmentRumorSwap(r.description)))}}))),Jr=e=>{const{flags:t}=e.world.environment;if(t.curfewLevel<3){const n=gl(t.gangHeat);if(n)return n}return pl(t.curfewLevel)??null},bl=()=>[{id:"environment.weather.update",when:e=>{const t=Jr(e);if(!t)return!1;const n=e.world.environment.weather,r=e.world.timeOfDay,s=n.presetId!==t.id,o=n.timeOfDay!==r;return s||o},fire:({dispatch:e,getState:t,now:n})=>{const r=t(),s=Jr(r);if(!s)return;const o=r.world.environment.weather,l=r.world.timeOfDay,a=r.settings.locale,d=tt(a).logs;if(e(mo({presetId:s.id,rainIntensity:s.rainIntensity,sirenLoop:s.sirenLoop,thunderActive:s.thunderActive,storyFunction:s.storyFunction,updatedAt:n,timeOfDay:l})),o.presetId!==s.id||o.timeOfDay!==l){const f=s.description??s.id;e(N(d.environmentWeatherShift(f)))}}}],xl=()=>{const e=["none","brownout","rolling"],t=["norm","tight","rationed"],n=e.flatMap(s=>Qr("blackoutTier",s).map(l=>({id:`environment.signage.${l.id}`,cooldownMs:4e3,when:a=>{if(a.world.environment.flags.blackoutTier!==s)return!1;const d=a.world.environment.signage[l.signId];return!d||d.variantId!==l.id},fire:({dispatch:a,getState:d,now:f})=>{const p=d().settings.locale,u=tt(p).logs;a(_r({signId:l.signId,snapshot:{variantId:l.id,storyFunction:l.storyFunction,updatedAt:f}})),a(N(u.environmentSignageSwap(l.text)))}}))),r=t.flatMap(s=>Qr("supplyScarcity",s).map(l=>({id:`environment.signage.${l.id}`,cooldownMs:4e3,when:a=>{if(a.world.environment.flags.supplyScarcity!==s)return!1;const d=a.world.environment.signage[l.signId];return!d||d.variantId!==l.id},fire:({dispatch:a,getState:d,now:f})=>{const p=d().settings.locale,u=tt(p).logs;a(_r({signId:l.signId,snapshot:{variantId:l.id,storyFunction:l.storyFunction,updatedAt:f}})),a(N(u.environmentSignageSwap(l.text)))}})));return[...n,...r]},wl=()=>{const e=["norm","tight","rationed"],t=["low","med","high"],n=[0,1,2,3],r=(s,o)=>o.flatMap(l=>fl(s,l).map(d=>({id:`environment.notes.${d.id}`,cooldownMs:5e3,when:f=>{const p=f.world.environment.flags;return(s==="supplyScarcity"?p.supplyScarcity===l:s==="gangHeat"?p.gangHeat===l:p.curfewLevel===l)?!f.world.environment.notes.some(g=>g.definitionId===d.id):!1},fire:({dispatch:f,getState:p,now:u})=>{const g=p(),b=g.world.currentMapArea.id,C=g.settings.locale,y=tt(C).logs;f(po({instanceId:`env-note::${d.id}`,definitionId:d.id,areaId:b,lines:[...d.lines],storyFunction:d.storyFunction,spawnedAt:u})),f(N(y.environmentNoteSpawned(d.description??"new memo recovered")))}})));return[...r("supplyScarcity",e),...r("gangHeat",t),...r("curfewLevel",n)]};let es=!1;const vl=()=>{if(es)return;const e=[...yl(),...bl(),...xl(),...wl()];al(e),es=!0},ts={light:0,balanced:1,heavy:2,sensor:3},ns={open:0,restricted:1,sealed:2},rs={clear:0,caution:1,severe:2},Sl={"smog:none":{},"smog:light":{behavior:{sightMultiplier:.9,chaseMultiplier:.95,routineIntervalMultiplier:1.05},travel:{visibilityMultiplier:.85,staminaDrainPerMinute:1,encounterRiskModifier:1.1,advisoryLevel:"caution"}},"smog:heavy":{behavior:{sightMultiplier:.65,chaseMultiplier:.8,loadoutBias:"sensor",routineIntervalMultiplier:1.2},travel:{visibilityMultiplier:.55,staminaDrainPerMinute:3,encounterRiskModifier:1.35,vehicleWearMultiplier:1.2,advisoryLevel:"severe"}},"blackout:none":{},"blackout:brownout":{behavior:{sightMultiplier:.95},faction:{shopMarkupDelta:.05,reinforcementDelayMultiplier:1.1,safehouseAccess:"restricted"},travel:{visibilityMultiplier:.8,advisoryLevel:"caution"}},"blackout:rolling":{behavior:{sightMultiplier:.85,loadoutBias:"sensor"},faction:{shopMarkupDelta:.12,reinforcementDelayMultiplier:.9,safehouseAccess:"restricted"},travel:{visibilityMultiplier:.7,vehicleWearMultiplier:1.1,advisoryLevel:"caution"}},"surveillance:low":{},"surveillance:elevated":{behavior:{chaseMultiplier:1.15,routineIntervalMultiplier:1.05},faction:{reinforcementDelayMultiplier:.95},travel:{encounterRiskModifier:1.2,advisoryLevel:"caution"}},"surveillance:extreme":{behavior:{sightMultiplier:1.1,chaseMultiplier:1.3,loadoutBias:"sensor",routineIntervalMultiplier:1.15},faction:{shopMarkupDelta:.08,reinforcementDelayMultiplier:.75,safehouseAccess:"restricted"},travel:{encounterRiskModifier:1.4,advisoryLevel:"severe"}},"radiation:none":{},"radiation:localized":{behavior:{routineIntervalMultiplier:1.08},faction:{safehouseAccess:"restricted"},travel:{staminaDrainPerMinute:2,vehicleWearMultiplier:1.15,advisoryLevel:"caution"}},"radiation:pervasive":{behavior:{routineIntervalMultiplier:1.18,loadoutBias:"heavy"},faction:{shopMarkupDelta:.1,safehouseAccess:"sealed"},travel:{staminaDrainPerMinute:4,vehicleWearMultiplier:1.3,encounterRiskModifier:1.25,advisoryLevel:"severe"}},"curfew:off":{},"curfew:tight":{behavior:{chaseMultiplier:1.1,routineIntervalMultiplier:1.05},faction:{shopMarkupDelta:.08,reinforcementDelayMultiplier:.85,safehouseAccess:"restricted"},travel:{encounterRiskModifier:1.25,advisoryLevel:"caution"}},"curfew:lockdown":{behavior:{chaseMultiplier:1.35,routineIntervalMultiplier:1.25,loadoutBias:"heavy"},faction:{shopMarkupDelta:.2,reinforcementDelayMultiplier:.65,safehouseAccess:"sealed"},travel:{encounterRiskModifier:1.6,advisoryLevel:"severe"}}},at=(e,t,n)=>Me(e,t,n),Il=()=>({behavior:{sightMultiplier:1,chaseMultiplier:1,routineIntervalMultiplier:1,loadoutBias:"balanced"},faction:{shopMarkupDelta:0,reinforcementDelayMultiplier:1,safehouseAccess:"open"},travel:{staminaDrainPerMinute:0,vehicleWearMultiplier:1,encounterRiskModifier:1,advisoryLevel:"clear",visibilityMultiplier:1}}),kl=(e,t)=>{if(t&&(typeof t.sightMultiplier=="number"&&(e.sightMultiplier=at(e.sightMultiplier*t.sightMultiplier,.35,1.8)),typeof t.chaseMultiplier=="number"&&(e.chaseMultiplier=at(e.chaseMultiplier*t.chaseMultiplier,.5,2)),typeof t.routineIntervalMultiplier=="number"&&(e.routineIntervalMultiplier=at(e.routineIntervalMultiplier*t.routineIntervalMultiplier,.7,2.2)),t.loadoutBias)){const n=ts[e.loadoutBias];ts[t.loadoutBias]>n&&(e.loadoutBias=t.loadoutBias)}},El=(e,t)=>{if(t&&(typeof t.shopMarkupDelta=="number"&&(e.shopMarkupDelta=Me(e.shopMarkupDelta+t.shopMarkupDelta,-.5,1)),typeof t.reinforcementDelayMultiplier=="number"&&(e.reinforcementDelayMultiplier=at(e.reinforcementDelayMultiplier*t.reinforcementDelayMultiplier,.4,1.6)),t.safehouseAccess)){const n=ns[e.safehouseAccess];ns[t.safehouseAccess]>n&&(e.safehouseAccess=t.safehouseAccess)}},Tl=(e,t)=>{if(t&&(typeof t.staminaDrainPerMinute=="number"&&(e.staminaDrainPerMinute=Me(e.staminaDrainPerMinute+t.staminaDrainPerMinute,0,12)),typeof t.vehicleWearMultiplier=="number"&&(e.vehicleWearMultiplier=at(e.vehicleWearMultiplier*t.vehicleWearMultiplier,.6,2)),typeof t.encounterRiskModifier=="number"&&(e.encounterRiskModifier=at(e.encounterRiskModifier*t.encounterRiskModifier,.5,3)),typeof t.visibilityMultiplier=="number"&&(e.visibilityMultiplier=at(e.visibilityMultiplier*t.visibilityMultiplier,.2,1)),t.advisoryLevel)){const n=rs[e.advisoryLevel];rs[t.advisoryLevel]>n&&(e.advisoryLevel=t.advisoryLevel)}},Cl=e=>{const t=Il();return e.forEach(n=>{const r=Sl[n];r&&(r.behavior&&kl(t.behavior,r.behavior),r.faction&&El(t.faction,r.faction),r.travel&&Tl(t.travel,r.travel))}),t},Ml=e=>{if(!e||e.length===0)return"none";const t=e.map(n=>n.toLowerCase());return t.some(n=>n.includes("dense smog")||n.includes("toxic smog"))?"heavy":t.some(n=>n.includes("smog")||n.includes("gas cloud"))?"light":"none"},Al=(e,t)=>{let n="low";(e.gangHeat!=="low"||e.curfewLevel>=1)&&(n="elevated");const r=(t==null?void 0:t.map(s=>s.toLowerCase()))??[];return(e.gangHeat==="high"||e.curfewLevel>=3||r.some(s=>s.includes("camera")||s.includes("drone")||s.includes("surveillance")||s.includes("riot squad")))&&(n="extreme"),n},Rl=e=>{if(!e||e.length===0)return"none";const t=e.map(n=>n.toLowerCase());return t.some(n=>n.includes("radiation pocket")||n.includes("reactor"))?"localized":t.some(n=>n.includes("radiation")||n.includes("toxic sludge"))?"pervasive":"none"},Pl=e=>e>=3?"lockdown":e>=1?"tight":"off",Dl=e=>{const t=Ml(e.zoneHazards);let n=Rl(e.zoneHazards);n==="none"&&e.zoneId&&(e.zoneId.includes("industrial")||e.zoneId.includes("wasteland"))&&(n="localized");const r=Al(e.flags,e.zoneHazards),s=Pl(e.flags.curfewLevel),o=`blackout:${e.flags.blackoutTier}`;return[`smog:${t}`,o,`surveillance:${r}`,`radiation:${n}`,`curfew:${s}`]},dr=e=>e.world.environment,$t=K(dr,e=>e.flags);K($t,e=>e.gangHeat);K($t,e=>e.curfewLevel);K($t,e=>e.supplyScarcity);K($t,e=>e.blackoutTier);K(dr,e=>e.notes);const wi=e=>e.world.currentMapArea,_l=K([$t,wi],(e,t)=>({flags:e,zoneHazards:(t==null?void 0:t.hazards)??[],zoneId:(t==null?void 0:t.zoneId)??null})),Ll=K(_l,e=>Dl(e)),vi=K(Ll,e=>Cl(e)),jl=e=>e.length===0?null:[...e].sort((n,r)=>((r==null?void 0:r.updatedAt)??0)-((n==null?void 0:n.updatedAt)??0))[0]??null,Nl=e=>e.length===0?null:[...e].sort((n,r)=>((r==null?void 0:r.updatedAt)??0)-((n==null?void 0:n.updatedAt)??0))[0]??null,Ol=K([dr,wi,vi],(e,t,n)=>{const r=Object.entries(e.rumorSets).map(([d,f])=>({groupId:d,lines:[...f.lines],storyFunction:f.storyFunction,updatedAt:f.updatedAt})),s=Object.entries(e.signage).map(([d,f])=>{const p=ml(f.variantId);return{signId:d,text:(p==null?void 0:p.text)??"",storyFunction:(p==null?void 0:p.storyFunction)??f.storyFunction,updatedAt:f.updatedAt}}),o=e.weather.presetId?hl(e.weather.presetId):null,l={presetId:e.weather.presetId,description:(o==null?void 0:o.description)??"",storyFunction:(o==null?void 0:o.storyFunction)??e.weather.storyFunction,updatedAt:e.weather.updatedAt,rainIntensity:e.weather.rainIntensity,thunderActive:e.weather.thunderActive,timeOfDay:e.weather.timeOfDay},a={zoneId:(t==null?void 0:t.zoneId)??null,zoneName:(t==null?void 0:t.displayName)??(t==null?void 0:t.name)??null,dangerRating:(t==null?void 0:t.dangerRating)??null,hazards:Array.isArray(t==null?void 0:t.hazards)?[...t.hazards]:[],summary:(t==null?void 0:t.summary)??null,directives:Array.isArray(t==null?void 0:t.objectives)?t.objectives.filter(d=>d&&d.trim().length>0).map(d=>d.trim()):[]};return{flags:{...e.flags},impacts:n,rumor:jl(r),signage:Nl(s),weather:l,zone:a}}),Si=e=>!!e.settings.reputationSystemsEnabled,Ii=e=>e.suspicion,ki=e=>K(Ii,Si,(t,n)=>!n||!e?null:t.zones[e]??null),Ei=e=>K(ki(e),t=>t?t.heat:{zoneId:e??"unknown",totalHeat:0,tier:"calm",leadingWitnessIds:[]});K(Ii,Si,(e,t)=>t?go(e.zones):"calm");const zl=e=>K(ki(e),t=>{if(!t)return[];const{heat:n,memories:r}=t;return n.leadingWitnessIds.map(s=>r[s]).filter(s=>!!s).map(s=>ho(s))}),St=e=>e.paranoia,Ti=K(St,e=>e.value),Fl=K(St,e=>e.tier);K(Ti,e=>Math.max(0,Math.min(1,e/100)));K(St,e=>e.cooldowns);const Bl=K(St,e=>e.lastSnapshot);K(St,e=>e.frozen);const $l=()=>({cameraAlarmedAt:{},guardAlertRank:{},lastCurfewActive:!1,lastLowHealth:!1,lastLowAmmo:!1,lastSafehouse:!1}),ss=()=>$l(),is=e=>{switch(e){case he.ALARMED:return 3;case he.INVESTIGATING:return 2;case he.SUSPICIOUS:return 1;default:return 0}},Wl=e=>e.type==="motionSensor"?e.motionRadius??e.range:e.range,Hl=(e,t)=>{var n,r,s;return e?!!((n=e.zoneId)!=null&&n.toLowerCase().includes("safehouse")||(r=e.name)!=null&&r.toLowerCase().includes("safehouse")||(s=t==null?void 0:t.zoneId)!=null&&s.toLowerCase().includes("safehouse")):!1},Gl=(e,t)=>t<=0?0:Me(e/t,0,1),Ul=e=>e>=7?.5:e>=5?.8:1,Vl=(e,t,n,r)=>e!=="day"||t||n>.02?!1:r===0,Yl=(e,t)=>{var ee;const n=Math.max(0,e.deltaMs)/1e3,r={},s={},o={},l=e.player,a=e.mapArea,d=e.surveillanceZone,f=Math.max(1,l.skills.perception??5),p=Math.max(1,l.skills.endurance??5),u=Math.max(1,l.skills.intelligence??5),g=Math.max(1,l.skills.charisma??5),b=Math.max(1,l.skills.luck??5),C=Me(1+f*.02-p*.03-u*.03-g*.02,.5,1.8),y=1+p*.02+u*.02+b*.01,A=Ul(b);if(d&&a){let h=0,w=0;if(Object.values(d.cameras).forEach(I=>{if(!I.isActive||I.alertState===X.DISABLED)return;const k=Wl(I),x=I.position.x-l.position.x,q=I.position.y-l.position.y,G=Math.hypot(x,q);if(G<=we.surveillance.proximityRadius){const ie=1-Math.min(G/we.surveillance.proximityRadius,1);h+=ie*we.surveillance.proximityGainPerSecond*n}if(I.type!=="motionSensor"&&Un(I.position,l.position,{range:k,angle:I.fieldOfView,direction:I.currentDirection})&&Vn(I.position,l.position,a)&&(w+=we.surveillance.coneGainPerSecond*n),I.alertState===X.ALARMED){const ie=t.cameraAlarmedAt[I.id]??0;e.timestamp-ie>=1e4&&(o[`camera:${I.id}`]=we.surveillance.alertSpike*A,t.cameraAlarmedAt[I.id]=e.timestamp)}}),h>0){const I=Math.min(h,we.surveillance.maxProximityContributionPerSecond*n);r.camerasProximity=I}w>0&&(r.camerasSweep=w)}let T=0;e.enemies.forEach(h=>{if(!a||!h.visionCone){t.guardAlertRank[h.id]=is(h.alertLevel);return}(Un(h.position,l.position,h.visionCone)?Vn(h.position,l.position,a):!1)&&(T+=1,r[`guardLOS:${h.id}`]=(r[`guardLOS:${h.id}`]??0)+we.guards.lineOfSightGainPerSecond*n);const I=is(h.alertLevel),k=t.guardAlertRank[h.id]??0;t.guardAlertRank[h.id]=I,h.alertLevel===he.ALARMED&&(r[`guardPursuit:${h.id}`]=(r[`guardPursuit:${h.id}`]??0)+we.guards.pursuitGainPerSecond*n),I>=3&&k<3&&(o[`guardChase:${h.id}`]=we.guards.pursuitSpike*A)});let S=0;if(e.zoneHeat){const h=yo(((ee=e.mapArea)==null?void 0:ee.zoneId)??null);S=Gl(e.zoneHeat.totalHeat,h.tierThresholds.crackdown),S>0&&(r.heat=S*we.heat.baselineGainPerSecond*n)}e.timeOfDay==="night"&&(r.night=we.circadian.nightGainPerSecond*n),e.curfewActive&&!t.lastCurfewActive&&(o.curfew=we.circadian.curfewSpike*A),t.lastCurfewActive=e.curfewActive;const z=Math.max(1,l.maxHealth);l.health/z<we.health.criticalThreshold?(r.lowHealth=we.health.sustainedGainPerSecond*n,t.lastLowHealth||(o.lowHealth=we.health.spike*A),t.lastLowHealth=!0):t.lastLowHealth=!1,t.lastLowAmmo=!1,e.environmentImpacts.travel.staminaDrainPerMinute>0&&(r.hazards=(r.hazards??0)+we.hazards.smogGainPerSecond*n),e.environmentImpacts.travel.visibilityMultiplier<.75&&(r.hazards=(r.hazards??0)+we.hazards.blackoutGainPerSecond*n);const L=Hl(a,d);L&&(s.safehouse=(s.safehouse??0)+we.safehouse.reliefPerSecond*n,t.lastSafehouse||(s.safehouseEntry=(s.safehouseEntry??0)+we.safehouse.entryRelief)),t.lastSafehouse=L,Vl(e.timeOfDay,e.curfewActive,r.camerasProximity??0,T)&&(s.daylight=(s.daylight??0)+we.circadian.daylightReliefPerSecond*n);const Q=1+S,F={};Object.entries(r).forEach(([h,w])=>{if(h==="heat"){F[h]=w;return}F[h]=w*Q});const le={gain:C,decay:y};return Object.keys(o).forEach(h=>{o[h]=o[h]*A}),{gains:F,losses:s,spikes:o,multipliers:le}},Kl=e=>e.world.engagementMode,Ci=e=>e.player.data.stealthModeEnabled,ur=e=>e.player.data.stealthCooldownExpiresAt,mn=e=>e.quests.activeDialogue.dialogueId,Mi=K([e=>e.world.inCombat,mn,ur],(e,t,n)=>!(e||t||typeof n=="number"&&n>Date.now())),ql=e=>{switch(e){case he.ALARMED:return 3;case he.INVESTIGATING:return 2;case he.SUSPICIOUS:return 1;case he.IDLE:default:return 0}},Xl=e=>{switch(e){case X.ALARMED:return 3;case X.INVESTIGATING:return 2;case X.SUSPICIOUS:return 1;case X.IDLE:case X.DISABLED:default:return 0}},Ql=K([e=>e.world.currentMapArea.entities.enemies],e=>{let t=0,n=0;return e.forEach(r=>{const s=ql(r.alertLevel);s>t&&(t=s);const o=r.alertProgress??0;o>n&&(n=o)}),{maxRank:t,maxProgress:Math.max(0,Math.min(100,Math.round(n)))}}),Ai=K([Ci,Kl,Mi,ur,e=>e.world.inCombat,mn,e=>e.surveillance.hud,Ql,e=>e.player.data.movementProfile],(e,t,n,r,s,o,l,a,d)=>{const f=Date.now(),p=typeof r=="number"&&r>f,u=typeof r=="number"?r:null,g=Xl(l.alertState),b=a.maxRank,C=g>0||l.detectionProgress>0||!!l.activeCameraId,y=b>0,A=e&&t==="stealth",T=Math.max(Math.round(l.detectionProgress??0),a.maxProgress);return s?{state:"compromised",reason:"combat",severity:Math.max(T,100),stealthActive:A,onCooldown:p,cooldownExpiresAt:u}:o?{state:A?"exposed":"standby",reason:"dialogue",severity:T,stealthActive:A,onCooldown:p,cooldownExpiresAt:u}:A?g>=3||b>=3?{state:"compromised",reason:g>=3?"camera":d==="sprint"?"noise":"vision",severity:Math.max(T,80),stealthActive:A,onCooldown:p,cooldownExpiresAt:u}:C||y||T>=30?{state:"exposed",reason:C?"camera":d==="sprint"?"noise":"vision",severity:Math.max(T,30),stealthActive:A,onCooldown:p,cooldownExpiresAt:u}:{state:"hidden",reason:"none",severity:T,stealthActive:A,onCooldown:p,cooldownExpiresAt:u}:p||!n?{state:"compromised",reason:"cooldown",severity:T,stealthActive:A,onCooldown:p,cooldownExpiresAt:u}:{state:"standby",reason:"none",severity:T,stealthActive:A,onCooldown:p,cooldownExpiresAt:u}});K([Ai],e=>e.stealthActive&&e.state==="hidden");const Zl=K([Ai,e=>e.world.inCombat,mn],(e,t,n)=>{const r=Date.now(),s=e.onCooldown&&e.cooldownExpiresAt?Math.max(1,Math.ceil((e.cooldownExpiresAt-r)/1e3)):0,o=t?"combat":n?"dialogue":e.onCooldown||e.reason==="cooldown"?"cooldown":null,l=e.stealthActive,a=l||o===null;let d="ready";return o==="combat"?d="combat":o==="dialogue"?d="dialogue":o==="cooldown"?d=s>0?`cooldown:${s}`:"cooldown":l&&e.reason!=="none"&&(d=`${e.reason}:${Math.max(0,Math.min(100,Math.round(e.severity)))}`),{isActive:l,stateLabel:e.state,detailLabel:d,canToggle:a,blockedReason:o,severity:Math.max(0,Math.min(100,Math.round(e.severity))),keyHint:"X",reason:e.reason,cooldownSeconds:s}}),Jl=K([Ci,Mi,ur],(e,t,n)=>({enabled:e,eligible:t,cooldownExpiresAt:typeof n=="number"?n:null,onCooldown:typeof n=="number"&&n>Date.now()})),ec=e=>{switch(e){case"on_edge":return 1.1;case"panicked":return 1.2;case"breakdown":return 1.3;default:return 1}},tc=4500,nc=12e4,rc=3,jn=e=>{switch(e){case he.SUSPICIOUS:return 1;case he.INVESTIGATING:return 2;case he.ALARMED:return 3;default:return 0}},sc={silent:{radius:2,gain:0},normal:{radius:4,gain:4},sprint:{radius:6,gain:8}},ic=e=>e.reduce((t,n)=>{const r=Array.isArray(n.tags)?n.tags:[],s=n.stackable?n.quantity??1:1;return r.includes("paranoia:calmtabs")&&(t.calmTabs+=s),r.includes("paranoia:cigarettes")&&(t.cigarettes+=s),t},{calmTabs:0,cigarettes:0}),Ri=e=>e.stackable?Math.max(1,e.quantity??1):1,Pi=(e,t)=>e.type!=="collect"||e.isCompleted?!1:e.targetResourceKey&&t.resourceKey?e.targetResourceKey===t.resourceKey:e.target===t.name,oc=(e,t)=>{if(e.type!=="kill"||e.isCompleted)return!1;if(e.targetResourceKey&&t.resourceKey)return e.targetResourceKey===t.resourceKey;if(e.targetResourceKey==="enemies.corpsec_guard"){if(t.aiProfileId===Bo)return!0;const n=t.name.toLowerCase();return["corpsec","curfew patrol","patrol","sentinel","sentry","guard","captain","enforcer","watchman"].some(s=>n.includes(s))}return e.target?t.name.toLowerCase()===e.target.toLowerCase():!1},ac=e=>e.type==="kill"&&!e.isCompleted&&e.targetResourceKey==="devices.surveillance_camera",lc=e=>e.type==="explore"&&!e.isCompleted&&e.targetResourceKey==="devices.patrol_drone",Di=e=>{var t;return((t=li[e.id])==null?void 0:t.kind)==="side"},jt=e=>!e.isCompleted&&(e.isActive||Di(e)),os=(e,t)=>{const n=e.x-t.x,r=e.y-t.y;return Math.sqrt(n*n+r*r)},cc=(e,t)=>t.reduce((n,r)=>Pi(e,r)?n+Ri(r):n,0),Zt=1.5,dc=(e,t,n)=>{var p;if(!e||!t||!Array.isArray(e.buildings)||e.buildings.length===0)return{available:!1,note:"No workbench nearby"};const{x:r,y:s}=t.position,o=e.buildings.find(u=>{if(!u.workbench)return!1;const{from:g,to:b}=u.footprint;return r>=g.x-Zt&&r<=b.x+Zt&&s>=g.y-Zt&&s<=b.y+Zt});if(!o||!o.workbench)return{available:!1,note:"No workbench nearby"};let l=!1;if(n){const u=ar(((p=t.factionReputation)==null?void 0:p.scavengers)??0);l=u.id==="friendly"||u.id==="allied"}const a=o.workbench.type==="market"&&(!n||!l)?o.workbench.feeRequired??50:void 0,d=a?t.credits>=a:!0,f=a&&!d?n?`Requires ${a} credits or Friendly scavenger standing`:`Requires ${a} credits`:a?n?"Fee applies if scavenger standing is below Friendly":"Market workbench fee applies":void 0;return{available:d,locationName:o.name,type:o.workbench.type,feeRequired:a,note:f}},uc=()=>{var Ar;const e=c.useMemo(()=>si("GameController"),[]),t=$e(),n=Ji(),r=R(m=>m.player.data),s=r.encumbrance.level,o=r.encumbrance.warning,l=r.encumbrance.percentage,a=R(m=>m.world.currentMapArea),d=a==null?void 0:a.entities.items,f=a==null?void 0:a.id,p=(a==null?void 0:a.isInterior)??!1,u=R(m=>m.world.inCombat),g=R(m=>m.world.isPlayerTurn),b=R(m=>m.world.timeOfDay),C=R(m=>m.world.curfewActive),y=R(m=>m.world.currentMapArea.entities.enemies),A=R(m=>m.world.mapAreas),T=R(m=>m.world.mapConnections),S=R(m=>m.world),z=R(m=>m.quests.quests),B=R(m=>m.quests.dialogues),Y=c.useMemo(()=>z.map(m=>`${m.id}:${m.isActive?1:0}:${m.isCompleted?1:0}`).join("|"),[z]),L=R(mn),Q=R(m=>m.settings.locale),F=R(m=>m.settings.autoBattleEnabled),le=R(m=>m.settings.autoBattleProfile),ee=R(Jl),h=ee.cooldownExpiresAt,w=ee.eligible,I=typeof h=="number",k=R(m=>m.world.engagementMode),x=R(m=>m.world.stealthToggleRequestNonce),q=R(m=>m.settings.autoStealthEnabled),G=R(m=>!!m.settings.reputationSystemsEnabled),ie=R(m=>m.world.turnCount),V=R(m=>m.world.globalAlertLevel),Z=R(m=>m.world.reinforcementsScheduled),ce=R(m=>f?m.surveillance.zones[f]:void 0),ue=R(m=>m.surveillance.hud.overlayEnabled),me=R(vi),ye=R(m=>m.world.environment.flags),pe=R(m=>m.world.currentTime),be=R(Fl),D=c.useMemo(()=>Ei((a==null?void 0:a.zoneId)??null),[a==null?void 0:a.zoneId]),ge=R(m=>D(m)),j=c.useMemo(()=>tt(Q).logs,[Q]),He=c.useMemo(()=>We(Q),[Q]),Pe=c.useMemo(()=>He.autoBattle,[He]),nt=c.useMemo(()=>Math.max(220,Math.round(320*me.behavior.routineIntervalMultiplier)),[me.behavior.routineIntervalMultiplier]),Xe=c.useMemo(()=>Math.max(750,Math.round(bo()*me.faction.reinforcementDelayMultiplier)),[me.faction.reinforcementDelayMultiplier]),It=c.useRef(u),kt=c.useRef(b),Et=c.useRef(V),Ge=c.useRef(void 0),Qe=c.useRef(r),ct=c.useRef(a??null),Wt=c.useRef(Z),dt=c.useRef(_a()),Oe=c.useRef(null),M=c.useRef(null),W=c.useRef(V),ae=c.useRef(b),oe=c.useRef(L),xe=c.useRef(ue),fe=c.useRef(pe),Se=c.useRef(null),Ie=c.useRef(null),ut=c.useRef(new Map),_e=c.useRef(f??null),hn=c.useRef(null),ft=c.useRef(z),yn=c.useRef(new Set),bn=c.useRef(new Set),xn=c.useRef(new Set),yr=c.useRef(r.id),Tt=c.useRef(null),br=c.useRef(ss()),xr=c.useRef(be),wr=c.useRef(ge),vr=c.useRef(0),wn=c.useRef(x),Sr=c.useRef({calmTabs:0,cigarettes:0}),Yi=((Ar=S.workbenchStatus)==null?void 0:Ar.available)!==void 0?{...S.workbenchStatus}:{available:S.workbenchAvailable??!1,note:S.workbenchAvailable?void 0:"No workbench nearby"},Ir=c.useRef(Yi),[Le,mt]=c.useState(0),Ht=c.useRef(null),Gt=c.useRef(null),Ue=c.useRef(null),[Ut,Ze]=c.useState("clear"),[Re,ke]=c.useState([]),pt=c.useRef(new Set),Ct=c.useRef([]),rt=c.useRef(new Map),Vt=c.useRef(null),[vn,Ee]=c.useState(null),[Sn,Te]=c.useState(null),Yt=c.useCallback(m=>{var E;if(!m.isInteractive||!m.dialogueId)return t(N(j.npcNotReady(m.name))),!1;if(L===m.dialogueId)return!0;const v=B.find(P=>P.id===m.dialogueId);if(!v||v.nodes.length===0)return t(N(j.npcNoNewInfo(m.name))),!1;const _=(E=v.nodes[0])==null?void 0:E.id;return _?(t(Lr({dialogueId:v.id,nodeId:_})),t(N(j.npcChannelOpened(m.name))),!0):(t(N(j.npcChannelEmpty(m.name))),!1)},[t,B,L,j]),gt=c.useCallback((m={})=>{const{sprint:v=!1}=m;if(u)return!0;if(v&&r.isExhausted)return t(N(j.tooTiredToSprint)),!1;let E=l>=80?jr.strenuousInteraction:0;return v&&(E+=jr.sprintTile),E<=0?(r.stamina<r.maxStamina&&t(xo(void 0)),!0):r.stamina<E?(t(N(j.notEnoughStamina(E,r.stamina))),!1):(t(wo(E)),!0)},[l,t,u,j,r.isExhausted,r.stamina,r.maxStamina]),je=c.useCallback((m=!0)=>{m&&Ht.current!==null&&window.clearTimeout(Ht.current),Ht.current=null,Gt.current=null},[]),ht=c.useRef(null),Mt=()=>typeof performance<"u"?performance.now():Date.now(),kr=()=>Date.now(),Er=c.useCallback(()=>{var m;t(kn({enabled:!0,cooldownExpiresAt:null})),((m=Qe.current)==null?void 0:m.movementProfile)!=="silent"&&t(En("silent"))},[t]),yt=c.useCallback(m=>{var _;const v=kr();t(kn({enabled:!1,cooldownExpiresAt:m?v+tc:null})),((_=Qe.current)==null?void 0:_.movementProfile)==="silent"&&t(En("normal"))},[t]),Kt=c.useCallback(m=>{const v=Qe.current;if(v){if(e.debug("Stealth toggle requested",{source:m}),v.stealthModeEnabled){yt(!1),t(Tn("none")),t(N(j.stealthDisengaged));return}if(!w){if(u){t(N(j.stealthUnavailableCombat));return}if(oe.current){t(N(j.stealthUnavailableDialogue));return}if(I&&typeof h=="number"){const _=Date.now(),E=Math.max(0,h-_);if(E>0){const P=Math.ceil(E/1e3);t(N(j.stealthCooldown(P)))}}return}Er(),t(Tn("stealth")),t(N(j.stealthEngaged))}},[yt,t,Er,u,e,j,h,w,I]),ze=c.useCallback(m=>{!m.isActive&&Di(m)&&t(or(m.id))},[t]);c.useEffect(()=>{Ge.current=ce},[ce]),c.useEffect(()=>{xr.current=be},[be]),c.useEffect(()=>{wr.current=ge},[ge]),c.useEffect(()=>{Qe.current=r},[r]),c.useEffect(()=>{yr.current!==r.id&&(yr.current=r.id,yn.current.clear(),bn.current.clear(),xn.current.clear())},[r.id]),c.useEffect(()=>{oe.current=L},[L]),c.useEffect(()=>{ft.current=z},[z]),c.useEffect(()=>{ct.current=a??null},[a]),c.useEffect(()=>{if(!d||d.length===0)return;const m=d.filter(_=>{var E,P;return((E=_.position)==null?void 0:E.x)===r.position.x&&((P=_.position)==null?void 0:P.y)===r.position.y});if(m.length===0)return;const v=ft.current.filter(jt);m.forEach(_=>{var O,te;const E=Ri(_),P=vo(_);t(ii(_)),t(So({id:_.id,position:_.position,name:_.name})),window.dispatchEvent(new CustomEvent(Io,{detail:{areaId:a.id,itemId:_.id,position:_.position}})),t(Pt({id:Ye(),value:E,gridX:((O=_.position)==null?void 0:O.x)??r.position.x,gridY:((te=_.position)==null?void 0:te.y)??r.position.y,type:"pickup",label:P})),t(N(j.itemPickedUp(P,E))),v.forEach(U=>{U.objectives.forEach(H=>{Pi(H,_)&&(ze(U),t(Dt({questId:U.id,objectiveId:H.id,count:E})))})})})},[t,d,r.position,j,a==null?void 0:a.id,ze]),c.useEffect(()=>{const m=ft.current.filter(jt);if(m.length===0)return;const v=r.inventory.items??[];v.length!==0&&m.forEach(_=>{_.objectives.forEach(E=>{if(E.type!=="collect"||E.isCompleted)return;const P=cc(E,v);if(P<=0)return;const O=E.count??1,te=E.currentCount??0,H=Math.min(P,O)-te;H<=0||(ze(_),t(Dt({questId:_.id,objectiveId:E.id,count:H})))})})},[t,r.inventory.items,Y,ze]),c.useEffect(()=>{if(!C)return;const m=Ge.current??ce;if(!m)return;const v=ft.current.filter(jt);if(v.length===0)return;const _=Object.values(m.cameras).filter(P=>P.type!=="drone"||!P.isActive||P.alertState===X.ALARMED?!1:os(P.position,r.position)<=rc);if(_.length===0)return;const E=new Map;v.forEach(P=>{P.objectives.forEach(O=>{lc(O)&&_.forEach(te=>{const U=`${te.id}:${te.currentWaypointIndex??0}`,H=`${P.id}:${O.id}:${U}`;if(xn.current.has(H))return;xn.current.add(H),ze(P),t(Dt({questId:P.id,objectiveId:O.id,count:1}));const ne=`${P.id}:${O.id}`,J=E.get(ne)??O.currentCount??0,re=O.count??1,$=Math.min(J+1,re);E.set(ne,$),t(N(j.droneReconWaypointLogged($,re)))})})})},[C,t,j,r.position,ce,Y,ze]),c.useEffect(()=>{const m=Ge.current??ce,v=Qe.current,E=y.reduce((H,ne)=>{const J=jn(ne.alertLevel);return J>H?J:H},0)>=3,O=(m?Object.values(m.cameras):[]).some(H=>H.alertState===X.ALARMED),te=kr();!(v!=null&&v.stealthModeEnabled)&&(v!=null&&v.stealthCooldownExpiresAt)&&v.stealthCooldownExpiresAt<=te&&t(kn({enabled:!1,cooldownExpiresAt:null}));let U="none";u?(U="combat",v!=null&&v.stealthModeEnabled&&(yt(!0),t(N(j.stealthCompromised)))):oe.current?(U="dialog",v!=null&&v.stealthModeEnabled&&yt(!1)):v!=null&&v.stealthModeEnabled&&(E||O?(yt(!0),t(N(j.stealthCompromised))):U="stealth"),k!==U&&t(Tn(U))},[L,yt,t,k,y,u,j,ce]),c.useEffect(()=>{br.current=ss()},[f]),c.useEffect(()=>{if(!a){_e.current=null,ut.current=new Map(y.map(E=>[E.id,E]));return}if(_e.current!==a.id){_e.current=a.id,ut.current=new Map(y.map(E=>[E.id,E]));return}const m=ut.current,v=new Map(y.map(E=>[E.id,E])),_=ft.current.filter(jt);m.forEach((E,P)=>{const O=v.get(P);E.health>0&&(!O||O.health<=0)&&(G&&t(ko({witnessId:P,zoneId:a.zoneId})),_.forEach(U=>{U.objectives.forEach(H=>{if(!oc(H,E))return;const ne=`${U.id}:${H.id}:${P}`;yn.current.has(ne)||(yn.current.add(ne),ze(U),t(Dt({questId:U.id,objectiveId:H.id,count:1})))})}))}),_e.current=a.id,ut.current=v},[y,a,t,G,ze]),c.useEffect(()=>{Wt.current=Z},[Z]),c.useEffect(()=>{!Z&&Oe.current!==null&&(dt.current.cancel(Oe.current),Oe.current=null)},[Z]),c.useEffect(()=>{const m=ic(r.inventory.items??[]),v=Sr.current;Sr.current=m;const _=Mt();m.calmTabs<v.calmTabs&&t(Nr({amount:we.calmTabs.relief,timestamp:_,cooldownKey:"calmTabs",cooldownMs:we.calmTabs.cooldownMs})),m.cigarettes<v.cigarettes&&(t(Nr({amount:we.cigarettes.relief,timestamp:_})),t(Eo({amountPerSecond:we.cigarettes.decayBoostPerSecond,durationMs:we.cigarettes.durationMs,timestamp:_})))},[r.inventory.items,t]),c.useEffect(()=>{W.current=V},[V]),c.useEffect(()=>{ae.current=b},[b]),c.useEffect(()=>{xe.current=ue},[ue]),c.useEffect(()=>{fe.current=pe},[pe]),c.useEffect(()=>{Tt.current||(Tt.current=new To(t,n))},[t,n]),c.useEffect(()=>{Tt.current&&Tt.current.update({enabled:F,profileId:le,player:r,enemies:y,mapArea:a??null,inCombat:u,isPlayerTurn:g,turnCount:ie,activeDialogueId:L,logStrings:j,autoBattleStrings:Pe})},[F,le,r,y,a,u,g,ie,L,j,Pe]),c.useEffect(()=>{ht.current&&ht.current.focus();const m=v=>{if(!ht.current)return;const _=v.target;_ instanceof Element&&(ht.current.contains(_)||_.closest('[data-controller-focus-ignore="true"]'))||ht.current.focus()};return document.addEventListener("click",m),()=>{document.removeEventListener("click",m)}},[]),c.useEffect(()=>{const m=ct.current;if(!m||!f)return;Ie.current!==null&&(window.clearTimeout(Ie.current),Ie.current=null);const v=Se.current;v&&v!==f&&Xr({areaId:v,dispatch:t});const _=Ge.current;return(!_||_.areaId!==f)&&rl({area:m,timeOfDay:ae.current,dispatch:t,timestamp:Mt()}),Se.current=f,()=>{const E=Se.current;E&&(Ie.current=window.setTimeout(()=>{Xr({areaId:E,dispatch:t}),Se.current=null,Ie.current=null},0))}},[f,t]),c.useEffect(()=>{if(!a||!f)return;const m=Ge.current??ce;m&&sl({zone:m,area:a,timeOfDay:b,dispatch:t,timestamp:Mt()})},[b,f,ce,a,t]),c.useEffect(()=>{const m=v=>{if(v.defaultPrevented)return;const _=v.target;if(!(_ instanceof Element&&_.closest('[data-controller-focus-ignore="true"]'))){if(v.key==="Tab"){if(v.preventDefault(),v.repeat)return;t($o({enabled:!xe.current}));return}if(v.key.toLowerCase()==="x"){if(v.repeat)return;v.preventDefault(),Kt("keyboard")}}};return window.addEventListener("keydown",m),()=>{window.removeEventListener("keydown",m)}},[t,Kt]),c.useEffect(()=>{if(x<=wn.current){wn.current=x;return}wn.current=x,Kt("hudButton")},[Kt,x]),c.useEffect(()=>{if(!f||typeof window>"u")return;vl();let m=null,v=Mt();const _=()=>{const E=Ge.current,P=ct.current,O=Qe.current,te=Mt(),U=te-v;v=te;const ne=n.getState().world;if(P&&O){const J=G?wr.current:null,re=Yl({player:O,enemies:P.entities.enemies,mapArea:P,surveillanceZone:E,zoneHeat:J,environmentImpacts:me,timeOfDay:ne.timeOfDay,curfewActive:ne.curfewActive,worldTimeSeconds:ne.currentTime,deltaMs:U,timestamp:te},br.current),$=Object.values(re.gains).reduce((Je,bt)=>Je+bt,0),se=Object.values(re.losses).reduce((Je,bt)=>Je+bt,0),de=Object.values(re.spikes).reduce((Je,bt)=>Je+bt,0),Fe=$*re.multipliers.gain-se+de;(Fe!==0||$>0||se>0||de!==0)&&t(Wo({timestamp:te,delta:Fe,deltaMs:U,breakdown:{gains:re.gains,losses:re.losses,spikes:re.spikes}})),t(Ho({deltaMs:U,timestamp:te,decayMultiplier:re.multipliers.decay}))}if(E&&P&&O){const J=G?re=>{t($r(re)),e.debug(`Suspicion: camera ${re.witnessId} reported player in ${re.zoneId} (${re.recognitionChannel})`)}:void 0;il({zone:E,mapArea:P,player:O,deltaMs:U,timestamp:te,dispatch:t,logStrings:j,reinforcementsScheduled:Wt.current??!1,globalAlertLevel:W.current??he.IDLE,timeOfDay:ne.timeOfDay,environmentFlags:ne.environment.flags,worldTimeSeconds:ne.currentTime,onWitnessObservation:J})}if(!u&&k==="stealth"&&q&&P&&O){const J=Pa();J&&t(N(`[Auto-Stealth]: ${J.summary}`))}if(P&&O){const J=dc(P,O,G),re=Ir.current;(re.available!==J.available||re.type!==J.type||re.locationName!==J.locationName||re.feeRequired!==J.feeRequired||re.note!==J.note)&&(Ir.current=J,t(Go(J)))}ll(t,n.getState),m=window.requestAnimationFrame(_)};return m=window.requestAnimationFrame(_),()=>{m!==null&&window.cancelAnimationFrame(m)}},[f,t,j,n,e,me,q,k,u,G]),c.useEffect(()=>{const m=v=>{const E=v.detail;if(!E||!a||E.areaId!==a.id||u)return;const P=E.position;if(Ee(null),Te(null),P.x===r.position.x&&P.y===r.position.y){ke([]),Te(null);return}const O=a.entities.npcs.find(H=>H.position.x===P.x&&H.position.y===P.y);if(O){if(u){t(N(j.combatChatterOverrides));return}if(Math.abs(O.position.x-r.position.x)+Math.abs(O.position.y-r.position.y)<=1){Yt(O);return}const ne=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}];let J=null;for(const re of ne){const $={x:O.position.x+re.x,y:O.position.y+re.y};if($.x===r.position.x&&$.y===r.position.y||$.x<0||$.y<0||$.x>=a.width||$.y>=a.height||!qt($,a,r,y,{npcs:a.entities.npcs}))continue;const se=_t(r.position,$,a,{player:r,enemies:y,npcs:a.entities.npcs});if(se.length>0){J=se;break}}J?(Ee(O.id),ke(J)):t(N(j.npcBoxedIn(O.name)));return}const te=a.entities.enemies.find(H=>H.position.x===P.x&&H.position.y===P.y&&H.health>0);if(te){if(Math.abs(te.position.x-r.position.x)+Math.abs(te.position.y-r.position.y)<=1){u||(t(Lt()),t(N(j.enteredCombat)));return}const ne=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}];let J=null;for(const re of ne){const $={x:te.position.x+re.x,y:te.position.y+re.y};if($.x===r.position.x&&$.y===r.position.y||$.x<0||$.y<0||$.x>=a.width||$.y>=a.height||!qt($,a,r,y,{npcs:a.entities.npcs}))continue;const se=_t(r.position,$,a,{player:r,enemies:y,npcs:a.entities.npcs});if(se.length>0){J=se;break}}J?(Te(te.id),ke(J)):t(N(j.enemyOutOfRange));return}const U=_t(r.position,P,a,{player:r,enemies:y,npcs:a.entities.npcs});if(U.length===0){window.dispatchEvent(new CustomEvent(Cn,{detail:{areaId:a.id,path:[]}})),Te(null);return}ke(U)};return window.addEventListener(Or,m),()=>{window.removeEventListener(Or,m)}},[a,r,y,u,t,Yt,T,j]),c.useEffect(()=>{a&&window.dispatchEvent(new CustomEvent(Cn,{detail:{areaId:a.id,path:Re}}))},[Re,a]),c.useEffect(()=>{if(!a)return;const m=v=>{const _=v.detail;if(!_||_.areaId!==a.id)return;const E=_t(r.position,_.target,a,{player:r,enemies:y,npcs:a.entities.npcs});ke(E),window.dispatchEvent(new CustomEvent(Cn,{detail:{areaId:a.id,path:E}}))};return window.addEventListener(zr,m),()=>{window.removeEventListener(zr,m)}},[a,r,y]),c.useEffect(()=>{ke(m=>m.length>0?[]:m),Ee(null),Te(null)},[a==null?void 0:a.id]),c.useEffect(()=>{p&&Ze("clear")},[f,p]),c.useEffect(()=>{const m=pt.current,v=Ct.current,_=rt.current;m.clear(),v.forEach(E=>{window.clearTimeout(E)}),v.length=0,_.clear()},[a==null?void 0:a.id]);const Tr=c.useCallback((m,v)=>{if(v.length===0){rt.current.delete(m.id);return}if(pt.current.has(m.id))return;const _=v[v.length-1];rt.current.set(m.id,_),pt.current.add(m.id);const E=nt;let P=0,O=m;const te=()=>{if(P>=v.length){pt.current.delete(m.id),rt.current.delete(m.id);return}const U=v[P];if(P+=1,O={...O,position:U},t(Uo(O)),P<v.length){const H=window.setTimeout(()=>{const ne=Ct.current.indexOf(H);ne>-1&&Ct.current.splice(ne,1),te()},E);Ct.current.push(H)}else pt.current.delete(m.id),rt.current.delete(m.id)};te()},[t,nt]);c.useEffect(()=>{a&&a.entities.npcs.forEach(m=>{const v=m.routine.find(O=>O.timeOfDay===b);if(!v||m.position.x===v.position.x&&m.position.y===v.position.y)return;const _=a.entities.npcs.filter(O=>O.id!==m.id).map(O=>O.position),E=Array.from(rt.current.entries()).filter(([O])=>O!==m.id).map(([,O])=>O),P=_t(m.position,v.position,a,{player:r,enemies:y,blockedPositions:[..._,...E]});P.length>0&&Tr(m,P)})},[a,b,r,y,Tr]),c.useEffect(()=>{const m=Ct.current,v=pt.current,_=rt.current;return()=>{m.forEach(E=>{window.clearTimeout(E)}),m.length=0,v.clear(),_.clear()}},[]),c.useEffect(()=>{var te;if(Re.length===0)return;if(u){ke([]),Ee(null);return}if(r.encumbrance.level==="immobile"){r.encumbrance.warning&&t(N(r.encumbrance.warning)),ke([]),Ee(null),Te(null);return}const m=Re[0],v=r.position.x,_=r.position.y;if(v===m.x&&_===m.y){ke(U=>U.slice(1));return}if(!qt(m,a,r,y,{npcs:a.entities.npcs})){ke([]),Ee(null),Te(null);return}const E=a.tiles[m.y][m.x],P=T.find(U=>U.fromAreaId===a.id&&U.fromPosition.x===m.x&&U.fromPosition.y===m.y);if(P){const U=A[P.toAreaId];if(C&&E.type===Fr.DOOR&&U&&!U.isInterior){t(N(j.checkpointSealed)),ke([]),Ee(null),Te(null);return}if(U){if(G&&U.factionRequirement){const H=U.factionRequirement,ne=He.playerStatus.factions[H.factionId]??H.factionId,J=((te=r.factionReputation)==null?void 0:te[H.factionId])??0,re=ar(J);let $=!0;if(H.minimumStanding){const se=wt(re.id),de=wt(H.minimumStanding);se<de&&($=!1)}if($&&typeof H.minimumReputation=="number"&&J<H.minimumReputation&&($=!1),!$){const se=[];H.minimumStanding&&se.push(an(Q,H.minimumStanding)),typeof H.minimumReputation=="number"&&se.push(`${He.factionPanel.reputationLabel} ${H.minimumReputation}+`);const de=se.join(" • ")||an(Q,re.id);t(N(j.factionAccessDenied(ne,de))),ke([]),Ee(null),Te(null);return}}if(!gt()){ke([]),Ee(null),Te(null);return}t(Br(U)),t(Xt(P.toPosition)),U.isInterior&&(t(sn({type:"campfireRest",locationId:U.id})),t(N(j.slipInsideStructure)),Ze("clear"))}else e.warn(`Missing target area in state for ${P.toAreaId}`);ke([]),Ee(null),Te(null);return}if(!gt()){ke([]),Ee(null),Te(null);return}const O=r.movementProfile==="silent"?140:0;Ue.current===null&&(Ue.current=window.setTimeout(()=>{Ue.current=null,t(Xt(m))},O))},[Re,r,a,y,u,C,t,A,T,e,j,gt,Q,He,G]),c.useEffect(()=>{Re.length===0&&Ue.current!==null&&(window.clearTimeout(Ue.current),Ue.current=null)},[Re.length]),c.useEffect(()=>()=>{Ue.current!==null&&(window.clearTimeout(Ue.current),Ue.current=null)},[]),c.useEffect(()=>{const m=o??null;if(m&&m!==Vt.current&&t(N(m)),!m&&Vt.current&&s==="normal"){Vt.current=null;return}Vt.current=m},[s,o,t]),c.useEffect(()=>{if(!vn||!a)return;const m=a.entities.npcs.find(_=>_.id===vn);if(!m){Ee(null);return}if(Math.abs(m.position.x-r.position.x)+Math.abs(m.position.y-r.position.y)<=1){if(u)Ee(null);else{const _=Yt(m);Ee(null),_&&ke([])}return}Re.length===0&&(t(N(j.npcOutOfReach(m.name))),Ee(null))},[vn,a,r,u,Re.length,t,T,Yt,j]),c.useEffect(()=>{if(!Sn||!a)return;const m=a.entities.enemies.find(_=>_.id===Sn);if(!m||m.health<=0){Te(null);return}if(Math.abs(m.position.x-r.position.x)+Math.abs(m.position.y-r.position.y)<=1){Te(null),ke([]),u||(t(Lt()),t(N(j.enteredCombat)));return}Re.length===0&&Te(null)},[Sn,a,r,u,Re.length,t,j,y]),c.useEffect(()=>{kt.current!==b&&(b==="night"?(t(N(j.nightFalls)),Ze("clear")):kt.current==="night"&&(t(N(j.dawnBreaks)),Ze("clear")),kt.current=b)},[b,t,j]),c.useEffect(()=>{G&&t(Co(!!L))},[L,t,G]),c.useEffect(()=>{var re;if(!r||y.length===0||!a){hn.current=null;return}const m=[a.id,`${r.position.x},${r.position.y}`,r.movementProfile,u?"combat":"field",b,y.map($=>{var se;return`${$.id}:${$.health}:${$.position.x},${$.position.y}:${$.facing}:${((se=$.visionCone)==null?void 0:se.direction)??"na"}`}).join("|")].join("::");if(hn.current===m)return;hn.current=m;const v=ec(xr.current),_=r.movementProfile==="silent"?.6:r.movementProfile==="sprint"?1.6:1,E=((re=r.skillTraining)==null?void 0:re.stealth)??0,P=Math.max(.7,1-Math.min(.3,E/333)),O=(ae.current??b)==="night"?.85:1,te=v*_*P*O,{updatedEnemies:U,maxAlertLevel:H,guardPerception:ne}=Mo(y,r,a,te);let J=!1;if(r.movementProfile!=="silent"){const $=sc[r.movementProfile];U.forEach((se,de)=>{const Ne=ne[de];if(!se||Ne!=null&&Ne.playerVisible)return;const Fe=se.position.x-r.position.x,Je=se.position.y-r.position.y;if(Math.sqrt(Fe*Fe+Je*Je)>$.radius||$.gain<=0)return;const Rr=se.alertProgress??0,At=Math.min(100,Rr+$.gain);if(At<=Rr)return;const Xi=se.alertLevel??he.IDLE;let Rt=se.alertLevel??he.IDLE;At>=Mn.alarmThreshold?Rt=he.ALARMED:At>=Mn.investigationThreshold?Rt=he.INVESTIGATING:At>=Mn.suspicionThreshold&&(Rt=he.SUSPICIOUS),U[de]={...se,alertProgress:At,alertLevel:Rt},jn(Rt)>jn(Xi)&&(J=!0)})}if(J){const se=Date.now();se-vr.current>=1500&&(t(N(j.stealthNoiseCue)),vr.current=se)}if(U.forEach(($,se)=>{const de=y[se];de&&($.alertLevel!==de.alertLevel||$.alertProgress!==de.alertProgress)&&t(An($))}),G&&ne.forEach(({enemy:$,playerVisible:se})=>{if(!se)return;const de=Ga({enemy:$,player:r,mapArea:a,timeOfDay:b,environmentFlags:ye,playerVisible:se,timestamp:pe});de&&(t($r(de)),e.debug(`Suspicion: guard ${$.id} observed player in ${a.zoneId} (certainty ${(de.baseCertainty*de.distanceModifier).toFixed(2)})`))}),H!==Et.current){const $=Ao(Et.current,H);$&&t(N(j[$])),t(rn(H)),Et.current=H,Ro(H,Z)&&(t(ri()),t(N(j.reinforcementsIncoming)),Oe.current!==null&&dt.current.cancel(Oe.current),Oe.current=dt.current.schedule(()=>{Oe.current=null,u||t(Lt());const se=u&&!g,de={id:Ye(),resourceKey:"enemies.corpsec_guard",name:j.curfewPatrolName,position:{x:r.position.x+5,y:r.position.y+2},facing:"west",coverOrientation:null,suppression:0,health:45,maxHealth:45,actionPoints:se?0:4,maxActionPoints:4,damage:7,attackRange:2,isHostile:!0,visionCone:{range:10,angle:90,direction:180},alertLevel:he.ALARMED,alertProgress:100};t(Wr(de)),t(xt()),se&&!g&&(t(st()),t(xt())),je(),mt(0),t(Po())},Xe))}},[r,y,a,t,j,u,g,Z,je,Xe,b,ye,pe,e,G]),c.useEffect(()=>{if(e.debug(`=== useEffect RUNNING === Turn: ${g?"Player":"Enemy"}, Combat: ${u}, Processing: ${Gt.current?"true":"false"}, EnemyIdx: ${Le}`),!u||g||y.length===0){je(),(!u||g)&&Le!==0&&mt(0);return}if(y.filter(E=>E.health>0).length===0){je(),e.warn("Enemy turn effect running but no living enemies found.");return}if(Le>=y.length){e.debug(`Enemy index ${Le} out of bounds (length: ${y.length}). Ending enemy turn.`),je(),t(st()),t(xt()),mt(0);return}const v=y[Le];if(!v||v.health<=0||v.actionPoints<=0){e.debug(`Enemy ${(v==null?void 0:v.id)??`at index ${Le}`} cannot act (Dead or 0 AP). Checking next.`),je();let E=Le+1,P=!1;for(;E<y.length;){const O=y[E];if(O&&O.health>0&&O.actionPoints>0){P=!0;break}E+=1}P?(e.debug(`Moving to next valid enemy at index ${E}`),mt(E)):(e.debug("All enemies processed, switching back to player."),t(st()),t(xt()),mt(0));return}if(Gt.current)return;e.debug(`Scheduling action for enemy index ${Le}: ${v.id} (AP: ${v.actionPoints})`),Gt.current=v.id;let _=null;Ht.current=window.setTimeout(()=>{if(e.debug(`>>> setTimeout CALLBACK for index ${Le}`),!u){e.debug("Combat ended, skipping enemy action"),je(!1);return}try{e.debug(`Enemy Turn AI: START for ${v.id}`);const E=[];for(let O=0;O<a.height;O+=1)for(let te=0;te<a.width;te+=1)a.tiles[O][te].provideCover&&E.push({x:te,y:O});e.debug(`Enemy Turn AI: Got cover positions for ${v.id}`);const P=Do(v,r,a,y,E,a.entities.npcs,fe.current);if(_=P,e.debug(`Enemy ${v.id} action: ${P.action}, AP left: ${P.enemy.actionPoints}`),P.action==="attack"||P.action==="attack_missed"){const O=r.health-P.player.health;O>0?(t(Pt({id:Ye(),value:O,gridX:r.position.x,gridY:r.position.y,type:P.isCritical?"crit":"damage"})),t(_o({id:Ye(),type:P.isCritical?"crit":"damage",intensity:.6,duration:300}))):P.action==="attack_missed"&&t(Pt({id:Ye(),value:0,gridX:r.position.x,gridY:r.position.y,type:"miss"}))}e.debug(`Enemy Turn AI: BEFORE dispatching updates for ${v.id}`),t(An(P.enemy)),e.debug(`Enemy Turn AI: AFTER dispatch(updateEnemy) for ${v.id}`),P.player.id===r.id&&(e.debug(`Enemy Turn AI: BEFORE dispatch(setPlayerData) for ${v.id}`),t(Hr(P.player)),e.debug(`Enemy Turn AI: AFTER dispatch(setPlayerData) for ${v.id}`)),e.debug(`Enemy Turn AI: END AI & Dispatches for ${v.id}`)}catch(E){e.error("Error during enemy turn AI:",{enemyId:v==null?void 0:v.id,error:E})}finally{const E=(_==null?void 0:_.enemy)??v,P=E&&E.health>0&&E.actionPoints>0;e.debug(`Enemy Turn FINALLY for index ${Le}. Remaining AP: ${(E==null?void 0:E.actionPoints)??v.actionPoints}. Repeat: ${P}`),je(!1),P||mt(O=>O+1)}},500)},[u,g,Le,y,t,r,a,je,e]),c.useEffect(()=>()=>{je()},[je]),c.useEffect(()=>{const m=dt.current;return()=>{m.dispose(),Oe.current=null}},[]),c.useEffect(()=>{if(!u){M.current=null;return}g&&M.current!==ie&&(M.current=ie,t(Lo()))},[t,u,g,ie]),c.useEffect(()=>{It.current&&!u&&(t(N(j.combatOver)),e.debug("Combat ended (detected via useEffect watching inCombat)."),t(xt())),It.current=u},[u,t,e,j]);const Cr=c.useCallback((m,v)=>{var re,$;const _=((re=r.equipped.weapon)==null?void 0:re.apCost)??jo,E=Number.isFinite(r.encumbrance.attackApMultiplier)?Math.max(r.encumbrance.attackApMultiplier,0):Number.POSITIVE_INFINITY,P=No(r)?0:Math.ceil(Math.max(0,_)*E);if(!Number.isFinite(P)||r.actionPoints<P){t(N(j.notEnoughAp));return}const O=(($=r.equipped.weapon)==null?void 0:$.range)??1;if(!Rn(r.position,m.position,O)){t(N(j.enemyOutOfRange));return}const te=v.tiles[m.position.y][m.position.x].provideCover;e.debug("attackEnemy: PRE-ATTACK",{enemyId:m.id,enemyPosition:m.position,isBehindCover:te,playerAP_before:r.actionPoints,attackCost:P});const U=Oo(r,m,te),H=U.newAttacker;t(Hr(H)),U.events&&U.events.forEach(se=>t(N(se.message))),e.debug("attackEnemy: POST-ATTACK",{apCost:P,playerAP_after:H.actionPoints}),U.success?(t(N(j.hitEnemy(m.name,U.damage))),t(Pt({id:Ye(),value:U.damage,gridX:m.position.x,gridY:m.position.y,type:U.isCritical?"crit":"damage"}))):(t(N(j.missedEnemy(m.name))),t(Pt({id:Ye(),value:0,gridX:m.position.x,gridY:m.position.y,type:"miss"})));const ne=U.newTarget;e.debug("attackEnemy: PRE-DISPATCH updateEnemy",{enemyId:ne.id,healthBeforeUpdate:m.health,healthInNewTarget:ne.health}),t(An(ne)),y.some(se=>se.id!==m.id||se.id===m.id&&U.newTarget.health>0)?H.actionPoints<=0&&(e.debug("attackEnemy: Player out of AP after attack, switching turn."),t(st())):t(N(j.allEnemiesDefeated))},[r,y,t,e,j]),In=c.useCallback(m=>y.length===0?null:y.reduce((v,_)=>{const E=Math.abs(_.position.x-m.x)+Math.abs(_.position.y-m.y),P=Math.abs(v.position.x-m.x)+Math.abs(v.position.y-m.y);return E<P?_:v}),[y]),Mr=c.useCallback(m=>{if(!a)return null;const v=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1},{x:1,y:1},{x:-1,y:-1},{x:-1,y:1},{x:1,y:-1}];for(const _ of v){const E={x:m.x+_.x,y:m.y+_.y};if(E.x<0||E.y<0||E.x>=a.width||E.y>=a.height)continue;const P=a.tiles[E.y],O=P?P[E.x]:void 0;if(!O||!O.isWalkable)continue;if(!y.some(U=>U.position.x===E.x&&U.position.y===E.y))return E}return null},[a,y]),Ki=c.useCallback(m=>{var P,O,te,U;const v=m.key,_=(a==null?void 0:a.isInterior)??!1;if(m.shiftKey&&(v==="A"||v==="a")){m.preventDefault(),m.stopPropagation(),t(Yn(!F));return}if(F&&u&&((P=Tt.current)==null||P.notifyManualOverride("manual_input"),t(Yn(!1))),L){m.preventDefault(),m.stopPropagation(),v==="Escape"&&(t(ln()),t(N(j.conversationEnded)));return}if(v==="e"||v==="E"){if(m.preventDefault(),m.stopPropagation(),!a)return;const H=a.entities.npcs.find(de=>!de.isInteractive||!de.dialogueId?!1:Math.abs(de.position.x-r.position.x)+Math.abs(de.position.y-r.position.y)<=1);if(H){const de=B.find(Fe=>Fe.id===H.dialogueId);if(!de||de.nodes.length===0){t(N(j.npcNoNewInfo(H.name)));return}const Ne=de.nodes[0].id;t(Lr({dialogueId:de.id,nodeId:Ne})),t(N(j.npcChannelOpened(H.name)));return}const ne=f?Ge.current??ce:void 0,J=ne?Object.values(ne.cameras).find(de=>os(de.position,r.position)<=1.5):void 0;if(!J||!f){t(N(j.noFriendlyContact));return}const re=Date.now(),$=typeof((O=J.hackState)==null?void 0:O.disabledUntil)=="number"&&J.hackState.disabledUntil>re;if(!C||$||!J.isActive){t(N(j.cameraSabotageFailed));return}t(ir({areaId:f,cameraId:J.id,timestamp:re,changes:{alertState:X.DISABLED,detectionProgress:0,trackingPlayer:!1,trackingDirection:void 0,lastDetectionTimestamp:void 0,hackState:{...J.hackState??{},disabledUntil:re+nc}}})),t(N(j.cameraSabotageSuccess)),ft.current.filter(jt).forEach(de=>{de.objectives.forEach(Ne=>{if(!ac(Ne))return;const Fe=`${de.id}:${Ne.id}:${J.id}`;bn.current.has(Fe)||(bn.current.add(Fe),ze(de),t(Dt({questId:de.id,objectiveId:Ne.id,count:1})))})});return}if(v==="Tab"&&u&&g){m.preventDefault(),m.stopPropagation(),t(N(j.endingTurn??"Ending turn...")),t(st());return}if(v===" "){if(m.preventDefault(),m.stopPropagation(),Re.length>0&&(ke([]),Ee(null),Te(null)),!u){const H=In(r.position),ne=((te=r.equipped.weapon)==null?void 0:te.range)??1;if(H&&Rn(r.position,H.position,ne)){t(Lt()),t(N(j.enteredCombat));return}}if(u&&g){const H=In(r.position),ne=((U=r.equipped.weapon)==null?void 0:U.range)??1;if(H&&Rn(r.position,H.position,ne)){Cr(H,a);return}t(N(j.noEnemiesInRange));return}return}if(u&&(!g||r.actionPoints<=0)){if(y.filter(ne=>ne.health>0).length===0){t(zo()),t(xt()),t(N(j.zoneSecured));return}if(!g){t(N(j.notYourTurn));return}if(r.actionPoints<=0){t(N(j.actionPointsDepleted)),t(st());return}}Re.length>0&&(ke([]),Ee(null),Te(null));const E={...r.position};switch(v){case"ArrowUp":case"w":case"W":E.y-=1;break;case"ArrowDown":case"s":case"S":E.y+=1;break;case"ArrowLeft":case"a":case"A":E.x-=1;break;case"ArrowRight":case"d":case"D":E.x+=1;break;default:return}if(m.preventDefault(),m.stopPropagation(),qt(E,a,r,y,{npcs:a.entities.npcs})){const H=a.tiles[E.y][E.x],ne=T.find($=>$.fromAreaId===a.id&&$.fromPosition.x===E.x&&$.fromPosition.y===E.y),J=!u&&m.shiftKey,re=r.stealthModeEnabled?J?"sprint":"silent":J?"sprint":"normal";if(r.movementProfile!==re&&t(En(re)),ne){const $=A[ne.toAreaId];if(C&&H.type===Fr.DOOR&&$&&!$.isInterior){t(N(j.checkpointSealed));return}if($){if(!gt({sprint:J}))return;t(Br($)),t(Xt(ne.toPosition)),$.isInterior&&(t(sn({type:"campfireRest",locationId:$.id})),t(N(j.slipInsideStructure)),Ze("clear"))}else e.warn(`Missing target area in state for ${ne.toAreaId}`);ke([]),Ee(null);return}if(!gt({sprint:J}))return;if(t(Xt(E)),C&&!_){if(Ut==="clear")t(N(j.searchlightsWarning)),Ze("warning");else if(Ut==="warning"){const $=Mr(E);if($){const se={id:Ye(),resourceKey:"enemies.corpsec_guard",name:j.curfewPatrolName,position:$,maxHealth:30,health:30,actionPoints:6,maxActionPoints:6,damage:6,attackRange:1,isHostile:!0};t(Wr(se)),t(sn({type:"patrolAmbush",locationId:a==null?void 0:a.id,tags:["corpsec"]})),u?t(N(j.curfewReinforcement)):(t(Lt()),t(N(j.curfewOpenFire)))}else t(N(j.curfewFootsteps));Ze("spawned")}}else Ut!=="clear"&&Ze("clear");u&&(e.debug("handleKeyDown: PRE-MOVE AP DEDUCTION",{apCost:1,playerAP_before:r.actionPoints}),t(Fo(-1)),e.debug("handleKeyDown: POST-MOVE AP DEDUCTION",{apCost:1,playerAP_after:r.actionPoints-1}),r.actionPoints<=1&&(e.debug("handleKeyDown: Player out of AP after move, switching turn."),t(st())))}},[r,a,u,g,t,y,Cr,In,C,Ut,Mr,A,Re,ke,Ee,L,T,B,f,ce,ze,e,j,gt,F]),qi=c.useCallback(m=>{m.key},[]);return i.jsx("div",{ref:ht,tabIndex:0,onKeyDown:Ki,onKeyUp:qi,className:"fixed inset-0 focus:outline-none",style:{zIndex:1},"data-testid":"game-controller"})},fc=(...e)=>e.filter(Boolean).join(" "),mc=(e,t,n,r)=>r==="none"?"base":r==="ascending"?e>=n?"critical":e>=t?"warning":"base":e<=n?"critical":e<=t?"warning":"base",as=({label:e,current:t,max:n,icon:r,variant:s="neutral",lowThreshold:o=50,criticalThreshold:l=25,disableGlow:a=!1,dangerDirection:d="descending"})=>{const f=c.useMemo(()=>{if(n<=0)return 0;const u=t/n*100;return Math.max(0,Math.min(100,u))},[t,n]),p=mc(f,o,l,d);return i.jsxs("div",{className:"hud-stat","data-variant":s,"data-level":p,"data-glow":a?"off":"on",children:[i.jsxs("div",{className:fc("hud-stat__row",p!=="base"?"hud-stat__row--emphasis":null),children:[i.jsxs("div",{className:"flex items-center gap-[0.4rem]",children:[r?i.jsx("span",{className:"hud-stat__icon",children:r}):null,i.jsx("span",{children:e})]}),i.jsxs("span",{className:"hud-stat__value","aria-live":"polite",children:[t,"/",n]})]}),i.jsx("div",{className:"hud-stat__bar",children:i.jsx("div",{className:"hud-stat__fill",style:{width:`${f}%`}})})]})},pc=(...e)=>e.filter(Boolean).join(" "),_i=c.forwardRef(({className:e,title:t,children:n,role:r,...s},o)=>i.jsxs("svg",{ref:o,viewBox:"0 0 24 24",className:pc("h-4 w-4 shrink-0 text-current",e),role:t?r??"img":"presentation","aria-hidden":t?void 0:!0,...s,children:[t?i.jsx("title",{children:t}):null,n]}));_i.displayName="IconBase";const gc=({className:e,...t})=>i.jsxs(_i,{className:e,...t,children:[i.jsx("path",{d:"M12 4.8 4 18.4c-.4.7.1 1.6.9 1.6h14.2c.8 0 1.3-.9.9-1.6L12 4.8z",fill:"currentColor",fillOpacity:.2}),i.jsx("path",{d:"M12 4.8 4 18.4c-.4.7.1 1.6.9 1.6h14.2c.8 0 1.3-.9.9-1.6L12 4.8z",stroke:"currentColor",strokeWidth:1.8,strokeLinejoin:"round",fill:"none"}),i.jsx("path",{d:"M12 9.8v3.8",stroke:"currentColor",strokeWidth:1.8,strokeLinecap:"round",fill:"none"}),i.jsx("circle",{cx:12,cy:16.6,r:1,fill:"currentColor"})]}),hc=({onOpenCharacter:e,characterOpen:t=!1,showActionButton:n=!0,className:r,variant:s="default"})=>{const o=$e(),l=R(Y=>Y.player.data),a=R(Ti),d=R(Y=>Y.settings.locale),f=R(Y=>Y.settings.testMode),p=R(Zl),u=We(d),g=u.stealthIndicator,b=l.backgroundId?Vo[l.backgroundId]:void 0,C=(b==null?void 0:b.name)??u.playerStatus.backgroundFallback,y=Math.round(a),A=p.isActive?g.stealthToggleOn:g.stealthToggleOff,T=p.blockedReason==="combat"?g.unavailableReasons.combat:p.blockedReason==="dialogue"?g.unavailableReasons.dialogue:p.blockedReason==="cooldown"?g.cooldown(Math.max(1,p.cooldownSeconds||1)):g.keyHint,S=()=>{const Y=l.level,L=qo(Y+1),Q=l.experience,F=L-Q;o(Kn({amount:Math.max(1,F),reason:"Test mode XP boost"}))},z=s==="frameless"?"flex h-full min-h-0 flex-1 flex-col gap-[0.5rem] px-0 py-0 text-[#f8fafc] font-body":"flex flex-col gap-[0.5rem] rounded-[18px] border border-[rgba(59,130,246,0.22)] bg-[linear-gradient(145deg,rgba(8,15,30,0.92),rgba(12,22,42,0.82),rgba(6,12,28,0.92))] px-[0.9rem] py-[0.9rem] text-[#f8fafc] shadow-[0_20px_30px_-20px_rgba(8,12,24,0.5)] backdrop-blur-[14px] font-body",B=r?`${z} ${r}`:z;return i.jsxs("div",{className:B,"data-testid":"player-summary-panel",children:[i.jsx("div",{className:"flex items-start gap-[0.75rem]",children:i.jsxs("div",{className:"flex min-w-0 flex-1 flex-col gap-[0.2rem]",children:[i.jsxs("div",{className:"flex items-center gap-[0.5rem] text-[0.9rem] uppercase tracking-[0.26em] text-[#bfdbfe] drop-shadow-[0_0_8px_rgba(56,189,248,0.4)]",children:[i.jsx("span",{className:"truncate",children:l.name}),i.jsxs("span",{className:"inline-flex items-center gap-[0.25rem] rounded-[999px] border border-[rgba(56,189,248,0.45)] bg-[rgba(56,189,248,0.18)] px-[0.55rem] py-[0.22rem] text-[0.6rem] font-semibold tracking-[0.14em] text-[#f8fafc] shadow-[0_10px_20px_-10px_rgba(56,189,248,0.55)]",children:[u.playerStatus.levelLabel," ",l.level]}),i.jsx("button",{type:"button",onClick:()=>o(Yo()),className:["inline-flex items-center gap-[0.25rem] rounded-[999px] border px-[0.55rem] py-[0.22rem] text-[0.6rem] font-semibold uppercase tracking-[0.14em] transition-all duration-150",p.isActive?"border-[rgba(45,212,191,0.65)] bg-[rgba(20,83,74,0.44)] text-[#ccfbf1] shadow-[0_10px_20px_-12px_rgba(20,184,166,0.55)]":"border-[rgba(148,163,184,0.6)] bg-[rgba(30,41,59,0.45)] text-[#dbeafe] shadow-[0_10px_20px_-12px_rgba(59,130,246,0.35)]"].join(" "),"data-testid":"player-stealth-toggle","aria-pressed":p.isActive,title:T,children:A})]}),i.jsx("div",{className:"text-[0.6rem] uppercase tracking-[0.12em] text-[rgba(226,232,240,0.72)]",children:C})]})}),i.jsx(as,{label:u.playerStatus.healthLabel,current:l.health,max:l.maxHealth,variant:"health",lowThreshold:50,criticalThreshold:25}),i.jsx(as,{label:u.playerStatus.paranoiaLabel,current:y,max:100,variant:"paranoia",lowThreshold:50,criticalThreshold:75,dangerDirection:"ascending"}),l.isExhausted&&i.jsxs("span",{className:"mt-[0.35rem] inline-flex items-center gap-[0.3rem] rounded-[999px] border border-[rgba(250,204,21,0.65)] bg-[rgba(250,204,21,0.08)] px-[0.55rem] py-[0.22rem] text-[0.55rem] font-semibold uppercase tracking-[0.14em] text-[#facc15] shadow-[0_8px_18px_-12px_rgba(250,204,21,0.6)]",title:u.playerStatus.fatigueHint,children:[i.jsx(gc,{className:"text-[#facc15]","aria-hidden":!0}),i.jsx("span",{children:u.playerStatus.fatigueStatus})]}),i.jsxs("div",{className:"grid grid-cols-2 gap-[0.28rem]",children:[i.jsxs("div",{className:"flex min-w-0 flex-col gap-[0.12rem] rounded-[12px] border border-[rgba(248,250,252,0.08)] bg-[linear-gradient(160deg,rgba(14,26,52,0.88),rgba(10,18,34,0.88))] px-[0.5rem] py-[0.45rem] shadow-[0_16px_30px_-20px_rgba(13,148,136,0.6)]",children:[i.jsx("span",{className:"text-[0.5rem] uppercase tracking-[0.12em] text-[rgba(148,163,184,0.7)]",children:u.playerStatus.creditsLabel}),i.jsxs("span",{className:"text-[0.85rem] font-semibold text-[#fbbf24] drop-shadow-[0_0_12px_rgba(251,191,36,0.5)]",children:["₿",l.credits]})]}),i.jsxs("div",{className:"flex min-w-0 flex-col gap-[0.12rem] rounded-[12px] border border-[rgba(248,250,252,0.08)] bg-[linear-gradient(160deg,rgba(14,26,52,0.88),rgba(10,18,34,0.88))] px-[0.5rem] py-[0.45rem] shadow-[0_16px_30px_-20px_rgba(13,148,136,0.6)]",children:[i.jsx("span",{className:"text-[0.5rem] uppercase tracking-[0.12em] text-[rgba(148,163,184,0.7)]",children:u.playerStatus.experienceLabel}),i.jsx("span",{className:"text-[0.85rem] font-semibold text-[#38bdf8] drop-shadow-[0_0_12px_rgba(56,189,248,0.45)]",children:Ko(l.experience,l.level)})]})]}),e&&n&&i.jsxs("div",{className:"flex gap-[0.5rem]",children:[i.jsx("button",{type:"button",onClick:e,className:["flex-1 rounded-[999px] border px-[0.75rem] py-[0.42rem] text-[0.58rem] font-semibold uppercase tracking-[0.18em] text-[#e0f2fe] shadow-[0_12px_20px_-18px_rgba(56,189,248,0.45)] transition-transform duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-neon/60 focus-visible:ring-offset-2 focus-visible:ring-offset-gunmetal-900",t?"border-[rgba(251,191,36,0.9)] bg-[linear-gradient(130deg,rgba(251,191,36,0.6),rgba(249,115,22,0.55))] text-[#fff7e1]":"border-[rgba(56,189,248,0.55)] bg-[linear-gradient(130deg,rgba(56,189,248,0.48),rgba(14,165,233,0.45))]"].join(" "),"data-testid":"summary-open-character","aria-pressed":t,children:u.shell.characterButton}),f&&i.jsx("button",{type:"button",onClick:S,className:"flex-1 rounded-[999px] border border-[rgba(251,191,36,0.9)] bg-[linear-gradient(130deg,rgba(251,191,36,0.48),rgba(249,115,22,0.45))] px-[0.75rem] py-[0.38rem] text-[0.58rem] font-semibold uppercase tracking-[0.18em] text-[#fff8dc] shadow-[0_12px_20px_-16px_rgba(251,191,36,0.48)] transition-all duration-200 hover:-translate-y-[2px] hover:scale-[1.01] hover:border-[rgba(251,191,36,1)] hover:shadow-[0_0_0_2px_rgba(251,191,36,0.4),0_14px_24px_-16px_rgba(251,191,36,0.6)] focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-400 focus-visible:ring-offset-2 focus-visible:ring-offset-gunmetal-900",title:"Test Mode: Gain XP to level up",children:"⬆ Level Up"})]})]})},yc=Bt.memo(hc),ls=15,bc=e=>{const{totalMinutes:t}=oi(e),n=Math.floor(t/ls)*ls,r=Math.floor(n/60)%24,s=n%60;return`${r.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`},xc=()=>{const e=R(l=>bc(l.world.currentTime)),t=R(l=>l.settings.locale),n=We(t).dayNight,[r,s]=e.split(":");return i.jsxs(i.Fragment,{children:[i.jsx("style",{children:`
    .day-night-clock {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.28rem;
      width: 7.6rem;
      justify-content: center;
      padding: 0.44rem 0.7rem;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.9);
      box-shadow: 0 0 12px rgba(56, 189, 248, 0.16);
      color: #e2e8f0;
      font-family: 'DM Mono', 'IBM Plex Mono', monospace;
      font-size: 0.98rem;
      font-weight: 600;
      letter-spacing: 0.14em;
      line-height: 1;
      text-shadow: 0 0 9px rgba(56, 189, 248, 0.32);
      pointer-events: none;
      user-select: none;
    }

    .day-night-clock::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(
        to bottom,
        rgba(148, 163, 184, 0.1),
        rgba(15, 23, 42, 0)
      );
      pointer-events: none;
    }

    .day-night-clock__digit {
      display: inline-flex;
      min-width: 1.55rem;
      justify-content: center;
    }

    .day-night-clock__colon {
      color: rgba(186, 230, 253, 0.9);
    }
  `}),i.jsxs("div",{className:"day-night-clock",role:"status","aria-label":`${n.clockLabel}: ${e}`,"data-testid":"day-night-clock",children:[i.jsx("span",{className:"day-night-clock__digit",children:r}),i.jsx("span",{className:"day-night-clock__colon","aria-hidden":!0,children:":"}),i.jsx("span",{className:"day-night-clock__digit",children:s})]})]})},Jt=8,Li={liveArea:20,stroke:2},cs={floor:"#101b32",wall:"#1f2937",door:"#fbbf24",cover:"#1d4ed8",water:"#0ea5e9",trap:"#7c3aed",default:"#101b32"},ds={player:"#60a5fa",enemy:"#f87171",npc:"#34d399",objective:"#facc15"},us={[X.IDLE]:"#38bdf8",[X.SUSPICIOUS]:"#fbbf24",[X.INVESTIGATING]:"#f97316",[X.ALARMED]:"#ef4444",[X.DISABLED]:"#64748b"},un=Li.stroke,ji=Li.liveArea/2,wc="rgba(15, 23, 42, 0.95)",fs=16,vc=256,Sc=192,Ic=192,kc=160,Ni=(e,t)=>{if(typeof window>"u"||typeof document>"u")return t;try{const n=window.getComputedStyle(document.documentElement).getPropertyValue(e);return(n==null?void 0:n.trim())||t}catch{return t}},Oi=()=>Ni("--color-hud-surface",wc),Ec=()=>{const e=Ni("--hud-radius-lg",`${fs}px`),t=Number.parseFloat(e);return Number.isFinite(t)?t:fs},Xn=e=>({minX:0,minY:0,maxX:Math.max(0,e.mapWidth-1),maxY:Math.max(0,e.mapHeight-1),width:Math.max(1,e.mapWidth),height:Math.max(1,e.mapHeight)}),en=e=>{var n;if(!e)return!1;const t=((n=e.type)==null?void 0:n.toString().toLowerCase())??"";return t==="wall"||t==="door"||t==="cover"?!0:e.isWalkable===!1},Nn=e=>{var y;const t=e.tiles;if(!t.length||!((y=t[0])!=null&&y.length))return Xn(e);const n=(A,T,S)=>Math.min(Math.max(A,T),S),r=A=>{if(!A)return-1;for(let T=0;T<A.length;T+=1)if(en(A[T]))return T;return-1},s=A=>{if(!A)return-1;for(let T=A.length-1;T>=0;T-=1)if(en(A[T]))return T;return-1},o=A=>{for(let T=0;T<t.length;T+=1){const S=t[T];if(S&&en(S[A]))return T}return-1},l=A=>{for(let T=t.length-1;T>=0;T-=1){const S=t[T];if(S&&en(S[A]))return T}return-1};let a=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY,f=Number.POSITIVE_INFINITY,p=Number.NEGATIVE_INFINITY;for(let A=0;A<t.length;A+=1){const T=t[A],S=r(T);S!==-1&&S<a&&(a=S);const z=s(T);z!==-1&&z>d&&(d=z)}for(let A=0;A<e.mapWidth;A+=1){const T=o(A);T!==-1&&T<f&&(f=T);const S=l(A);S!==-1&&S>p&&(p=S)}if(!Number.isFinite(a)||!Number.isFinite(d)||!Number.isFinite(f)||!Number.isFinite(p))return Xn(e);const u=n(a,0,Math.max(0,e.mapWidth-1)),g=n(d,u,Math.max(0,e.mapWidth-1)),b=n(f,0,Math.max(0,e.mapHeight-1)),C=n(p,b,Math.max(0,e.mapHeight-1));return{minX:u,minY:b,maxX:g,maxY:C,width:Math.max(1,g-u+1),height:Math.max(1,C-b+1)}},Nt=(e,t,n)=>Math.min(Math.max(e,t),n),ms=(e,t)=>Math.min(ji,Math.max(3,e*t)),lt=(e,t=un)=>Math.max(.5,t)/Math.max(e,1e-4),Tc=(e,t,n,r,s,o)=>{const l=Math.max(0,Math.min(o,Math.min(r,s)/2));e.beginPath(),e.moveTo(t+l,n),e.lineTo(t+r-l,n),e.quadraticCurveTo(t+r,n,t+r,n+l),e.lineTo(t+r,n+s-l),e.quadraticCurveTo(t+r,n+s,t+r-l,n+s),e.lineTo(t+l,n+s),e.quadraticCurveTo(t,n+s,t,n+s-l),e.lineTo(t,n+l),e.quadraticCurveTo(t,n,t+l,n),e.closePath()},On=(e,t)=>{const n=1.3333333333333333,r=Math.max(1,Math.round(t.width)),s=Math.max(1,Math.round(t.height));let o=Math.max(1,e.width),l=Math.max(1,e.height);return o/l>n?o=l*n:l=o/n,o>r&&(o=r,l=o/n),l>s&&(l=s,o=l*n,o>r&&(o=r,l=o/n)),{width:Math.max(1,Math.round(o)),height:Math.max(1,Math.round(l))}},Cc=(e,t,n)=>{if(!e)return null;const r=window.devicePixelRatio||1,s=Math.max(1,Math.round(t*r)),o=Math.max(1,Math.round(n*r));e.width!==s&&(e.width=s),e.height!==o&&(e.height=o),e.style.width=`${t}px`,e.style.height=`${n}px`;const l=e.getContext("2d");return l?(l.setTransform(r,0,0,r,0,0),l.imageSmoothingEnabled=!1,l):null},Mc=({ctx:e,state:t,crop:n})=>{const{tiles:r,tileScale:s}=t,o=Oi();e.fillStyle=o,e.fillRect(n.minX*s,n.minY*s,n.width*s,n.height*s);for(let l=n.minY;l<=n.maxY;l+=1){const a=r[l];if(a)for(let d=n.minX;d<=n.maxX;d+=1){const f=a[d];if(!f)continue;const p=cs[f.type.toLowerCase()]??cs.default;e.fillStyle=p,e.fillRect(d*s,l*s,s,s),f.provideCover&&(e.fillStyle="rgba(59, 130, 246, 0.15)",e.fillRect(d*s,l*s,s,s))}}},Ac=({ctx:e,state:t,scale:n,crop:r})=>{const{tileScale:s,entities:o,cameras:l}=t,a=t.objectiveMarkers??[];o.forEach(d=>{if(d.x<r.minX||d.x>r.maxX||d.y<r.minY||d.y>r.maxY)return;const f=ds[d.kind]??ds.npc,p=ms(s,d.kind==="player"?.7:d.kind==="npc"?.62:.5),u=(d.x+.5)*s,g=(d.y+.5)*s;d.kind==="player"?(e.fillStyle=f,e.beginPath(),e.moveTo(u,g-p),e.lineTo(u+p,g+p),e.lineTo(u-p,g+p),e.closePath(),e.fill()):(e.fillStyle=d.status==="inactive"?"rgba(148, 163, 184, 0.35)":f,e.beginPath(),e.arc(u,g,p*.85,0,Math.PI*2),e.fill(),(d.kind==="enemy"||d.kind==="npc")&&(e.strokeStyle="rgba(15, 23, 42, 0.85)",e.lineWidth=lt(n),e.stroke()))}),a.forEach(d=>{if(d.x<r.minX||d.x>r.maxX||d.y<r.minY||d.y>r.maxY)return;const f=d.markerKind==="questContact",p=Math.min(ji,Math.max(f?6:5,s*(f?.66:.55))),u=(d.x+.5)*s,g=(d.y+.5)*s;e.fillStyle=f?"rgba(34, 211, 238, 0.2)":"rgba(251, 191, 36, 0.2)",e.beginPath(),e.arc(u,g,p,0,Math.PI*2),e.fill(),e.strokeStyle=f?"rgba(34, 211, 238, 0.95)":"rgba(251, 191, 36, 0.95)",e.lineWidth=lt(n),e.beginPath(),e.arc(u,g,p*.7,0,Math.PI*2),e.stroke()}),l.forEach(d=>{if(d.x<r.minX||d.x>r.maxX||d.y<r.minY||d.y>r.maxY)return;const f=d.isActive?us[d.alertState]:us[X.DISABLED],p=ms(s,.5),u=(d.x+.5)*s,g=(d.y+.5)*s;e.save(),e.fillStyle=f,e.beginPath(),e.moveTo(u,g-p),e.lineTo(u+p,g+p),e.lineTo(u-p,g+p),e.closePath(),e.fill(),e.lineWidth=lt(n),e.strokeStyle="rgba(15, 23, 42, 0.65)",e.stroke(),e.restore()})},Rc=({ctx:e,state:t,scale:n})=>{const{path:r,tileScale:s}=t;if(!r||r.length<2)return;e.strokeStyle="rgba(59, 130, 246, 0.6)",e.lineWidth=lt(n,un*.95),e.lineJoin="round",e.lineCap="round",e.setLineDash([s*.8,s*.5]),e.beginPath(),r.forEach((d,f)=>{const p=(d.x+.5)*s,u=(d.y+.5)*s;f===0?e.moveTo(p,u):e.lineTo(p,u)}),e.stroke(),e.setLineDash([]);const o=r[r.length-1],l=(o.x+.5)*s,a=(o.y+.5)*s;e.fillStyle="rgba(59, 130, 246, 0.12)",e.beginPath(),e.arc(l,a,Math.max(4,s*.4),0,Math.PI*2),e.fill(),e.strokeStyle="rgba(59, 130, 246, 0.7)",e.lineWidth=lt(n),e.beginPath(),e.arc(l,a,Math.max(3,s*.28),0,Math.PI*2),e.stroke()},Pc=({ctx:e,state:t,scale:n},r)=>{const{viewport:s,tileScale:o}=t;if(!s||s.width<=0||s.height<=0)return;const l=r.width,a=r.height,d=l*o,f=a*o,p=(s.x+s.width/2)*o,u=(s.y+s.height/2)*o,g=p-d/2,b=u-f/2,C=Math.min(Math.max(4,d*.12),Ec()/Math.max(n,1e-4));e.save(),e.lineWidth=lt(n,un*.85),e.strokeStyle="rgba(148, 163, 184, 0.4)",Tc(e,g,b,d,f,C),e.stroke(),e.restore();const y=Math.max(2,o*.5);e.save(),e.strokeStyle="rgba(148, 163, 184, 0.5)",e.lineWidth=lt(n,un*.75),e.beginPath(),e.moveTo(p-y,u),e.lineTo(p+y,u),e.moveTo(p,u-y),e.lineTo(p,u+y),e.stroke(),e.restore()},Dc=(e,t,n,r,s,o)=>{const l=Cc(e,n,r);if(!l)return;l.clearRect(0,0,n,r),l.fillStyle=Oi(),l.fillRect(0,0,n,r);const a=o.width*t.tileScale,d=o.height*t.tileScale;if(a<=0||d<=0)return;const f=Math.min(n/a,r/d),p=(n-a*f)/2,u=(r-d*f)/2;l.save(),l.translate(p,u),l.scale(f,f),l.translate(-o.minX*t.tileScale,-o.minY*t.tileScale);const g={ctx:l,state:t,scale:f,crop:o};Mc(g),Rc(g),Ac(g),Pc(g,s),l.restore()},_c=()=>{const e=c.useRef(null),t=c.useRef(null),n=c.useRef(it.getState()),r=c.useRef(n.current?Nn(n.current):null),[s,o]=c.useState({width:vc,height:Sc}),[l,a]=c.useState(0),d=c.useRef(null),f=c.useRef(null),p=c.useRef(!1),u=c.useRef(null),g=c.useRef(!1),b=c.useCallback(()=>n.current,[]),C=c.useCallback(h=>h?(r.current||(r.current=Nn(h)),r.current??Xn(h)):null,[]),y=c.useCallback(h=>{const w=h.viewport;if(!w)return;f.current!==h.areaId&&(d.current=null,f.current=h.areaId);const I=On(w,{width:h.mapWidth,height:h.mapHeight}),k=d.current;(!k||k.width!==I.width||k.height!==I.height)&&(d.current=I)},[]);c.useEffect(()=>{const h=w=>{const I=w.detail;n.current=I,r.current=Nn(I),y(I),a(I.version)};return it.addEventListener(Gr,h),it.requestImmediateState(),()=>{it.removeEventListener(Gr,h)}},[y]),c.useEffect(()=>{const h=e.current;if(!h||typeof ResizeObserver>"u")return;const w=new ResizeObserver(()=>{const I=Math.max(Ic,Math.floor(h.clientWidth/Jt)*Jt),k=Math.max(kc,Math.floor(h.clientHeight/Jt)*Jt);o(x=>x.width===I&&x.height===k?x:{width:I,height:k}),it.setCanvasBounds(I,k)});return w.observe(h),()=>w.disconnect()},[]),c.useEffect(()=>{const h=b(),w=d.current,I=C(h);!h||!w||!I||Dc(t.current,h,s.width,s.height,w,I)},[s.width,s.height,l,b,C]);const A=c.useCallback(h=>{const w=b(),I=t.current,k=C(w);if(!w||!I||!k)return null;const x=I.getBoundingClientRect(),q=x.width,G=x.height;if(q===0||G===0)return null;const ie=k.width*w.tileScale,V=k.height*w.tileScale,Z=Math.min(q/ie,G/V),ce=(q-ie*Z)/2,ue=(G-V*Z)/2,me=(h.clientX-x.left-ce)/Z,ye=(h.clientY-x.top-ue)/Z,pe=me+k.minX*w.tileScale,be=ye+k.minY*w.tileScale,D=Nt(pe/w.tileScale,0,w.mapWidth),ge=Nt(be/w.tileScale,0,w.mapHeight);return{gridX:D,gridY:ge}},[C,b]),T=c.useCallback((h,w)=>{if(!h)return;const I=b(),k=I==null?void 0:I.viewport;if(!I||!k)return;const x=d.current??On(k,{width:I.mapWidth,height:I.mapHeight}),q=x.width/2,G=x.height/2,ie=Nt(h.gridX,q,Math.max(q,I.mapWidth-q)),V=Nt(h.gridY,G,Math.max(G,I.mapHeight-G));d.current=x,it.emitInteraction({type:Xo,gridX:ie,gridY:V,animate:w})},[b]),S=h=>{if(h.pointerType!=="touch"&&h.button!==0)return;const w=A(h);if(w){if(p.current=!0,g.current=!1,u.current=h.pointerId,typeof h.currentTarget.setPointerCapture=="function")try{h.currentTarget.setPointerCapture(h.pointerId)}catch{}T(w,!0)}},z=h=>{if(!p.current||u.current!==h.pointerId)return;const w=A(h);w&&(g.current=!0,T(w,!1))},B=h=>{if(!p.current||u.current!==h.pointerId)return;const w=A(h);T(w,!g.current),p.current=!1,u.current=null},Y=h=>{u.current===h.pointerId&&(p.current=!1,u.current=null)},L=()=>{p.current=!1,u.current=null},Q=h=>{h.preventDefault();const w=Nt(h.deltaY,-120,120);it.adjustZoom(w<0?.15:-.15)},F=h=>{if(!["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(h.key))return;h.preventDefault();const w=b();if(!w)return;const I=d.current??On(w.viewport,{width:w.mapWidth,height:w.mapHeight}),k=Math.max(1,Math.floor(I.width*.2));let x=w.viewport.x+w.viewport.width/2,q=w.viewport.y+w.viewport.height/2;switch(h.key){case"ArrowUp":q-=k;break;case"ArrowDown":q+=k;break;case"ArrowLeft":x-=k;break;case"ArrowRight":x+=k;break}T({gridX:x,gridY:q},!1)};return!(b()&&d.current)?null:i.jsx("section",{className:"mini-map-panel","aria-label":"MiniMap panel",children:i.jsx("div",{ref:e,className:"mini-map-canvas",role:"application","aria-label":"MiniMap viewport",tabIndex:0,onKeyDown:F,onWheel:Q,onPointerDown:S,onPointerMove:z,onPointerUp:B,onPointerCancel:Y,onPointerLeave:L,children:i.jsx("canvas",{ref:t,style:{width:"100%",height:"100%",display:"block"}})})})},Lc=Bt.memo(_c),jc=({children:e,className:t,variant:n="default"})=>{const r=n==="frameless"?"flex h-full min-h-0 flex-1 flex-col gap-[0.5rem] px-0 py-0 text-[#f8fafc] font-body":"flex h-full min-h-0 flex-1 flex-col gap-[0.5rem] rounded-[18px] border border-[rgba(59,130,246,0.22)] bg-[linear-gradient(145deg,rgba(8,15,30,0.92),rgba(12,22,42,0.82),rgba(6,12,28,0.92))] px-[0.9rem] py-[0.9rem] text-[#f8fafc] shadow-[0_20px_30px_-20px_rgba(8,12,24,0.5)] backdrop-blur-[14px] font-body",s=t?`${r} ${t}`:r;return i.jsx("div",{className:s,"data-testid":"tactical-panel",children:e})},Nc=Bt.memo(jc),pn=e=>e.player.data,Oc=e=>!!e.settings.reputationSystemsEnabled,zc={resistance:0,corpsec:0,scavengers:0};K(pn,e=>e.karma);const Fc=K(pn,Oc,(e,t)=>t?e.factionReputation:zc),Bc={corpsec_defector:{earnest:.6,stoic:.4},street_urchin:{sarcastic:.7,ruthless:.3},underground_hacker:{sarcastic:.6,earnest:.4},wasteland_scavenger:{ruthless:.6,stoic:.4}},$c=e=>{let t="earnest",n=Number.NEGATIVE_INFINITY;return Object.keys(e).forEach(r=>{const s=e[r];s>n&&(t=r,n=s)}),t},Wc=e=>{const t={earnest:0,sarcastic:0,ruthless:0,stoic:0},n={...t,...e},r=Object.values(n).reduce((s,o)=>s+o,0);return r<=0?{...t,earnest:1}:Object.keys(n).reduce((s,o)=>(s[o]=Number.parseFloat((n[o]/r).toFixed(3)),s),t)},Hc=K(pn,e=>{const t={...e.personality.flags};if(e.backgroundId){const r=Bc[e.backgroundId];r&&Object.keys(r).forEach(s=>{const o=t[s]??0;t[s]=o+r[s]})}const n=Wc(t);return{alignment:$c(n),flags:n,lastUpdated:e.personality.lastUpdated,lastChangeSource:e.personality.lastChangeSource}});K(pn,e=>e.name);const Gc=e=>e.quests.quests,Uc=K(Gc,e=>e.filter(t=>t.isActive&&!t.isCompleted)),Vc=(e,t)=>/main/i.test(e.id)||/main/i.test(e.name)?-50+t:/datapad|operation|cold|iron/i.test(e.id)?-25+t:t,fr=K(Uc,e=>{const t=[];return e.forEach((n,r)=>{n.objectives.filter(s=>!s.isCompleted).forEach((s,o)=>{t.push({questId:n.id,questName:n.name,questDescription:n.description,objective:s,priority:Vc(n,r)*10+o,isPrimary:r===0})})}),t.sort((n,r)=>n.priority-r.priority)});K(fr,e=>e.length>0?e[0]:null);K(fr,e=>e.length>1?e[1]:null);const mr=e=>e.missions,Yc=e=>e.quests.quests,Kc=K(mr,e=>e.levels[e.currentLevelIndex]??null),qc=e=>e?e.isCompleted?!0:e.objectives.length>0&&e.objectives.every(t=>t.isCompleted):!1,Xc=(e,t)=>{const n=e.questIds.map(l=>t.find(a=>a.id===l)),r=e.questIds.length,s=n.filter(qc).length;return{...e,totalQuests:r,completedQuests:s,isComplete:r===0?!1:s===r}},ps=(e,t)=>e.map(n=>Xc(n,t)),De=K([Kc,Yc],(e,t)=>{if(!e)return null;const n=ps(e.objectives.filter(o=>o.kind==="primary"),t),r=ps(e.objectives.filter(o=>o.kind==="side"),t),s=n.length>0&&n.every(o=>o.isComplete);return{level:e.level,levelId:e.levelId,name:e.name,zoneId:e.zoneId,primary:n,side:r,allPrimaryComplete:s}});K(De,e=>(e==null?void 0:e.primary)??[]);K(De,e=>(e==null?void 0:e.side)??[]);const Qc=K(De,e=>(e==null?void 0:e.primary.find(t=>!t.isComplete))??null),Zc=K(De,e=>(e==null?void 0:e.side.find(t=>!t.isComplete))??null);K(De,e=>(e==null?void 0:e.allPrimaryComplete)??!1);const zi=K(mr,e=>e.pendingAdvance),Jc=K(mr,e=>e.celebrationAcknowledged);K(De,e=>(e==null?void 0:e.level)??0);K(De,e=>(e==null?void 0:e.name)??"");const Qn={banter:{earnest:[{text:"Shelterline kids started a rumor that thunder is just the ocean applauding us. Let’s stay worth the encore.",guidelineRef:"plot.tone.guideline.7"},{text:"Amara logged a new morale playlist: ninety minutes of clattering cutlery recorded during a pre-war dinner rush. We could dance to that later.",guidelineRef:"plot.tone.guideline.6"}],sarcastic:[{text:"CorpSec just issued an alert about “unauthorized optimism in Sector 12.” Congratulations, you’re contraband joy.",guidelineRef:"plot.tone.guideline.4"},{text:"Fun fact: drone firmware now includes “coyote deterrent mode.” Somewhere an engineer thinks we’re wildlife. Let’s give them a nature documentary.",guidelineRef:"plot.tone.guideline.2"}],ruthless:[{text:"Found an ESD memo describing us as “surgical entropy.” I’ll embrace the brand if you do.",guidelineRef:"plot.tone.guideline.5"},{text:"CorpSec requisitioned riot foam flavored like citrus. Imagine choking on oranges while we dismantle their barricade.",guidelineRef:"plot.tone.guideline.2"}],stoic:[{text:"Filed under anomalies: pigeons roosting in the comms tower tapped out Morse for “stay loud.” No human hands detected.",guidelineRef:"plot.tone.guideline.2"},{text:"Supply ledger shows someone requisitioned 40 kilos of glitter for “psychological operations.” I logged it as “to be determined.”",guidelineRef:"plot.tone.guideline.3"}]},interjections:{questCompleted:{earnest:[{text:"Objective archived. You just stretched curfew a little thinner.",guidelineRef:"plot.tone.guideline.1"},{text:"Quest wrapped. Shelterline will taste this win in their next ration drop.",guidelineRef:"plot.tone.guideline.7"}],sarcastic:[{text:"You crushed that objective so hard the drones filed a workplace grievance.",guidelineRef:"plot.tone.guideline.4"},{text:"Quest complete. Somewhere an ESD analyst just spat in their nutrient slurry.",guidelineRef:"plot.tone.guideline.4"}],ruthless:[{text:"Target neutralized. Momentum stays with us.",guidelineRef:"plot.tone.guideline.5"},{text:"Objective cleared. Line them up for the next strike.",guidelineRef:"plot.tone.guideline.5"}],stoic:[{text:"Task completed. Logging success before it cools.",guidelineRef:"plot.tone.guideline.3"},{text:"Objective done. Updating projections now.",guidelineRef:"plot.tone.guideline.3"}]},reputationPositive:{earnest:[{text:"Your name circulates with smiles today. Resistance morale just spiked.",guidelineRef:"plot.tone.guideline.7"}],sarcastic:[{text:"Congrats, you’re trending on the underground net for something other than property damage.",guidelineRef:"plot.tone.guideline.4"}],ruthless:[{text:"Factions noticed your precision. They’ll expect more sharp edges.",guidelineRef:"plot.tone.guideline.5"}],stoic:[{text:"Reputation bump logged. Allies recalibrating expectations.",guidelineRef:"plot.tone.guideline.3"}]},reputationNegative:{earnest:[{text:"Heads up: whispers turned uneasy. We might need to mend fences soon.",guidelineRef:"plot.tone.guideline.1"}],sarcastic:[{text:"Your popularity dip just broke a few pirate radio polls. Impressive in its own way.",guidelineRef:"plot.tone.guideline.4"}],ruthless:[{text:"Standing dropped. Intimidation can be leverage, but watch the collateral.",guidelineRef:"plot.tone.guideline.5"}],stoic:[{text:"Faction trust decaying. Rebalancing recommendations forthcoming.",guidelineRef:"plot.tone.guideline.3"}]},hostileEntered:{earnest:[{text:"Sensors scream hostile territory. Stay quick, stay breathing.",guidelineRef:"plot.tone.guideline.1"}],sarcastic:[{text:"Welcome to enemy hospitality. Complimentary bullets on the mezzanine.",guidelineRef:"plot.tone.guideline.4"}],ruthless:[{text:"Hostile zone confirmed. Perfect conditions for decisive violence.",guidelineRef:"plot.tone.guideline.5"}],stoic:[{text:"Hostility detected. Updating threat overlay now.",guidelineRef:"plot.tone.guideline.3"}]}}},ed=e=>{const t=Qn.banter[e]??Qn.banter.earnest;return t[Math.floor(Math.random()*t.length)]},td=(e,t)=>{const n=Qn.interjections[e];if(!n)return null;const r=n[t]??n.earnest;return!r||r.length===0?null:r[Math.floor(Math.random()*r.length)]},nd=["gangHeat","curfewLevel","supplyScarcity","blackoutTier"],rd={rumor:45e3,signage:45e3,weather:3e4,zoneDanger:15e3,hazardChange:12e3,zoneBrief:6e4},Zn=e=>({gangHeat:e.gangHeat,curfewLevel:e.curfewLevel,supplyScarcity:e.supplyScarcity,blackoutTier:e.blackoutTier}),gs=e=>({flags:Zn(e.flags),impacts:{behavior:{...e.impacts.behavior},faction:{...e.impacts.faction},travel:{...e.impacts.travel}},rumor:e.rumor?{groupId:e.rumor.groupId,lines:[...e.rumor.lines],storyFunction:e.rumor.storyFunction,updatedAt:e.rumor.updatedAt}:null,signage:e.signage?{signId:e.signage.signId,text:e.signage.text,storyFunction:e.signage.storyFunction,updatedAt:e.signage.updatedAt}:null,weather:{presetId:e.weather.presetId,description:e.weather.description,storyFunction:e.weather.storyFunction,updatedAt:e.weather.updatedAt,rainIntensity:e.weather.rainIntensity,thunderActive:e.weather.thunderActive,timeOfDay:e.weather.timeOfDay},zone:{zoneId:e.zone.zoneId,zoneName:e.zone.zoneName,dangerRating:e.zone.dangerRating,hazards:[...e.zone.hazards],summary:e.zone.summary,directives:[...e.zone.directives]}}),hs=e=>{const t=new Map;return e.forEach(n=>{const r=n.trim();if(!r)return;const s=r.toLowerCase();t.has(s)||t.set(s,r)}),t},sd=(e,t)=>{if(e.length!==t.length)return!1;for(let n=0;n<e.length;n+=1)if(e[n]!==t[n])return!1;return!0};class id{constructor(t){Ae(this,"previous",null);Ae(this,"lastEmitted",{});Ae(this,"cooldowns");this.cooldowns={...rd,...(t==null?void 0:t.cooldowns)??{}}}prime(t){this.previous=gs(t),this.lastEmitted={}}reset(){this.previous=null,this.lastEmitted={}}collect(t,n=Date.now()){const r=gs(t);if(!this.previous)return this.previous=r,[];const s=this.diff(this.previous,r,n),o=[];for(const l of s){const a=this.lastEmitted[l.category],d=this.cooldowns[l.category]??0;typeof a=="number"&&d>0&&n-a<d||(o.push(l),this.lastEmitted[l.category]=n)}return this.previous=r,o}diff(t,n,r){const s=[];n.rumor&&n.rumor.lines.length>0&&(!t.rumor||t.rumor.updatedAt!==n.rumor.updatedAt)&&s.push({category:"rumor",timestamp:r,groupId:n.rumor.groupId,lines:[...n.rumor.lines],storyFunction:n.rumor.storyFunction}),n.signage&&(!t.signage||t.signage.updatedAt!==n.signage.updatedAt||t.signage.text!==n.signage.text)&&s.push({category:"signage",timestamp:r,signId:n.signage.signId,text:n.signage.text,storyFunction:n.signage.storyFunction}),(t.weather.presetId!==n.weather.presetId||t.weather.updatedAt!==n.weather.updatedAt||t.weather.rainIntensity!==n.weather.rainIntensity||t.weather.thunderActive!==n.weather.thunderActive||t.weather.timeOfDay!==n.weather.timeOfDay)&&s.push({category:"weather",timestamp:r,presetId:n.weather.presetId,previousPresetId:t.weather.presetId,description:n.weather.description,storyFunction:n.weather.storyFunction,rainIntensity:n.weather.rainIntensity,thunderActive:n.weather.thunderActive,timeOfDay:n.weather.timeOfDay});const l=nd.reduce((C,y)=>(t.flags[y]!==n.flags[y]&&C.push({key:y,previous:t.flags[y],next:n.flags[y]}),C),[]),a=t.zone.dangerRating!==n.zone.dangerRating,d=n.zone.zoneName??t.zone.zoneName??null;(a||l.length>0)&&s.push({category:"zoneDanger",timestamp:r,dangerRating:n.zone.dangerRating??null,previousDangerRating:t.zone.dangerRating??null,flags:Zn(n.flags),previousFlags:Zn(t.flags),changedFlags:l,zoneName:d});const f=hs(t.zone.hazards),p=hs(n.zone.hazards),u=[];p.forEach((C,y)=>{f.has(y)||u.push(C)});const g=[];return f.forEach((C,y)=>{p.has(y)||g.push(C)}),(u.length>0||g.length>0)&&s.push({category:"hazardChange",timestamp:r,added:u,removed:g,zoneName:d}),(t.zone.zoneId!==n.zone.zoneId||t.zone.zoneName!==n.zone.zoneName||t.zone.summary!==n.zone.summary||!sd(t.zone.directives,n.zone.directives))&&s.push({category:"zoneBrief",timestamp:r,zoneName:n.zone.zoneName??d,summary:n.zone.summary??null,dangerRating:n.zone.dangerRating??null,hazards:[...n.zone.hazards],directives:[...n.zone.directives]}),s}}const Jn="MISSION_ACCOMPLISHED",er="LEVEL_ADVANCE_REQUESTED",od=e=>{typeof window>"u"||window.dispatchEvent(new CustomEvent(Jn,{detail:e}))},ad=e=>{typeof window>"u"||window.dispatchEvent(new CustomEvent(er,{detail:e}))},ld=9e3,ys=48e3,cd=96e3,bs=12,dd=['Diagnostics show morale at "manageable"—keep it that way.',"Filed another complaint against the rain. Status: pending since 2034.","If you spot Theo, remind him the coffee synth still needs a filter.","Today’s lucky number is 404. Let’s try not to vanish."],ud={operation:{badge:"OP",tone:"operation"},status:{badge:"ST",tone:"status"},interjection:{badge:"BC",tone:"broadcast"},player:{badge:"ME",tone:"player"},broadcast:{badge:"BC",tone:"broadcast"},battle:{badge:"BT",tone:"battle"},dialog:{badge:"DG",tone:"dialog"},stealth:{badge:"SF",tone:"stealth"}},fd={badge:"--",tone:"broadcast"},xs=({size:e=32,className:t})=>{const n=c.useId(),r=`${n}-bg`,s=`${n}-glow`;return i.jsxs("svg",{className:t,width:e,height:e,viewBox:"0 0 64 64",role:"img","aria-hidden":"true",focusable:"false",children:[i.jsxs("defs",{children:[i.jsxs("linearGradient",{id:r,x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[i.jsx("stop",{offset:"0%",stopColor:"#1e293b",stopOpacity:1}),i.jsx("stop",{offset:"100%",stopColor:"#0f172a",stopOpacity:1})]}),i.jsxs("linearGradient",{id:s,x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[i.jsx("stop",{offset:"0%",stopColor:"#38bdf8",stopOpacity:1}),i.jsx("stop",{offset:"100%",stopColor:"#0ea5e9",stopOpacity:1})]})]}),i.jsx("circle",{cx:"32",cy:"32",r:"32",fill:`url(#${r})`}),i.jsx("path",{d:"M32 16 L46 24 L32 32 L18 24 Z",fill:"#475569",opacity:"0.6"}),i.jsx("circle",{cx:"32",cy:"32",r:"10",fill:"none",stroke:`url(#${s})`,strokeWidth:"2.5"}),i.jsx("circle",{cx:"32",cy:"32",r:"6",fill:"none",stroke:`url(#${s})`,strokeWidth:"1.5"}),i.jsx("line",{x1:"32",y1:"22",x2:"32",y2:"26",stroke:"#38bdf8",strokeWidth:"2",strokeLinecap:"round"}),i.jsx("line",{x1:"32",y1:"38",x2:"32",y2:"42",stroke:"#38bdf8",strokeWidth:"2",strokeLinecap:"round"}),i.jsx("line",{x1:"22",y1:"32",x2:"26",y2:"32",stroke:"#38bdf8",strokeWidth:"2",strokeLinecap:"round"}),i.jsx("line",{x1:"38",y1:"32",x2:"42",y2:"32",stroke:"#38bdf8",strokeWidth:"2",strokeLinecap:"round"}),i.jsx("circle",{cx:"32",cy:"32",r:"2",fill:"#38bdf8"}),i.jsx("path",{d:"M8 8 L12 8 L12 12",fill:"none",stroke:"#0ea5e9",strokeWidth:"1.5",opacity:.4}),i.jsx("path",{d:"M56 8 L52 8 L52 12",fill:"none",stroke:"#0ea5e9",strokeWidth:"1.5",opacity:.4}),i.jsx("path",{d:"M8 56 L12 56 L12 52",fill:"none",stroke:"#0ea5e9",strokeWidth:"1.5",opacity:.4}),i.jsx("path",{d:"M56 56 L52 56 L52 52",fill:"none",stroke:"#0ea5e9",strokeWidth:"1.5",opacity:.4})]})},md=(e,t,n)=>{if(e.length===0)return[t.questNone];const s=e.slice(0,n).map(o=>{const l=o.objective.count&&o.objective.count>1?` (${o.objective.currentCount??0}/${o.objective.count})`:"";return`${o.questName}: ${o.objective.description}${l}`});return e.length>n&&s.push(t.questMore),s},pd=e=>{const t=e.replace(/\s+/g," ").trim();return t.length<=140?t:`${t.slice(0,137).trimEnd()}…`},gd=(e,t)=>{const n=e.trim(),r=n.length?n:"---",s=r.toLowerCase(),o=l=>l.some(a=>s.includes(a));return o(["attack","enemy","combat","battle","damage","hostile"])?{category:"battle",label:t.battle,text:r,timestamp:Date.now()}:o(["dialog","dialogue","whispers","says","conversation","briefing","speech"])?{category:"dialog",label:t.dialog,text:r,timestamp:Date.now()}:o(["stealth","hidden","sneak","shadow","camouflage","conceal"])?{category:"stealth",label:t.stealth,text:r,timestamp:Date.now()}:{category:"broadcast",label:t.broadcast,text:r,timestamp:Date.now()}},hd=()=>{const e=R(M=>M.settings.locale),t=c.useMemo(()=>We(e),[e]),n=c.useMemo(()=>t.george,[t]),{feedLabels:r,levelAdvance:s,missionComplete:o,promptPlaceholder:l,askPlaceholder:a,askInputLabel:d,sendLabel:f}=n,p=R(fr),u=R(De),g=R(Qc),b=R(Zc),C=R(Hc),y=R(Fc),A=R(M=>!!M.settings.reputationSystemsEnabled),T=R(M=>M.quests.quests),S=R(M=>M.world),z=R(Ol),B=R(M=>M.log.messages),Y=c.useMemo(()=>{var M;return(M=n.ambient)!=null&&M.length?n.ambient:dd},[n]),[L,Q]=c.useState([]),[F,le]=c.useState(""),ee=c.useRef(0),h=c.useRef(null),w=c.useRef(new Set),I=c.useRef(y),k=c.useRef({level:S.globalAlertLevel,inCombat:S.inCombat}),x=c.useRef(null),q=c.useRef(null),G=c.useRef(""),ie=c.useRef(B.length),V=c.useRef(null),Z=c.useRef(!1),ce=c.useRef([]),ue=c.useRef(null),me=c.useCallback(()=>{if(!ce.current.length){ue.current=null;return}const M=ce.current.shift();M&&Q(W=>{const ae=[...W,M];return ae.length>bs?ae.slice(ae.length-bs):ae}),ue.current=window.setTimeout(me,1e3)},[]),ye=c.useCallback(({category:M,label:W,text:ae,timestamp:oe})=>{const xe=oe??Date.now(),fe=ud[M]??fd,Se={id:`${xe}-${Math.random().toString(36).slice(2)}`,category:M,text:pd(ae),label:W,timestamp:xe,badge:fe.badge,tone:fe.tone};ce.current=[...ce.current,Se],ue.current===null&&me()},[me]),pe=c.useCallback(M=>{ye(M)},[ye]),be=c.useCallback(M=>{ee.current=Date.now()+ld,h.current=null,pe({category:"interjection",label:n.feedLabels.interjection,text:M.text,timestamp:Date.now()})},[n.feedLabels.interjection,pe]),D=c.useCallback(M=>{const W=td(M,C.alignment);if(!W)return;if(Date.now()>=ee.current){be(W);return}h.current=W},[C.alignment,be]),ge=c.useCallback(()=>Y.length&&Math.random()<.5?{text:Y[Math.floor(Math.random()*Y.length)],guidelineRef:"ambient.line"}:ed(C.alignment),[Y,C.alignment]),j=c.useCallback(M=>{le(M.target.value)},[]),He=c.useCallback(M=>{var xe,fe;M&&M.preventDefault();const W=F.trim();if(!W){(xe=V.current)==null||xe.focus();return}ye({category:"player",label:r.player,text:W,timestamp:Date.now()}),le(""),(fe=V.current)==null||fe.focus();const ae=ge(),oe=l(ae.text);ye({category:"interjection",label:r.interjection,text:oe,timestamp:Date.now()})},[ye,r.interjection,r.player,ge,l,F]),Pe=c.useCallback(()=>{x.current!==null&&window.clearTimeout(x.current);const M=Math.floor(ys+Math.random()*(cd-ys));x.current=window.setTimeout(()=>{const W=ge();Date.now()>=ee.current?be(W):h.current=W,Pe()},M)},[ge,be]);c.useEffect(()=>{const M=window.setInterval(()=>{const W=h.current;W&&Date.now()>=ee.current&&be(W)},400);return()=>window.clearInterval(M)},[be]),c.useEffect(()=>(Pe(),()=>{x.current!==null&&(window.clearTimeout(x.current),x.current=null),ue.current!==null&&(window.clearTimeout(ue.current),ue.current=null),ce.current=[]}),[Pe]),c.useEffect(()=>{if(B.length<=ie.current){ie.current=B.length;return}B.slice(ie.current).forEach(W=>{const ae=gd(W,{battle:r.battle,dialog:r.dialog,stealth:r.stealth,broadcast:r.broadcast});pe(ae)}),ie.current=B.length},[r.battle,r.broadcast,r.dialog,r.stealth,B,pe]),c.useEffect(()=>{const M=(u==null?void 0:u.name)??n.zoneFallback,W=[];if(u){if(u.allPrimaryComplete)W.push(n.guidancePrimaryComplete(M));else if(g){const fe=g.totalQuests>1?n.guidanceProgress(g.completedQuests??0,g.totalQuests):"";W.push(n.guidancePrimaryObjective(g.label,fe))}b&&W.push(n.guidanceSideObjective(b.label))}const ae=md(p,n,3),oe=[n.guidanceIntro];W.length>0&&oe.push(...W),ae.length>0&&(W.length>0&&oe.push(""),oe.push(...ae));const xe=oe.join(`
`).trim();!xe||G.current===xe||(G.current=xe,pe({category:"operation",label:r.operation,text:xe,timestamp:Date.now()}))},[r.operation,n,u,g,b,p,pe]);const nt=c.useCallback(M=>{if(!M)return"";try{return new Intl.DateTimeFormat(e,{hour:"2-digit",minute:"2-digit"}).format(new Date(M))}catch{return new Date(M).toLocaleTimeString()}},[e]),Xe=c.useCallback(M=>{var xe;const W=n.ambientFeed,ae=C.alignment,oe=fe=>({category:"broadcast",text:fe,label:r.broadcast,timestamp:M.timestamp});switch(M.category){case"rumor":{const fe=((xe=M.lines.find(Ie=>Ie&&Ie.trim().length>0))==null?void 0:xe.trim())??W.fallbacks.rumor,Se=M.storyFunction?W.storyFunctionLabels[M.storyFunction]??M.storyFunction.replace(/-/g," ").toUpperCase():void 0;return oe(W.formatRumor({line:fe,storyLabel:Se},ae))}case"signage":{const fe=M.text&&M.text.trim().length>0?M.text.trim():W.fallbacks.signage,Se=M.storyFunction?W.storyFunctionLabels[M.storyFunction]??M.storyFunction.replace(/-/g," ").toUpperCase():void 0;return oe(W.formatSignage({text:fe,storyLabel:Se},ae))}case"weather":{const fe=M.description&&M.description.trim().length>0?M.description.trim():W.fallbacks.weather,Se=M.storyFunction?W.storyFunctionLabels[M.storyFunction]??M.storyFunction.replace(/-/g," ").toUpperCase():void 0;return oe(W.formatWeather({description:fe,storyLabel:Se},ae))}case"zoneDanger":{const fe=t.levelIndicator.dangerLevels,Se=M.dangerRating?fe[M.dangerRating]??M.dangerRating:W.dangerFallback,Ie=M.previousDangerRating?fe[M.previousDangerRating]??M.previousDangerRating:null,ut=M.changedFlags.map(_e=>({label:W.flagLabels[_e.key]??_e.key,previous:W.formatFlagValue(_e.key,_e.previous),next:W.formatFlagValue(_e.key,_e.next)}));return oe(W.formatZoneDanger({zoneName:M.zoneName,dangerLabel:Se,previousDangerLabel:Ie,flagChanges:ut},ae))}case"hazardChange":{const fe=M.added.map(Ie=>Ie.trim()).filter(Ie=>Ie.length>0),Se=M.removed.map(Ie=>Ie.trim()).filter(Ie=>Ie.length>0);return oe(W.formatHazards({zoneName:M.zoneName,additions:fe,removals:Se},ae))}case"zoneBrief":{const fe=t.levelIndicator.dangerLevels,Se=M.dangerRating?fe[M.dangerRating]??M.dangerRating:W.dangerFallback;return oe(W.formatZoneBrief({zoneName:M.zoneName,summary:M.summary??null,dangerLabel:Se,hazards:M.hazards,directives:M.directives},ae))}default:return null}},[r.broadcast,n.ambientFeed,C.alignment,t.levelIndicator.dangerLevels]);c.useEffect(()=>{const M=ae=>{const oe=ae.detail;if(!oe)return;const xe=o(oe.name);pe({category:"operation",label:r.operation,text:xe,timestamp:Date.now()}),D("questCompleted")},W=ae=>{const oe=ae.detail;if(!oe)return;const xe=oe.nextLevelId??`level ${oe.nextLevel}`,fe=s(xe);pe({category:"operation",label:r.operation,text:fe,timestamp:Date.now()})};return window.addEventListener(Jn,M),window.addEventListener(er,W),()=>{window.removeEventListener(Jn,M),window.removeEventListener(er,W)}},[r.operation,s,o,pe,D]),c.useEffect(()=>{const M=new Set(T.filter(oe=>oe.isCompleted).map(oe=>oe.id)),W=w.current;Array.from(M).filter(oe=>!W.has(oe)).length>0&&D("questCompleted"),w.current=M},[T,D]),c.useEffect(()=>{if(!z)return;if(!q.current){const ae=new id;ae.prime(z),q.current=ae;const oe={category:"zoneBrief",timestamp:Date.now(),zoneName:z.zone.zoneName,summary:z.zone.summary,dangerRating:z.zone.dangerRating??null,hazards:[...z.zone.hazards],directives:[...z.zone.directives]},xe=Xe(oe);xe&&pe(xe);return}const W=q.current.collect(z);W.length&&W.forEach(ae=>{const oe=Xe(ae);oe&&pe(oe)})},[z,Xe,pe]),c.useEffect(()=>{const M=I.current,W=y;if(!A){I.current=W;return}const ae=new Set([...Object.keys(W),...Object.keys(M)]),oe=Array.from(ae).some(fe=>{const Se=W[fe]??0,Ie=M[fe]??0;return Se-Ie>=20}),xe=Array.from(ae).some(fe=>{const Se=W[fe]??0,Ie=M[fe]??0;return Se-Ie<=-20});oe?D("reputationPositive"):xe&&D("reputationNegative"),I.current=W},[y,D,A]),c.useEffect(()=>{const M=k.current;(!M.inCombat&&S.inCombat||M.level!=="alarmed"&&S.globalAlertLevel==="alarmed")&&D("hostileEntered"),k.current={level:S.globalAlertLevel,inCombat:S.inCombat}},[D,S.globalAlertLevel,S.inCombat]);const It=c.useRef(null),kt=c.useCallback(M=>{var W;M.preventDefault(),(W=V.current)==null||W.focus()},[]),Et=c.useCallback(()=>{Z.current=!0},[]),Ge=c.useCallback(()=>{Z.current=!1},[]);c.useEffect(()=>{var W;const M=It.current;M&&(M.scrollTo({top:M.scrollHeight,behavior:"smooth"}),Z.current&&((W=V.current)==null||W.focus()))},[L]);const Qe={id:"george-placeholder",category:"status",text:n.logEmpty,label:r.broadcast,timestamp:0,badge:"NB",tone:"broadcast"},ct=L.length>0?L:[Qe],Wt=L.length>0,dt=ct.length-1,Oe=F.trim().length===0;return i.jsxs("div",{className:"george-inline","data-controller-focus-ignore":"true",children:[i.jsx("div",{className:"george-chat",role:"log","aria-live":"polite",ref:It,children:ct.map((M,W)=>{const ae=Wt&&W===dt,oe=M.timestamp?nt(M.timestamp):"";return i.jsxs("div",{className:"george-chat-entry",children:[i.jsx("div",{className:"george-chat-avatar","aria-hidden":"true",children:i.jsx(xs,{size:32})}),i.jsxs("div",{className:`george-chat-bubble george-chat-bubble--${M.tone}${ae?" george-chat-bubble--latest":""}`,children:[i.jsxs("div",{className:"george-chat-bubble__header",children:[i.jsxs("div",{className:"george-chat-bubble__title",children:[i.jsx("span",{className:`george-chat-badge george-chat-badge--${M.tone}`,"aria-hidden":"true",children:M.badge}),i.jsx("span",{className:"george-chat-bubble__label",children:M.label})]}),oe?i.jsx("span",{className:"george-chat-bubble__time",children:oe}):null]}),i.jsx("p",{className:"george-chat-bubble__text",children:M.text})]})]},M.id)})}),i.jsxs("form",{className:"george-input-row",onSubmit:He,children:[i.jsx(xs,{size:36}),i.jsx("div",{className:"george-input",children:i.jsx("input",{id:"george-prompt-input",className:"george-input__field",type:"text",placeholder:a,"aria-label":d,value:F,onChange:j,autoComplete:"off",ref:V,onFocus:Et,onBlur:Ge})}),i.jsx("button",{type:"submit",className:"george-send-button","data-disabled":Oe,"aria-label":f,onMouseDown:kt,children:i.jsx("span",{className:"george-send-icon","aria-hidden":"true",children:"↗"})})]})]})},gn=["warmth","melancholy","sarcasm","surrealism","urgency","steadiness","wit"],yd={author:.4,persona:.4,scene:.2},Ke={sentenceLengthMean:14,sentenceLengthStdDev:4,metaphorRate:.35,fragmentPreference:.2,motifDensity:.25},ws=gn.reduce((e,t)=>(e[t]=.5,e),{});gn.reduce((e,t)=>(e[t]={type:"number",minimum:0,maximum:1},e),{});const zn=e=>e.rhetoric?{sentenceLengthMean:e.rhetoric.sentenceLengthMean??Ke.sentenceLengthMean,sentenceLengthStdDev:e.rhetoric.sentenceLengthStdDev??Ke.sentenceLengthStdDev,metaphorRate:e.rhetoric.metaphorRate??Ke.metaphorRate,fragmentPreference:e.rhetoric.fragmentPreference??Ke.fragmentPreference,motifDensity:e.rhetoric.motifDensity??Ke.motifDensity}:{...Ke},bd=e=>{let t=1779033703,n=3144134277,r=1013904242,s=2773480762;for(let o=0;o<e.length;o+=1){const l=e.charCodeAt(o);t=Math.imul(t^l,597399067),n=Math.imul(n^l,2869860233),r=Math.imul(r^l,951274213),s=Math.imul(s^l,2716044179)}return t=Math.imul(t^t>>>18,597399067),n=Math.imul(n^n>>>22,2869860233),r=Math.imul(r^r>>>17,951274213),s=Math.imul(s^s>>>19,2716044179),[t^n^r^s,n^t,r^t,s^t]},xd=e=>()=>{let t=e+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296},Ft=e=>{const t=typeof e=="number"?e.toString(36):e,n=bd(t),r=xd(n[0]),s=()=>r(),o=a=>a<=0?0:Math.floor(s()*a);return{next:s,nextInt:o,pick:a=>{if(a.length===0)throw new Error("Cannot pick from an empty list.");return a[o(a.length)]}}},Ot=(e,t,n)=>Math.min(Math.max(e,t),n),wd=(e,t)=>{const n={...yd,...e};if(!t){const s=n.author+n.persona;return s===0?{author:.5,persona:.5,scene:0}:{author:n.author/s,persona:n.persona/s,scene:0}}const r=n.author+n.persona+n.scene;return r===0?{author:.4,persona:.4,scene:.2}:{author:n.author/r,persona:n.persona/r,scene:n.scene/r}},Fn=e=>e?gn.reduce((t,n)=>{var s;const r=(s=e.traits)==null?void 0:s[n];return typeof r=="number"&&!Number.isNaN(r)?t[n]=Ot(r,0,1):t[n]=ws[n],t},{}):{...ws},vd=(e,t,n,r)=>gn.reduce((s,o)=>{const l=t[o]??.5,a=n[o]??.5,d=r?r[o]??.5:.5,f=l*e.author+a*e.persona+d*e.scene;return s[o]=Ot(f,0,1),s},{}),Sd=(e,t,n,r)=>{const s=zn(t),o=zn(n),l=r?zn(r):Ke;return{sentenceLengthMean:s.sentenceLengthMean*e.author+o.sentenceLengthMean*e.persona+l.sentenceLengthMean*e.scene,sentenceLengthStdDev:s.sentenceLengthStdDev*e.author+o.sentenceLengthStdDev*e.persona+l.sentenceLengthStdDev*e.scene,metaphorRate:s.metaphorRate*e.author+o.metaphorRate*e.persona+l.metaphorRate*e.scene,fragmentPreference:s.fragmentPreference*e.author+o.fragmentPreference*e.persona+l.fragmentPreference*e.scene,motifDensity:s.motifDensity*e.author+o.motifDensity*e.persona+l.motifDensity*e.scene}},Id=(e,t)=>{const n=[],r=Ke.sentenceLengthMean+e.melancholy*4-e.urgency*5+e.surrealism*3+e.wit*1-e.sarcasm*1,s=Ot((t.sentenceLengthMean+r)/2,6,28);Math.abs(s-t.sentenceLengthMean)>.01&&(n.push({trait:"urgency",from:t.sentenceLengthMean,to:s}),t.sentenceLengthMean=s);const o=.15+e.sarcasm*.25+e.urgency*.3-e.steadiness*.2,l=Ot((t.fragmentPreference+o)/2,0,.85);Math.abs(l-t.fragmentPreference)>.01&&(n.push({trait:"sarcasm",from:t.fragmentPreference,to:l}),t.fragmentPreference=l);const a=Ke.metaphorRate+e.surrealism*.4+e.melancholy*.2-e.urgency*.25,d=Ot((t.metaphorRate+a)/2,0,.9);return Math.abs(d-t.metaphorRate)>.01&&(n.push({trait:"surrealism",from:t.metaphorRate,to:d}),t.metaphorRate=d),n},kd=e=>Object.entries(e).reduce((t,[n,r])=>{const s=Math.max(0,r-1);return s>0&&(t[n]=s),t},{}),Ed=(e,t,n)=>{switch(e.type){case"requiresTrait":return!e.trait||typeof e.threshold!="number"?!0:t[e.trait]>=e.threshold;case"forbidsTrait":return!e.trait||typeof e.threshold!="number"?!0:t[e.trait]<=e.threshold;case"maxSentenceLength":return!0;case"requiresMotif":return e.motifId?(n[e.motifId]??0)>0:!0;default:return!0}},Td=(e,t,n)=>e.requiredTraits&&Object.entries(e.requiredTraits).some(([s,o])=>t[s]<o)||e.forbiddenTraits&&Object.entries(e.forbiddenTraits).some(([s,o])=>t[s]>o)?!1:e.constraints?e.constraints.every(r=>Ed(r,t,n)):!0,Cd=(e,t,n,r)=>{var o,l;let s=1;if(e.traitWeightBoost)for(const[a,d]of Object.entries(e.traitWeightBoost))s+=(t[a]??.5)*d;return(o=n.templateBias)!=null&&o.includes(e.id)&&(s+=.75),(l=r.templateBias)!=null&&l.includes(e.id)&&(s+=.75),Math.max(s,.1)},Md=(e,t,n,r)=>{var f,p;if(e.requestedTemplateId){const u=t.templates.find(g=>g.id===e.requestedTemplateId);if(u)return u}const s=t.templates.filter(u=>Td(u,n,r));if(s.length===0){const u=((f=e.persona.fallbackTemplates)==null?void 0:f[0])??((p=e.author.fallbackTemplates)==null?void 0:p[0]),g=u?t.templates.find(b=>b.id===u):void 0;if(g)return g;if(t.templates.length===0)throw new Error("No dialogue tone templates defined.");return t.templates[0]}const o=Ft(`${e.seed??"tone"}::template`),l=s.map(u=>({template:u,weight:Cd(u,n,e.author,e.persona)})),a=l.reduce((u,g)=>u+g.weight,0);let d=o.next()*a;for(const u of l){if(d<=u.weight)return u.template;d-=u.weight}return l[l.length-1].template},Ad=(e,t)=>{const n=e.palettes.find(r=>r.id===t);if(!n)throw new Error(`Missing palette ${t} referenced by tone template.`);return n},Rd=(e,t)=>{var n;return(n=e.lexiconOverrides)==null?void 0:n[t]},Pd=(e,t,n,r)=>{var o;let s=e.weight;if(e.traitInfluence)for(const[l,a]of Object.entries(e.traitInfluence))s+=(t[l]??.5)*a;if(e.motifId){const l=r[e.motifId]??0;s-=l*.35,(o=n.motifBias)!=null&&o.includes(e.motifId)&&(s+=.5)}return Math.max(s,0)},Dd=(e,t,n,r,s,o,l)=>{var C;const a=Rd(r.persona,t);if(a&&a.length>0){const y=Ft(`${l}::override::${t}`),A=a[y.nextInt(a.length)];return{paletteId:e,entryId:"override",text:A}}const d=Ad(s,e),f=Ft(`${l}::palette::${e}`),p=d.entries.map(y=>({entry:y,weight:Pd(y,n,r.persona,o)})),u=p.reduce((y,A)=>y+A.weight,0);if(u<=0){const y=d.defaultText??((C=d.entries[0])==null?void 0:C.text);if(!y)throw new Error(`Palette ${e} has no viable entries.`);return{paletteId:e,entryId:"fallback",text:y}}let g=f.next()*u;for(const{entry:y,weight:A}of p){if(g<=A)return{paletteId:e,entryId:y.id,text:y.text};g-=A}const b=p[p.length-1].entry;return{paletteId:e,entryId:b.id,text:b.text}},_d=(e,t)=>e.template.replace(/\{\{(.*?)\}\}/g,(n,r)=>{var l;const s=r.trim(),o=t[s];return o?o.text:((l=e.slots.find(a=>a.id===s))==null?void 0:l.fallback)??""}),Ld=(e,t)=>{var A;const n=wd(e.weights,!!e.scene),r=Fn(e.author),s=Fn(e.persona),o=e.scene?Fn(e.scene):void 0,l=vd(n,r,s,o),a=Sd(n,e.author,e.persona,e.scene),d=Id(l,a),f=kd(e.motifState??{}),p=Md(e,t,l,f);!p.supportsFragments&&a.fragmentPreference>.55&&(d.push({trait:"steadiness",from:a.fragmentPreference,to:.45}),a.fragmentPreference=.45),p.maxSentenceLength&&a.sentenceLengthMean>p.maxSentenceLength&&(d.push({trait:"steadiness",from:a.sentenceLengthMean,to:p.maxSentenceLength}),a.sentenceLengthMean=p.maxSentenceLength);const u={...f},g=p.slots.reduce((T,S)=>{var L;const z=Dd(S.paletteId,S.id,l,e,t,u,e.seed??"tone");T[S.id]=z;const B=(L=t.palettes.find(Q=>Q.id===S.paletteId))==null?void 0:L.entries.find(Q=>Q.id===z.entryId),Y=B==null?void 0:B.motifId;return Y&&(u[Y]=(u[Y]??0)+2),T},{}),b=_d(p,g),C=e.motifState??{},y={templateId:p.id,text:b,slots:g,motifsApplied:Object.keys(u).filter(T=>(u[T]??0)>(C[T]??0))};return{traits:l,rhetoric:a,weights:n,clampLog:d,render:y,motifState:u,seed:e.seed??"tone",metadata:{authorId:e.author.id,personaId:e.persona.id,sceneId:(A=e.scene)==null?void 0:A.id,templateId:p.id}}},tr={id:"author.vonnegut_brautigan_core",label:"Vonnegut-Brautigan Core Voice",influences:["plot.tone.guideline.1","plot.tone.guideline.2","plot.tone.guideline.7"],traits:{wit:.75,melancholy:.6,surrealism:.68,sarcasm:.55,warmth:.52,urgency:.48,steadiness:.5},rhetoric:{sentenceLengthMean:18,sentenceLengthStdDev:5,metaphorRate:.48,fragmentPreference:.22},templateBias:["template.deadpan.reassure","template.surreal.resilience"],fallbackTemplates:["template.deadpan.reassure"]},vs={id:"author.propaganda_glitch",label:"Glitched Broadcast Satire",influences:["plot.tone.guideline.4","plot.tone.guideline.2"],traits:{wit:.55,melancholy:.35,surrealism:.5,sarcasm:.7,warmth:.32,urgency:.6,steadiness:.44},rhetoric:{sentenceLengthMean:14,sentenceLengthStdDev:3,metaphorRate:.28,fragmentPreference:.32},templateBias:["template.urgent.push"],fallbackTemplates:["template.urgent.push"]},nr={[tr.id]:tr,[vs.id]:vs},Fi=tr.id,Bi=e=>nr[e]??nr[Fi],rr={id:"persona.trace",label:"Trace (Player)",personaTags:["player","resistance"],traits:{wit:.65,warmth:.54,urgency:.62,steadiness:.4,sarcasm:.58,melancholy:.47,surrealism:.44},rhetoric:{sentenceLengthMean:14,sentenceLengthStdDev:4,fragmentPreference:.28},motifBias:["motif.streetlight","motif.rain_hum"],templateBias:["template.urgent.push","template.deadpan.reassure"],lexiconOverrides:{directive:["Keep moving like the cameras forgot you.","Drift along the blackout fringe—quiet shoes, loud mission."]}},Ss={id:"persona.amara_velez",label:"Amara Velez",personaTags:["mentor","resistance"],traits:{wit:.52,warmth:.66,urgency:.48,steadiness:.68,sarcasm:.38,melancholy:.55,surrealism:.42},rhetoric:{sentenceLengthMean:17,sentenceLengthStdDev:3,fragmentPreference:.18},motifBias:["motif.compass","motif.streetlight"],templateBias:["template.deadpan.reassure","template.surreal.resilience"],lexiconOverrides:{comfort:["Breathe—we’ve lived through harsher tides.","You held the line; I’ll hold the fallout."]}},Is={id:"persona.theo_anders",label:"Theo Anders",personaTags:["hacker","ally"],traits:{wit:.7,warmth:.5,urgency:.57,steadiness:.38,sarcasm:.64,melancholy:.42,surrealism:.58},rhetoric:{sentenceLengthMean:13,sentenceLengthStdDev:5,fragmentPreference:.36},motifBias:["motif.glowsticks","motif.rain_hum"],templateBias:["template.urgent.push"],lexiconOverrides:{opener:["Signal’s noisy but alive.","Console’s humming like a nervous choir."]}},ks={id:"persona.sadiq_rahm",label:"Sadiq Rahm",personaTags:["strategist","ally"],traits:{wit:.48,warmth:.4,urgency:.52,steadiness:.6,sarcasm:.46,melancholy:.58,surrealism:.36},rhetoric:{sentenceLengthMean:16,sentenceLengthStdDev:3,fragmentPreference:.22},motifBias:["motif.compass"],templateBias:["template.deadpan.reassure"],lexiconOverrides:{promise:["We bank this win, re-draw the map, hit harder tomorrow.","Blueprints shift in our favour; we keep walking."]}},sr={[rr.id]:rr,[Ss.id]:Ss,[Is.id]:Is,[ks.id]:ks},$i=rr.id,Wi=e=>sr[e]??sr[$i],Es={id:"scene.share_scarce_food",label:"Share Scarce Food",intent:"break bread after a risky supply run",traits:{warmth:.72,melancholy:.58,wit:.46,surrealism:.42,sarcasm:.3,urgency:.28,steadiness:.64},rhetoric:{sentenceLengthMean:17,metaphorRate:.38}},Ts={id:"scene.post_ambush_reassurance",label:"Post-Ambush Reassurance",intent:"steady the squad after scraping through an ambush",traits:{warmth:.62,melancholy:.55,wit:.4,surrealism:.37,sarcasm:.34,urgency:.46,steadiness:.68},rhetoric:{sentenceLengthMean:16,fragmentPreference:.2}},Cs={id:"scene.pre_heist_briefing",label:"Pre-Heist Briefing",intent:"sharpen focus during mission prep",traits:{warmth:.38,melancholy:.32,wit:.5,surrealism:.28,sarcasm:.52,urgency:.72,steadiness:.58},rhetoric:{sentenceLengthMean:14,fragmentPreference:.26}},Ms={id:"scene.radio_counter_speech",label:"Counter-Broadcast Speech",intent:"mock the regime broadcast while rallying allies",traits:{warmth:.44,melancholy:.36,wit:.68,surrealism:.5,sarcasm:.74,urgency:.6,steadiness:.46},rhetoric:{sentenceLengthMean:15,sentenceLengthStdDev:4,fragmentPreference:.34}},Hi={[Es.id]:Es,[Ts.id]:Ts,[Cs.id]:Cs,[Ms.id]:Ms},jd=e=>Hi[e],Nd=[{id:"template.deadpan.reassure",label:"Deadpan Reassurance",template:"{{opener}} {{comfort}} {{promise}}",supportsFragments:!1,maxSentenceLength:22,requiredTraits:{warmth:.4,steadiness:.45},traitWeightBoost:{warmth:.6,steadiness:.3,wit:.2},slots:[{id:"opener",paletteId:"palette.opener.deadpan"},{id:"comfort",paletteId:"palette.comfort.solidarity"},{id:"promise",paletteId:"palette.promise.grit"}]},{id:"template.urgent.push",label:"Urgent Push",template:"{{urgent_intro}} {{directive}}",supportsFragments:!0,maxSentenceLength:18,requiredTraits:{urgency:.55},forbiddenTraits:{warmth:.85},traitWeightBoost:{urgency:.8,wit:.2,sarcasm:.3},slots:[{id:"urgent_intro",paletteId:"palette.urgent.intro",allowFragments:!0},{id:"directive",paletteId:"palette.directive.push",allowFragments:!0}]},{id:"template.surreal.resilience",label:"Surreal Resilience",template:"{{opener}} {{surreal_image}} {{resolution}}",supportsFragments:!1,maxSentenceLength:24,requiredTraits:{surrealism:.45},traitWeightBoost:{surrealism:.9,melancholy:.4,wit:.25},slots:[{id:"opener",paletteId:"palette.opener.deadpan"},{id:"surreal_image",paletteId:"palette.surreal.image"},{id:"resolution",paletteId:"palette.resolution.resilience"}]}],Od=[{id:"palette.opener.deadpan",slotId:"opener",defaultText:"Streetlight holds.",entries:[{id:"opener.streetlight",text:"Streetlight holds.",weight:1,traitInfluence:{steadiness:.4,warmth:.2},motifId:"motif.streetlight"},{id:"opener.ashtray",text:"Ashtray smoke braids the curfew alarm.",weight:.8,traitInfluence:{melancholy:.3,surrealism:.4},motifId:"motif.rain_hum"},{id:"opener.static",text:"Static licks the PA like a bored coyote.",weight:.9,traitInfluence:{wit:.3,sarcasm:.35}}]},{id:"palette.comfort.solidarity",slotId:"comfort",defaultText:"We bend so we do not break.",entries:[{id:"comfort.breathe",text:"Breathe; the city hums but our pulse sets tempo.",weight:1,traitInfluence:{warmth:.35,steadiness:.35}},{id:"comfort.hum",text:"We hum louder than their drones tonight.",weight:.9,traitInfluence:{wit:.25,urgency:.2},motifId:"motif.rain_hum"},{id:"comfort.coffee",text:"Ration coffee still tastes like defiance.",weight:.8,traitInfluence:{wit:.3,warmth:.3}}]},{id:"palette.promise.grit",slotId:"promise",defaultText:"We bank this and push the next door.",entries:[{id:"promise.grid",text:"Map updates in our favour; we move before dawn.",weight:1,traitInfluence:{urgency:.35,steadiness:.4},motifId:"motif.compass"},{id:"promise.neon",text:"Neon farms glow for us tonight if we choose.",weight:.85,traitInfluence:{surrealism:.4,warmth:.25}},{id:"promise.ledger",text:"Ledger tilts our way; we cash it in soon.",weight:.9,traitInfluence:{wit:.2,melancholy:.2}}]},{id:"palette.urgent.intro",slotId:"urgent_intro",defaultText:"Sirens kick a four count.",entries:[{id:"urgent.metro",text:"Metro lights stutter; sweepers reroute.",weight:1,traitInfluence:{urgency:.45,surrealism:.25},motifId:"motif.glowsticks"},{id:"urgent.chopper",text:"Chopper rotors chew the humidity early.",weight:.9,traitInfluence:{urgency:.4,sarcasm:.3}},{id:"urgent.clocks",text:"Every stolen clock ticks loud right now.",weight:.85,traitInfluence:{melancholy:.25,wit:.3}}]},{id:"palette.directive.push",slotId:"directive",defaultText:"Push past the surveillance bloom.",entries:[{id:"directive.sprint",text:"Sprint the blackout seam before it seals.",weight:1,traitInfluence:{urgency:.5,wit:.2}},{id:"directive.slide",text:"Slide between floodlights like you rehearsed it.",weight:.9,traitInfluence:{steadiness:.2,wit:.35},motifId:"motif.glowsticks"},{id:"directive.smile",text:"Smile like the scanners owe you rent.",weight:.75,traitInfluence:{sarcasm:.45}}]},{id:"palette.surreal.image",slotId:"surreal_image",defaultText:"Drones drift like bored gulls.",entries:[{id:"surreal.malls",text:"Flooded malls grow neon algae halos.",weight:1,traitInfluence:{surrealism:.55,melancholy:.25},motifId:"motif.rain_hum"},{id:"surreal.balloons",text:"Propaganda balloons sag like tired saints.",weight:.9,traitInfluence:{sarcasm:.3,wit:.25}},{id:"surreal.kites",text:"Kids fly hacked drones like paper kites.",weight:.85,traitInfluence:{warmth:.3,wit:.3}}]},{id:"palette.resolution.resilience",slotId:"resolution",defaultText:"We walk out together and louder.",entries:[{id:"resolution.compass",text:"Compass north re-centers on us tonight.",weight:1,traitInfluence:{steadiness:.45,warmth:.3},motifId:"motif.compass"},{id:"resolution.lunch",text:"Save me a ration bar; we earned dessert.",weight:.8,traitInfluence:{wit:.35,warmth:.25}},{id:"resolution.rain",text:"Let the rain mask our getaway beats.",weight:.85,traitInfluence:{melancholy:.3,surrealism:.3},motifId:"motif.rain_hum"}]}],zd=()=>({authors:nr,personas:sr,scenes:Hi,templates:Nd,palettes:Od,motifDefaults:{"motif.streetlight":0,"motif.rain_hum":0,"motif.compass":0,"motif.glowsticks":0}}),Fd=()=>Bi(Fi),Bd=()=>Wi($i),$d=e=>jd(e),Wd=(e,t)=>e?t?{...e,...t}:e:t,Hd=(e,t,n,r,s)=>`${e}::persona:${t}::author:${n}::scene:${r??"none"}::template:${s??"any"}`,Gd=(e,t)=>e?{...e}:t.motifDefaults?{...t.motifDefaults}:{},Ud=(e,t,n,r)=>{const s=(n==null?void 0:n.seedKey)??r??"default";return`${e.id}:${t.id}:${s}`},Vd=(e,t)=>{var n;if(t!=null&&t.personaId)return t.personaId;if((n=e.toneDefaults)!=null&&n.personaId)return e.toneDefaults.personaId};class Yd{constructor(){Ae(this,"library");Ae(this,"motifStates");Ae(this,"cache");Ae(this,"defaultAuthor",Fd());Ae(this,"defaultPersona",Bd());Ae(this,"resolvePersona",t=>t?Wi(t):this.defaultPersona);Ae(this,"resolveShouldGenerate",t=>(t==null?void 0:t.useGenerated)!==!1);Ae(this,"reset",()=>{this.cache.clear(),this.motifStates.clear()});Ae(this,"resetDialogue",t=>{for(const n of this.cache.keys())n.startsWith(`${t}:`)&&this.cache.delete(n)});Ae(this,"resolveLine",t=>{const{dialogue:n,node:r,fallbackText:s,seedOverride:o}=t,l=Wd(n.toneDefaults,r.tone);if(!l||!this.resolveShouldGenerate(l))return{text:s,source:"fallback"};const a=l.authorId?Bi(l.authorId):this.defaultAuthor,d=this.resolvePersona(Vd(n,l)),f=l.sceneId?$d(l.sceneId):void 0,p=Ud(n,r,l,o),u=Hd(p,d.id,a.id,f==null?void 0:f.id,l.templateId),g=this.cache.get(u);if(g)return{text:g.render.text,source:"generated",metadata:g};const b=Gd(this.motifStates.get(d.id),this.library),C=Ld({author:a,persona:d,scene:f,requestedTemplateId:l.templateId,seed:p,motifState:b},this.library);return this.cache.set(u,C),this.motifStates.set(d.id,C.motifState),{text:C.render.text,source:"generated",metadata:C}});this.library=zd(),this.motifStates=new Map,this.cache=new Map}}const Kd=new Yd,qd=(e,t)=>{try{const n=Zo(e);return t==="charisma"?n.dialogueThresholdBonus:0}catch(n){console.warn("[DialogueSystem] Falling back to base stats for dialogue bonus.",n);const r=Jo(e.skills);return t==="charisma"?r.dialogueThresholdBonus:0}},Xd=(e,t)=>{if(!t.skillCheck)return!0;const{skill:n,threshold:r,domain:s}=t.skillCheck;if((s??"attribute")==="skill"){const f=n;return(e.skillTraining[f]??0)>=r}const l=n,a=e.skills[l],d=qd(e,l);return Qo(a,r,d)},Bn={blackout:["blackout","brownout"],smog:["smog","toxic","fumes"],surveillance:["surveillance","camera","drone"]},As=["ration bricks","filtered water packs","reactive dampeners","silenced carbines","patch kits"],Rs=["battery bricks","jury-rigged lanterns","hand-crank dynamos"],Ps=["homemade filters","charcoal respirators","sealed goggles"],Ds=["signal scrubbers","anti-drone flares","masking foil"],_s=["Keep your head down; CorpSec doubled patrol rotations.","George whispered about a convoy slipping through the south gate tonight.","If you see a checkpoint scanner, go around—no one’s calibrating them right now.","Word is the resistance safehouse stashed contraband in the hollow neon signs."],Qd=[{id:"merchant.default_greeting.resistanceFriend",roleId:"merchant",templateKey:"default_greeting",summary:"Warm greeting for resistance-aligned players during regular hours.",content:"Signal's clean for you. {{highlightItem}} just landed—priced for family. {{rumorHook}}",fallbackContent:"Welcome back. Supplies are stocked.",gating:{faction:[{factionId:"resistance",minimumReputation:25}],forbiddenTimesOfDay:["night"]},tokens:[{id:"highlightItem",fallback:"Ration bricks",resolve:(e,t)=>{const n=e.world.hazards.join(" ").toLowerCase();return Bn.blackout.some(r=>n.includes(r))?t.pickOne(Rs,Rs[0]):Bn.smog.some(r=>n.includes(r))?t.pickOne(Ps,Ps[0]):Bn.surveillance.some(r=>n.includes(r))?t.pickOne(Ds,Ds[0]):t.pickOne(As,As[0])}},{id:"rumorHook",fallback:"Stay nimble out there.",resolve:(e,t)=>t.pickOne(_s,_s[0])}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.amara_velez",useGenerated:!0},weight:3},{id:"merchant.default_greeting.curfewUrgent",roleId:"merchant",templateKey:"default_greeting",summary:"Curt greeting while curfew is active.",content:"Curfew sirens already spun up. {{highlightItem}} on the counter—take it and bolt.",fallbackContent:"Curfew's live. Make it quick.",gating:{requireCurfewActive:!0},tokens:[{id:"highlightItem",fallback:"Emergency stim kit",resolve:(e,t)=>e.player.perks.includes("quickDraw")?"reflex chems—your speed deserves it":e.player.perks.includes("toughness")?"impact gel armor—fits right onto your plates":t.pickOne(["emergency stim kit","flashburst grenade","thermal cloak"],"emergency stim kit")}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"merchant.default_greeting.corpsecWatcher",roleId:"merchant",templateKey:"default_greeting",summary:"Wary exchange when player reputation is low with CorpSec.",content:"CorpSec sniffers are wired to sniffing you. Credits up front, {{highlightItem}} after.",fallbackContent:"No trust, no chatter—show credits.",gating:{faction:[{factionId:"corpsec",maximumReputation:-10}]},tokens:[{id:"highlightItem",fallback:"scrambler chip",resolve:(e,t)=>t.pickOne(["scrambler chip","masking foil strip","signal foam"],"scrambler chip")}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"merchant.default_greeting.genericFallback",roleId:"merchant",templateKey:"default_greeting",summary:"Default line when no other gating applies.",content:"Stock's thin but serviceable. {{highlightItem}} still on the shelves.",fallbackContent:"Limited stock today.",tokens:[{id:"highlightItem",fallback:"standard issue kits",resolve:(e,t)=>t.pickOne(["standard issue kits","bulk rations","basic medpacks"],"basic medpacks")}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},weight:1,isFallback:!0}],Ls=["Keep your papers visible and your hands where the drones can see them.","If you spot a rebel courier, flag Ops immediately.","Curfew level's rising—movement passes expire at sundown.","Checkpoint scanners lag two beats; don't test them."],js=["Orders say we hit siege level if one more rumor spikes.","CorpSec command wants names; don't make me drag you in.","We're one alert away from full lockdown."],Zd=[{id:"checkpoint_guard.default_greeting.standard",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Baseline checkpoint greeting with procedural warning.",content:"Checkpoint Delta online. {{instructionHook}}",fallbackContent:"Checkpoint active. Move along.",tokens:[{id:"instructionHook",fallback:"Stay within curfew limits.",resolve:(e,t)=>t.pickOne(Ls,Ls[0])}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"checkpoint_guard.default_greeting.highAlert",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Escalated warning when curfew level is high.",content:"Alert tier is {{alertTier}}. Any resistance contact gets you cuffed.",fallbackContent:"High alert. Don't test me.",gating:{environment:[{flag:"curfewLevel",minimumNumeric:2}]},tokens:[{id:"alertTier",fallback:"escalating",resolve:e=>e.world.environmentFlags.curfewLevel>=3?"siege":"escalating"}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},weight:3},{id:"checkpoint_guard.default_greeting.blackout",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Warning when blackout tier is active.",content:"Power grid's unstable; blackout tier {{blackoutTier}}. Expect spot checks.",fallbackContent:"Power grid's shaky. Expect spot checks.",gating:{environment:[{flag:"blackoutTier",allowed:["brownout","rolling"]}]},tokens:[{id:"blackoutTier",fallback:"brownout",resolve:e=>e.world.environmentFlags.blackoutTier}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"checkpoint_guard.default_greeting.crackdown",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Threatening line for hostile resistance reputation.",content:"Your face is flagged on half the scanners in this grid. {{warning}}",fallbackContent:"I've got eyes on you.",gating:{faction:[{factionId:"resistance",maximumReputation:-10}]},tokens:[{id:"warning",fallback:"Step out of line and I'm calling it in.",resolve:(e,t)=>t.pickOne(js,js[0])}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"checkpoint_guard.default_greeting.nightShift",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Night-time variant referencing curfew sweeps.",content:"Night shift sweep in progress. Curfew papers or back to shelter.",fallbackContent:"Curfew papers or move.",gating:{allowedTimesOfDay:["night"]},toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},isFallback:!0}],Ns=["Keep wounds sealed; alley dust is lethal.","Rotating sutures hourly keeps CorpSec toxins from setting in.","Swap filters every hour—mutation spores love stagnant air.","Use the city's steam vents to sterilise gear if the clinic is compromised."],Os=["Don't stack stim packs unless you want your heart to stage a protest.","Hydrate with electrolytes after each stim; trust me, you need them.","If the stim crash hits, sleep it off. No negotiation."],Jd=[{id:"street_doc.default_greeting.resistanceAlly",roleId:"street_doc",templateKey:"default_greeting",summary:"Compassionate line for resistance allies.",content:"Clinic's running hot, but I carved out a cot for you. {{advice}}",fallbackContent:"Clinic's open for resistance blood.",gating:{faction:[{factionId:"resistance",minimumStanding:"friendly"}],forbiddenTimesOfDay:["night"]},tokens:[{id:"advice",fallback:"Stay hydrated and bandage often.",resolve:(e,t)=>t.pickOne(Ns,Ns[0])}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.amara_velez",useGenerated:!0},weight:2},{id:"street_doc.default_greeting.stimWarning",roleId:"street_doc",templateKey:"default_greeting",summary:"Warns players who lean on adrenaline perks.",content:"Saw your vitals spike mid-field. {{stimulantNote}}",fallbackContent:"Your vitals scream stim abuse.",gating:{forbiddenTimesOfDay:["morning"]},tokens:[{id:"stimulantNote",fallback:"Dial down the stim packs or you'll pancake.",resolve:(e,t)=>e.player.perks.includes("adrenalineRush")?t.pickOne(Os,Os[0]):"Your heart rate needs calm, not more gunfire."}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.amara_velez",useGenerated:!0}},{id:"street_doc.default_greeting.hazardClinic",roleId:"street_doc",templateKey:"default_greeting",summary:"Environmental note when hazardous clouds are active.",content:"Smog's thick tonight. I packed spare filters and anti-rad chems.",fallbackContent:"Air's poison. Use the filters.",gating:{requiredHazardKeywords:["smog","toxic","radiation"]},toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"street_doc.default_greeting.overrun",roleId:"street_doc",templateKey:"default_greeting",summary:"Terse line when curfew is active.",content:"I'm triaging patrol victims on the floor. Sit, bleed, talk later.",fallbackContent:"Busy. Sit and wait.",gating:{requireCurfewActive:!0},toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"street_doc.default_greeting.defaultFallback",roleId:"street_doc",templateKey:"default_greeting",summary:"General-purpose greeting.",content:"Slide onto the stool. Tools are clean; I made sure.",fallbackContent:"Seat's open. Let's patch you.",toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},isFallback:!0}],zs=["CorpSec squads shifted to the mag-line every half hour.","Drone lattice thins out near the collapsed tram. Use it.","Rumor says resistance cracked the western floodgate. Check it tonight.","The scavengers set a new killbox under the viaduct. Don't stray."],Fs=["Step wrong and I tip off the enforcers.","You smell like CorpSec. Two words: back off.","My crew has eyes everywhere. Try nothing."],eu=[{id:"gang_scout.default_greeting.friendly",roleId:"gang_scout",templateKey:"default_greeting",summary:"Alliance tone when player reputation with scavengers is high.",content:"Scav nets flagged you green. {{intel}}",fallbackContent:"You're clear with the crew.",gating:{faction:[{factionId:"scavengers",minimumReputation:10}]},tokens:[{id:"intel",fallback:"Stick to the alleys; corp eyes are thick tonight.",resolve:(e,t)=>t.pickOne(zs,zs[0])}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"gang_scout.default_greeting.hostile",roleId:"gang_scout",templateKey:"default_greeting",summary:"Threatening line when player reputation is poor.",content:"Crew tagged you as trouble. {{warning}}",fallbackContent:"Crew doesn't trust you.",gating:{faction:[{factionId:"scavengers",maximumReputation:-5}]},tokens:[{id:"warning",fallback:"You move, we respond.",resolve:(e,t)=>t.pickOne(Fs,Fs[0])}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"gang_scout.default_greeting.blackoutRecon",roleId:"gang_scout",templateKey:"default_greeting",summary:"Intel drop during blackout scenarios.",content:"Blackout's blanketing the grid. Use it to ghost past scanners.",fallbackContent:"Blackout cover tonight. Move quiet.",gating:{environment:[{flag:"blackoutTier",allowed:["brownout","rolling"]}]},toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0}},{id:"gang_scout.default_greeting.nightWatch",roleId:"gang_scout",templateKey:"default_greeting",summary:"Night-only greeting referencing curfew sweeps.",content:"Night patrol spotted a CorpSec sweeper moving east. Stay in the shadows.",fallbackContent:"Night sweeps inbound. Stay sharp.",gating:{allowedTimesOfDay:["night"]},toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"gang_scout.default_greeting.fallback",roleId:"gang_scout",templateKey:"default_greeting",summary:"General-purpose line.",content:"Eyes are open. Feed me intel if you want safe passage.",fallbackContent:"Watch your angles out there.",toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},isFallback:!0}],Bs=["Bunks are sanitised—don't bleed on them.","We rotate guard shifts every twenty minutes; slot in if you can.","Leave broken gear on the workbench; the techs are patching it nightly."],$s=["Food stores run dry in two days unless the next convoy lands.","Filters arrive at dawn—ration what you have left.","Ammo press needs parts; scavenge springs if you spot any."],tu=[{id:"safehouse_handler.default_greeting.welcome",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Warm welcome when the player returns to a safehouse.",content:"Safehouse doors are sealed. {{restNote}}",fallbackContent:"Safehouse secured. Rest while you can.",tokens:[{id:"restNote",fallback:"Grab a bunk and breathe.",resolve:(e,t)=>t.pickOne(Bs,Bs[0])}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.amara_velez",useGenerated:!0},weight:2},{id:"safehouse_handler.default_greeting.lowSupplies",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Warns about low supplies when scarcity flag is high.",content:"Pantry's thin—{{supplyNote}}",fallbackContent:"Supplies low. Make your run count.",gating:{environment:[{flag:"supplyScarcity",allowed:["tight","rationed"]}]},tokens:[{id:"supplyNote",fallback:"stretch your rations.",resolve:(e,t)=>t.pickOne($s,$s[0])}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0}},{id:"safehouse_handler.default_greeting.hazardShelter",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Highlights shelter when hazards are active outside.",content:"Outside's a killbox tonight. Trade routes stay closed until daybreak.",fallbackContent:"Outside is lethal right now. Stay in.",gating:{requiredHazardKeywords:["smog","radiation","patrol"]},toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0}},{id:"safehouse_handler.default_greeting.curfewShelter",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Curfew-specific shelter reminder.",content:"Curfew alarms are peaking. Lock-in lasts until morning.",fallbackContent:"Curfew locked. Sit tight.",gating:{requireCurfewActive:!0},toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0}},{id:"safehouse_handler.default_greeting.fallback",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Default handler line.",content:"We keep the lights dim and the exits mapped. Rest easy.",fallbackContent:"Safehouse steady.",toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},isFallback:!0}],nu=[...Qd,...Zd,...Jd,...eu,...tu],ru=nu.reduce((e,t)=>(e[t.roleId]||(e[t.roleId]=[]),e[t.roleId].push(t),e),{}),Ws=1,su=(e,t)=>{const n=t[e.flag];return!(e.allowed&&e.allowed.length>0&&!e.allowed.includes(n)||e.forbidden&&e.forbidden.includes(n)||typeof n=="number"&&(typeof e.minimumNumeric=="number"&&n<e.minimumNumeric||typeof e.maximumNumeric=="number"&&n>e.maximumNumeric))},iu=(e,t,n)=>{try{const r=e.resolve(t,n);return n.ensure(r,e.fallback)}catch(r){return console.warn("[RoleTemplateResolver] Token resolver failed",e.id,r),e.fallback}},ou=(e,t,n)=>{if(!e.tokens||e.tokens.length===0)return{};const r=Ft(`${n}::${e.id}::tokens`),s={rng:()=>r.next(),pickOne:(o,l)=>!o||o.length===0?l:o[r.nextInt(o.length)],ensure:(o,l)=>o&&o.trim().length>0?o:l};return e.tokens.reduce((o,l)=>(o[l.id]=iu(l,t,s),o),{})},Hs=(e,t)=>e?e.replace(/{{\s*([\w.]+)\s*}}/g,(n,r)=>{const s=t[r];return typeof s=="string"&&s.length>0?s:n}):"",au=(e,t,n)=>!(t&&t.some(r=>!e.includes(r))||n&&n.some(r=>e.includes(r))),lu=(e,t)=>e.reputationSystemsEnabled===!1||!t||t.length===0?!0:t.every(n=>{var o;const r=((o=e.player.factionReputation)==null?void 0:o[n.factionId])??0;if(typeof n.minimumReputation=="number"&&r<n.minimumReputation||typeof n.maximumReputation=="number"&&r>n.maximumReputation)return!1;const s=ar(r);if(n.minimumStanding){const l=wt(s.id),a=wt(n.minimumStanding);if(l<a)return!1}if(n.maximumStanding){const l=wt(s.id),a=wt(n.maximumStanding);if(l>a)return!1}return!0}),cu=(e,t,n)=>!(t&&t.length>0&&!t.every(s=>e.some(o=>o.toLowerCase().includes(s.toLowerCase())))||n&&n.length>0&&n.some(s=>e.some(o=>o.toLowerCase().includes(s.toLowerCase())))),du=(e,t)=>{const n=e.gating;if(!n)return!0;const{world:r,player:s,npc:o}=t;if(!lu(t,n.faction)||!au(s.perks??[],n.requiresPerkIds,n.forbiddenPerkIds)||n.allowedTimesOfDay&&n.allowedTimesOfDay.length>0&&!n.allowedTimesOfDay.includes(r.timeOfDay)||n.forbiddenTimesOfDay&&n.forbiddenTimesOfDay.includes(r.timeOfDay)||typeof n.requireCurfewActive=="boolean"&&n.requireCurfewActive!==r.curfewActive||typeof n.forbidCurfewActive=="boolean"&&n.forbidCurfewActive===r.curfewActive||!cu(r.hazards??[],n.requiredHazardKeywords,n.forbiddenHazardKeywords)||n.environment&&n.environment.length>0&&!n.environment.every(a=>su(a,r.environmentFlags)))return!1;if(n.requiredNpcTags&&n.requiredNpcTags.length>0){const l=(o==null?void 0:o.tags)??[];if(!n.requiredNpcTags.every(d=>l.includes(d)))return!1}if(n.forbiddenNpcTags&&n.forbiddenNpcTags.length>0){const l=(o==null?void 0:o.tags)??[];if(n.forbiddenNpcTags.some(a=>l.includes(a)))return!1}return!(n.requiredZoneIds&&n.requiredZoneIds.length>0&&!n.requiredZoneIds.includes(r.zoneId))},uu=(e,t)=>{if(!e.length)return null;if(e.length===1)return e[0];const n=Ft(`${t}::templatePick`),r=e.reduce((o,l)=>o+(l.weight??Ws),0);let s=n.next()*r;for(const o of e)if(s-=o.weight??Ws,s<=0)return o;return e[n.nextInt(e.length)]},fu=(e,t)=>{const n=ru[e];return n?n.filter(r=>r.templateKey===t):[]},mu=e=>{const{roleId:t,templateKey:n,context:r}=e,s=fu(t,n);if(s.length===0)return console.warn("[RoleTemplateResolver] Missing templates for role",t,"template",n),null;const o=s.filter(b=>du(b,r)),l=o.length>0?o:s.filter(b=>b.isFallback)||s,a=e.seedOverride??r.randomSeed??`${t}:${n}`,d=uu(l,a)??l[0],f=`${a}::${d.seedHint??d.id}`,p=ou(d,r,f),u=Hs(d.content,p),g=Hs(d.fallbackContent,p);return{templateId:d.id,roleId:t,text:u,fallbackText:g,tokens:p,seed:f,toneOverrides:d.toneOverrides,metadata:d.metadata}},Gs=e=>e.charAt(0).toUpperCase()+e.slice(1),pu=/^\[roleTemplate:([a-zA-Z0-9_]+)\.([a-zA-Z0-9_]+)\]$/i,Us={resistance:0,corpsec:0,scavengers:0},$n=e=>e.objectives.some(t=>t.type!=="talk"&&!t.isCompleted),gu=e=>{if(!e)return null;const t=e.trim(),n=pu.exec(t);if(!n)return null;const[,r,s]=n;return{roleId:r,templateKey:s}},hu=()=>{const e=$e(),t=R(h=>h.quests.quests),n=R(h=>h.settings.locale),r=R(h=>!!h.settings.reputationSystemsEnabled),s=tt(n),o=We(n),{logs:l}=s,a=R(h=>h.player.data),d=R(h=>h.world),[f,p]=Bt.useState(null),u=(h,w="attribute")=>{if(w==="skill")try{return sa(h).name}catch(I){return console.warn("[DialogueOverlay] Missing skill definition for",h,I),Gs(h)}return o.skills[h]??Gs(h)},g=c.useCallback(h=>{const w=t.find(k=>k.id===h);if(!w)return;let I=!1;if(w.rewards.forEach(k=>{switch(k.type){case"experience":k.amount>0&&(e(Kn({amount:k.amount,reason:`Quest complete: ${w.name}`})),e(N(l.rewardExperience(k.amount,w.name))),I=!0);break;case"currency":k.amount>0&&(e(ea(k.amount)),e(N(l.rewardCredits(k.amount,w.name))));break;case"item":if(k.id){const x=Math.max(1,k.amount||1);for(let q=0;q<x;q+=1){const G={id:Ye(),name:k.id,description:o.dialogueOverlay.itemRecoveredDescription(w.name),weight:1,value:0,isQuestItem:!1};e(ii(G))}e(N(l.rewardItem(k.id,w.name)))}break}}),!I){const k=Math.max(40,(w.objectives.length||1)*30);e(Kn({amount:k,reason:`Quest complete: ${w.name}`})),e(N(l.rewardExperience(k,w.name)))}},[e,t,l,o]),b=c.useCallback(h=>{if(!h.questEffect)return;const{questId:w,effect:I,objectiveId:k}=h.questEffect;switch(I){case"start":{const x=t.find(q=>q.id===w);x&&!x.isActive&&!x.isCompleted&&(e(or(w)),e(N(l.questAccepted(x.name))))}break;case"complete":{const x=t.find(q=>q.id===w);if(x&&x.isActive&&!x.isCompleted){if($n(x))break;e(na(w)),g(w),e(N(l.questCompleted(x.name)))}}break;case"update":if(k){e(ta({questId:w,objectiveId:k,isCompleted:!0}));const x=t.find(G=>G.id===w),q=x==null?void 0:x.objectives.find(G=>G.id===k);x&&q&&e(N(l.objectiveUpdated(q.description,x.name)))}break}},[e,g,t,l]),{activeDialogue:{dialogueId:C,currentNodeId:y},dialogues:A}=R(h=>h.quests),T=c.useMemo(()=>C?A.find(h=>h.id===C)??null:null,[C,A]),S=c.useMemo(()=>!T||T.nodes.length===0?null:T.nodes.find(w=>w.id===y)??T.nodes[0],[T,y]),z=c.useMemo(()=>{var q,G,ie;if(!T||!S)return null;const h=T.nodes.find(V=>V.id===S.id)??S;let w=h.text,I=h,k;const x=gu(h.text);if(x&&a&&d){const V=x.roleId,{templateKey:Z}=x,ce={level:a.level,perks:a.perks??[],factionReputation:r?a.factionReputation??Us:Us},ue={locale:n,reputationSystemsEnabled:r,player:ce,world:{timeOfDay:d.timeOfDay,curfewActive:d.curfewActive,zoneId:((q=d.currentMapArea)==null?void 0:q.zoneId)??"unknown_zone",zoneName:(G=d.currentMapArea)==null?void 0:G.name,hazards:((ie=d.currentMapArea)==null?void 0:ie.hazards)??[],environmentFlags:d.environment.flags},npc:void 0,randomSeed:`${T.id}:${h.id}`},me=mu({roleId:V,templateKey:Z,context:ue});me&&(w=me.text,k=me.seed,I={...h,text:me.text,tone:{...h.tone??{},...me.toneOverrides??{}}})}return{dialogue:T,node:I,fallbackText:w,seedOverride:k}},[T,S,n,a,d,r]),B=c.useMemo(()=>z?Kd.resolveLine({dialogue:z.dialogue,node:z.node,fallbackText:z.fallbackText,seedOverride:z.seedOverride}):null,[z]),Y=c.useCallback(h=>{if(!h.questEffect)return null;const w=t.find(I=>{var k;return I.id===((k=h.questEffect)==null?void 0:k.questId)});if(!w)return null;switch(h.questEffect.effect){case"start":if(w.isCompleted)return"alreadyCompleted";if(w.isActive)return"alreadyActive";break;case"complete":if(w.isCompleted)return"alreadyCompleted";if(!w.isActive)return"notActive";if($n(w))return"objectivesIncomplete";break;case"update":if(h.questEffect.objectiveId){const I=w.objectives.find(k=>{var x;return k.id===((x=h.questEffect)==null?void 0:x.objectiveId)});if(I!=null&&I.isCompleted)return"objectiveCompleted"}break}return null},[t]),L=c.useCallback(h=>{if(!h.questEffect)return!0;const w=t.find(I=>{var k;return I.id===((k=h.questEffect)==null?void 0:k.questId)});if(!w)return!1;switch(h.questEffect.effect){case"start":return!w.isActive&&!w.isCompleted;case"complete":return w.isActive&&!w.isCompleted&&!$n(w);case"update":return!w.isActive||w.isCompleted?!1:h.questEffect.objectiveId?!w.objectives.some(I=>{var k;return I.id===((k=h.questEffect)==null?void 0:k.objectiveId)&&I.isCompleted}):!0;default:return!0}},[t]),Q=c.useCallback(h=>Y(h)?!0:h.skillCheck?!Xd(a,h):!1,[Y,a]),F=c.useMemo(()=>S?S.options.filter(L):[],[S,L]),le=c.useCallback(h=>{Q(h)||(b(h),h.nextNodeId?e(ra(h.nextNodeId)):e(ln()))},[e,b,Q]);if(c.useEffect(()=>{if(!S)return;const h=I=>{var G;if(I.target instanceof HTMLElement&&(I.target.tagName==="INPUT"||I.target.tagName==="TEXTAREA"||I.target.getAttribute("contenteditable")==="true"))return;let k=null;if(/^[0-9]$/.test(I.key))k=Number(I.key);else if((G=I.code)!=null&&G.startsWith("Numpad")){const ie=Number(I.code.replace("Numpad",""));k=Number.isNaN(ie)?null:ie}if(k===null||k<1)return;const x=k-1,q=F[x];q&&(I.preventDefault(),I.stopPropagation(),typeof I.stopImmediatePropagation=="function"&&I.stopImmediatePropagation(),le(q))},w={capture:!0};return window.addEventListener("keydown",h,w),()=>{window.removeEventListener("keydown",h,w)}},[S,le,F]),!C||!T||!S)return null;const ee=(B==null?void 0:B.text)??(S==null?void 0:S.text)??"...";return i.jsx("div",{style:{position:"absolute",inset:0,display:"flex",alignItems:"flex-end",justifyContent:"center",pointerEvents:"none"},children:i.jsxs("div",{style:{width:"min(620px, 90%)",marginBottom:"calc(var(--bottom-panel-height, 0px) + 2.5rem)",background:"linear-gradient(160deg, rgba(15, 23, 42, 0.94), rgba(15, 23, 42, 0.78))",border:"1px solid rgba(148, 163, 184, 0.35)",borderRadius:"18px",padding:"1.5rem 1.7rem",color:"#e2e8f0",fontFamily:"'DM Sans', 'Inter', sans-serif",boxShadow:"0 28px 48px rgba(15, 23, 42, 0.55)",pointerEvents:"auto",display:"flex",flexDirection:"column",gap:"1.2rem"},children:[i.jsxs("div",{children:[i.jsx("span",{style:{display:"block",fontSize:"0.72rem",letterSpacing:"0.28em",textTransform:"uppercase",color:"rgba(148, 163, 184, 0.85)",marginBottom:"0.35rem"},children:T.npcId}),i.jsx("h2",{style:{fontSize:"1.28rem",fontWeight:700,margin:0,color:"#f8fafc"},children:ee})]}),i.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"0.75rem"},children:F.map((h,w)=>{const I=Q(h),k=h.skillCheck?`${u(h.skillCheck.skill,h.skillCheck.domain??"attribute")} ${h.skillCheck.threshold}`:null,x=Y(h),q=x?o.dialogueOverlay.questLocks[x]:k?I?o.dialogueOverlay.requiresSkill(k):o.dialogueOverlay.checkSkill(k):null;return i.jsxs("button",{type:"button",onClick:()=>le(h),onMouseEnter:()=>!I&&p(w),onMouseLeave:()=>p(null),style:{border:I?"1px solid rgba(148, 163, 184, 0.3)":f===w?"1px solid rgba(96, 165, 250, 0.7)":"1px solid rgba(96, 165, 250, 0.4)",borderRadius:"12px",padding:"0.85rem 1rem",background:I?"linear-gradient(135deg, rgba(15, 23, 42, 0.65), rgba(30, 41, 59, 0.75))":f===w?"linear-gradient(135deg, rgba(37, 99, 235, 0.35), rgba(56, 189, 248, 0.3))":"linear-gradient(135deg, rgba(37, 99, 235, 0.22), rgba(56, 189, 248, 0.18))",color:I?"rgba(148, 163, 184, 0.8)":"#e2e8f0",fontSize:"0.9rem",textAlign:"left",cursor:I?"not-allowed":"pointer",display:"flex",gap:"0.6rem",alignItems:"center",opacity:I?.75:1,pointerEvents:I?"none":"auto",boxShadow:I?"none":f===w?"0 0 20px rgba(56, 189, 248, 0.4), 0 4px 12px rgba(0, 0, 0, 0.3)":"0 0 8px rgba(56, 189, 248, 0.15)",transform:f===w&&!I?"translateY(-2px)":"translateY(0)",transition:"all 0.2s cubic-bezier(0.4, 0, 0.2, 1)"},children:[i.jsx("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:"1.25rem",height:"1.25rem",borderRadius:"50%",background:I?"rgba(148, 163, 184, 0.25)":"rgba(96, 165, 250, 0.35)",color:I?"#cbd5f5":"#bfdbfe",fontWeight:600,fontSize:"0.75rem"},children:w+1}),i.jsx("span",{style:{flex:1},children:h.text}),q&&i.jsx("span",{style:{fontSize:"0.68rem",textTransform:"uppercase",letterSpacing:"0.16em",color:I?"#f87171":"#5eead4"},children:q})]},`${h.text}-${w}`)})}),i.jsx("span",{style:{fontSize:"0.68rem",color:"rgba(148, 163, 184, 0.7)",textAlign:"right",letterSpacing:"0.22em",textTransform:"uppercase"},children:o.dialogueOverlay.escHint})]})})},yu=e=>e.quests.quests,bu=e=>e.settings.locale,Vs=(e,t)=>{var a,d,f;const n=li[e.id],r=(n==null?void 0:n.kind)??"primary",s=(a=n==null?void 0:n.relatedNpcKeys)==null?void 0:a[0],o=s?((d=t.npcs[s])==null?void 0:d.name)??null:null,l=n!=null&&n.missionKey&&n.missionKey in t.missions?((f=t.missions[n.missionKey])==null?void 0:f.summary)??null:null;return{id:e.id,name:e.name,description:e.description,objectives:e.objectives,rewards:e.rewards,kind:r,giverName:o,missionSummary:l,isActive:e.isActive,isCompleted:e.isCompleted}},xu=K([De,yu,bu],(e,t,n)=>{const r=ka(n),s=t.map(d=>Vs(d,r)).filter(d=>d.kind==="side"),o=s.filter(d=>d.isActive&&!d.isCompleted).sort((d,f)=>d.name.localeCompare(f.name)),l=s.filter(d=>!d.isActive&&!d.isCompleted).sort((d,f)=>d.name.localeCompare(f.name)),a=t.map(d=>Vs(d,r)).filter(d=>d.isCompleted).sort((d,f)=>d.name.localeCompare(f.name));return{primaryObjectives:(e==null?void 0:e.primary)??[],activeSideQuests:o,availableSideQuests:l,completedQuests:a}}),wu=(...e)=>e.filter(Boolean).join(" "),vu=({showCompleted:e=!1})=>{const t=R(g=>g.settings.locale),n=We(t),r=R(xu),s=(g,b)=>g<=0?null:t==="en"?g>1?`${g} ${b}s`:`${g} ${b}`:`${g} ${b}`,o=g=>{const b=g.rewards.filter(T=>T.type==="currency").reduce((T,S)=>T+S.amount,0),C=g.rewards.filter(T=>T.type==="experience").reduce((T,S)=>T+S.amount,0),y=g.rewards.filter(T=>T.type==="item"),A=[b?n.questLog.currencyLabel(b):null,C?n.questLog.experienceLabel(C):null,...y.map(T=>s(Math.max(1,T.amount||1),T.id??n.questLog.supplyFallback))].filter(Boolean);return A.length===0?null:i.jsxs("div",{className:"text-[0.66rem] uppercase tracking-[0.18em] text-[#34d399]",children:[n.questLog.rewardsHeading,": ",A.join(" • ")]})},l=g=>i.jsx("h4",{className:"hud-ops-section-label text-[0.62rem] font-semibold text-[#93c5fd]",children:g}),a=()=>r.primaryObjectives.length===0?i.jsx("div",{className:"hud-ops-empty text-[0.7rem]",children:n.questLog.primaryEmpty}):i.jsx("div",{className:"flex flex-col gap-2.5",children:r.primaryObjectives.map(g=>i.jsxs("div",{className:"hud-ops-card hud-ops-card--active flex items-start justify-between gap-3 p-[0.8rem]",children:[i.jsxs("div",{className:"flex min-w-0 flex-1 flex-col gap-1.5",children:[i.jsx("div",{className:"text-[0.76rem] font-semibold tracking-[0.04em] text-slate-100",children:g.label}),g.summary?i.jsx("p",{className:"hud-ops-text-muted text-[0.68rem] leading-[1.45]",children:g.summary}):null]}),i.jsxs("div",{className:"flex min-w-[4.6rem] flex-col items-end gap-1",children:[i.jsx("span",{className:"text-[0.62rem] uppercase tracking-[0.16em]",style:{color:g.isComplete?"#86efac":"#facc15"},children:g.isComplete?n.questLog.primaryComplete:n.questLog.primaryInProgress}),i.jsxs("span",{className:"text-[0.66rem] text-[#e2e8f0]",children:[g.completedQuests,"/",g.totalQuests]})]})]},g.id))}),d=()=>r.activeSideQuests.length===0?i.jsx("div",{className:"hud-ops-empty text-[0.7rem]",children:n.questLog.activeSideEmpty}):i.jsx("div",{className:"flex flex-col gap-2.5",children:r.activeSideQuests.map(g=>i.jsxs("div",{className:"hud-ops-card hud-ops-card--active flex flex-col gap-2.5 p-[0.88rem]",children:[i.jsx("div",{className:"text-[0.84rem] font-semibold tracking-[0.05em] text-slate-50",children:g.name}),i.jsx("p",{className:"hud-ops-text-muted text-[0.72rem] leading-[1.5]",children:g.description}),i.jsx("div",{className:"flex flex-col gap-2.5",children:g.objectives.map(b=>i.jsxs("div",{className:"flex items-start gap-[0.52rem] text-[0.72rem] text-[#cbd5f5]",children:[i.jsx("span",{"aria-hidden":"true",className:"hud-ops-objective-check mt-[1px]","data-completed":b.isCompleted,children:"✓"}),i.jsx("span",{className:"flex-1 leading-tight",children:b.description}),b.count?i.jsxs("span",{className:"text-[0.62rem] uppercase tracking-[0.14em] text-[#facc15]",children:[b.currentCount??0,"/",b.count]}):null]},b.id))}),o(g)]},g.id))}),f=()=>r.availableSideQuests.length===0?i.jsx("div",{className:"hud-ops-empty text-[0.7rem]",children:n.questLog.availableSideEmpty}):i.jsx("div",{className:"flex flex-col gap-2.5",children:r.availableSideQuests.map(g=>i.jsxs("div",{className:"hud-ops-card flex flex-col gap-2.5 p-[0.84rem]",children:[i.jsx("div",{className:"text-[0.78rem] font-semibold tracking-[0.05em] text-[#e2e8f0]",children:g.name}),g.missionSummary?i.jsx("p",{className:"hud-ops-text-muted text-[0.7rem] leading-[1.5]",children:g.missionSummary}):i.jsx("p",{className:"hud-ops-text-muted text-[0.7rem] leading-[1.5]",children:g.description}),i.jsx("div",{className:"text-[0.64rem] uppercase tracking-[0.14em] text-[#93c5fd]",children:g.giverName?n.questLog.giverLabel(g.giverName):n.questLog.giverUnknown}),i.jsx("div",{className:"flex flex-col gap-2",children:g.objectives.map(b=>i.jsxs("div",{className:"flex items-start gap-[0.52rem] text-[0.69rem] text-[#b7c3df]",children:[i.jsx("span",{"aria-hidden":"true",className:"hud-ops-objective-check mt-[1px]","data-completed":b.isCompleted,children:"✓"}),i.jsx("span",{className:"flex-1 leading-tight",children:b.description}),b.count?i.jsxs("span",{className:"text-[0.62rem] uppercase tracking-[0.14em] text-[#facc15]",children:[b.currentCount??0,"/",b.count]}):null]},b.id))}),o(g)]},g.id))}),p=()=>r.completedQuests.length===0?i.jsx("div",{className:"hud-ops-empty text-[0.72rem]",children:n.questLog.completedEmpty}):i.jsx("div",{className:"flex flex-col gap-2.5",children:r.completedQuests.map(g=>i.jsxs("div",{className:"hud-ops-card hud-ops-card--completed flex flex-col gap-2.5 p-[0.84rem]",children:[i.jsxs("div",{className:"flex items-center justify-between gap-2",children:[i.jsx("div",{className:"text-[0.78rem] font-semibold tracking-[0.05em] text-[#ede9fe]",children:g.name}),i.jsx("span",{"aria-hidden":"true",className:"hud-ops-complete-badge inline-flex h-[1.15rem] w-[1.15rem] items-center justify-center rounded-[0.35rem] text-[0.72rem] font-bold",children:"✓"})]}),i.jsx("p",{className:"hud-ops-text-muted text-[0.7rem] leading-[1.5]",children:g.description})]},g.id))});if(e)return i.jsx("div",{className:"flex flex-col gap-3.5 overflow-y-auto pr-1",children:i.jsxs("section",{className:"flex flex-col gap-2.5",children:[l(n.questLog.completed),p()]})});const u=r.primaryObjectives.length+r.activeSideQuests.length+r.availableSideQuests.length>4;return i.jsxs("div",{className:wu("flex flex-col gap-4 pr-1",u?"overflow-y-auto":"overflow-y-hidden"),children:[i.jsxs("section",{className:"flex flex-col gap-2.5",children:[l(n.questLog.primaryProgress),a()]}),i.jsxs("section",{className:"flex flex-col gap-2.5",children:[l(n.questLog.activeSideQuests),d()]}),i.jsxs("section",{className:"flex flex-col gap-2.5",children:[l(n.questLog.availableSideQuests),f()]})]})},Ys=Bt.memo(vu),fn={cyan:"#38bdf8",textPrimary:"#f8fafc",textSecondary:"rgba(226, 232, 240, 0.78)",textMuted:"rgba(148, 163, 184, 0.72)"},mm={background:"rgba(15, 23, 42, 0.6)",borderRadius:"12px",border:"1px solid rgba(148, 163, 184, 0.18)",padding:"0.8rem",boxShadow:"inset 0 1px 0 rgba(148, 163, 184, 0.18)"},pm={display:"flex",flexDirection:"column",gap:"0.14rem"},gm={fontSize:"0.52rem",letterSpacing:"0.19em",textTransform:"uppercase",color:"rgba(148, 163, 184, 0.72)"},hm={fontSize:"0.72rem",fontWeight:600,letterSpacing:"0.05em",color:"#f8fafc",margin:0},ym={fontFamily:'"DM Sans", "Inter", sans-serif',fontSize:"0.85rem",fontWeight:700,color:fn.textPrimary},bm={fontFamily:'"DM Sans", "Inter", sans-serif',fontSize:"0.62rem",color:fn.textMuted},xm=(e,t)=>({background:`linear-gradient(135deg, ${e}, ${t})`,WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text"}),Su=(e,t=8)=>({textShadow:`0 0 ${t}px ${e}, 0 0 ${t*2}px ${e}40`}),Ks=24,Iu=e=>{if(!e)return null;const t=e.canvasDisplayWidth/(e.canvasWidth||1),n=e.canvasDisplayHeight/(e.canvasHeight||1);return{x:e.canvasLeft+e.screenX*t,y:e.canvasTop+e.screenY*n}},ku=()=>{const[e,t]=c.useState(null),n=c.useRef(null),r=c.useCallback(s=>{n.current=s;const o=Iu(s);o&&t(o)},[]);return c.useEffect(()=>{if(typeof window<"u"){const s=window.__getawayPlayerScreenPosition;s&&r(s)}},[r]),c.useEffect(()=>{const s=o=>{r(o.detail)};return window.addEventListener(cn,s),()=>window.removeEventListener(cn,s)},[r]),c.useEffect(()=>{const s=()=>{n.current&&r(n.current)};return window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[r]),e},Eu=({notification:e,onComplete:t})=>{const[n,r]=c.useState(!1);c.useEffect(()=>{const a=setTimeout(()=>r(!0),10),d=setTimeout(()=>{r(!1),setTimeout(()=>t(e.id),200)},2200);return()=>{clearTimeout(a),clearTimeout(d)}},[e.id,t]);const s={display:"inline-flex",alignItems:"center",gap:"0.28rem",padding:"0.28rem 0.45rem",minWidth:"fit-content",background:"linear-gradient(150deg, rgba(7, 13, 26, 0.92) 0%, rgba(12, 148, 136, 0.58) 100%)",border:"1px solid rgba(56, 189, 248, 0.45)",borderRadius:"999px",boxShadow:"0 10px 18px -16px rgba(13, 148, 136, 0.55)",opacity:n?1:0,transform:n?"translateY(0)":"translateY(10px)",transition:"opacity 0.18s ease-out, transform 0.18s ease-out",pointerEvents:"none"},o={fontSize:"0.9rem",fontWeight:800,letterSpacing:"0.16em",textTransform:"uppercase",color:fn.textPrimary,...Su(fn.cyan,6)},l={fontSize:"0.55rem",fontWeight:700,letterSpacing:"0.24em",textTransform:"uppercase",color:"rgba(148, 233, 255, 0.92)"};return i.jsxs("div",{style:s,children:[i.jsxs("span",{style:o,children:["+",e.amount]}),i.jsx("span",{style:l,children:"XP"})]})},Tu=({notifications:e,onDismiss:t})=>{const n=ku(),r=c.useMemo(()=>({right:28,top:72}),[]);return i.jsx(i.Fragment,{children:e.map((s,o)=>{const l=n&&typeof window<"u"?(()=>{const a=(b,C,y)=>Math.min(Math.max(b,C),y),d=window.innerWidth||r.right*2,f=window.innerHeight||r.top*2,p=a(n.x,24,d-24),u=a(n.y,24,f-24),g=a(u-56-o*Ks,16,f-16);return{position:"fixed",left:p,top:g,transform:"translateX(-50%)",zIndex:9998,pointerEvents:"none"}})():{position:"fixed",right:`${r.right}px`,top:`${r.top+o*Ks}px`,zIndex:9998,pointerEvents:"none"};return i.jsx("div",{style:l,children:i.jsx(Eu,{notification:s,onComplete:t})},s.id)})})},Cu=()=>{const{currentMapArea:e,inCombat:t,engagementMode:n}=R(g=>g.world),r=R(g=>g.surveillance.hud),s=R(g=>!!g.settings.reputationSystemsEnabled),o=R(g=>g.world.currentMapArea.zoneId),l=R(g=>{var b;return s?(b=g.suspicion.zones[o])==null?void 0:b.heat:void 0}),[a,d]=c.useState(()=>new Date),f=n==="stealth",p=n==="dialog",u=c.useMemo(()=>{const g=(r==null?void 0:r.detectionProgress)??0,b=(l==null?void 0:l.totalHeat)??0,C=Math.max(0,Math.min(100,Math.round(b)));return Math.max(g,C)},[r==null?void 0:r.detectionProgress,l==null?void 0:l.totalHeat]);return c.useEffect(()=>{const g=window.setInterval(()=>d(new Date),1e3);return()=>window.clearInterval(g)},[]),i.jsxs("div",{className:"pointer-events-none absolute inset-0 select-none font-mono uppercase tracking-[0.18em] text-[#38bdf8]",children:[i.jsx("div",{className:"hud-corner","data-position":"top-left"}),i.jsx("div",{className:"hud-corner","data-position":"top-right"}),i.jsx("div",{className:"hud-corner","data-position":"bottom-right"}),i.jsx("div",{className:"hud-corner","data-position":"bottom-left"}),i.jsxs("div",{className:"hud-frame-top",children:[i.jsxs("div",{className:"hud-frame-chip","data-state":t?"alert":f?"stealth":"idle",children:[i.jsx("span",{className:"text-[0.45rem]",children:"●"}),i.jsx("span",{children:t?"COMBAT":f?"STEALTH":p?"DIALOG":"TACTICAL"})]}),i.jsxs("div",{className:"hud-frame-chip",children:[i.jsx("span",{children:"LOC"}),i.jsx("span",{className:"text-slate-100",children:(e==null?void 0:e.id)??"UNKNOWN"})]}),i.jsx("div",{className:"hud-frame-chip",children:i.jsx("span",{children:a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"})})})]}),i.jsx("div",{className:"hud-threat","data-alert":t?"true":"false",children:f?i.jsxs("span",{children:["DETECTION: ",u,"%"]}):p?i.jsx(i.Fragment,{children:"DIALOG MODE ACTIVE"}):i.jsxs(i.Fragment,{children:["THREAT LEVEL: ",t?"HOSTILE":"CLEAR"]})}),i.jsx("div",{className:"hud-frame-line","data-orientation":"top"}),i.jsx("div",{className:"hud-frame-line","data-orientation":"bottom"})]})},Mu=({value:e,gridX:t,gridY:n,type:r,label:s,onComplete:o})=>{const[l,a]=c.useState(!0),[d,f]=c.useState(null),p=c.useRef(null),u=R(S=>S.player.data.position),g=c.useCallback(S=>{if(!S)return;p.current=S;const z=t-u.x,B=n-u.y,Y=64,L=Y,Q=Y/2,F=(z-B)*(L/2),le=(z+B)*(Q/2),ee=S.worldX+F,h=S.worldY+le,w=S.worldX-S.screenX/S.zoom,I=S.worldY-S.screenY/S.zoom,k=(ee-w)*S.zoom,x=(h-I)*S.zoom,q=S.canvasDisplayWidth/S.canvasWidth,G=S.canvasDisplayHeight/S.canvasHeight,ie=S.canvasLeft+k*q,V=S.canvasTop+x*G;f({x:ie,y:V})},[t,n,u.x,u.y]);if(c.useEffect(()=>{if(typeof window<"u"){const S=window.__getawayPlayerScreenPosition;S&&g(S)}},[g]),c.useEffect(()=>{const S=z=>{g(z.detail)};return window.addEventListener(cn,S),()=>window.removeEventListener(cn,S)},[g]),c.useEffect(()=>{const S=setTimeout(()=>{a(!1),o==null||o()},1500);return()=>clearTimeout(S)},[o]),!l||!d)return null;const C=(()=>{switch(r){case"damage":return{color:"#ef4444",glow:"rgba(239, 68, 68, 0.8)",prefix:"-",scale:1};case"heal":return{color:"#34d399",glow:"rgba(52, 211, 153, 0.8)",prefix:"+",scale:1};case"crit":return{color:"#fbbf24",glow:"rgba(251, 191, 36, 0.9)",prefix:"-",scale:1.4};case"miss":return{color:"#94a3b8",glow:"rgba(148, 163, 184, 0.6)",prefix:"",scale:.9};case"block":return{color:"#38bdf8",glow:"rgba(56, 189, 248, 0.8)",prefix:"",scale:1};case"pickup":return{color:"#22d3ee",glow:"rgba(34, 211, 238, 0.85)",prefix:"+",scale:1.05};default:return{color:"#ffffff",glow:"rgba(255, 255, 255, 0.6)",prefix:"",scale:1}}})(),y=r==="miss"?"MISS":r==="block"?"BLOCK":r==="pickup"?`PICKED UP: ${e>1?`${e}x `:""}${s??(e===1?"ITEM":"ITEMS")}`:`${C.prefix}${e}`,A={position:"fixed",left:`${d.x}px`,top:`${d.y}px`,transform:"translate(-50%, -100%)",pointerEvents:"none",userSelect:"none",zIndex:1e4,animation:"floatUp 1.5s cubic-bezier(0.4, 0, 0.2, 1) forwards"},T={fontSize:`${1.2*C.scale}rem`,fontWeight:r==="crit"?900:800,color:C.color,textShadow:`0 0 12px ${C.glow}, 0 0 6px ${C.glow}, 0 2px 4px rgba(0, 0, 0, 0.8)`,fontFamily:'"DM Mono", "IBM Plex Mono", monospace',letterSpacing:"0.05em",WebkitTextStroke:r==="crit"?`1px ${C.color}dd`:"none"};return i.jsxs(i.Fragment,{children:[i.jsx("style",{children:`
        @keyframes floatUp {
          0% {
            transform: translateY(0) scale(${C.scale*.8});
            opacity: 0;
          }
          20% {
            opacity: 1;
          }
          100% {
            transform: translateY(-60px) scale(${C.scale});
            opacity: 0;
          }
        }
      `}),i.jsx("div",{style:A,children:i.jsx("span",{style:T,children:y})})]})},Au=({active:e,type:t="damage",intensity:n=.6,duration:r=300})=>{const[s,o]=c.useState(!1);if(c.useEffect(()=>{if(e){o(!0);const f=setTimeout(()=>{o(!1)},r);return()=>clearTimeout(f)}},[e,r]),!s)return null;const d={...{position:"absolute",inset:0,pointerEvents:"none",zIndex:9999,animation:`hitFlash ${r}ms ease-out forwards`},...(()=>{switch(t){case"damage":return{background:`radial-gradient(circle at center, rgba(239, 68, 68, ${Math.max(0,n*.22)}) 0%, rgba(239, 68, 68, 0) 65%)`,mixBlendMode:"screen"};case"heal":return{background:`rgba(52, 211, 153, ${n})`,mixBlendMode:"lighten"};case"crit":return{background:`rgba(251, 191, 36, ${n*.8})`,mixBlendMode:"screen"};case"block":return{background:`rgba(56, 189, 248, ${n*.7})`,mixBlendMode:"screen"};default:return{background:`rgba(255, 255, 255, ${n})`,mixBlendMode:"screen"}}})()};return i.jsxs(i.Fragment,{children:[i.jsx("style",{children:`
        @keyframes hitFlash {
          0% {
            opacity: 1;
          }
          100% {
            opacity: 0;
          }
        }
      `}),i.jsx("div",{style:d})]})},Ru=()=>{const e=$e(),{floatingNumbers:t,activeFlashId:n,hitFlashes:r}=R(o=>o.combatFeedback),s=r.find(o=>o.id===n);return i.jsxs(i.Fragment,{children:[s&&i.jsx(Au,{active:!0,type:s.type,intensity:s.intensity,duration:s.duration}),t.map(o=>i.jsx(Mu,{value:o.value,gridX:o.gridX,gridY:o.gridY,type:o.type,label:o.label,onComplete:()=>e(ia(o.id))},o.id))]})},Pu={position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",pointerEvents:"none",zIndex:20},Du={padding:"1.8rem 3rem",borderRadius:"18px",background:"rgba(15, 23, 42, 0.85)",border:"1px solid rgba(248, 250, 252, 0.35)",boxShadow:"0 40px 60px rgba(15, 23, 42, 0.55)",display:"flex",flexDirection:"column",alignItems:"center",gap:"0.6rem",textAlign:"center",color:"#f8fafc",letterSpacing:"0.28em",textTransform:"uppercase"},_u={fontSize:"1.6rem",fontWeight:800},Lu={fontSize:"0.85rem",fontWeight:600,opacity:.8},ju=()=>{const e=$e(),t=R(n=>n.surveillance.curfewBanner.visible);return c.useEffect(()=>{if(!t)return;const n=window.setTimeout(()=>{e(ni({visible:!1,timestamp:Date.now()}))},3e3);return()=>{window.clearTimeout(n)}},[t,e]),t?i.jsx("div",{style:Pu,"aria-live":"assertive","aria-atomic":"true",children:i.jsxs("div",{style:Du,role:"alert",children:[i.jsx("span",{style:_u,children:"Curfew Active"}),i.jsx("span",{style:Lu,children:"Surveillance Engaged"})]})}):null},Nu=e=>e.hudLayout.override,Ou=K([Nu,e=>e.world.inCombat],(e,t)=>e||(t?"combat":"exploration")),zu=()=>{const e=$e(),t=R(De),n=R(zi),r=c.useRef(!1),s=c.useRef(!1);return c.useEffect(()=>{const o=(t==null?void 0:t.allPrimaryComplete)??!1;o&&!r.current&&!n&&e(oa()),r.current=o},[t==null?void 0:t.allPrimaryComplete,n,e]),c.useEffect(()=>{if(!t){s.current=!1;return}n&&!s.current&&(od({level:t.level,levelId:t.levelId,name:t.name}),e(sn({type:"missionCompletion",missionId:t.levelId})),s.current=!0),n||(s.current=!1)},[e,n,t]),null},pr=e=>!!e.settings.reputationSystemsEnabled,Fu={resistance:0,corpsec:0,scavengers:0},Bu=[],$u=[],Gi=e=>e.player.data.factionReputation,Wu=e=>e.player.pendingFactionEvents;K(Gi,pr,(e,t)=>t?e:Fu);const Hu=K(Wu,pr,(e,t)=>!t||e.length===0?Bu:e),wm=K(Gi,pr,(e,t)=>t?aa().map(({id:r})=>{const s=ca(r),o=la(r,e[r]??s.definition.defaultReputation);return{factionId:r,name:s.definition.name,description:s.definition.description,value:o.value,standingId:o.standing.id,standingLabel:o.standing.label,color:o.standing.color,icon:o.standing.icon,effects:o.effects,nextThreshold:o.nextThreshold}}):$u),Gu={position:"fixed",top:"80px",right:"28px",display:"flex",flexDirection:"column",gap:"0.45rem",zIndex:9999,pointerEvents:"none"},Uu=e=>({minWidth:"220px",maxWidth:"280px",borderRadius:"12px",border:`1px solid ${e}`,background:"rgba(15, 23, 42, 0.92)",boxShadow:"0 18px 32px rgba(2, 6, 23, 0.45)",padding:"0.55rem 0.7rem",display:"flex",flexDirection:"column",gap:"0.28rem",color:"rgba(226, 232, 240, 0.95)",pointerEvents:"auto"}),Vu={fontSize:"0.64rem",letterSpacing:"0.12em",textTransform:"uppercase"},qs={fontSize:"0.58rem",lineHeight:1.35,color:"rgba(203, 213, 225, 0.92)"},Xs=e=>e===0?"±0":`${e>0?"+":""}${e}`,Yu=4200,Ku=()=>{const e=$e(),t=R(Hu),n=R(p=>p.settings.locale),r=R(p=>!!p.settings.reputationSystemsEnabled),s=c.useMemo(()=>We(n),[n]),o=s.playerStatus.factions,[l,a]=c.useState([]),d=c.useRef({}),f=c.useCallback(p=>{a(g=>g.filter(b=>b.id!==p));const u=d.current[p];u&&(window.clearTimeout(u),delete d.current[p])},[]);return c.useEffect(()=>{if(!r){Object.values(d.current).forEach(u=>window.clearTimeout(u)),d.current={},a(u=>u.length>0?[]:u);return}if(!t.length)return;const p=[];t.forEach(u=>{const g=o[u.factionId]??u.factionId,b=u.standingChanges.find(ee=>ee.factionId===u.factionId),C=u.standingChanges.find(ee=>ee.factionId!==u.factionId),y=Object.entries(u.rivalDeltas??{}),A=y.length>0?y[0]:void 0,T=u.reason?s.factionToast.reasons[u.reason]??u.reason:void 0,S=Xs(u.delta),z=b?an(n,b.nextStanding):void 0,B=z?s.factionToast.standingChange(z):void 0,Y=C?an(n,C.nextStanding):void 0,L=A?s.factionToast.rivalChange(o[A[0]]??A[0],Xs(A[1]),Y):void 0,Q=s.factionToast.reputationChange(g,S,T),F=`${u.factionId}-${u.timestamp}`,le=u.delta>0?"rgba(56, 189, 248, 0.65)":u.delta<0?"rgba(248, 113, 113, 0.65)":"rgba(148, 163, 184, 0.65)";p.push({id:F,factionId:u.factionId,message:Q,standingNote:B,rivalNote:L,color:le}),e(N(Q)),B&&B!==Q&&e(N(B)),L&&e(N(L))}),a(u=>[...u,...p].slice(-6)),p.forEach(u=>{const g=window.setTimeout(()=>f(u.id),Yu);d.current[u.id]=g}),e(da())},[e,t,o,n,f,s.factionToast,r]),c.useEffect(()=>()=>{Object.values(d.current).forEach(p=>window.clearTimeout(p)),d.current={}},[]),!r||l.length===0?null:i.jsx("div",{style:Gu,"aria-live":"polite","aria-atomic":"false",children:l.map(p=>i.jsxs("div",{style:Uu(p.color),role:"status","aria-live":"polite",children:[i.jsx("span",{style:Vu,children:p.message}),p.standingNote&&i.jsx("span",{style:qs,children:p.standingNote}),p.rivalNote&&i.jsx("span",{style:qs,children:p.rivalNote})]},p.id))})},qu={position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(15, 23, 42, 0.86)",backdropFilter:"blur(6px)",zIndex:20,padding:"1.5rem"},Xu={width:"min(520px, 92vw)",borderRadius:"18px",border:"1px solid rgba(94, 234, 212, 0.2)",background:"linear-gradient(135deg, rgba(6, 15, 28, 0.95), rgba(13, 31, 48, 0.92))",color:"#f8fafc",fontFamily:"'DM Mono', 'IBM Plex Mono', monospace",boxShadow:"0 40px 68px rgba(2, 6, 23, 0.55)",display:"flex",flexDirection:"column",gap:"1.2rem",padding:"2rem 2.2rem"},Qu={display:"flex",gap:"0.75rem"},Qs={all:"unset",cursor:"pointer",flex:1,padding:"0.7rem 1.2rem",borderRadius:"999px",letterSpacing:"0.15em",fontSize:"0.72rem",fontWeight:700,textTransform:"uppercase",textAlign:"center",minWidth:0},Zu=({open:e,levelName:t,missionStrings:n,primaryObjectives:r,sideObjectives:s,onContinue:o,onDefer:l})=>{if(!e)return null;const a=r.filter(f=>f.isComplete),d=s.filter(f=>!f.isComplete);return i.jsx("div",{role:"dialog","aria-modal":"true",style:qu,children:i.jsxs("div",{style:Xu,children:[i.jsxs("header",{style:{display:"flex",flexDirection:"column",gap:"0.4rem"},children:[i.jsx("span",{style:{fontSize:"0.7rem",letterSpacing:"0.28em",color:"rgba(94, 234, 212, 0.75)",textTransform:"uppercase"},children:n.accomplishedTitle}),i.jsx("h2",{style:{fontSize:"1.35rem",fontWeight:700,letterSpacing:"0.08em",margin:0},children:n.accomplishedSubtitle(t)})]}),i.jsxs("section",{style:{display:"flex",flexDirection:"column",gap:"0.9rem"},children:[i.jsxs("div",{style:{border:"1px solid rgba(148, 163, 184, 0.22)",borderRadius:"14px",padding:"0.9rem 1.1rem",background:"rgba(15, 23, 42, 0.68)",display:"flex",flexDirection:"column",gap:"0.6rem"},children:[i.jsx("span",{style:{fontSize:"0.7rem",color:"rgba(148, 163, 184, 0.78)"},children:n.primarySummaryLabel}),a.length===0?i.jsx("span",{style:{fontSize:"0.72rem",color:"rgba(226, 232, 240, 0.86)"},children:"—"}):i.jsx("ul",{style:{margin:0,padding:0,listStyle:"none",display:"flex",flexDirection:"column",gap:"0.45rem"},children:a.map(f=>i.jsxs("li",{style:{display:"flex",gap:"0.55rem",alignItems:"flex-start",fontSize:"0.74rem",color:"rgba(226, 232, 240, 0.9)",lineHeight:1.35},children:[i.jsx("span",{"aria-hidden":!0,style:{width:"0.9rem",height:"0.9rem",borderRadius:"999px",display:"inline-flex",alignItems:"center",justifyContent:"center",background:"linear-gradient(135deg, rgba(56, 189, 248, 0.55), rgba(94, 234, 212, 0.55))",color:"#02111f",fontSize:"0.62rem",fontWeight:700,border:"1px solid rgba(94, 234, 212, 0.5)"},children:"✓"}),i.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"0.2rem",flex:1},children:[i.jsx("span",{style:{fontWeight:600},children:f.label}),f.summary&&i.jsx("span",{style:{fontSize:"0.66rem",color:"rgba(203, 213, 225, 0.82)"},children:f.summary})]})]},f.id))})]}),i.jsxs("div",{style:{border:"1px solid rgba(148, 163, 184, 0.22)",borderRadius:"14px",padding:"0.9rem 1.1rem",background:"rgba(15, 23, 42, 0.6)",display:"flex",flexDirection:"column",gap:"0.65rem"},children:[i.jsx("span",{style:{fontSize:"0.7rem",color:"rgba(148, 163, 184, 0.78)"},children:n.sideReminder}),d.length===0?i.jsx("span",{style:{fontSize:"0.72rem",color:"rgba(226, 232, 240, 0.88)"},children:"—"}):i.jsx("ul",{style:{margin:0,paddingLeft:"1.1rem",display:"flex",flexDirection:"column",gap:"0.35rem",fontSize:"0.72rem",color:"rgba(226, 232, 240, 0.88)",listStyle:"disc"},children:d.map(f=>i.jsx("li",{children:f.label},f.id))})]}),i.jsx("span",{style:{fontSize:"0.64rem",color:"rgba(148, 163, 184, 0.65)"},children:n.deferHint})]}),i.jsxs("div",{style:Qu,children:[i.jsx("button",{type:"button",onClick:o,style:{...Qs,border:"1px solid rgba(94, 234, 212, 0.5)",background:"linear-gradient(135deg, rgba(56, 189, 248, 0.7), rgba(94, 234, 212, 0.65))",color:"#02111f",boxShadow:"0 20px 36px rgba(13, 148, 136, 0.35)"},children:n.continueCta}),i.jsx("button",{type:"button",onClick:l,style:{...Qs,border:"1px solid rgba(148, 163, 184, 0.45)",background:"rgba(15, 23, 42, 0.75)",color:"rgba(226, 232, 240, 0.9)"},children:n.deferCta})]})]})})},Ju=()=>{const e=$e(),t=R(p=>p.settings.locale),n=R(De),r=R(p=>p.missions),s=R(zi),o=R(Jc),l=We(t),a=s&&!o,d=()=>{if(!n)return;const p=r.levels[r.currentLevelIndex+1],u=(p==null?void 0:p.zoneId)??null;ad({level:n.level,levelId:n.levelId,name:n.name,nextLevel:(p==null?void 0:p.level)??n.level+1,nextLevelId:p==null?void 0:p.levelId}),e(fa()),u&&e(ma({zoneId:u}))},f=()=>{e(ua())};return i.jsx(Zu,{open:a,levelName:(n==null?void 0:n.name)??"Current Sector",missionStrings:l.mission,primaryObjectives:(n==null?void 0:n.primary)??[],sideObjectives:(n==null?void 0:n.side)??[],onContinue:d,onDefer:f})},ef=[],tf={width:"min(360px, 32vw)",minWidth:"280px",padding:"0.85rem 1rem 1.1rem",borderRadius:"16px",background:"linear-gradient(165deg, rgba(10,17,32,0.93), rgba(15,23,42,0.9))",border:"1px solid rgba(56,189,248,0.28)",boxShadow:"0 18px 36px rgba(15,23,42,0.55)",display:"flex",flexDirection:"column",gap:"0.72rem",pointerEvents:"auto"},nf={display:"flex",alignItems:"center",justifyContent:"space-between",fontSize:"0.62rem",letterSpacing:"0.22em",textTransform:"uppercase",color:"#94a3b8"},rf={display:"inline-flex",gap:"0.42rem",alignItems:"center",fontSize:"0.62rem",letterSpacing:"0.18em"},sf={fontWeight:700,fontSize:"0.78rem",color:"#38bdf8"},of={opacity:.8,color:"#cbd5f5"},af=e=>({width:"100%",display:"flex",alignItems:"center",justifyContent:"center",padding:"0.52rem 1rem",borderRadius:"12px",fontWeight:700,letterSpacing:"0.22em",fontSize:"0.76rem",textTransform:"uppercase",color:e?"#0f172a":"#f8fafc",background:e?"linear-gradient(135deg, #38bdf8, #60a5fa)":"linear-gradient(135deg, rgba(248,113,113,0.85), rgba(239,68,68,0.95))",boxShadow:e?"0 0 18px rgba(56,189,248,0.6), 0 14px 24px -10px rgba(56,189,248,0.55)":"0 0 18px rgba(239,68,68,0.6), 0 14px 24px -10px rgba(239,68,68,0.55)"}),lf={display:"flex",flexDirection:"column",gap:"0.65rem",padding:"0.9rem 1rem 0.85rem",borderRadius:"14px",background:"linear-gradient(155deg, rgba(15,23,42,0.92), rgba(30,41,59,0.8))",border:"1px solid rgba(56,189,248,0.18)",boxShadow:"0 16px 32px rgba(15,23,42,0.45)"},cf={display:"flex",justifyContent:"space-between",alignItems:"center",fontSize:"0.68rem",letterSpacing:"0.16em",color:"#9ca3c6",textTransform:"uppercase"},df=e=>({fontSize:"0.98rem",fontWeight:600,color:e?"#fda4af":"#f8fafc",textShadow:e?"0 0 12px rgba(248,113,113,0.45)":"none"}),uf={position:"relative",height:"9px",borderRadius:"999px",background:"linear-gradient(90deg, rgba(30,41,59,0.9), rgba(11,16,28,0.85))",overflow:"hidden",boxShadow:"inset 0 0 8px rgba(15,23,42,0.6)"},ff=e=>({position:"absolute",top:0,left:0,height:"100%",width:`${Math.max(0,Math.min(1,e))*100}%`,background:"linear-gradient(90deg, rgba(96,165,250,0.95), rgba(56,189,248,0.85))",boxShadow:"0 0 16px rgba(56,189,248,0.38)",transition:"width 160ms ease-out"}),mf=e=>{const t={off:{border:"rgba(148,163,184,0.32)",glow:"rgba(148,163,184,0.22)",background:"linear-gradient(135deg, rgba(15,23,42,0.86), rgba(30,41,59,0.78))",label:"#cbd5f5",state:"#94a3b8",dot:"#64748b"},running:{border:"rgba(34,197,94,0.55)",glow:"rgba(34,197,94,0.45)",background:"linear-gradient(135deg, rgba(22,163,74,0.25), rgba(74,222,128,0.18))",label:"#d1fae5",state:"#86efac",dot:"#34d399"},paused:{border:"rgba(250,204,21,0.55)",glow:"rgba(250,204,21,0.38)",background:"linear-gradient(135deg, rgba(120,53,15,0.28), rgba(217,119,6,0.22))",label:"#fef3c7",state:"#fde68a",dot:"#fbbf24"}}[e];return{width:"100%",display:"flex",alignItems:"center",justifyContent:"space-between",padding:"0.52rem 0.9rem",borderRadius:"12px",border:`1px solid ${t.border}`,background:t.background,color:t.label,fontWeight:500,fontSize:"0.72rem",letterSpacing:"0.16em",textTransform:"uppercase",cursor:"pointer",boxShadow:`0 0 22px ${t.glow}`,transition:"transform 120ms ease, box-shadow 120ms ease, border-color 160ms ease"}},pf={display:"flex",flexDirection:"column",alignItems:"flex-start",gap:"0.14rem"},gf={fontSize:"0.58rem",letterSpacing:"0.3em",opacity:.74},hf=e=>({fontSize:"0.84rem",letterSpacing:"0.14em",color:{off:"#cbd5f5",running:"#bbf7d0",paused:"#fde68a"}[e]}),yf=e=>{const t={off:{background:"#64748b",shadow:"rgba(100,116,139,0.35)"},running:{background:"#34d399",shadow:"rgba(52,211,153,0.55)"},paused:{background:"#fbbf24",shadow:"rgba(251,191,36,0.45)"}};return{width:"0.6rem",height:"0.6rem",borderRadius:"50%",background:t[e].background,boxShadow:`0 0 14px ${t[e].shadow}`}},bf={display:"flex",flexDirection:"column",gap:"0.5rem",padding:"0.82rem 0.95rem",borderRadius:"14px",background:"linear-gradient(160deg, rgba(17,24,39,0.86), rgba(15,23,42,0.9))",border:"1px solid rgba(99,102,241,0.22)",boxShadow:"0 16px 32px rgba(15,23,42,0.42)"},xf={display:"block",fontSize:"0.58rem",letterSpacing:"0.24em",color:"#808bb2",textTransform:"uppercase"},wf={display:"grid",gridTemplateColumns:"minmax(0, 1fr) minmax(0, 1.5fr) auto",alignItems:"center",gap:"0.6rem",fontSize:"0.72rem",color:"#d1dcff"},vf={position:"relative",height:"6px",borderRadius:"999px",background:"rgba(71,85,105,0.45)",overflow:"hidden"},Sf=e=>({position:"absolute",inset:0,width:`${Math.max(0,Math.min(1,e))*100}%`,background:"linear-gradient(90deg, rgba(239,68,68,0.85), rgba(248,113,113,0.78))",boxShadow:"0 0 12px rgba(248,113,113,0.32)",transition:"width 160ms ease-out"}),If={fontSize:"0.66rem",opacity:.84,minWidth:"44px",textAlign:"right"},kf=()=>{const e=$e(),t=R(L=>L.settings.locale),n=R(L=>L.autoBattle.status),r=R(L=>L.world.inCombat),s=R(L=>L.world.isPlayerTurn),o=R(L=>L.settings.autoBattleEnabled),l=R(L=>L.player.data.actionPoints),a=R(L=>L.player.data.maxActionPoints),d=R(L=>{var Q;return((Q=L.world.currentMapArea)==null?void 0:Q.entities.enemies)??ef}),f=We(t),p=c.useMemo(()=>d.filter(L=>L.health>0),[d]),u=p.length,g=c.useMemo(()=>p.slice().sort((L,Q)=>Q.actionPoints-L.actionPoints).slice(0,4),[p]),[b,C]=c.useState(l),y=c.useRef(b),A=c.useRef(null);if(c.useEffect(()=>{y.current=b},[b]),c.useEffect(()=>{const L=l;if(A.current&&(window.clearTimeout(A.current),A.current=null),!r){C(L);return}if(!(o&&n==="running")||L>=y.current){C(L);return}const F=()=>{const le=y.current;if(le<=L){A.current=null;return}C(le-1),A.current=window.setTimeout(F,70)};return A.current=window.setTimeout(F,60),()=>{A.current&&(window.clearTimeout(A.current),A.current=null)}},[l,r,o,n]),c.useEffect(()=>()=>{A.current&&window.clearTimeout(A.current)},[]),!r)return null;const T=Math.max(0,a),S=T>0?Math.max(0,Math.min(1,b/T)):0,z=()=>{e(Yn(!o))},Y=o?n==="paused"?"paused":n==="running"?"running":"off":"off";return i.jsxs("div",{style:tf,"data-testid":"combat-control-widget",children:[i.jsxs("div",{style:nf,children:[i.jsx("span",{children:f.turnTracker.heading.toUpperCase()}),i.jsxs("span",{style:rf,children:[i.jsx("span",{style:sf,children:u}),i.jsx("span",{style:of,children:f.turnTracker.hostileReadout.toUpperCase()})]})]}),i.jsx("div",{style:af(s),children:s?f.turnTracker.playerTurn:f.turnTracker.enemyTurn}),i.jsxs("div",{style:lf,children:[i.jsxs("div",{style:cf,children:[i.jsx("span",{children:f.playerStatus.actionPointsLabel}),i.jsxs("span",{style:df(b===0),children:[b,"/",a]})]}),i.jsx("div",{style:uf,children:i.jsx("div",{style:ff(S)})})]}),i.jsxs("button",{type:"button",onClick:z,style:mf(Y),"aria-pressed":o,"aria-label":f.autoBattle.toggleLabel,children:[i.jsxs("span",{style:pf,children:[i.jsx("span",{style:gf,children:f.autoBattle.heading.toUpperCase()}),i.jsx("span",{style:hf(Y),children:Y==="off"?f.autoBattle.hudToggleOffLabel:f.autoBattle.hudToggleOnLabel})]}),i.jsx("span",{style:yf(Y)})]}),i.jsxs("div",{style:bf,children:[i.jsx("span",{style:xf,children:f.turnTracker.hostileReadout.toUpperCase()}),i.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"0.55rem"},children:g.length>0?g.map(L=>{const Q=L.maxActionPoints>0?Math.max(0,Math.min(1,L.actionPoints/L.maxActionPoints)):0;return i.jsxs("div",{style:wf,children:[i.jsx("span",{style:{fontWeight:600,overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"},title:L.name,children:L.name}),i.jsx("div",{style:vf,children:i.jsx("div",{style:Sf(Q)})}),i.jsxs("span",{style:If,children:[L.actionPoints,"/",L.maxActionPoints]})]},L.id)}):i.jsx("span",{style:{fontSize:"0.68rem",color:"#9ca3c6",textAlign:"center",letterSpacing:"0.1em"},children:f.turnTracker.playerTurn.toUpperCase()})})]})]})},gr=e=>!!e.settings.reputationSystemsEnabled,Ef={},hr=e=>e.reputation,Tf=K(gr,hr,(e,t)=>e&&t.debug.heatmapEnabled),Ui=K(hr,gr,(e,t)=>t?e.profiles:Ef),Cf=e=>K(Ui,t=>t[e]),Mf=(e,t=3)=>K(Ui,n=>{const r=n[e];return r?pa.map(s=>{const o=r.traits[s];return{trait:s,value:(o==null?void 0:o.value)??0,confidence:(o==null?void 0:o.confidence)??0}}).filter(s=>s.value!==0).sort((s,o)=>Math.abs(o.value)-Math.abs(s.value)).slice(0,t):[]}),Af=K(gr,hr,(e,t)=>e?t.debug.inspectorTargetId??null:null),Rf=()=>{if(typeof process<"u")return"production";if(typeof window<"u"){const e=window;if(typeof e.__VITE_MODE__=="string")return e.__VITE_MODE__}return"development"},Pf=e=>`${Math.round(e*100)}`,Df=e=>e.charAt(0).toUpperCase()+e.slice(1),Wn=e=>{if(!Number.isFinite(e))return"—";const{hour:t,minute:n}=oi(e,lr);return`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`},Vi=e=>Math.floor(e/24*lr.cycleDuration),_f=Vi(ha),Zs=Vi(ya),Lf={fontSize:"0.64rem",letterSpacing:"0.18em",textTransform:"uppercase",color:"rgba(226, 232, 240, 0.72)"},jf={all:"unset",display:"flex",alignItems:"center",justifyContent:"space-between",gap:"0.5rem",width:"100%",marginBottom:"0.35rem",cursor:"pointer",letterSpacing:"0.18em",textTransform:"uppercase",color:"rgba(226, 232, 240, 0.86)"},Nf={fontSize:"0.68rem",color:"rgba(148, 163, 184, 0.72)"},Of={display:"none"},Ve={display:"flex",justifyContent:"space-between",fontSize:"0.78rem",marginBottom:"0.22rem"},tn={listStyle:"none",margin:0,padding:0,display:"grid",gap:"0.35rem"},nn={padding:"0.45rem 0.55rem",borderRadius:"0.55rem",backgroundColor:"rgba(24, 36, 52, 0.78)",border:"1px solid rgba(70, 104, 150, 0.3)"},zf={display:"flex",flexDirection:"column",alignItems:"flex-start",gap:"0.5rem",pointerEvents:"auto"},Ff={all:"unset",display:"inline-flex",alignItems:"center",gap:"0.45rem",padding:"0.45rem 0.85rem",borderRadius:"999px",border:"1px solid rgba(59, 130, 246, 0.42)",background:"linear-gradient(135deg, rgba(15, 23, 42, 0.92), rgba(30, 41, 59, 0.92))",color:"#e2e8f0",fontFamily:'"DM Mono","IBM Plex Mono",monospace',fontSize:"0.62rem",letterSpacing:"0.2em",textTransform:"uppercase",cursor:"pointer",transition:"transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease"},et={all:"unset",display:"inline-flex",alignItems:"center",justifyContent:"center",padding:"0.35rem 0.65rem",borderRadius:"0.55rem",border:"1px solid rgba(148, 163, 184, 0.45)",background:"rgba(15, 23, 42, 0.88)",color:"rgba(226, 232, 240, 0.92)",fontSize:"0.58rem",letterSpacing:"0.18em",textTransform:"uppercase",cursor:"pointer"},Bf={padding:"0.85rem 1rem",borderRadius:"0.85rem",backgroundColor:"rgba(12, 18, 28, 0.9)",color:"#f1f5ff",backdropFilter:"blur(6px)",border:"1px solid rgba(59, 130, 246, 0.38)",width:"min(360px, 28vw)",display:"grid",gap:"0.75rem",fontFamily:'"DM Mono","IBM Plex Mono",monospace',boxShadow:"0 18px 40px rgba(15, 23, 42, 0.32)",zIndex:5},$f=[],Wf=({zoneId:e,rendererInfo:t})=>{const n=$e(),r=e??"unknown",s=c.useMemo(()=>Ei(r),[r]),o=c.useMemo(()=>zl(r),[r]),l=R(Tf),a=R(Af),d=R(D=>D.world.currentMapArea.entities.npcs),f=R(D=>D.world.currentMapArea),p=R(D=>D.settings.testMode),u=R(D=>!!D.settings.reputationSystemsEnabled),g=c.useMemo(()=>a?Cf(a):null,[a]),b=c.useMemo(()=>a?Mf(a,4):null,[a]),C=R(D=>g?g(D):null),y=R(D=>b?b(D):$f),[A,T]=c.useState({renderer:!1,time:!1,mission:!1,suspicion:!1,reputation:!1,paranoia:!1}),S={renderer:"Renderer diagnostics",time:"Time/lighting debug",mission:"Mission snapshot",suspicion:"Suspicion snapshot",reputation:"Reputation debug",paranoia:"Paranoia debug"},[z,B]=c.useState(null),[Y,L]=c.useState(null),Q=c.useCallback(D=>{T(ge=>({...ge,[D]:!ge[D]}))},[]);c.useEffect(()=>{!a&&d.length>0&&n(Ur(d[0].id))},[n,a,d]);const F=c.useCallback(()=>{const D=_f;n(Vr(D)),L(`Set to day (${Wn(D)})`)},[n]),le=c.useCallback(()=>{n(Vr(Zs)),L(`Set to night (${Wn(Zs)})`)},[n]),ee=c.useMemo(()=>d.find(D=>D.id===a),[d,a]),[h,w]=c.useState(!0),I=Rf(),k=R(D=>s(D)),x=R(D=>o(D)),q=R(D=>St(D)),G=R(Bl),ie=R(De),V=R(D=>D.world.currentTime),Z=R(D=>D.world.timeOfDay),ce=c.useCallback(()=>{if(!u){B("Reputation systems are disabled for MVP.");return}if(!a||!f){B("Select an NPC inside the current map to seed a sample event.");return}const D=d.find(ge=>ge.id===a);if(!D){B("Selected NPC is no longer present in this area.");return}n(ga({actorId:"player",actorLabel:"Player",zoneId:f.zoneId??"zone::debug",position:{...D.position},intensity:"legendary",traits:{heroic:28,intimidating:8},tags:["debug_sample"],mapArea:f,npcsOverride:[D],ambientLighting:1,ambientNoise:.8,disguisePenalty:0,timestamp:Date.now()})),B(`Seeded a heroic event around ${D.name}. If nothing appears, try again nearby or toggle the reputation heatmap.`)},[n,a,f,d,u]);if(c.useEffect(()=>{z&&y.length>0&&B(null)},[z,y.length]),I==="production"||!p)return null;const ue="command-debug-panel",me=(t==null?void 0:t.label)??"Detecting…",ye=(t==null?void 0:t.detail)??"Negotiating renderer",pe=h?"Show Debug Panel":"Hide Debug Panel",be=(D,ge,j,He)=>{const Pe=A[D],nt=`${ue}-${He}`,Xe=typeof ge=="string"?ge:S[D];return i.jsxs("section",{children:[i.jsxs("button",{type:"button",style:jf,onClick:()=>Q(D),"aria-expanded":!Pe,"aria-controls":nt,"aria-label":`${Pe?"Expand":"Collapse"} ${Xe}`,children:[i.jsx("span",{style:Lf,children:ge}),i.jsx("span",{style:Nf,children:Pe?"▸":"▾"})]}),i.jsx("div",{id:nt,style:Pe?Of:void 0,"aria-hidden":Pe,children:Pe?null:j()})]})};return i.jsxs("div",{style:zf,children:[i.jsxs("button",{type:"button",style:Ff,onClick:()=>w(D=>!D),"aria-expanded":!h,"aria-controls":ue,children:[i.jsx("span",{children:pe}),i.jsx("span",{style:{fontSize:"0.58rem",letterSpacing:"0.2em",textTransform:"uppercase",opacity:.75},children:me})]}),!h&&i.jsxs("div",{id:ue,style:Bf,role:"region","aria-label":"Debug Panel",children:[be("renderer","Renderer Diagnostics",()=>i.jsxs(i.Fragment,{children:[i.jsxs("div",{style:Ve,children:[i.jsx("span",{children:"Mode"}),i.jsx("span",{children:me})]}),i.jsxs("div",{style:{...Ve,alignItems:"flex-start"},children:[i.jsx("span",{children:"Detail"}),i.jsx("span",{style:{textAlign:"right",maxWidth:"18rem"},children:ye})]}),i.jsxs("div",{style:Ve,children:[i.jsx("span",{children:"Phaser"}),i.jsx("span",{children:Be.VERSION})]})]}),"renderer"),be("time","Time & Lighting",()=>i.jsxs(i.Fragment,{children:[i.jsxs("div",{style:Ve,children:[i.jsx("span",{children:"Current"}),i.jsxs("strong",{children:[Wn(V)," · ",Z]})]}),i.jsxs("div",{style:Ve,children:[i.jsx("span",{children:"Cycle Duration"}),i.jsxs("strong",{children:[lr.cycleDuration,"s"]})]}),i.jsxs("div",{style:{display:"flex",gap:"0.35rem",flexWrap:"wrap"},children:[i.jsx("button",{type:"button",style:et,onClick:F,children:"Set Day"}),i.jsx("button",{type:"button",style:et,onClick:le,children:"Set Night"})]}),Y&&i.jsx("div",{style:{fontSize:"0.62rem",color:"rgba(96, 165, 250, 0.8)"},children:Y})]}),"time"),be("mission","Mission Snapshot",()=>i.jsx(i.Fragment,{children:ie?i.jsxs("div",{style:{display:"grid",gap:"0.42rem"},children:[i.jsxs("div",{style:Ve,children:[i.jsx("span",{children:"Level"}),i.jsxs("strong",{children:[ie.level," · ",ie.name]})]}),i.jsx("div",{style:{fontSize:"0.64rem",textTransform:"uppercase",letterSpacing:"0.16em",color:"rgba(125, 211, 252, 0.9)"},children:"Primary Objectives"}),ie.primary.length>0?i.jsx("ul",{style:tn,children:ie.primary.map(D=>i.jsxs("li",{style:nn,children:[i.jsx("div",{style:{fontSize:"0.7rem",marginBottom:"0.15rem"},children:D.label}),i.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.64rem",opacity:.8},children:[i.jsxs("span",{children:[D.completedQuests,"/",D.totalQuests]}),i.jsx("span",{children:D.isComplete?"complete":"in progress"})]})]},D.id))}):i.jsx("div",{style:{fontSize:"0.68rem",opacity:.65},children:"No primary objectives mapped."}),i.jsx("div",{style:{fontSize:"0.64rem",textTransform:"uppercase",letterSpacing:"0.16em",color:"rgba(196, 181, 253, 0.92)"},children:"Side Objectives"}),ie.side.length>0?i.jsx("ul",{style:tn,children:ie.side.map(D=>i.jsxs("li",{style:nn,children:[i.jsx("div",{style:{fontSize:"0.7rem",marginBottom:"0.15rem"},children:D.label}),i.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.64rem",opacity:.8},children:[i.jsxs("span",{children:[D.completedQuests,"/",D.totalQuests]}),i.jsx("span",{children:D.isComplete?"complete":"in progress"})]})]},D.id))}):i.jsx("div",{style:{fontSize:"0.68rem",opacity:.65},children:"No side objectives mapped."})]}):i.jsx("div",{style:{fontSize:"0.7rem",opacity:.65},children:"No active mission manifest."})}),"mission"),u&&be("suspicion",`Suspicion Snapshot · ${r}`,()=>i.jsxs(i.Fragment,{children:[i.jsxs("div",{style:Ve,children:[i.jsx("span",{children:"Heat Tier"}),i.jsx("span",{children:k.tier})]}),i.jsxs("div",{style:Ve,children:[i.jsx("span",{children:"Total Heat"}),i.jsx("span",{children:k.totalHeat.toFixed(2)})]}),x.length>0?i.jsx("ul",{style:tn,children:x.map(D=>i.jsxs("li",{style:nn,children:[i.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.72rem",marginBottom:"0.18rem"},children:[i.jsx("span",{children:D.witnessLabel??D.witnessId}),i.jsxs("span",{children:[Pf(D.certainty),"%"]})]}),i.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.68rem",opacity:.75},children:[i.jsx("span",{children:D.recognitionChannel}),i.jsx("span",{children:D.reported?"reported":"unreported"})]})]},D.id))}):i.jsx("div",{style:{fontSize:"0.7rem",opacity:.65},children:"No active witnesses."})]}),"suspicion"),u&&be("reputation",`Reputation Debug · ${(ee==null?void 0:ee.name)??"Local Cell"}`,()=>i.jsxs(i.Fragment,{children:[i.jsx("div",{style:{display:"flex",gap:"0.4rem",flexWrap:"wrap",marginBottom:"0.45rem"},children:i.jsx("button",{type:"button",style:{...et,borderColor:l?"rgba(96, 165, 250, 0.65)":et.border},onClick:()=>n(ba(!l)),children:l?"Hide Heatmap":"Show Heatmap"})}),i.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"0.35rem",marginBottom:"0.45rem"},children:d.length?d.map(D=>i.jsx("button",{type:"button",style:{...et,borderColor:a===D.id?"rgba(96, 165, 250, 0.65)":et.border},onClick:()=>n(Ur(D.id)),"aria-pressed":a===D.id,children:D.name},D.id)):i.jsx("span",{style:{fontSize:"0.68rem",opacity:.6},children:"No NPCs in this map."})}),i.jsx("div",{style:{fontSize:"0.62rem",color:"rgba(148, 163, 184, 0.75)",marginBottom:"0.35rem"},children:"1) Pick an NPC in the active cell. 2) Trigger an in-game action or use the seed button below. 3) Inspect the traits that populate here and toggle the heatmap to see cell sentiment."}),C?y.length?i.jsx("ul",{style:tn,children:y.map(D=>{const ge=C.traits[D.trait],j=(ge==null?void 0:ge.sources)??[];return i.jsxs("li",{style:nn,children:[i.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.7rem",marginBottom:"0.18rem"},children:[i.jsx("span",{children:Df(D.trait)}),i.jsx("span",{children:D.value.toFixed(1)})]}),i.jsxs("div",{style:{fontSize:"0.64rem",opacity:.72},children:["Confidence ",Math.round(D.confidence*100),"%"]}),j.length?i.jsxs("div",{style:{fontSize:"0.62rem",opacity:.62,marginTop:"0.2rem"},children:["Rumors: ",j.slice(0,3).join(", ")]}):i.jsx("div",{style:{fontSize:"0.62rem",opacity:.45,marginTop:"0.2rem"},children:"No rumor sources tracked."})]},D.trait)})}):i.jsxs("div",{style:{display:"grid",gap:"0.35rem"},children:[i.jsx("div",{style:{fontSize:"0.68rem",opacity:.6},children:"No localized reputation yet. Trigger a nearby event so NPCs can witness something."}),i.jsx("button",{type:"button",onClick:ce,style:{...et,borderColor:"rgba(96, 165, 250, 0.55)",justifyContent:"center"},disabled:!f,children:"Seed Sample Heroic Event"}),z&&i.jsx("div",{style:{fontSize:"0.62rem",color:"rgba(96, 165, 250, 0.8)"},children:z})]}):i.jsxs("div",{style:{display:"grid",gap:"0.35rem"},children:[i.jsx("div",{style:{fontSize:"0.68rem",opacity:.6},children:"Select an NPC to inspect reputation."}),i.jsx("button",{type:"button",onClick:ce,style:{...et,borderColor:"rgba(96, 165, 250, 0.55)",justifyContent:"center"},disabled:!f,children:"Seed Sample Heroic Event"}),z&&i.jsx("div",{style:{fontSize:"0.62rem",color:"rgba(96, 165, 250, 0.8)"},children:z})]})]}),"reputation"),be("paranoia",`Paranoia Debug · ${q.tier}`,()=>i.jsxs(i.Fragment,{children:[i.jsxs("div",{style:Ve,children:[i.jsx("span",{children:"Value"}),i.jsx("span",{children:q.value.toFixed(1)})]}),G?i.jsxs("div",{style:{display:"grid",gap:"0.3rem",fontSize:"0.72rem"},children:[i.jsxs("div",{children:[i.jsx("strong",{style:{opacity:.8},children:"Δ"})," ",G.delta>=0?"+":"",G.delta.toFixed(3)]}),i.jsxs("div",{children:[i.jsx("strong",{style:{opacity:.8},children:"Gains"})," ",Object.keys(G.breakdown.gains).length===0?"—":Object.entries(G.breakdown.gains).map(([D,ge])=>`${D}:${ge.toFixed(3)}`).join(" | ")]}),i.jsxs("div",{children:[i.jsx("strong",{style:{opacity:.8},children:"Losses"})," ",Object.keys(G.breakdown.losses).length===0?"—":Object.entries(G.breakdown.losses).map(([D,ge])=>`${D}:${ge.toFixed(3)}`).join(" | ")]}),i.jsxs("div",{children:[i.jsx("strong",{style:{opacity:.8},children:"Spikes"})," ",Object.keys(G.breakdown.spikes).length===0?"—":Object.entries(G.breakdown.spikes).map(([D,ge])=>`${D}:${ge.toFixed(3)}`).join(" | ")]})]}):i.jsx("div",{style:{fontSize:"0.7rem",opacity:.65},children:"No recent paranoia stimuli."})]}),"paranoia")]})]})},Hf=c.lazy(()=>vt(()=>import("./GameMenu-Cc2oLOFS.js"),__vite__mapDeps([0,1,2,3,4,5]))),Gf=c.lazy(()=>vt(()=>import("./CharacterCreationScreen-BYE7y1eW.js"),__vite__mapDeps([6,1,2,4,3,5,7]))),Uf=c.lazy(()=>vt(()=>import("./CharacterScreen-ByXRfNzd.js"),__vite__mapDeps([8,1,2,3,4,7]))),Vf=c.lazy(()=>vt(()=>import("./LevelUpModal-wUvGPm-b.js"),__vite__mapDeps([9,1,2,5,4,3])).then(e=>({default:e.LevelUpModal}))),Yf=c.lazy(()=>vt(()=>import("./PerkSelectionPanel-CJHwa9xc.js"),__vite__mapDeps([10,1,2,3,4]))),Kf=c.lazy(()=>vt(()=>import("./LevelUpPointAllocationPanel-C5HV9Ta6.js"),__vite__mapDeps([11,1,2,4,3,5]))),Js=si("App"),qf={margin:0,padding:0,width:"100vw",height:"100vh",overflow:"hidden",position:"relative",backgroundColor:"var(--color-gunmetal-900)",color:"var(--color-hud-text)",fontFamily:"var(--font-mono)"},Xf={position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",background:"var(--hud-stage-background)"},Hn=260,Qf=320,Zf={flex:"1 1 auto",minWidth:0,height:"100%",position:"relative",overflow:"hidden"},Jf={position:"absolute",top:"1.25rem",left:"1.25rem",display:"flex",flexDirection:"column",alignItems:"flex-start",gap:"0.75rem",zIndex:5,pointerEvents:"auto"},em={position:"absolute",top:"1.25rem",left:"50%",transform:"translateX(-50%)",display:"flex",flexDirection:"column",alignItems:"center",gap:"0.75rem",zIndex:6,pointerEvents:"auto"},tm={position:"absolute",top:"1.25rem",right:"1.25rem",display:"flex",flexDirection:"column",alignItems:"flex-end",gap:"0.75rem",zIndex:6,pointerEvents:"none"},nm={all:"unset",display:"flex",alignItems:"center",justifyContent:"space-between",gap:"0.5rem",padding:"0.7rem 0.9rem",boxSizing:"border-box",borderRadius:"14px",border:"var(--hud-command-button-border)",background:"var(--hud-command-button-bg)",boxShadow:"var(--hud-command-button-shadow)",color:"var(--hud-command-button-text)",fontFamily:"var(--font-mono)",fontSize:"0.7rem",letterSpacing:"0.14em",textTransform:"uppercase",cursor:"pointer",pointerEvents:"auto",transition:"transform 0.16s ease, box-shadow 0.16s ease, border-color 0.16s ease, color 0.16s ease"},rm={fontSize:"0.78rem",letterSpacing:"0.2em",color:"inherit"},sm={fontSize:"0.62rem",letterSpacing:"0.24em",color:"var(--hud-command-button-text-muted)",textTransform:"uppercase"},im=({onOpenMenu:e,onToggleCharacter:t,showMenu:n,characterOpen:r,hudLayoutPreset:s})=>{const o=R(F=>F.settings.locale),l=R(F=>F.settings.testMode),a=R(F=>F.world.inCombat),d=We(o),f=R(F=>{var le;return((le=F.world.currentMapArea)==null?void 0:le.zoneId)??null}),p=s==="combat",[u,g]=c.useState(!1),[b,C]=c.useState(null),y=c.useRef(null),[A,T]=c.useState(null),[S,z]=c.useState(Hn);c.useEffect(()=>{n&&g(!1)},[n]),c.useEffect(()=>{a&&g(!1)},[a]),c.useEffect(()=>{if(typeof window>"u"||typeof ResizeObserver>"u")return;const F=y.current;if(!F)return;const le=new ResizeObserver(ee=>{const h=ee[0];if(!h)return;const w=Math.round(h.contentRect.height);T(I=>I===w?I:w)});return le.observe(F),()=>le.disconnect()},[]),c.useEffect(()=>{const F=y.current;if(!F)return;const le=Math.round(F.getBoundingClientRect().height);T(ee=>ee===le?ee:le)},[]),c.useEffect(()=>{if(!A){z(Hn);return}if(typeof window>"u"){z(A);return}const le=(parseFloat(window.getComputedStyle(document.documentElement).fontSize||"16")||16)*1.3,ee=Math.round(A+le),h=Math.min(Math.max(ee,Hn),Qf);z(w=>w===h?w:h)},[A]);const B=()=>{g(F=>!F)},Y=u?d.shell.completedToggleClose:d.shell.completedToggleOpen;return c.useEffect(()=>{if(!(typeof document>"u"))return S?document.documentElement.style.setProperty("--bottom-panel-height",`${S}px`):document.documentElement.style.removeProperty("--bottom-panel-height"),()=>{typeof document<"u"&&document.documentElement.style.removeProperty("--bottom-panel-height")}},[S]),i.jsxs("div",{style:Xf,className:"command-shell-stage","data-hud-layout":s,children:[i.jsxs("div",{style:Zf,children:[i.jsx(Cu,{}),i.jsx(Aa,{onRendererInfo:C}),i.jsx(uc,{}),i.jsxs("div",{style:Jf,children:[i.jsxs("button",{type:"button",onClick:e,style:{...nm,width:"90vw",maxWidth:"240px"},"data-testid":"menu-overlay-button","aria-label":d.shell.menuButton,title:d.shell.menuButton,onMouseEnter:F=>{F.currentTarget.style.transform="translateY(-2px)",F.currentTarget.style.boxShadow="var(--hud-command-button-shadow-hover)",F.currentTarget.style.borderColor="var(--hud-command-button-border-hover)",F.currentTarget.style.color="var(--hud-command-button-text-hover)"},onMouseLeave:F=>{F.currentTarget.style.transform="translateY(0)",F.currentTarget.style.boxShadow="var(--hud-command-button-shadow)",F.currentTarget.style.borderColor="var(--hud-command-button-border-rest)",F.currentTarget.style.color="var(--hud-command-button-text)"},onFocus:F=>{F.currentTarget.style.boxShadow="var(--hud-command-button-shadow-focus)",F.currentTarget.style.borderColor="var(--hud-command-button-border-focus)"},onBlur:F=>{F.currentTarget.style.boxShadow="var(--hud-command-button-shadow)",F.currentTarget.style.borderColor="var(--hud-command-button-border-rest)"},children:[i.jsx("span",{style:rm,children:d.shell.menuButton}),i.jsx("span",{style:sm,children:"ESC"})]}),l?i.jsx(Wf,{zoneId:f,rendererInfo:b}):null]}),i.jsx("div",{style:em,children:i.jsx(kf,{})}),i.jsx("div",{style:tm,children:i.jsx("div",{style:{pointerEvents:"auto"},children:i.jsx(xc,{})})}),i.jsx(hu,{}),i.jsx(Ru,{})]}),i.jsxs("div",{className:"hud-bottom-dock","data-hud-layout":s,children:[i.jsx("div",{className:"hud-bottom-lane hud-bottom-lane--map",children:i.jsx("div",{className:"hud-bottom-lane-card",children:i.jsx("div",{className:"hud-bottom-card-surface",children:i.jsx(Nc,{className:"hud-bottom-map-card",variant:"frameless",children:i.jsx(Lc,{})})})})}),i.jsx("div",{className:"hud-bottom-lane hud-bottom-lane--status",ref:y,"data-hud-emphasis":p?"true":void 0,children:i.jsx("div",{className:"hud-bottom-lane-card",children:i.jsx("div",{className:"hud-bottom-card-surface",children:i.jsx(yc,{onOpenCharacter:t,characterOpen:r,variant:"frameless"})})})}),i.jsx("div",{className:"hud-bottom-lane hud-bottom-lane--george",children:i.jsx("div",{className:"hud-bottom-lane-card",children:i.jsx("div",{className:"hud-bottom-card-surface",children:i.jsx(hd,{})})})}),i.jsxs("div",{className:"hud-bottom-lane hud-bottom-lane--ops",children:[i.jsx("div",{className:"hud-bottom-lane-card",children:i.jsxs("div",{className:"hud-bottom-card-surface",children:[i.jsx("div",{className:"hud-bottom-quests",children:i.jsx(Ys,{})}),i.jsx("div",{className:"hud-bottom-control-row",children:i.jsx("button",{type:"button",className:"hud-bottom-toggle",onClick:B,"aria-expanded":u,"aria-controls":"command-objective-overlay",children:Y})})]})}),i.jsx("div",{id:"command-objective-overlay",className:"hud-bottom-overlay","data-expanded":u,children:i.jsx("div",{className:"hud-bottom-overlay__scroll",children:i.jsx(Ys,{showCompleted:!0})})})]})]})]})},ei=()=>{if(typeof window>"u")return!1;try{return!!window.localStorage.getItem(ai)}catch(e){return console.warn("[App] Failed to read persisted game state",e),!1}},on=e=>Ea().filter(t=>!e.perks.includes(t.id)),Gn=e=>on(e).map(t=>Ta(e,t)).filter(t=>t.canSelect);function om(){const[e,t]=c.useState(!1),[n,r]=c.useState(!0),[s,o]=c.useState(!1),[l,a]=c.useState(()=>ei()),[d,f]=c.useState(null),[p,u]=c.useState([]),[g,b]=c.useState(!1),[C,y]=c.useState(0),[A,T]=c.useState(!1),[S,z]=c.useState(!1),[B,Y]=c.useState(!1),L=R(Ou),Q=R(V=>!!V.settings.reputationSystemsEnabled);c.useEffect(()=>{Js.debug("Component mounted"),Js.debug("Store state:",ve.getState())},[]),c.useEffect(()=>ve.subscribe(()=>{const Z=ve.getState(),ce=Z.player.pendingLevelUpEvents;f(ye=>ye||(ce.length>0?ce[0]:null));const ue=Z.player.data.pendingPerkSelections;y(ue);const me=Z.player.xpNotifications??[];u(me)}),[]),c.useEffect(()=>{if(n){if(e){a(!0);return}a(ei())}},[n,e]),c.useEffect(()=>{if(typeof window>"u")return;const V=new URLSearchParams(window.location.search);if(V.get("poc")!=="esb"||e||s)return;try{window.localStorage.removeItem(ai)}catch{}a(!1),r(!1);const Z={name:V.get("pocName")??"Deus",attributes:Yr,backgroundId:"corpsec_defector",visualPreset:"default"};le(Z)},[e,s]),c.useEffect(()=>{e&&window.requestAnimationFrame(()=>{window.dispatchEvent(new Event("resize"))})},[e]),c.useEffect(()=>{(n||s)&&b(!1)},[n,s]),c.useEffect(()=>{const V=Z=>{Z.key.toLowerCase()==="c"&&e&&!n&&!s&&b(ce=>!ce)};return window.addEventListener("keydown",V),()=>window.removeEventListener("keydown",V)},[e,n,s]);const F=()=>{r(!1),o(!0)},le=V=>{ve.dispatch(xa());const Z=V.attributes??Yr,ce=V.backgroundId??"corpsec_defector";ve.dispatch(wa({name:V.name,skills:Z,backgroundId:ce,visualPreset:V.visualPreset}));const ue=ve.getState(),{logs:me}=tt(ue.settings.locale);ve.dispatch(N(`${me.operationStart} - Call sign: ${V.name}`));const ye=ue.quests.quests.find(pe=>pe.id==="quest_market_cache");ye&&!ye.isActive&&!ye.isCompleted&&(ve.dispatch(or(ye.id)),ve.dispatch(N(me.questAccepted(ye.name)))),o(!1),t(!0),a(!0)},ee=()=>{o(!1),r(!0)},h=()=>{ve.dispatch(va()),t(!0),r(!1),a(!0)};c.useEffect(()=>{if(!e)return;const V=Z=>{if(Z.key!=="Escape")return;if(Z.preventDefault(),g){b(!1),S&&z(!1);return}if(!!ve.getState().quests.activeDialogue.dialogueId){ve.dispatch(ln());return}if(n){h();return}s||r(!0)};return window.addEventListener("keydown",V),()=>window.removeEventListener("keydown",V)},[e,n,s,g,S]);const w=()=>{if(!e){r(!0);return}if(n){h();return}if(!!ve.getState().quests.activeDialogue.dialogueId){ve.dispatch(ln());return}r(!0)},I=()=>{!e||n||s||b(V=>!V)},k=()=>{if(!d)return;const Z=ve.getState().player.data,ce=Z.pendingPerkSelections,ue=on(Z),me=Gn(Z),ye=ce>0,pe=me.length>0,be=Z.skillPoints>0||Z.attributePoints>0;z(ye||be),ve.dispatch(Sa()),f(null),ye&&ue.length>0?(pe||console.info("[LevelUp] Perk selections available but current requirements are unmet. Player may need to allocate points first."),T(!0)):(ye&&ue.length===0&&ve.dispatch(Pn()),be?Y(!0):z(!1))},x=()=>{if(T(!1),!S)return;const V=ve.getState().player.data,Z=V.pendingPerkSelections,ce=V.skillPoints>0||V.attributePoints>0,ue=on(V),me=Gn(V);if(Z>0&&me.length===0&&ue.length===0&&ve.dispatch(Pn()),ce){Y(!0);return}z(!1)},q=()=>{b(!1),S&&z(!1)},G=()=>{Y(!1);const V=ve.getState().player.data,Z=V.pendingPerkSelections,ce=on(V),ue=Gn(V);if(Z>0&&ue.length>0){T(!0);return}Z>0&&ue.length===0&&ce.length===0&&ve.dispatch(Pn()),z(!1)},ie=V=>{ve.dispatch(Ia(V))};return i.jsxs(i.Fragment,{children:[i.jsx(zu,{}),Q&&i.jsx(Ku,{}),i.jsxs("div",{style:qf,children:[e&&i.jsx(im,{onOpenMenu:w,onToggleCharacter:I,showMenu:n,characterOpen:g,hudLayoutPreset:L}),i.jsx(ju,{})]}),i.jsxs(c.Suspense,{fallback:null,children:[n&&i.jsx(Hf,{onStartNewGame:F,onContinue:h,hasActiveGame:e||l}),s&&i.jsx(Gf,{onComplete:le,onCancel:ee}),d&&i.jsx(Vf,{newLevel:d.newLevel,skillPointsEarned:d.skillPointsEarned,attributePointsEarned:d.attributePointsEarned,perksUnlocked:d.perksUnlocked,onContinue:k}),i.jsx(Yf,{open:A,pendingSelections:C,onClose:x}),B&&i.jsx(Kf,{onComplete:G}),i.jsx(Uf,{open:g,onClose:q}),i.jsx(Ju,{})]}),i.jsx(Tu,{notifications:p,onDismiss:ie})]})}function am(){return i.jsx(eo,{store:ve,children:i.jsx(om,{})})}to.createRoot(document.getElementById("root")).render(i.jsx(c.StrictMode,{children:i.jsx(am,{})}));export{yc as P,pm as a,gm as b,mm as c,hm as d,ym as e,wm as f,xm as g,fn as n,bm as s};
