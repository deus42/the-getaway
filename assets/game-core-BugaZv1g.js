var ja=Object.defineProperty;var $a=(e,t,i)=>t in e?ja(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var y=(e,t,i)=>$a(e,typeof t!="symbol"?t+"":t,i);import{P}from"./phaser-DkaA9Y8j.js";import{v as oe,g as bt,a as Ya,e as Za,i as ti,c as Xa,b as Qa,d as Ja,f as ii,D as Te,L as er,Q as tr,h as ir,P as sr,j as En,k as _n,l as nr,m as ar,n as xs,o as Is}from"./game-content-DZEr7Bkc.js";import{c as ee,a as rr,b as or,d as lr}from"./vendor-Cc93p67d.js";const Xe=Object.freeze({qualityPreset:"balanced",lightsEnabled:!1,bloom:{enabled:!1,color:16777215,offsetX:0,offsetY:0,blurStrength:0,strength:0,steps:0},vignette:{enabled:!1,x:.5,y:.5,radius:1,strength:0},colorMatrix:{enabled:!1,saturation:0,brightness:1,contrast:0,hue:0}});let ce={qualityPreset:Xe.qualityPreset,lightsEnabled:Xe.lightsEnabled,bloom:{...Xe.bloom},vignette:{...Xe.vignette},colorMatrix:{...Xe.colorMatrix}};const Ii=new Set,cr=()=>{Ii.forEach(e=>e(ce))},oi=e=>{ce={qualityPreset:e.qualityPreset??ce.qualityPreset,lightsEnabled:e.lightsEnabled??ce.lightsEnabled,bloom:{...ce.bloom,...e.bloom??{}},vignette:{...ce.vignette,...e.vignette??{}},colorMatrix:{...ce.colorMatrix,...e.colorMatrix??{}}},cr()},dr=e=>e==="performance"?{bloomStrengthCap:.18,vignetteCap:.22,colorMatrixEnabled:!1,maxFogBands:2,maxEmissiveZones:6,wetReflectionAlpha:.08,occlusionFadeFloor:.56}:e==="cinematic"?{bloomStrengthCap:.48,vignetteCap:.44,colorMatrixEnabled:!0,maxFogBands:6,maxEmissiveZones:14,wetReflectionAlpha:.2,occlusionFadeFloor:.38}:{bloomStrengthCap:.32,vignetteCap:.34,colorMatrixEnabled:!0,maxFogBands:4,maxEmissiveZones:10,wetReflectionAlpha:.14,occlusionFadeFloor:.48},Cs=e=>dr(e),Dn=e=>(Ii.add(e),e(ce),()=>{Ii.delete(e)}),ur=(e,t)=>{t.enabled&&e.postFX.addBloom(t.color,t.offsetX,t.offsetY,t.blurStrength,t.strength,t.steps)},hr=(e,t)=>{t.enabled&&e.postFX.addVignette(t.x,t.y,t.radius,t.strength)},pr=(e,t)=>{if(!t.enabled)return;const i=e.postFX.addColorMatrix();let s=!1;const n=a=>{a(s),s=!0};t.saturation!==0&&n(a=>i.saturate(t.saturation,a)),t.hue!==0&&n(a=>i.hue(t.hue,a)),t.contrast!==0&&n(a=>i.contrast(t.contrast,a)),t.brightness!==1&&n(a=>i.brightness(t.brightness,a))},mr=e=>{e.clearFX(),ur(e,ce.bloom),hr(e,ce.vignette),pr(e,ce.colorMatrix)},gr=e=>{const i=Dn(()=>mr(e));return()=>{i(),e.clearFX()}};var O=(e=>(e.IDLE="idle",e.SUSPICIOUS="suspicious",e.INVESTIGATING="investigating",e.ALARMED="alarmed",e))(O||{}),$=(e=>(e.IDLE="idle",e.SUSPICIOUS="suspicious",e.INVESTIGATING="investigating",e.ALARMED="alarmed",e.DISABLED="disabled",e))($||{}),D=(e=>(e.FLOOR="floor",e.WALL="wall",e.DOOR="door",e.COVER="cover",e.WATER="water",e.TRAP="trap",e))(D||{});const ie=5,se=10,Ln=[{id:"combat",label:"Combat",blurb:"Disciplines that determine battlefield performance and weapon mastery.",skills:[{id:"smallGuns",name:"Small Guns",branch:"combat",maxValue:100,increment:ie,taggedIncrement:se,description:"Training with ballistic pistols, SMGs, and rifles.",effectSummary:"+0.5% hit chance per point with ballistic weapons."},{id:"energyWeapons",name:"Energy Weapons",branch:"combat",maxValue:100,increment:ie,taggedIncrement:se,description:"Mastery of beam, laser, and plasma weapon systems.",effectSummary:"+0.4% hit chance and +0.3% crit chance per point with energy weapons."},{id:"meleeCombat",name:"Melee Combat",branch:"combat",maxValue:100,increment:ie,taggedIncrement:se,description:"Close-quarters tactics for blades, clubs, and unarmed strikes.",effectSummary:"+0.3% melee hit chance per point and +1 damage per 10 points."},{id:"explosives",name:"Explosives",branch:"combat",maxValue:100,increment:ie,taggedIncrement:se,description:"Deployment of grenades, mines, and shaped charges.",effectSummary:"+0.25% throw accuracy per point and +1 tile radius per 25 points."}]},{id:"tech",label:"Tech",blurb:"System infiltration, fabrication, and field engineering aptitudes.",skills:[{id:"hacking",name:"Hacking",branch:"tech",maxValue:100,increment:ie,taggedIncrement:se,description:"Bypass security systems and crack encrypted terminals.",effectSummary:"Unlocks advanced intrusion dialogue choices and minigames (stub).",stub:!0},{id:"engineering",name:"Engineering",branch:"tech",maxValue:100,increment:ie,taggedIncrement:se,description:"Maintain drones, turrets, and battlefield gadgets.",effectSummary:"Improves deployable durability and crafting options (stub).",stub:!0},{id:"science",name:"Science",branch:"tech",maxValue:100,increment:ie,taggedIncrement:se,description:"Chemical analysis and experimental tech research.",effectSummary:"Boosts chem crafting and anomaly research (stub).",stub:!0}]},{id:"survival",label:"Survival",blurb:"Field medicine, stealth, and salvage expertise.",skills:[{id:"medicine",name:"Medicine",branch:"survival",maxValue:100,increment:ie,taggedIncrement:se,description:"Treat injuries and synthesize bio-stims under fire.",effectSummary:"Increases healing efficiency and unlocks aid recipes (stub).",stub:!0},{id:"stealth",name:"Stealth",branch:"survival",maxValue:100,increment:ie,taggedIncrement:se,description:"Avoid detection and blend into hostile zones.",effectSummary:"Improves detection thresholds and noise damping (stub).",stub:!0},{id:"scavenging",name:"Scavenging",branch:"survival",maxValue:100,increment:ie,taggedIncrement:se,description:"Recover components and rare materials from ruins.",effectSummary:"Increases loot yields and salvage spots (stub).",stub:!0}]},{id:"social",label:"Social",blurb:"Command presence, negotiation, and underground influence.",skills:[{id:"persuasion",name:"Persuasion",branch:"social",maxValue:100,increment:ie,taggedIncrement:se,description:"Convince allies and sway neutral factions.",effectSummary:"Unlocks diplomatic dialogue options and better rewards (stub).",stub:!0},{id:"intimidation",name:"Intimidation",branch:"social",maxValue:100,increment:ie,taggedIncrement:se,description:"Force compliance through presence and threat.",effectSummary:"Unlocks threat-based dialogue paths (stub).",stub:!0},{id:"barter",name:"Barter",branch:"social",maxValue:100,increment:ie,taggedIncrement:se,description:"Broker deals and hustle black-market channels.",effectSummary:"Improves vendor prices and trade availability (stub).",stub:!0}]}],fr=Ln.flatMap(e=>e.skills).reduce((e,t)=>(e[t.id]=t,e),{});Ln.reduce((e,t)=>(e[t.id]=t,e),{});const Ci=e=>{const t=fr[e];if(!t)throw new Error(`[skills] Unknown skill id: ${e}`);return t},Xi=(e,t)=>e.skillTraining[t]??0,yr=(e,t)=>e.taggedSkillIds.includes(t),wt=(e,t=100)=>!Number.isFinite(e)||e<0?0:Math.min(t,e),cp=(e,t)=>{const i=Ci(t);return yr(e,t)?i.taggedIncrement:i.increment},Fn=e=>e?e.skillType??(e.range<=1?"meleeCombat":"smallGuns"):"meleeCombat",Bn=e=>wt(e)*.5,Qi=e=>{const t=wt(e);return{hit:t*.4,crit:t*.3}},Ji=e=>{const t=wt(e);return{hit:t*.35,damage:Math.floor(t/10)}},On=e=>{const t=wt(e);return{accuracy:t*.25,radius:Math.floor(t/25)}},dp=(e,t)=>{const i=wt(t);switch(e){case"smallGuns":return`Hit chance bonus +${Bn(i).toFixed(1)}% with ballistic weapons`;case"energyWeapons":{const s=Qi(i);return`Hit +${s.hit.toFixed(1)}% / Crit +${s.crit.toFixed(1)}% with energy weapons`}case"meleeCombat":{const s=Ji(i);return`Hit +${s.hit.toFixed(1)}% / Damage +${s.damage}`}case"explosives":{const s=On(i),n=s.radius===1?"tile":"tiles";return`Throw accuracy +${s.accuracy.toFixed(1)}%, blast radius +${s.radius} ${n}`}default:return"Specialisation effects coming online soon."}},ks=10,si=64,Sr=(e,t)=>{const i=[];for(let s=0;s<t;s++){i[s]=[];for(let n=0;n<e;n++)i[s][n]={type:D.FLOOR,position:{x:n,y:s},isWalkable:!0,provideCover:!1,surfaceKind:"lot"}}return i},Nn=(e,t=ks,i=ks,s={})=>{const n=Sr(t,i);for(let a=0;a<t;a++)n[0][a].type=D.WALL,n[0][a].isWalkable=!1,n[i-1][a].type=D.WALL,n[i-1][a].isWalkable=!1;for(let a=0;a<i;a++)n[a][0].type=D.WALL,n[a][0].isWalkable=!1,n[a][t-1].type=D.WALL,n[a][t-1].isWalkable=!1;return{id:oe(),name:e,zoneId:s.zoneId??"unknown_zone",level:s.level??0,objectives:s.objectives??[],isInterior:s.isInterior??!1,factionRequirement:s.factionRequirement,displayName:s.displayName,summary:s.summary,dangerRating:s.dangerRating,hazards:s.hazards??[],width:t,height:i,tiles:n,entities:{enemies:[],npcs:[],items:[]}}},vr=(e,t)=>{const i=[...e.tiles];for(const s of t)s.y>=0&&s.y<e.height&&s.x>=0&&s.x<e.width&&(i[s.y][s.x]={...i[s.y][s.x],type:D.WALL,isWalkable:!1});return{...e,tiles:i}},br=(e,t)=>{const i=[...e.tiles];for(const s of t)s.y>=0&&s.y<e.height&&s.x>=0&&s.x<e.width&&(i[s.y][s.x]={...i[s.y][s.x],type:D.COVER,provideCover:!0,isWalkable:!0});return{...e,tiles:i}},wr=(e,t,i)=>{if(!je(t,e))return e;const s=e.tiles.map((n,a)=>n.map((r,o)=>a===t.y&&o===t.x?{...r,cover:{...i},provideCover:!0}:r));return{...e,tiles:s}},je=(e,t)=>e.x>=0&&e.x<t.width&&e.y>=0&&e.y<t.height,ke=(e,t,i,s=[],n={})=>{if(!je(e,t))return!1;const a=t.tiles[e.y][e.x];if(!a.isWalkable||i&&a.skillRequirement&&Xi(i,a.skillRequirement.skill)<a.skillRequirement.threshold)return!1;const{npcs:r=[],ignoreNpcIds:o=[]}=n;return!(i&&i.position.x===e.x&&i.position.y===e.y||s.some(l=>l.position.x===e.x&&l.position.y===e.y)||r.some(l=>!o.includes(l.id)&&l.position.x===e.x&&l.position.y===e.y))},Hn=(e,t,i,s=[])=>[{x:e.x+1,y:e.y},{x:e.x-1,y:e.y},{x:e.x,y:e.y+1},{x:e.x,y:e.y-1}].filter(a=>ke(a,t,i,s)),es=(e,t,i,s=[])=>{if(ke(e,t,i,s))return e;const n=new Set,a=[e],r=l=>`${l.x},${l.y}`;n.add(r(e));const o=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}];for(;a.length>0;){const l=a.shift();if(!l)break;for(const c of o){const d={x:l.x+c.x,y:l.y+c.y},u=r(d);if(!n.has(u)&&(n.add(u),!!je(d,t))){if(ke(d,t,i,s))return d;a.push(d)}}}return null},Se=(e,t)=>e.perks.includes(t),Pr=e=>e?e.range>1:!1,Mr=e=>Se(e,"steadyHands")?.1:0,Ar=e=>Se(e,"toughness")?3:0,ts=e=>Se(e,"gunFu")?e.perkRuntime.gunFuShotsThisTurn<=0:!1,xr=e=>Se(e,"gunFu")?{...e,perkRuntime:{...e.perkRuntime,gunFuShotsThisTurn:e.perkRuntime.gunFuShotsThisTurn+1}}:e,Ir=e=>Se(e,"gunFu")?{...e,perkRuntime:{...e.perkRuntime,gunFuShotsThisTurn:0}}:e,li=e=>Se(e,"adrenalineRush")?(e.maxHealth>0?e.health/e.maxHealth:0)<=.3&&e.perkRuntime.adrenalineRushTurnsRemaining<=0:!1,ci=e=>Se(e,"adrenalineRush")?{...e,actionPoints:Math.min(e.actionPoints+2,e.maxActionPoints+2),perkRuntime:{...e.perkRuntime,adrenalineRushTurnsRemaining:3}}:e,Cr=e=>{if(!Se(e,"adrenalineRush"))return e;const t=Math.max(0,e.perkRuntime.adrenalineRushTurnsRemaining-1);return{...e,actionPoints:Math.min(e.actionPoints+2,e.maxActionPoints+2),perkRuntime:{...e.perkRuntime,adrenalineRushTurnsRemaining:t}}},kr=e=>!Se(e,"ghost")||e.perkRuntime.ghostInvisibilityTurns<=0?e:{...e,perkRuntime:{...e.perkRuntime,ghostInvisibilityTurns:Math.max(0,e.perkRuntime.ghostInvisibilityTurns-1)}},is=e=>{const t={strengthBonus:0,perceptionBonus:0,enduranceBonus:0,charismaBonus:0,intelligenceBonus:0,agilityBonus:0,luckBonus:0,totalArmorRating:0,totalAPPenalty:0,totalDamageBonus:0},{weapon:i,armor:s}=e.equipped;return i&&i.statModifiers&&Ts(t,i.statModifiers),s&&(t.totalArmorRating+=s.protection||0,s.statModifiers&&Ts(t,s.statModifiers)),t};function Ts(e,t){e.strengthBonus=(e.strengthBonus||0)+(t.strengthBonus||0),e.perceptionBonus=(e.perceptionBonus||0)+(t.perceptionBonus||0),e.enduranceBonus=(e.enduranceBonus||0)+(t.enduranceBonus||0),e.charismaBonus=(e.charismaBonus||0)+(t.charismaBonus||0),e.intelligenceBonus=(e.intelligenceBonus||0)+(t.intelligenceBonus||0),e.agilityBonus=(e.agilityBonus||0)+(t.agilityBonus||0),e.luckBonus=(e.luckBonus||0)+(t.luckBonus||0),e.totalArmorRating=(e.totalArmorRating||0)+(t.armorRating||0),e.totalAPPenalty=(e.totalAPPenalty||0)+(t.apPenalty||0),e.totalDamageBonus=(e.totalDamageBonus||0)+(t.damageBonus||0)}const Tr=(e,t)=>({strength:e.strength+(t.strengthBonus||0),perception:e.perception+(t.perceptionBonus||0),endurance:e.endurance+(t.enduranceBonus||0),charisma:e.charisma+(t.charismaBonus||0),intelligence:e.intelligence+(t.intelligenceBonus||0),agility:e.agility+(t.agilityBonus||0),luck:e.luck+(t.luckBonus||0)}),Rr=e=>is(e).totalArmorRating+Ar(e),Er=(e,t)=>{const i=t.totalAPPenalty||0,s=e-i;return Math.max(1,Math.floor(s))},_r=(e,t,i=0)=>e+(t.totalDamageBonus||0)+i,Dr=(e,t)=>{const i=e-t;return Math.max(1,i)},ss=e=>{const{strength:t,perception:i,endurance:s,charisma:n,intelligence:a,agility:r,luck:o}=e;return{maxHP:50+s*10,baseAP:6+Math.floor((r-5)*.5),maxStamina:50+s*5,carryWeight:25+t*5,criticalChance:5+i*2+o*2,dialogueThresholdBonus:Math.floor(n/2),skillPointsPerLevel:3+Math.floor(a/3),hitChanceModifier:(i-5)*3,dodgeChance:(r-5)*2,meleeDamageBonus:Math.floor(t/2)}},at=e=>50+e*10,rt=e=>6+Math.floor((e-5)*.5),ye=e=>50+e*5,ot=e=>25+e*5,up=(e,t,i=0)=>!Number.isFinite(e)||!Number.isFinite(t)||!Number.isFinite(i)?(console.warn("[StatCalculations] Invalid skill check parameters:",{attributeValue:e,threshold:t,bonus:i}),!1):e+i>=t,Lr=e=>{const t=is(e),i=Tr(e.skills,t),s=ss(i),n=Er(s.baseAP,t);return{...s,baseAP:n}},Fr=(e,t,i)=>Number.isNaN(e)||!Number.isFinite(e)?0:Math.max(t,Math.min(i,Math.round(e))),ae=e=>Fr(e,-100,100),de=[{id:"hostile",label:"Hostile",min:-100,max:-61,color:"#ef4444",icon:"⚠️"},{id:"unfriendly",label:"Unfriendly",min:-60,max:-20,color:"#f97316",icon:"⚠"},{id:"neutral",label:"Neutral",min:-19,max:19,color:"#94a3b8",icon:"•"},{id:"friendly",label:"Friendly",min:20,max:59,color:"#4ade80",icon:"★"},{id:"allied",label:"Allied",min:60,max:100,color:"#facc15",icon:"✪"}],Wn=de.reduce((e,t)=>(e[t.id]=t,e),{hostile:de[0],unfriendly:de[1],neutral:de[2],friendly:de[3],allied:de[4]}),be=e=>{const t=ae(e);for(const i of de)if(t>=i.min&&t<=i.max)return i;return Wn.neutral},hp=e=>be(e),Br=e=>{const t=be(e),i=de.findIndex(n=>n.id===t.id);if(i<0||i===de.length-1)return null;const s=de[i+1];return{standing:s,requiredValue:s.min}},Fe={resistance:{definition:{id:"resistance",name:"Resistance",description:"Anti-regime saboteurs coordinating from hidden cells throughout the slums.",rivalId:"corpsec",defaultReputation:10},effects:{hostile:["Resistance ambush teams hunt you on sight.","Safe houses barred and support staff evacuate when you enter a cell."],unfriendly:["Handlers refuse new operations and keep patrol intel off the record.","Markets charge +50% and watchers shadow your movements."],neutral:["Standard trade access with baseline mission availability."],friendly:["Safe house quartermasters grant -25% discounts.","Resistance fire teams can reinforce nearby encounters.","Access to special sabotage contracts."],allied:["Leadership shares prototype gear and strategic intel.","Full access to command safe houses and staging areas.","Resistance commits strike units to the final mission."]}},corpsec:{definition:{id:"corpsec",name:"CorpSec",description:"Corporate security forces enforcing curfew and regime edicts downtown.",rivalId:"resistance",defaultReputation:-20},effects:{hostile:["CorpSec strike teams engage immediately and post bounties.","Checkpoints sealed; city travel heavily restricted."],unfriendly:["CorpSec enforcers tail you and random searches increase.","Vendor prices +50% and contracts withdrawn."],neutral:["Standard patrol scrutiny with access to routine contracts."],friendly:["Access to restricted checkpoints and heavy weapon requisitions.","CorpSec officers provide enforcement support nearby."],allied:["CorpSec elevates you to trusted asset status.","Elite armories and armored escorts unlocked for the endgame assault."]}},scavengers:{definition:{id:"scavengers",name:"Scavengers",description:"Resourceful traders running the black markets threading the slums and tunnels.",defaultReputation:0},effects:{hostile:["Black market shuts you out and bounty hunters look to cash in."],unfriendly:["Merchants hike prices by 50% and fence only low-tier goods.","Rumours and location intel dry up."],neutral:["Regular trade access with standard supply lists."],friendly:["Negotiated prices drop 25% and rare stock appears more often.","Vehicle parts and crafting materials offered reliably."],allied:["Exclusive caches, contraband routes, and crew hire options unlocked.","Scavengers lend munitions support during the finale."]}}},pp=e=>Fe[e],Or=()=>Object.values(Fe).map(e=>e.definition),Nr=(e,t)=>Fe[e].effects[t],Hr=e=>{const t={resistance:Fe.resistance.definition.defaultReputation,corpsec:Fe.corpsec.definition.defaultReputation,scavengers:Fe.scavengers.definition.defaultReputation};return e?{resistance:ae(e.resistance??t.resistance),corpsec:ae(e.corpsec??t.corpsec),scavengers:ae(e.scavengers??t.scavengers)}:t},Wr=-70,Gr=60,qr=.5,Gn=(e,t,i)=>{const s=Hr(e),n=[],a=ae(e[t]??s[t]),r=be(a),o=ae(a+i),l=be(o);s[t]=o,l.id!==r.id&&n.push({factionId:t,previousStanding:r.id,nextStanding:l.id});const c={},d=Fe[t].definition.rivalId;if(d){const u=ae(e[d]??s[d]),h=be(u),g=-Math.round(i*qr);if(g!==0){const m=ae(u+g),p=m-u;if(p!==0){s[d]=m,c[d]=p;const v=be(m);v.id!==h.id&&n.push({factionId:d,previousStanding:h.id,nextStanding:v.id})}}if(o>=Gr){const m=ae(Wr);if(s[d]>m){const p=be(s[d]),v=m-s[d];s[d]=m,c[d]=(c[d]??0)+v;const S=be(s[d]);S.id!==p.id&&n.push({factionId:d,previousStanding:p.id,nextStanding:S.id})}}}return{values:s,primaryDelta:o-a,rivalDeltas:c,standingChanges:n}},Vr=(e,t,i)=>{const s=ae(e[t]);return Gn(e,t,ae(i)-s)},mp=(e,t)=>{const i=be(t);return{value:t,standing:i,effects:Nr(e,i.id),nextThreshold:Br(t)}},gp=e=>de.findIndex(t=>t.id===e),zr={en:{hostile:"Hostile",unfriendly:"Unfriendly",neutral:"Neutral",friendly:"Friendly",allied:"Allied"},uk:{hostile:"Ворог",unfriendly:"Недружній",neutral:"Нейтральний",friendly:"Союзний",allied:"Союз"}},fp=(e,t)=>{var i;return((i=zr[e])==null?void 0:i[t])??Wn[t].label},Pt={strength:5,perception:5,endurance:5,charisma:5,intelligence:5,agility:5,luck:5},Rs=at(Pt.endurance),Es=rt(Pt.agility),Ur=ot(Pt.strength),_s=ye(Pt.endurance),Kr=Or().reduce((e,t)=>(e[t.id]=t.defaultReputation,e),{resistance:0,corpsec:0,scavengers:0}),jr=()=>({smallGuns:0,energyWeapons:0,meleeCombat:0,explosives:0,hacking:0,engineering:0,science:0,medicine:0,stealth:0,scavenging:0,persuasion:0,intimidation:0,barter:0}),jt=()=>({alignment:"earnest",flags:{earnest:1,sarcastic:0,ruthless:0,stoic:0},lastUpdated:0}),Q={id:oe(),name:"Player",position:{x:3,y:1},facing:"south",coverOrientation:null,suppression:0,health:Rs,maxHealth:Rs,actionPoints:Es,maxActionPoints:Es,stamina:_s,maxStamina:_s,isExhausted:!1,movementProfile:"normal",stealthModeEnabled:!1,stealthCooldownExpiresAt:null,skills:Pt,skillTraining:jr(),taggedSkillIds:[],level:1,experience:0,credits:0,skillPoints:0,attributePoints:0,backgroundId:void 0,perks:[],pendingPerkSelections:0,karma:0,personality:jt(),factionReputation:{...Kr},appearancePreset:void 0,inventory:{items:[],maxWeight:Ur,currentWeight:0,hotbar:[null,null,null,null,null]},equipped:{weapon:void 0,armor:void 0,accessory:void 0,secondaryWeapon:void 0,meleeWeapon:void 0,bodyArmor:void 0,helmet:void 0,accessory1:void 0,accessory2:void 0},equippedSlots:{},activeWeaponSlot:"primaryWeapon",perkRuntime:{gunFuShotsThisTurn:0,adrenalineRushTurnsRemaining:0,ghostInvisibilityTurns:0,ghostConsumed:!1},encumbrance:{level:"normal",percentage:0,movementApMultiplier:1,attackApMultiplier:1}},ns=e=>e<=1?0:Math.floor(100*e*(1+e*.15)),$r=e=>3+Math.floor(e/3),Yr=e=>e>0,Zr=e=>e>0&&e%2===0,Xr=(e,t)=>{const i=ns(t+1);return e>=i},Qr=e=>{let t=0,i=0,s=0,n=0;const a={...e};for(;Xr(a.experience,a.level);){const r=ns(a.level+1);a.experience-=r,a.level+=1,t++;const o=$r(a.skills.intelligence);i+=o,Yr(a.level)&&s++,Zr(a.level)&&n++,a.maxHealth+=5,a.health=a.maxHealth,a.maxStamina=ye(a.skills.endurance),a.stamina=a.maxStamina,a.isExhausted=!1,a.level%5===0&&(a.maxActionPoints+=1,a.actionPoints=a.maxActionPoints)}return{player:a,levelsGained:t,skillPointsAwarded:i,attributePointsAwarded:s,perksUnlocked:n}},Jr=(e,t)=>({...e,experience:Math.max(0,e.experience+t)}),yp=(e,t)=>{const i=ns(t+1);return`${e} / ${i} XP`},eo=[{id:"corpsec_defector",name:"Corpsec Defector",tagline:"Turned the regime’s training against them.",description:["Former security officer who leaked patrol routes until the alarms sounded on you.","You know their formations by heart and still dream in evac sirens."],factionAdjustments:{resistance:10,corpsec:-20},startingEquipment:[{type:"catalog",definitionId:"weapon_corpsec_service_pistol",equip:!0},{type:"catalog",definitionId:"armor_kevlar_vest",equip:!0},{type:"catalog",definitionId:"misc_corpsec_credentials"},{type:"catalog",definitionId:"consumable_basic_repair_kit",quantity:1}]},{id:"street_urchin",name:"Street Urchin",tagline:"Raised by alleys, guided by whispers.",description:["You hustled the markets since curfew was a bedtime story.","Lockpicks, fast feet, and favor debts keep you breathing."],factionAdjustments:{scavengers:10},startingEquipment:[{type:"catalog",definitionId:"weapon_shiv_knife",equip:!0},{type:"catalog",definitionId:"armor_layered_leather_jacket",equip:!0},{type:"catalog",definitionId:"misc_lockpick_set"},{type:"catalog",definitionId:"consumable_basic_repair_kit",quantity:1}]},{id:"underground_hacker",name:"Underground Hacker",tagline:"Screensaver by day, blackout by night.",description:["Your code toppled curfew drones before dawn.","Signal ghosts and failsafe exploits follow in your wake."],factionAdjustments:{resistance:15,corpsec:-10},startingEquipment:[{type:"catalog",definitionId:"misc_custom_deck"},{type:"catalog",definitionId:"misc_emp_charge"},{type:"catalog",definitionId:"armor_utility_hoodie",equip:!0},{type:"catalog",definitionId:"consumable_basic_repair_kit",quantity:1}]},{id:"wasteland_scavenger",name:"Wasteland Scavenger",tagline:"Dust lungs, steady hands, endless caches.",description:["You crossed toxic badlands with nothing but a crowbar and spite.","Trade routes and buried caches live in your head like lullabies."],factionAdjustments:{scavengers:10,resistance:5},startingEquipment:[{type:"catalog",definitionId:"weapon_industrial_crowbar",equip:!0},{type:"catalog",definitionId:"misc_gas_mask"},{type:"catalog",definitionId:"consumable_field_medkit",quantity:1},{type:"catalog",definitionId:"consumable_basic_repair_kit",quantity:1}]}],to=Object.fromEntries(eo.map(e=>[e.id,e])),Ds={damageMultiplier:1,hitChanceBonus:0,critChanceBonus:0,magazineSizeMultiplier:1,silenced:!1},$t=(e,t)=>e?(t??e.attachedMods??[]).reduce((s,n)=>{var a,r;try{const l=bt(n.modId).effect;l.damageMultiplier!==void 0&&(s.damageMultiplier*=l.damageMultiplier),l.hitChanceBonus!==void 0&&(s.hitChanceBonus+=l.hitChanceBonus),l.hitChancePenalty!==void 0&&(s.hitChanceBonus-=l.hitChancePenalty),l.critChanceBonus!==void 0&&(s.critChanceBonus+=l.critChanceBonus),l.magazineSizeMultiplier!==void 0&&(s.magazineSizeMultiplier*=l.magazineSizeMultiplier),l.armorPiercingFactor!==void 0&&(s.armorPiercingFactor=s.armorPiercingFactor!==void 0?Math.min(s.armorPiercingFactor,l.armorPiercingFactor):l.armorPiercingFactor),(l.silenced||(a=l.addTags)!=null&&a.includes("silenced"))&&(s.silenced=!0),(r=l.addTags)!=null&&r.includes("armorPiercing")&&(s.armorPiercingFactor=s.armorPiercingFactor??.5)}catch{}return s},{...Ds}):{...Ds},Sp=(e,t,i)=>{if(!e)return{compatible:!1,reason:"Weapon not found"};if(!(e.modSlots??[]).includes(i))return{compatible:!1,reason:"This weapon has no matching slot."};const n=bt(t);if(n.slot!==i)return{compatible:!1,reason:"Mod slot mismatch."};const a=e.weaponType??"pistol";return n.compatibleWeaponTypes.includes(a)?{compatible:!0}:{compatible:!1,reason:"Not compatible with this weapon type."}},io=(e,t)=>({id:oe(),amount:e,reason:t}),so=(e,t,i,s)=>({newLevel:e,skillPointsEarned:t,attributePointsEarned:i,perksUnlocked:s}),di=1e-4,no={normal:{movement:1,attack:1},heavy:{movement:1.25,attack:1.1,warning:"Pack weight is slowing you. You will bleed AP if you keep hauling this much."},overloaded:{movement:2,attack:1.25,warning:"Overloaded. Movement now chews double AP until you off-load gear."},immobile:{movement:Number.POSITIVE_INFINITY,attack:Number.POSITIVE_INFINITY,warning:"You are pinned by your gear. Drop items before you can move or fight."}},ao=e=>!Number.isFinite(e)||Number.isNaN(e)?0:Math.max(0,Math.round(e*100)/100),ro=e=>e>=120-di?"immobile":e>=100-di?"overloaded":e>=80-di?"heavy":"normal",oo=(e,t,i)=>{const s=t<=0?1:t,n=e/s*100,a=ao(n),r=ro(a),o=no[r],l=o.warning??((i==null?void 0:i.level)===r?i==null?void 0:i.warning:void 0);return{level:r,percentage:a,movementApMultiplier:o.movement,attackApMultiplier:o.attack,warning:l}},lo=e=>e.level==="immobile"||e.movementApMultiplier===Number.POSITIVE_INFINITY,vp={sprintTile:2,strenuousInteraction:1},co=3,uo=.3,ho=.4,Ue=(e,t)=>!Number.isFinite(e)||!Number.isFinite(t)||t<=0||e<0?0:e>t?t:e,qn=(e,t)=>!Number.isFinite(e)||!Number.isFinite(t)||t<=0?0:Math.max(0,Math.min(1,e/t)),po=(e,t)=>qn(e,t)<uo,mo=(e,t)=>qn(e,t)>ho,lt=(e,t)=>{var i;return((i=e==null?void 0:e.tags)==null?void 0:i.includes(t))??!1},ui=e=>lt(e,"twoHanded"),mt=2,ki=()=>{const e={...Q,id:oe(),position:{...Q.position},skills:{...Q.skills},skillTraining:{...Q.skillTraining},taggedSkillIds:[...Q.taggedSkillIds],inventory:{items:[],maxWeight:Q.inventory.maxWeight,currentWeight:0,hotbar:[null,null,null,null,null]},karma:Q.karma,personality:jt(),equipped:{weapon:void 0,armor:void 0,accessory:void 0,secondaryWeapon:void 0,meleeWeapon:void 0,bodyArmor:void 0,helmet:void 0,accessory1:void 0,accessory2:void 0},equippedSlots:{},activeWeaponSlot:"primaryWeapon",factionReputation:{...Q.factionReputation},perks:[...Q.perks],pendingPerkSelections:Q.pendingPerkSelections,backgroundId:void 0,appearancePreset:Q.appearancePreset,perkRuntime:{...Q.perkRuntime},encumbrance:{level:"normal",percentage:0,movementApMultiplier:1,attackApMultiplier:1}};return He(e),We(e),e},z={version:mt,data:ki(),pendingLevelUpEvents:[],xpNotifications:[],pendingFactionEvents:[]},Ee=e=>Math.max(1,Math.min(10,Math.round(e))),go=e=>Math.round(e*100)/100,Ti=5,fo=["primaryWeapon","secondaryWeapon","meleeWeapon","bodyArmor","helmet","accessory1","accessory2"],yo=20,So=e=>e.primaryDelta!==0||Object.values(e.rivalDeltas).some(t=>t!==0)||e.standingChanges.length>0,vo=(e,t)=>{e.pendingFactionEvents.push(t),e.pendingFactionEvents.length>yo&&e.pendingFactionEvents.shift()},Ls=(e,t,i,s)=>{So(i)&&vo(e,{factionId:t,delta:i.primaryDelta,updatedValue:e.data.factionReputation[t],rivalDeltas:i.rivalDeltas,standingChanges:i.standingChanges,reason:s==null?void 0:s.reason,source:s==null?void 0:s.source,timestamp:Date.now()})};function Ve(e){if(!Number.isFinite(e.maxStamina)||e.maxStamina<=0){e.maxStamina=0,e.stamina=0,e.isExhausted=!1;return}if(e.stamina=Ue(e.stamina,e.maxStamina),po(e.stamina,e.maxStamina)){e.isExhausted=!0;return}if(e.isExhausted&&mo(e.stamina,e.maxStamina)){e.isExhausted=!1;return}!e.isExhausted&&e.stamina>=e.maxStamina&&(e.isExhausted=!1)}function _e(e,t,i={}){const s=i.preserveRatio??!0,n=Number.isFinite(t)&&t>0?Math.floor(t):0,a=Number.isFinite(e.maxStamina)&&e.maxStamina>0?e.maxStamina:0;let r;if(!s||a===0||n===0)r=n;else{const o=Math.max(0,Math.min(1,Ue(e.stamina,a)/a));r=Math.floor(n*o)}e.maxStamina=n,e.stamina=n===0?0:Ue(r,n),Ve(e)}function He(e){(!Number.isFinite(e.maxStamina)||e.maxStamina<0)&&(e.maxStamina=ye(e.skills.endurance)),Number.isFinite(e.stamina)?e.stamina=Ue(e.stamina,e.maxStamina):e.stamina=e.maxStamina,typeof e.isExhausted!="boolean"&&(e.isExhausted=!1),Ve(e)}const as=e=>{const t=e?[...e]:[];for(;t.length<Ti;)t.push(null);return t.slice(0,Ti)},ni=e=>{if(!e)return 0;if(!e.stackable)return 1;const t=e.quantity??1;return!Number.isFinite(t)||t<=0?1:Math.floor(t)},bo=e=>typeof globalThis.structuredClone=="function"?globalThis.structuredClone(e):JSON.parse(JSON.stringify(e));function We(e){e.movementProfile!=="silent"&&e.movementProfile!=="sprint"&&(e.movementProfile="normal"),typeof e.stealthModeEnabled!="boolean"&&(e.stealthModeEnabled=!1),e.stealthCooldownExpiresAt!==null&&(!Number.isFinite(e.stealthCooldownExpiresAt)||e.stealthCooldownExpiresAt<0)&&(e.stealthCooldownExpiresAt=null)}const Vn=e=>e.damage!==void 0,zn=e=>e.protection!==void 0,wo=(e,t)=>{const i=new Set,s=[],n=(a,r)=>{if(!a||i.has(a.id)||!a.durability)return;const o=a.durability.max;if(!Number.isFinite(o)||o<=0)return;const l=a.durability.current;if(l>=o||t==="weapon"&&!Vn(a)||t==="armor"&&!zn(a))return;const c=l<=0?0:Math.max(0,Math.min(1,l/o));i.add(a.id),s.push({item:a,ratio:c,equipped:r})};return n(e.equipped.weapon,!0),n(e.equipped.secondaryWeapon,!0),n(e.equipped.meleeWeapon,!0),n(e.equipped.bodyArmor,!0),n(e.equipped.helmet,!0),e.equippedSlots&&Object.values(e.equippedSlots).forEach(a=>n(a,!0)),e.inventory.items.forEach(a=>n(a,!1)),s},Po=(e,t)=>{var s;const i=wo(e,t);return i.length===0?null:(i.sort((n,a)=>n.ratio!==a.ratio?n.ratio-a.ratio:n.equipped!==a.equipped?n.equipped?-1:1:0),((s=i[0])==null?void 0:s.item.id)??null)},Mo=e=>{if(e.equipSlot)return e.equipSlot;const t=e;return(Number.isFinite(t.range)?t.range:0)<=1||t.skillType==="meleeCombat"?"meleeWeapon":"primaryWeapon"},he=(e,t)=>{if(!e)return e;const i={...e};if(Vn(i)){const s=i.durability,n=Number.isFinite(s==null?void 0:s.max)&&((s==null?void 0:s.max)??0)>0?Math.round(s.max):100,a=Number.isFinite(s==null?void 0:s.current)?Math.max(0,Math.round(s.current)):n;i.durability={max:n,current:Math.min(n,a)},i.equipSlot=t??Mo(i)}else if(zn(i)){const s=i.durability,n=Number.isFinite(s==null?void 0:s.max)&&((s==null?void 0:s.max)??0)>0?Math.round(s.max):120,a=Number.isFinite(s==null?void 0:s.current)?Math.max(0,Math.round(s.current)):n;i.durability={max:n,current:Math.min(n,a)},i.equipSlot=t??"bodyArmor"}else t&&(i.equipSlot=t);if(i.stackable){const s=ni(i)||1;i.quantity=s,(!Number.isFinite(i.maxStack)||i.maxStack===void 0||i.maxStack<=0)&&(i.maxStack=Math.max(5,s))}else delete i.quantity,delete i.maxStack;return Number.isFinite(i.weight)||(i.weight=0),Number.isFinite(i.value)||(i.value=0),i},Ao=e=>{const t=e.reduce((i,s)=>{const n=Number.isFinite(s.weight)?s.weight:0;return i+n*ni(s)},0);return go(t)},re=e=>{e.inventory.items=e.inventory.items.map(s=>he(s)??s);const t=Ao(e.inventory.items),i=as(e.inventory.hotbar);e.inventory={...e.inventory,currentWeight:t,hotbar:i},e.encumbrance=oo(e.inventory.currentWeight,e.inventory.maxWeight,e.encumbrance)},xo=(e,t)=>e.inventory.items.reduce((i,s)=>{if(s.definitionId!==t)return i;const n=s.stackable?s.quantity??1:1;return i+n},0),Io=(e,t,i)=>{if(i<=0)return!0;let s=i;return e.inventory.items=e.inventory.items.reduce((n,a)=>{if(s<=0||a.definitionId!==t)return n.push(a),n;if(a.stackable){const r=a.quantity??1;return r>s?(n.push({...a,quantity:r-s}),s=0):s-=r,n}return s-=1,s<0&&(s=0),n},[]),re(e),s===0},Co=(e,t)=>{if(t.find(s=>xo(e,s.id)<s.quantity))return!1;for(const s of t)if(!Io(e,s.id,s.quantity))return!1;return!0},rs=(e,t)=>{const i=e.inventory.items.findIndex(n=>n.id===t);if(i===-1)return;const[s]=e.inventory.items.splice(i,1);return s},Un=(e,t)=>t||(e.equipSlot?e.equipSlot:"damage"in e?"primaryWeapon":"protection"in e?"bodyArmor":null),Yt=e=>e.modSlots?e.modSlots:(e.weaponType??"pistol")==="melee"?[]:["barrel","magazine","optics"],Kn=e=>{const t=e.magazineSize??0;if(t<=0)return e;const i=$t(e),s=Math.max(1,Math.round(t*(i.magazineSizeMultiplier??1))),n=e.currentMagazine??s;return{...e,currentMagazine:Math.max(0,Math.min(s,n))}},ko=(e,t)=>{const i=[...e.attachedMods??[]],s=i.findIndex(a=>a.slot===t);if(s===-1)return{updated:{...e,modSlots:Yt(e)}};const[n]=i.splice(s,1);return{updated:{...e,attachedMods:i,modSlots:Yt(e),currentMagazine:Kn(e).currentMagazine},detachedModId:n.modId}},To=(e,t)=>{const i=bt(t),s=Yt(e),n=[...e.attachedMods??[]],a=n.findIndex(o=>o.slot===i.slot);let r;return a!==-1&&(r=n[a].modId,n.splice(a,1)),n.push({slot:i.slot,modId:t}),{updated:{...e,attachedMods:n,modSlots:s,currentMagazine:Kn(e).currentMagazine},replacedModId:r}},Ro=(e,t)=>{var l;const i=bt(t.modId),s=t.feePaid??0;if(i.crafting.station==="workbench"&&!t.atWorkbench||s>0&&e.credits<s)return!1;const n=((l=e.skillTraining)==null?void 0:l.engineering)??0;if(!Number.isFinite(n)||n<i.crafting.level)return!1;const a=i.crafting.inputs.map(c=>({id:c.id,quantity:c.quantity}));if(!Co(e,a))return!1;s>0&&(e.credits-=s);const o=ti(t.modId);return e.inventory.items.push(o),re(e),!0},Ce=(e,t,i)=>{switch(t){case"primaryWeapon":e.equipped.weapon=i;break;case"secondaryWeapon":e.equipped.secondaryWeapon=i;break;case"meleeWeapon":e.equipped.meleeWeapon=i;break;case"bodyArmor":e.equipped.bodyArmor=i,e.equipped.armor=i;break;case"helmet":e.equipped.helmet=i;break;case"accessory1":e.equipped.accessory1=i;break;case"accessory2":e.equipped.accessory2=i;break}e.equippedSlots||(e.equippedSlots={}),i?e.equippedSlots[t]=i:e.equippedSlots&&delete e.equippedSlots[t]},ht=(e,t)=>{if(e.equippedSlots&&e.equippedSlots[t])return e.equippedSlots[t];switch(t){case"primaryWeapon":return e.equipped.weapon;case"secondaryWeapon":return e.equipped.secondaryWeapon;case"meleeWeapon":return e.equipped.meleeWeapon;case"bodyArmor":return e.equipped.bodyArmor??e.equipped.armor;case"helmet":return e.equipped.helmet;case"accessory1":return e.equipped.accessory1;case"accessory2":return e.equipped.accessory2;default:return}},Zt=e=>{const t={...e},i=e;return Array.isArray(i.attachedMods)&&(t.attachedMods=[...i.attachedMods]),t},Mt=(e,t)=>{const i=e.inventory.items.findIndex(s=>s.id===t);if(i!==-1)return{location:"inventory",item:e.inventory.items[i],index:i};for(const s of fo){const n=ht(e,s);if(n&&n.id===t)return{location:"equipped",item:n,slot:s}}},jn=(e,t,i)=>{if(t.location==="inventory"){e.inventory.items[t.index]=i;return}Ce(e,t.slot,i),e.equippedSlots&&(e.equippedSlots[t.slot]=i)},hi=(e,t)=>{const{itemId:i,slot:s}=t,n=e.inventory.items.find(c=>c.id===i);if(!n||n.isQuestItem||n.stackable||n.durability&&n.durability.current<=0)return!1;const a=Un(n,s);if(!a)return!1;const r="damage"in n?n:void 0;if(a==="secondaryWeapon"){if(r&&ui(r))return!1;const c=ht(e,"primaryWeapon");if(ui(c))return!1}const o=rs(e,i);if(!o)return!1;const l=ht(e,a);if(l&&e.inventory.items.push(Zt(l)),a==="primaryWeapon"&&"damage"in o&&ui(o)){const c=ht(e,"secondaryWeapon");c&&(e.inventory.items.push(Zt(c)),Ce(e,"secondaryWeapon",void 0),e.activeWeaponSlot==="secondaryWeapon"&&(e.activeWeaponSlot="primaryWeapon"))}return Ce(e,a,o),(a==="primaryWeapon"||a==="secondaryWeapon"||a==="meleeWeapon")&&(e.activeWeaponSlot=a),re(e),!0},pi=(e,t)=>{const{slot:i}=t,s=ht(e,i);return s?(e.inventory.items.push(Zt(s)),Ce(e,i,void 0),i===e.activeWeaponSlot&&(e.activeWeaponSlot="primaryWeapon"),re(e),!0):!1},$n=(e,t)=>{const{itemId:i,amount:s}=t;if(!Number.isFinite(s)||s<=0)return!1;const n=Mt(e,i);if(!n||!n.item.durability)return!1;const a=Math.floor(s),r=n.item.durability;return r.current=Math.min(r.max,r.current+a),n.location==="equipped"&&Ce(e,n.slot,n.item),!0},Eo=(e,t)=>{const{itemId:i,quantity:s}=t;if(!Number.isFinite(s)||s<=0)return;const n=Mt(e,i);if(!n||n.location!=="inventory")return;const a=n.item;if(!a.stackable)return;const r=ni(a),o=Math.floor(s);if(o>=r)return;const l=Zt(a);l.id=oe(),l.quantity=o;const c=r-o;return a.quantity=c<=1?void 0:c,a.quantity===void 0&&delete a.quantity,e.inventory.items.push(l),re(e),l},_o=(e,t)=>{const{slotIndex:i,itemId:s}=t;if(!Number.isInteger(i)||i<0||i>=Ti)return!1;if(e.inventory.hotbar=as(e.inventory.hotbar),s!==null){const n=Mt(e,s);if(!n||n.location!=="inventory")return!1;e.inventory.hotbar=e.inventory.hotbar.map((a,r)=>a===s&&r!==i?null:a),e.inventory.hotbar[i]=s}else e.inventory.hotbar[i]=null;return!0},Do=(e,t)=>{const{weaponId:i,modItemId:s}=t,n=Mt(e,i);if(!n||!("damage"in n.item))return!1;const a=n.item,r=e.inventory.items.find(m=>m.id===s&&m.weaponModId);if(!r||!r.weaponModId)return!1;const o=r.weaponModId,l=bt(o),c=a.weaponType??"pistol";if(!Yt(a).includes(l.slot)||!l.compatibleWeaponTypes.includes(c)||!rs(e,s))return!1;const{updated:h,replacedModId:g}=To(a,o);return g&&e.inventory.items.push(ti(g)),jn(e,n,h),re(e),!0},Lo=(e,t)=>{const{weaponId:i,slot:s}=t,n=Mt(e,i);if(!n||!("damage"in n.item))return!1;const a=n.item,{updated:r,detachedModId:o}=ko(a,s);return o?(e.inventory.items.push(ti(o)),jn(e,n,r),re(e),!0):!1},Fo=(e,t)=>{e.inventory.hotbar=as(e.inventory.hotbar);const i=e.inventory.items.findIndex(c=>c.id===t);if(i===-1)return!1;const s=e.inventory.items[i];if(!s||!("effect"in s))return!1;const n=s,a=n.effect;let r=null,o=0;if(a.type==="repair"&&(o=Math.floor(a.value??0),o<=0||(r=Po(e,a.target??"any"),!r)))return!1;let l=!1;if(s.stackable){const c=ni(s);if(c<=1)e.inventory.items.splice(i,1),l=!0;else{const d=c-1;d<=1?delete n.quantity:n.quantity=d}}else e.inventory.items.splice(i,1),l=!0;switch(l&&(e.inventory.hotbar=e.inventory.hotbar.map(c=>c===t?null:c)),a.type){case"health":{const c=Number.isFinite(a.value)?a.value:0;e.health=Math.min(e.maxHealth,Math.max(0,e.health+c));break}case"actionPoints":{const c=Number.isFinite(a.value)?a.value:0;e.actionPoints=Math.min(e.maxActionPoints,Math.max(0,e.actionPoints+c));break}case"stat":{if(a.statAffected){const c=e.skills[a.statAffected]??0,d=Number.isFinite(a.value)?a.value:0;e.skills[a.statAffected]=c+d}break}case"repair":{r&&$n(e,{itemId:r,amount:o});break}}return re(e),!0},Bo=(e,t)=>{switch(t.type){case"catalog":{const i=ti(t.definitionId,{quantity:t.quantity,durability:t.durability});if(t.equip){const s=Un(i);if(s){Ce(e,s,i),(s==="primaryWeapon"||s==="secondaryWeapon"||s==="meleeWeapon")&&(e.activeWeaponSlot=s);break}}e.inventory.items.push(i);break}case"weapon":{const i=Ja(t.name,t.damage,t.range,t.apCost,t.weight,t.statModifiers,t.skillType);t.equip?Ce(e,"primaryWeapon",i):e.inventory.items.push(i);break}case"armor":{const i=Qa(t.name,t.protection,t.weight,t.statModifiers);t.equip?Ce(e,"bodyArmor",i):e.inventory.items.push(i);break}case"consumable":{const i=Xa(t.name,t.effectType,t.value,{statAffected:t.statAffected,weight:t.weight,target:t.target,stackable:t.stackable,maxStack:t.maxStack,quantity:t.quantity});e.inventory.items.push(i);break}case"item":{const i={id:oe(),name:t.name,description:t.description,weight:t.weight,value:Math.max(10,Math.round(t.weight*15)),isQuestItem:!!t.isQuestItem};e.inventory.items.push(i);break}}re(e)},Yn=ee({name:"player",initialState:z,reducers:{initializeCharacter:(e,t)=>{const{name:i,skills:s,backgroundId:n,visualPreset:a}=t.payload,r={strength:Ee(s.strength),perception:Ee(s.perception),endurance:Ee(s.endurance),charisma:Ee(s.charisma),intelligence:Ee(s.intelligence),agility:Ee(s.agility),luck:Ee(s.luck)},o=ss(r),l=to[n],c=ki();c.name=i,c.appearancePreset=a,c.skills=r,c.maxHealth=o.maxHP,c.health=o.maxHP,c.maxActionPoints=o.baseAP,c.actionPoints=o.baseAP,c.maxStamina=o.maxStamina,c.stamina=o.maxStamina,c.isExhausted=!1,Ve(c),c.inventory={items:[],maxWeight:o.carryWeight,currentWeight:0,hotbar:[null,null,null,null,null]},c.equipped={weapon:void 0,armor:void 0,accessory:void 0,secondaryWeapon:void 0,meleeWeapon:void 0,bodyArmor:void 0,helmet:void 0,accessory1:void 0,accessory2:void 0},c.equippedSlots={},c.activeWeaponSlot="primaryWeapon",c.perks=[],c.pendingPerkSelections=0,c.backgroundId=n,c.factionReputation={resistance:0,corpsec:0,scavengers:0},c.perkRuntime={gunFuShotsThisTurn:0,adrenalineRushTurnsRemaining:0,ghostInvisibilityTurns:0,ghostConsumed:!1},l&&(l.perk&&c.perks.push(l.perk.id),Object.entries(l.factionAdjustments).forEach(([d,u])=>{const h=d,g=u??0,m=c.factionReputation[h]??0;c.factionReputation[h]=ae(m+g)}),l.startingEquipment.forEach(d=>Bo(c,d))),e.data=c,e.data.encumbrance={level:"normal",percentage:0,movementApMultiplier:1,attackApMultiplier:1}},adjustFactionReputation:(e,t)=>{const{factionId:i,delta:s,reason:n,source:a}=t.payload;if(!Number.isFinite(s)||s===0)return;const r=Gn(e.data.factionReputation,i,s);e.data.factionReputation={...r.values},Ls(e,i,r,{reason:n,source:a})},setFactionReputation:(e,t)=>{const{factionId:i,value:s,reason:n,source:a}=t.payload,r=Vr(e.data.factionReputation,i,s);e.data.factionReputation={...r.values},Ls(e,i,r,{reason:n,source:a})},consumeFactionReputationEvents:e=>{e.pendingFactionEvents=[]},adjustPersonalityTrait:(e,t)=>{const{trait:i,delta:s,source:n}=t.payload;e.data.personality||(e.data.personality=jt());const a={...e.data.personality.flags},r=a[i]??0,o=Math.max(-5,Math.min(5,r+s));a[i]=o,e.data.personality={...e.data.personality,flags:a,lastUpdated:Date.now(),lastChangeSource:n??"storylet"}},movePlayer:(e,t)=>{if(e.data.encumbrance.level==="immobile")return;const i=e.data.position;if(e.data.position=t.payload,i){const s=t.payload.x-i.x,n=t.payload.y-i.y;(s!==0||n!==0)&&(Math.abs(s)>=Math.abs(n)?e.data.facing=s>=0?"east":"west":e.data.facing=n>=0?"south":"north")}e.data.coverOrientation=null,e.data.suppression=e.data.suppression??0},updateHealth:(e,t)=>{e.data.health=Math.max(0,Math.min(e.data.maxHealth,e.data.health+t.payload)),li(e.data)&&(e.data=ci(e.data))},setHealth:(e,t)=>{e.data.health=Math.max(0,Math.min(e.data.maxHealth,t.payload)),li(e.data)&&(e.data=ci(e.data))},updateActionPoints:(e,t)=>{e.data.actionPoints=Math.max(0,Math.min(e.data.maxActionPoints,e.data.actionPoints+t.payload))},resetActionPoints:e=>{e.data.actionPoints=e.data.maxActionPoints},consumeStamina:(e,t)=>{He(e.data),We(e.data);const i=t.payload;if(!Number.isFinite(i)||i<=0)return;const s=Math.max(0,Math.floor(i));e.data.stamina=Ue(e.data.stamina-s,e.data.maxStamina),Ve(e.data)},regenerateStamina:(e,t)=>{He(e.data),We(e.data);const i=t.payload??co;if(!Number.isFinite(i)||i<=0){Ve(e.data);return}const s=Math.max(0,Math.floor(i));e.data.stamina=Ue(e.data.stamina+s,e.data.maxStamina),Ve(e.data)},updateMaxStamina:e=>{He(e.data),We(e.data);const t=ye(e.data.skills.endurance);_e(e.data,t,{preserveRatio:!0})},addExperience:(e,t)=>{const i=typeof t.payload=="number"?{amount:t.payload}:t.payload,s=i.amount;if(!Number.isFinite(s)||s===0)return;e.data=Jr(e.data,s);const n=Qr(e.data);if(e.data=n.player,He(e.data),We(e.data),n.skillPointsAwarded>0&&(e.data.skillPoints+=n.skillPointsAwarded),n.attributePointsAwarded>0&&(e.data.attributePoints+=n.attributePointsAwarded),n.perksUnlocked>0&&(e.data.pendingPerkSelections+=n.perksUnlocked),n.levelsGained>0&&(e.pendingLevelUpEvents.push(so(e.data.level,n.skillPointsAwarded,n.attributePointsAwarded,n.perksUnlocked)),_e(e.data,ye(e.data.skills.endurance),{preserveRatio:!1})),s>0){const a=i.reason??"Experience gained",r=e.xpNotifications??[];e.xpNotifications=[...r,io(s,a)]}},addCredits:(e,t)=>{e.data.credits=Math.max(0,e.data.credits+t.payload)},setKarma:(e,t)=>{const i=Math.max(-1e3,Math.min(1e3,t.payload));e.data.karma=i,e.data.personality.lastUpdated=Date.now(),e.data.personality.lastChangeSource="karma:set"},adjustKarma:(e,t)=>{const i=Math.max(-1e3,Math.min(1e3,e.data.karma+t.payload));e.data.karma=i,e.data.personality.lastUpdated=Date.now(),e.data.personality.lastChangeSource="karma:adjust"},removeXPNotification:(e,t)=>{const i=e.xpNotifications??[];e.xpNotifications=i.filter(s=>s.id!==t.payload)},levelUp:e=>{e.data.level+=1,e.data.maxHealth+=10,e.data.health=e.data.maxHealth,e.data.maxActionPoints+=1,e.data.actionPoints=e.data.maxActionPoints;const t=ye(e.data.skills.endurance);_e(e.data,t,{preserveRatio:!1})},updateSkill:(e,t)=>{const{skill:i,amount:s}=t.payload;e.data.skills[i]=Math.max(1,Math.min(10,e.data.skills[i]+s));const n=e.data.skills,a=at(n.endurance),r=rt(n.agility),o=ot(n.strength),l=ye(n.endurance),c=Number.isFinite(e.data.health)?e.data.health:0,d=Number.isFinite(e.data.maxHealth)&&e.data.maxHealth>0?e.data.maxHealth:1,u=c/d;e.data.maxHealth=a;const h=Math.floor(a*u);e.data.health=Math.max(0,Math.min(Number.isFinite(h)?h:a,a)),e.data.maxActionPoints=r,e.data.actionPoints=Math.min(e.data.actionPoints,r),e.data.inventory.maxWeight=o,_e(e.data,l,{preserveRatio:!0})},setSkill:(e,t)=>{const{skill:i,value:s}=t.payload;e.data.skills[i]=Math.max(1,Math.min(10,s));const n=e.data.skills;e.data.maxHealth=at(n.endurance),e.data.health=e.data.maxHealth,e.data.maxActionPoints=rt(n.agility),e.data.actionPoints=e.data.maxActionPoints,e.data.inventory.maxWeight=ot(n.strength),_e(e.data,ye(n.endurance),{preserveRatio:!1})},addItem:(e,t)=>{e.data.inventory.items.push(t.payload),re(e.data)},removeItem:(e,t)=>{const i=t.payload;rs(e.data,i)&&re(e.data)},resetPlayer:e=>{e.version=mt,e.data=ki(),e.pendingLevelUpEvents=[],e.xpNotifications=[],e.pendingFactionEvents=[]},setPlayerData:(e,t)=>{const i=bo(t.payload);if(e.version=mt,e.data=i,e.data.factionReputation||(e.data.factionReputation={...Q.factionReputation}),["resistance","corpsec","scavengers"].forEach(n=>{const a=Q.factionReputation[n]??0,r=e.data.factionReputation[n];e.data.factionReputation[n]=ae(typeof r=="number"?r:a)}),e.pendingFactionEvents=[],e.data.perkRuntime||(e.data.perkRuntime={gunFuShotsThisTurn:0,adrenalineRushTurnsRemaining:0,ghostInvisibilityTurns:0,ghostConsumed:!1}),e.data.inventory.hotbar||(e.data.inventory.hotbar=[null,null,null,null,null]),e.data.equipped?e.data.equipped={...e.data.equipped}:e.data.equipped={},e.data.equippedSlots||(e.data.equippedSlots={}),e.data.activeWeaponSlot||(e.data.activeWeaponSlot="primaryWeapon"),e.data.encumbrance||(e.data.encumbrance={level:"normal",percentage:0,movementApMultiplier:1,attackApMultiplier:1}),!e.data.personality)e.data.personality=jt();else{const n=e.data.personality.flags??{};e.data.personality={...e.data.personality,flags:{earnest:n.earnest??0,sarcastic:n.sarcastic??0,ruthless:n.ruthless??0,stoic:n.stoic??0},lastUpdated:e.data.personality.lastUpdated??0}}e.data.inventory.items=e.data.inventory.items.map(n=>he(n)??n),e.data.equipped.weapon=he(e.data.equipped.weapon,"primaryWeapon"),e.data.equipped.secondaryWeapon=he(e.data.equipped.secondaryWeapon,"secondaryWeapon"),e.data.equipped.meleeWeapon=he(e.data.equipped.meleeWeapon,"meleeWeapon"),e.data.equipped.bodyArmor=he(e.data.equipped.bodyArmor,"bodyArmor"),e.data.equipped.helmet=he(e.data.equipped.helmet,"helmet"),e.data.equipped.accessory1=he(e.data.equipped.accessory1,"accessory1"),e.data.equipped.accessory2=he(e.data.equipped.accessory2,"accessory2");const s=e.data.equippedSlots??{};e.data.equippedSlots=s,Object.entries(s).forEach(([n,a])=>{if(!a)return;const r=he(a,n);s[n]=r}),He(e.data),We(e.data),re(e.data),li(e.data)&&(e.data=ci(e.data))},setMovementProfile:(e,t)=>{e.data.movementProfile=t.payload},setStealthState:(e,t)=>{e.data.stealthModeEnabled=t.payload.enabled,"cooldownExpiresAt"in t.payload&&(e.data.stealthCooldownExpiresAt=t.payload.cooldownExpiresAt??null)},equipItem:(e,t)=>{hi(e.data,t.payload)},unequipItem:(e,t)=>{pi(e.data,t.payload)},repairItem:(e,t)=>{$n(e.data,t.payload)},splitStack:(e,t)=>{Eo(e.data,t.payload)},assignHotbarSlot:(e,t)=>{_o(e.data,t.payload),re(e.data)},attachWeaponMod:(e,t)=>{Do(e.data,t.payload)},detachWeaponMod:(e,t)=>{Lo(e.data,t.payload)},craftWeaponMod:(e,t)=>{Ro(e.data,t.payload)},useInventoryItem:(e,t)=>{Fo(e.data,t.payload)},equipWeapon:(e,t)=>{hi(e.data,{itemId:t.payload,slot:"primaryWeapon"})},equipArmor:(e,t)=>{hi(e.data,{itemId:t.payload,slot:"bodyArmor"})},unequipWeapon:e=>{pi(e.data,{slot:"primaryWeapon"})},unequipArmor:e=>{pi(e.data,{slot:"bodyArmor"})},consumeLevelUpEvent:e=>{e.pendingLevelUpEvents.shift()},clearPendingPerkSelections:e=>{e.data.pendingPerkSelections=0},selectPerk:(e,t)=>{const i=t.payload;if(e.data.pendingPerkSelections<=0||e.data.perks.includes(i))return;const s=Ya(i);if(Za(e.data,s).canSelect)switch(e.data.perks.push(i),e.data.pendingPerkSelections=Math.max(0,e.data.pendingPerkSelections-1),i){case"gunFu":e.data.perkRuntime.gunFuShotsThisTurn=0;break;case"adrenalineRush":e.data.perkRuntime.adrenalineRushTurnsRemaining=0;break;case"ghost":e.data.perkRuntime.ghostConsumed=!1,e.data.perkRuntime.ghostInvisibilityTurns=0;break}},beginPlayerTurn:e=>{e.data=Ir(e.data),e.data.perkRuntime.adrenalineRushTurnsRemaining>0&&(e.data=Cr(e.data)),e.data.perkRuntime.ghostInvisibilityTurns>0&&(e.data=kr(e.data))},spendSkillPoints:(e,t)=>{const i=t.payload;e.data.skillPoints>=i&&i>0&&(e.data.skillPoints-=i)},allocateSkillPointToSkill:(e,t)=>{const i=t.payload;if(e.data.skillPoints<=0)return;const s=Ci(i),n=e.data.skillTraining[i]??0,r=e.data.taggedSkillIds.includes(i)?s.taggedIncrement:s.increment;n>=s.maxValue||n+r>s.maxValue||(e.data.skillTraining[i]=n+r,e.data.skillPoints-=1)},refundSkillPointFromSkill:(e,t)=>{const i=t.payload,s=Ci(i),n=e.data.skillTraining[i]??0;if(n<=0)return;const r=e.data.taggedSkillIds.includes(i)?s.taggedIncrement:s.increment,o=n-r;o<0||(e.data.skillTraining[i]=o,e.data.skillPoints+=1)},spendAttributePoint:(e,t)=>{const i=t.payload;if(e.data.attributePoints<=0||e.data.skills[i]>=10)return;e.data.attributePoints-=1,e.data.skills[i]+=1;const s=e.data.skills,n=at(s.endurance),a=rt(s.agility),r=ot(s.strength),o=ye(s.endurance),l=Number.isFinite(e.data.health)?e.data.health:0,c=Number.isFinite(e.data.maxHealth)&&e.data.maxHealth>0?e.data.maxHealth:1,d=l/c;e.data.maxHealth=n;const u=Math.floor(n*d);e.data.health=Math.max(0,Math.min(Number.isFinite(u)?u:n,n)),e.data.maxActionPoints=a,e.data.actionPoints=Math.min(e.data.actionPoints,a),e.data.inventory.maxWeight=r,_e(e.data,o,{preserveRatio:!0})},refundAttributePoint:(e,t)=>{const i=t.payload;if(e.data.skills[i]<=1)return;e.data.attributePoints+=1,e.data.skills[i]-=1;const n=e.data.skills,a=at(n.endurance),r=rt(n.agility),o=ot(n.strength),l=ye(n.endurance),c=Number.isFinite(e.data.health)?e.data.health:0,d=Number.isFinite(e.data.maxHealth)&&e.data.maxHealth>0?e.data.maxHealth:1,u=c/d;e.data.maxHealth=a;const h=Math.floor(a*u);e.data.health=Math.max(0,Math.min(Number.isFinite(h)?h:a,a)),e.data.maxActionPoints=r,e.data.actionPoints=Math.min(e.data.actionPoints,r),e.data.inventory.maxWeight=o,_e(e.data,l,{preserveRatio:!0})}}}),{initializeCharacter:bp,movePlayer:Oo,updateHealth:No,setHealth:wp,updateActionPoints:Fs,resetActionPoints:Pp,consumeStamina:Mp,regenerateStamina:Ap,updateMaxStamina:xp,addExperience:Ip,addCredits:Cp,setKarma:kp,adjustKarma:Tp,adjustFactionReputation:Ho,setFactionReputation:Rp,consumeFactionReputationEvents:Ep,adjustPersonalityTrait:Wo,removeXPNotification:_p,levelUp:Dp,updateSkill:Lp,setSkill:Fp,addItem:Bp,removeItem:Op,equipItem:Np,unequipItem:Hp,repairItem:Wp,splitStack:Gp,assignHotbarSlot:qp,attachWeaponMod:Vp,detachWeaponMod:zp,craftWeaponMod:Up,useInventoryItem:Kp,resetPlayer:jp,setPlayerData:Go,setMovementProfile:$p,setStealthState:Yp,equipWeapon:Zp,equipArmor:Xp,unequipWeapon:Qp,unequipArmor:Jp,consumeLevelUpEvent:em,clearPendingPerkSelections:tm,selectPerk:im,beginPlayerTurn:sm,spendSkillPoints:nm,spendAttributePoint:am,refundAttributePoint:rm,allocateSkillPointToSkill:om,refundSkillPointFromSkill:lm}=Yn.actions,qo=Yn.reducer,pt="corpsec-sentinel",W=e=>({kind:"lineOfSight",state:"chase",weight:0,...e}),Vo=[W({kind:"lineOfSight",state:"attack",weight:3}),W({kind:"lineOfSight",state:"chase",weight:2}),W({kind:"lostLineOfSight",state:"search",weight:2}),W({kind:"healthBelow",state:"flee",threshold:.35,weight:3}),W({kind:"suppressionAbove",state:"panic",threshold:.6,weight:2}),W({kind:"alertAtLeast",state:"attack",alert:O.INVESTIGATING,weight:1.5}),W({kind:"alertBelow",state:"patrol",alert:O.SUSPICIOUS,weight:1}),W({kind:"distanceBelow",state:"attack",tiles:2,weight:2.5}),W({kind:"distanceAbove",state:"patrol",tiles:8,weight:1.2}),{kind:"healthBelow",state:"attack",threshold:.4,weight:-3},{kind:"healthBelow",state:"chase",threshold:.4,weight:-3},{kind:"healthBelow",state:"panic",threshold:.35,weight:2}],zo=[W({kind:"lineOfSight",state:"attack",weight:4}),W({kind:"lineOfSight",state:"chase",weight:3}),W({kind:"lostLineOfSight",state:"search",weight:1.5}),W({kind:"healthBelow",state:"panic",threshold:.25,weight:2}),W({kind:"suppressionAbove",state:"flee",threshold:.8,weight:2}),W({kind:"alertAtLeast",state:"attack",alert:O.ALARMED,weight:2}),W({kind:"directorAtLeast",state:"panic",threshold:.8,weight:1.5})],Uo=[W({kind:"lineOfSight",state:"chase",weight:1.5}),W({kind:"lostLineOfSight",state:"search",weight:3}),W({kind:"healthBelow",state:"flee",threshold:.5,weight:3}),W({kind:"alertBelow",state:"patrol",alert:O.SUSPICIOUS,weight:2}),W({kind:"distanceAbove",state:"patrol",tiles:6,weight:1.5}),W({kind:"distanceBelow",state:"inspectNoise",tiles:4,weight:1.2})],mi=(e,t)=>({id:e,initialState:"patrol",baseWeights:{idle:.5,patrol:3,chase:1,search:1,attack:.5,inspectNoise:.5,flee:.2,panic:.1},cooldowns:{panic:12e3,flee:8e3,inspectNoise:2e3},minimumSelectableWeight:.05,...t}),Ri={[pt]:{id:pt,label:"CorpSec Sentinel",description:"Baseline guard tuned for perimeter patrols; favours holding ground until line of sight is confirmed.",fsm:mi(pt,{baseWeights:{idle:.6,patrol:3.5,chase:.3,search:.9,attack:.9,inspectNoise:.6,flee:.4,panic:.2},utilityModifiers:Vo})},"corpsec-enforcer":{id:"corpsec-enforcer",label:"CorpSec Enforcer",description:"Aggressive shock troops that lean into panic suppression and rapid response.",fsm:mi("corpsec-enforcer",{initialState:"patrol",baseWeights:{idle:.2,patrol:2.5,chase:1.5,search:.6,attack:1.2,inspectNoise:.4,flee:.2,panic:.4},utilityModifiers:zo,cooldowns:{panic:1e4,flee:6e3,inspectNoise:1500}})},"corpsec-watchman":{id:"corpsec-watchman",label:"CorpSec Watchman",description:"Cautious sentry who prioritises searching and calling in reinforcements.",fsm:mi("corpsec-watchman",{baseWeights:{idle:1,patrol:2.5,chase:.6,search:1.4,attack:.5,inspectNoise:.8,flee:.5,panic:.2},utilityModifiers:Uo,cooldowns:{panic:12e3,flee:9e3,inspectNoise:2500}})}},Ko=e=>Ri[e],Bs={zoneId:"unknown_zone",name:"Unknown Sector",level:0,danger:"low",hazards:[],objectives:[],summary:"No reconnaissance available for this zone."},Os={downtown_checkpoint:{zoneId:"downtown_checkpoint",name:"Slums Command Grid",level:0,danger:"moderate",hazards:["CorpSec curfew sweeps after sundown","Autonomous patrol drones scanning alleys","Tight choke points with improvised barricades"],objectives:["Recover Lira's contraband cache from the downtown evidence lockers.","Decrypt the surveillance manifests Archivist Naila smuggled out.","Re-establish Brant's courier drop routes across the grid before curfew.","Black out the CorpSec camera grid guarding the barricades.","Map patrol drone loops and assign safe counter-routes.","Restock Medic Yara's rebel clinic with field medkits.","Ambush the transit patrol escorting the sweep captain."],summary:"Primary resistance staging ground on the edge of Downtown. Expect constant patrol loops and rapid curfew escalations once alarms trip."},gov_complex:{zoneId:"gov_complex",name:"Downtown Governance Ring",level:1,danger:"high",hazards:["Omnidirectional camera grids with rapid resync pulses","CorpSec riot squads supported by shield drones","Encrypted checkpoints requiring forged credentials"],objectives:["Breaching the executive archives for blackmail dossiers","Subverting curfew order terminals","Exfiltrating detained resistance couriers"],summary:"Corporate command nerve centre governing the city core. Security density spikes during curfew and when alert level rises above Suspicious."},corporate_plaza:{zoneId:"corporate_plaza",name:"Skyline Transit Spire",level:1,danger:"moderate",hazards:["Precision sniper nests covering rooftop routes","Kinetic response teams dispatched via mag-rails","Marketing holo projectors causing navigation glare"],objectives:["Sabotage skyline transit relays to halt corporate reinforcements","Secure encrypted comm relays for resistance broadcasts","Extract high-value defectors under corporate escort"],summary:"Vertical plaza bridging transit hubs and corporate towers. Movement is exposed but offers vantage points if you neutralise overwatch nests."},industrial_corridor:{zoneId:"industrial_corridor",name:"Industrial Wasteland",level:2,danger:"critical",hazards:["Toxic smog plumes reducing visibility and draining health","Open radiation pockets around collapsed reactors","Unstable power conduits causing electrical surges","Hostile scavenger clans with improvised explosives"],objectives:["Stabilise the resistance refinery outpost","Disrupt CorpSec convoy routes feeding the upper city","Recover prototype filtration tech before corp retrieval teams arrive"],summary:"Decommissioned industrial belt now weaponised by corp security. Navigation requires filtration gear and constant hazard monitoring."},resistance_safehouse:{zoneId:"resistance_safehouse",name:"Resistance Safehouse Network",level:0,danger:"low",hazards:["Tight corridors with limited firing lanes"],objectives:["Resupply from hidden caches","Brief with cell leadership for mission intel","Coordinate evac routes ahead of major operations"],summary:"Hidden safehouse offering respite between sorties. Minimal patrol risk but expect limited mobility and quick extraction drills."}},jo=e=>e.includes("::")?e.split("::")[0]??e:e,Zn=e=>{if(!e)return Bs;const t=Os[e];if(t)return t;const i=Os[jo(e)];return i||{...Bs,zoneId:e}},$o={performance:{maxDecorPropsPerBuilding:2,maxAmbientGlows:12,enableAnimatedHazards:!1,enableHighDensityLabels:!1,maxFogBands:2,maxEmissiveZones:6,wetReflectionAlpha:.08,occlusionFadeFloor:.56},balanced:{maxDecorPropsPerBuilding:4,maxAmbientGlows:24,enableAnimatedHazards:!0,enableHighDensityLabels:!0,maxFogBands:4,maxEmissiveZones:10,wetReflectionAlpha:.14,occlusionFadeFloor:.48},cinematic:{maxDecorPropsPerBuilding:6,maxAmbientGlows:36,enableAnimatedHazards:!0,enableHighDensityLabels:!0,maxFogBands:6,maxEmissiveZones:14,wetReflectionAlpha:.2,occlusionFadeFloor:.38}},Ns=(e,t,i,s,n,a,r,o,l,c,d,u,h,g)=>({district:e,signageStyle:t,propDensity:i,facadePattern:s,lotPattern:n,massingStyle:a,massingHeight:r,accentHex:o,glowHex:l,trimHex:c,atmosphereHex:d,signagePrimaryHex:u,signageSecondaryHex:h,backdropHex:g}),Xn={downtown:Ns("downtown","corp_holo","medium","ribbed","plaza","block",1.8,"#38bdf8","#67e8f9","#b6f7ff","#081126","#9beafe","#67e8f9","#0d1b2a"),slums:Ns("slums","slums_neon","medium","banded","market","stacked",1,"#f97316","#fb923c","#ffd08d","#170c09","#6ff2ff","#9c8cff","#0b1220")},Yo={player:{role:"player",baseColor:988970,outlineColor:6333946,primaryColor:3900150,accentColor:6809849,glowColor:3718648,columnHeight:1.5,widthScale:.72,heightScale:.46,depthOffset:12},friendlyNpc:{role:"friendlyNpc",baseColor:1713208,outlineColor:2282478,primaryColor:959977,accentColor:6809849,glowColor:2282478,columnHeight:1.28,widthScale:.68,heightScale:.44,depthOffset:9},hostileNpc:{role:"hostileNpc",baseColor:2758171,outlineColor:15680580,primaryColor:14427686,accentColor:16347926,glowColor:16478597,columnHeight:1.32,widthScale:.69,heightScale:.45,depthOffset:9},interactiveNpc:{role:"interactiveNpc",baseColor:1057336,outlineColor:10980346,primaryColor:9133302,accentColor:2282478,glowColor:12616956,columnHeight:1.36,widthScale:.7,heightScale:.46,depthOffset:10}},os=e=>({id:"noir-vector-v1",preset:e,qualityBudget:$o[e],tilePalettes:{floorEven:1382951,floorOdd:1712688,wallEven:3096416,wallOdd:2569554,coverEven:2640722,coverOdd:2244423,waterEven:1066081,waterOdd:997200,trapEven:5644612,trapOdd:4528694,doorEven:3093058,doorOdd:2369333},surfacePalettes:{lotEven:1317415,lotOdd:1712688,roadEven:856602,roadOdd:1251876,crosswalkEven:2830655,crosswalkOdd:2436153,sidewalkEven:2173496,sidewalkOdd:1778738},districtDefaults:Xn,entityProfiles:Yo}),Vt=(e,t,i)=>{const n=Xn[e==="downtown"?"downtown":"slums"],a=t??n.signageStyle,r=i??n.propDensity;return a==="corp_brass"?{...n,signageStyle:a,propDensity:r,facadePattern:"chevron",lotPattern:"plaza",massingStyle:"block",massingHeight:2,accentHex:"#f3ca75",glowHex:"#fbbf24",trimHex:"#ffe4a3",atmosphereHex:"#1a140a",signagePrimaryHex:"#f3ca75",signageSecondaryHex:"#f9e2af",backdropHex:"#1a140a"}:a==="slums_scrap"?{...n,signageStyle:a,propDensity:r,facadePattern:"solid",lotPattern:"service",massingStyle:"block",massingHeight:.95,accentHex:"#f97316",glowHex:"#fb923c",trimHex:"#ffd299",atmosphereHex:"#190f08",signagePrimaryHex:"#f97316",signageSecondaryHex:"#fb923c",backdropHex:"#190f08"}:{...n,signageStyle:a,propDensity:r}},Hs=["solid","ribbed","banded","chevron"],Zo=["ribbed","chevron"],Xo=["solid","banded"],Qo=["plaza","service"],Jo=["market","service"],el=["block"],tl=["stacked","block"],il=e=>{let t=0;for(let i=0;i<e.length;i+=1)t=t*31+e.charCodeAt(i)>>>0;return t},gi=e=>Math.max(0,Math.min(255,Math.round(e))),Rt=(e,t)=>{const i=e.startsWith("#")?e.slice(1):e;if(i.length!==6)return e;const s=parseInt(i.slice(0,2),16),n=parseInt(i.slice(2,4),16),a=parseInt(i.slice(4,6),16),r=t*255;return`#${[gi(s+r),gi(n+r),gi(a+r)].map(l=>l.toString(16).padStart(2,"0")).join("")}`},sl=e=>{const t={};return e.forEach(i=>{const s=Vt(i.district,i.signageStyle,i.propDensity),n=il(`${i.id}:${i.name}`),a=i.district==="downtown"?"downtown":"slums",r=a==="downtown"?Zo:Xo,o=a==="downtown"?Qo:Jo,l=a==="downtown"?el:tl,c=r[n%r.length]??Hs[n%Hs.length],d=o[(n>>1)%o.length]??s.lotPattern,u=l[(n>>2)%l.length]??s.massingStyle,h=a==="downtown"?1.45:1,g=(n%7-3)*.09,m=Math.max(.85,h+g),p=a==="downtown"?(n%5-2)*.05:(n%7-3)*.06;t[i.id]={...s,facadePattern:c,lotPattern:d,massingStyle:u,massingHeight:m,accentHex:Rt(s.accentHex,p),glowHex:Rt(s.glowHex,p*.7),trimHex:Rt(s.trimHex,p*.45),atmosphereHex:Rt(s.atmosphereHex,p*.28)}}),{profilesByBuildingId:t}},nl=96,al=72,Qn=e=>e>=24&&e<=26||e>=60&&e<=62,Jn=e=>e>=20&&e<=21||e>=44&&e<=45,rl=(e,t)=>Qn(e)||Jn(t),ol=(e,t)=>t.some(i=>{const{from:s,to:n}=i.footprint;return e.x>=s.x&&e.x<=n.x&&e.y>=s.y&&e.y<=n.y}),ll=(e,t,i,s)=>{const n=Nn(e,t,i,{level:s.level,isInterior:!0,zoneId:s.zoneId,factionRequirement:s.factionRequirement,displayName:s.displayName,summary:s.summary,dangerRating:s.dangerRating,hazards:s.hazards}),a={x:Math.floor(t/2),y:i-1},r={x:a.x,y:Math.max(1,a.y-1)},o=n.tiles[a.y][a.x];return o.type=D.DOOR,o.isWalkable=!0,{area:n,entryPosition:r,doorPosition:a}},cl=(e,t,i)=>{const s=[],n=[];return i.forEach(a=>{var d,u;const{from:r,to:o}=a.footprint;for(let h=r.y;h<=o.y;h++)for(let g=r.x;g<=o.x;g++){const m=(d=e.tiles[h])==null?void 0:d[g];m&&m.type===D.DOOR&&(m.type=D.WALL,m.isWalkable=!1)}const l=(u=e.tiles[a.door.y])==null?void 0:u[a.door.x];if(!l)return;l.type=D.DOOR,l.isWalkable=!0;const c=ll(`${t} :: ${a.name}`,a.interior.width,a.interior.height,{level:e.level??0,zoneId:`${e.zoneId}::interior`,factionRequirement:a.factionRequirement,displayName:`${t} :: ${a.name}`,summary:e.summary,dangerRating:e.dangerRating,hazards:e.hazards});n.push(c.area),s.push({fromAreaId:e.id,fromPosition:{...a.door},toAreaId:c.area.id,toPosition:{...c.entryPosition}}),s.push({fromAreaId:c.area.id,fromPosition:{...c.doorPosition},toAreaId:e.id,toPosition:{...a.door}})}),{connections:s,interiors:n}},dl=e=>e,ul=e=>{var s,n;const t=e.tiles.map(a=>a.map(r=>({...r,surfaceKind:r.surfaceKind??"lot",surfaceAxis:r.surfaceAxis})));for(let a=0;a<e.height;a+=1)for(let r=0;r<e.width;r+=1){const o=(s=t[a])==null?void 0:s[r];if(!o)continue;if(!o.isWalkable){o.surfaceKind="lot";continue}const l=Qn(r),c=Jn(a);l&&c?(o.surfaceKind="crosswalk",o.surfaceAxis="intersection"):l||c?(o.surfaceKind="road",o.surfaceAxis=l?"avenue":"street"):o.surfaceKind="lot"}const i=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}];for(let a=0;a<e.height;a+=1)for(let r=0;r<e.width;r+=1){const o=(n=t[a])==null?void 0:n[r];if(!o||!o.isWalkable||o.surfaceKind==="road"||o.surfaceKind==="crosswalk")continue;i.some(c=>{var u;const d=(u=t[a+c.y])==null?void 0:u[r+c.x];return!!(d!=null&&d.isWalkable&&(d.surfaceKind==="road"||d.surfaceKind==="crosswalk"))})&&(o.surfaceKind="sidewalk")}return{...e,tiles:t}},hl=(e,t,i,s,n,a,r)=>{const o=Nn(e,nl,al,{level:0,objectives:i,zoneId:t}),l=Zn(t),c={...o,name:l.name,displayName:l.name,level:l.level,objectives:l.objectives.length?l.objectives:o.objectives,dangerRating:l.danger,hazards:l.hazards,summary:l.summary},d=[],u=(f,E,B,Y)=>{for(let te=E;te<=Y;te++)for(let le=f;le<=B;le++)rl(le,te)||d.push({x:le,y:te})};s.forEach(f=>{u(f.footprint.from.x,f.footprint.from.y,f.footprint.to.x,f.footprint.to.y)});const h=vr(c,d),m=n.map(f=>f.position).filter(f=>{var B;const E=(B=h.tiles[f.y])==null?void 0:B[f.x];return E?E.isWalkable:!1}),p=br(h,m),v=new Set(m.map(f=>`${f.x}:${f.y}`)),S=n.reduce((f,E)=>{if(!E.profile)return f;const B=`${E.position.x}:${E.position.y}`;return v.has(B)?wr(f,E.position,E.profile):f},p),M=dl(S),x=ul(M),b=sl(s),A=s.map(f=>({id:f.id,name:f.name,signageStyle:f.signageStyle,district:f.district,propDensity:f.propDensity,encounterProfile:f.encounterProfile,workbench:f.workbench,footprint:{from:{...f.footprint.from},to:{...f.footprint.to}},door:{...f.door},visualProfile:b.profilesByBuildingId[f.id]?{facadePattern:b.profilesByBuildingId[f.id].facadePattern,lotPattern:b.profilesByBuildingId[f.id].lotPattern,massingStyle:b.profilesByBuildingId[f.id].massingStyle,massingHeight:b.profilesByBuildingId[f.id].massingHeight,accentHex:b.profilesByBuildingId[f.id].accentHex,glowHex:b.profilesByBuildingId[f.id].glowHex,trimHex:b.profilesByBuildingId[f.id].trimHex,atmosphereHex:b.profilesByBuildingId[f.id].atmosphereHex,signagePrimaryHex:b.profilesByBuildingId[f.id].signagePrimaryHex,signageSecondaryHex:b.profilesByBuildingId[f.id].signageSecondaryHex,backdropHex:b.profilesByBuildingId[f.id].backdropHex}:void 0}));x.buildings=A;const I=f=>{var B;const E=(B=x.tiles[f.y])==null?void 0:B[f.x];return!E||!E.isWalkable||E.type===D.DOOR||E.type===D.WALL?!1:!ol(f,s)},w=f=>{const E=es(f,x)??f;return I(E)?E:Hn(E,x).find(te=>I(te))??null};a.forEach(f=>{const E=w(f.position);E&&x.entities.npcs.push({...f,id:oe(),position:E})});const C=m.length?m:[{x:32,y:74},{x:84,y:28},{x:54,y:64}];r.forEach((f,E)=>{const B=C[E%C.length],Y=w(B)??B;x.entities.items.push({...f,id:oe(),position:Y})});const{connections:R,interiors:k}=cl(x,e,s);return k.forEach(f=>{f.level=f.level??0,f.objectives=f.objectives??[]}),{area:x,connections:R,interiorAreas:k}},pl=({locale:e})=>{const t=ii(e),i=hl(t.world.areaName,t.world.zoneId,t.world.objectives,t.buildingDefinitions,t.coverSpots.all,t.npcBlueprints,t.itemBlueprints),s=i.area,a=[...i.interiorAreas].reduce((r,o)=>(r[o.id]=o,r),{[s.id]:s});return{slumsArea:s,mapAreas:a,connections:[...i.connections]}},G={cycleDuration:300,timeMultiplier:1,morningStartTime:0,dayStartTime:.1,eveningStartTime:.4,dayEndTime:.5},gt=(e,t=G)=>{const i=e%t.cycleDuration/t.cycleDuration;return i>=t.morningStartTime&&i<t.dayStartTime?"morning":i>=t.dayStartTime&&i<t.eveningStartTime?"day":i>=t.eveningStartTime&&i<t.dayEndTime?"evening":"night"},ml=(e,t=G)=>{const i=e%t.cycleDuration/t.cycleDuration;return i>=t.morningStartTime&&i<t.dayStartTime?.4+(i-t.morningStartTime)/(t.dayStartTime-t.morningStartTime)*.6:i>=t.dayStartTime&&i<t.eveningStartTime?1:i>=t.eveningStartTime&&i<t.dayEndTime?1-(i-t.eveningStartTime)/(t.dayEndTime-t.eveningStartTime)*.6:.2},gl=(e,t=G)=>{const i=gt(e,t),s=ml(e,t);switch(i){case"morning":return`rgba(180, 208, 255, ${(1-s)*.22})`;case"day":return"rgba(255, 255, 255, 0)";case"evening":return`rgba(214, 179, 255, ${(1-s)*.28})`;case"night":return`rgba(18, 30, 64, ${.72*(1-s)})`;default:return"rgba(0, 0, 0, 0)"}},fl=(e,t=G)=>{const i=t.cycleDuration;if(!Number.isFinite(e)||i<=0)return{totalMinutes:0,hour:0,minute:0};const n=(e%i+i)%i/i,a=Math.floor(n*24*60)%(24*60),r=Math.floor(a/60),o=a%60;return{totalMinutes:a,hour:r,minute:o}},ft=(e,t=G)=>{const{hour:i}=fl(e,t);return i>=22||i<6};var fi={};const yl=()=>{},Sl=()=>typeof process<"u"?"production":"development",vl=()=>[typeof process<"u"?fi==null?void 0:fi.ENABLE_VERBOSE_LOGS:void 0,typeof globalThis<"u"?globalThis.__ENABLE_VERBOSE_LOGS:void 0].some(t=>typeof t=="string"?t.toLowerCase()==="true":t===!0),bl=!vl()&&Sl()==="test",wl=e=>{const t=console[e]??console.log;return typeof t=="function"?t.bind(console):console.log.bind(console)},Et=(e,t)=>{const i=wl(e);return bl&&(e==="debug"||e==="info")?yl:(...s)=>{i(`[${t}]`,...s)}},ls=e=>({debug:Et("debug",e),info:Et("info",e),warn:Et("warn",e),error:Et("error",e)});ls("app");const pe=ls("worldSlice"),Pl=()=>({flags:{gangHeat:"low",curfewLevel:0,supplyScarcity:"norm",blackoutTier:"none"},weather:{presetId:null,rainIntensity:0,thunderActive:!1,sirenLoop:!1,updatedAt:0,timeOfDay:null},signage:{},rumorSets:{},notes:[]}),Ml=(e,t)=>(e.buildings??[]).some(i=>{const{from:s,to:n}=i.footprint;return t.x>=s.x&&t.x<=n.x&&t.y>=s.y&&t.y<=n.y}),Al=e=>({id:oe(),name:e,position:{x:34,y:24},facing:"west",coverOrientation:null,suppression:0,maxHealth:45,health:45,actionPoints:4,maxActionPoints:4,damage:7,attackRange:2,isHostile:!0,visionCone:{range:10,angle:90,direction:180},alertLevel:O.IDLE,alertProgress:0,lastKnownPlayerPosition:null,aiProfileId:pt,aiState:"patrol",aiLastTransitionAt:0,aiCooldowns:{}});Math.floor(G.dayEndTime*G.cycleDuration);const xl=Math.floor(G.dayStartTime*G.cycleDuration),ea=Math.floor((G.dayStartTime+G.eveningStartTime)/2*G.cycleDuration),ta=e=>{const t=pl({locale:e}),i=ii(e),s=t.slumsArea,n=Al(i.world.initialEnemyName),a=es(n.position,s);a&&(n.position=a),s.entities.enemies.push(n),pe.debug("Initial map generated with enemy:",n);const r=ea;return{currentMapArea:s,mapAreas:t.mapAreas,mapConnections:t.connections,currentTime:r,timeOfDay:gt(r,G),curfewActive:ft(r,G),inCombat:!1,isPlayerTurn:!0,turnCount:1,globalAlertLevel:O.IDLE,reinforcementsScheduled:!1,environment:Pl(),engagementMode:"none",stealthToggleRequestNonce:0,workbenchAvailable:!1,workbenchStatus:{available:!1,note:"No workbench nearby"}}},Il=ta(Te),ia=ee({name:"world",initialState:Il,reducers:{setEnvironmentFlags:(e,t)=>{e.environment.flags={...e.environment.flags,...t.payload}},setWorkbenchAvailable:(e,t)=>{e.workbenchAvailable=t.payload,e.workbenchStatus={available:t.payload,note:t.payload?void 0:"No workbench nearby"}},setWorkbenchStatus:(e,t)=>{e.workbenchStatus={...t.payload},e.workbenchAvailable=t.payload.available},applyEnvironmentWeather:(e,t)=>{e.environment.weather={...t.payload}},applyEnvironmentSignage:(e,t)=>{const{signId:i,snapshot:s}=t.payload;e.environment.signage={...e.environment.signage,[i]:{...s}}},removeEnvironmentSignage:(e,t)=>{const i={...e.environment.signage};delete i[t.payload],e.environment.signage=i},applyEnvironmentRumorSet:(e,t)=>{const{groupId:i,snapshot:s}=t.payload;e.environment.rumorSets={...e.environment.rumorSets,[i]:{...s}}},removeEnvironmentRumorSet:(e,t)=>{const i={...e.environment.rumorSets};delete i[t.payload],e.environment.rumorSets=i},registerEnvironmentalNote:(e,t)=>{const i=t.payload,s=e.environment.notes.findIndex(n=>n.instanceId===i.instanceId);s>=0?e.environment.notes[s]={...i}:e.environment.notes.push({...i})},clearEnvironmentalNotesForArea:(e,t)=>{const i=t.payload;e.environment.notes=e.environment.notes.filter(s=>s.areaId!==i)},setNpcAmbientProfile:(e,t)=>{const{profile:i,match:s}=t.payload,{dialogueId:n,name:a}=s,r=o=>{let l=!1;const c=o.map(d=>{const u=n?d.dialogueId===n:!1,h=a?d.name===a:!1;return!u&&!h?d:(l=!0,{...d,ambientProfile:i?{...i}:void 0})});return l?c:o};e.currentMapArea.entities.npcs=r(e.currentMapArea.entities.npcs),Object.values(e.mapAreas).forEach(o=>{o.entities.npcs=r(o.entities.npcs)})},setMapArea:(e,t)=>{e.currentMapArea=t.payload,e.inCombat=!1,e.isPlayerTurn=!0,e.turnCount=1,e.engagementMode="none",e.workbenchAvailable=!1,e.workbenchStatus={available:!1,note:"No workbench nearby"}},setCurrentMapAreaZoneMetadata:(e,t)=>{const i=Zn(t.payload.zoneId),s=e.currentMapArea;s.zoneId=i.zoneId,s.name=i.name,s.displayName=i.name,s.level=i.level,s.summary=i.summary,s.dangerRating=i.danger,s.hazards=[...i.hazards],s.objectives=[...i.objectives],e.workbenchAvailable=!1,e.workbenchStatus={available:!1,note:"No workbench nearby"};const n=e.mapAreas[s.id];n&&(n.zoneId=s.zoneId,n.name=s.name,n.displayName=s.displayName,n.level=s.level,n.summary=s.summary,n.dangerRating=s.dangerRating,n.hazards=[...s.hazards],n.objectives=[...s.objectives])},updateGameTime:(e,t)=>{e.currentTime+=t.payload,e.timeOfDay=gt(e.currentTime,G),e.curfewActive=ft(e.currentTime,G),e.curfewActive?e.environment.flags.curfewLevel=e.reinforcementsScheduled?3:2:e.environment.flags.curfewLevel=0,e.environment.flags.blackoutTier!=="rolling"&&(e.environment.flags.blackoutTier=e.curfewActive?"brownout":"none")},setGameTime:(e,t)=>{e.currentTime=t.payload,e.timeOfDay=gt(e.currentTime,G),e.curfewActive=ft(e.currentTime,G),e.curfewActive?e.environment.flags.curfewLevel=e.reinforcementsScheduled?3:2:e.environment.flags.curfewLevel=0,e.environment.flags.blackoutTier!=="rolling"&&(e.environment.flags.blackoutTier=e.curfewActive?"brownout":"none")},enterCombat:e=>{if(!e.inCombat){if(e.currentMapArea.entities.enemies.filter(i=>i.health>0).length===0){pe.debug("Cannot enter combat: no living enemies");return}pe.debug("Entering Combat Mode"),e.inCombat=!0,e.isPlayerTurn=!0,e.turnCount=1,e.engagementMode="combat"}},exitCombat:e=>{e.inCombat&&(pe.debug("Exiting Combat Mode"),e.inCombat=!1,e.isPlayerTurn=!0,e.turnCount=1,e.engagementMode="none")},setEngagementMode:(e,t)=>{e.engagementMode=t.payload},requestStealthToggle:e=>{e.stealthToggleRequestNonce+=1},switchTurn:e=>{e.inCombat&&(e.isPlayerTurn=!e.isPlayerTurn,e.isPlayerTurn?(e.turnCount++,pe.debug(`switchTurn: Starting Player Turn ${e.turnCount}`)):(pe.debug(`switchTurn: Starting Enemy Turn (during Player Turn ${e.turnCount})`),pe.debug("switchTurn: Resetting AP for all living enemies"),e.currentMapArea.entities.enemies.forEach((t,i)=>{t.health>0&&(e.currentMapArea.entities.enemies[i].actionPoints=t.maxActionPoints)})))},updateEnemy:(e,t)=>{const i=t.payload,s=a=>{const r=a.entities.enemies.findIndex(o=>o.id===i.id);return r===-1?!1:(i.health<=0?a.entities.enemies.splice(r,1):a.entities.enemies[r]=i,a.entities.enemies=[...a.entities.enemies],!0)};pe.debug("updateEnemy reducer running",{enemyId:i.id,health:i.health});const n=s(e.currentMapArea);Object.values(e.mapAreas).forEach(a=>{const r=s(a);!n&&r&&a.id===e.currentMapArea.id&&(e.currentMapArea.entities.enemies=[...e.currentMapArea.entities.enemies])}),i.health<=0&&(pe.debug(`updateEnemy: Enemy ${i.id} removed from all areas.`),e.currentMapArea.entities.enemies.filter(r=>r.health>0).length===0&&(pe.debug("updateEnemy: No living enemies remain. Clearing combat state."),e.inCombat=!1,e.isPlayerTurn=!0,e.turnCount=1))},addEnemy:(e,t)=>{const i={...t.payload};let s=es(i.position,e.currentMapArea);s||(s=Hn(i.position,e.currentMapArea,void 0,[]).find(r=>e.currentMapArea.entities.enemies.every(o=>o.position.x!==r.x||o.position.y!==r.y))??i.position),i.position=s,e.currentMapArea.entities.enemies.push(i),e.currentMapArea.entities.enemies=[...e.currentMapArea.entities.enemies]},removeEnemy:(e,t)=>{const i=t.payload;e.currentMapArea.entities.enemies=e.currentMapArea.entities.enemies.filter(s=>s.id!==i),e.currentMapArea.entities.enemies=[...e.currentMapArea.entities.enemies]},updateNPC:(e,t)=>{const i=t.payload,s=e.currentMapArea.entities.npcs.findIndex(n=>n.id===i.id);s!==-1&&(e.currentMapArea.entities.npcs[s]=i,e.currentMapArea.entities.npcs=[...e.currentMapArea.entities.npcs])},addNPC:(e,t)=>{e.currentMapArea.entities.npcs.push(t.payload),e.currentMapArea.entities.npcs=[...e.currentMapArea.entities.npcs]},removeNPC:(e,t)=>{const i=t.payload;e.currentMapArea.entities.npcs=e.currentMapArea.entities.npcs.filter(s=>s.id!==i),e.currentMapArea.entities.npcs=[...e.currentMapArea.entities.npcs]},addItemToMap:(e,t)=>{var r;const{item:i,position:s}=t.payload,n=(r=e.currentMapArea.tiles[s.y])==null?void 0:r[s.x];if(!n||!n.isWalkable||n.type===D.DOOR||n.type===D.WALL||Ml(e.currentMapArea,s))return;const a={...i,position:s};e.currentMapArea.entities.items.push(a)},removeItemFromMap:(e,t)=>{const i=t.payload;e.currentMapArea.entities.items=e.currentMapArea.entities.items.filter(s=>s.id!==i)},removeItemInstanceFromMap:(e,t)=>{const{id:i,position:s,name:n}=t.payload,a=e.currentMapArea.entities.items,r=a.filter(o=>{var d,u;const l=!!(i&&o.id===i),c=!!(s&&((d=o.position)==null?void 0:d.x)===s.x&&((u=o.position)==null?void 0:u.y)===s.y&&(!n||o.name===n));return!(l||c)});r.length!==a.length&&(e.currentMapArea.entities.items=r)},applyLocaleToWorld:(e,t)=>ta(t.payload),setGlobalAlertLevel:(e,t)=>{e.globalAlertLevel=t.payload;const i=t.payload===O.ALARMED?"high":t.payload===O.IDLE?"low":"med",s=t.payload===O.ALARMED?"rationed":t.payload===O.IDLE?"norm":"tight";e.environment.flags.gangHeat=i,e.environment.flags.supplyScarcity=s,t.payload===O.ALARMED?(e.environment.flags.blackoutTier="rolling",e.environment.flags.curfewLevel=Math.max(e.environment.flags.curfewLevel,3)):e.environment.flags.blackoutTier==="rolling"&&(e.environment.flags.blackoutTier=e.curfewActive?"brownout":"none",e.environment.flags.curfewLevel=e.curfewActive?2:0)},scheduleReinforcements:e=>{e.reinforcementsScheduled=!0,e.environment.flags.curfewLevel=3,e.globalAlertLevel===O.ALARMED&&(e.environment.flags.blackoutTier="rolling")},clearReinforcementsSchedule:e=>{e.reinforcementsScheduled=!1,e.environment.flags.curfewLevel=e.curfewActive?2:0,e.environment.flags.blackoutTier!=="rolling"&&(e.environment.flags.blackoutTier=e.curfewActive?"brownout":"none")}}}),{setEnvironmentFlags:cm,applyEnvironmentWeather:dm,applyEnvironmentSignage:um,removeEnvironmentSignage:hm,applyEnvironmentRumorSet:pm,removeEnvironmentRumorSet:mm,registerEnvironmentalNote:gm,clearEnvironmentalNotesForArea:fm,setNpcAmbientProfile:ym,setMapArea:Sm,setCurrentMapAreaZoneMetadata:vm,updateGameTime:sa,setGameTime:Cl,enterCombat:bm,exitCombat:wm,switchTurn:_t,updateEnemy:kl,addEnemy:Pm,removeEnemy:Mm,updateNPC:Am,addNPC:xm,removeNPC:Im,addItemToMap:Cm,removeItemFromMap:km,removeItemInstanceFromMap:Tm,applyLocaleToWorld:Tl,setGlobalAlertLevel:Rm,scheduleReinforcements:Em,clearReinforcementsSchedule:_m,setEngagementMode:Dm,requestStealthToggle:Lm,setWorkbenchAvailable:Fm,setWorkbenchStatus:Bm}=ia.actions,na=ia.reducer,Ei=e=>{const t=ii(e);return{quests:t.quests,dialogues:t.dialogues,activeDialogue:{dialogueId:null,currentNodeId:null},lastBriefing:{dialogueId:null,nodeId:null}}},Rl=Ei(Te),aa=ee({name:"quests",initialState:Rl,reducers:{addQuest:(e,t)=>{e.quests.push(t.payload)},updateQuest:(e,t)=>{const i=t.payload,s=e.quests.findIndex(n=>n.id===i.id);s!==-1&&(e.quests[s]=i)},startQuest:(e,t)=>{const i=t.payload,s=e.quests.find(n=>n.id===i);s&&!s.isActive&&!s.isCompleted&&(s.isActive=!0)},completeQuest:(e,t)=>{const i=t.payload,s=e.quests.find(n=>n.id===i);s&&s.isActive&&(s.isActive=!1,s.isCompleted=!0)},updateObjectiveStatus:(e,t)=>{const{questId:i,objectiveId:s,isCompleted:n}=t.payload,a=e.quests.find(r=>r.id===i);if(a){const r=a.objectives.find(o=>o.id===s);r&&(r.isCompleted=n)}},updateObjectiveCounter:(e,t)=>{const{questId:i,objectiveId:s,count:n}=t.payload,a=e.quests.find(r=>r.id===i);if(a){const r=a.objectives.find(o=>o.id===s);if(r&&(r.type==="collect"||r.type==="kill")){const o=r.count||1,l=(r.currentCount||0)+n;r.currentCount=Math.min(l,o),r.currentCount>=o&&(r.isCompleted=!0)}}},addDialogue:(e,t)=>{e.dialogues.push(t.payload)},startDialogue:(e,t)=>{const{dialogueId:i,nodeId:s}=t.payload;e.activeDialogue={dialogueId:i,currentNodeId:s},e.lastBriefing={dialogueId:i,nodeId:s}},setDialogueNode:(e,t)=>{e.activeDialogue.currentNodeId=t.payload,t.payload&&(e.lastBriefing={dialogueId:e.activeDialogue.dialogueId,nodeId:t.payload})},endDialogue:e=>{e.activeDialogue={dialogueId:null,currentNodeId:null}},resetQuests:(e,t)=>Ei(t.payload??Te),applyLocaleToQuests:(e,t)=>Ei(t.payload)}}),{addQuest:Om,updateQuest:Nm,startQuest:Hm,completeQuest:Wm,updateObjectiveStatus:Gm,updateObjectiveCounter:qm,addDialogue:Vm,startDialogue:zm,setDialogueNode:Um,endDialogue:Km,resetQuests:jm,applyLocaleToQuests:El}=aa.actions,_l=aa.reducer,Dl={id:"level0_recover_cache",resourceKey:"missions.level0.recover_cache",levelKey:"levels.slums_command_grid",kind:"primary",questKeys:["quests.market_cache"],relatedNpcKeys:["npcs.lira_smuggler"],generatedSceneKeys:["scenes.level0.recover_cache.ambush_route"]},Ll={id:"level0_decrypt_manifests",resourceKey:"missions.level0.decrypt_manifests",levelKey:"levels.slums_command_grid",kind:"primary",questKeys:["quests.datapad_truth"],relatedNpcKeys:["npcs.archivist_naila"]},Fl={id:"level0_rebuild_courier_network",resourceKey:"missions.level0.rebuild_courier_network",levelKey:"levels.slums_command_grid",kind:"primary",questKeys:["quests.courier_network"],relatedNpcKeys:["npcs.courier_brant"]},Bl={id:"level0_blackout_camera_grid",resourceKey:"missions.level0.blackout_camera_grid",levelKey:"levels.slums_command_grid",kind:"side",questKeys:["quests.equipment_sabotage"],factionTag:"resistance",relatedNpcKeys:["npcs.firebrand_juno"]},Ol={id:"level0_map_drone_patrols",resourceKey:"missions.level0.map_drone_patrols",levelKey:"levels.slums_command_grid",kind:"side",questKeys:["quests.drone_recon"],relatedNpcKeys:["npcs.drone_handler_kesh"]},Nl={id:"level0_restock_rebel_clinic",resourceKey:"missions.level0.restock_rebel_clinic",levelKey:"levels.slums_command_grid",kind:"side",questKeys:["quests.medkit_supplies"],relatedNpcKeys:["npcs.medic_yara"]},Hl={id:"level0_clear_transit_patrol",resourceKey:"missions.level0.clear_transit_patrol",levelKey:"levels.slums_command_grid",kind:"side",questKeys:["quests.combat_patrol"],relatedNpcKeys:["npcs.captain_reyna"]},Wl={id:"level1_seize_governance_archives",resourceKey:"missions.level1.seize_governance_archives",levelKey:"levels.downtown_governance_ring",kind:"primary",questKeys:["quests.government_archives"],relatedNpcKeys:[]},Gl={id:"level1_override_curfew_terminals",resourceKey:"missions.level1.override_curfew_terminals",levelKey:"levels.downtown_governance_ring",kind:"primary",questKeys:["quests.curfew_override"],relatedNpcKeys:[]},ql={id:"level1_extract_detained_couriers",resourceKey:"missions.level1.extract_detained_couriers",levelKey:"levels.downtown_governance_ring",kind:"primary",questKeys:["quests.prison_break"],relatedNpcKeys:[]},Vl={id:"level1_hijack_camera_resync",resourceKey:"missions.level1.hijack_camera_resync",levelKey:"levels.downtown_governance_ring",kind:"side",questKeys:["quests.camera_resync"],relatedNpcKeys:[]},zl={id:"level1_divert_supply_convoys",resourceKey:"missions.level1.divert_supply_convoys",levelKey:"levels.downtown_governance_ring",kind:"side",questKeys:["quests.supply_diversion"],relatedNpcKeys:[]},Ul={id:"level1_broadcast_resistance_propaganda",resourceKey:"missions.level1.broadcast_resistance_propaganda",levelKey:"levels.downtown_governance_ring",kind:"side",questKeys:["quests.plaza_broadcast"],relatedNpcKeys:[]},Kl={id:"level2_stabilise_refinery_outpost",resourceKey:"missions.level2.stabilise_refinery_outpost",levelKey:"levels.industrial_wasteland",kind:"primary",questKeys:["quests.refinery_stabilization"],relatedNpcKeys:[]},jl={id:"level2_cripple_convoy_routes",resourceKey:"missions.level2.cripple_convoy_routes",levelKey:"levels.industrial_wasteland",kind:"primary",questKeys:["quests.convoy_ambush"],relatedNpcKeys:[]},$l={id:"level2_recover_filtration_core",resourceKey:"missions.level2.recover_filtration_core",levelKey:"levels.industrial_wasteland",kind:"primary",questKeys:["quests.filtration_recovery"],relatedNpcKeys:[]},Yl={id:"level2_broker_scavenger_truce",resourceKey:"missions.level2.broker_scavenger_truce",levelKey:"levels.industrial_wasteland",kind:"side",questKeys:["quests.scavenger_truce"],factionTag:"scavengers",relatedNpcKeys:[]},Zl={id:"level2_stabilise_power_grid",resourceKey:"missions.level2.stabilise_power_grid",levelKey:"levels.industrial_wasteland",kind:"side",questKeys:["quests.power_grid"],relatedNpcKeys:[]},Xl={id:"level2_secure_evacuation_lanes",resourceKey:"missions.level2.secure_evacuation_lanes",levelKey:"levels.industrial_wasteland",kind:"side",questKeys:["quests.industrial_evac"],relatedNpcKeys:[]},Ql=[Dl,Ll,Fl,Bl,Ol,Nl,Hl,Wl,Gl,ql,Vl,zl,Ul,Kl,jl,$l,Yl,Zl,Xl],Jl=Ql.reduce((e,t)=>(e[t.resourceKey]=t,e),{}),ec=e=>{const t=Jl[e];if(!t)throw new Error(`Unknown mission resource key: ${e}`);return t},tc=(e,t)=>{const i=t.missions[e.resourceKey];if(!i)throw new Error(`Missing locale entry for mission ${e.resourceKey}`);const s=e.questKeys.map(n=>{const a=tr[n];if(!a)throw new Error(`Mission ${e.resourceKey} references unknown quest key ${n}`);return a.id});return{id:e.id,label:i.label,summary:i.summary,questIds:s,kind:e.kind,recommendedLevel:e.recommendedLevel,factionTag:e.factionTag}},ic=(e,t)=>{const i=t.levels[e.resourceKey],s=e.missionKeys.map(ec).map(n=>tc(n,t));return{level:e.order,levelId:e.id,name:(i==null?void 0:i.name)??e.id,zoneId:e.zoneKey,objectives:s}},sc=e=>{const t=ir(e);return er.map(i=>ic(i,t))},nc=e=>sc(e).map(i=>({level:i.level,levelId:i.levelId,name:i.name,zoneId:i.zoneId,objectives:i.objectives.map(s=>({...s,questIds:[...s.questIds]}))})),_i=(e=Te)=>({levels:nc(e),currentLevelIndex:0,pendingAdvance:!1,celebrationAcknowledged:!1,lastMissionCompletedAt:null}),ac=_i(Te),ra=ee({name:"missions",initialState:ac,reducers:{missionAccomplished(e){e.pendingAdvance||(e.pendingAdvance=!0,e.celebrationAcknowledged=!1,e.lastMissionCompletedAt=Date.now())},acknowledgeMissionAccomplished(e){e.celebrationAcknowledged=!0},deferMissionAdvance(e){e.celebrationAcknowledged=!0},showMissionAdvancePrompt(e){e.pendingAdvance&&(e.celebrationAcknowledged=!1)},advanceToNextLevel(e){e.currentLevelIndex<e.levels.length-1&&(e.currentLevelIndex+=1),e.pendingAdvance=!1,e.celebrationAcknowledged=!1},resetMissions:(e,t)=>_i(t.payload??Te),applyLocaleToMissions:(e,t)=>_i(t.payload)}}),{missionAccomplished:$m,acknowledgeMissionAccomplished:Ym,deferMissionAdvance:Zm,showMissionAdvancePrompt:Xm,advanceToNextLevel:Qm,resetMissions:Jm,applyLocaleToMissions:rc}=ra.actions,oc=ra.reducer,lc={messages:[]},oa=ee({name:"log",initialState:lc,reducers:{addLogMessage(e,t){const s=[...e.messages,t.payload];s.length>50&&s.shift(),e.messages=s,console.log(`[Log] ${t.payload}`)},clearLog(e){e.messages=[]}},extraReducers:e=>{e.addCase(Cl,(t,i)=>{ft(i.payload,G)&&t.messages.length===0&&(t.messages=["Searchlights pin you in the open—duck inside before the patrols lock on."])})}}),{addLogMessage:xe,clearLog:eg}=oa.actions,cc=oa.reducer,yi=e=>e,Di={balanced:yi({id:"balanced",label:"Balanced",description:"Evaluates offence and defence evenly. Prioritises clear shots, keeps moderate AP reserve, and falls back to cover if health dips.",weights:{attackBias:1,focusLowestHealth:.75,focusOverwatchThreat:.85,maintainCover:.8,pursuitAggression:.65,consumableAggression:.5,retreatBias:.6},thresholds:{panicHealthFraction:.35,apReserve:1,minimumConsumableCharges:1}}),aggressive:yi({id:"aggressive",label:"Aggressive",description:"Closes distance, spends AP rapidly, and consumes resources to finish priority targets. Retreats only when near death.",weights:{attackBias:1.35,focusLowestHealth:1.1,focusOverwatchThreat:.7,maintainCover:.35,pursuitAggression:1.2,consumableAggression:1,retreatBias:.2},thresholds:{panicHealthFraction:.2,apReserve:0,minimumConsumableCharges:0}}),defensive:yi({id:"defensive",label:"Defensive",description:"Holds positions with strong cover, conserves consumables, and only advances when safe. Will disengage early if health drops.",weights:{attackBias:.6,focusLowestHealth:.55,focusOverwatchThreat:1.25,maintainCover:1.6,pursuitAggression:.3,consumableAggression:.25,retreatBias:1.4},thresholds:{panicHealthFraction:.5,apReserve:2,minimumConsumableCharges:2}})},dc="balanced",tg=Object.keys(Di),Ws=e=>Di[e]??Di.balanced,uc={locale:Te,testMode:!1,autoBattleEnabled:!1,autoBattleProfile:dc,visualQualityPreset:"balanced",lightsEnabled:!1,autoStealthEnabled:!1,reputationSystemsEnabled:!1},la=ee({name:"settings",initialState:uc,reducers:{setLocale:(e,t)=>{e.locale=t.payload},setTestMode:(e,t)=>{e.testMode=t.payload},setAutoBattleEnabled:(e,t)=>{e.autoBattleEnabled=t.payload},setAutoBattleProfile:(e,t)=>{e.autoBattleProfile=t.payload},setVisualQualityPreset:(e,t)=>{e.visualQualityPreset=t.payload},setLightsEnabled:(e,t)=>{e.lightsEnabled=t.payload},setAutoStealthEnabled:(e,t)=>{e.autoStealthEnabled=t.payload},setReputationSystemsEnabled:(e,t)=>{e.reputationSystemsEnabled=t.payload}}}),{setLocale:ig,setTestMode:sg,setAutoBattleEnabled:ng,setAutoBattleProfile:ag,setVisualQualityPreset:rg,setLightsEnabled:Gs,setAutoStealthEnabled:og,setReputationSystemsEnabled:lg}=la.actions,ca=la.reducer,hc={floatingNumbers:[],hitFlashes:[],activeFlashId:null},da=ee({name:"combatFeedback",initialState:hc,reducers:{addFloatingNumber:(e,t)=>{e.floatingNumbers.push(t.payload)},removeFloatingNumber:(e,t)=>{e.floatingNumbers=e.floatingNumbers.filter(i=>i.id!==t.payload)},triggerHitFlash:(e,t)=>{e.activeFlashId=t.payload.id,e.hitFlashes.push(t.payload)},clearHitFlash:e=>{e.activeFlashId=null,e.hitFlashes=[]},clearAllFeedback:e=>{e.floatingNumbers=[],e.hitFlashes=[],e.activeFlashId=null}}}),{addFloatingNumber:pc,removeFloatingNumber:cg,triggerHitFlash:dg,clearHitFlash:ug,clearAllFeedback:hg}=da.actions,mc=da.reducer,gc=()=>({overlayEnabled:!0,camerasNearby:0,detectionProgress:0,activeCameraId:null,alertState:$.IDLE,networkAlertActive:!1,networkAlertExpiresAt:null}),qs={zones:{},hud:gc(),curfewBanner:{visible:!1,lastActivatedAt:null}},ua=ee({name:"surveillance",initialState:qs,reducers:{registerZoneCameras:(e,t)=>{const{areaId:i,zoneId:s,cameras:n,timestamp:a}=t.payload,r=n.reduce((o,l)=>(o[l.id]={...l},o),{});e.zones[i]={areaId:i,zoneId:s,cameras:r,networkAlert:null,lastUpdatedAt:a}},updateCameraState:(e,t)=>{const{areaId:i,cameraId:s,changes:n,timestamp:a}=t.payload,r=e.zones[i];if(!r)return;const o=r.cameras[s];o&&(r.cameras[s]={...o,...n},r.lastUpdatedAt=a)},setCameraNetworkAlert:(e,t)=>{const{areaId:i,alert:s}=t.payload,n=e.zones[i];n&&(n.networkAlert=s?{...s}:null)},updateHudState:(e,t)=>{const i=t.payload;e.hud={...e.hud,...i},typeof i.networkAlertActive=="boolean"&&!i.networkAlertActive&&(e.hud.networkAlertExpiresAt=null),typeof i.networkAlertExpiresAt=="number"&&(e.hud.networkAlertActive=!0)},setOverlayEnabled:(e,t)=>{e.hud.overlayEnabled=t.payload.enabled},setCurfewBanner:(e,t)=>{e.curfewBanner.visible=t.payload.visible,t.payload.visible&&(e.curfewBanner.lastActivatedAt=t.payload.timestamp)},clearZoneCameras:(e,t)=>{const{areaId:i}=t.payload;delete e.zones[i]},resetSurveillanceState:()=>qs}}),{registerZoneCameras:pg,updateCameraState:mg,setCameraNetworkAlert:gg,updateHudState:fg,setOverlayEnabled:yg,setCurfewBanner:Sg,clearZoneCameras:vg,resetSurveillanceState:bg}=ua.actions,ha=ua.reducer,fc=[{id:"npc_lira_vendor",name:"Lira the Smuggler",kind:"contact",tags:["resistance","strategist","ally","bonded","quartermaster"],traits:["resistance","strategist","bonded"],factionId:"resistance",relationship:"bonded"},{id:"npc_archivist_naila",name:"Archivist Naila",kind:"contact",tags:["resistance","scholar","ally"],traits:["scholar","resistance"],factionId:"resistance",relationship:"ally"},{id:"npc_courier_brant",name:"Courier Brant",kind:"contact",tags:["resistance","runner","ally"],traits:["runner","ally"],factionId:"resistance",relationship:"ally"},{id:"npc_firebrand_juno",name:"Firebrand Juno",kind:"contact",tags:["resistance","agitator","ally","witness"],traits:["agitator"],factionId:"resistance",relationship:"ally"},{id:"npc_seraph_warden",name:"Seraph Warden",kind:"contact",tags:["corpsec","warden","rival"],traits:["corpsec","rival"],factionId:"corpsec",relationship:"rival"},{id:"npc_drone_handler_kesh",name:"Drone Handler Kesh",kind:"contact",tags:["resistance","tech","ally"],traits:["technician"],factionId:"resistance",relationship:"ally"}],yc={npc_lira_vendor:{tags:["resistance","ally","quartermaster","bonded"],traits:["strategist","bonded"],relationship:"bonded",factionId:"resistance"},npc_archivist_naila:{tags:["resistance","ally","scholar"],traits:["scholar"],relationship:"ally",factionId:"resistance"},npc_courier_brant:{tags:["resistance","ally","runner"],traits:["runner"],relationship:"ally",factionId:"resistance"},npc_firebrand_juno:{tags:["resistance","ally","agitator"],traits:["agitator"],relationship:"ally",factionId:"resistance"},npc_seraph_warden:{tags:["corpsec","rival","warden"],traits:["corpsec","rival"],relationship:"rival",factionId:"corpsec"},npc_drone_handler_kesh:{tags:["resistance","ally","tech"],traits:["technician"],relationship:"ally",factionId:"resistance"},npc_medic_yara:{tags:["resistance","ally","medic"],traits:["medic"],relationship:"ally",factionId:"resistance"},npc_captain_reyna:{tags:["resistance","ally","commander"],traits:["commander"],relationship:"ally",factionId:"resistance"}},Li=(e,t)=>{e.has(t.id)||e.set(t.id,{...t,tags:[...t.tags],traits:[...t.traits]})},Sc=(e,t,i)=>{const s=e.get(t.id);if(!s){Li(e,t);return}s.tags=Array.from(new Set([...s.tags,...t.tags])),s.traits=Array.from(new Set([...s.traits,...t.traits]))},vc=({player:e,npcs:t})=>{var a;const i=new Map;fc.forEach(r=>Li(i,r));const s=e.maxHealth>0?e.maxHealth*.65:e.maxHealth,n={id:e.id,name:e.name||"Operative",kind:"player",tags:["player","operative","ally"],traits:[((a=e.personality)==null?void 0:a.alignment)??"earnest"],factionId:"resistance",wounded:e.health<s,relationship:"ally",backgroundId:e.backgroundId};return e.backgroundId&&n.tags.push(e.backgroundId),e.perks.length>0&&n.tags.push("perked"),Li(i,n),t.forEach(r=>{const o=r.dialogueId??r.id;if(!o)return;const l={id:o,name:r.name,kind:r.isInteractive?"contact":"npc",tags:["npc",r.isInteractive?"ally":"witness"],traits:[],wounded:r.health<r.maxHealth,relationship:r.isInteractive?"ally":"witness"},c=yc[o];c&&(l.tags.push(...c.tags),c.traits&&l.traits.push(...c.traits),c.relationship&&(l.relationship=c.relationship),c.factionId&&(l.factionId=c.factionId)),Sc(i,l)}),Array.from(i.values())},Vs=(e,t,i)=>{var n;if(t.requiredTags&&!t.requiredTags.every(a=>i.tags.includes(a))||t.forbiddenTags&&t.forbiddenTags.some(a=>i.tags.includes(a))||t.requiredTraits&&!t.requiredTraits.every(a=>i.traits.includes(a))||t.forbiddenTraits&&t.forbiddenTraits.some(a=>i.traits.includes(a))||i.wounded&&t.allowWounded===!1)return null;let s=1;return t.preferredTags&&t.preferredTags.forEach(a=>{i.tags.includes(a)&&(s+=2)}),t.requiredTraits&&(s+=t.requiredTraits.length),i.relationship&&((n=t.preferredTags)!=null&&n.includes(i.relationship))&&(s+=1.5),i.kind==="player"&&e!=="protagonist"&&(s-=.25),s},bc=(e,t)=>{const i=[...t],s={},n=new Set;let a=0;const r=t.find(o=>o.kind==="player");for(const o of e.roles){let l=null;for(const c of i){if(c.kind!=="player"&&n.has(c.id))continue;const d=Vs(o.id,o,c);d!=null&&(!l||d>l.score)&&(l={roleId:o.id,actor:c,score:d})}if(!l&&o.fallbackToPlayer&&r){const c=Vs(o.id,o,r);c!=null&&(l={roleId:o.id,actor:r,score:Math.max(.5,c)})}if(!l)return null;s[o.id]=l.actor,a+=l.score,l.actor.kind!=="player"&&n.add(l.actor.id)}return{resolvedRoles:s,totalScore:a}},wc=(e,t,i)=>!e.conditions||e.conditions.length===0?!0:e.conditions.every(s=>{var n;switch(s.type){case"roleTrait":{const a=t[s.roleId];return a?a.traits.includes(s.trait):!1}case"roleTag":{const a=t[s.roleId];return a?a.tags.includes(s.tag):!1}case"roleRelationship":{const a=t[s.roleId];return a?a.relationship===s.relationship:!1}case"roleStatus":{const a=t[s.roleId];return s.status==="wounded"?!!(a!=null&&a.wounded):!1}case"contextTag":return!!((n=i.tags)!=null&&n.includes(s.tag));case"contextArc":return i.arc===s.arc;default:return!1}}),Pc=(e,t,i)=>{let s=null,n=-1/0;for(const a of e.branches){if(!wc(a,t,i))continue;const r=a.weight??1;(!s||r>n)&&(s=a,n=r)}return s??e.branches[0]??null},Mc=(e,t)=>e.triggers.some(i=>{if(i.type!==t.type)return!1;if(i.tags&&i.tags.length>0){const s=t.tags??[];return i.tags.every(n=>s.includes(n))}return!0}),Ac=(e,t,i,s)=>{const n=e.entries[t.id];return!!(n!=null&&n.cooldownExpiresAt&&n.cooldownExpiresAt>s||t.cooldown.perLocation&&i&&e.lastSeenByLocation[i]===t.id&&n!=null&&n.cooldownExpiresAt&&n.cooldownExpiresAt>s)},xc=({plays:e,runtime:t,trigger:i,actorPool:s,now:n,locationId:a})=>{let r=null,o=-1/0;for(const l of e){if(l.arc!==i.arc||!Mc(l,i)||Ac(t,l,a,n))continue;const c=bc(l,s);if(!c)continue;const d=Pc(l,c.resolvedRoles,i);if(!d)continue;const u=t.entries[l.id];let h=(l.weight??1)+c.totalScore+(d.weight??1);u&&(h-=u.timesTriggered*.75),h>o&&(o=h,r={storyletId:l.id,play:l,branch:d,outcome:d.outcome,resolvedRoles:c.resolvedRoles,context:i,timestamp:n,cooldownExpiresAt:n+l.cooldown.durationMs})}return r},Ic=e=>e<=0?"act1_setup":e===1?"act2_escalation":"act3_finale",pa=[{id:"firelight_ambush",arc:"act1_setup",titleKey:"storylets.firelight_ambush.title",synopsisKey:"storylets.firelight_ambush.synopsis",tags:["ambush","resistance","omen"],triggers:[{type:"missionCompletion",tags:["resistance"],intensity:"medium"}],roles:[{id:"protagonist",titleKey:"storylets.roles.protagonist",preferredTags:["operative","player"],fallbackToPlayer:!0,allowWounded:!0},{id:"mentor",titleKey:"storylets.roles.mentor",requiredTags:["resistance"],preferredTags:["strategist","quartermaster"]},{id:"witness",titleKey:"storylets.roles.witness",preferredTags:["civilian","witness"],allowWounded:!1,fallbackToPlayer:!0}],branches:[{id:"scarred_victory",weight:2,conditions:[{type:"roleStatus",roleId:"protagonist",status:"wounded"}],outcome:{id:"scarred_victory",localizationKey:"storylets.firelight_ambush.outcomes.scarred_victory",variantKey:"wounded",effects:[{type:"faction",factionId:"resistance",delta:8,reason:"storylet:firelight_ambush"},{type:"log",logKey:"storylets.firelight_ambush.log.wounded",severity:"info"}],tags:["injury","loyalty"]}},{id:"clean_sweep",outcome:{id:"clean_sweep",localizationKey:"storylets.firelight_ambush.outcomes.clean_sweep",effects:[{type:"faction",factionId:"resistance",delta:5,reason:"storylet:firelight_ambush"},{type:"log",logKey:"storylets.firelight_ambush.log.clean",severity:"info"}],tags:["loyalty"]}}],cooldown:{durationMs:1e3*60*20,perLocation:!0},weight:3},{id:"neon_bivouac",arc:"act2_escalation",titleKey:"storylets.neon_bivouac.title",synopsisKey:"storylets.neon_bivouac.synopsis",tags:["relationship","rest","memory"],triggers:[{type:"campfireRest",tags:["rest"],intensity:"low"}],roles:[{id:"protagonist",titleKey:"storylets.roles.protagonist",preferredTags:["operative","player"],fallbackToPlayer:!0,allowWounded:!0},{id:"confidant",titleKey:"storylets.roles.confidant",requiredTags:["ally"],preferredTags:["bonded","scholar","strategist"],allowWounded:!0}],branches:[{id:"bond_renewed",weight:3,conditions:[{type:"roleRelationship",roleId:"confidant",relationship:"bonded"}],outcome:{id:"bond_renewed",localizationKey:"storylets.neon_bivouac.outcomes.bond_renewed",variantKey:"bonded",effects:[{type:"log",logKey:"storylets.neon_bivouac.log.bonded",severity:"info"},{type:"traitDelta",target:"player",trait:"earnest",delta:1}],tags:["relationship","loyalty"]}},{id:"quiet_distance",outcome:{id:"quiet_distance",localizationKey:"storylets.neon_bivouac.outcomes.quiet_distance",effects:[{type:"log",logKey:"storylets.neon_bivouac.log.distance",severity:"info"}],tags:["memory"]}}],cooldown:{durationMs:1e3*60*30,perLocation:!0},weight:2},{id:"serrated_omen",arc:"act3_finale",titleKey:"storylets.serrated_omen.title",synopsisKey:"storylets.serrated_omen.synopsis",tags:["ambush","corpsec","injury","omen"],triggers:[{type:"patrolAmbush",tags:["corpsec","ambush"],intensity:"high"}],roles:[{id:"protagonist",titleKey:"storylets.roles.protagonist",preferredTags:["operative","player"],fallbackToPlayer:!0,allowWounded:!0},{id:"rival",titleKey:"storylets.roles.rival",requiredTags:["corpsec"],preferredTags:["rival","warden"],allowWounded:!0},{id:"witness",titleKey:"storylets.roles.witness",preferredTags:["resistance","ally"],allowWounded:!0,fallbackToPlayer:!1}],branches:[{id:"rivalry_ignites",weight:2,conditions:[{type:"roleRelationship",roleId:"rival",relationship:"rival"}],outcome:{id:"rivalry_ignites",localizationKey:"storylets.serrated_omen.outcomes.rivalry_ignites",variantKey:"rival",effects:[{type:"faction",factionId:"corpsec",delta:-10,reason:"storylet:serrated_omen"},{type:"playerHealth",delta:-4,allowKO:!1},{type:"log",logKey:"storylets.serrated_omen.log.rival",severity:"warning"}],tags:["injury","corpsec"]}},{id:"shadows_scatter",outcome:{id:"shadows_scatter",localizationKey:"storylets.serrated_omen.outcomes.shadows_scatter",effects:[{type:"log",logKey:"storylets.serrated_omen.log.default",severity:"info"}],tags:["ambush"]}}],cooldown:{durationMs:1e3*60*25,perLocation:!0},weight:3}];pa.reduce((e,t)=>(e[t.id]=t,e),{});const Cc=()=>pa,ma={roles:{protagonist:"Operative",mentor:"Mentor",witness:"Witness",confidant:"Confidant",rival:"Rival"},plays:{firelight_ambush:{title:"Firelight Ambush",synopsis:"After the crates are reclaimed, the cell huddles around a burn barrel to measure the cost of provoking CorpSec patrols.",roles:{protagonist:"Operative",mentor:"Quartermaster",witness:"Runner"},outcomes:{scarred_victory:{base:{narrative:"{mentor} studies the bandaged gouge across {protagonist}’s ribs. “You took the hit so the crates could run. That balance clears.”",logLine:"Lira marks your scars as the price of keeping the supply line alive."},variants:{wounded:{narrative:"{mentor} catches {protagonist} before they slide to the bricks. She seals the fresh wound, the firelight flickering across the stimulant foam. “Next patrol never makes it to the siren,” she vows, voice steady for {witness}’s sake.",logLine:"Lira steadies you, promising the next patrol will never raise an alarm."}}},clean_sweep:{base:{narrative:"The burn barrel sends sparks up past the transit rails. {protagonist} tips confiscated batons into the fire while {mentor} and {witness} sketch new blind spots across a soot-streaked map.",logLine:"The cell celebrates the clean strike and notebooks fill with new patrol gaps."}}}},neon_bivouac:{title:"Neon Bivouac",synopsis:"The crew slumps beneath a humming holo-ad, sharing contraband rations while the grid cools. Stories trade faster than the battered thermos.",roles:{protagonist:"Operative",confidant:"Confidant"},outcomes:{bond_renewed:{base:{narrative:"{confidant} nudges a tin mug into {protagonist}’s hands. “Remember the rooftops in District Eight?” The laugh that follows is low and unguarded, the neon glow framing two conspirators instead of soldiers.",logLine:"{confidant} shares an old war story and the bivouac feels like home again."},variants:{bonded:{narrative:"{confidant} leans shoulder to shoulder with {protagonist}, the steam from the thermos curling between matching scars. “When we ran the Gridfall evac we swore never to sleep alone on watch again. Still true.”",logLine:"{confidant} reaffirms the pact forged during Gridfall and your bond deepens."}}},quiet_distance:{base:{narrative:"The neon hum fills the silence between {protagonist} and {confidant}. They trade reports instead of memories, each syllable an inventory count that never strays into feeling.",logLine:"Camp chatter stays clipped—nerves too raw for stories tonight."}}}},serrated_omen:{title:"Serrated Omen",synopsis:"A CorpSec counter-sweep slams into the team on their way back through the alleys. The clash leaves a metallic stink and unanswered questions.",roles:{protagonist:"Operative",rival:"Adversary",witness:"Witness"},outcomes:{rivalry_ignites:{base:{narrative:"{rival}’s monofilament blade sparks off the barricade, carving a groove through {protagonist}’s armor. “I told you the curfew rites were mine to enforce,” she hisses, visor fractured yet unyielding.",logLine:"Seraph Warden carves a warning across your armor and vows the next hunt will finish it."},variants:{rival:{narrative:"{rival} vents ozone from her pauldrons, the mask reflecting {protagonist}’s blood. “You survived my ambush twice. Next time I bring witnesses.” {witness} pulls you back before the second strike lands.",logLine:"Seraph Warden leaves you bleeding but breathing—her promise of a final duel hangs heavy."}}},shadows_scatter:{base:{narrative:"Sirens bloom and the alleys dissolve into darkness. {protagonist} fires blind, smoke swallowing {rival} while {witness} drags the wounded out before drones arrive.",logLine:"You slip the net, but CorpSec frequencies crackle with renewed suspicion."}}}}},logs:{"storylets.firelight_ambush.log.wounded":"Lira steadies you, promising the next patrol will never raise an alarm.","storylets.firelight_ambush.log.clean":"The cell celebrates the clean strike and notebooks fill with new patrol gaps.","storylets.neon_bivouac.log.bonded":"Sharing Gridfall memories, your confidant reminds you why the fire still burns.","storylets.neon_bivouac.log.distance":"Camp chatter stays clipped—nerves too raw for stories tonight.","storylets.serrated_omen.log.rival":"Seraph Warden leaves you bleeding but breathing—her promise of a final duel hangs heavy.","storylets.serrated_omen.log.default":"You lose her in the smoke, but CorpSec channels crackle with orders to tighten the cordon."}},kc={roles:{protagonist:"Оперативник",mentor:"Кураторка",witness:"Свідок",confidant:"Довірена особа",rival:"Суперниця"},plays:{firelight_ambush:{title:"Засідка у вогнях",synopsis:"Після повернення контрабандних ящиків осередок гріється біля бочки й рахує ціну, яку доведеться платити за розлючені патрулі CorpSec.",roles:{protagonist:"Оперативник",mentor:"Квартирмейстерка",witness:"Розвідник"},outcomes:{scarred_victory:{base:{narrative:"{mentor} розглядає перев’язаний поріз на ребрах {protagonist}. «Ти прийняв удар, щоб вантаж дійшов. Рахунок закрито».",logLine:"Ліра фіксує шрам як обов’язкову плату за живу лінію постачання."},variants:{wounded:{narrative:"{mentor} підхоплює {protagonist}, поки той не впав на бруківку. Вона заливає свіже поранення піною, іскри від вогню тремтять у її очах. «Наступний патруль не доживе до сирени», — кидає вона, щоб заспокоїти {witness}.",logLine:"Ліра підтримує тебе й клянеться, що наступний патруль навіть не встигне подати тривогу."}}},clean_sweep:{base:{narrative:"Жар від бочки освітлює спорядження. {protagonist} кидає конфісковані кийки у вогонь, поки {mentor} та {witness} малюють нові «сліпі зони» на закіптюженій мапі.",logLine:"Осередок святкує чисту операцію й занотовує нові прогалини у патрулях."}}}},neon_bivouac:{title:"Неоновий бівак",synopsis:"Команда притискається під гудінням голографічної реклами, ділячись пайками та історіями, поки мережа остигає.",roles:{protagonist:"Оперативник",confidant:"Довірена особа"},outcomes:{bond_renewed:{base:{narrative:"{confidant} підсовує {protagonist} розігрітий кухоль. «Пам’ятаєш дахи у Восьмому секторі?» Сміх глухий і теплий, неонове сяйво робить із них двох змовників, а не солдатів.",logLine:"{confidant} ділиться старою історією, і бівак знову відчувається домом."},variants:{bonded:{narrative:"{confidant} торкається плечем до плеча {protagonist}, пара від термоса обвішує їхні парні шрами. «На евакуації Gridfall ми поклялися не стояти на варті на самоті. Обіцянка діє», — шепоче вона.",logLine:"{confidant} нагадує про клятву часів Gridfall, і ваш зв’язок міцнішає."}}},quiet_distance:{base:{narrative:"Неонове гудіння заповнює паузу між {protagonist} та {confidant}. Вони обмінюються лише рапортами, кожне слово — це інвентаризація без жодної емоції.",logLine:"Розмови біля вогню уривчасті — нерви надто натягнуті для спогадів."}}}},serrated_omen:{title:"Зазубрений знак",synopsis:"Контр-рейд CorpSec накриває групу у провулках. Металевий присмак зависає в повітрі, залишаючи запитання без відповіді.",roles:{protagonist:"Оперативник",rival:"Суперниця",witness:"Свідок"},outcomes:{rivalry_ignites:{base:{narrative:"Лезо {rival} креслить іскри по барикаді, розрізаючи броню {protagonist}. «Комендантська година — моя прерогатива», — шипить вона крізь тріснутий візор.",logLine:"Сераф-варден залишає поріз на твоїй броні й обіцяє, що наступне полювання буде останнім."},variants:{rival:{narrative:"{rival} випускає озон із наплічників, маска віддзеркалює кров {protagonist}. «Двічі ти вислизнув. Наступного разу я приведу свідків». {witness} шарпає тебе назад, перш ніж вона наносить другий удар.",logLine:"Сераф-варден залишає тебе пораненим, але живим — і призначає фінальний двобій."}}},shadows_scatter:{base:{narrative:"Сирени розквітають, провулки ковтає дим. {protagonist} стріляє навмання, {rival} губиться в тіні, поки {witness} витягує поранених до прибуття дронів.",logLine:"Вам вдається вислизнути, але частоти CorpSec гудуть новими наказами посилити патрулі."}}}}},logs:{"storylets.firelight_ambush.log.wounded":"Ліра підтримує тебе й клянеться, що наступний патруль не встигне підняти тривогу.","storylets.firelight_ambush.log.clean":"Осередок святкує чисту операцію й занотовує нові прогалини у патрулях.","storylets.neon_bivouac.log.bonded":"Довірена особа ділиться спогадами Gridfall, і вогник знову обіцяє тепло.","storylets.neon_bivouac.log.distance":"Розмови біля вогню уривчасті — нерви надто натягнуті для спогадів.","storylets.serrated_omen.log.rival":"Сераф-варден залишає тебе пораненим, але живим, і призначає фінальний двобій.","storylets.serrated_omen.log.default":"Вам вдається вислизнути, але частоти CorpSec гудуть новими наказами посилити патрулі."}},Tc={en:ma,uk:kc},ga=e=>Tc[e]??ma,zt=(e,t)=>e.replace(/\{([\w\d_]+)\}/g,(i,s)=>t[s]??`{${s}}`),Rc=(e,t)=>!t||!e.variants?e.base:e.variants[t]??e.base,zs={entries:{},lastSeenByLocation:{},queue:[]},fa=ee({name:"storylets",initialState:zs,reducers:{enqueueStorylet(e,t){const{resolution:i,queueItem:s,locationId:n}=t.payload,a=e.entries[i.storyletId]??{storyletId:i.storyletId,lastTriggeredAt:null,cooldownExpiresAt:null,timesTriggered:0};a.lastTriggeredAt=i.timestamp,a.cooldownExpiresAt=i.cooldownExpiresAt,a.timesTriggered+=1,e.entries[i.storyletId]=a,n&&(e.lastSeenByLocation[n]=i.storyletId),e.queue.push(s)},dequeueStorylet(e,t){const i=t.payload;if(!i){e.queue.shift();return}e.queue=e.queue.filter(s=>s.id!==i)},clearStorylets:()=>zs}}),{enqueueStorylet:Ec,dequeueStorylet:wg,clearStorylets:Pg}=fa.actions,_c=fa.reducer,Dc=(e,t,i)=>{var o;const s=Ic(t.missions.currentLevelIndex),n=e.locationId??((o=t.world.currentMapArea)==null?void 0:o.id),a=new Set(e.tags??[]);e.type==="patrolAmbush"&&a.add("ambush"),e.type==="campfireRest"&&(a.add("rest"),a.add("relationship"));const r=t.player.data;return r.maxHealth>0&&r.health<r.maxHealth*.7&&a.add("injury"),{type:e.type,arc:s,timestamp:i,locationId:n,missionId:e.missionId,tags:Array.from(a)}},Lc=e=>({entries:{...e.entries},lastSeenByLocation:{...e.lastSeenByLocation}}),Fc=(e,t)=>{const s=ga(t).plays[e.storyletId],n={},a={};Object.entries(e.resolvedRoles).forEach(([u,h])=>{n[u]=h.name,a[u]={id:h.id,name:h.name,relationship:h.relationship}});const r=s==null?void 0:s.outcomes[e.branch.id],o=r?Rc(r,e.outcome.variantKey):void 0,l=o?zt(o.narrative,n):"",c=o!=null&&o.epilogue?zt(o.epilogue,n):void 0,d=o!=null&&o.logLine?zt(o.logLine,n):void 0;return{id:oe(),storyletId:e.storyletId,branchId:e.branch.id,title:(s==null?void 0:s.title)??e.play.id,synopsis:(s==null?void 0:s.synopsis)??"",narrative:l,epilogue:c,logLine:d,resolvedRoles:a,triggeredAt:e.timestamp,locale:t,outcomeLocalizationKey:e.outcome.localizationKey,variantKey:e.outcome.variantKey}},Bc=(e,t,i,s)=>{const n=ga(t),a={};Object.entries(e.resolvedRoles).forEach(([r,o])=>{a[r]=o.name}),e.outcome.effects.forEach(r=>{switch(r.type){case"log":{const o=n.logs[r.logKey]??e.play.titleKey??r.logKey,l=zt(o,a);i(xe(l));break}case"faction":{if(!s)break;i(Ho({factionId:r.factionId,delta:r.delta,reason:r.reason??"storylet",source:e.storyletId}));break}case"playerHealth":{i(No(r.delta));break}case"traitDelta":{r.target==="player"&&i(Wo({trait:r.trait,delta:r.delta,source:e.storyletId}));break}}})},Mg=e=>(t,i)=>{var h;const s=i(),n=Date.now(),a=((h=s.settings)==null?void 0:h.locale)??Te,r=Dc(e,s,n),o=Lc(s.storylets),l=Cc(),c=vc({player:s.player.data,npcs:s.world.currentMapArea.entities.npcs}),d=xc({plays:l,runtime:o,trigger:r,actorPool:c,now:n,locationId:r.locationId});if(!d)return;Bc(d,a,t,!!s.settings.reputationSystemsEnabled);const u=Fc(d,a);t(Ec({resolution:d,queueItem:u,locationId:r.locationId}))},Fi=(e,t,i)=>!Number.isFinite(e)||e<t?t:e>i?i:e,Ag=e=>{if(!Number.isFinite(e))return 0;const t=e%360;return t<0?t+360:t},xg=(e,t)=>!Number.isFinite(e)||!Number.isFinite(t)?0:(t-e+540)%360-180,Ig=(e,t,i)=>!Number.isFinite(e)||!Number.isFinite(t)||!Number.isFinite(i)?e:e+(t-e)*i,Cg=e=>Number.isFinite(e)?e*(180/Math.PI):0,ya=(e,t,i)=>`${e}:${t}:${i}`,Pe=e=>Fi(e,0,1),Sa=e=>{const{baseCertainty:t,distanceModifier:i,lightingModifier:s,disguiseModifier:n,postureModifier:a}=e,r=t*Pe(i)*Pe(s)*Pe(n)*Pe(a);return Pe(r)},Oc=(e,t)=>{var s;const i=Sa(e);return{id:ya(e.witnessId,e.targetId,e.recognitionChannel),witnessId:e.witnessId,witnessLabel:e.witnessLabel??e.witnessId,targetId:e.targetId,zoneId:e.zoneId,areaId:e.areaId,source:e.source,recognitionChannel:e.recognitionChannel,certainty:i,halfLifeSeconds:t.halfLifeSeconds,firstSeenAt:e.timestamp,lastSeenAt:e.timestamp,reinforcedAt:void 0,reported:e.reported??!1,suppressed:((s=e.existing)==null?void 0:s.suppressed)??!1,proximityWeight:Pe(e.distanceModifier),location:e.location}},Nc=(e,t,i)=>{var r;const s=Sa(t),n=s*i.reinforcementBonus,a=Pe(Math.max(e.certainty,s)+n);return{...e,witnessLabel:t.witnessLabel??e.witnessLabel??e.witnessId,certainty:a,lastSeenAt:t.timestamp,reinforcedAt:t.timestamp,reported:e.reported||t.reported,suppressed:((r=t.existing)==null?void 0:r.suppressed)??e.suppressed,proximityWeight:Pe(Math.max(e.proximityWeight,t.distanceModifier)),location:t.location??e.location}},Hc=(e,t,i)=>{if(t<=0||e.certainty<=0)return{memory:{...e},pruned:e.certainty<i.certaintyFloor};const s=e.halfLifeSeconds>0?e.halfLifeSeconds:i.halfLifeSeconds,n=t/s,a=Math.pow(.5,n);let r=Pe(e.certainty*a);e.suppressed&&(r*=i.suppressionPenalty);const o=r<i.certaintyFloor;return{memory:{...e,certainty:r},pruned:o}},Us=e=>({id:e.id,witnessId:e.witnessId,witnessLabel:e.witnessLabel,targetId:e.targetId,zoneId:e.zoneId,areaId:e.areaId,source:e.source,recognitionChannel:e.recognitionChannel,certainty:e.certainty,halfLifeSeconds:e.halfLifeSeconds,firstSeenAt:e.firstSeenAt,lastSeenAt:e.lastSeenAt,reinforcedAt:e.reinforcedAt,reported:e.reported,suppressed:e.suppressed,proximityWeight:e.proximityWeight}),Bi=e=>({id:e.id,witnessId:e.witnessId,witnessLabel:e.witnessLabel,targetId:e.targetId,zoneId:e.zoneId,areaId:e.areaId,source:e.source,recognitionChannel:e.recognitionChannel,certainty:e.certainty,halfLifeSeconds:e.halfLifeSeconds,firstSeenAt:e.firstSeenAt,lastSeenAt:e.lastSeenAt,reinforcedAt:e.reinforcedAt,reported:e.reported,suppressed:e.suppressed,proximityWeight:e.proximityWeight}),Wc=(e,t)=>{const i=Math.pow(Fi(e.proximityWeight,0,1),t.proximityExponent),s=e.reported?t.reportMultiplier:1;return Fi(e.certainty*i*s,0,1.5)},Gc=(e,t)=>e>=t.tierThresholds.crackdown?"crackdown":e>=t.tierThresholds.tracking?"tracking":"calm",qc=(e,t,i)=>{if(t.length===0)return{zoneId:e,totalHeat:0,tier:"calm",leadingWitnessIds:[]};const s=t.filter(c=>c.suppressed?!1:c.certainty>=i.certaintyFloor);if(s.length===0)return{zoneId:e,totalHeat:0,tier:"calm",leadingWitnessIds:[]};const n=s.map(c=>({memory:c,weight:Wc(c,i)})).sort((c,d)=>d.weight-c.weight),a=i.topK>0?i.topK:5,r=n.slice(0,a),o=r.reduce((c,d)=>c+d.weight,0),l=Gc(o,i);return{zoneId:e,totalHeat:o,tier:l,leadingWitnessIds:r.map(c=>c.memory.id)}},Oi=3600,Xt={id:"default",label:"Baseline Urban Patrols",halfLifeSeconds:72*Oi,certaintyFloor:.05,reinforcementBonus:.4,reportMultiplier:1.25,suppressionPenalty:.4,topK:5,proximityExponent:.85,tierThresholds:{tracking:.4,crackdown:.75}},Vc={downtown:{...Xt,id:"downtown",label:"Downtown Grid Hyper-Patrol",halfLifeSeconds:60*Oi,reportMultiplier:1.35,topK:6},industrial:{...Xt,id:"industrial",label:"Industrial Wasteland Patrol",halfLifeSeconds:96*Oi,suppressionPenalty:.55}},Ni=e=>e?Vc[e]??Xt:Xt,Hi=1,zc=(e,t)=>({zoneId:e,memories:{},heat:{zoneId:e,totalHeat:0,tier:"calm",leadingWitnessIds:[]},lastUpdatedAt:t,lastObservationAt:null}),cs=()=>({version:Hi,zones:{},paused:!1,lastTickAt:null}),Uc=cs(),Ks=e=>{switch(e){case"calm":return 0;case"tracking":return 1;case"crackdown":return 2;default:return 0}},Dt=e=>{const t=Ni(e.zoneId),i=Object.values(e.memories).map(s=>Bi(s));return qc(e.zoneId,i,t)},va=ee({name:"suspicion",initialState:Uc,reducers:{ingestObservation:(e,t)=>{if(e.paused)return;const i=t.payload,s=i.zoneId,n=i.witnessLabel??i.witnessId,a=i.timestamp,r=e.zones[s]??(e.zones[s]=zc(s,a)),o=Ni(s),l=ya(i.witnessId,i.targetId,i.recognitionChannel),c=r.memories[l],d=c?Bi(c):void 0,u={...i,witnessLabel:n,existing:d},h=d?Nc(d,u,o):Oc(u,o);r.memories[l]=Us(h),r.heat=Dt(r),r.lastObservationAt=a,r.lastUpdatedAt=a,e.lastTickAt=a},applySuspicionDecay:(e,t)=>{if(e.paused)return;const{elapsedSeconds:i,timestamp:s}=t.payload;i<=0||(Object.values(e.zones).forEach(n=>{const a=Ni(n.zoneId),r={};let o=!1;Object.entries(n.memories).forEach(([l,c])=>{const d=Bi(c),{memory:u,pruned:h}=Hc(d,i,a);if(h){o=!0;return}o=o||u.certainty!==c.certainty,r[l]=Us(u)}),o&&(n.memories=r,n.heat=Dt(n),n.lastUpdatedAt=s)}),e.lastTickAt=s)},setSuspicionPaused:(e,t)=>{e.paused=t.payload},suppressWitnessMemory:(e,t)=>{const{zoneId:i,memoryId:s,suppressed:n}=t.payload,a=e.zones[i];if(!a)return;const r=a.memories[s];r&&r.suppressed!==n&&(a.memories[s]={...r,suppressed:n},a.heat=Dt(a))},purgeWitnessMemories:(e,t)=>{const{witnessId:i,zoneId:s}=t.payload;(s?[s]:Object.keys(e.zones)).forEach(a=>{const r=e.zones[a];if(!r)return;const o=Object.keys(r.memories).length;if(o===0)return;const l={};Object.entries(r.memories).forEach(([c,d])=>{d.witnessId!==i&&(l[c]=d)}),Object.keys(l).length!==o&&(r.memories=l,r.heat=Dt(r))})},resetSuspicionState:()=>cs()}}),{ingestObservation:kg,applySuspicionDecay:ba,setSuspicionPaused:Tg,suppressWitnessMemory:Rg,purgeWitnessMemories:Eg,resetSuspicionState:_g}=va.actions,Dg=e=>{let t="calm";return Object.values(e).forEach(i=>{Ks(i.heat.tier)>Ks(t)&&(t=i.heat.tier)}),t},Kc=va.reducer,jc={status:"idle",reason:null,lastDecision:null},wa=ee({name:"autoBattle",initialState:jc,reducers:{setAutoBattleStatus:(e,t)=>{e.status=t.payload.status,e.reason=t.payload.reason??null,e.status!=="running"&&(e.lastDecision=e.lastDecision?{...e.lastDecision,timestamp:Date.now()}:e.lastDecision)},recordAutoBattleDecision:(e,t)=>{e.lastDecision=t.payload,e.status="running",e.reason=null},clearAutoBattleDecision:e=>{e.lastDecision=null}}}),{setAutoBattleStatus:js,recordAutoBattleDecision:$c,clearAutoBattleDecision:Lg}=wa.actions,Yc=wa.reducer,Ut=e=>Math.max(En,Math.min(_n,e)),Si=e=>{const t=Ut(e),i=nr.find(s=>t>=s.min&&t<=s.max);return(i==null?void 0:i.tier)??"calm"},Wi=1,Pa=()=>({version:Wi,value:12,tier:"calm",lastUpdatedAt:null,frozen:!1,respiteUntil:null,decayBoostUntil:null,decayBoostPerSecond:0,cooldowns:{},lastSnapshot:null}),Zc=Pa(),Xc=()=>ee({name:"paranoia",initialState:Zc,reducers:{resetParanoiaState:()=>Pa(),tickParanoia:(e,t)=>{const{deltaMs:i,timestamp:s,decayMultiplier:n}=t.payload;if(e.frozen||i<=0){e.lastUpdatedAt=s;return}const a=Math.max(0,i)/1e3;if(a===0){e.lastUpdatedAt=s;return}const r=Math.max(0,n??1);let o=ar*r;e.decayBoostUntil&&s<e.decayBoostUntil?o+=Math.max(0,e.decayBoostPerSecond):e.decayBoostUntil&&s>=e.decayBoostUntil&&(e.decayBoostUntil=null,e.decayBoostPerSecond=0);const l=a*o;if(l>0){const c=Ut(e.value-l);e.value=c,e.tier=Si(c),e.lastSnapshot={timestamp:s,delta:-l,breakdown:{gains:{},losses:{passive:l},spikes:{}},value:c,tier:e.tier}}e.lastUpdatedAt=s},applyParanoiaStimuli:(e,t)=>{const{timestamp:i,delta:s,breakdown:n,deltaMs:a}=t.payload;if(!Number.isFinite(s)||s===0&&!n)return;let r=s;e.frozen&&r>0&&(r=0);const c=1.1*Math.max(.1,(a??1e3)/1e3);r>0&&e.respiteUntil&&i<e.respiteUntil&&(r=Math.min(r,sr.respite.maxGainPerTick)),r=Math.max(-c,Math.min(c,r));const d=Ut(e.value+r);e.value=d,e.tier=Si(d),e.lastUpdatedAt=i,n&&(e.lastSnapshot={timestamp:i,delta:r,breakdown:n,value:d,tier:e.tier})},applyParanoiaRelief:(e,t)=>{const{amount:i,timestamp:s,cooldownKey:n,cooldownMs:a}=t.payload,r=Math.max(0,i);if(r===0)return;if(n&&a){const l=e.cooldowns[n];if(typeof l=="number"&&l>s)return;e.cooldowns[n]=s+a}const o=Ut(e.value-r);e.value=o,e.tier=Si(o),e.lastUpdatedAt=s,e.lastSnapshot={timestamp:s,delta:-r,breakdown:{gains:{},losses:{relief:r},spikes:{}},value:o,tier:e.tier}},setParanoiaRespite:(e,t)=>{const{durationMs:i,timestamp:s}=t.payload,n=Math.max(0,i);e.respiteUntil=s+n},setParanoiaDecayBoost:(e,t)=>{const{amountPerSecond:i,durationMs:s,timestamp:n}=t.payload;if(i<=0||s<=0){e.decayBoostUntil=null,e.decayBoostPerSecond=0;return}e.decayBoostPerSecond=i,e.decayBoostUntil=n+s},setParanoiaFrozen:(e,t)=>{e.frozen=t.payload},clearParanoiaSnapshot:e=>{e.lastSnapshot=null}}}),Ma=Xc(),{resetParanoiaState:Qc,tickParanoia:Fg,applyParanoiaStimuli:Bg,applyParanoiaRelief:Og,setParanoiaRespite:Ng,setParanoiaDecayBoost:Hg,setParanoiaFrozen:Wg,clearParanoiaSnapshot:Gg}=Ma.actions,Aa=Ma.reducer,At=["heroic","cruel","sneaky","intimidating","competent"],Gi=1,Jc={heroic:60*45,cruel:60*50,sneaky:60*35,intimidating:60*40,competent:60*55},ed=.45,td=.25,$s=5,yt=100,Ys=60*90,id=.1,sd=5,Zs=6,Ke={minor:.4,moderate:.65,major:.85,legendary:1},nd=.1,ad=At.reduce((e,t)=>(e[t]=0,e),{}),Xs=12,L=(e,t,i)=>Number.isFinite(e)?Math.max(t,Math.min(i,e)):t,Qs=(e,t,i)=>e+(t-e)*i,xa=(e,t)=>{const i=e.x-t.x,s=e.y-t.y;return Math.sqrt(i*i+s*s)},ds=e=>{const t=Math.floor(e.x/Xs),i=Math.floor(e.y/Xs);return`${t}:${i}`},rd=(e,t,i,s)=>{const n=t.x-e.x,a=t.y-e.y,r=Math.sqrt(n*n+a*a),o=Math.max(1,Math.floor(r/i));for(let l=1;l<=o;l+=1){const c=l/(o+1);s({x:Qs(e.x,t.x,c),y:Qs(e.y,t.y,c)})}},od=(e,t,i)=>{let s=0,n=0;const a=o=>{if(!o){s+=1;return}!o.isWalkable||o.type===D.WALL?s+=1:o.type===D.DOOR&&(s+=.5)};if(rd(t,i,1.25,o=>{var d;const l=Math.round(o.x),c=Math.round(o.y);a((d=e.tiles[c])==null?void 0:d[l]),n+=1}),n===0)return 1;const r=s/n;return L(1-r,.1,1)},Lt={base:.7,noiseLevel:.6,lightingFactor:.85,disguiseFactor:.8},ld=e=>({base:L((e==null?void 0:e.base)??Lt.base,0,1),noiseLevel:L((e==null?void 0:e.noiseLevel)??Lt.noiseLevel,0,1),lightingFactor:L((e==null?void 0:e.lightingFactor)??Lt.lightingFactor,0,1),disguiseFactor:L((e==null?void 0:e.disguiseFactor)??Lt.disguiseFactor,0,1),crowdDensity:L((e==null?void 0:e.crowdDensity)??.5,0,1)}),cd=e=>At.reduce((t,i)=>{const s=e[i];return typeof s=="number"&&Number.isFinite(s)&&s!==0&&(t[i]=L(s,-30,30)),t},{}),dd=e=>{const t=oe(),i=typeof e.timestamp=="number"?e.timestamp:Date.now(),s=e.cellId??ds(e.position),n=ld(e.visibility),a=Ke[e.intensity]??Ke.minor,r=cd(Object.keys(e.traits??{}).reduce((o,l)=>{var c;if(At.includes(l)){const d=l;o[d]=L(((c=e.traits)==null?void 0:c[d])??0,-40,40)*a}return o},{}));return{id:t,actorId:e.actorId,actorLabel:e.actorLabel??"Player",zoneId:e.zoneId,cellId:s,position:{...e.position},intensity:e.intensity,traits:r,tags:[...e.tags],timestamp:i,visibility:n,metadata:e.metadata?{...e.metadata}:void 0}},ud=24,Js={resistance:{heroic:1,cruel:-.6,sneaky:.25,intimidating:-.1,competent:.5},corpsec:{heroic:-.2,cruel:.4,sneaky:-.4,intimidating:.8,competent:.6},scavengers:{heroic:.2,cruel:.1,sneaky:.8,intimidating:.3,competent:.4},civilians:{heroic:.8,cruel:-.8,sneaky:-.1,intimidating:-.2,competent:.4}},hd=(e,t)=>{var a,r,o;const i=e.reputationBias??Js[t??""]??Js.civilians,s=(a=e.socialTags)!=null&&a.includes("gossip_hub")?.35:.55,n=(r=e.socialTags)!=null&&r.includes("gossip_hub")?.75:(o=e.socialTags)!=null&&o.includes("guard")?.25:.5;return{traitWeights:{...i},skepticism:L(s,.15,.85),appetiteForRumors:L(n,.15,.9)}},pd=(e,t)=>{var i,s,n;return e.factionId?e.factionId:(i=e.socialTags)!=null&&i.includes("corpsec")?"corpsec":(s=e.socialTags)!=null&&s.includes("scavenger")?"scavengers":(n=e.socialTags)!=null&&n.includes("resistance")?"resistance":t},md=(e,t)=>L(e*t,.2,1.1),gd=(e,t)=>L(e-(typeof t=="number"?t:0),.25,1),fd=({visibilityScore:e,distanceFactor:t,lineOfSight:i,npc:s})=>{var r,o;const n=(r=s.socialTags)!=null&&r.includes("sentinel")?.15:(o=s.socialTags)!=null&&o.includes("guard")?.1:0,a=e*.65+t*.2+i*.15+n;return L(a,0,1)},yd=({event:e,mapArea:t,npcs:i,ambientLighting:s,ambientNoise:n,disguisePenalty:a,maxDistance:r=ud,visibilityThreshold:o=ed})=>{const l=i??t.entities.npcs;return l.length?l.map(c=>{var A;const d=xa(c.position,e.position);if(d>r)return null;const u=L(1-d/(r+1),0,1),h=od(t,c.position,e.position),g=md(s,e.visibility.lightingFactor),m=L(n*.35+e.visibility.noiseLevel*.65,.1,1),p=gd(e.visibility.disguiseFactor,a),v=L(e.visibility.base*u*h*g*(.5+m*.5)*(1-(1-p)*.6),0,1);if(v<td)return null;const S=pd(c,((A=t.factionRequirement)==null?void 0:A.factionId)??null),M=hd(c,S),x=fd({visibilityScore:v,distanceFactor:u,lineOfSight:h,npc:c}),b=v<o;return{witnessId:c.id,name:c.name,factionId:S,zoneId:e.zoneId,cellId:ds(c.position),position:{...c.position},distance:d,lineOfSight:h,distanceFactor:u,lightingFactor:g,noiseFactor:m,disguiseFactor:p,visibilityScore:v,baseConfidence:x,isRumorOnly:b,bias:M}}).filter(c=>!!c).sort((c,d)=>d.visibilityScore-c.visibilityScore):[]},Sd=(e,t,i)=>{var n;const s=(n=t.traitWeights)==null?void 0:n[e];return typeof s=="number"&&s!==0?i*s:i},vd=(e,t,i,s)=>{const n=i?.45+(1-s.appetiteForRumors)*.3:0,r=e*L(t/30,.25,1)*(1-s.skepticism)*(1-n);return L(r,0,1)},bd=(e,t,i,s)=>{if(t===0)return null;const n=vd(i,Math.abs(t),s.isRumorOnly,s.bias);return n<nd?null:{trait:e,delta:t,confidence:n,source:s.isRumorOnly?"rumor":"witness"}},wd=({event:e,candidates:t,timestamp:i})=>{if(!t.length)return[];const s=e.traits??{},n=Ke[e.intensity]??Ke.minor,a=typeof i=="number"?i:e.timestamp;return t.map(r=>{const o=L(r.baseConfidence*(r.isRumorOnly?.65:1),0,1),l=Object.entries(s).map(([d,u])=>{const h=d,g=Sd(h,r.bias,u??0)*n*(r.isRumorOnly?.6:1);return bd(h,g,o,r)}).filter(d=>d?d.delta!==0:!1);if(!l.length)return null;const c=L(l.reduce((d,u)=>d+u.confidence,0)/l.length,0,1);return{id:oe(),eventId:e.id,witnessId:r.witnessId,witnessName:r.name,factionId:r.factionId,zoneId:r.zoneId,cellId:r.cellId,timestamp:a,visibilityScore:r.visibilityScore,confidence:c,isRumorOnly:r.isRumorOnly,traits:l}}).filter(r=>!!r)},Ia=22,Pd=5,Md=(e,t,i)=>({id:`${e}::${t}`,fromId:e,toId:t,weight:L(i,.05,1),latencySeconds:L(60*(1.2-i),20,120),remainingEnergy:Zs*i,maxEnergy:Zs,lastSharedAt:null}),Ad=(e,t,i)=>{var a;let s=L(1-i/(Ia+1),0,1);const n=(a=e.socialTags)==null?void 0:a.filter(r=>{var o;return(o=t.socialTags)==null?void 0:o.includes(r)});return n!=null&&n.length&&(s+=n.length*.08),e.factionId&&t.factionId&&e.factionId===t.factionId&&(s+=.15),L(s,0,1)},xd=({mapArea:e,npcs:t})=>{const i=t??e.entities.npcs;if(i.length<2)return[];const s=[];return i.forEach(n=>{i.filter(r=>r.id!==n.id).map(r=>{const o=xa(n.position,r.position);if(o>Ia)return null;const l=Ad(n,r,o);return l<=0?null:{other:r,weight:l}}).filter(r=>!!r).sort((r,o)=>o.weight-r.weight).slice(0,Pd).forEach(({other:r,weight:o})=>{s.push(Md(n.id,r.id,o))})}),s},Id=(e,t)=>{const i=L(Math.abs(e)/yt,0,1);return L(i*t,0,1)},Cd=(e,t,i)=>`${e}:${t}:${i}`,kd=(e,t)=>{if(!t.length)return[];const i={},s=Ke[e.intensity]??Ke.minor;return t.forEach(n=>{n.traits.forEach(a=>{const r=Id(a.delta,a.confidence)*s;if(r<=id)return;const o=n.witnessId,l=a.delta>=0?1:-1;i[o]||(i[o]={carrierId:o,cellId:n.cellId,zoneId:n.zoneId,rumors:[]});const c=Cd(o,a.trait,e.id);i[o].rumors.push({id:c,eventId:e.id,originWitnessId:n.witnessId,carrierId:o,trait:a.trait,polarity:l,strength:L(r,0,1),confidence:L(a.confidence,0,1),ttlSeconds:Ys,decayRate:1/Ys,lastUpdatedAt:n.timestamp,originCellId:n.cellId,originZoneId:n.zoneId,intensity:e.intensity})})}),Object.values(i).map(n=>({...n,rumors:n.rumors.slice(0,sd)}))},Td=()=>{const e=Date.now();return At.reduce((t,i)=>(t[i]={value:ad[i]??0,confidence:0,lastUpdatedAt:e,decaySeconds:Jc[i]??60*45,sources:[]},t),{})},Rd=(e,t,i,s,n,a)=>({id:e,scope:t,label:i,factionId:n,cellId:a,traits:Td(),updatedAt:s}),Ed={version:Gi,events:{},witnessRecords:{},recordsByEvent:{},profiles:{},carriers:{},edges:{},debug:{heatmapEnabled:!1},lastTickAt:null},_d=(e,t,i,s,n,a,r)=>{let o=e.profiles[t];return o||(o=Rd(t,s,i,n,a,r),e.profiles[t]=o),o},Dd=(e,t,i)=>{const s=e.traits[t.trait];s&&(s.value=L(s.value+t.delta,-yt,yt),s.confidence=L(s.confidence+t.confidence*(1-s.confidence*.5),0,1),s.lastUpdatedAt=i,t.sourceRecordId&&(s.sources.unshift(t.sourceRecordId),s.sources.length>$s&&(s.sources.length=$s)),e.updatedAt=i)},en=(e,t,i)=>{t.forEach(s=>{const n=s.scopeId,a=s.scope==="witness"?`Witness::${s.scopeId}`:s.scope==="cell"?`Cell ${s.scopeId}`:`Faction ${s.scopeId}`,r=_d(e,n,a,s.scope,i,s.scope==="faction"?s.factionId:null,s.scope==="cell"?s.cellId:null);Dd(r,s,i)})},tn=(e,t)=>{t.forEach(i=>{e.carriers[i.carrierId]={carrierId:i.carrierId,cellId:i.cellId,zoneId:i.zoneId,rumors:i.rumors.map(s=>({...s}))}})},sn=(e,t)=>{t.forEach(i=>{const s=e.edges[i.id];e.edges[i.id]=s?{...s,remainingEnergy:i.remainingEnergy,lastSharedAt:i.lastSharedAt??s.lastSharedAt}:{...i}})},Ld=(e,t,i)=>{At.forEach(s=>{const n=e.traits[s];if(!n)return;const a=L(t/n.decaySeconds,0,1);if(a<=0)return;const r=n.value*a*.5;n.value=L(n.value-r,-yt,yt),n.confidence=L(n.confidence*(1-a*.6),0,1),n.lastUpdatedAt=i,Math.abs(n.value)<.01&&(n.value=0),n.confidence<.02&&(n.confidence=0,n.sources=[])}),e.updatedAt=i},nn=e=>{Object.entries(e.carriers).forEach(([t,i])=>{i.rumors.length||delete e.carriers[t]})},Ca=ee({name:"reputation",initialState:Ed,reducers:{applyEventIntegration:(e,t)=>{const{event:i,records:s,profileMutations:n,carriers:a,edges:r}=t.payload;e.events[i.id]=i,e.recordsByEvent[i.id]=s.map(o=>o.id),s.forEach(o=>{e.witnessRecords[o.id]=o}),en(e,n,i.timestamp),tn(e,a),sn(e,r),nn(e),e.lastTickAt=i.timestamp},applyDecay:(e,t)=>{const{timestamp:i,elapsedSeconds:s}=t.payload;Object.values(e.profiles).forEach(n=>Ld(n,s,i)),Object.values(e.edges).forEach(n=>{n.remainingEnergy=L(Math.min(n.remainingEnergy+s*.05,n.maxEnergy),0,n.maxEnergy)}),e.lastTickAt=i},applyPropagationResult:(e,t)=>{const{carriers:i,edges:s,profileMutations:n}=t.payload;tn(e,i),sn(e,s),nn(e);const a=Date.now();en(e,n,a),e.lastTickAt=a},toggleReputationHeatmap:(e,t)=>{e.debug.heatmapEnabled=t.payload},setInspectorTarget:(e,t)=>{e.debug.inspectorTargetId=t.payload}}}),{applyEventIntegration:Fd,applyDecay:qg,applyPropagationResult:Vg,toggleReputationHeatmap:zg,setInspectorTarget:Ug}=Ca.actions,qi=Ca.reducer,Bd=(e,t)=>{const i=t==="night"?.55:t==="evening"||t==="morning"?.75:1;return e.flags.blackoutTier==="rolling"?i*.4:e.flags.blackoutTier==="brownout"?i*.65:i},Od=e=>{switch(e.flags.gangHeat){case"high":return .85;case"med":return .7;default:return .55}},Nd=e=>{var a;const t=((a=e.skillTraining)==null?void 0:a.stealth)??0,i=e.skills.agility??5,s=Math.min(t/160,.25),n=Math.max(0,(i-6)*.03);return L(.4-(s+n),0,.4)},Hd=e=>{const t=[];return e.forEach(i=>{i.traits.forEach(s=>{const n=s.confidence;t.push({scopeId:i.witnessId,scope:"witness",factionId:i.factionId,cellId:i.cellId,trait:s.trait,delta:s.delta,confidence:s.confidence,sourceRecordId:i.id,witnessId:i.witnessId}),i.factionId&&t.push({scopeId:i.factionId,scope:"faction",factionId:i.factionId,cellId:null,trait:s.trait,delta:s.delta*(.55+n*.2),confidence:s.confidence*.7,sourceRecordId:i.id,witnessId:i.witnessId}),t.push({scopeId:i.cellId,scope:"cell",factionId:i.factionId,cellId:i.cellId,trait:s.trait,delta:s.delta*(.7+n*.15),confidence:s.confidence*.8,sourceRecordId:i.id,witnessId:i.witnessId})})}),t},Kg=e=>(t,i)=>{const s=i();if(!s.settings.reputationSystemsEnabled)return;const n=s.world,a=s.player.data,r=e.mapArea??n.currentMapArea,o=e.ambientLighting??Bd(n.environment,n.timeOfDay),l=e.ambientNoise??Od(n.environment),c=e.disguisePenalty??Nd(a),d=dd({...e,zoneId:e.zoneId??r.zoneId??n.currentMapArea.zoneId,cellId:e.cellId??ds(e.position)}),u=yd({event:d,mapArea:r,npcs:e.npcsOverride,ambientLighting:o,ambientNoise:l,disguisePenalty:c});if(!u.length)return;const h=wd({event:d,candidates:u,timestamp:d.timestamp}),g=Hd(h),m=kd(d,h),p=xd({mapArea:r});t(Fd({event:d,records:h,profileMutations:g,carriers:m,edges:p}))},Wd={override:null},ka=ee({name:"hudLayout",initialState:Wd,reducers:{setHudLayoutOverride:(e,t)=>{e.override=t.payload},clearHudLayoutOverride:e=>{e.override=null}}}),{setHudLayoutOverride:jg,clearHudLayoutOverride:$g}=ka.actions,Gd=ka.reducer;var qd={};const us="the-getaway-state",Ta=typeof window<"u",an=typeof process<"u"&&typeof qd.JEST_WORKER_ID<"u",Vd={player:qo,world:na,quests:_l,log:cc,settings:ca,autoBattle:Yc,combatFeedback:mc,missions:oc,surveillance:ha,storylets:_c,suspicion:Kc,paranoia:Aa,reputation:qi,hudLayout:Gd},Qe=rr(Vd),zd=or("app/resetGame"),Yg=us,Ft=(e,t)=>Array.isArray(e)?[...e]:[...t],Ud=e=>{if(!e)return{...z,version:mt,data:{...z.data,perks:[...z.data.perks],perkRuntime:{...z.data.perkRuntime},factionReputation:{...z.data.factionReputation}},pendingLevelUpEvents:[...z.pendingLevelUpEvents],xpNotifications:[...z.xpNotifications],pendingFactionEvents:[...z.pendingFactionEvents]};const t=e.data??null,i={...z.data,...t??{},perks:Ft(t==null?void 0:t.perks,z.data.perks),perkRuntime:{...z.data.perkRuntime,...(t==null?void 0:t.perkRuntime)??{}},factionReputation:{...z.data.factionReputation,...(t==null?void 0:t.factionReputation)??{}}};return{version:mt,data:i,pendingLevelUpEvents:Ft(e.pendingLevelUpEvents,z.pendingLevelUpEvents),xpNotifications:Ft(e.xpNotifications,z.xpNotifications),pendingFactionEvents:Ft(e.pendingFactionEvents,z.pendingFactionEvents)}},Kd=e=>{if(!e||e.version!==Wi)return Aa(void 0,Qc());const t=typeof e.value=="number"?e.value:0,i=Number.isFinite(t)?t:0,s=Math.max(En,Math.min(_n,i)),n=Number.isFinite(e.decayBoostPerSecond)?Math.max(0,e.decayBoostPerSecond):0;return{version:Wi,value:s,tier:e.tier??"calm",lastUpdatedAt:typeof e.lastUpdatedAt=="number"?e.lastUpdatedAt:null,frozen:!!e.frozen,respiteUntil:typeof e.respiteUntil=="number"?e.respiteUntil:null,decayBoostUntil:typeof e.decayBoostUntil=="number"?e.decayBoostUntil:null,decayBoostPerSecond:n,cooldowns:{...e.cooldowns??{}},lastSnapshot:e.lastSnapshot??null}},jd=e=>({zoneId:e.zoneId,memories:{...e.memories},heat:{zoneId:e.heat.zoneId,totalHeat:e.heat.totalHeat,tier:e.heat.tier,leadingWitnessIds:[...e.heat.leadingWitnessIds]},lastUpdatedAt:e.lastUpdatedAt,lastObservationAt:e.lastObservationAt}),$d=e=>{if(!e||e.version!==Hi)return cs();const t={};return e.zones&&Object.entries(e.zones).forEach(([i,s])=>{s&&(t[i]=jd(s))}),{version:Hi,zones:t,paused:!!e.paused,lastTickAt:typeof e.lastTickAt=="number"?e.lastTickAt:null}},Yd=e=>{if(!e||e.version!==Gi)return qi(void 0,{type:"@@INIT"});const t=qi(void 0,{type:"@@INIT"});return{...t,...e,events:{...e.events??{}},witnessRecords:{...e.witnessRecords??{}},recordsByEvent:{...e.recordsByEvent??{}},profiles:{...e.profiles??{}},carriers:{...e.carriers??{}},edges:{...e.edges??{}},debug:{...t.debug,...e.debug??{}},lastTickAt:typeof e.lastTickAt=="number"?e.lastTickAt:null,version:Gi}},Zd=e=>{const t=na(void 0,{type:"@@INIT"});if(!e)return t;const i={...e,environment:{...e.environment,flags:{...e.environment.flags},weather:{...e.environment.weather},signage:{...e.environment.signage},rumorSets:{...e.environment.rumorSets??{}},notes:Array.isArray(e.environment.notes)?[...e.environment.notes]:[...t.environment.notes]}},s=ea||xl;return i.currentTime=s,i.timeOfDay=gt(s,G),i.curfewActive=ft(s,G),i},Xd=e=>{const t=ha(void 0,{type:"@@INIT"});return e?{zones:e.zones?{...e.zones}:{},hud:{...t.hud,...e.hud??{},overlayEnabled:!0},curfewBanner:e.curfewBanner?{...e.curfewBanner}:{...t.curfewBanner}}:t},Qd=e=>{const t=ca(void 0,{type:"@@INIT"});return e?{...t,...e,visualQualityPreset:e.visualQualityPreset??t.visualQualityPreset}:t},Jd=()=>{if(Ta)try{const e=window.localStorage.getItem(us);return e?JSON.parse(e):void 0}catch(e){console.warn("[store] Failed to load state from localStorage:",e);return}},eu=e=>{if(Ta)try{const t=JSON.stringify(e);window.localStorage.setItem(us,t)}catch(t){console.warn("[store] Failed to save state to localStorage:",t)}},tu=e=>{if(e)return{...e,player:Ud(e.player),suspicion:$d(e.suspicion),paranoia:Kd(e.paranoia),world:Zd(e.world),surveillance:Xd(e.surveillance),reputation:Yd(e.reputation),settings:Qd(e.settings)}},iu=(e,t)=>{if(zd.match(t)){const i=e==null?void 0:e.settings;let s=Qe(void 0,t);return i&&(s=Qe(s,El(i.locale)),s=Qe(s,Tl(i.locale)),s=Qe(s,rc(i.locale)),s={...s,settings:i}),s}return Qe(e,t)},su=Jd(),nu=tu(su),F=lr({reducer:iu,preloadedState:nu,middleware:e=>e({serializableCheck:an?!1:{ignoredActions:["app/resetGame"],warnAfter:128},immutableCheck:an?!1:{warnAfter:128}})});F.subscribe(()=>{const e=F.getState(),t={player:e.player,world:e.world,quests:e.quests,log:e.log,settings:e.settings,autoBattle:e.autoBattle,combatFeedback:e.combatFeedback,missions:e.missions,surveillance:e.surveillance,storylets:e.storylets,suspicion:e.suspicion,paranoia:e.paranoia,reputation:e.reputation,hudLayout:e.hudLayout};eu(t)});const vi=1023,H=Object.freeze({TILE_BASE:0,TILE_OVERLAY:48,PROP_LOW:96,PROP_TALL:128,CHARACTER_BASE:160,CHARACTER:192,EFFECT:224,FLOATING_UI:256,PATH_PREVIEW:288,OVERLAY:960,DEBUG:992}),Ge=Object.freeze({BACKDROP:-20,MAP_BASE:-5,VISION_OVERLAY:2,PATH_PREVIEW:4,COVER_DEBUG:5,DAY_NIGHT_OVERLAY:100}),hs=(e,t,i=0)=>{const s=(Math.floor(e)&vi)>>>0,n=Math.floor(t),a=P.Math.Clamp(Math.floor(i),-vi,vi);return(n<<10)+s+a};class au{constructor(t){y(this,"registrations",new Map);y(this,"destroyed",!1);this.scene=t,this.handlePreUpdate=this.handlePreUpdate.bind(this),this.destroy=this.destroy.bind(this),this.scene.events.on(P.Scenes.Events.PRE_UPDATE,this.handlePreUpdate),this.scene.events.once(P.Scenes.Events.SHUTDOWN,this.destroy)}registerStatic(t,i){if(this.registrations.has(t))return;const s={target:t,staticDepth:i};this.attachRegistration(t,s),this.applyRegistration(s)}getRegistration(t){return this.registrations.get(t)}refresh(t){const i=this.registrations.get(t);i&&this.applyRegistration(i)}unregister(t){this.registrations.delete(t)}destroy(){this.destroyed||(this.destroyed=!0,this.scene.events.off(P.Scenes.Events.PRE_UPDATE,this.handlePreUpdate),this.scene.events.off(P.Scenes.Events.SHUTDOWN,this.destroy),this.registrations.clear())}upsertDynamic(t,i,s){const n=this.registrations.get(t);if(n){n.dynamicPoint=i,n.dynamicBias=s,n.staticDepth=void 0,this.applyRegistration(n);return}const a={target:t,dynamicPoint:i,dynamicBias:s};this.attachRegistration(t,a),this.applyRegistration(a)}attachRegistration(t,i){this.registrations.set(t,i),t.once(P.GameObjects.Events.DESTROY,()=>this.unregister(t))}handlePreUpdate(){this.destroyed||this.registrations.forEach(t=>{t.dynamicPoint&&this.applyRegistration(t)})}applyRegistration(t){const{target:i,staticDepth:s,dynamicPoint:n}=t;let a=s;n&&(a=hs(n.x,n.y,t.dynamicBias??0)),!(a===void 0||a===t.lastApplied)&&(i.setDepth(a),t.lastApplied=a)}}const Ra=(e,t,i,s,n)=>{if(e){const a={x:i,y:s};e.upsertDynamic(t,a,n)}else t.setDepth(hs(i,s,n))},Oe=(e,t,i)=>Math.max(t,Math.min(i,e)),ru=e=>({r:e>>16&255,g:e>>8&255,b:e&255}),rn=(e,t,i)=>(e&255)<<16|(t&255)<<8|i&255,ge=(e=si)=>{const t=e,i=e/2;return{tileWidth:t,tileHeight:i,halfTileWidth:t/2,halfTileHeight:i/2}},me=(e,t,i,s,n=si)=>{const a=ge(n),r=(e-t)*a.halfTileWidth+i,o=(e+t)*a.halfTileHeight+s;return{x:r,y:o}},ne=(e,t,i,s)=>{const n=i/2,a=s/2;return[{x:e,y:t-a},{x:e+n,y:t},{x:e,y:t+a},{x:e-n,y:t}]},T=(e,t)=>{const{r:i,g:s,b:n}=ru(e);if(t>=0){const c=Oe(Math.round(i+(255-i)*t),0,255),d=Oe(Math.round(s+(255-s)*t),0,255),u=Oe(Math.round(n+(255-n)*t),0,255);return rn(c,d,u)}const a=Math.max(0,1+t),r=Oe(Math.round(i*a),0,255),o=Oe(Math.round(s*a),0,255),l=Oe(Math.round(n*a),0,255);return rn(r,o,l)};class ou{constructor(t,i=si,s){y(this,"originX",0);y(this,"originY",0);this.scene=t,this.tileSize=i,this.depthManager=s}assignDepth(t,i,s,n){Ra(this.depthManager,t,i,s,n)}setIsoOrigin(t,i){return this.originX=t,this.originY=i,this}createCrate(t,i,s={}){const n=ge(this.tileSize),{x:a,y:r}=me(t,i,this.originX,this.originY,this.tileSize),o=s.scale??.55,l=s.height??.65,c=s.alpha??1,d=s.tint??9262372,u=T(d,.2),h=T(d,-.12),g=T(d,-.35),m=this.scene.add.graphics();m.setAlpha(c);const p=n.tileHeight*l,v=n.tileWidth*o,S=n.tileHeight*o,M=ne(a,r-p,v,S),x=ne(a,r,v,S),b=[x[3],x[0],M[0],M[3]],A=[x[0],x[1],M[1],M[0]];return m.fillStyle(h,1),m.fillPoints(b,!0),m.fillStyle(T(h,-.05),1),m.fillPoints(A,!0),m.fillStyle(u,1),m.fillPoints(M,!0),m.lineStyle(1.2,g,.8),m.strokePoints(x,!0),m.strokePoints(M,!0),this.assignDepth(m,a,r,H.PROP_LOW),m}createHighlightDiamond(t,i,s={}){const{x:n,y:a}=me(t,i,this.originX,this.originY,this.tileSize),r=ge(this.tileSize),o=r.tileWidth*(s.widthScale??1),l=r.tileHeight*(s.heightScale??1),c=s.color??6333946,d=s.alpha??.3,u=ne(n,a,o,l),h=this.scene.add.graphics();return h.fillStyle(c,d),h.fillPoints(u,!0),h.lineStyle(1.5,T(c,.2),d+.2),h.strokePoints(u,!0),this.assignDepth(h,n,a,H.TILE_OVERLAY),h}createCharacterBase(t,i,s={}){const n=this.scene.add.graphics();return this.updateCharacterBase(n,t,i,s),n}createBarricade(t,i,s={}){const n=ge(this.tileSize),{x:a,y:r}=me(t,i,this.originX,this.originY,this.tileSize),o=s.tint??4937059,l=n.tileWidth*(s.widthScale??.9),c=n.tileHeight*.32*(s.height??1),d=n.tileHeight*.34,u=ne(a,r-c,l,d).map(M=>new P.Geom.Point(M.x,M.y)),h=ne(a,r,l,d).map(M=>new P.Geom.Point(M.x,M.y)),g=[h[3],h[0],u[0],u[3]],m=[h[0],h[1],u[1],u[0]],p=[h[1],h[2],u[2],u[1]],v=this.scene.add.graphics();v.fillStyle(o,.96),v.fillPoints(p,!0),v.fillStyle(o,.92),v.fillPoints(g,!0),v.fillStyle(o,.88),v.fillPoints(m,!0),v.lineStyle(1.5,T(o,.18),.9),v.strokePoints(h,!0),v.strokePoints(u,!0);const S=H.PROP_TALL+(s.depthOffset??0);return this.assignDepth(v,a,r,S),v}createStreetLight(t,i,s={}){const n=ge(this.tileSize),{x:a,y:r}=me(t,i,this.originX,this.originY,this.tileSize),o=s.baseColor??988970,l=s.poleColor??1976635,c=s.glowColor??3718648,d=s.height??1.2,u=s.widthScale??.42,h=this.scene.add.container(a,r),g=this.scene.add.graphics(),m=ne(0,0,n.tileWidth*u,n.tileHeight*.32).map(w=>new P.Geom.Point(w.x,w.y));g.fillStyle(o,.95),g.fillPoints(m,!0),g.lineStyle(1.2,T(o,.18),.9),g.strokePoints(m,!0);const p=this.scene.add.graphics(),v=n.tileHeight*(1.8*d),S=Math.max(2,n.tileWidth*.05);p.fillStyle(l,1),p.fillRect(-S/2,-v,S,v),p.setAlpha(.95);const M=this.scene.add.graphics(),x=n.tileWidth*.55,b=n.tileHeight*.3,A=ne(0,-v,x,b).map(w=>new P.Geom.Point(w.x,w.y));M.fillStyle(T(c,-.4),.96),M.fillPoints(A,!0),M.lineStyle(1.2,T(c,.2),.9),M.strokePoints(A,!0);const I=this.scene.add.graphics();return I.fillStyle(c,s.glowAlpha??.22),I.fillEllipse(0,n.tileHeight*.05,n.tileWidth*.9,n.tileHeight*.36),I.setBlendMode(P.BlendModes.ADD),h.add([I,g,p,M]),this.assignDepth(h,a,r,H.PROP_TALL+16),h}createBillboard(t,i,s={}){const n=ge(this.tileSize),{x:a,y:r}=me(t,i,this.originX,this.originY,this.tileSize),o=s.baseColor??1120295,l=s.glowColor??3718648,c=s.panelColor??T(l,-.2),d=s.accentColor??T(l,.25),u=s.widthScale??.9,h=s.heightScale??1.1,g=this.scene.add.container(a,r),m=this.scene.add.graphics(),p=ne(0,0,n.tileWidth*.45,n.tileHeight*.28).map(C=>new P.Geom.Point(C.x,C.y));m.fillStyle(o,.94),m.fillPoints(p,!0),m.lineStyle(1.3,T(o,.15),.9),m.strokePoints(p,!0);const v=this.scene.add.graphics(),S=n.tileHeight*1.35*h,M=Math.max(2,n.tileWidth*.04);v.fillStyle(T(o,.1),1),v.fillRect(-M/2,-S,M,S);const x=this.scene.add.graphics(),b=n.tileWidth*u,A=n.tileHeight*.6*h,I=[new P.Geom.Point(-b/2,-S),new P.Geom.Point(b/2,-S-A*.18),new P.Geom.Point(b/2,-S-A),new P.Geom.Point(-b/2,-S-A*.82)];x.fillStyle(c,.93),x.fillPoints(I,!0),x.lineStyle(1.6,d,.95),x.strokePoints(I,!0);const w=this.scene.add.graphics();return w.fillStyle(l,s.glowAlpha??.25),w.fillEllipse(0,-S-A*.6,b*1.1,A*1.4),w.setBlendMode(P.BlendModes.ADD),g.add([w,m,v,x]),this.assignDepth(g,a,r,H.PROP_TALL+12),g}createPulsingHighlight(t,i,s={}){var I,w;const n=ge(this.tileSize),{x:a,y:r}=me(t,i,this.originX,this.originY,this.tileSize),o=n.tileWidth*(s.widthScale??.8),l=n.tileHeight*(s.heightScale??.8),c=s.color??3718648,d=s.alpha??.2,u=s.pulseColor??T(c,.1),h=s.pulseScale??1.18,g=((I=s.pulseAlpha)==null?void 0:I.from)??d,m=((w=s.pulseAlpha)==null?void 0:w.to)??.05,p=s.duration??1350,v=s.depthOffset??5,S=this.scene.add.container(a,r),M=(C,R,k)=>{const f=ne(0,0,o,l).map(E=>new P.Geom.Point(E.x,E.y));C.clear(),C.fillStyle(R,k),C.fillPoints(f,!0),C.lineStyle(1.3,T(R,.2),Math.min(1,k+.1)),C.strokePoints(f,!0)},x=this.scene.add.graphics();M(x,c,d);const b=this.scene.add.graphics();M(b,u,g),S.add([b,x]),this.assignDepth(S,a,r,H.EFFECT+v);const A=this.scene.tweens.add({targets:b,alpha:{from:g,to:m},scaleX:{from:1,to:h},scaleY:{from:1,to:h},duration:p,ease:"Sine.easeInOut",yoyo:!0,repeat:-1});return S.setData("pulseTween",A),S.once(P.GameObjects.Events.DESTROY,()=>{A&&A.isPlaying()&&A.stop()}),S}createSpriteTile(t,i,s,n={}){var a,r;return this.createIsoSprite(t,i,s,{textureKey:n.textureKey,depthBias:n.depthBias??H.TILE_BASE,origin:{x:((a=n.origin)==null?void 0:a.x)??.5,y:((r=n.origin)==null?void 0:r.y)??.5},normalTextureKey:n.normalTextureKey})}createSpriteProp(t,i,s,n={}){var a,r;return this.createIsoSprite(t,i,s,{textureKey:n.textureKey,depthBias:n.depthBias??H.PROP_TALL,origin:{x:((a=n.origin)==null?void 0:a.x)??.5,y:((r=n.origin)==null?void 0:r.y)??.85},normalTextureKey:n.normalTextureKey})}positionSprite(t,i,s,n){const{x:a,y:r}=me(i,s,this.originX,this.originY,this.tileSize);t.setPosition(a,r);const o=n??t.getData("isoDepthBias")??H.PROP_TALL;this.assignDepth(t,a,r,o),t.setData("isoGrid",{x:i,y:s})}updateCharacterBase(t,i,s,n){const a=t.getData("isoOptions")??{},r={baseColor:(n==null?void 0:n.baseColor)??a.baseColor??1120295,outlineColor:(n==null?void 0:n.outlineColor)??a.outlineColor??T(1120295,.25),alpha:(n==null?void 0:n.alpha)??a.alpha??.85,widthScale:(n==null?void 0:n.widthScale)??a.widthScale??.82,heightScale:(n==null?void 0:n.heightScale)??a.heightScale??.6,depthOffset:(n==null?void 0:n.depthOffset)??a.depthOffset??2};t.setData("isoOptions",r);const{x:o,y:l}=me(i,s,this.originX,this.originY,this.tileSize),c=ge(this.tileSize),d=c.tileWidth*(r.widthScale??1),u=c.tileHeight*(r.heightScale??1),h=ne(o,l,d,u);t.clear(),t.fillStyle(r.baseColor??1120295,r.alpha??.85),t.fillPoints(h,!0),t.lineStyle(1.4,r.outlineColor??T(r.baseColor??1120295,.25),(r.alpha??.85)+.1),t.strokePoints(h,!0);const g=H.CHARACTER_BASE+(r.depthOffset??0);this.assignDepth(t,o,l,g)}createCharacterToken(t,i,s={}){const n=this.scene.add.container(0,0),a=ge(this.tileSize),r=s.widthScale??.8,o=s.heightScale??.5,l=a.tileHeight*(s.columnHeight??1.4),c=a.tileWidth*r,d=a.tileHeight*o,u=s.haloRadius??a.tileWidth*.55,h=s.baseColor??1120295,g=s.outlineColor??T(h,.25),m=s.primaryColor??3718648,p=s.accentColor??T(m,.2),v=s.glowColor??m,S=this.scene.add.graphics(),M=ne(0,0,c,d).map(f=>new P.Geom.Point(f.x,f.y));S.fillStyle(h,s.alpha??.86),S.fillPoints(M,!0),S.lineStyle(1.2,g,.72),S.strokePoints(M,!0),S.fillStyle(T(h,-.24),.8),S.fillEllipse(0,a.tileHeight*.08,c*.58,d*.52);const x=this.scene.add.graphics(),b=c*.34,A=l*.9,I=-A,w=Math.max(3,b*.4);x.fillStyle(T(m,-.28),.96),x.fillRoundedRect(-b/2,I,b,A*.8,w),x.fillStyle(T(m,-.08),.95),x.fillCircle(0,I+A*.1,b*.28),x.lineStyle(1.2,T(m,.24),.9),x.strokeRoundedRect(-b/2,I,b,A*.8,w),x.lineStyle(1,T(m,.36),.74),x.strokeCircle(0,I+A*.1,b*.28);const C=this.scene.add.graphics();C.fillStyle(p,.95),C.fillTriangle(0,I-A*.18,-3.5,I-A*.01,3.5,I-A*.01),C.lineStyle(1,T(p,.32),.9),C.strokeTriangle(0,I-A*.18,-3.5,I-A*.01,3.5,I-A*.01);const R=this.scene.add.graphics();R.fillStyle(v,.22),R.fillEllipse(0,a.tileHeight*.08,u,u*.42),R.setBlendMode(P.BlendModes.ADD),n.add([R,S,x,C]);const k={container:n,base:S,column:x,beacon:C,halo:R,depthOffset:s.depthOffset??6,options:s};return this.positionCharacterToken(k,t,i),k}positionCharacterToken(t,i,s){const{x:n,y:a}=me(i,s,this.originX,this.originY,this.tileSize);t.container.setPosition(n,a);const r=H.CHARACTER+(t.depthOffset??0);this.assignDepth(t.container,n,a,r)}createIsoSprite(t,i,s,n){var d,u;const a=n.textureKey??"props",r=n.depthBias??H.PROP_TALL,o=this.scene.add.image(0,0,a,s),l=((d=n.origin)==null?void 0:d.x)??.5,c=((u=n.origin)==null?void 0:u.y)??.5;return o.setOrigin(l,c),o.setData("isoDepthBias",r),n.normalTextureKey&&(o.setData("isoNormalTexture",n.normalTextureKey),o.setData("isoLightingApplied",!1)),this.positionSprite(o,t,i,r),o}applyLightingToSprite(t,i){if(!t||!t.getData("isoNormalTexture"))return;const n=t.getData("isoLightingApplied")===!0,a=this.scene.game.renderer instanceof P.Renderer.WebGL.WebGLRenderer;i&&a&&!n?(t.setPipeline("Light2D"),t.setData("isoLightingApplied",!0)):(!i||!a)&&n&&(t.resetPipeline(),t.setData("isoLightingApplied",!1))}}class on{constructor(){y(this,"disposables",[]);y(this,"disposed",!1)}add(t){if(this.disposed){t();return}this.disposables.push(t)}dispose(){if(!this.disposed)for(this.disposed=!0;this.disposables.length>0;){const t=this.disposables.pop();if(t)try{t()}catch(i){console.error("[DisposableBag] Failed to dispose resource.",i)}}}}const lu=(e,t,i)=>{const s=(o,l,c)=>{window.addEventListener(o,l,c),i.add(()=>window.removeEventListener(o,l,c))},n=(o,l,c)=>{document.addEventListener(o,l,c),i.add(()=>document.removeEventListener(o,l,c))},a=(o,l,c)=>{e.scale.on(o,l,c),i.add(()=>e.scale.off(o,l,c))},r=(o,l,c)=>{e.input&&(e.input.on(o,l,c),i.add(()=>{var d;(d=e.input)==null||d.off(o,l,c)}))};return{scene:e,getState:t.getState,dispatch:t.dispatch,disposables:i,listenWindow:s,listenDocument:n,listenScale:a,listenInput:r}};class cu{constructor(t){y(this,"modulesByKey",new Map);y(this,"orderedModules",[]);y(this,"orderDirty",!1);this.context=t}register(t){if(this.modulesByKey.has(t.key))throw new Error(`[SceneModuleRegistry] Duplicate module key "${t.key}".`);t.init(this.context),this.modulesByKey.set(t.key,t),this.orderDirty=!0}getOrderedModules(){if(!this.orderDirty)return this.orderedModules;const t=Array.from(this.modulesByKey.keys()),i=new Map(t.map((o,l)=>[o,l])),s=new Map(t.map(o=>[o,0])),n=new Map(t.map(o=>[o,[]]));this.modulesByKey.forEach(o=>{(o.dependsOn??[]).forEach(c=>{var d;if(!this.modulesByKey.has(c))throw new Error(`[SceneModuleRegistry] Module "${o.key}" depends on missing module "${c}".`);s.set(o.key,(s.get(o.key)??0)+1),(d=n.get(c))==null||d.push(o.key)})});const a=t.filter(o=>(s.get(o)??0)===0),r=[];for(;a.length>0;){const o=a.shift();if(!o)continue;r.push(o),(n.get(o)??[]).forEach(c=>{const d=(s.get(c)??0)-1;s.set(c,d),d===0&&(a.push(c),a.sort((u,h)=>(i.get(u)??0)-(i.get(h)??0)))})}if(r.length!==this.modulesByKey.size){const o=t.filter(l=>(s.get(l)??0)>0);throw new Error(`[SceneModuleRegistry] Dependency cycle detected: ${o.join(" -> ")}.`)}return this.orderedModules=r.map(o=>{const l=this.modulesByKey.get(o);if(!l)throw new Error(`[SceneModuleRegistry] Internal error: module "${o}" not found.`);return l}),this.orderDirty=!1,this.orderedModules}onCreate(){this.getOrderedModules().forEach(t=>{var i;(i=t.onCreate)==null||i.call(t)})}onStateChange(t,i){this.getOrderedModules().forEach(s=>{var n;(n=s.onStateChange)==null||n.call(s,t,i)})}onResize(){this.getOrderedModules().forEach(t=>{var i;(i=t.onResize)==null||i.call(t)})}onUpdate(t,i){this.getOrderedModules().forEach(s=>{var n;(n=s.onUpdate)==null||n.call(s,t,i)})}onShutdown(){var i;const t=this.getOrderedModules();for(let s=t.length-1;s>=0;s-=1){const n=t[s];n&&((i=n.onShutdown)==null||i.call(n))}this.modulesByKey.clear(),this.orderedModules=[],this.orderDirty=!1}}const du=1.12,bi=.38,Bt=2.3,uu=6,ln=.08,hu=1.28,pu=.22,mu=340,j=(e,t)=>Reflect.get(e,t),Ot=(e,t)=>{const i=j(e,t);if(i==null)throw new Error(`[CameraModule] Missing required scene value: ${t}`);return i},cn=(e,t,i)=>{const s=j(e,t);return typeof s=="number"?s:i},K=(e,t,...i)=>{const s=j(e,t);if(typeof s!="function")throw new Error(`[CameraModule] Missing required scene method: ${t}`);return s.apply(e,i)},gu=e=>({cameras:Ot(e,"cameras"),scale:Ot(e,"scale"),sys:Ot(e,"sys"),tweens:Ot(e,"tweens"),getCurrentMapArea:()=>j(e,"currentMapArea")??null,getPlayerInitialPosition:()=>j(e,"playerInitialPosition"),getPlayerTokenContainer:()=>{const t=j(e,"playerToken");return t==null?void 0:t.container},getTileSize:()=>cn(e,"tileSize",0),setIsoOrigin:(t,i)=>{Reflect.set(e,"isoOriginX",t),Reflect.set(e,"isoOriginY",i)},ensureIsoFactory:()=>{K(e,"ensureIsoFactory")},ensureVisualPipeline:()=>{K(e,"ensureVisualPipeline")},getIsoMetrics:()=>K(e,"getIsoMetrics"),calculatePixelPosition:(t,i)=>K(e,"calculatePixelPosition",t,i),computeIsoBounds:()=>K(e,"computeIsoBounds"),renderStaticProps:()=>{K(e,"renderStaticProps")},drawBackdrop:()=>{K(e,"drawBackdrop")},drawMap:t=>{K(e,"drawMap",t)},drawBuildingMasses:()=>{K(e,"drawBuildingMasses")},drawBuildingLabels:()=>{K(e,"drawBuildingLabels")},clearPathPreview:()=>{K(e,"clearPathPreview")},resizeDayNightOverlay:()=>{K(e,"resizeDayNightOverlay")},applyOverlayZoom:()=>{K(e,"applyOverlayZoom")},emitViewportUpdate:()=>{K(e,"emitViewportUpdate")},dispatchPlayerScreenPosition:()=>{K(e,"dispatchPlayerScreenPosition")},isInCombat:()=>!!j(e,"inCombat"),readRuntimeState:()=>({isCameraFollowingPlayer:!!j(e,"isCameraFollowingPlayer"),hasInitialZoomApplied:!!j(e,"hasInitialZoomApplied"),userAdjustedZoom:!!j(e,"userAdjustedZoom"),pendingCameraRestore:!!j(e,"pendingCameraRestore"),preCombatZoom:j(e,"preCombatZoom")??null,preCombatUserAdjusted:!!j(e,"preCombatUserAdjusted"),pendingRestoreUserAdjusted:j(e,"pendingRestoreUserAdjusted")??null,baselineCameraZoom:cn(e,"baselineCameraZoom",1),cameraZoomTween:j(e,"cameraZoomTween")??null}),writeRuntimeState:t=>{Reflect.set(e,"isCameraFollowingPlayer",t.isCameraFollowingPlayer),Reflect.set(e,"hasInitialZoomApplied",t.hasInitialZoomApplied),Reflect.set(e,"userAdjustedZoom",t.userAdjustedZoom),Reflect.set(e,"pendingCameraRestore",t.pendingCameraRestore),Reflect.set(e,"preCombatZoom",t.preCombatZoom),Reflect.set(e,"preCombatUserAdjusted",t.preCombatUserAdjusted),Reflect.set(e,"pendingRestoreUserAdjusted",t.pendingRestoreUserAdjusted),Reflect.set(e,"baselineCameraZoom",t.baselineCameraZoom),Reflect.set(e,"cameraZoomTween",t.cameraZoomTween)}}),fu=()=>({isCameraFollowingPlayer:!1,hasInitialZoomApplied:!1,userAdjustedZoom:!1,pendingCameraRestore:!1,preCombatZoom:null,preCombatUserAdjusted:!1,pendingRestoreUserAdjusted:null,baselineCameraZoom:1,cameraZoomTween:null});class yu{constructor(t,i){y(this,"key","camera");y(this,"context");y(this,"ports");y(this,"runtimeState");y(this,"handleWheel",(t,i,s,n)=>{if(!this.ports.sys.isActive())return;const a=this.ports.cameras.main,r=n>0?.82:1.18,o=a.zoom,l=P.Math.Clamp(o*r,bi,Bt);if(Math.abs(l-o)<5e-4)return;this.ports.isInCombat()||(this.runtimeState.userAdjustedZoom=!0),this.stopCameraZoomTween();let c=null;if(this.runtimeState.isCameraFollowingPlayer||(c=a.getWorldPoint(t.x,t.y)),a.setZoom(l),this.runtimeState.isCameraFollowingPlayer)a.setDeadzone(Math.max(120,this.ports.scale.width*.22),Math.max(160,this.ports.scale.height*.28)),this.recenterCameraOnPlayer();else{const d=a.getWorldPoint(t.x,t.y),u=((c==null?void 0:c.x)??0)-d.x,h=((c==null?void 0:c.y)??0)-d.y;a.scrollX+=u,a.scrollY+=h,this.clampCameraToBounds(a)}this.ports.applyOverlayZoom(),this.ports.emitViewportUpdate(),this.ports.isInCombat()||(this.runtimeState.baselineCameraZoom=l),this.pushRuntimeStateToPorts()});var s,n;this.ports=i??gu(t),this.runtimeState={...fu(),...(n=(s=this.ports).readRuntimeState)==null?void 0:n.call(s)},this.pushRuntimeStateToPorts()}init(t){this.context=t}onCreate(){this.context.listenInput("wheel",this.handleWheel)}onResize(){this.ports.sys.isActive()&&this.ports.getCurrentMapArea()&&(this.setupCameraAndMap(),this.enablePlayerCameraFollow(),this.ports.resizeDayNightOverlay())}onShutdown(){this.stopCameraZoomTween()}setupCameraAndMap(){const t=this.ports.getCurrentMapArea();if(!t)return;const{width:i,height:s}=t,{tileHeight:n,halfTileWidth:a,halfTileHeight:r}=this.ports.getIsoMetrics(),o=this.ports.scale.width,l=this.ports.scale.height;this.ports.setIsoOrigin((s-1)*a,n),this.ports.ensureIsoFactory(),this.ports.ensureVisualPipeline();const c=(i+s)*a,d=(i+s)*r,u=o/c,h=l/d,g=Math.min(u,h),m=P.Math.Clamp(g*du,bi,Bt),p=this.ports.cameras.main,v=this.runtimeState.pendingCameraRestore||!!this.runtimeState.cameraZoomTween;this.ports.isInCombat()||(this.runtimeState.hasInitialZoomApplied?!this.runtimeState.userAdjustedZoom&&!v&&Math.abs(p.zoom-m)>8e-4&&(this.runtimeState.userAdjustedZoom=!1,this.animateCameraZoom(m)):v||p.setZoom(m));const S=this.ports.computeIsoBounds(),M=this.ports.getTileSize()*uu;p.setBounds(S.minX-M,S.minY-M,S.maxX-S.minX+M*2,S.maxY-S.minY+M*2);const x=(i-1)/2,b=(s-1)/2,A=this.ports.calculatePixelPosition(x,b),I=this.ports.getPlayerInitialPosition(),C=(I?this.ports.calculatePixelPosition(I.x,I.y):null)??A;this.runtimeState.isCameraFollowingPlayer?this.recenterCameraOnPlayer():p.centerOn(C.x,C.y+n*.25),this.ports.renderStaticProps(),this.ports.drawBackdrop(),this.ports.drawMap(t.tiles),this.ports.drawBuildingMasses(),this.ports.drawBuildingLabels(),this.ports.clearPathPreview(),this.ports.resizeDayNightOverlay(),this.ports.emitViewportUpdate(),!this.ports.isInCombat()&&!v&&(this.runtimeState.baselineCameraZoom=p.zoom),this.runtimeState.hasInitialZoomApplied=!0,this.pushRuntimeStateToPorts()}enablePlayerCameraFollow(){const t=this.ports.getPlayerTokenContainer();if(!t||!this.ports.sys.isActive())return;const i=this.ports.cameras.main;this.runtimeState.isCameraFollowingPlayer||i.startFollow(t,!1,ln,ln),i.setDeadzone(Math.max(120,this.ports.scale.width*.22),Math.max(160,this.ports.scale.height*.28)),this.runtimeState.isCameraFollowingPlayer=!0,this.pushRuntimeStateToPorts(),this.recenterCameraOnPlayer(),this.ports.dispatchPlayerScreenPosition()}recenterCameraOnPlayer(){const t=this.ports.getPlayerTokenContainer();if(!t||!this.ports.sys.isActive())return;this.ports.cameras.main.centerOn(t.x,t.y),this.ports.dispatchPlayerScreenPosition()}isFollowingPlayer(){return this.runtimeState.isCameraFollowingPlayer}clampCameraToBounds(t){const i=t.getBounds();if(!i)return;const s=t.width/t.zoom,n=t.height/t.zoom,a=i.x,r=i.x+Math.max(0,i.width-s),o=i.y,l=i.y+Math.max(0,i.height-n);t.scrollX=P.Math.Clamp(t.scrollX,a,r),t.scrollY=P.Math.Clamp(t.scrollY,o,l)}clampCameraCenterTarget(t,i){const s=this.ports.cameras.main,n=s.getBounds();if(!n)return{x:t,y:i};const a=s.worldView.width,r=s.worldView.height,o=a/2,l=r/2,c=n.x+o,d=n.x+Math.max(o,n.width-o),u=n.y+l,h=n.y+Math.max(l,n.height-l),g=P.Math.Clamp(t,c,Math.max(c,d)),m=P.Math.Clamp(i,u,Math.max(u,h));return{x:g,y:m}}focusCameraOnGridPosition(t,i,s=!0){if(!this.ports.sys.isActive()||!this.ports.getCurrentMapArea())return;const n=this.ports.getIsoMetrics(),a=this.ports.calculatePixelPosition(t,i),r=a.x,o=a.y+n.halfTileHeight,{x:l,y:c}=this.clampCameraCenterTarget(r,o),d=this.ports.cameras.main;this.runtimeState.isCameraFollowingPlayer=!1,this.pushRuntimeStateToPorts(),d.stopFollow();const u=()=>{this.clampCameraToBounds(d),this.ports.emitViewportUpdate()};s?d.pan(l,c,300,"Sine.easeInOut",!1,(h,g)=>{this.ports.emitViewportUpdate(),g===1&&u()}):(d.centerOn(l,c),u())}stopCameraZoomTween(){this.runtimeState.cameraZoomTween&&(this.runtimeState.cameraZoomTween.remove(),this.runtimeState.cameraZoomTween=null,this.runtimeState.pendingCameraRestore&&(this.runtimeState.pendingCameraRestore=!1,this.runtimeState.pendingRestoreUserAdjusted!==null&&(this.runtimeState.userAdjustedZoom=this.runtimeState.pendingRestoreUserAdjusted),this.runtimeState.preCombatZoom=null,this.runtimeState.preCombatUserAdjusted=!1,this.runtimeState.pendingRestoreUserAdjusted=null),this.pushRuntimeStateToPorts())}animateCameraZoom(t){if(!this.ports.sys.isActive())return;const i=this.ports.cameras.main;if(!i)return;const s=P.Math.Clamp(t,bi,Bt),n=i.zoom;if(this.stopCameraZoomTween(),Math.abs(n-s)<5e-4){i.setZoom(s),this.ports.applyOverlayZoom(),this.ports.emitViewportUpdate(),this.ports.isInCombat()||(this.runtimeState.baselineCameraZoom=i.zoom),this.runtimeState.pendingCameraRestore&&(this.runtimeState.pendingCameraRestore=!1,this.runtimeState.pendingRestoreUserAdjusted!==null&&(this.runtimeState.userAdjustedZoom=this.runtimeState.pendingRestoreUserAdjusted),this.runtimeState.preCombatZoom=null,this.runtimeState.preCombatUserAdjusted=!1,this.runtimeState.pendingRestoreUserAdjusted=null),this.pushRuntimeStateToPorts();return}this.runtimeState.cameraZoomTween=this.ports.tweens.add({targets:i,zoom:s,duration:mu,ease:"Sine.easeInOut",onUpdate:()=>{this.ports.applyOverlayZoom(),this.ports.emitViewportUpdate()},onComplete:()=>{this.runtimeState.cameraZoomTween=null,this.ports.isInCombat()||(this.runtimeState.baselineCameraZoom=i.zoom),this.runtimeState.pendingCameraRestore&&(this.runtimeState.pendingCameraRestore=!1,this.runtimeState.pendingRestoreUserAdjusted!==null&&(this.runtimeState.userAdjustedZoom=this.runtimeState.pendingRestoreUserAdjusted),this.runtimeState.preCombatZoom=null,this.runtimeState.preCombatUserAdjusted=!1,this.runtimeState.pendingRestoreUserAdjusted=null),this.pushRuntimeStateToPorts()}}),this.pushRuntimeStateToPorts()}zoomCameraForCombat(){const t=this.ports.cameras.main;if(!t)return;this.runtimeState.pendingCameraRestore=!1;const i=t.zoom;this.runtimeState.preCombatZoom===null&&(this.runtimeState.preCombatZoom=i,this.runtimeState.preCombatUserAdjusted=this.runtimeState.userAdjustedZoom),this.runtimeState.baselineCameraZoom=i;const s=Math.min(Bt,Math.max(i*hu,i+pu));this.runtimeState.userAdjustedZoom=!1,this.pushRuntimeStateToPorts(),this.animateCameraZoom(s)}restoreCameraAfterCombat(){const t=this.ports.cameras.main;if(!t)return;const i=this.runtimeState.preCombatZoom??this.runtimeState.baselineCameraZoom??t.zoom;this.runtimeState.pendingRestoreUserAdjusted=this.runtimeState.preCombatUserAdjusted,this.runtimeState.userAdjustedZoom=!0,this.runtimeState.pendingCameraRestore=!0,this.pushRuntimeStateToPorts(),this.animateCameraZoom(i)}resetForMapTransition(){this.runtimeState.hasInitialZoomApplied=!1,this.runtimeState.userAdjustedZoom=!1,this.runtimeState.pendingCameraRestore=!1,this.runtimeState.preCombatZoom=null,this.runtimeState.preCombatUserAdjusted=!1,this.runtimeState.pendingRestoreUserAdjusted=null,this.pushRuntimeStateToPorts()}pushRuntimeStateToPorts(){var t,i;(i=(t=this.ports).writeRuntimeState)==null||i.call(t,this.runtimeState)}}const Ea=.5,Vi=5,ps=(e,t)=>Reflect.get(e,t),Je=(e,t,i)=>{const s=ps(e,t);return typeof s=="number"?s:i},Nt=(e,t,...i)=>{const s=ps(e,t);if(typeof s!="function")throw new Error(`[ClockModule] Missing required scene method: ${t}`);return s.apply(e,i)},Su=e=>({getCurrentGameTime:()=>Je(e,"currentGameTime",F.getState().world.currentTime),getAtmosphereRedrawBucket:()=>Je(e,"lastAtmosphereRedrawBucket",-1),setAtmosphereRedrawBucket:t=>{Reflect.set(e,"lastAtmosphereRedrawBucket",t)},signalAtmosphereRedraw:()=>{const t=ps(e,"currentMapArea");t&&(Nt(e,"drawBackdrop"),Nt(e,"drawMap",t.tiles))},signalOverlayUpdate:()=>{Nt(e,"updateDayNightOverlay")},signalOcclusionUpdate:()=>{Nt(e,"applyOcclusionReadability")},dispatchGameTime:t=>{F.dispatch(sa(t))},shouldApplySuspicionDecay:()=>!!F.getState().settings.reputationSystemsEnabled,dispatchSuspicionDecay:(t,i)=>{F.dispatch(ba({elapsedSeconds:t,timestamp:i}))},readRuntimeState:()=>({currentGameTime:Je(e,"currentGameTime",F.getState().world.currentTime),timeDispatchAccumulator:Je(e,"timeDispatchAccumulator",0),lastAtmosphereRedrawBucket:Je(e,"lastAtmosphereRedrawBucket",-1),dispatchCadenceSeconds:Ea,atmosphereBucketSeconds:Vi}),writeRuntimeState:t=>{Reflect.set(e,"currentGameTime",t.currentGameTime),Reflect.set(e,"timeDispatchAccumulator",t.timeDispatchAccumulator),Reflect.set(e,"lastAtmosphereRedrawBucket",t.lastAtmosphereRedrawBucket)}}),vu=e=>({currentGameTime:e,timeDispatchAccumulator:0,lastAtmosphereRedrawBucket:Math.floor(e/Vi),dispatchCadenceSeconds:Ea,atmosphereBucketSeconds:Vi});class bu{constructor(t,i){y(this,"key","clock");y(this,"dependsOn",["stateSync","worldRender","dayNightOverlay"]);y(this,"ports");y(this,"runtimeState");var s,n;this.ports=i??Su(t),this.runtimeState={...vu(this.ports.getCurrentGameTime()),...(n=(s=this.ports).readRuntimeState)==null?void 0:n.call(s)},this.runtimeState.lastAtmosphereRedrawBucket<0&&(this.runtimeState.lastAtmosphereRedrawBucket=Math.floor(this.runtimeState.currentGameTime/this.runtimeState.atmosphereBucketSeconds)),this.ports.setAtmosphereRedrawBucket(this.runtimeState.lastAtmosphereRedrawBucket),this.pushRuntimeStateToPorts()}init(t){}onStateChange(t,i){const s=i.world.currentTime;Math.abs(s-this.runtimeState.currentGameTime)>1e-4&&(this.runtimeState.currentGameTime=s,this.pushRuntimeStateToPorts())}onUpdate(t,i){const s=i/1e3;if(!Number.isFinite(s)||s<=0)return;this.runtimeState.currentGameTime+=s,this.runtimeState.timeDispatchAccumulator+=s;const n=Math.floor(this.runtimeState.currentGameTime/this.runtimeState.atmosphereBucketSeconds),a=this.ports.getAtmosphereRedrawBucket();if(n!==a&&(this.runtimeState.lastAtmosphereRedrawBucket=n,this.ports.setAtmosphereRedrawBucket(n),this.ports.signalAtmosphereRedraw()),this.ports.signalOverlayUpdate(),this.ports.signalOcclusionUpdate(),this.runtimeState.timeDispatchAccumulator>=this.runtimeState.dispatchCadenceSeconds){const r=this.runtimeState.timeDispatchAccumulator;this.ports.dispatchGameTime(r),this.ports.shouldApplySuspicionDecay()&&this.ports.dispatchSuspicionDecay(r,this.runtimeState.currentGameTime),this.runtimeState.timeDispatchAccumulator=0}this.pushRuntimeStateToPorts()}getCurrentGameTime(){return this.runtimeState.currentGameTime}pushRuntimeStateToPorts(){var t,i;(i=(t=this.ports).writeRuntimeState)==null||i.call(t,this.runtimeState)}}const wu=.28,Pu=16777215,ai=(e,t)=>Reflect.get(e,t),Ht=(e,t)=>{const i=ai(e,t);if(i==null)throw new Error(`[DayNightOverlayModule] Missing required scene value: ${t}`);return i},Mu=(e,t,i)=>{const s=ai(e,t);return typeof s=="number"?s:i},dn=(e,t,...i)=>{const s=ai(e,t);if(typeof s!="function")throw new Error(`[DayNightOverlayModule] Missing required scene method: ${t}`);return s.apply(e,i)},Au=e=>({add:Ht(e,"add"),cameras:Ht(e,"cameras"),scale:Ht(e,"scale"),sys:Ht(e,"sys"),getCurrentGameTime:()=>Mu(e,"currentGameTime",0),isInCombat:()=>!!ai(e,"inCombat"),resolveAtmosphereProfile:t=>dn(e,"resolveAtmosphereProfile",t),registerStaticDepth:(t,i)=>{dn(e,"registerStaticDepth",t,i)}});class xu{constructor(t,i){y(this,"key","dayNightOverlay");y(this,"context");y(this,"overlay");y(this,"ports");y(this,"handleVisibilityChange",()=>{var t;this.ports.sys.isActive()&&document.visibilityState==="visible"&&(this.resizeDayNightOverlay(),this.updateDayNightOverlay(),(t=this.overlay)==null||t.setVisible(!0))});this.ports=i??Au(t)}init(t){this.context=t}onCreate(){this.context.listenDocument("visibilitychange",this.handleVisibilityChange)}onShutdown(){this.overlay&&(this.overlay.destroy(),this.overlay=void 0)}initializeDayNightOverlay(){const t=this.ports.scale.width,i=this.ports.scale.height,s=this.ports.add.rectangle(0,0,t,i,0,0);s.setOrigin(.5,.5),s.setScrollFactor(0),this.ports.registerStaticDepth(s,Ge.DAY_NIGHT_OVERLAY),s.setBlendMode(P.BlendModes.MULTIPLY),s.setSize(t,i),s.setDisplaySize(t,i),this.overlay=s,this.applyOverlayZoom()}applyOverlayZoom(){const t=this.overlay;if(!t)return;const s=1/(this.ports.cameras.main.zoom||1);t.setScale(s,s),t.setPosition(this.ports.scale.width/2,this.ports.scale.height/2)}resizeDayNightOverlay(){const t=this.overlay;if(!t)return;const i=this.ports.scale.width,s=this.ports.scale.height;t.setSize(i,s),t.setDisplaySize(i,s),this.applyOverlayZoom()}updateDayNightOverlay(){const t=this.overlay;if(!t)return;const i=gl(this.ports.getCurrentGameTime(),G),s=this.ports.resolveAtmosphereProfile(i),n=this.ports.isInCombat(),a=n?Math.min(s.overlayAlpha,wu):s.overlayAlpha,r=n?Pu:s.overlayColor;t.setFillStyle(r,a)}}const Iu="isoTileSelected",zi="isoPathPreview",Cu="minimapViewportClick",ku="minimapStateUpdate",Tu="minimapZoomUpdate",Zg="minimapPathPreview",Ru="minimapObjectiveFocus",Eu="playerScreenPositionUpdate",_u="pickupStateSync",J=(e,t)=>Reflect.get(e,t),Ae=(e,t)=>{const i=J(e,t);if(i==null)throw new Error(`[EntityRenderModule] Missing required scene value: ${t}`);return i},et=(e,t,...i)=>{const s=J(e,t);if(typeof s!="function")throw new Error(`[EntityRenderModule] Missing required scene method: ${t}`);return s.apply(e,i)},Du=e=>({add:Ae(e,"add"),cameras:Ae(e,"cameras"),game:Ae(e,"game"),scale:Ae(e,"scale"),sys:Ae(e,"sys"),hasMapGraphics:()=>!!J(e,"mapGraphics"),ensureIsoFactory:()=>{et(e,"ensureIsoFactory")},getIsoMetrics:()=>et(e,"getIsoMetrics"),calculatePixelPosition:(t,i)=>et(e,"calculatePixelPosition",t,i),syncDepth:(t,i,s,n)=>{et(e,"syncDepth",t,i,s,n)},enablePlayerCameraFollow:()=>{et(e,"enablePlayerCameraFollow")},isInCombat:()=>!!J(e,"inCombat"),isCameraFollowingPlayer:()=>!!J(e,"isCameraFollowingPlayer"),createCharacterToken:(t,i,s)=>{const n=J(e,"characterRigFactory");let a;if(n)a=n.createToken(t,i,s);else{const r=Ae(e,"isoFactory"),o=Ae(e,"visualTheme");a=r.createCharacterToken(i,s,o.entityProfiles[t])}if(!a)throw new Error("[EntityRenderModule] Failed to create character token.");return a},positionCharacterToken:(t,i,s)=>{const n=J(e,"characterRigFactory");if(n){n.positionToken(t,i,s);return}Ae(e,"isoFactory").positionCharacterToken(t,i,s)},readRuntimeState:()=>({playerToken:J(e,"playerToken"),playerNameLabel:J(e,"playerNameLabel"),playerVitalsIndicator:J(e,"playerVitalsIndicator"),enemySprites:J(e,"enemySprites")??new Map,npcSprites:J(e,"npcSprites")??new Map,lastPlayerGridPosition:J(e,"lastPlayerGridPosition")??null,lastPlayerScreenDetail:J(e,"lastPlayerScreenDetail")}),writeRuntimeState:t=>{Reflect.set(e,"playerToken",t.playerToken),Reflect.set(e,"playerNameLabel",t.playerNameLabel),Reflect.set(e,"playerVitalsIndicator",t.playerVitalsIndicator),Reflect.set(e,"enemySprites",t.enemySprites),Reflect.set(e,"npcSprites",t.npcSprites),Reflect.set(e,"lastPlayerGridPosition",t.lastPlayerGridPosition),Reflect.set(e,"lastPlayerScreenDetail",t.lastPlayerScreenDetail)}}),Lu=()=>({playerToken:void 0,playerNameLabel:void 0,playerVitalsIndicator:void 0,enemySprites:new Map,npcSprites:new Map,lastPlayerGridPosition:null,lastPlayerScreenDetail:void 0});class Fu{constructor(t,i){y(this,"key","entityRender");y(this,"ports");y(this,"runtimeState");this.ports=i??Du(t),this.runtimeState=Lu(),this.pullRuntimeStateFromPorts(),this.pushRuntimeStateToPorts()}init(){}onUpdate(){this.dispatchPlayerScreenPosition()}onShutdown(){this.pullRuntimeStateFromPorts(),this.clearEntities(),this.runtimeState.playerToken&&(this.runtimeState.playerToken.container.destroy(!0),this.runtimeState.playerToken=void 0),this.runtimeState.playerNameLabel&&(this.runtimeState.playerNameLabel.destroy(),this.runtimeState.playerNameLabel=void 0),this.runtimeState.lastPlayerGridPosition=null,this.runtimeState.lastPlayerScreenDetail=void 0,this.destroyPlayerVitalsIndicator(),this.pushRuntimeStateToPorts()}initializePlayer(t,i){if(this.pullRuntimeStateFromPorts(),!t)return!1;this.ports.ensureIsoFactory(),this.runtimeState.playerToken=this.ports.createCharacterToken("player",t.x,t.y);const s=this.ports.getIsoMetrics(),n=this.ports.calculatePixelPosition(t.x,t.y);return this.runtimeState.playerNameLabel=this.createCharacterNameLabel(i,3718648,14),this.positionCharacterLabel(this.runtimeState.playerNameLabel,n.x,n.y,s.tileHeight*1.6),this.runtimeState.lastPlayerGridPosition={...t},this.pushRuntimeStateToPorts(),!0}getPlayerTokenContainer(){var t;return this.pullRuntimeStateFromPorts(),(t=this.runtimeState.playerToken)==null?void 0:t.container}getLastPlayerGridPosition(){return this.pullRuntimeStateFromPorts(),this.runtimeState.lastPlayerGridPosition}getRuntimeStateSnapshot(){return this.pullRuntimeStateFromPorts(),this.runtimeState}updatePlayerPosition(t){if(this.pullRuntimeStateFromPorts(),!this.runtimeState.playerToken){console.warn("[MainScene] Player token not available for position update.");return}const i=!this.runtimeState.lastPlayerGridPosition||this.runtimeState.lastPlayerGridPosition.x!==t.x||this.runtimeState.lastPlayerGridPosition.y!==t.y;this.ports.ensureIsoFactory(),this.ports.positionCharacterToken(this.runtimeState.playerToken,t.x,t.y);const s=this.ports.calculatePixelPosition(t.x,t.y);if(this.dispatchPlayerScreenPosition(),this.runtimeState.playerNameLabel){const n=this.ports.getIsoMetrics();this.positionCharacterLabel(this.runtimeState.playerNameLabel,s.x,s.y,n.tileHeight*1.6)}i&&(this.runtimeState.lastPlayerGridPosition={...t},this.ports.isCameraFollowingPlayer()||this.ports.enablePlayerCameraFollow()),this.pushRuntimeStateToPorts()}updatePlayerVitalsIndicator(t,i,s){if(this.pullRuntimeStateFromPorts(),!this.ports.isInCombat()){this.destroyPlayerVitalsIndicator();return}if(!this.runtimeState.playerToken||!this.ports.sys.isActive())return;const n=this.ports.getIsoMetrics(),a=this.ports.calculatePixelPosition(t.x,t.y),r=n.tileWidth*.38,o=Math.max(4,n.tileHeight*.08),l=a.x-r/2,c=a.y-n.tileHeight*.7,d=s>0?Math.max(0,Math.min(1,i/s)):0;this.runtimeState.playerVitalsIndicator||(this.runtimeState.playerVitalsIndicator=this.ports.add.graphics());const u=this.runtimeState.playerVitalsIndicator;u.clear(),u.fillStyle(988970,.82),u.fillRoundedRect(l,c,r,o,Math.min(4,o)),d>0&&(u.fillStyle(3718648,1),u.fillRoundedRect(l+1,c+1,(r-2)*d,Math.max(1,o-2),Math.max(2,o-2))),this.ports.syncDepth(u,a.x,a.y,H.FLOATING_UI+9),this.pushRuntimeStateToPorts()}destroyPlayerVitalsIndicator(){this.pullRuntimeStateFromPorts(),this.runtimeState.playerVitalsIndicator&&(this.runtimeState.playerVitalsIndicator.destroy(),this.runtimeState.playerVitalsIndicator=void 0,this.pushRuntimeStateToPorts())}updateEnemies(t){if(this.pullRuntimeStateFromPorts(),!this.ports.hasMapGraphics()||!this.ports.sys.isActive())return;this.ports.ensureIsoFactory(),this.runtimeState.enemySprites.forEach(s=>{s.markedForRemoval=!0});const i=this.ports.getIsoMetrics();for(const s of t){const n=this.runtimeState.enemySprites.get(s.id),a=this.ports.calculatePixelPosition(s.position.x,s.position.y);if(!n){if(s.health<=0)continue;const r=this.ports.createCharacterToken("hostileNpc",s.position.x,s.position.y),o=this.ports.add.graphics();o.setVisible(!1);const l=this.createCharacterNameLabel(s.name??"Hostile",15680580);this.positionCharacterLabel(l,a.x,a.y,i.tileHeight*1.45),this.runtimeState.enemySprites.set(s.id,{token:r,healthBar:o,nameLabel:l,markedForRemoval:!1});const c=this.runtimeState.enemySprites.get(s.id);c&&this.updateEnemyHealthBar(c,a,i,s);continue}if(s.health<=0){n.markedForRemoval=!0;continue}this.ports.positionCharacterToken(n.token,s.position.x,s.position.y),n.markedForRemoval=!1,this.positionCharacterLabel(n.nameLabel,a.x,a.y,i.tileHeight*1.45),this.updateEnemyHealthBar(n,a,i,s)}this.runtimeState.enemySprites.forEach((s,n)=>{s.markedForRemoval&&(s.token.container.destroy(!0),s.healthBar.destroy(),s.nameLabel.destroy(),this.runtimeState.enemySprites.delete(n))}),this.pushRuntimeStateToPorts()}updateNpcs(t){if(this.pullRuntimeStateFromPorts(),!this.ports.sys.isActive())return;this.runtimeState.npcSprites.forEach(s=>{s.markedForRemoval=!0}),this.ports.ensureIsoFactory();const i=this.ports.getIsoMetrics();for(const s of t){const n=this.runtimeState.npcSprites.get(s.id),a=this.ports.calculatePixelPosition(s.position.x,s.position.y);if(!n){const r=s.isInteractive?"interactiveNpc":"friendlyNpc",o=this.ports.createCharacterToken(r,s.position.x,s.position.y),l=this.createCharacterNameLabel(s.name??"Civilian",s.isInteractive?2282478:9741240);this.positionCharacterLabel(l,a.x,a.y,i.tileHeight*1.35);const c={token:o,nameLabel:l,markedForRemoval:!1};this.runtimeState.npcSprites.set(s.id,c),this.updateNpcCombatIndicator(c,a,i,s);continue}this.ports.positionCharacterToken(n.token,s.position.x,s.position.y),n.markedForRemoval=!1,this.positionCharacterLabel(n.nameLabel,a.x,a.y,i.tileHeight*1.35),this.updateNpcCombatIndicator(n,a,i,s)}this.runtimeState.npcSprites.forEach((s,n)=>{s.markedForRemoval&&(s.token.container.destroy(!0),s.nameLabel.destroy(),s.indicator&&s.indicator.destroy(),this.runtimeState.npcSprites.delete(n))}),this.pushRuntimeStateToPorts()}clearForMapTransition(){this.pullRuntimeStateFromPorts(),this.clearEntities(),this.runtimeState.lastPlayerScreenDetail=void 0,this.runtimeState.lastPlayerGridPosition=null,this.destroyPlayerVitalsIndicator(),this.pushRuntimeStateToPorts()}resetCombatIndicators(){this.pullRuntimeStateFromPorts(),this.destroyPlayerVitalsIndicator(),this.runtimeState.enemySprites.forEach(t=>{t.healthBar.clear(),t.healthBar.setVisible(!1)}),this.runtimeState.npcSprites.forEach(t=>{t.indicator&&(t.indicator.destroy(),t.indicator=void 0)}),this.pushRuntimeStateToPorts()}createCharacterNameLabel(t,i,s=12){const n=this.ports.add.text(0,0,t.toUpperCase(),{fontFamily:'Orbitron, "DM Sans", sans-serif',fontSize:`${s}px`,fontStyle:"700",color:this.colorToHex(16317180),align:"center"});return n.setOrigin(.5,1),n.setStroke(this.colorToHex(i),1.4),n.setShadow(0,0,this.colorToHex(i),8,!0,!0),n.setBlendMode(P.BlendModes.ADD),n.setAlpha(.95),n}positionCharacterLabel(t,i,s,n){t.setPosition(i,s-n),t.setDepth(hs(i,s,H.OVERLAY))}dispatchPlayerScreenPosition(){var h;if(this.pullRuntimeStateFromPorts(),!this.runtimeState.playerToken||!this.ports.sys.isActive())return;const t=this.ports.cameras.main,i=this.runtimeState.playerToken.container,s=i.x,n=i.y,a=(s-t.worldView.x)*t.zoom,r=(n-t.worldView.y)*t.zoom,o=(h=this.ports.game.canvas)==null?void 0:h.getBoundingClientRect(),l=(o==null?void 0:o.width)??this.ports.scale.width,c=(o==null?void 0:o.height)??this.ports.scale.height,d={worldX:s,worldY:n,screenX:a,screenY:r,canvasWidth:this.ports.scale.width,canvasHeight:this.ports.scale.height,canvasDisplayWidth:l,canvasDisplayHeight:c,canvasLeft:(o==null?void 0:o.left)??0,canvasTop:(o==null?void 0:o.top)??0,zoom:t.zoom,timestamp:typeof performance<"u"?performance.now():Date.now()},u=this.runtimeState.lastPlayerScreenDetail;u&&Math.abs(u.screenX-d.screenX)<.5&&Math.abs(u.screenY-d.screenY)<.5&&Math.abs(u.zoom-d.zoom)<1e-4&&u.canvasWidth===d.canvasWidth&&u.canvasHeight===d.canvasHeight||(this.runtimeState.lastPlayerScreenDetail=d,this.pushRuntimeStateToPorts(),typeof window<"u"&&(window.__getawayPlayerScreenPosition=d,window.dispatchEvent(new CustomEvent(Eu,{detail:d}))))}updateNpcCombatIndicator(t,i,s,n){if(!this.ports.isInCombat()||!n.isInteractive){t.indicator&&(t.indicator.destroy(),t.indicator=void 0);return}t.indicator||(t.indicator=this.ports.add.graphics());const a=t.indicator,r=s.tileWidth*.26,o=Math.max(3,s.tileHeight*.06),l=i.x-r/2,c=i.y-s.tileHeight*.68;a.clear(),a.fillStyle(1059395,.82),a.fillRoundedRect(l,c,r,o,Math.min(3,o)),a.fillStyle(2278750,1),a.fillRoundedRect(l+1,c+1,r-2,Math.max(1,o-2),Math.max(2,o-2)),this.ports.syncDepth(a,i.x,i.y,H.FLOATING_UI+6)}updateEnemyHealthBar(t,i,s,n){const a=t.healthBar;if(!this.ports.isInCombat()){a.clear(),a.setVisible(!1);return}a.setVisible(!0);const r=s.tileWidth*.38,o=Math.max(4,s.tileHeight*.08),l=i.x-r/2,c=i.y-s.tileHeight*.75,d=n.maxHealth>0?P.Math.Clamp(n.health/n.maxHealth,0,1):0;a.clear(),a.fillStyle(4136221,.88),a.fillRoundedRect(l,c,r,o,Math.min(4,o)),d>0&&(a.fillStyle(15680580,1),a.fillRoundedRect(l+1,c+1,(r-2)*d,Math.max(1,o-2),Math.max(2,o-2))),this.ports.syncDepth(a,i.x,i.y,H.FLOATING_UI+7)}pullRuntimeStateFromPorts(){var i,s;const t=(s=(i=this.ports).readRuntimeState)==null?void 0:s.call(i);t&&(t.playerToken!==void 0&&(this.runtimeState.playerToken=t.playerToken),t.playerNameLabel!==void 0&&(this.runtimeState.playerNameLabel=t.playerNameLabel),this.runtimeState.playerVitalsIndicator=t.playerVitalsIndicator,t.enemySprites&&(this.runtimeState.enemySprites=t.enemySprites),t.npcSprites&&(this.runtimeState.npcSprites=t.npcSprites),t.lastPlayerGridPosition!==void 0&&(this.runtimeState.lastPlayerGridPosition=t.lastPlayerGridPosition),this.runtimeState.lastPlayerScreenDetail=t.lastPlayerScreenDetail)}pushRuntimeStateToPorts(){var t,i;(i=(t=this.ports).writeRuntimeState)==null||i.call(t,this.runtimeState)}clearEntities(){this.runtimeState.enemySprites.forEach(t=>{t.token.container.destroy(!0),t.healthBar.destroy(),t.nameLabel.destroy()}),this.runtimeState.enemySprites.clear(),this.runtimeState.npcSprites.forEach(t=>{t.token.container.destroy(!0),t.nameLabel.destroy(),t.indicator&&(t.indicator.destroy(),t.indicator=void 0)}),this.runtimeState.npcSprites.clear()}colorToHex(t){return`#${t.toString(16).padStart(6,"0")}`}}const Ui=5,St=2,un=1,Bu="south",hn=0,Ou=["none","half","full"],Nu={none:1,half:.75,full:.55},Hu={none:0,half:-.2,full:-.4},Wu=()=>{var e;try{switch(((e=F.getState().paranoia)==null?void 0:e.tier)??"calm"){case"uneasy":return-.05;case"on_edge":return-.1;case"panicked":return-.15;case"breakdown":return-.25;default:return 0}}catch{return 0}},Qt=e=>Ou.indexOf(e),pn=(e,t)=>Qt(t)>Qt(e)?t:e,ri=(e,t)=>{const i=t.x-e.x,s=t.y-e.y;if(Math.abs(i)>=Math.abs(s)){if(i>0)return"east";if(i<0)return"west"}return s>0?"south":s<0?"north":Bu},_a=(e,t)=>e?e[t]??"none":"none",Gu=e=>{if(!e)return null;let t="north",i="none";return["north","east","south","west"].forEach(s=>{const n=_a(e,s);Qt(n)>Qt(i)&&(i=n,t=s)}),i==="none"?null:t},Da=(e,t)=>{var i,s;if(e)return(s=(i=e.tiles[t.y])==null?void 0:i[t.x])==null?void 0:s.cover},La=e=>typeof e=="boolean"?{isBehindCover:e}:e?{isBehindCover:!!e.isBehindCover,mapArea:e.mapArea}:{isBehindCover:!1},Fa=(e,t,i)=>{let s=i.isBehindCover?"half":"none";const n=ri(t.position,e.position),a=Da(i.mapArea,t.position);return s=pn(s,_a(a,n)),t.coverOrientation&&t.coverOrientation===n&&(s=pn(s,"half")),{level:s,attackDirection:n}},Ba=(e,t)=>({...e,facing:t}),Ki=(e,t)=>{if(!t)return{...e,coverOrientation:e.coverOrientation??null,suppression:e.suppression??hn};const i=Da(t,e.position);return{...e,coverOrientation:Gu(i),suppression:e.suppression??hn}},xt=(e,t,i)=>{const s=ri(t,e.position),n=Ba(e,s);return Ki(n,i)};let qu=()=>Math.random();const mn=()=>{const e=qu();if(!Number.isFinite(e)||Number.isNaN(e))throw new Error("[CombatSystem] Random generator must return a finite number between 0 and 1.");if(e<0||e>1)throw new Error("[CombatSystem] Random generator must return a value between 0 and 1.");return e},gn=e=>({...e,equipped:{...e.equipped},encumbrance:{...e.encumbrance},inventory:{...e.inventory,items:[...e.inventory.items],hotbar:[...e.inventory.hotbar]},equippedSlots:e.equippedSlots?{...e.equippedSlots}:{},perkRuntime:{...e.perkRuntime}}),ji=.25,ct=e=>{const t=e==null?void 0:e.durability;if(!t||t.max<=0)return 1;const i=t.current/t.max;return Number.isFinite(i)?Math.max(0,Math.min(1,i)):1},fn=e=>{const t=ct(e);return t<=0?0:t<=ji?.75:t<=.5?.9:1},yn=(e,t=1)=>{if(!e.durability)return e;const i=Math.max(0,e.durability.current-t);return{...e,durability:{...e.durability,current:i}}},Sn=(e,t,i,s,n)=>{if(s>0&&n===0){e.push({type:t==="weapon"?"weaponBroken":"armorBroken",message:t==="weapon"?`${i} has broken—switch weapons or repair it to continue fighting.`:`${i} is shredded! Incoming damage will hit you directly.`});return}s>ji&&n<=ji&&n>0&&e.push({type:t==="weapon"?"weaponDamaged":"armorDamaged",message:t==="weapon"?`${i} is about to fail. Repair it soon to avoid misfires.`:`${i} can barely absorb hits—seek repairs immediately.`})},Vu=(e,t)=>{const i=e.encumbrance,s=(i==null?void 0:i.attackApMultiplier)??1;if(!Number.isFinite(s))return Number.POSITIVE_INFINITY;const n=Math.ceil(t*Math.max(s,0));return Math.max(0,n)},Oa=e=>{var t;if("skills"in e){const i=e;if(lo(i.encumbrance))return Number.POSITIVE_INFINITY;const s=((t=i.encumbrance)==null?void 0:t.movementApMultiplier)??1;return Number.isFinite(s)?Math.max(1,Math.ceil(un*Math.max(s,0))):Number.POSITIVE_INFINITY}return un},zu=e=>{var t;if("skills"in e){const i=e,s=((t=i.equipped.weapon)==null?void 0:t.apCost)??St,n=Math.max(0,s);return ts(i)?0:Vu(i,n)}return St},Uu=(e,t)=>{const i=Math.abs(e.x-t.x),s=Math.abs(e.y-t.y);return i===1&&s===0||i===0&&s===1},Le=(e,t,i)=>{if(!Number.isFinite(i)||i<=0)return console.warn("[CombatSystem] Invalid attack range:",i),!1;const s=Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));return s>0&&s<=i},Ku=(e,t)=>Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)),ue=(e,t)=>Math.abs(t.x-e.x)+Math.abs(t.y-e.y),$i=e=>{try{return Lr(e)}catch(t){return console.warn("[CombatSystem] Failed to calculate equipment-aware stats, falling back to base attributes.",t),ss(e.skills)}},ju=(e,t,i)=>{const s=La(i),{level:n,attackDirection:a}=Fa(e,t,s),r=Ku(e.position,t.position);let o=.65-r*.05;if(o+=Hu[n],"skills"in e){const d=e,u=$i(d);o+=u.hitChanceModifier/100;const h=$t(d.equipped.weapon);o+=h.hitChanceBonus;const g=Fn(d.equipped.weapon),m=Xi(d,g);switch(g){case"smallGuns":{o+=Bn(m)/100;break}case"energyWeapons":{const p=Qi(m);o+=p.hit/100;break}case"meleeCombat":{const p=Ji(m);o+=p.hit/100;break}case"explosives":{const p=On(m);o+=p.accuracy/100;break}}Pr(d.equipped.weapon)&&(o+=Mr(d))}if("skills"in t){const d=$i(t);o-=d.dodgeChance/100}const l=Wu();l!==0&&(o+=l);const c=Math.max(.1,Math.min(.95,o));return console.log("[CombatSystem] calculateHitChance:",{attacker:e.id,target:t.id,distance:r,attackDirection:a,coverLevel:n,finalHitChance:c}),c},Na=(e,t,i)=>{var E,B,Y,te,le,Be,$e,ve,Ye,Ct;const s=La(i),n=Fa(e,t,s),a=zu(e);if(!Number.isFinite(a)||e.actionPoints<a)return{success:!1,damage:0,isCritical:!1,newAttacker:e,newTarget:t,events:void 0};if("skills"in e){const _=e.equipped.weapon;if(_!=null&&_.durability&&_.durability.current<=0)return{success:!1,damage:0,isCritical:!1,newAttacker:e,newTarget:t,events:[{type:"weaponBroken",message:`${_.name} is inoperable—repair or swap weapons before attacking.`}]}}const r=[],o=ju(e,t,s),c=mn()<=o;let d=0,u=!1,h=e,g;const m=ri(e.position,t.position);let p,v=1,S=!1,M=!1,x=!1,b=!1,A,I=$t(),w=0,C=0;if("skills"in e){if(p=e.equipped.weapon,v=fn(p),S=lt(p,"silenced"),M=lt(p,"armorPiercing"),x=lt(p,"energy"),b=lt(p,"hollowPoint"),I=$t(p),p){const q=p.magazineSize??0;w=q>0?Math.max(1,Math.round(q*(I.magazineSizeMultiplier??1))):0,C=w>0?Math.min(w,p.currentMagazine??w):0,w>0&&C<=0&&(C=w)}S=S||I.silenced,I.armorPiercingFactor!==void 0&&(M=!0,A=I.armorPiercingFactor)}let R=1,k,f=0;if("skills"in t){const q=t;k=q.equipped.bodyArmor??q.equipped.armor,R=fn(k),f=Math.max(0,Math.round(Rr(q)))}if(c){let q=0;if("skills"in e){const _=e,Z=$i(_),U=is(_),Ze=(p==null?void 0:p.damage)??Ui,Ka=!p||p.range<=1?Z.meleeDamageBonus:0,ws=Fn(p),Ps=Xi(_,ws);let kt=_r(Ze,U,Ka);switch(ws){case"energyWeapons":{q=Qi(Ps).crit;break}case"meleeCombat":{const Re=Ji(Ps);kt+=Re.damage;break}}kt=Math.max(0,kt);let Tt=v;Tt*=I.damageMultiplier??1,Tt*=Nu[n.level],b&&(Tt*=f>0?.5:1.25),d=Math.round(kt*Tt),d=Math.max(0,d),I.critChanceBonus&&(q+=I.critChanceBonus);const Ms=Math.max(0,Math.min(95,Z.criticalChance+q));let As=!1;if(!("skills"in t)&&Se(_,"executioner")){const Re=t;Re.maxHealth>0&&Re.health<=Re.maxHealth*.25&&(d=Math.round(d*1.5),As=!0,u=!0)}!As&&Ms>0&&mn()<=Ms/100&&(d=Math.round(d*1.5),u=!0)}else d="damage"in e?e.damage:Ui;if("skills"in t&&d>0){let _=Math.round(f*R);M&&_>0&&(_=Math.max(0,Math.floor(_*(A??.5)))),x&&(_=0),_>0&&(d=Dr(d,_))}}if("skills"in t){const q=t,_=gn(q);if(_.health=Math.max(0,q.health-d),c&&(k!=null&&k.durability)){const Z=ct(k),U=yn(k,1),Ze=ct(U);Sn(r,"armor",U.name,Z,Ze),((E=_.equipped.bodyArmor)==null?void 0:E.id)===k.id&&(_.equipped.bodyArmor=U),((B=_.equipped.armor)==null?void 0:B.id)===k.id&&(_.equipped.armor=U),((te=(Y=_.equippedSlots)==null?void 0:Y.bodyArmor)==null?void 0:te.id)===k.id&&(_.equippedSlots.bodyArmor=U)}g=_}else g={...t,health:Math.max(0,t.health-d)};if("skills"in e){const _=gn(e);if(p){const Z=ct(p),U=yn(p,1),Ze=ct(U);if(p.durability&&Sn(r,"weapon",U.name,Z,Ze),w>0){const bs=Math.max(0,Math.min(w,C-1));U.currentMagazine=bs}_.equipped.weapon=U,((Be=(le=_.equippedSlots)==null?void 0:le.primaryWeapon)==null?void 0:Be.id)===p.id&&(_.equippedSlots.primaryWeapon=U),((ve=($e=_.equippedSlots)==null?void 0:$e.secondaryWeapon)==null?void 0:ve.id)===p.id&&(_.equippedSlots.secondaryWeapon=U),((Ct=(Ye=_.equippedSlots)==null?void 0:Ye.meleeWeapon)==null?void 0:Ct.id)===p.id&&(_.equippedSlots.meleeWeapon=U)}p&&p.range>1&&!S&&r.push({type:"weaponNoise",message:`${p.name} echoes loudly—nearby hostiles are on edge.`}),_.actionPoints=Math.max(0,_.actionPoints-a),h=xr(_)}else h={...e,actionPoints:Math.max(0,e.actionPoints-a)};return{success:c,damage:d,isCritical:u,newAttacker:Ki(Ba(h,m),s.mapArea),newTarget:Ki(g,s.mapArea),events:r.length>0?r:void 0}},ms=(e,t,i,s,n)=>{const a=Oa(e);if(!Number.isFinite(a)||e.actionPoints<a||!Uu(e.position,t))return!1;const r=n.filter(l=>l.id!==e.id),o=e.id===s.id?{...s,position:{x:-1,y:-1}}:s;return ke(t,i,o,r)},It=(e,t)=>{const i=Oa(e);return!Number.isFinite(i)||i===Number.POSITIVE_INFINITY?e:{...e,position:t,actionPoints:Math.max(0,e.actionPoints-i)}},ze=(e,t)=>Reflect.get(e,t),wi=(e,t)=>{const i=ze(e,t);if(i==null)throw new Error(`[InputModule] Missing required scene value: ${t}`);return i},tt=(e,t,...i)=>{const s=ze(e,t);if(typeof s!="function")throw new Error(`[InputModule] Missing required scene method: ${t}`);return s.apply(e,i)},$u=e=>({cameras:wi(e,"cameras"),sys:wi(e,"sys"),pathGraphics:wi(e,"pathGraphics"),getCurrentMapArea:()=>ze(e,"currentMapArea")??null,setCurrentMapArea:t=>{Reflect.set(e,"currentMapArea",t)},getPlayerInitialPosition:()=>ze(e,"playerInitialPosition"),getLastPlayerGridPosition:()=>ze(e,"lastPlayerGridPosition")??null,getCoverDebugGraphics:()=>ze(e,"coverDebugGraphics"),worldToGrid:(t,i)=>tt(e,"worldToGrid",t,i),getIsoMetrics:()=>tt(e,"getIsoMetrics"),calculatePixelPosition:(t,i)=>tt(e,"calculatePixelPosition",t,i),getDiamondPoints:(t,i,s,n)=>tt(e,"getDiamondPoints",t,i,s,n),renderStaticProps:()=>{tt(e,"renderStaticProps")}});class Yu{constructor(t,i){y(this,"key","input");y(this,"context");y(this,"ports");y(this,"handlePickupStateSync",t=>{var n;const i=t,s=this.ports.getCurrentMapArea();!this.ports.sys.isActive()||!s||(n=i.detail)!=null&&n.areaId&&i.detail.areaId!==s.id||(this.ports.setCurrentMapArea(this.context.getState().world.currentMapArea),this.ports.renderStaticProps())});y(this,"handlePathPreview",t=>{if(!this.ports.sys.isActive())return;const s=t.detail;if(!s){this.clearPathPreview();return}const n=this.ports.getCurrentMapArea();if(!n||s.areaId!==n.id){this.clearPathPreview();return}if(this.ports.pathGraphics.clear(),!s.path||s.path.length===0)return;const{tileWidth:a,tileHeight:r}=this.ports.getIsoMetrics(),o=s.path.length,l=s.path.map(g=>this.ports.calculatePixelPosition(g.x,g.y));let c=3462041;o>9?c=16281969:o>6?c=16486972:o>3&&(c=16498468),l.length>1&&(this.ports.pathGraphics.lineStyle(5.2,2282478,.14),this.ports.pathGraphics.beginPath(),this.ports.pathGraphics.moveTo(l[0].x,l[0].y),l.slice(1).forEach(g=>{this.ports.pathGraphics.lineTo(g.x,g.y)}),this.ports.pathGraphics.strokePath(),this.ports.pathGraphics.lineStyle(2.2,c,.88),this.ports.pathGraphics.beginPath(),this.ports.pathGraphics.moveTo(l[0].x,l[0].y),l.slice(1).forEach(g=>{this.ports.pathGraphics.lineTo(g.x,g.y)}),this.ports.pathGraphics.strokePath()),l.forEach((g,m)=>{const p=m===l.length-1;this.ports.pathGraphics.fillStyle(p?16762967:c,p?.95:.72),this.ports.pathGraphics.fillCircle(g.x,g.y,p?r*.14:r*.08)});const d=l[l.length-1],u=this.ports.getDiamondPoints(d.x,d.y,a*.72,r*.72);this.ports.pathGraphics.lineStyle(1.6,16769690,.94),this.ports.pathGraphics.strokePoints(u,!0),this.ports.pathGraphics.lineStyle(.9,3718648,.74),this.ports.pathGraphics.strokeCircle(d.x,d.y,r*.28);const h=s.path[s.path.length-1];this.renderCoverPreview(h)});this.ports=i??$u(t)}init(t){this.context=t}onCreate(){this.context.listenWindow(zi,this.handlePathPreview),this.context.listenWindow(_u,this.handlePickupStateSync),this.context.listenInput("pointerdown",this.handlePointerDown,this)}handlePointerDown(t){const i=this.ports.getCurrentMapArea();if(!i||!this.ports.sys.isActive()||!t.leftButtonDown())return;const s=this.ports.cameras.main.getWorldPoint(t.x,t.y),n=this.ports.worldToGrid(s.x,s.y);if(!n)return;const{x:a,y:r}=n;if(a<0||r<0||a>=i.width||r>=i.height)return;const o=i.tiles[r][a];!o.isWalkable&&o.type!==D.DOOR||window.dispatchEvent(new CustomEvent(Iu,{detail:{position:n,areaId:i.id}}))}clearPathPreview(){var t;(t=this.ports.pathGraphics)==null||t.clear(),this.renderCoverPreview()}renderCoverPreview(t){var M;const i=this.ports.getCoverDebugGraphics();if(!i)return;i.clear();const s=this.ports.getCurrentMapArea();if(!t||!s){i.setVisible(!1);return}const n=this.ports.getLastPlayerGridPosition()??this.ports.getPlayerInitialPosition();if(!n){i.setVisible(!1);return}const a=(M=s.tiles[t.y])==null?void 0:M[t.x];if(!(a!=null&&a.cover)){i.setVisible(!1);return}const r=ri(t,n),o=a.cover[r];if(!o||o==="none"){i.setVisible(!1);return}const{tileWidth:l,tileHeight:c}=this.ports.getIsoMetrics(),d=this.ports.calculatePixelPosition(t.x,t.y),u=this.ports.getDiamondPoints(d.x,d.y,l*.7,c*.7),[h,g,m,p]=u,v=o==="full"?3718648:16498468,S=o==="full"?.35:.25;switch(i.fillStyle(v,S),r){case"north":i.fillTriangle(h.x,h.y,g.x,g.y,p.x,p.y);break;case"south":i.fillTriangle(m.x,m.y,g.x,g.y,p.x,p.y);break;case"east":i.fillTriangle(g.x,g.y,h.x,h.y,m.x,m.y);break;case"west":i.fillTriangle(p.x,p.y,m.x,m.y,h.x,h.y);break}i.fillCircle(d.x,d.y,c*.08),i.setVisible(!0)}}const we=(e,t,i)=>i<t?t:Math.min(Math.max(e,t),i),dt=(e,t=4)=>{const i=10**t;return Math.round(e*i)/i},vn=2,Zu=(e,t,i,s,n)=>{const a=e.map(o=>`${o.id}:${o.position.x}:${o.position.y}:${o.health}`).join("|"),r=t.map(o=>`${o.id}:${o.position.x}:${o.position.y}`).join("|");return`${i??"player"}:${s}:${n}::${a}::${r}`},Xu=e=>e.map(t=>`${t.id}:${t.x}:${t.y}:${t.status}`).join("|"),Qu=()=>typeof window>"u"?1:window.devicePixelRatio||1,Ju=(e,t,i)=>{const s=t/Math.max(1,e.width),n=i/Math.max(1,e.height),a=Math.min(s,n),r=Math.max(.6,Math.min(4,a||vn));return Number.isFinite(r)&&r>0?r:vn},eh=(e,t)=>{const i=Math.max(1,t.width),s=Math.max(1,t.height),n=Math.max(1e-4,e.width),a=Math.max(1e-4,e.height),r=e.x+n/2,o=e.y+a/2,l=.001,c=Math.max(l,n),d=Math.max(l,a),u=Math.min(i,c),h=Math.min(s,d),g=u/2,m=h/2,p=g,v=Math.max(g,i-g),S=m,M=Math.max(m,s-m),x=we(r,p,v),b=we(o,S,M),A=dt(u),I=dt(h),w=we(x,A/2,Math.max(A/2,i-A/2)),C=we(b,I/2,Math.max(I/2,s-I/2)),R=we(dt(w-A/2),0,Math.max(0,i-A)),k=we(dt(C-I/2),0,Math.max(0,s-I));return{x:R,y:k,width:A,height:I,zoom:e.zoom}};class th{constructor(t){y(this,"scene",null);y(this,"viewport",null);y(this,"tileSignature",null);y(this,"config");y(this,"lastRenderState",null);this.config={maxCanvasWidth:(t==null?void 0:t.maxCanvasWidth)??180,maxCanvasHeight:(t==null?void 0:t.maxCanvasHeight)??160,minZoom:(t==null?void 0:t.minZoom)??.6,maxZoom:(t==null?void 0:t.maxZoom)??3}}bindScene(t){this.scene=t}setViewport(t){this.viewport=t}setCanvasBounds(t,i){const s=Number.isFinite(t)?Math.floor(t):0,n=Number.isFinite(i)?Math.floor(i):0;if(s<=0||n<=0)return!1;const a=we(s,120,4096),r=we(n,80,4096);return a===this.config.maxCanvasWidth&&r===this.config.maxCanvasHeight?!1:(this.config={...this.config,maxCanvasWidth:a,maxCanvasHeight:r},!0)}compose(t,i,s){var k,f;const n=t.world.currentMapArea;if(!n)return null;const a=Ju(n,this.config.maxCanvasWidth,this.config.maxCanvasHeight),r=dt(a*we(i,this.config.minZoom,this.config.maxZoom)),o=Math.ceil(n.width*r),l=Math.ceil(n.height*r),c=Qu(),d=t.player.data,u=t.world.currentMapArea.entities.enemies,h=t.world.currentMapArea.entities.npcs,g=t.world.currentMapArea.entities.items,m=t.surveillance.zones[n.id],p=Zu(u,h,d.id,d.position.x,d.position.y),v=m?this.buildCameras(m.cameras):[],S=this.createCameraSignature(v),M=n.tiles;let x=((k=this.tileSignature)==null?void 0:k.version)??0;(!this.tileSignature||this.tileSignature.areaId!==n.id||this.tileSignature.ref!==M)&&(x+=1,this.tileSignature={areaId:n.id,ref:M,version:x});const b=this.viewport??{x:0,y:0,width:Math.min(n.width,Math.ceil(n.width*.4)),height:Math.min(n.height,Math.ceil(n.height*.4)),zoom:this.scene?this.scene.cameras.main.zoom:1},A=eh(b,n);this.viewport=A;const I=this.buildObjectives(g),w=Xu(I),C=s&&s.length?s.map(E=>`${E.x}:${E.y}`).join("|"):"",R={version:(((f=this.lastRenderState)==null?void 0:f.version)??0)+1,areaId:n.id,areaName:n.name,mapWidth:n.width,mapHeight:n.height,logicalWidth:o,logicalHeight:l,tileScale:r,devicePixelRatio:c,baseTileScale:a,userZoom:r/a,tileVersion:x,tiles:M,entities:this.buildEntities(d.id??"player",d.position.x,d.position.y,u,h),entitiesSignature:p,cameras:v,camerasSignature:S,viewport:A,curfewActive:t.world.curfewActive,timestamp:Date.now(),path:s??void 0,pathSignature:C,objectiveMarkers:I,objectivesSignature:w,dirtyLayers:this.resolveDirtyLayers({tileVersion:x,entitySignature:p,cameraSignature:S,objectivesSignature:w,pathSignature:C,viewport:A,curfewActive:t.world.curfewActive,tileScale:r,areaId:n.id})};return this.lastRenderState=R,R}buildEntities(t,i,s,n,a){const r=[{id:t,kind:"player",x:i,y:s,status:"active"}];return n.forEach(o=>{r.push({id:o.id,kind:"enemy",x:o.position.x,y:o.position.y,status:o.health>0?"active":"inactive"})}),a.forEach(o=>{r.push({id:o.id,kind:"npc",x:o.position.x,y:o.position.y,status:"active"})}),r}buildCameras(t){return Object.values(t).map(i=>({id:i.id,type:i.type,x:i.position.x,y:i.position.y,alertState:i.alertState,isActive:i.isActive}))}createCameraSignature(t){return t.length?t.map(i=>`${i.id}:${i.type}:${i.x}:${i.y}:${i.alertState}:${i.isActive?1:0}`).join("|"):""}buildObjectives(t){return t.filter(i=>!!i.position).map(i=>({id:i.id,label:i.name,x:i.position.x,y:i.position.y,status:"active"}))}resolveDirtyLayers(t){const i=this.lastRenderState;if(!i)return{tiles:!0,overlays:!0,entities:!0,viewport:!0,path:!!t.pathSignature};const s=i.areaId!==t.areaId,n=i.tileScale!==t.tileScale,a=s||i.tileVersion!==t.tileVersion||n,r=s||i.camerasSignature!==t.cameraSignature||n,o=s||i.entitiesSignature!==t.entitySignature||n||r,l=s||i.objectivesSignature!==t.objectivesSignature||n,c=s||i.viewport.x!==t.viewport.x||i.viewport.y!==t.viewport.y||i.viewport.width!==t.viewport.width||i.viewport.height!==t.viewport.height||i.viewport.zoom!==t.viewport.zoom||i.tileScale!==t.tileScale,d=i.pathSignature!==t.pathSignature||n,u=s||i.curfewActive!==t.curfewActive||l||c;return{tiles:a,overlays:u,entities:o||l,viewport:c,path:d}}}const ih=typeof window<"u"?window.requestAnimationFrame.bind(window):void 0,bn=typeof window<"u"?window.cancelAnimationFrame.bind(window):void 0,sh=(e,t,i)=>i<t?t:Math.min(Math.max(e,t),i);class nh extends EventTarget{constructor(){super(...arguments);y(this,"scene",null);y(this,"storeUnsubscribe",null);y(this,"pendingFrame",null);y(this,"pendingStoreUpdate",!1);y(this,"pendingViewportUpdate",!1);y(this,"controller",new th);y(this,"lastState",null);y(this,"userZoom",1);y(this,"minZoom",.6);y(this,"maxZoom",3);y(this,"lastPath",null);y(this,"raf",ih);y(this,"handlePathPreview",i=>{const s=i.detail,a=F.getState().world.currentMapArea;if(!a||s.areaId!==a.id)return;const r=s.path??[];this.lastPath=r.length?r:null,this.pendingStoreUpdate=!0,this.scheduleBroadcast()})}initialize(i){this.scene!==i&&(this.shutdown(),this.scene=i,this.controller.bindScene(i),this.storeUnsubscribe=F.subscribe(()=>{this.pendingStoreUpdate=!0,this.scheduleBroadcast()}),typeof window<"u"&&window.addEventListener(zi,this.handlePathPreview),this.pendingStoreUpdate=!0,this.scheduleBroadcast(!0))}shutdown(){this.storeUnsubscribe&&(this.storeUnsubscribe(),this.storeUnsubscribe=null),this.pendingFrame!==null&&this.raf&&bn&&bn(this.pendingFrame),this.pendingFrame=null,this.controller.bindScene(null),this.scene=null,typeof window<"u"&&window.removeEventListener(zi,this.handlePathPreview)}getState(){return this.lastState}updateViewport(i){this.controller.setViewport({x:i.x,y:i.y,width:i.width,height:i.height,zoom:i.zoom}),this.pendingViewportUpdate=!0,this.scheduleBroadcast()}emitInteraction(i){if(this.scene)switch(i.type){case Cu:{const s=i.animate??!0;this.scene.focusCameraOnGridPosition(i.gridX,i.gridY,s);break}case Ru:{const s=i.animate??!0;this.scene.focusCameraOnGridPosition(i.target.x,i.target.y,s);break}}}setZoom(i){const s=sh(i,this.minZoom,this.maxZoom);Math.abs(s-this.userZoom)<1e-4||(this.userZoom=s,this.pendingStoreUpdate=!0,this.dispatchEvent(new CustomEvent(Tu,{detail:{zoom:this.userZoom}})),this.scheduleBroadcast())}adjustZoom(i){this.setZoom(this.userZoom+i)}getZoom(){return this.userZoom}centerOnPlayer(i=!0){if(!this.scene)return;const n=F.getState().player.data.position;this.scene.focusCameraOnGridPosition(n.x,n.y,i)}setCanvasBounds(i,s){this.controller.setCanvasBounds(i,s)&&(this.pendingStoreUpdate=!0,this.scheduleBroadcast())}requestImmediateState(){this.pendingStoreUpdate=!0,this.scheduleBroadcast(!0)}scheduleBroadcast(i=!1){if(i||!this.raf){this.broadcast();return}this.pendingFrame===null&&(this.pendingFrame=this.raf(()=>{this.pendingFrame=null,this.broadcast()}))}composeState(){return this.controller.compose(F.getState(),this.userZoom,this.lastPath)}broadcast(){if(!this.pendingStoreUpdate&&!this.pendingViewportUpdate)return;const i=this.composeState();if(this.pendingStoreUpdate=!1,this.pendingViewportUpdate=!1,!i)return;const s=this.shouldEmit(i);this.lastState=i,s&&this.dispatchEvent(new CustomEvent(ku,{detail:i}))}shouldEmit(i){if(!this.lastState)return!0;const s=this.lastState;if(i.areaId!==s.areaId)return!0;const n=i.dirtyLayers;return n.tiles||n.entities||n.overlays||n.viewport||n.path}}const Pi=new nh,gs=(e,t)=>Reflect.get(e,t),wn=(e,t)=>{const i=gs(e,t);if(i==null)throw new Error(`[MinimapBridgeModule] Missing required scene value: ${t}`);return i},ah=(e,t,...i)=>{const s=gs(e,t);if(typeof s!="function")throw new Error(`[MinimapBridgeModule] Missing required scene method: ${t}`);return s.apply(e,i)},rh=e=>({cameras:wn(e,"cameras"),sys:wn(e,"sys"),getCurrentMapArea:()=>gs(e,"currentMapArea")??null,worldToGridContinuous:(t,i)=>ah(e,"worldToGridContinuous",t,i)});class oh{constructor(t,i){y(this,"key","minimapBridge");y(this,"ports");this.scene=t,this.ports=i??rh(t)}init(t){}onCreate(){Pi.initialize(this.scene)}onShutdown(){Pi.shutdown()}emitViewportUpdate(){if(!this.ports.getCurrentMapArea()||!this.ports.sys.isActive())return;const i=this.ports.cameras.main,s=i.worldView,n=this.ports.worldToGridContinuous(s.x,s.y),a=this.ports.worldToGridContinuous(s.x+s.width,s.y),r=this.ports.worldToGridContinuous(s.x,s.y+s.height),o=this.ports.worldToGridContinuous(s.x+s.width,s.y+s.height);if(!n||!a||!r||!o)return;const l=(n.x+a.x+r.x+o.x)/4,c=(n.y+a.y+r.y+o.y)/4,d=[Math.abs(a.x-n.x),Math.abs(o.x-r.x)].filter(S=>Number.isFinite(S)),u=[Math.abs(r.y-n.y),Math.abs(o.y-a.y)].filter(S=>Number.isFinite(S)),h=d.length?d.reduce((S,M)=>S+M,0)/d.length:0,g=u.length?u.reduce((S,M)=>S+M,0)/u.length:0,m=Math.max(1e-4,h),p=Math.max(1e-4,g),v={x:l-m/2,y:c-p/2,width:m,height:p};Pi.updateViewport({...v,zoom:i.zoom})}}const fe=(e,t)=>Reflect.get(e,t),lh=(e,t)=>{const i=fe(e,t);if(i==null)throw new Error(`[StateSyncModule] Missing required scene value: ${t}`);return i},V=(e,t,...i)=>{const s=fe(e,t);if(typeof s!="function")throw new Error(`[StateSyncModule] Missing required scene method: ${t}`);return s.apply(e,i)},ch=e=>({sys:lh(e,"sys"),getCurrentMapArea:()=>fe(e,"currentMapArea")??null,setCurrentMapArea:t=>{Reflect.set(e,"currentMapArea",t)},getItemMarkerSignature:t=>V(e,"getItemMarkerSignature",t),renderStaticProps:()=>{V(e,"renderStaticProps")},updateDayNightOverlay:()=>{V(e,"updateDayNightOverlay")},updatePlayerPosition:t=>{V(e,"updatePlayerPosition",t)},updatePlayerVitalsIndicator:(t,i,s)=>{V(e,"updatePlayerVitalsIndicator",t,i,s)},updateEnemies:t=>{V(e,"updateEnemies",t)},updateNpcs:t=>{V(e,"updateNpcs",t)},renderVisionCones:()=>{V(e,"renderVisionCones")},updateSurveillanceCameras:(t,i)=>{V(e,"updateSurveillanceCameras",t,i)},zoomCameraForCombat:()=>{V(e,"zoomCameraForCombat")},restoreCameraAfterCombat:()=>{V(e,"restoreCameraAfterCombat")},destroyPlayerVitalsIndicator:()=>{V(e,"destroyPlayerVitalsIndicator")},destroyCameraSprites:()=>{V(e,"destroyCameraSprites")},setupCameraAndMap:()=>{V(e,"setupCameraAndMap")},clearPathPreview:()=>{V(e,"clearPathPreview")},enablePlayerCameraFollow:()=>{V(e,"enablePlayerCameraFollow")},resetCameraRuntimeStateForMapTransition:()=>{var i;const t=fe(e,"cameraModule");(i=t==null?void 0:t.resetForMapTransition)==null||i.call(t)},clearEntityRuntimeStateForMapTransition:()=>{var i;const t=fe(e,"entityRenderModule");(i=t==null?void 0:t.clearForMapTransition)==null||i.call(t)},clearWorldRuntimeStateForMapTransition:()=>{var i;const t=fe(e,"worldRenderModule");(i=t==null?void 0:t.clearForMapTransition)==null||i.call(t)},resetEntityCombatIndicators:()=>{var i;const t=fe(e,"entityRenderModule");(i=t==null?void 0:t.resetCombatIndicators)==null||i.call(t)},readRuntimeState:()=>{const t=fe(e,"currentMapArea");return{curfewActive:!!fe(e,"curfewActive"),inCombat:!!fe(e,"inCombat"),lastMapAreaId:(t==null?void 0:t.id)??null,isMapTransitionPending:!1}},writeRuntimeState:t=>{Reflect.set(e,"curfewActive",t.curfewActive),Reflect.set(e,"inCombat",t.inCombat)}}),dh=()=>({curfewActive:!1,inCombat:!1,lastMapAreaId:null,isMapTransitionPending:!1});class uh{constructor(t,i){y(this,"key","stateSync");y(this,"ports");y(this,"runtimeState");var s,n;this.ports=i??ch(t),this.runtimeState={...dh(),...(n=(s=this.ports).readRuntimeState)==null?void 0:n.call(s)},this.pushRuntimeStateToPorts()}init(){}isInCombat(){return this.runtimeState.inCombat}isCurfewActive(){return this.runtimeState.curfewActive}onStateChange(t,i){var p,v,S,M,x,b,A,I,w,C,R,k;const s=this.ports.getCurrentMapArea();if(!this.ports.sys.isActive()||!s)return;const n=i.player.data,a=i.world,r=a.currentMapArea.entities.enemies,o=this.runtimeState.inCombat;if(this.runtimeState.inCombat=a.inCombat,this.runtimeState.inCombat&&!o&&this.ports.zoomCameraForCombat(),!this.runtimeState.inCombat&&o&&(this.ports.restoreCameraAfterCombat(),this.ports.destroyPlayerVitalsIndicator(),(v=(p=this.ports).resetEntityCombatIndicators)==null||v.call(p)),this.ports.updateDayNightOverlay(),!a.currentMapArea||!s){this.pushRuntimeStateToPorts();return}const l=a.currentMapArea,c=this.runtimeState.lastMapAreaId??s.id,d=l.id;this.runtimeState.isMapTransitionPending=c!==d,this.runtimeState.isMapTransitionPending&&((M=(S=this.ports).resetCameraRuntimeStateForMapTransition)==null||M.call(S),(b=(x=this.ports).clearEntityRuntimeStateForMapTransition)==null||b.call(x),(I=(A=this.ports).clearWorldRuntimeStateForMapTransition)==null||I.call(A),this.ports.destroyCameraSprites(),this.ports.setCurrentMapArea(l),this.ports.setupCameraAndMap(),this.ports.clearPathPreview(),this.ports.enablePlayerCameraFollow(),this.runtimeState.lastMapAreaId=d,this.runtimeState.isMapTransitionPending=!1);const u=this.ports.getItemMarkerSignature(s);this.ports.setCurrentMapArea(l);const h=this.ports.getItemMarkerSignature(l);u!==h&&this.ports.renderStaticProps(),this.runtimeState.curfewActive=a.curfewActive,this.ports.updatePlayerPosition(n.position),this.ports.updatePlayerVitalsIndicator(n.position,n.health,n.maxHealth),this.ports.updateEnemies(r),this.ports.updateNpcs(l.entities.npcs),this.ports.renderVisionCones();const g=(C=(w=i.surveillance)==null?void 0:w.zones)==null?void 0:C[l.id],m=((k=(R=i.surveillance)==null?void 0:R.hud)==null?void 0:k.overlayEnabled)??!1;this.ports.updateSurveillanceCameras(g,m),this.runtimeState.lastMapAreaId=d,this.pushRuntimeStateToPorts()}pushRuntimeStateToPorts(){var t,i;(i=(t=this.ports).writeRuntimeState)==null||i.call(t,this.runtimeState)}}const qe={suspicionThreshold:30,investigationThreshold:60,alarmThreshold:100,progressGainPerTick:10,progressDecayPerTick:5,reinforcementDelay:2e3},Ha=(e,t,i)=>{const s=t.x-e.x,n=t.y-e.y;if(Math.sqrt(s*s+n*n)>i.range)return!1;const o=(Math.atan2(n,s)*(180/Math.PI)+360)%360,l=(i.direction+360)%360;let c=Math.abs(o-l);return c>180&&(c=360-c),c<=i.angle/2},Wa=(e,t,i)=>{const s=hh(e,t);for(const n of s){if(n.x===e.x&&n.y===e.y||n.x===t.x&&n.y===t.y)continue;if(n.x<0||n.y<0||n.y>=i.height||n.x>=i.width)return!1;const a=i.tiles[n.y][n.x];if(!a.isWalkable&&a.type!=="cover")return!1}return!0},hh=(e,t)=>{const i=[];let s=Math.floor(e.x),n=Math.floor(e.y);const a=Math.floor(t.x),r=Math.floor(t.y),o=Math.abs(a-s),l=Math.abs(r-n),c=s<a?1:-1,d=n<r?1:-1;let u=o-l;for(;i.push({x:s,y:n}),!(s===a&&n===r);){const h=2*u;h>-l&&(u-=l,s+=c),h<o&&(u+=o,n+=d)}return i},Ga=(e,t,i)=>!e.visionCone||!Ha(e.position,t.position,e.visionCone)?!1:Wa(e.position,t.position,i),ph=(e,t,i=1)=>{const s=e.alertProgress??0;let n=s;if(t){const o=qe.progressGainPerTick*Math.max(0,i);n=Math.min(100,s+o)}else n=Math.max(0,s-qe.progressDecayPerTick);let a=O.IDLE;n>=qe.alarmThreshold?a=O.ALARMED:n>=qe.investigationThreshold?a=O.INVESTIGATING:n>=qe.suspicionThreshold&&(a=O.SUSPICIOUS);const r=t?void 0:e.lastKnownPlayerPosition;return{...e,alertProgress:n,alertLevel:a,lastKnownPlayerPosition:r}},mh=(e,t)=>{if(!e.visionCone)return e;const i=t.x-e.position.x,s=t.y-e.position.y,a=(Math.atan2(s,i)*(180/Math.PI)+360)%360;return{...e,visionCone:{...e.visionCone,direction:a}}},gh=(e,t,i)=>{const s=[],{range:n}=t;for(let a=-n;a<=n;a++)for(let r=-n;r<=n;r++){const o={x:e.x+r,y:e.y+a};o.x<0||o.y<0||o.y>=i.height||o.x>=i.width||Ha(e,o,t)&&Wa(e,o,i)&&s.push(o)}return s},Pn=P.Math.DEG_TO_RAD,it={[$.IDLE]:{fill:3900150,alpha:.15},[$.SUSPICIOUS]:{fill:16436245,alpha:.22},[$.INVESTIGATING]:{fill:16347926,alpha:.26},[$.ALARMED]:{fill:15680580,alpha:.3},[$.DISABLED]:{fill:6583435,alpha:.12}};class fh extends P.GameObjects.Container{constructor(i,s,n,a){super(i,s,n);y(this,"housing");y(this,"lens");y(this,"led");y(this,"cone");y(this,"ledTween",null);y(this,"rangePixels");y(this,"fieldOfView");y(this,"direction");y(this,"tileSize");y(this,"isActiveSprite",!1);y(this,"alertState",$.DISABLED);y(this,"overlayVisible",!1);const{tileSize:r,rangeTiles:o,fieldOfView:l,initialDirection:c}=a;this.tileSize=r,this.fieldOfView=l,this.direction=c,this.rangePixels=o*r,this.housing=i.add.rectangle(0,0,r*.5,r*.35,3355443,1),this.housing.setOrigin(.5,.5),this.lens=i.add.ellipse(r*.15,0,r*.22,r*.16,0,1),this.lens.setStrokeStyle(1,2042167,.6),this.led=i.add.circle(-r*.18,-r*.08,r*.12,16711680,1),this.led.setAlpha(0),this.cone=i.add.graphics(),this.cone.setAlpha(0),this.cone.setDepth(-1),this.add([this.cone,this.housing,this.lens,this.led]),this.setSize(r,r),this.scene.add.existing(this),this.drawVisionCone(),this.setAlertState($.DISABLED)}setActiveState(i){this.isActiveSprite!==i&&(this.isActiveSprite=i,i?this.ledTween?this.ledTween.resume():this.ledTween=this.scene.tweens.add({targets:this.led,alpha:{from:1,to:.3},duration:1e3,ease:"Sine.easeInOut",yoyo:!0,repeat:-1}):(this.ledTween&&this.ledTween.pause(),this.led.setAlpha(0)),this.refreshConeAlpha())}setAlertState(i){this.alertState=i;const{fill:s}=it[i];if(this.drawVisionCone(s),this.isActiveSprite&&i!==$.DISABLED){const n=i===$.ALARMED?16731471:i===$.INVESTIGATING?16347926:i===$.SUSPICIOUS?16436245:2282478;this.led.setFillStyle(n,1)}else i===$.DISABLED&&this.led.setFillStyle(6583435,.8);this.refreshConeAlpha()}setDirection(i){this.direction=i,this.drawVisionCone(),this.refreshConeAlpha()}setRangeTiles(i){this.rangePixels=i*this.tileSize,this.drawVisionCone(),this.refreshConeAlpha()}updateVision(i){this.cone.setPosition(i.x-this.x,i.y-this.y)}setOverlayVisible(i){this.overlayVisible!==i&&(this.overlayVisible=i,this.refreshConeAlpha())}destroy(i){this.ledTween&&(this.ledTween.stop(),this.ledTween.remove(),this.ledTween=null),super.destroy(i)}drawVisionCone(i){const s=i??it[this.alertState].fill;this.cone.clear();const n=(this.direction-this.fieldOfView/2)*Pn,a=(this.direction+this.fieldOfView/2)*Pn;this.cone.fillStyle(s,it[this.alertState].alpha),this.cone.slice(0,0,this.rangePixels,n,a,!1),this.cone.fillPath(),this.cone.lineStyle(1.2,s,Math.min(.65,it[this.alertState].alpha+.1)),this.cone.beginPath(),this.cone.moveTo(0,0),this.cone.arc(0,0,this.rangePixels,n,a,!1),this.cone.closePath(),this.cone.strokePath()}refreshConeAlpha(){const s=this.isActiveSprite&&this.overlayVisible&&this.alertState!==$.DISABLED?it[this.alertState].alpha:0;this.cone.setAlpha(s)}}const Kt=(e,t)=>Reflect.get(e,t),Mi=(e,t,...i)=>{const s=Kt(e,t);if(typeof s!="function")throw new Error(`[SurveillanceRenderModule] Missing required scene method: ${t}`);return s.apply(e,i)},yh=e=>({getCurrentMapArea:()=>Kt(e,"currentMapArea")??null,getVisionConeGraphics:()=>Kt(e,"visionConeGraphics"),getTileSize:()=>{const t=Kt(e,"tileSize");return typeof t=="number"?t:0},getIsoMetrics:()=>Mi(e,"getIsoMetrics"),calculatePixelPosition:(t,i)=>Mi(e,"calculatePixelPosition",t,i),syncDepth:(t,i,s,n)=>{Mi(e,"syncDepth",t,i,s,n)}});class Sh{constructor(t,i){y(this,"key","surveillanceRender");y(this,"cameraSprites",new Map);y(this,"ports");this.scene=t,this.ports=i??yh(t)}init(t){}onShutdown(){this.clearCameraSprites()}clearCameraSprites(){this.cameraSprites.forEach(t=>{t.destroy(!0)}),this.cameraSprites.clear()}renderVisionCones(){const t=this.ports.getCurrentMapArea(),i=this.ports.getVisionConeGraphics();if(!t||!i)return;i.clear();const s=t.entities.enemies,n=this.ports.getIsoMetrics();s.forEach(a=>{if(!a.visionCone||a.health<=0)return;const r=gh(a.position,a.visionCone,t);if(r.length===0)return;let o=16776960,l=.1;switch(a.alertLevel){case O.SUSPICIOUS:o=16755200,l=.15;break;case O.INVESTIGATING:o=16737792,l=.2;break;case O.ALARMED:o=16711680,l=.25;break;default:o=16776960,l=.1}i.fillStyle(o,l),r.forEach(c=>{const d=this.ports.calculatePixelPosition(c.x,c.y),u=[d.x,d.y-n.tileHeight/2,d.x+n.tileWidth/2,d.y,d.x,d.y+n.tileHeight/2,d.x-n.tileWidth/2,d.y];i.fillPoints(u,!0)})})}updateSurveillanceCameras(t,i=!1){const s=this.ports.getCurrentMapArea();if(!t||!s){this.cameraSprites.size>0&&this.clearCameraSprites();return}const n=new Set(this.cameraSprites.keys()),a=this.ports.getIsoMetrics();Object.values(t.cameras).forEach(r=>{n.delete(r.id);const o=this.ports.calculatePixelPosition(r.position.x,r.position.y);let l=this.cameraSprites.get(r.id);l?(l.setPosition(o.x,o.y),l.setRangeTiles(r.range)):(l=new fh(this.scene,o.x,o.y,{tileSize:this.ports.getTileSize(),rangeTiles:r.range,fieldOfView:r.fieldOfView,initialDirection:r.currentDirection}),this.cameraSprites.set(r.id,l));const c=H.PROP_TALL+Math.round(a.tileHeight*.5);this.ports.syncDepth(l,o.x,o.y,c),l.setOverlayVisible(i),l.setActiveState(r.isActive),l.setAlertState(r.alertState),l.setDirection(r.currentDirection)}),n.forEach(r=>{const o=this.cameraSprites.get(r);o&&o.destroy(!0),this.cameraSprites.delete(r)})}}class vh{constructor(t,i){y(this,"wetReflectionAlpha");y(this,"emissiveIntensity");this.graphics=t,this.theme=i,this.wetReflectionAlpha=i.qualityBudget.wetReflectionAlpha,this.emissiveIntensity=.35}setAtmosphereProfile(t){this.wetReflectionAlpha=P.Math.Clamp(t.wetReflectionAlpha,0,.4),this.emissiveIntensity=P.Math.Clamp(t.emissiveIntensity,0,1)}drawTile(t,i){const s=i.groundOnly?{...t,type:D.FLOOR}:t,n=this.getTileBaseColor(s,i.gridX,i.gridY),a=((i.gridX*13^i.gridY*9)%9-4)*.01,r=T(n,a);if(this.drawGround(s,i,r),!i.groundOnly)switch(t.type){case D.COVER:this.drawCover(t,i,r);break;case D.WALL:this.drawWallVolume(t,i,r);break;case D.DOOR:this.drawDoorPortal(t,i,r);break;case D.WATER:case D.TRAP:this.drawHazardVariant(t,i,r);break}}drawGround(t,i,s){const n=this.getPoints(i.center.x,i.center.y,i.tileWidth,i.tileHeight),r=((Math.floor(i.gridX/4)^Math.floor(i.gridY/4))%5-2)*.03,o=T(s,r),l=T(o,.2),c=T(o,-.22);this.graphics.fillStyle(o,1),this.graphics.fillPoints(n,!0);const[d,u,h,g]=n,m=new P.Geom.Point(i.center.x,i.center.y);this.graphics.fillStyle(l,.35),this.graphics.fillPoints([d,u,m],!0),this.graphics.fillPoints([d,m,g],!0),this.graphics.fillStyle(c,.3),this.graphics.fillPoints([h,u,m],!0),this.graphics.fillPoints([h,m,g],!0),this.graphics.lineStyle(1,T(o,-.3),.42),this.graphics.strokePoints(n,!0),t.type===D.FLOOR?this.drawSurfaceTreatments(t,i,n,o):(t.type===D.COVER||t.type===D.WALL)&&(this.graphics.lineStyle(.9,16317180,.08),this.graphics.strokePoints(n,!0))}drawCover(t,i,s){const n=this.getElevationProfile(.5,i.tileWidth,i.tileHeight),a=this.getPoints(i.center.x,i.center.y,i.tileWidth,i.tileHeight),r=this.getPoints(i.center.x,i.center.y-n.heightOffset,n.topWidth,n.topHeight),o=[a[1],a[2],r[2],r[1]],l=[a[2],a[3],r[3],r[2]];this.graphics.fillStyle(T(s,-.15),.98),this.graphics.fillPoints(l,!0),this.graphics.fillStyle(T(s,-.08),.98),this.graphics.fillPoints(o,!0),this.graphics.fillStyle(T(s,.2),.95),this.graphics.fillPoints(r,!0),this.graphics.lineStyle(1.1,16498468,.3),this.graphics.strokePoints(r,!0)}drawWallVolume(t,i,s){const n=this.getElevationProfile(1.2,i.tileWidth,i.tileHeight),a=this.getPoints(i.center.x,i.center.y,i.tileWidth,i.tileHeight),r=this.getPoints(i.center.x,i.center.y-n.heightOffset,n.topWidth,n.topHeight),o=[a[1],a[2],r[2],r[1]],l=[a[2],a[3],r[3],r[2]];this.graphics.fillStyle(T(s,-.28),1),this.graphics.fillPoints(l,!0),this.graphics.fillStyle(T(s,-.16),1),this.graphics.fillPoints(o,!0);const c=T(s,.18);this.graphics.fillStyle(c,1),this.graphics.fillPoints(r,!0),this.graphics.lineStyle(1.2,2282478,.18),this.graphics.strokePoints(r,!0);const[d,u,h,g]=a,[m,p,v,S]=r;this.graphics.lineStyle(1,8246268,.2),this.graphics.strokePoints([g,S],!1),this.graphics.strokePoints([h,v],!1),this.graphics.strokePoints([u,p],!1),this.graphics.strokePoints([d,m],!1)}drawDoorPortal(t,i,s){const n=this.getPoints(i.center.x,i.center.y,i.tileWidth,i.tileHeight),[a,r,o,l]=n,c=this.lerpPoint(a,l,.22),d=this.lerpPoint(a,r,.22),u=this.lerpPoint(o,r,.3),h=this.lerpPoint(o,l,.3);this.graphics.fillStyle(T(s,-.2),.96),this.graphics.fillPoints([c,d,u,h],!0);const g=this.lerpPoint(c,h,.12),m=this.lerpPoint(d,u,.12),p=this.lerpPoint(d,u,.86),v=this.lerpPoint(c,h,.86);this.graphics.fillStyle(988970,.84),this.graphics.fillPoints([g,m,p,v],!0),this.graphics.lineStyle(1.3,3718648,.4),this.graphics.strokePoints([g,m],!1)}drawHazardVariant(t,i,s){const n=this.getPoints(i.center.x,i.center.y,i.tileWidth*.72,i.tileHeight*.72);if(t.type===D.WATER){const r=this.theme.qualityBudget.enableAnimatedHazards?.22+.12*(.5+.5*Math.sin(Date.now()%2e3/2e3*Math.PI*2)):.2;this.graphics.fillStyle(T(s,.2),r),this.graphics.fillPoints(n,!0),this.graphics.lineStyle(1,6809849,.22),this.graphics.strokePoints(n,!0);return}const a=this.theme.qualityBudget.enableAnimatedHazards?.18+.1*(.5+.5*Math.sin(Date.now()%1500/1500*Math.PI*2)):.18;this.graphics.fillStyle(T(s,.35),a),this.graphics.fillPoints(n,!0),this.graphics.lineStyle(1.1,16020150,.35),this.graphics.strokePoints(n,!0)}getTileBaseColor(t,i,s){const n=(i+s)%2===0,a=this.theme.tilePalettes,r=this.theme.surfacePalettes;switch(t.type){case D.WALL:return n?a.wallEven:a.wallOdd;case D.COVER:return n?a.coverEven:a.coverOdd;case D.WATER:return n?a.waterEven:a.waterOdd;case D.TRAP:return n?a.trapEven:a.trapOdd;case D.DOOR:return n?a.doorEven:a.doorOdd;default:switch(t.surfaceKind){case"road":return n?r.roadEven:r.roadOdd;case"crosswalk":return n?r.crosswalkEven:r.crosswalkOdd;case"sidewalk":return n?r.sidewalkEven:r.sidewalkOdd;case"lot":default:return n?r.lotEven:r.lotOdd}}}getElevationProfile(t,i,s){return{heightOffset:s*(.48+t*.78),topWidth:i*Math.max(.7,1-t*.08),topHeight:s*Math.max(.62,1-t*.1)}}lerpPoint(t,i,s){return new P.Geom.Point(P.Math.Linear(t.x,i.x,s),P.Math.Linear(t.y,i.y,s))}getPoints(t,i,s,n){return ne(t,i,s,n).map(a=>new P.Geom.Point(a.x,a.y))}drawRoadReflection(t,i,s,n=1){if(!t.isWalkable||this.wetReflectionAlpha<=.01)return;const[a,r,o,l]=s,c=((i.gridX*11+i.gridY*17)%9-4)*.04,d=P.Math.Clamp(this.wetReflectionAlpha*(.7+this.emissiveIntensity*.65)*n,.03,.28),u=T(6809849,-.12+c),h=T(16486972,-.25+c*.7);this.graphics.lineStyle(1,u,d),this.graphics.strokePoints([this.lerpPoint(l,a,.3),this.lerpPoint(o,r,.3)],!1),this.graphics.lineStyle(.8,h,d*.6),this.graphics.strokePoints([this.lerpPoint(a,r,.55),this.lerpPoint(l,o,.55)],!1)}drawSurfaceTreatments(t,i,s,n){const a=t.surfaceKind??"lot",r=t.surfaceAxis,[o,l,c,d]=s,u=new P.Geom.Point(i.center.x,i.center.y);if(a==="road"||a==="crosswalk"){const h=a==="crosswalk"?16762490:16757596;if(this.graphics.lineStyle(1,h,a==="crosswalk"?.28:.18),(r==="avenue"||r==="intersection")&&this.graphics.strokePoints([o,u,c],!1),(r==="street"||r==="intersection")&&this.graphics.strokePoints([d,u,l],!1),a==="crosswalk"){this.graphics.lineStyle(1.15,16317180,.42);const m=this.lerpPoint(d,o,.42),p=this.lerpPoint(c,l,.42),v=this.lerpPoint(d,o,.62),S=this.lerpPoint(c,l,.62);this.graphics.strokePoints([m,p],!1),this.graphics.strokePoints([v,S],!1)}this.drawRoadReflection(t,i,s,a==="crosswalk"?1.1:1);return}if(a==="sidewalk"){this.graphics.lineStyle(1,T(n,.2),.24),this.graphics.strokePoints(s,!0),this.graphics.lineStyle(.9,9741240,.2),this.graphics.strokePoints([this.lerpPoint(o,l,.5),this.lerpPoint(d,c,.5)],!1),this.drawRoadReflection(t,i,s,.65);return}(i.gridX+i.gridY)%5===0&&(this.graphics.lineStyle(.8,6809849,.06),this.graphics.strokePoints(s,!0)),this.drawRoadReflection(t,i,s,.45)}}const bh="block_2_2",Mn="esb",wh="esb_iso",Ne=(e,t)=>{if(e===null)return t;const i=Number(e);return Number.isFinite(i)?i:t},Ph=()=>{const e={heightTiles:48,baseTiles:18,scale:1.1,rotateDeg:0,offsetX:0,offsetY:0};if(typeof window>"u")return e;const t=new URLSearchParams(window.location.search);return{heightTiles:Math.max(1,Ne(t.get("esbHeightTiles"),e.heightTiles)),baseTiles:Math.max(1,Ne(t.get("esbBaseTiles"),e.baseTiles)),scale:Math.max(.05,Ne(t.get("esbScale"),e.scale)),rotateDeg:Ne(t.get("esbRot"),e.rotateDeg),offsetX:Ne(t.get("esbOffX"),e.offsetX),offsetY:Ne(t.get("esbOffY"),e.offsetY)}};class Mh{constructor(t,i){this.scene=t,this.theme=i}createMassing(t,i,s){var m,p;const n=this.scene.add.container(s.center.x,s.center.y),a=this.toLocal(s.center,s.footprint);if(t.id===bh&&this.scene.textures.exists(Mn)){const v=Ph(),S=this.scene.add.image(a.bottom.x+v.offsetX,a.bottom.y+v.offsetY,Mn,wh);S.setOrigin(.5,1);const M=s.tileHeight*v.heightTiles,x=P.Math.Distance.Between(a.left.x,a.left.y,a.right.x,a.right.y),b=M/Math.max(1,S.height),A=x/Math.max(1,S.width),I=Math.max(b,A);S.setScale(I*v.scale),v.rotateDeg&&S.setRotation(P.Math.DegToRad(v.rotateDeg));const w=P.Math.Clamp(((m=s.atmosphere)==null?void 0:m.emissiveIntensity)??.35,0,1),C=P.Math.Clamp(((p=s.atmosphere)==null?void 0:p.overlayAlpha)??.2,0,1),R=P.Math.Clamp(.28+w*.58,0,1),k=P.Display.Color.Interpolate.ColorWithColor(P.Display.Color.ValueToColor(15390402),P.Display.Color.ValueToColor(12443647),1,R),f=P.Display.Color.GetColor(k.r,k.g,k.b);S.setTint(f);const E=P.Math.Clamp(.9+w*.09-C*.08,.82,1);return S.setAlpha(E),n.add(S),n}const r=this.scene.add.graphics(),o=this.scene.add.graphics(),l=this.scene.add.graphics(),c=s.widthTiles+s.depthTiles,d=i.district==="downtown"?.78:.7,u=s.tileHeight*Math.max(.58,i.massingHeight*d),h=i.district==="downtown"?.03:.015,g=this.createRoof(a,u,h);return this.drawBaseShadow(r,a),this.drawBody(o,l,i,a,g),this.drawDistrictDetails(l,i,a,g,c),n.add([r,o,l]),n}createLabel(t,i,s,n){const a=this.scene.add.container(i.x,i.y-s*.24),r=this.scene.add.text(0,0,t.name,{fontFamily:'Orbitron, "DM Sans", sans-serif',fontSize:this.theme.qualityBudget.enableHighDensityLabels?"13px":"11px",fontStyle:"700",color:n.signagePrimaryHex,stroke:n.signageSecondaryHex,strokeThickness:1.6,align:"center"});r.setOrigin(.5),r.setShadow(0,0,n.glowHex,8,!0,!0);const c=this.scene.add.rectangle(0,0,r.width+14,r.height+8,this.hexToColor(n.backdropHex),.58);return c.setStrokeStyle(1.1,this.hexToColor(n.signageSecondaryHex),.72),a.add([c,r]),a}drawBaseShadow(t,i){t.fillStyle(132622,.14),t.fillPoints([i.top,i.right,i.bottom,i.left],!0)}drawBody(t,i,s,n,a){const r=[n.right,n.bottom,a.bottom,a.right],o=[n.bottom,n.left,a.left,a.bottom],l=[n.left,n.top,a.top,a.left],c=this.hexToColor(s.backdropHex),d=T(c,-.06),u=T(c,-.13),h=T(c,-.1),g=T(c,.03);t.fillStyle(h,.72),t.fillPoints(l,!0),t.fillStyle(d,.74),t.fillPoints(r,!0),t.fillStyle(u,.78),t.fillPoints(o,!0),t.fillStyle(g,.8),t.fillPoints([a.top,a.right,a.bottom,a.left],!0),t.lineStyle(1.2,this.hexToColor(s.trimHex),.24),t.strokePoints([a.top,a.right,a.bottom,a.left],!0),i.lineStyle(1,this.hexToColor(s.trimHex),.16),i.strokePoints([n.bottom,a.bottom],!1),i.strokePoints([n.left,a.left],!1),i.strokePoints([n.right,a.right],!1)}drawDistrictDetails(t,i,s,n,a){const r=[s.right,s.bottom,n.bottom,n.right],o=[s.bottom,s.left,n.left,n.bottom];if(i.district==="downtown"){const g=Math.max(4,Math.min(10,Math.floor(a*.8))),m=Math.max(3,Math.min(8,Math.floor(i.massingHeight*1.7))),p=this.hexToColor(i.signageSecondaryHex);this.drawFaceGrid(t,o,g,m,p,.2),this.drawFaceGrid(t,r,g,m,p,.16),t.lineStyle(1,this.hexToColor(i.signagePrimaryHex),.36),t.strokePoints([n.left,n.bottom,n.right],!1);return}const l=this.hexToColor(i.accentHex);t.lineStyle(1,l,.2);const c=this.lerpPoint(o[0],o[3],.44),d=this.lerpPoint(o[1],o[2],.44);t.strokePoints([c,d],!1);const u=this.lerpPoint(r[0],r[3],.36),h=this.lerpPoint(r[1],r[2],.36);t.strokePoints([u,h],!1)}drawFaceGrid(t,i,s,n,a,r){t.lineStyle(1,a,r);for(let o=1;o<s;o+=1){const l=o/s,c=this.lerpPoint(i[0],i[1],l),d=this.lerpPoint(i[3],i[2],l);t.strokePoints([c,d],!1)}for(let o=1;o<n;o+=1){const l=o/n,c=this.lerpPoint(i[0],i[3],l),d=this.lerpPoint(i[1],i[2],l);t.strokePoints([c,d],!1)}}createRoof(t,i,s){return{top:this.liftAndInset(t.top,i,s),right:this.liftAndInset(t.right,i,s),bottom:this.liftAndInset(t.bottom,i,s),left:this.liftAndInset(t.left,i,s)}}liftAndInset(t,i,s){return new P.Geom.Point(t.x*(1-s),t.y*(1-s)-i)}toLocal(t,i){const s=n=>new P.Geom.Point(n.x-t.x,n.y-t.y);return{top:s(i.top),right:s(i.right),bottom:s(i.bottom),left:s(i.left)}}lerpPoint(t,i,s){return new P.Geom.Point(P.Math.Linear(t.x,i.x,s),P.Math.Linear(t.y,i.y,s))}hexToColor(t){return P.Display.Color.HexStringToColor(t).color}}const Ah=(e,t)=>{const i=e.entityProfiles[t];return{baseColor:i.baseColor,outlineColor:i.outlineColor,primaryColor:i.primaryColor,accentColor:i.accentColor,glowColor:i.glowColor,columnHeight:i.columnHeight,widthScale:i.widthScale,heightScale:i.heightScale,depthOffset:i.depthOffset}};class xh{constructor(t,i){y(this,"motionByToken",new WeakMap);this.isoFactory=t,this.theme=i}createToken(t,i,s){const n=this.isoFactory.createCharacterToken(i,s,Ah(this.theme,t));return this.decorateToken(t,n),this.motionByToken.set(n,{lastX:i,lastY:s,cadence:Math.abs(i*17+s*31)%11*.23}),n}positionToken(t,i,s){this.isoFactory.positionCharacterToken(t,i,s);const n=this.motionByToken.get(t),a=t.container.getData("rigShell"),r=t.container.getData("rigStride");if(!n||!a||!r)return;const o=i-n.lastX,l=s-n.lastY;if(o!==0||l!==0){n.cadence+=.55;const d=P.Math.Clamp(o*.22,-.24,.24);a.setRotation(d),t.container.scaleX=o<0?-1:1,r.setAlpha(.28+Math.min(.42,Math.abs(o)*.2+Math.abs(l)*.2)),r.setScale(1+Math.abs(o)*.1,1+Math.abs(l)*.08),t.halo.setAlpha(.2+Math.min(.16,(Math.abs(o)+Math.abs(l))*.08))}else n.cadence+=.08,a.setRotation(a.rotation*.86),r.setAlpha(Math.max(.12,r.alpha*.85)),r.setScale(P.Math.Linear(r.scaleX,1,.25),P.Math.Linear(r.scaleY,1,.25)),t.halo.setAlpha(P.Math.Linear(t.halo.alpha,.2,.2));a.y=-2+Math.sin(n.cadence)*1.8,t.beacon.y=-Math.sin(n.cadence+.45)*1.25,n.lastX=i,n.lastY=s}decorateToken(t,i){const s=this.theme.entityProfiles[t],n=i.container.scene.add.graphics(),a=i.container.scene.add.graphics(),r=i.container.scene.add.graphics(),o=16*s.widthScale,l=24*s.columnHeight*.64;switch(n.fillStyle(T(s.primaryColor,-.2),.9),n.lineStyle(1.2,s.outlineColor,.95),n.fillEllipse(0,-l*.3,o,l),n.strokeEllipse(0,-l*.3,o,l),a.fillStyle(s.accentColor,.94),a.lineStyle(1,T(s.accentColor,.35),.92),r.fillStyle(s.glowColor,.18),r.fillEllipse(0,2.5,21*s.widthScale,8.4*s.heightScale),r.setBlendMode(P.BlendModes.ADD),t){case"player":n.fillStyle(T(s.accentColor,-.15),.95),n.fillTriangle(0,-l*1.08,-4.4,-l*.64,4.4,-l*.64),a.fillTriangle(0,-l*.96,-3.4,-l*.7,3.4,-l*.7);break;case"hostileNpc":n.fillStyle(T(s.primaryColor,-.34),.98),n.fillRect(-o*.55,-l*.75,o*1.1,l*.32),a.fillTriangle(-4.5,-l*.85,-8.2,-l*.58,-2.2,-l*.58),a.fillTriangle(4.5,-l*.85,2.2,-l*.58,8.2,-l*.58);break;case"interactiveNpc":n.fillStyle(T(s.primaryColor,.08),.95),n.fillEllipse(0,-l*.86,o*.88,o*.72),a.fillStyle(s.accentColor,.9),a.fillCircle(0,-l*1.02,3.2),a.fillRect(-.8,-l*.96,1.6,9.6);break;case"friendlyNpc":default:n.fillStyle(T(s.primaryColor,.04),.92),n.fillEllipse(0,-l*.87,o*.92,o*.62),a.fillTriangle(0,-l*.96,-3.8,-l*.78,3.8,-l*.78);break}i.container.addAt(n,2),i.container.add(a),i.container.add(r),i.container.setData("rigShell",n),i.container.setData("rigStride",r);const c=i.container.scene.tweens.add({targets:a,alpha:{from:.4,to:.95},yoyo:!0,repeat:-1,duration:920+(t==="hostileNpc"?180:0),ease:"Sine.easeInOut"});i.container.once(P.GameObjects.Events.DESTROY,()=>{c.isPlaying()&&c.stop()})}}const Ie=e=>P.Math.Clamp(e,0,1),X=(e,t,i)=>{const s=P.Display.Color.ValueToColor(e),n=P.Display.Color.ValueToColor(t),a=Ie(i),r=P.Math.Linear(s.red,n.red,a),o=P.Math.Linear(s.green,n.green,a),l=P.Math.Linear(s.blue,n.blue,a);return P.Display.Color.GetColor(r,o,l)},Ih=e=>{if(!e)return null;const t=e.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([0-9.]+)\)/i);if(!t)return null;const[,i,s,n,a]=t;return{color:P.Display.Color.GetColor(Number(i),Number(s),Number(n)),alpha:Ie(Number(a))}};class Ch{constructor(t){this.theme=t}resolveAtmosphereProfile(t){const i=Ie(t.districtWeight),s=t.timeSeconds%180/180*Math.PI*2,a=1-Ie(.5+.5*Math.sin(s-Math.PI*.5)),r=X(1323092,728122,a*.45),o=X(4071715,2166805,a*.42),l=X(o,r,i),c=X(l,396053,.3+a*.38),d=X(l,792880,.24+i*.22+a*.24),u=X(1707796,926264,i*.58),h=X(593173,1189440,i*.62),g=Math.max(1,this.theme.qualityBudget.maxFogBands),m=[];for(let A=0;A<g;A+=1){const I=(A+1)/(g+1),w=X(2760230,1522266,i*.7+I*.2),C=Ie((.16+a*.12)*(1-I*.72));m.push({widthFactor:1.1+I*.95,heightFactor:.34+I*.28,yFactor:.66+I*.2,color:w,alpha:C})}const p=Ie(.28+a*.56+i*.12+this.theme.qualityBudget.maxEmissiveZones*.012),v=Ie(this.theme.qualityBudget.wetReflectionAlpha*(.68+a*.65)),S=Ih(t.baseOverlayRgba),M=X(725536,2298136,1-i),x=S?X(S.color,M,.22+a*.26):M,b=Ie(((S==null?void 0:S.alpha)??.12+a*.32)*(.9+a*.2));return{gradientTopLeft:c,gradientTopRight:d,gradientBottomLeft:u,gradientBottomRight:h,skylineDowntownColor:X(2051962,1391198,a*.45),skylineSlumsColor:X(5909034,3808548,a*.4),skylineColumns:this.theme.preset==="cinematic"?34:this.theme.preset==="balanced"?30:24,skylineSplit:P.Math.Clamp(.24+i*.52,.2,.82),skylineAlphaBase:.22+a*.16,skylineAlphaVariance:.12,horizonGlowColor:X(6105141,2972550,i),horizonGlowAlpha:.14+a*.1,lowerHazeColor:X(329485,659485,i*.4),lowerHazeAlpha:.42+a*.2,fogBands:m,emissiveIntensity:p,wetReflectionAlpha:v,overlayColor:x,overlayAlpha:b}}}const Wt=20,An=1.06;class kh{constructor(){y(this,"previousFrameMassAlpha",new WeakMap);y(this,"previousFrameEntityVisuals",new WeakMap)}applyOcclusionReadability(t){const i=P.Math.Clamp(t.occlusionFadeFloor,.2,.9),s=P.Math.Clamp(.14+t.emissiveIntensity*.3,.12,.5);this.restorePreviousFrameState(t),t.masses.forEach(n=>{this.previousFrameMassAlpha.has(n.container)||this.previousFrameMassAlpha.set(n.container,n.container.alpha)}),t.masses.forEach(n=>{const a=new P.Geom.Rectangle(n.bounds.x-Wt,n.bounds.y-Wt,n.bounds.width+Wt*2,n.bounds.height+Wt*2),r=t.entities.filter(o=>a.contains(o.pixelX,o.pixelY));r.length&&(this.previousFrameMassAlpha.has(n.container)||this.previousFrameMassAlpha.set(n.container,n.container.alpha),n.container.setAlpha(Math.min(n.container.alpha,i)),r.forEach(o=>{var d,u,h,g,m;const l=o.token.container;this.previousFrameEntityVisuals.has(l)||this.previousFrameEntityVisuals.set(l,{haloAlpha:o.token.halo.alpha,beaconAlpha:o.token.beacon.alpha,nameAlpha:((d=o.nameLabel)==null?void 0:d.alpha)??1,nameScaleX:((u=o.nameLabel)==null?void 0:u.scaleX)??1,nameScaleY:((h=o.nameLabel)==null?void 0:h.scaleY)??1,healthAlpha:((g=o.healthBar)==null?void 0:g.alpha)??1,indicatorAlpha:((m=o.indicator)==null?void 0:m.alpha)??1});const c=o.token;c.halo.setAlpha(Math.max(c.halo.alpha,.28+s)),c.beacon.setAlpha(Math.max(c.beacon.alpha,.36+s*.75)),o.nameLabel&&(o.nameLabel.setAlpha(1),o.nameLabel.setScale(Math.max(o.nameLabel.scaleX,An),Math.max(o.nameLabel.scaleY,An))),o.healthBar&&o.healthBar.visible&&o.healthBar.setAlpha(Math.max(o.healthBar.alpha,.94)),o.indicator&&o.indicator.visible&&o.indicator.setAlpha(Math.max(o.indicator.alpha,.94))}))})}restorePreviousFrameState(t){t.masses.forEach(i=>{const s=this.previousFrameMassAlpha.get(i.container);typeof s=="number"&&i.container.setAlpha(s),this.previousFrameMassAlpha.delete(i.container)}),t.entities.forEach(i=>{this.restoreEntityBaseState(i)})}restoreEntityBaseState(t){const i=t.token.container,s=this.previousFrameEntityVisuals.get(i);s&&(t.token.halo.setAlpha(s.haloAlpha),t.token.beacon.setAlpha(s.beaconAlpha),t.nameLabel&&(t.nameLabel.setAlpha(s.nameAlpha),t.nameLabel.setScale(s.nameScaleX,s.nameScaleY)),t.healthBar&&t.healthBar.setAlpha(s.healthAlpha),t.indicator&&t.indicator.setAlpha(s.indicatorAlpha),this.previousFrameEntityVisuals.delete(i))}}const xn={"items.corporate_keycard":"Keycard","items.encrypted_datapad":"Datapad","items.transit_tokens":"Transit Token","items.abandoned_medkit":"Medkit","items.holo_projector_lens":"Lens","items.saboteur_charge_kit":"Charge Kit"},In={misc_corporate_keycard:"Keycard",misc_encrypted_datapad:"Datapad",misc_transit_tokens:"Transit Token",misc_abandoned_medkit:"Medkit",misc_holo_projector_lens:"Lens",misc_saboteur_charge_kit:"Charge Kit"},Th=e=>e.resourceKey&&xn[e.resourceKey]?xn[e.resourceKey]:e.definitionId&&In[e.definitionId]?In[e.definitionId]:e.name,N=(e,t)=>Reflect.get(e,t),Gt=(e,t)=>{const i=N(e,t);if(i==null)throw new Error(`[WorldRenderModule] Missing required scene value: ${t}`);return i},qt=(e,t,i)=>{const s=N(e,t);return typeof s=="number"?s:i},st=(e,t,...i)=>{const s=N(e,t);if(typeof s!="function")throw new Error(`[WorldRenderModule] Missing required scene method: ${t}`);return s.apply(e,i)},Rh=()=>({visualTheme:os("balanced"),tilePainter:void 0,buildingPainter:void 0,characterRigFactory:void 0,atmosphereDirector:void 0,occlusionReadabilityController:void 0,buildingVisualProfiles:{},buildingLabels:[],buildingMassings:[],buildingMassingEntries:[],currentAtmosphereProfile:void 0,lastAtmosphereRedrawBucket:-1,lastItemMarkerSignature:""}),Eh=e=>({add:Gt(e,"add"),game:Gt(e,"game"),lights:Gt(e,"lights"),mapGraphics:Gt(e,"mapGraphics"),getBackdropGraphics:()=>N(e,"backdropGraphics"),getCurrentMapArea:()=>N(e,"currentMapArea")??null,getCurrentGameTime:()=>qt(e,"currentGameTime",0),getTileSize:()=>qt(e,"tileSize",0),getIsoFactory:()=>N(e,"isoFactory"),ensureIsoFactory:()=>{st(e,"ensureIsoFactory")},getIsoMetrics:()=>st(e,"getIsoMetrics"),calculatePixelPosition:(t,i)=>st(e,"calculatePixelPosition",t,i),syncDepth:(t,i,s,n)=>{st(e,"syncDepth",t,i,s,n)},renderVisionCones:()=>{st(e,"renderVisionCones")},getStaticPropGroup:()=>N(e,"staticPropGroup"),setStaticPropGroup:t=>{Reflect.set(e,"staticPropGroup",t)},getLightsFeatureEnabled:()=>!!N(e,"lightsFeatureEnabled"),setLightsFeatureEnabled:t=>{Reflect.set(e,"lightsFeatureEnabled",t)},getDemoLampGrid:()=>N(e,"demoLampGrid"),setDemoLampGrid:t=>{Reflect.set(e,"demoLampGrid",t)},getDemoPointLight:()=>N(e,"demoPointLight"),setDemoPointLight:t=>{Reflect.set(e,"demoPointLight",t)},getLightingAmbientColor:()=>qt(e,"lightingAmbientColor",988970),readEntityRuntimeState:()=>({playerToken:N(e,"playerToken"),playerNameLabel:N(e,"playerNameLabel"),enemySprites:N(e,"enemySprites")??new Map,npcSprites:N(e,"npcSprites")??new Map}),readRuntimeState:()=>({visualTheme:N(e,"visualTheme")??os("balanced"),tilePainter:N(e,"tilePainter"),buildingPainter:N(e,"buildingPainter"),characterRigFactory:N(e,"characterRigFactory"),atmosphereDirector:N(e,"atmosphereDirector"),occlusionReadabilityController:N(e,"occlusionReadabilityController"),buildingVisualProfiles:N(e,"buildingVisualProfiles")??{},buildingLabels:N(e,"buildingLabels")??[],buildingMassings:N(e,"buildingMassings")??[],buildingMassingEntries:N(e,"buildingMassingEntries")??[],currentAtmosphereProfile:N(e,"currentAtmosphereProfile"),lastAtmosphereRedrawBucket:qt(e,"lastAtmosphereRedrawBucket",-1),lastItemMarkerSignature:N(e,"lastItemMarkerSignature")??""}),writeRuntimeState:t=>{Reflect.set(e,"visualTheme",t.visualTheme),Reflect.set(e,"tilePainter",t.tilePainter),Reflect.set(e,"buildingPainter",t.buildingPainter),Reflect.set(e,"characterRigFactory",t.characterRigFactory),Reflect.set(e,"atmosphereDirector",t.atmosphereDirector),Reflect.set(e,"occlusionReadabilityController",t.occlusionReadabilityController),Reflect.set(e,"buildingVisualProfiles",t.buildingVisualProfiles),Reflect.set(e,"buildingLabels",t.buildingLabels),Reflect.set(e,"buildingMassings",t.buildingMassings),Reflect.set(e,"buildingMassingEntries",t.buildingMassingEntries),Reflect.set(e,"currentAtmosphereProfile",t.currentAtmosphereProfile),Reflect.set(e,"lastAtmosphereRedrawBucket",t.lastAtmosphereRedrawBucket),Reflect.set(e,"lastItemMarkerSignature",t.lastItemMarkerSignature)}});class _h{constructor(t,i){y(this,"key","worldRender");y(this,"ports");y(this,"runtimeState");var s,n;this.scene=t,this.ports=i??Eh(t),this.runtimeState={...Rh(),...(n=(s=this.ports).readRuntimeState)==null?void 0:n.call(s)},this.pushRuntimeStateToPorts()}init(){}onShutdown(){this.clearForMapTransition(),this.disableLighting(!0)}createCharacterToken(t,i,s){if(this.ensureVisualPipeline(),this.ports.ensureIsoFactory(),this.runtimeState.characterRigFactory)return this.runtimeState.characterRigFactory.createToken(t,i,s);const n=this.ports.getIsoFactory();if(!n)throw new Error("[WorldRenderModule] IsoObjectFactory not available while creating character token.");return n.createCharacterToken(i,s,this.runtimeState.visualTheme.entityProfiles[t])}positionCharacterToken(t,i,s){if(this.runtimeState.characterRigFactory){this.runtimeState.characterRigFactory.positionToken(t,i,s);return}const n=this.ports.getIsoFactory();if(!n)throw new Error("[WorldRenderModule] IsoObjectFactory not available while positioning character token.");n.positionCharacterToken(t,i,s)}getAtmosphereRedrawBucket(){return this.runtimeState.lastAtmosphereRedrawBucket}setAtmosphereRedrawBucket(t){this.runtimeState.lastAtmosphereRedrawBucket=t,this.pushRuntimeStateToPorts()}ensureVisualPipeline(){const t=F.getState().settings.visualQualityPreset,i=!this.runtimeState.visualTheme||this.runtimeState.visualTheme.preset!==t;(!this.runtimeState.visualTheme||this.runtimeState.visualTheme.preset!==t)&&(this.runtimeState.visualTheme=os(t)),this.ports.mapGraphics&&(!this.runtimeState.tilePainter||i)&&(this.runtimeState.tilePainter=new vh(this.ports.mapGraphics,this.runtimeState.visualTheme)),(!this.runtimeState.buildingPainter||i)&&(this.runtimeState.buildingPainter=new Mh(this.scene,this.runtimeState.visualTheme)),(!this.runtimeState.atmosphereDirector||i)&&(this.runtimeState.atmosphereDirector=new Ch(this.runtimeState.visualTheme),this.runtimeState.lastAtmosphereRedrawBucket=-1),(!this.runtimeState.occlusionReadabilityController||i)&&(this.runtimeState.occlusionReadabilityController=new kh);const s=this.ports.getIsoFactory();s&&(!this.runtimeState.characterRigFactory||i)&&(this.runtimeState.characterRigFactory=new xh(s,this.runtimeState.visualTheme));const n=this.ports.getCurrentMapArea();if(n!=null&&n.buildings){const a={};n.buildings.forEach(r=>{const o=Vt(r.district,r.signageStyle,r.propDensity);a[r.id]=r.visualProfile?{district:r.district==="downtown"?"downtown":"slums",signageStyle:r.signageStyle??o.signageStyle,propDensity:r.propDensity??o.propDensity,facadePattern:r.visualProfile.facadePattern??o.facadePattern,lotPattern:r.visualProfile.lotPattern??o.lotPattern,massingStyle:r.visualProfile.massingStyle??o.massingStyle,massingHeight:r.visualProfile.massingHeight??o.massingHeight,accentHex:r.visualProfile.accentHex??o.accentHex,glowHex:r.visualProfile.glowHex??o.glowHex,trimHex:r.visualProfile.trimHex??o.trimHex,atmosphereHex:r.visualProfile.atmosphereHex??o.atmosphereHex,signagePrimaryHex:r.visualProfile.signagePrimaryHex??o.signagePrimaryHex,signageSecondaryHex:r.visualProfile.signageSecondaryHex??o.signageSecondaryHex,backdropHex:r.visualProfile.backdropHex??o.backdropHex}:o}),this.runtimeState.buildingVisualProfiles=a}else this.runtimeState.buildingVisualProfiles={};this.pushRuntimeStateToPorts()}renderStaticProps(){const t=this.ports.getStaticPropGroup();if(t&&t.clear(!0,!0),this.ports.setDemoLampGrid(void 0),this.destroyDemoPointLight(),!this.ports.getIsoFactory()||!this.ports.getCurrentMapArea())return;this.ensureVisualPipeline(),this.ports.getStaticPropGroup()||this.ports.setStaticPropGroup(this.ports.add.group());const i=l=>{var c;l&&((c=this.ports.getStaticPropGroup())==null||c.add(l))},s=this.ports.getCurrentMapArea();if(!s)return;const n=(s.entities.npcs??[]).filter(l=>l.isInteractive),a=(s.entities.items??[]).filter(l=>!!l.position),r=this.ports.getIsoFactory();if(!r)return;const o=this.ports.getIsoMetrics();n.forEach(l=>{i(r.createPulsingHighlight(l.position.x,l.position.y,{color:2282478,alpha:.14,pulseColor:8246268,pulseAlpha:{from:.26,to:.05},pulseScale:1.22,widthScale:.58,heightScale:.58,depthOffset:9,duration:1400}))}),a.forEach(l=>{const c=l.isQuestItem?16436245:2282478,d=l.isQuestItem?16774079:8246268,u=this.ports.calculatePixelPosition(l.position.x,l.position.y),h=Th(l);i(r.createPulsingHighlight(l.position.x,l.position.y,{color:c,alpha:l.isQuestItem?.24:.22,pulseColor:d,pulseAlpha:{from:l.isQuestItem?.34:.3,to:.08},pulseScale:l.isQuestItem?1.28:1.22,widthScale:.72,heightScale:.72,depthOffset:8,duration:l.isQuestItem?1150:1300}));const g=this.ports.add.text(u.x,u.y-o.tileHeight*.7,h,{fontFamily:'Orbitron, "DM Sans", sans-serif',fontSize:"10px",fontStyle:"700",color:l.isQuestItem?"#fde68a":"#dbeafe",align:"center"});g.setOrigin(.5,1),g.setStroke(l.isQuestItem?"#f59e0b":"#0284c7",1.1),g.setShadow(0,0,l.isQuestItem?"#f59e0b":"#38bdf8",8,!0,!0),this.ports.syncDepth(g,u.x,u.y,H.FLOATING_UI+14),i(g)}),this.ports.getLightsFeatureEnabled()&&this.rebuildLightingDemoLight(),this.runtimeState.lastItemMarkerSignature=this.getItemMarkerSignature(s),this.pushRuntimeStateToPorts()}getItemMarkerSignature(t){if(!t)return"";const i=(t.entities.items??[]).filter(s=>!!s.position);return i.length===0?"":i.map(s=>`${s.id??s.name}@${s.position.x},${s.position.y}`).sort().join("|")}applyLightingSettings(t){var a;const i=(a=this.runtimeState.visualTheme)==null?void 0:a.preset;(!this.runtimeState.visualTheme||i!==t.qualityPreset)&&(this.ensureVisualPipeline(),this.refreshVisualLayers());const s=Cs(t.qualityPreset),n=t.lightsEnabled&&t.qualityPreset!=="performance";if(n&&!this.hasLightPipelineSupport()){console.warn("[MainScene] Light2D not supported by current renderer; disabling lighting toggle."),F.dispatch(Gs(!1)),oi({lightsEnabled:!1}),this.disableLighting(!0);return}n?this.enableLighting():this.disableLighting(),!s.colorMatrixEnabled&&t.colorMatrix.enabled&&oi({colorMatrix:{enabled:!1}})}refreshVisualLayers(){const t=this.ports.getCurrentMapArea();t&&(this.runtimeState.currentAtmosphereProfile=void 0,this.drawBackdrop(),this.drawMap(t.tiles),this.drawBuildingMasses(),this.drawBuildingLabels(),this.renderStaticProps(),this.ports.renderVisionCones(),this.applyOcclusionReadability(),this.pushRuntimeStateToPorts())}drawMap(t){var o,l,c;if(!this.ports.mapGraphics)return;this.ensureVisualPipeline();const i=this.resolveAtmosphereProfile();(o=this.runtimeState.tilePainter)==null||o.setAtmosphereProfile({wetReflectionAlpha:i.wetReflectionAlpha,emissiveIntensity:i.emissiveIntensity}),this.ports.mapGraphics.clear();const{tileWidth:s,tileHeight:n}=this.ports.getIsoMetrics(),a=this.ports.getCurrentMapArea(),r=new Set;(l=a==null?void 0:a.buildings)==null||l.forEach(d=>{for(let u=d.footprint.from.y;u<=d.footprint.to.y;u+=1)for(let h=d.footprint.from.x;h<=d.footprint.to.x;h+=1)r.add(`${h}:${u}`)});for(let d=0;d<t.length;d+=1)for(let u=0;u<t[0].length;u+=1){const h=t[d][u],g=this.ports.calculatePixelPosition(u,d),m=((c=a==null?void 0:a.zoneId)==null?void 0:c.startsWith("downtown_checkpoint"))&&h.type===D.COVER,p=r.has(`${u}:${d}`),v=m||p&&(h.type===D.WALL||h.type===D.COVER||h.type===D.DOOR);this.renderTile(h,g,s,n,u,d,v)}}drawBuildingMasses(){var r;this.runtimeState.buildingMassings.forEach(o=>o.destroy(!0)),this.runtimeState.buildingMassings=[],this.runtimeState.buildingMassingEntries=[];const t=this.ports.getCurrentMapArea();if(!((r=t==null?void 0:t.buildings)!=null&&r.length)||!this.runtimeState.buildingPainter){this.pushRuntimeStateToPorts();return}this.ensureVisualPipeline();const i=this.runtimeState.buildingPainter;if(!i)return;const{tileWidth:s,tileHeight:n}=this.ports.getIsoMetrics(),a=this.runtimeState.currentAtmosphereProfile??this.resolveAtmosphereProfile();t.buildings.forEach(o=>{const l=this.runtimeState.buildingVisualProfiles[o.id]??Vt(o.district,o.signageStyle,o.propDensity),c=o.footprint.to.x-o.footprint.from.x+1,d=o.footprint.to.y-o.footprint.from.y+1,u=this.ports.calculatePixelPosition(o.footprint.from.x,o.footprint.from.y),h=this.ports.calculatePixelPosition(o.footprint.to.x,o.footprint.from.y),g=this.ports.calculatePixelPosition(o.footprint.to.x,o.footprint.to.y),m=this.ports.calculatePixelPosition(o.footprint.from.x,o.footprint.to.y),p={top:new P.Geom.Point(u.x,u.y-n*.5),right:new P.Geom.Point(h.x+s*.5,h.y),bottom:new P.Geom.Point(g.x,g.y+n*.5),left:new P.Geom.Point(m.x-s*.5,m.y)},v={x:(p.top.x+p.right.x+p.bottom.x+p.left.x)/4,y:(p.top.y+p.right.y+p.bottom.y+p.left.y)/4},S=i.createMassing(o,l,{center:v,tileHeight:n,widthTiles:c,depthTiles:d,footprint:p,atmosphere:{emissiveIntensity:a.emissiveIntensity,overlayAlpha:a.overlayAlpha}});if(S.setScrollFactor(1),o.id==="block_2_2"){const C=Math.min(H.CHARACTER_BASE-1,H.PROP_TALL+Math.round(l.massingHeight*12));this.ports.syncDepth(S,p.bottom.x,p.bottom.y,C),this.runtimeState.buildingMassings.push(S);const R=this.ports.calculatePixelPosition(o.door.x,o.door.y),k=this.ports.add.container(R.x,R.y);if(k.setScrollFactor(1),typeof window<"u"&&new URLSearchParams(window.location.search).get("pocDebug")==="1"){const B=this.ports.add.graphics();B.lineStyle(2,3790335,.65),B.strokePoints([p.top,p.right,p.bottom,p.left],!0),this.ports.syncDepth(B,p.bottom.x,p.bottom.y,H.FLOATING_UI+28),this.runtimeState.buildingMassings.push(B);const Y=this.ports.add.text(0,-n*1.6,`door ${o.door.x},${o.door.y}`,{fontFamily:"monospace",fontSize:"10px",color:"#39d5ff",stroke:"#000000",strokeThickness:3});Y.setOrigin(.5,1),k.add(Y)}const f=this.ports.add.graphics();f.setBlendMode(P.BlendModes.ADD),f.fillStyle(16757596,.06),f.fillCircle(0,0,n*1.1),f.fillStyle(16742936,.04),f.fillCircle(0,0,n*.75),f.lineStyle(2,3790335,.09),f.strokeRoundedRect(-10,-18,20,30,4),f.lineStyle(1,12667903,.06),f.strokeRoundedRect(-13,-21,26,36,6),f.fillStyle(3790335,.025),f.fillRoundedRect(n*1,-n*1.25,n*2.4,n*.85,6),f.lineStyle(2,3790335,.08),f.strokeRoundedRect(n*1,-n*1.25,n*2.4,n*.85,6),f.lineStyle(1,16757596,.05),f.strokeRoundedRect(n*1.05,-n*1.2,n*2.3,n*.75,6),k.add(f),this.ports.syncDepth(k,R.x,R.y,H.PROP_LOW),this.runtimeState.buildingMassings.push(k),this.scene.tweens.add({targets:f,alpha:{from:.85,to:1},duration:2800,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});return}this.ports.syncDepth(S,p.bottom.x,p.bottom.y,H.PROP_TALL+Math.round(l.massingHeight*12)),this.runtimeState.buildingMassings.push(S);const M=l.district==="downtown"?.78:.7,x=n*Math.max(.58,l.massingHeight*M),b=Math.min(p.top.x,p.right.x,p.bottom.x,p.left.x),A=Math.max(p.top.x,p.right.x,p.bottom.x,p.left.x),I=Math.min(p.top.y-x,p.right.y-x,p.bottom.y-x,p.left.y-x),w=Math.max(p.top.y,p.right.y,p.bottom.y,p.left.y);this.runtimeState.buildingMassingEntries.push({id:o.id,container:S,bounds:new P.Geom.Rectangle(b,I,Math.max(1,A-b),Math.max(1,w-I))})}),this.pushRuntimeStateToPorts()}drawBuildingLabels(){this.runtimeState.buildingLabels.forEach(s=>s.destroy(!0)),this.runtimeState.buildingLabels=[];const t=this.ports.getCurrentMapArea();if(!(t!=null&&t.buildings)||t.buildings.length===0){this.pushRuntimeStateToPorts();return}this.ensureVisualPipeline();const{tileHeight:i}=this.ports.getIsoMetrics();t.buildings.forEach(s=>{const n=this.runtimeState.buildingVisualProfiles[s.id]??Vt(s.district,s.signageStyle,s.propDensity),a=(s.footprint.from.x+s.footprint.to.x)/2,r=Math.min(s.footprint.from.y,s.door.y)-.4,o=this.ports.calculatePixelPosition(a,r),l=i*(.8+n.massingHeight*.18),c=this.runtimeState.buildingPainter?this.runtimeState.buildingPainter.createLabel(s,o,l,n):this.ports.add.container(o.x,o.y-i*.2);c.setScrollFactor(1),this.ports.syncDepth(c,o.x,o.y,H.FLOATING_UI+20),this.runtimeState.buildingLabels.push(c)}),this.pushRuntimeStateToPorts()}resolveAtmosphereProfile(t){if(this.ensureVisualPipeline(),!this.runtimeState.atmosphereDirector)throw new Error("AtmosphereDirector is not initialized.");const i=this.runtimeState.atmosphereDirector.resolveAtmosphereProfile({districtWeight:this.resolveDistrictWeight(),timeSeconds:this.ports.getCurrentGameTime(),baseOverlayRgba:t}),s=Cs(this.runtimeState.visualTheme.preset);return this.runtimeState.currentAtmosphereProfile={...i,fogBands:i.fogBands.slice(0,s.maxFogBands),emissiveIntensity:P.Math.Clamp(i.emissiveIntensity,0,1),wetReflectionAlpha:P.Math.Clamp(i.wetReflectionAlpha,0,s.wetReflectionAlpha)},this.pushRuntimeStateToPorts(),this.runtimeState.currentAtmosphereProfile}applyOcclusionReadability(){var n,a,r,o;if(!this.runtimeState.occlusionReadabilityController||!this.runtimeState.buildingMassingEntries.length)return;const t=(a=(n=this.ports).readEntityRuntimeState)==null?void 0:a.call(n),i=[];t!=null&&t.playerToken&&i.push({id:"player",pixelX:t.playerToken.container.x,pixelY:t.playerToken.container.y,token:t.playerToken,nameLabel:t.playerNameLabel}),(r=t==null?void 0:t.enemySprites)==null||r.forEach((l,c)=>{i.push({id:c,pixelX:l.token.container.x,pixelY:l.token.container.y,token:l.token,nameLabel:l.nameLabel,healthBar:l.healthBar})}),(o=t==null?void 0:t.npcSprites)==null||o.forEach((l,c)=>{i.push({id:c,pixelX:l.token.container.x,pixelY:l.token.container.y,token:l.token,nameLabel:l.nameLabel,indicator:l.indicator})});const s=this.runtimeState.currentAtmosphereProfile??this.resolveAtmosphereProfile();this.runtimeState.occlusionReadabilityController.applyOcclusionReadability({masses:this.runtimeState.buildingMassingEntries,entities:i,occlusionFadeFloor:this.runtimeState.visualTheme.qualityBudget.occlusionFadeFloor,emissiveIntensity:s.emissiveIntensity})}drawBackdrop(){const t=this.ports.getBackdropGraphics(),i=this.ports.getCurrentMapArea();if(!t||!i)return;const s=this.computeIsoBounds(),n=this.ports.getTileSize()*4,a=s.maxX-s.minX+n*2,r=s.maxY-s.minY+n*2,o=s.minX-n,l=s.minY-n,c=this.resolveAtmosphereProfile(),d=c.skylineSplit;t.clear(),t.fillGradientStyle(c.gradientTopLeft,c.gradientTopRight,c.gradientBottomLeft,c.gradientBottomRight,1,1,1,1),t.fillRect(o,l,a,r);const u=l+r*.52,h=c.skylineColumns,g=c.skylineDowntownColor,m=c.skylineSlumsColor;for(let v=0;v<h;v+=1){const S=v/h,M=o+S*a,x=.68+v*13%7*.08,b=a/h*x,A=v*29%11/11,I=r*(.12+A*.28)*(S<d?1.12:.78),w=S<d?.78:.26,C=P.Display.Color.Interpolate.ColorWithColor(P.Display.Color.ValueToColor(m),P.Display.Color.ValueToColor(g),1,w),R=P.Display.Color.GetColor(C.r,C.g,C.b);t.fillStyle(R,c.skylineAlphaBase+A*c.skylineAlphaVariance),t.fillRect(M,u-I,b,I),t.fillStyle(T(R,.12),.14+c.emissiveIntensity*.1),t.fillRect(M+b*.72,u-I,b*.16,I)}const p=l+r*.35;t.fillStyle(c.horizonGlowColor,c.horizonGlowAlpha),t.fillEllipse(o+a/2,p,a*1.08,r*.52),t.fillStyle(c.lowerHazeColor,c.lowerHazeAlpha),t.fillRect(o,l+r*.6,a,r*.6),c.fogBands.forEach(v=>{v.alpha<=0||(t.lineStyle(2,v.color,v.alpha),t.strokeEllipse(o+a/2,l+r*v.yFactor,a*v.widthFactor,r*v.heightFactor))})}computeIsoBounds(){const t=this.ports.getCurrentMapArea();if(!t)return{minX:0,maxX:0,minY:0,maxY:0};const{width:i,height:s}=t,n=[this.ports.calculatePixelPosition(0,0),this.ports.calculatePixelPosition(i-1,0),this.ports.calculatePixelPosition(0,s-1),this.ports.calculatePixelPosition(i-1,s-1)];return{minX:Math.min(...n.map(a=>a.x)),maxX:Math.max(...n.map(a=>a.x)),minY:Math.min(...n.map(a=>a.y)),maxY:Math.max(...n.map(a=>a.y))}}hasLightPipelineSupport(){return this.ports.game.renderer instanceof P.Renderer.WebGL.WebGLRenderer}enableLighting(){if(!this.hasLightPipelineSupport()){console.warn("[MainScene] WebGL renderer unavailable; Light2D disabled."),this.ports.setLightsFeatureEnabled(!1),F.dispatch(Gs(!1)),oi({lightsEnabled:!1});return}if(this.ports.getLightsFeatureEnabled()){this.rebuildLightingDemoLight();return}this.ports.lights.enable().setAmbientColor(this.ports.getLightingAmbientColor()),this.ports.setLightsFeatureEnabled(!0),this.rebuildLightingDemoLight()}disableLighting(t=!1){if(!this.ports.getLightsFeatureEnabled()&&!t){this.destroyDemoPointLight();return}if(this.destroyDemoPointLight(),this.hasLightPipelineSupport()){const i=this.ports.lights;typeof i.removeAll=="function"&&i.removeAll(),this.ports.lights.disable()}this.ports.setLightsFeatureEnabled(!1)}rebuildLightingDemoLight(){const t=this.ports.getDemoLampGrid();if(!this.ports.getLightsFeatureEnabled()||!t){this.destroyDemoPointLight();return}const{x:i,y:s}=this.ports.calculatePixelPosition(t.x,t.y),n=s-this.ports.getTileSize()*.35,a=this.ports.getTileSize()*1.6,r=.4,o=this.ports.getDemoPointLight();if(!o){const l=this.ports.add.pointlight(i,n,8246268,a,r);l.setScrollFactor(1),this.ports.setDemoPointLight(l);return}o.setPosition(i,n),o.radius=a,o.intensity=r}destroyDemoPointLight(){const t=this.ports.getDemoPointLight();t&&(t.destroy(),this.ports.setDemoPointLight(void 0))}clearForMapTransition(){this.runtimeState.buildingLabels.forEach(t=>t.destroy(!0)),this.runtimeState.buildingLabels=[],this.runtimeState.buildingMassings.forEach(t=>t.destroy(!0)),this.runtimeState.buildingMassings=[],this.runtimeState.buildingMassingEntries=[],this.runtimeState.currentAtmosphereProfile=void 0,this.runtimeState.lastAtmosphereRedrawBucket=-1,this.runtimeState.lastItemMarkerSignature="",this.pushRuntimeStateToPorts()}renderTile(t,i,s,n,a,r,o=!1){var l;this.ensureVisualPipeline(),(l=this.runtimeState.tilePainter)==null||l.drawTile(t,{center:i,tileWidth:s,tileHeight:n,gridX:a,gridY:r,groundOnly:o})}resolveDistrictWeight(){const t=Object.values(this.runtimeState.buildingVisualProfiles);return t.length?t.filter(s=>s.district==="downtown").length/t.length:.5}pushRuntimeStateToPorts(){var t,i;(i=(t=this.ports).writeRuntimeState)==null||i.call(t,this.runtimeState)}}class Xg extends P.Scene{constructor(){super({key:"MainScene"});y(this,"tileSize",si);y(this,"depthManager");y(this,"mapGraphics");y(this,"backdropGraphics");y(this,"pathGraphics");y(this,"visionConeGraphics");y(this,"coverDebugGraphics");y(this,"currentMapArea",null);y(this,"playerInitialPosition");y(this,"isoOriginX",0);y(this,"isoOriginY",0);y(this,"isoFactory");y(this,"staticPropGroup");y(this,"lightsFeatureEnabled",!1);y(this,"demoLampGrid");y(this,"demoPointLight");y(this,"lightingAmbientColor",988970);y(this,"unsubscribe",null);y(this,"disposeVisualSettings");y(this,"disposeLightingSettings");y(this,"moduleDisposables",new on);y(this,"sceneModuleRegistry");y(this,"dayNightOverlayModule");y(this,"minimapBridgeModule");y(this,"surveillanceRenderModule");y(this,"worldRenderModule");y(this,"entityRenderModule");y(this,"inputModule");y(this,"cameraModule");y(this,"stateSyncModule");y(this,"clockModule");y(this,"lastStoreSnapshot",F.getState())}init(i){this.currentMapArea=i.mapArea,this.playerInitialPosition=i.playerPosition}create(){var n,a;if(!this.currentMapArea){console.error("[MainScene] currentMapArea is null on create!");return}this.cameras.main.setBackgroundColor(1710618),this.depthManager=new au(this),this.backdropGraphics=this.add.graphics(),this.registerStaticDepth(this.backdropGraphics,Ge.BACKDROP),this.mapGraphics=this.add.graphics(),this.registerStaticDepth(this.mapGraphics,Ge.MAP_BASE),this.visionConeGraphics=this.add.graphics(),this.registerStaticDepth(this.visionConeGraphics,Ge.VISION_OVERLAY),this.pathGraphics=this.add.graphics(),this.registerStaticDepth(this.pathGraphics,Ge.PATH_PREVIEW),this.coverDebugGraphics=this.add.graphics(),this.registerStaticDepth(this.coverDebugGraphics,Ge.COVER_DEBUG),this.coverDebugGraphics.setVisible(!1),this.initializeSceneModules(),this.worldRenderModule.ensureVisualPipeline(),this.cameraModule.setupCameraAndMap(),this.dayNightOverlayModule.initializeDayNightOverlay(),this.dayNightOverlayModule.updateDayNightOverlay(),this.cameras.main.setRoundPixels(!1),this.disposeVisualSettings=gr(this.cameras.main),this.disposeLightingSettings=Dn(r=>{this.applyLightingSettings(r)}),this.events.once(P.Scenes.Events.SHUTDOWN,this.cleanupScene,this);const i=F.getState().player.data.name??"Operative";if(this.entityRenderModule.initializePlayer(this.playerInitialPosition,i)){if(this.cameraModule.enablePlayerCameraFollow(),typeof window<"u"&&new URLSearchParams(window.location.search).get("poc")==="esb"){const o=(a=(n=this.currentMapArea)==null?void 0:n.buildings)==null?void 0:a.find(l=>l.id==="block_2_2");if(o){const l=(o.footprint.from.x+o.footprint.to.x)/2,c=(o.footprint.from.y+o.footprint.to.y)/2;this.focusCameraOnGridPosition(l,c,!1)}else this.focusCameraOnGridPosition(14,33,!1)}}else console.error("[MainScene] playerInitialPosition is null");this.unsubscribe=F.subscribe(this.handleStateChange.bind(this)),this.lastStoreSnapshot=F.getState(),this.queueInitialStateSync()}shutdown(){this.cleanupScene()}update(i,s){var n;this.sys.isActive()&&((n=this.sceneModuleRegistry)==null||n.onUpdate(i,s))}worldToGrid(i,s){const{halfTileWidth:n,halfTileHeight:a}=this.getIsoMetrics(),r=i-this.isoOriginX,o=s-this.isoOriginY,l=(o/a+r/n)*.5,c=(o/a-r/n)*.5,d=Math.round(l),u=Math.round(c);return Number.isNaN(d)||Number.isNaN(u)?null:{x:d,y:u}}worldToGridContinuous(i,s){const{halfTileWidth:n,halfTileHeight:a}=this.getIsoMetrics(),r=i-this.isoOriginX,o=s-this.isoOriginY,l=(o/a+r/n)*.5,c=(o/a-r/n)*.5;return!Number.isFinite(l)||!Number.isFinite(c)?null:{x:l,y:c}}emitViewportUpdate(){this.minimapBridgeModule.emitViewportUpdate()}focusCameraOnGridPosition(i,s,n=!0){this.cameraModule.focusCameraOnGridPosition(i,s,n)}initializeSceneModules(){this.moduleDisposables.dispose(),this.moduleDisposables=new on,this.dayNightOverlayModule=new xu(this,{add:this.add,cameras:this.cameras,scale:this.scale,sys:this.sys,getCurrentGameTime:()=>{var s;return((s=this.clockModule)==null?void 0:s.getCurrentGameTime())??F.getState().world.currentTime},isInCombat:()=>{var s;return((s=this.stateSyncModule)==null?void 0:s.isInCombat())??F.getState().world.inCombat},resolveAtmosphereProfile:s=>this.worldRenderModule.resolveAtmosphereProfile(s),registerStaticDepth:(s,n)=>this.registerStaticDepth(s,n)}),this.minimapBridgeModule=new oh(this,{cameras:this.cameras,sys:this.sys,getCurrentMapArea:()=>this.currentMapArea,worldToGridContinuous:(s,n)=>this.worldToGridContinuous(s,n)}),this.surveillanceRenderModule=new Sh(this,{getCurrentMapArea:()=>this.currentMapArea,getVisionConeGraphics:()=>this.visionConeGraphics,getTileSize:()=>this.tileSize,getIsoMetrics:()=>this.getIsoMetrics(),calculatePixelPosition:(s,n)=>this.calculatePixelPosition(s,n),syncDepth:(s,n,a,r)=>this.syncDepth(s,n,a,r)}),this.worldRenderModule=new _h(this,{add:this.add,game:this.game,lights:this.lights,mapGraphics:this.mapGraphics,getBackdropGraphics:()=>this.backdropGraphics,getCurrentMapArea:()=>this.currentMapArea,getCurrentGameTime:()=>{var s;return((s=this.clockModule)==null?void 0:s.getCurrentGameTime())??F.getState().world.currentTime},getTileSize:()=>this.tileSize,getIsoFactory:()=>this.isoFactory,ensureIsoFactory:()=>this.ensureIsoFactory(),getIsoMetrics:()=>this.getIsoMetrics(),calculatePixelPosition:(s,n)=>this.calculatePixelPosition(s,n),syncDepth:(s,n,a,r)=>this.syncDepth(s,n,a,r),renderVisionCones:()=>this.surveillanceRenderModule.renderVisionCones(),getStaticPropGroup:()=>this.staticPropGroup,setStaticPropGroup:s=>{this.staticPropGroup=s},getLightsFeatureEnabled:()=>this.lightsFeatureEnabled,setLightsFeatureEnabled:s=>{this.lightsFeatureEnabled=s},getDemoLampGrid:()=>this.demoLampGrid,setDemoLampGrid:s=>{this.demoLampGrid=s},getDemoPointLight:()=>this.demoPointLight,setDemoPointLight:s=>{this.demoPointLight=s},getLightingAmbientColor:()=>this.lightingAmbientColor,readEntityRuntimeState:()=>this.entityRenderModule.getRuntimeStateSnapshot()}),this.entityRenderModule=new Fu(this,{add:this.add,cameras:this.cameras,game:this.game,scale:this.scale,sys:this.sys,hasMapGraphics:()=>!!this.mapGraphics,ensureIsoFactory:()=>this.ensureIsoFactory(),getIsoMetrics:()=>this.getIsoMetrics(),calculatePixelPosition:(s,n)=>this.calculatePixelPosition(s,n),syncDepth:(s,n,a,r)=>this.syncDepth(s,n,a,r),enablePlayerCameraFollow:()=>this.cameraModule.enablePlayerCameraFollow(),isInCombat:()=>this.stateSyncModule.isInCombat(),isCameraFollowingPlayer:()=>this.cameraModule.isFollowingPlayer(),createCharacterToken:(s,n,a)=>this.worldRenderModule.createCharacterToken(s,n,a),positionCharacterToken:(s,n,a)=>this.worldRenderModule.positionCharacterToken(s,n,a)}),this.inputModule=new Yu(this,{cameras:this.cameras,sys:this.sys,pathGraphics:this.pathGraphics,getCurrentMapArea:()=>this.currentMapArea,setCurrentMapArea:s=>{this.currentMapArea=s},getPlayerInitialPosition:()=>this.playerInitialPosition,getLastPlayerGridPosition:()=>this.entityRenderModule.getLastPlayerGridPosition(),getCoverDebugGraphics:()=>this.coverDebugGraphics,worldToGrid:(s,n)=>this.worldToGrid(s,n),getIsoMetrics:()=>this.getIsoMetrics(),calculatePixelPosition:(s,n)=>this.calculatePixelPosition(s,n),getDiamondPoints:(s,n,a,r)=>this.getDiamondPoints(s,n,a,r),renderStaticProps:()=>this.worldRenderModule.renderStaticProps()}),this.cameraModule=new yu(this,{cameras:this.cameras,scale:this.scale,sys:this.sys,tweens:this.tweens,getCurrentMapArea:()=>this.currentMapArea,getPlayerInitialPosition:()=>this.playerInitialPosition,getPlayerTokenContainer:()=>this.entityRenderModule.getPlayerTokenContainer(),getTileSize:()=>this.tileSize,setIsoOrigin:(s,n)=>{this.isoOriginX=s,this.isoOriginY=n},ensureIsoFactory:()=>this.ensureIsoFactory(),ensureVisualPipeline:()=>this.worldRenderModule.ensureVisualPipeline(),getIsoMetrics:()=>this.getIsoMetrics(),calculatePixelPosition:(s,n)=>this.calculatePixelPosition(s,n),computeIsoBounds:()=>this.worldRenderModule.computeIsoBounds(),renderStaticProps:()=>this.worldRenderModule.renderStaticProps(),drawBackdrop:()=>this.worldRenderModule.drawBackdrop(),drawMap:s=>this.worldRenderModule.drawMap(s),drawBuildingMasses:()=>this.worldRenderModule.drawBuildingMasses(),drawBuildingLabels:()=>this.worldRenderModule.drawBuildingLabels(),clearPathPreview:()=>this.inputModule.clearPathPreview(),resizeDayNightOverlay:()=>this.dayNightOverlayModule.resizeDayNightOverlay(),applyOverlayZoom:()=>this.dayNightOverlayModule.applyOverlayZoom(),emitViewportUpdate:()=>this.minimapBridgeModule.emitViewportUpdate(),dispatchPlayerScreenPosition:()=>this.entityRenderModule.dispatchPlayerScreenPosition(),isInCombat:()=>this.stateSyncModule.isInCombat()}),this.stateSyncModule=new uh(this,{sys:this.sys,getCurrentMapArea:()=>this.currentMapArea,setCurrentMapArea:s=>{this.currentMapArea=s},getItemMarkerSignature:s=>this.worldRenderModule.getItemMarkerSignature(s),renderStaticProps:()=>this.worldRenderModule.renderStaticProps(),updateDayNightOverlay:()=>this.dayNightOverlayModule.updateDayNightOverlay(),updatePlayerPosition:s=>this.entityRenderModule.updatePlayerPosition(s),updatePlayerVitalsIndicator:(s,n,a)=>this.entityRenderModule.updatePlayerVitalsIndicator(s,n,a),updateEnemies:s=>this.entityRenderModule.updateEnemies(s),updateNpcs:s=>this.entityRenderModule.updateNpcs(s),renderVisionCones:()=>this.surveillanceRenderModule.renderVisionCones(),updateSurveillanceCameras:(s,n)=>this.surveillanceRenderModule.updateSurveillanceCameras(s,n??!1),zoomCameraForCombat:()=>this.cameraModule.zoomCameraForCombat(),restoreCameraAfterCombat:()=>this.cameraModule.restoreCameraAfterCombat(),destroyPlayerVitalsIndicator:()=>this.entityRenderModule.destroyPlayerVitalsIndicator(),destroyCameraSprites:()=>this.surveillanceRenderModule.clearCameraSprites(),setupCameraAndMap:()=>this.cameraModule.setupCameraAndMap(),clearPathPreview:()=>this.inputModule.clearPathPreview(),enablePlayerCameraFollow:()=>this.cameraModule.enablePlayerCameraFollow(),resetCameraRuntimeStateForMapTransition:()=>this.cameraModule.resetForMapTransition(),clearEntityRuntimeStateForMapTransition:()=>this.entityRenderModule.clearForMapTransition(),clearWorldRuntimeStateForMapTransition:()=>this.worldRenderModule.clearForMapTransition(),resetEntityCombatIndicators:()=>this.entityRenderModule.resetCombatIndicators(),readRuntimeState:()=>{var s;return{curfewActive:F.getState().world.curfewActive,inCombat:F.getState().world.inCombat,lastMapAreaId:((s=this.currentMapArea)==null?void 0:s.id)??null,isMapTransitionPending:!1}}}),this.clockModule=new bu(this,{getCurrentGameTime:()=>F.getState().world.currentTime,getAtmosphereRedrawBucket:()=>this.worldRenderModule.getAtmosphereRedrawBucket(),setAtmosphereRedrawBucket:s=>this.worldRenderModule.setAtmosphereRedrawBucket(s),signalAtmosphereRedraw:()=>{this.currentMapArea&&(this.worldRenderModule.drawBackdrop(),this.worldRenderModule.drawMap(this.currentMapArea.tiles))},signalOverlayUpdate:()=>this.dayNightOverlayModule.updateDayNightOverlay(),signalOcclusionUpdate:()=>this.worldRenderModule.applyOcclusionReadability(),dispatchGameTime:s=>{F.dispatch(sa(s))},shouldApplySuspicionDecay:()=>!!F.getState().settings.reputationSystemsEnabled,dispatchSuspicionDecay:(s,n)=>{F.dispatch(ba({elapsedSeconds:s,timestamp:n}))},readRuntimeState:()=>({currentGameTime:F.getState().world.currentTime,timeDispatchAccumulator:0,lastAtmosphereRedrawBucket:this.worldRenderModule.getAtmosphereRedrawBucket(),dispatchCadenceSeconds:.5,atmosphereBucketSeconds:5})});const i=lu(this,{getState:()=>F.getState(),dispatch:F.dispatch},this.moduleDisposables);this.sceneModuleRegistry=new cu(i),this.sceneModuleRegistry.register(this.dayNightOverlayModule),this.sceneModuleRegistry.register(this.minimapBridgeModule),this.sceneModuleRegistry.register(this.surveillanceRenderModule),this.sceneModuleRegistry.register(this.worldRenderModule),this.sceneModuleRegistry.register(this.entityRenderModule),this.sceneModuleRegistry.register(this.inputModule),this.sceneModuleRegistry.register(this.cameraModule),this.sceneModuleRegistry.register(this.stateSyncModule),this.sceneModuleRegistry.register(this.clockModule),this.sceneModuleRegistry.onCreate(),i.listenScale("resize",this.handleResize,this)}queueInitialStateSync(){setTimeout(()=>{var s;if(!this.sys.isActive())return;const i=F.getState();(s=this.sceneModuleRegistry)==null||s.onStateChange(i,i)},0)}handleStateChange(){var s;if(!this.sys.isActive()||!this.currentMapArea)return;const i=F.getState();(s=this.sceneModuleRegistry)==null||s.onStateChange(this.lastStoreSnapshot,i),this.lastStoreSnapshot=i}cleanupScene(){var i,s;(i=this.sceneModuleRegistry)==null||i.onShutdown(),this.sceneModuleRegistry=void 0,this.moduleDisposables.dispose(),this.disposeVisualSettings&&(this.disposeVisualSettings(),this.disposeVisualSettings=void 0),this.disposeLightingSettings&&(this.disposeLightingSettings(),this.disposeLightingSettings=void 0),this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null),(s=this.coverDebugGraphics)==null||s.destroy(),this.coverDebugGraphics=void 0}handleResize(){var i;(i=this.sceneModuleRegistry)==null||i.onResize()}applyLightingSettings(i){this.worldRenderModule.applyLightingSettings(i)}ensureIsoFactory(){this.isoFactory||(this.isoFactory=new ou(this,this.tileSize,this.depthManager)),this.isoFactory.setIsoOrigin(this.isoOriginX,this.isoOriginY)}registerStaticDepth(i,s){this.depthManager.registerStatic(i,s)}syncDepth(i,s,n,a){Ra(this.depthManager,i,s,n,a)}calculatePixelPosition(i,s){return me(i,s,this.isoOriginX,this.isoOriginY,this.tileSize)}getIsoMetrics(){return ge(this.tileSize)}getDiamondPoints(i,s,n,a){return ne(i,s,n,a).map(r=>new P.Geom.Point(r.x,r.y))}}class Qg extends P.Scene{constructor(){super({key:"BootScene"})}preload(){this.load.atlas("props","atlases/props.png","atlases/props.json"),this.load.atlas("esb","atlases/esb_iso_trim_pad.png","atlases/esb_iso_trim_pad.json"),this.load.image("lamp_slim_a_n","normals/lamp_slim_a_n.png")}create(){console.log("[BootScene] create: Fetching initial state and starting MainScene...");const t=F.getState(),i=t.world.currentMapArea,s=t.player.data.position,n=this.textures.get("props"),a=this.textures.get("lamp_slim_a_n");if(n&&a&&n.dataSource.length===0){const c=a.getSourceImage();n.setDataSource(c),this.textures.remove("lamp_slim_a_n")}i||console.error("[BootScene] Error: initialMapArea is null or undefined in Redux state!"),s||console.error("[BootScene] Error: initialPlayerPosition is null or undefined in Redux state!");const r=t.settings.locale,l=ii(r).buildingDefinitions;this.scene.start("MainScene",{mapArea:i,playerPosition:s,buildings:l})}}const nt=e=>`${e.x},${e.y}`,fs=(e,t,i,s={})=>{if(e.x===t.x&&e.y===t.y)return[];const n=s.allowDiagonals===!0,a=n?[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1},{x:1,y:1},{x:-1,y:-1},{x:1,y:-1},{x:-1,y:1}]:[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}],{player:r,enemies:o=[],blockedPositions:l=[],npcs:c=[],ignoreNpcIds:d=[]}=s,u=new Set(l.map(nt)),h=w=>w.x>=0&&w.y>=0&&w.x<i.width&&w.y<i.height,g=w=>{const C=Math.abs(t.x-w.x),R=Math.abs(t.y-w.y);return n?Math.max(C,R):C+R},m=(w,C)=>w.f!==C.f?w.f-C.f:w.h!==C.h?w.h-C.h:w.turnPenalty!==C.turnPenalty?w.turnPenalty-C.turnPenalty:w.position.y!==C.position.y?w.position.y-C.position.y:w.position.x-C.position.x,p=nt(e),v=nt(t),S=new Map,M=new Set,x=new Map,b={position:e,parentKey:null,direction:null,g:0,h:g(e),f:g(e),turnPenalty:0};S.set(p,b),x.set(p,b);const A=()=>{const w=[];let C=v;for(;C!==p;){const R=x.get(C);if(!R)return[];if(w.push(R.position),!R.parentKey)return[];C=R.parentKey}return w.reverse()},I=()=>{let w=null;return S.forEach(C=>{(!w||m(C,w)<0)&&(w=C)}),w};for(;S.size>0;){const w=I();if(!w)break;const C=nt(w.position);if(S.delete(C),M.add(C),C===v)return A();for(const R of a){const k={x:w.position.x+R.x,y:w.position.y+R.y};if(!h(k))continue;const f=nt(k);if(M.has(f))continue;const E=k.x===t.x&&k.y===t.y,B=i.tiles[k.y][k.x];if(!B||!B.isWalkable)continue;if(E){const Ct=r?r.position.x===k.x&&r.position.y===k.y:!1,q=o.some(Z=>Z.position.x===k.x&&Z.position.y===k.y),_=c.some(Z=>!d.includes(Z.id)&&Z.position.x===k.x&&Z.position.y===k.y);if(Ct||q||_)continue}else if(u.has(f)||!ke(k,i,r,o,{npcs:c,ignoreNpcIds:d}))continue;const Y={x:R.x,y:R.y},te=w.direction&&(w.direction.x!==Y.x||w.direction.y!==Y.y)?.001:0,le=w.g+1,Be=g(k),$e=le+Be+te,ve=S.get(f);if(ve&&le>ve.g||ve&&le===ve.g&&m({...ve,h:Be,f:$e,turnPenalty:te},ve)>=0)continue;const Ye={position:k,parentKey:C,direction:Y,g:le,h:Be,f:$e,turnPenalty:te};S.set(f,Ye),x.set(f,Ye)}}return[]},qa=4294967295,Dh=e=>()=>{let t=e+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/(qa+1)},vt=e=>{let t=1779033703^e.length;for(let i=0;i<e.length;i+=1)t=Math.imul(t^e.charCodeAt(i),3432918353),t=t<<13|t>>>19;return(Math.imul(t^t>>>16,2246822507)^Math.imul(t^t>>>13,3266489909))>>>0},ys=(e,t=0)=>{const i=Math.floor(t)>>>0,s=vt(e)^i,n=Dh(s||1),a=()=>n();return{next:a,nextInRange:(r,o)=>{if(o<=r)return r;const l=a();return r+l*(o-r)},fork:r=>{const o=Math.floor(a()*qa);return ys(`${e}:${r}`,o)}}},Me=["idle","patrol","chase","search","attack","inspectNoise","flee","panic"],Cn=e=>e?Me.reduce((t,i)=>(typeof e[i]=="number"&&(t[i]=e[i]),t),{}):{},Lh=e=>Me.reduce((t,i)=>{const s=e[i];return t[i]=typeof s=="number"?Math.max(0,s):0,t},{}),Fh=(e,t,i,s)=>{if(!(!t||t.length===0))for(const n of t){const{state:a,weight:r}=n;let o=0;switch(n.kind){case"healthBelow":i.healthRatio<=n.threshold&&(o=r);break;case"healthAbove":i.healthRatio>=n.threshold&&(o=r);break;case"lineOfSight":i.hasLineOfSight&&(o=r);break;case"lostLineOfSight":i.hasLineOfSight||(o=r);break;case"alertAtLeast":(i.alertLevel??0)>=n.alert&&(o=r);break;case"alertBelow":(i.alertLevel??0)<n.alert&&(o=r);break;case"suppressionAbove":i.suppressionRatio>=n.threshold&&(o=r);break;case"distanceBelow":i.distanceToPlayer<=n.tiles&&(o=r);break;case"distanceAbove":i.distanceToPlayer>=n.tiles&&(o=r);break;case"directorAtLeast":typeof i.directorIntensity=="number"&&i.directorIntensity>=n.threshold&&(o=r);break}if(o!==0){const l=Math.max(0,(e[a]??0)+o);e[a]=l,s[a]=(s[a]??0)+o}}},Bh=(e,t,i)=>{Me.forEach(s=>{const n=t[s];typeof n=="number"&&n>i&&(e[s]=0)})},Oh=(e,t)=>{t<=0||Me.forEach(i=>{e[i]>0&&e[i]<t&&(e[i]=t)})},Nh=(e,t)=>{let i=0;if(Me.forEach(a=>{i+=e[a]}),i<=0)return"idle";const s=t()*i;let n=0;for(const a of Me)if(n+=e[a],s<=n)return a;return Me[Me.length-1]},Hh=(e,t,i,s)=>{const n=t==null?void 0:t[i];typeof n=="number"&&n>0&&(e[i]=s+n)},Wh=(e,t)=>{const i=(t==null?void 0:t.personalitySeed)??vt(e.id),s=ys(`${e.id}:${i}`,i);let n=(t==null?void 0:t.currentState)??e.initialState,a=(t==null?void 0:t.lastTransitionAt)??0;const r=Cn(t==null?void 0:t.cooldowns),o=e.cooldowns??{},l=e.minimumSelectableWeight??0;return{getState:()=>n,getSnapshot:()=>({currentState:n,lastTransitionAt:a,cooldowns:Cn(r),personalitySeed:i}),step:(h,g)=>{const m=Lh(e.baseWeights),p=Me.reduce((b,A)=>(b[A]=0,b),{});Fh(m,e.utilityModifiers,h,p),Bh(m,r,h.now),Oh(m,l),m[n]>0&&(m[n]+=.5);const v=Nh(m,s.next),S=n;v!==n&&(Hh(r,o,v,h.now),n=v,a=h.now);const M={previousState:S,selectedState:v,weights:m,utilityBreakdown:p,now:h.now},x=g==null?void 0:g[v];return x&&x(h,M),{state:v,metadata:M}}}},Gh=e=>{const t=e.suppression??0;return t<=0?0:Math.max(0,Math.min(1,t/100))},qh=({enemy:e,player:t,mapArea:i,squad:s,npcs:n,hasLineOfSight:a,now:r})=>({enemy:e,player:t,mapArea:i,squad:s,civilians:n,hasLineOfSight:a,distanceToPlayer:ue(e.position,t.position),tookRecentDamage:e.health<e.maxHealth,healthRatio:e.maxHealth>0?e.health/e.maxHealth:0,suppressionRatio:Gh(e),alertLevel:e.alertLevel,lastKnownPlayerPosition:e.lastKnownPlayerPosition,directorIntensity:void 0,now:r}),Vh=(e,t)=>({currentState:e.aiState??t,lastTransitionAt:e.aiLastTransitionAt??0,cooldowns:e.aiCooldowns??{},personalitySeed:e.aiPersonalitySeed??vt(e.id)}),zh=(e,t,i,s)=>({...e,aiProfileId:t,aiState:i.currentState,aiLastTransitionAt:i.lastTransitionAt,aiCooldowns:i.cooldowns,aiPersonalitySeed:i.personalitySeed,aiTelemetry:{state:s.selectedState,previousState:s.previousState,weights:{...s.weights},utilities:{...s.utilityBreakdown},updatedAt:s.now}}),ut=(e,t,i,s)=>{if(!Le(e.position,t.position,e.attackRange))return null;if(e.actionPoints<St)return{enemy:{...e,actionPoints:0},player:t,action:"no_ap"};const n=s.some(c=>c.x===t.position.x&&c.y===t.position.y),a=Na(e,t,{isBehindCover:n,mapArea:i});let r=e,o=t;a.newAttacker.id===e.id&&(r=a.newAttacker),a.newTarget.id===t.id&&(o=a.newTarget);const l=a.success?"attack":"attack_missed";return{enemy:r,player:o,action:l,isCritical:a.isCritical}},Uh=(e,t,i,s,n,a)=>{if(!je(t,i))return null;const r=n.filter(l=>l.id!==e.id),o=fs(e.position,t,i,{player:s,enemies:r,npcs:a});return o.length===0?null:o[0]},De=(e,t,i,s,n)=>{const a=Zi(e,t,i,s,n);if(!a)return null;const r=It(e,a);return{enemy:xt(r,e.position,i),player:t,action:"move"}},Yi=(e,t,i,s,n,a)=>{const r=Yh(e,t,i,s,n,a);if(!r)return null;const o=It(e,r);return{enemy:xt(o,e.position,i),player:t,action:"seek_cover"}},Va=(e,t,i,s,n)=>{if(!e.lastKnownPlayerPosition)return null;const a=Uh(e,e.lastKnownPlayerPosition,i,t,s,n);if(!a)return null;const r=It(e,a);return{enemy:xt(r,e.position,i),player:t,action:"search"}},kn=(e,t,i,s,n,a,r)=>{const o=Ss(e.position),l=s.filter(p=>p.id!==e.id),c=o.filter(p=>ms(e,p,i,t,l));if(c.length===0)return null;const d=ys(a,r),u=Math.floor(d.nextInRange(0,c.length)),h=c[u]??c[0],g=It(e,h);return{enemy:xt(g,e.position,i),player:t,action:"inspect_noise"}},Kh=(e,t)=>({enemy:{...e,actionPoints:Math.max(0,e.actionPoints-1)},player:t,action:"idle"}),jh=(e,t,i,s,n,a,r,o)=>{switch(e){case"attack":return ut(t,i,s,r);case"chase":return De(t,i,s,n,a);case"search":return Va(t,i,s,n,a);case"inspectNoise":return kn(t,i,s,n,a,`${t.id}:${o.selectedState}:${o.now}`,vt(t.id));case"flee":case"panic":return Yi(t,i,s,n,r,a);case"patrol":return(t.alertLevel??O.IDLE)>=O.SUSPICIOUS?De(t,i,s,n,a):kn(t,i,s,n,a,`${t.id}:patrol:${o.now}`,vt(t.id));case"idle":return Kh(t,i);default:return null}},Ai=(e,t)=>({enemy:{...e,actionPoints:0},player:t,action:"no_valid_move"}),$h=e=>{if(e){const t=Ko(e);if(t)return t}return Ri[pt]??Object.values(Ri)[0]},Jg=(e,t,i,s,n,a=[],r=Date.now())=>{let o={...e},l={...t};if(e.health<=0)return{enemy:o,player:l,action:"dead"};if(e.actionPoints<=0)return{enemy:o,player:l,action:"no_ap"};if(Le(e.position,t.position,e.attackRange)){const f=ut(e,l,i,n);if(f)return f}const c=$h(e.aiProfileId),d=Vh(e,c.fsm.initialState),u=Wh(c.fsm,d),h=Ga(e,t,i),g=s.filter(f=>f.id!==e.id),m=qh({enemy:e,player:t,mapArea:i,squad:g,npcs:a,hasLineOfSight:h,now:r});let p=null;const v={idle:()=>{p="idle"},patrol:()=>{p="patrol"},chase:()=>{p="chase"},search:()=>{p="search"},attack:()=>{p="attack"},inspectNoise:()=>{p="inspectNoise"},flee:()=>{p="flee"},panic:()=>{p="panic"}},{state:S,metadata:M}=u.step(m,v);let b=jh(p??S,e,l,i,s,a,n,M)??null;if(b||(b=ut(e,l,i,n)??De(e,l,i,s,a)??Yi(e,l,i,s,n,a)??Ai(e,l)),m.hasLineOfSight){const f=b.enemy??e,E=Le(f.position,l.position,f.attackRange);if((b.action==="idle"||b.action==="inspect_noise")&&E){const B=ut(f,l,i,n);B&&(b=B)}else if(b.action==="inspect_noise"&&!E){const B=De(f,l,i,s,a);B&&(b=B)}else if(b.action==="idle"&&!E){const B=De(f,l,i,s,a);B&&(b=B)}}if(!m.hasLineOfSight&&b.action==="idle"){const f=De(e,l,i,s,a);f&&(b=f)}if(!m.hasLineOfSight&&b.action==="inspect_noise"){const f=Va(e,l,i,s,a)??De(e,l,i,s,a);f&&(b=f)}if(m.healthRatio<=.4&&b.action!=="seek_cover"){const f=Yi(e,l,i,s,n,a);f&&(b=f)}if(b.action==="move"&&b.enemy&&b.enemy.position.x===e.position.x&&b.enemy.position.y===e.position.y){const f=Zi(b.enemy,l,i,s,a);if(f){const E=It(b.enemy,f);b={...b,enemy:xt(E,b.enemy.position,i)}}}const A=b.enemy??e,I=Le(A.position,l.position,A.attackRange),w=!!Zi(A,l,i,s,a);b.action==="idle"&&!I&&!w&&(b=Ai(A,l));const C=b.enemy??A,R=Le(C.position,l.position,C.attackRange);if(m.hasLineOfSight&&R&&!["attack","attack_missed","seek_cover","flee","dead","no_ap"].includes(b.action)){const f=ut(C,l,i,n);f&&(b=f)}b.action==="idle"&&!m.hasLineOfSight&&!I&&(b=Ai(b.enemy??e,l));const k=u.getSnapshot();return o=zh(b.enemy,c.id,k,M),l=b.player,{...b,enemy:o,player:l}},Zi=(e,t,i,s,n=[])=>{const a=s.filter(h=>h.id!==e.id),r=Math.max(1,Math.ceil(e.attackRange)),o=[];for(let h=-r;h<=r;h+=1)for(let g=-r;g<=r;g+=1){if(h===0&&g===0)continue;const m={x:t.position.x+h,y:t.position.y+g};je(m,i)&&Le(m,t.position,e.attackRange)&&o.push(m)}const l=o.sort((h,g)=>{const m=ue(e.position,h),p=ue(e.position,g);return m-p});let c=null;for(const h of l){if(!ke(h,i,t,a,{npcs:n}))continue;const g=fs(e.position,h,i,{player:t,enemies:a,npcs:n});if(g.length!==0&&(!c||g.length<c.length)&&(c=g,g.length===1))break}if(c&&c.length>0)return c[0];const u=Ss(e.position).filter(h=>ms(e,h,i,t,a));return u.length===0?null:u.reduce((h,g)=>{const m=ue(g,t.position),p=ue(h,t.position);return m<p?g:h},u[0])},Yh=(e,t,i,s,n,a=[])=>{var h,g;if(n.length===0||(g=(h=i.tiles[e.position.y])==null?void 0:h[e.position.x])!=null&&g.provideCover)return null;const r=s.filter(m=>m.id!==e.id);let o=null;for(const m of n){if(!je(m,i)||!ke(m,i,t,r,{npcs:a}))continue;const p=fs(e.position,m,i,{player:t,enemies:r,npcs:a});if(p.length!==0&&(!o||p.length<o.length)&&(o=p,p.length===1))break}if(o&&o.length>0)return o[0];const c=Ss(e.position).filter(m=>ms(e,m,i,t,r));if(c.length===0)return null;const d=c.filter(m=>n.some(p=>p.x===m.x&&p.y===m.y));if(d.length>0)return d[0];const u=Zh(e.position,n);return u?c.reduce((m,p)=>{const v=ue(p,u),S=ue(m,u);return v<S?p:m},c[0]):null},Zh=(e,t)=>t.length===0?null:t.reduce((i,s)=>{const n=ue(e,s),a=ue(e,i);return n<a?s:i},t[0]),Ss=e=>[{x:e.x+1,y:e.y},{x:e.x-1,y:e.y},{x:e.x,y:e.y+1},{x:e.x,y:e.y-1}],ef=(e,t,i,s=1)=>{let n=O.IDLE;const a=[];return{updatedEnemies:e.map(o=>{if(!o.visionCone)return a.push({enemy:o,playerVisible:!1}),o;const l=Ga(o,t,i);let c=ph(o,l,s);if(l&&(c=mh(c,t.position),c.lastKnownPlayerPosition=t.position),a.push({enemy:c,playerVisible:l}),c.alertLevel){const d=Jt(c.alertLevel),u=Jt(n);d>u&&(n=c.alertLevel)}return c}),maxAlertLevel:n,guardPerception:a}},Jt=e=>{switch(e){case O.IDLE:return 0;case O.SUSPICIOUS:return 1;case O.INVESTIGATING:return 2;case O.ALARMED:return 3;default:return 0}},tf=(e,t)=>{const i=Jt(e);if(Jt(t)<=i)return null;switch(t){case O.SUSPICIOUS:return"alertSuspicious";case O.INVESTIGATING:return"alertInvestigating";case O.ALARMED:return"alertAlarmed";default:return null}},sf=(e,t)=>e===O.ALARMED&&!t,nf=()=>qe.reinforcementDelay,Xh=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}],ei=(e,t)=>{var s;const i=(s=e.tiles[t.y])==null?void 0:s[t.x];return i?i.cover?1:i.provideCover?.75:0:0},Qh=e=>{var t;return((t=e.equipped.weapon)==null?void 0:t.damage)??Ui},za=e=>{var t;return((t=e.equipped.weapon)==null?void 0:t.range)??1},Jh=e=>{var n;const t=((n=e.equipped.weapon)==null?void 0:n.apCost)??St,i=Number.isFinite(e.encumbrance.attackApMultiplier)?Math.max(e.encumbrance.attackApMultiplier,0):Number.POSITIVE_INFINITY,s=ts(e)?0:Math.ceil(Math.max(0,t)*i);return Number.isFinite(s)?s:Number.POSITIVE_INFINITY},vs=e=>e.filter(t=>t.health>0),Tn=(e,t)=>t.length===0?Number.POSITIVE_INFINITY:t.reduce((i,s)=>{const n=ue(e,s.position);return n<i?n:i},Number.POSITIVE_INFINITY),Ua=e=>Number.isFinite(e)?e:Number.NEGATIVE_INFINITY,ep=(e,t)=>{const{player:i,enemies:s,map:n,profile:a}=e,r=vs(s),o=Jh(i);if(!Number.isFinite(o)||o>i.actionPoints)return[];const l=Qh(i),c=za(i),d=ei(n,i.position);return r.filter(u=>Le(i.position,u.position,c)).map(u=>{const h=ue(i.position,u.position),g=u.maxHealth>0?u.health/u.maxHealth:1,m=ei(n,u.position),p=l*(m>0?.75:1),v=(1-g)*a.weights.focusLowestHealth*p,S=a.weights.focusOverwatchThreat*u.damage*.05,M=d<.5?.25:0,x=t?a.weights.retreatBias*(p*.2+(d<.5?2:0)):0,b=i.actionPoints-o,A=b<a.thresholds.apReserve?(a.thresholds.apReserve-b)*.4:0,I=a.weights.attackBias*p+v+S-M-x-A,w=[];return w.push(`Distance ${h}`),w.push(`Expected damage ${p.toFixed(1)}`),v>.1&&w.push("Target vulnerable"),x>.1&&w.push("Panic dampening attack"),A>.1&&w.push("Preserve AP reserve"),{type:"attack",targetId:u.id,targetName:u.name,targetPosition:u.position,expectedDamage:p,apCost:o,distance:h,score:Ua(I),summary:`Attack ${u.name}`,rationale:w}})},tp=(e,t)=>{const{player:i,enemies:s,map:n,profile:a}=e;if(i.actionPoints<=0)return[];const r=vs(s);if(r.length===0)return[];const o=ei(n,i.position),l=Tn(i.position,r),c=za(i),d=[];return Xh.forEach(u=>{const h={x:i.position.x+u.x,y:i.position.y+u.y};if(!ke(h,n,i,r))return;const g=ei(n,h),m=Math.max(0,g-o),p=Tn(h,r),v=l>0?l-p:0,S=a.weights.pursuitAggression*(c>0?v/c:0),M=t||a.weights.retreatBias>.8?a.weights.retreatBias*Math.max(0,p-l):0,x=a.weights.maintainCover*g,b=i.actionPoints-1,A=b<a.thresholds.apReserve?(a.thresholds.apReserve-b)*.35:0,I=x+S+M-Math.max(0,-v)*.1-A,w=[];m>.01?w.push("Gain cover"):g>.4&&w.push("Maintain cover"),v>.2&&w.push("Advance on target"),M>.2&&w.push("Create distance"),A>.1&&w.push("Hold AP reserve"),d.push({type:"move",destination:h,coverGain:m,distanceToNearestEnemy:p,apCost:1,score:Ua(I),summary:m>0?"Move to cover":"Reposition",rationale:w})}),d},ip=()=>({type:"wait",score:-.5,summary:"Hold position",rationale:["No advantageous action"]}),sp=e=>{const{player:t,profile:i,enemies:s}=e;if(vs(s).length===0)return{type:"wait",score:Number.NEGATIVE_INFINITY,summary:"No targets",rationale:["No living enemies"]};const r=(t.maxHealth>0?t.health/t.maxHealth:1)<=i.thresholds.panicHealthFraction,o=ep(e,r),l=tp(e,r),c=ip();return[...o,...l,c].reduce((h,g)=>!h||g.score>h.score?g:h,null)??c},np=ls("AutoBattleController"),Rn=(e,t)=>{if(!e)return t.hudPauseReasons.none;switch(e){case"manual_input":return t.hudPauseReasons.manualInput;case"dialogue":return t.hudPauseReasons.dialogue;case"objective":return t.hudPauseReasons.objective;case"resources":return t.hudPauseReasons.resources;case"ap":return t.hudPauseReasons.ap;case"settings":default:return t.hudPauseReasons.none}},xi=220;class af{constructor(t,i){y(this,"dispatch");y(this,"getState");y(this,"lastSignature",null);y(this,"currentStatus","idle");y(this,"currentReason",null);y(this,"manualOverride",!1);y(this,"turnStartTimestamp",null);y(this,"lastProcessedTurn",null);y(this,"pendingBufferTimeout",null);this.dispatch=t,this.getState=i.getState.bind(i)}notifyManualOverride(t){this.manualOverride=!0,this.lastSignature=null;const s=this.getState().settings.locale,n=xs(s).autoBattle,a=Is(s).logs,r=Rn(t,n);this.dispatch(js({status:"paused",reason:t})),this.dispatch(xe(a.autoBattlePaused(r))),this.currentStatus="paused",this.currentReason=t}update(t){if(!t.enabled){this.resetStatus("idle",null,t),this.manualOverride=!1,this.lastSignature=null,this.clearTurnBuffer(),this.lastProcessedTurn=null;return}if(this.manualOverride){this.resetStatus("paused","manual_input",t),this.clearTurnBuffer();return}if(t.isPlayerTurn){if(this.lastProcessedTurn!==t.turnCount){this.lastProcessedTurn=t.turnCount,this.turnStartTimestamp=this.now(),this.lastSignature=null,this.resetStatus("idle",null,t),this.scheduleBufferedUpdate(xi);return}if(this.turnStartTimestamp!==null){const l=this.now()-this.turnStartTimestamp;if(l<xi){this.scheduleBufferedUpdate(xi-l);return}}}else this.clearTurnBuffer();const i=Ws(t.profileId),s=i.label,n=this.resolveFailSafe(t);if(n){this.resetStatus("paused",n,t),this.lastSignature=null,this.clearTurnBuffer();return}const a=this.buildSignature(t);if(a===this.lastSignature)return;const r=sp({player:t.player,enemies:t.enemies,map:t.mapArea,profile:i});this.dispatch($c(this.buildDecisionSummary(r,i.id))),this.resetStatus("running",null,t);const o=this.buildDecisionDescription(r);this.dispatch(xe(t.logStrings.autoBattleDecision(s,o))),this.executeDecision(r,t),this.lastSignature=a}clearTurnBuffer(){this.pendingBufferTimeout!==null&&(window.clearTimeout(this.pendingBufferTimeout),this.pendingBufferTimeout=null),this.turnStartTimestamp=null}scheduleBufferedUpdate(t){const i=Math.max(0,Math.round(t));this.pendingBufferTimeout!==null&&window.clearTimeout(this.pendingBufferTimeout),this.pendingBufferTimeout=window.setTimeout(()=>{this.pendingBufferTimeout=null;const s=this.buildContextFromStore();s&&this.update(s)},i)}buildContextFromStore(){const t=this.getState(),{autoBattleEnabled:i,autoBattleProfile:s,locale:n}=t.settings,a=t.world,r=a.currentMapArea??null;return{enabled:i,profileId:s,player:t.player.data,enemies:(r==null?void 0:r.entities.enemies)??[],mapArea:r,inCombat:a.inCombat,isPlayerTurn:a.isPlayerTurn,turnCount:a.turnCount,activeDialogueId:t.quests.activeDialogue.dialogueId,logStrings:Is(n).logs,autoBattleStrings:xs(n).autoBattle}}now(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}resolveFailSafe(t){return!t.inCombat||!t.isPlayerTurn||!t.mapArea?"settings":t.player.actionPoints<=0?"ap":t.activeDialogueId?"dialogue":t.enemies.some(i=>i.health>0)?null:"settings"}resetStatus(t,i,s){if(!(this.currentStatus===t&&this.currentReason===i)){if(this.currentStatus=t,this.currentReason=i,this.dispatch(js({status:t,reason:i})),t==="running"){this.dispatch(xe(s.logStrings.autoBattleEngaged(Ws(s.profileId).label)));return}if(t==="paused"){const n=Rn(i,s.autoBattleStrings);this.dispatch(xe(s.logStrings.autoBattlePaused(n)))}}}buildSignature(t){const{player:i}=t;return[t.turnCount,i.actionPoints,i.position.x,i.position.y,t.enemies.map(s=>`${s.id}:${s.health}`).join("|")].join(":")}buildDecisionSummary(t,i){return{profileId:i,action:t.summary,targetId:t.type==="attack"?t.targetId:void 0,targetName:t.type==="attack"?t.targetName:void 0,score:t.score,explanation:t.rationale.join(", "),timestamp:Date.now()}}buildDecisionDescription(t){const i=t.rationale.length>0?t.rationale[0]:"";return i?`${t.summary} (${i})`:t.summary}executeDecision(t,i){switch(t.type){case"attack":this.executeAttack(t,i);break;case"move":this.executeMove(t,i);break;case"wait":default:this.executeWait(i);break}}executeAttack(t,i){var u;const s=this.getState(),n=s.player.data,a=s.world.currentMapArea.entities.enemies.find(h=>h.id===t.targetId);if(!a||a.health<=0){np.warn("Attack target no longer valid; falling back to wait",{targetId:t.targetId}),this.executeWait(i);return}const r=s.world.currentMapArea,o=(u=r.tiles[a.position.y])==null?void 0:u[a.position.x],l=(o==null?void 0:o.provideCover)??!1,c=Na(n,a,{isBehindCover:l,mapArea:r});this.dispatch(Go(c.newAttacker)),this.dispatch(kl(c.newTarget)),c.events&&c.events.forEach(h=>this.dispatch(xe(h.message))),c.success?(this.dispatch(xe(i.logStrings.hitEnemy(t.targetName,Math.round(c.damage??t.expectedDamage)))),this.dispatch(pc({id:oe(),value:Math.round(c.damage??t.expectedDamage),gridX:a.position.x,gridY:a.position.y,type:c.isCritical?"crit":"damage"}))):this.dispatch(xe(i.logStrings.missedEnemy(t.targetName))),c.newAttacker.actionPoints<=0&&this.dispatch(_t())}executeMove(t,i){this.dispatch(Oo(t.destination)),this.dispatch(Fs(-t.apCost)),i.player.actionPoints-t.apCost<=0&&this.dispatch(_t())}executeWait(t){const i=ts(t.player)?0:St;t.player.actionPoints<=i?this.dispatch(_t()):(this.dispatch(Fs(-t.player.actionPoints)),this.dispatch(_t()))}}export{Hg as $,O as A,Qg as B,$ as C,G as D,Cl as E,Kg as F,fl as G,zg as H,ls as I,nf as J,zm as K,Ap as L,Xg as M,Mp as N,Yp as O,$p as P,Dm as Q,At as R,vp as S,Th as T,Bp as U,Tm as V,_u as W,pc as X,qm as Y,Eg as Z,Og as _,vg as a,Or as a$,af as a0,Iu as a1,zi as a2,Zg as a3,fs as a4,ke as a5,D as a6,hp as a7,gp as a8,fp as a9,Fs as aA,yg as aB,Bg as aC,Fg as aD,Bm as aE,Am as aF,to as aG,Lm as aH,yp as aI,Ip as aJ,ns as aK,Pi as aL,ku as aM,Cu as aN,Xm as aO,up as aP,Lr as aQ,ss as aR,Cp as aS,Gm as aT,Wm as aU,Hm as aV,Um as aW,Ci as aX,Eu as aY,cg as aZ,$m as a_,Sm as aa,Oo as ab,Mg as ac,bm as ad,Tg as ae,ef as af,qe as ag,kl as ah,kg as ai,tf as aj,sf as ak,Pm as al,Pp as am,_t as an,_m as ao,Jg as ap,dg as aq,Go as ar,sm as as,St as at,ts as au,Le as av,Na as aw,ng as ax,Km as ay,wm as az,pg as b,mp as b0,pp as b1,Ep as b2,Zm as b3,Qm as b4,vm as b5,F as b6,Yg as b7,zd as b8,bp as b9,$t as bA,Wp as bB,Kp as bC,qp as bD,zp as bE,Sp as bF,Vp as bG,Up as bH,im as bI,rm as bJ,Pt as ba,hg as bb,em as bc,tm as bd,_p as be,tg as bf,ig as bg,El as bh,Tl as bi,rc as bj,ag as bk,Gs as bl,jg as bm,eo as bn,is as bo,Tr as bp,am as bq,Ln as br,dp as bs,Xi as bt,yr as bu,cp as bv,lm as bw,om as bx,Np as by,Hp as bz,Fi as c,mg as d,Sg as e,xe as f,gg as g,fg as h,Em as i,Rm as j,Ha as k,Ig as l,Wa as m,pm as n,ym as o,dm as p,um as q,Cg as r,xg as s,gm as t,oi as u,Dg as v,Ag as w,Bi as x,Ni as y,Ug as z};
