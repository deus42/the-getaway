const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/GameMenu-CLfAxnfK.js","assets/vendor-Cc93p67d.js","assets/phaser-DkaA9Y8j.js","assets/game-content-CQeS209Q.js","assets/game-core-rSlhvLSb.js","assets/EnhancedButton-DVdhyrz_.js","assets/CharacterCreationScreen-CNJ7JNkw.js","assets/Tooltip-CnX58fCC.js","assets/CharacterScreen-DCP4_Mlb.js","assets/LevelUpModal-BVD2FLv7.js","assets/PerkSelectionPanel-DGpYa3F2.js","assets/LevelUpPointAllocationPanel-CBufruiv.js"])))=>i.map(i=>d[i]);
var Cs=Object.defineProperty;var Ts=(e,t,n)=>t in e?Cs(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var Ce=(e,t,n)=>Ts(e,typeof t!="symbol"?t+"":t,n);import{r as c,u as E,j as s,e as X,f as De,g as Ps,R as Lt,P as _s,h as As}from"./vendor-Cc93p67d.js";import{P as ze}from"./phaser-DkaA9Y8j.js";import{B as Rs,M as Ds,u as js,C as J,w as Ls,l as cr,c as Me,r as La,s as Ns,A as we,a as Os,b as zs,d as Na,e as Oa,f as F,g as dr,h as Fs,i as za,j as Yt,k as Pn,m as _n,n as Bs,o as Hs,p as Ws,q as ur,t as $s,v as Us,x as Gs,y as Vs,R as qs,z as fr,D as mr,E as Ys,F as Ks,N as pr,G as Xs,H as Wn,I as Qs,J as Fa,K as Zs,L as gr,O as Js,S as hr,P as ei,Q as dn,T as br,U as ti,V as Ba,W as ni,X as ri,Y as Tt,Z as yr,_ as un,$ as ai,a0 as xr,a1 as si,a2 as ii,a3 as wr,a4 as fn,a5 as vr,a6 as Pt,a7 as $t,a8 as Sr,a9 as $n,aa as ht,ab as Qt,ac as Ir,ad as Ut,ae as Kt,af as _t,ag as oi,ah as li,ai as mn,aj as pn,ak as kr,al as ci,am as di,an as Er,ao as gt,ap as Je,aq as ui,ar as fi,as as mi,at as Mr,au as pi,av as gi,aw as hi,ax as gn,ay as bi,az as An,aA as Zt,aB as yi,aC as xi,aD as wi,aE as vi,aF as Si,aG as Ii,aH as ki,aI as Ei,aJ as Mi,aK as Rn,aL as Ci,aM as et,aN as Cr,aO as Ti,aP as Pi,aQ as _i,aR as Ai,aS as Ri,aT as Di,aU as ji,aV as Li,aW as Ha,aX as Ni,aY as Oi,aZ as Jt,a_ as zi,a$ as Fi,b0 as Bi,b1 as Hi,b2 as Wi,b3 as $i,b4 as Ui,b5 as Gi,b6 as Vi,b7 as xe,b8 as Wa,b9 as qi,ba as Yi,bb as Tr,bc as Ki,bd as Xi,be as hn,bf as Qi}from"./game-core-rSlhvLSb.js";import{o as Xe,P as he,n as Pe,v as We,p as Zi,e as Ji}from"./game-content-CQeS209Q.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}})();const eo="modulepreload",to=function(e){return"/the-getaway/"+e},Pr={},bt=function(t,n,r){let a=Promise.resolve();if(n&&n.length>0){let l=function(m){return Promise.all(m.map(f=>Promise.resolve(f).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),d=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));a=l(n.map(m=>{if(m=to(m),m in Pr)return;Pr[m]=!0;const f=m.endsWith(".css"),u=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${m}"]${u}`))return;const h=document.createElement("link");if(h.rel=f?"stylesheet":eo,f||(h.as="script"),h.crossOrigin="",h.href=m,d&&h.setAttribute("nonce",d),document.head.appendChild(h),f)return new Promise((v,x)=>{h.addEventListener("load",v),h.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${m}`)))})}))}function o(l){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=l,window.dispatchEvent(i),!i.defaultPrevented)throw l}return a.then(l=>{for(const i of l||[])i.status==="rejected"&&o(i.reason);return t().catch(o)})},no=({onRendererInfo:e})=>{const t=c.useRef(null),n=c.useRef(null),[r,a]=c.useState({label:"Detecting…",detail:"Negotiating renderer"}),o=c.useRef({width:0,height:0});c.useEffect(()=>{if(console.log("[GameCanvas] useEffect running"),console.log("[GameCanvas] gameContainerRef.current:",t.current),!t.current){console.error("[GameCanvas] No container ref available");return}const m=t.current.offsetWidth,f=t.current.offsetHeight;console.log("[GameCanvas] Container dimensions:",{parentWidth:m,parentHeight:f});const u=R=>{switch(R){case ze.WEBGL:return{label:"WebGL",detail:"GPU accelerated (shaders, batching)",type:R};case ze.CANVAS:return{label:"Canvas",detail:"CPU rasterization fallback",type:R};case ze.HEADLESS:return{label:"Headless",detail:"No renderer active",type:R};default:return{label:"Detecting…",detail:"Negotiating renderer",type:R}}},h=()=>{const R=n.current;if(!R||!R.renderer){a({label:"Detecting…",detail:"Negotiating renderer",type:void 0});return}const $=u(R.renderer.type);a($)},v={type:ze.AUTO,width:m>0?m:800,height:f>0?f:600,backgroundColor:"#05070d",parent:t.current,scene:[Rs,Ds],scale:{mode:ze.Scale.FIT,autoCenter:ze.Scale.CENTER_BOTH,width:m>0?m:800,height:f>0?f:600},render:{antialias:!0,pixelArt:!1,roundPixels:!1,transparent:!1,powerPreference:"high-performance"},physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!1}},pixelArt:!1,roundPixels:!1,transparent:!1};if(console.log("[GameCanvas] Phaser config:",v),!n.current)try{n.current=new ze.Game(v);const R=n.current;R.isBooted?h():R.events.once(ze.Core.Events.READY,h),console.log("[GameCanvas] Phaser game initialized successfully")}catch(R){console.error("[GameCanvas] Error initializing Phaser:",R)}let x,b=null;const C={width:m,height:f},_=(R,$)=>{if(!n.current)return;const A=Math.max(0,Math.floor(R)),Y=Math.max(0,Math.floor($));if(A===0||Y===0)return;const{width:te,height:fe}=o.current;if(te===A&&fe===Y)return;o.current={width:A,height:Y},n.current.scale.resize(A,Y)},y=(R,$)=>{typeof R=="number"&&typeof $=="number"?(C.width=R,C.height=$):t.current&&(C.width=t.current.offsetWidth,C.height=t.current.offsetHeight),b!==null&&window.clearTimeout(b),b=window.setTimeout(()=>{b=null,_(C.width,C.height)},40)},N=()=>{y()};return typeof ResizeObserver<"u"&&t.current&&(x=new ResizeObserver(R=>{const $=R[0];$&&y($.contentRect.width,$.contentRect.height)}),x.observe(t.current)),window.addEventListener("resize",N),()=>{console.log("[GameCanvas] Cleanup running"),window.removeEventListener("resize",N),b!==null&&window.clearTimeout(b),x&&x.disconnect(),n.current&&(n.current.events.off(ze.Core.Events.READY,h),n.current.destroy(!0),n.current=null,console.log("[GameCanvas] Phaser game destroyed"))}},[]),console.log("[GameCanvas] Rendering component");const l=E(m=>m.settings.testMode),i=E(m=>m.settings.lightsEnabled),d=E(m=>m.settings.visualQualityPreset);return c.useEffect(()=>{js({lightsEnabled:i,qualityPreset:d})},[i,d]),c.useEffect(()=>{n.current&&window.requestAnimationFrame(()=>{window.dispatchEvent(new Event("resize"))})},[l]),c.useEffect(()=>{e&&e(r)},[e,r]),s.jsx("div",{style:{position:"relative",width:"100%",height:"100%",backgroundColor:"var(--color-gunmetal-900)",overflow:"hidden",display:"flex",justifyContent:"center",alignItems:"center",pointerEvents:"none"},children:s.jsx("div",{ref:t,style:{position:"absolute",width:"100%",height:"100%",top:0,left:0,right:0,bottom:0,display:"flex",justifyContent:"center",alignItems:"center",backgroundColor:"var(--color-gunmetal-900)",minWidth:"400px",minHeight:"300px",pointerEvents:"auto"}})})},ro=()=>({type:"wait",score:0,summary:"Hold position",rationale:["No safer move available"]}),ao=e=>ro(),bn=typeof window<"u"?window:globalThis;class so{constructor(){Ce(this,"timeouts",new Set)}schedule(t,n){const r=bn.setTimeout(()=>{this.timeouts.delete(r),t()},n);return this.timeouts.add(r),r}cancel(t){t!=null&&(bn.clearTimeout(t),this.timeouts.delete(t))}dispose(){this.timeouts.forEach(t=>{bn.clearTimeout(t)}),this.timeouts.clear()}}const io=()=>new so,Ee=["evening","night"],oo=[{zoneId:"downtown_checkpoint",cameras:[{id:"downtown_training_static",type:"static",position:{x:28,y:18},range:6,fieldOfView:90,activationPhases:Ee,sweep:{angles:[300,270,240],cycleDurationMs:2600}},{id:"downtown_static_01",type:"static",position:{x:18,y:22},range:8,fieldOfView:90,activationPhases:Ee,sweep:{angles:[310,270,230],cycleDurationMs:3200}},{id:"downtown_static_02",type:"static",position:{x:52,y:20},range:8,fieldOfView:90,activationPhases:Ee,sweep:{angles:[45,90,135],cycleDurationMs:3e3}},{id:"downtown_motion_01",type:"motionSensor",position:{x:36,y:44},range:4,fieldOfView:360,activationPhases:Ee,motionRadius:4},{id:"downtown_drone_01",type:"drone",position:{x:70,y:16},range:10,fieldOfView:90,activationPhases:Ee,patrolPath:{waypoints:[{x:70,y:16},{x:78,y:28},{x:64,y:34},{x:56,y:22}],travelDurationMs:12e3},sweep:{angles:[0,45,0,-45],cycleDurationMs:2800}}]},{zoneId:"gov_complex",cameras:[{id:"gov_static_01",type:"static",position:{x:14,y:12},range:9,fieldOfView:90,activationPhases:Ee,sweep:{angles:[315,270,225,180],cycleDurationMs:3600}},{id:"gov_static_02",type:"static",position:{x:40,y:10},range:9,fieldOfView:90,activationPhases:Ee,sweep:{angles:[0,45,90],cycleDurationMs:3600}},{id:"gov_motion_01",type:"motionSensor",position:{x:27,y:26},range:4,fieldOfView:360,activationPhases:Ee,motionRadius:4},{id:"gov_motion_02",type:"motionSensor",position:{x:48,y:26},range:4,fieldOfView:360,activationPhases:Ee,motionRadius:4},{id:"gov_drone_01",type:"drone",position:{x:56,y:18},range:12,fieldOfView:90,activationPhases:Ee,patrolPath:{waypoints:[{x:56,y:18},{x:70,y:24},{x:60,y:36},{x:46,y:28}],travelDurationMs:14e3},sweep:{angles:[15,0,-15],cycleDurationMs:2600}},{id:"gov_static_03",type:"static",position:{x:32,y:6},range:9,fieldOfView:90,activationPhases:Ee,sweep:{angles:[200,240,280],cycleDurationMs:3400}}]},{zoneId:"corporate_plaza",cameras:[{id:"corp_static_01",type:"static",position:{x:12,y:12},range:8,fieldOfView:90,activationPhases:Ee,sweep:{angles:[40,0,-40],cycleDurationMs:3e3}},{id:"corp_motion_01",type:"motionSensor",position:{x:26,y:22},range:4,fieldOfView:360,activationPhases:Ee,motionRadius:4},{id:"corp_drone_01",type:"drone",position:{x:34,y:14},range:10,fieldOfView:90,activationPhases:Ee,patrolPath:{waypoints:[{x:34,y:14},{x:42,y:16},{x:40,y:28},{x:30,y:24}],travelDurationMs:1e4},sweep:{angles:[90,120,90,60],cycleDurationMs:2400}}]},{zoneId:"industrial_corridor",cameras:[{id:"ind_static_01",type:"static",position:{x:8,y:32},range:9,fieldOfView:90,activationPhases:Ee,sweep:{angles:[180,210,240],cycleDurationMs:3200}},{id:"ind_motion_01",type:"motionSensor",position:{x:22,y:40},range:4,fieldOfView:360,activationPhases:Ee,motionRadius:4}]},{zoneId:"resistance_safehouse",cameras:[]}],lo=e=>{const t=oo.find(n=>n.zoneId===e);return t?t.cameras.map(n=>({...n})):[]},co=400,uo=3200,$a=e=>{const t=typeof e=="number"&&Number.isFinite(e)?Math.abs(e):uo;return Math.max(co,t)},Dt=e=>{const t=Ls(e);return t<0?t+360:t},fo=e=>{var r;const t=((r=e.sweep)==null?void 0:r.angles)??[],n=t.length>0?Dt(t[0]):Dt(e.fieldOfView>=360?0:e.fieldOfView/2);return{...e,alertState:J.IDLE,detectionProgress:0,isActive:!1,hackState:{},lastDetectionTimestamp:void 0,currentDirection:n,sweepDirection:1,sweepElapsedMs:0,sweepIndex:0,patrolProgressMs:0,currentWaypointIndex:0,networkAlertContributionAt:void 0,trackingPlayer:!1,trackingDirection:void 0}},Ua=(e,t,n,r)=>{const a=e.sweep;if(!a||a.angles.length===0)return{direction:n?r:e.currentDirection,sweepDirection:e.sweepDirection??1,sweepIndex:e.sweepIndex??0,sweepElapsedMs:e.sweepElapsedMs??0};const o=a.angles,l=o.length;if(l===1){const y=n?r+o[0]:o[0];return{direction:Dt(y),sweepDirection:e.sweepDirection??1,sweepIndex:0,sweepElapsedMs:0}}let i=e.sweepDirection??1,d=Me(e.sweepIndex??0,0,l-1),m=(e.sweepElapsedMs??0)+t;const f=$a(a.cycleDurationMs)/(l-1);for(;m>=f;){m-=f;let y=d+i;y>=l?(i=-1,y=l-2):y<0&&(i=1,y=1),d=Me(y,0,l-1)}const u=Me(d+i,0,l-1),h=Me(f===0?0:m/f,0,1),v=o[d],x=o[u],b=Ns(v,x),C=v+b*h,_=n?r+C:C;return{direction:Dt(_),sweepDirection:i,sweepIndex:d,sweepElapsedMs:m}},Ga=(e,t)=>{const n=Ua(e,t,!1,0);return e.currentDirection=n.direction,e.sweepDirection=n.sweepDirection,e.sweepIndex=n.sweepIndex,e.sweepElapsedMs=n.sweepElapsedMs,e},yn=(e,t)=>t===0?0:e<0?t-1:e>=t?0:e,mo=(e,t)=>{const n=e.patrolPath;if(!n||n.waypoints.length===0)return Ga(e,t);const r=n.waypoints,a=$a(n.travelDurationMs)/r.length;let o=(e.patrolProgressMs??0)+t,l=yn(e.currentWaypointIndex??0,r.length),i=yn(l+1,r.length);for(;o>=a;)o-=a,l=i,i=yn(l+1,r.length);const d=r[l],m=r[i],f=a<=0?0:Me(o/a,0,1),u=cr(d.x,m.x,f),h=cr(d.y,m.y,f),v=Math.atan2(m.y-d.y,m.x-d.x),x=La(v),b=Ua(e,t,!0,x);return e.position={x:u,y:h},e.currentDirection=b.direction,e.currentWaypointIndex=l,e.patrolProgressMs=o,e.sweepDirection=b.sweepDirection,e.sweepIndex=b.sweepIndex,e.sweepElapsedMs=b.sweepElapsedMs,e},po=(e,t)=>{let n;switch(e.type){case"drone":n=mo(e,t);break;case"motionSensor":case"static":default:n=Ga(e,t);break}return n.trackingPlayer&&typeof n.trackingDirection=="number"&&(n.currentDirection=Dt(n.trackingDirection)),n},go=(e,t)=>{const{hackState:n}=e;return n?!!(n.disabledUntil&&n.disabledUntil>t):!1},ho=(e,t)=>{const{hackState:n}=e;return!!(n!=null&&n.loopFootageUntil&&n.loopFootageUntil>t)},xn=e=>{switch(e){case we.IDLE:return 0;case we.SUSPICIOUS:return 1;case we.INVESTIGATING:return 2;case we.ALARMED:return 3;default:return 0}},Va=(e,t)=>{const n=e.x-t.x,r=e.y-t.y;return Math.sqrt(n*n+r*r)},qa=(e,t)=>t.blackoutTier==="rolling"?.55:t.blackoutTier==="brownout"?.65:e==="night"?.7:e==="evening"||e==="morning"?.85:1,Ya=e=>{var l;const t=((l=e.skillTraining)==null?void 0:l.stealth)??0,n=e.skills.agility??5,r=Math.min(t/120,.35),a=Math.max(0,(n-6)*.03),o=Math.min(.45,r+a);return Me(1-o,.55,1)},Ka=e=>{switch(e.movementProfile){case"silent":return .7;case"sprint":return 1.15;default:return 1}},bo=e=>{const t=e.label;return typeof t=="string"&&t.trim().length>0?t:e.id.split(/[_-]/g).map(n=>n.charAt(0).toUpperCase()+n.slice(1)).join(" ")},yo=({enemy:e,player:t,mapArea:n,timeOfDay:r,environmentFlags:a,playerVisible:o,timestamp:l})=>{const i=e.visionCone;if(!i||!o)return null;const d=e.alertLevel??we.IDLE,m=Va(e.position,t.position),f=i.range||8,u=Me(.7+xn(d)*.06,.6,.95),h=Me(1-m/(f+1),.25,1),v=qa(r,a),x=Ya(t),b=Ka(t);return{witnessId:e.id,witnessLabel:e.name??"Guard",targetId:t.id,zoneId:n.zoneId,areaId:n.id,timestamp:l,source:"guard",recognitionChannel:"face",baseCertainty:u,distanceModifier:h,lightingModifier:v,disguiseModifier:x,postureModifier:b,reported:xn(d)>=xn(we.INVESTIGATING),location:{...e.position}}},xo=({camera:e,player:t,mapArea:n,timeOfDay:r,environmentFlags:a,timestamp:o,alertState:l})=>{const i=Va(e.position,t.position),d=e.range||8,m=l===J.ALARMED?.88:l===J.SUSPICIOUS?.65:.5,f=Me(1-i/(d+1),.3,1),u=qa(r,a),h=Ya(t),v=Ka(t);return{witnessId:e.id,witnessLabel:bo(e),targetId:t.id,zoneId:n.zoneId,areaId:n.id,timestamp:o,source:"camera",recognitionChannel:"face",baseCertainty:m,distanceModifier:f,lightingModifier:u,disguiseModifier:h,postureModifier:v,reported:l===J.ALARMED,location:{...e.position}}},wo=100/3e3,_r=100/4e3,vo=6e4,So=5*60*1e3,en={},Ue={},Xa=(e,t)=>!e.activationPhases||e.activationPhases.length===0?!0:e.activationPhases.includes(t),Io=e=>{const t=e%360;return t<0?t+360:t},ko=(e,t)=>{const n=Math.atan2(t.position.y-e.position.y,t.position.x-e.position.x),r=La(n);return Io(r)},Qa=(e,t)=>{const n=t.x-e.x,r=t.y-e.y;return Math.sqrt(n*n+r*r)},Za=(e,t)=>{var r;const n=(r=e.skillTraining)==null?void 0:r[t];return typeof n=="number"?n:0},Eo=(e,t)=>{const n=e.type==="motionSensor"?e.motionRadius??e.range:e.range,r=Za(t,"stealth"),a=Me(r/200,0,.75);let o=n*(1-a);const l=t.movementProfile==="silent"?.8:t.movementProfile==="sprint"?1.2:1;return o*=l,t.stealthModeEnabled&&(o*=.75),Math.max(1,o)},Mo=(e,t,n,r,a,o,l)=>{if(!e.isActive)return{state:J.DISABLED,progress:0,detectionActive:!1,lastDetectionTimestamp:void 0};if(go(t,l))return{state:J.DISABLED,progress:0,detectionActive:!1,lastDetectionTimestamp:void 0};const i=ho(t,l),d=Eo(e,n),m=Qa(e.position,n.position);let f=!1;if(!i)if(e.type==="motionSensor"){const x=n.movementProfile!=="silent";f=m<=d&&a&&x}else Pn(e.position,n.position,{range:d,angle:e.fieldOfView,direction:e.currentDirection})&&_n(e.position,n.position,r)&&(f=!0);let u=t.detectionProgress,h=t.lastDetectionTimestamp;if(f){const x=Za(n,"hacking"),b=Me(x/400,0,.25),C=n.movementProfile==="silent"?.7:n.movementProfile==="sprint"?1.2:1,_=n.stealthModeEnabled?.75:1;u+=wo*o*(1-b)*C*_,u=Math.min(100,u),h=l}else{const x=t.trackingPlayer?_r*1.8:_r;u-=x*o,u=Math.max(0,u)}let v=J.IDLE;return u>=100?(v=J.ALARMED,u=100):u>0&&(v=J.SUSPICIOUS),{state:v,progress:u,detectionActive:f,lastDetectionTimestamp:h}},Co=(e,t,n)=>{Ue[e]||(Ue[e]=[]),Ue[e].push({cameraId:t,timestamp:n}),Ue[e]=Ue[e].filter(r=>n-r.timestamp<=vo)},To=e=>{const t=Ue[e];return t?t.length>=3:!1},Po=e=>{const{area:t,timeOfDay:n,dispatch:r,timestamp:a}=e,l=lo(t.zoneId).map(i=>{const d=fo(i),m=Xa(d,n);return d.isActive=m,d.alertState=m?J.IDLE:J.DISABLED,d.detectionProgress=0,d.lastDetectionTimestamp=void 0,d});r(zs({areaId:t.id,zoneId:t.zoneId,cameras:l,timestamp:a})),en[t.id]={lastPlayerPosition:void 0,lastUpdateTimestamp:a,hudSnapshot:void 0},Ue[t.id]=[]},Ar=e=>{const{areaId:t,dispatch:n}=e;n(Os({areaId:t})),delete en[t],delete Ue[t]},_o=e=>{const{zone:t,area:n,timeOfDay:r,dispatch:a,timestamp:o}=e;if(!t||!n)return;const l=[];let i=!1;Object.values(t.cameras).forEach(d=>{const m=Xa(d,r);if(m===d.isActive&&(m||d.alertState===J.DISABLED&&(d.detectionProgress??0)===0))return;const f={isActive:m,detectionProgress:m?d.detectionProgress:0,lastDetectionTimestamp:m?d.lastDetectionTimestamp:void 0,alertState:m?J.IDLE:J.DISABLED,trackingPlayer:!1,trackingDirection:void 0};m?i=!0:i=i||d.isActive,l.push({cameraId:d.id,changes:f})}),l.forEach(d=>{a(Na({areaId:t.areaId,cameraId:d.cameraId,changes:d.changes,timestamp:o}))}),i&&r!=="day"&&r!=="morning"&&a(Oa({visible:!0,timestamp:o}))},Ao=e=>{const{zone:t,mapArea:n,player:r,deltaMs:a,timestamp:o,dispatch:l,logStrings:i,reinforcementsScheduled:d,globalAlertLevel:m,timeOfDay:f,environmentFlags:u,worldTimeSeconds:h,onWitnessObservation:v}=e,x=en[t.areaId]??{lastPlayerPosition:void 0},b=x.lastPlayerPosition,C=b?b.x!==r.position.x||b.y!==r.position.y:!1,_=T=>{switch(T){case J.ALARMED:return 3;case J.SUSPICIOUS:return 2;case J.IDLE:return 1;case J.DISABLED:default:return 0}},y=T=>T.type==="motionSensor"?T.motionRadius??T.range:T.range;let N=0,R=0,$=J.IDLE,A=null;const Y=[];let te=!1,fe=!1;Object.values(t.cameras).forEach(T=>{const I={...T,position:{...T.position},hackState:{...T.hackState}};po(I,a);const q=Mo(I,T,r,n,C,a,o);if(I.alertState=q.state,I.detectionProgress=q.progress,I.lastDetectionTimestamp=q.lastDetectionTimestamp,I.alertState===J.DISABLED&&(I.detectionProgress=0),I.type!=="motionSensor")if(I.isActive&&q.detectionActive&&(I.alertState===J.SUSPICIOUS||I.alertState===J.ALARMED)){const ne=ko(I,r);I.trackingPlayer=!0,I.trackingDirection=ne,I.currentDirection=ne}else I.trackingPlayer&&(I.trackingPlayer=!1,I.trackingDirection=void 0);else I.trackingPlayer&&(I.trackingPlayer=!1,I.trackingDirection=void 0);const ee=I.alertState!==T.alertState,de=I.currentDirection!==T.currentDirection,be=I.position.x!==T.position.x||I.position.y!==T.position.y,G=Math.abs(I.detectionProgress-T.detectionProgress)>.1,Q=I.lastDetectionTimestamp!==T.lastDetectionTimestamp,le=I.sweepDirection!==T.sweepDirection||I.sweepIndex!==T.sweepIndex||Math.abs((I.sweepElapsedMs??0)-(T.sweepElapsedMs??0))>.1,ue=(I.trackingPlayer??!1)!==(T.trackingPlayer??!1),ie=I.trackingDirection!==T.trackingDirection;if(ee&&(I.alertState===J.SUSPICIOUS||I.alertState===J.ALARMED)){const D=xo({camera:I,player:r,mapArea:n,timeOfDay:f,environmentFlags:u,timestamp:h,alertState:I.alertState});v&&v(D)}if((ee||de||be||G||Q||le||ue||ie)&&Y.push({cameraId:T.id,runtime:I,previous:T}),ee&&I.alertState===J.ALARMED&&(fe=!0,Co(t.areaId,T.id,o)),I.isActive&&I.alertState!==J.DISABLED){const D=y(I);Qa(I.position,r.position)<=D+.5&&(N+=1)}I.detectionProgress>R&&(R=I.detectionProgress,A=T.id),_(I.alertState)>_($)&&($=I.alertState)}),Y.forEach(({cameraId:T,runtime:I,previous:q})=>{const ee={alertState:I.alertState,detectionProgress:I.detectionProgress,currentDirection:I.currentDirection,lastDetectionTimestamp:I.lastDetectionTimestamp,position:I.position,sweepDirection:I.sweepDirection,sweepIndex:I.sweepIndex,sweepElapsedMs:I.sweepElapsedMs,patrolProgressMs:I.patrolProgressMs,currentWaypointIndex:I.currentWaypointIndex,trackingPlayer:I.trackingPlayer,trackingDirection:I.trackingDirection};I.isActive||(ee.detectionProgress=0,ee.alertState=J.DISABLED,ee.lastDetectionTimestamp=void 0,ee.trackingPlayer=!1,ee.trackingDirection=void 0),l(Na({areaId:t.areaId,cameraId:T,changes:ee,timestamp:o})),q.alertState!==I.alertState&&(I.alertState===J.SUSPICIOUS&&q.alertState===J.IDLE&&l(F(i.alertSuspicious)),I.alertState===J.ALARMED&&q.alertState!==J.ALARMED&&l(F(i.alertAlarmed)))});const me=Ue[t.areaId]??[];let g=t.networkAlert;if(g&&g.expiresAt<=o&&(l(dr({areaId:t.areaId,alert:null})),g=null),!g&&To(t.areaId)){te=!0;const T=me.slice(-3).map(I=>I.cameraId);g={triggeredAt:o,expiresAt:o+So,contributingCameraIds:T},l(dr({areaId:t.areaId,alert:g}))}const w={camerasNearby:N,detectionProgress:Number(Math.min(100,R).toFixed(2)),alertState:$,activeCameraId:A,networkAlertActive:!!g,networkAlertExpiresAt:(g==null?void 0:g.expiresAt)??null},S=x.hudSnapshot;(!S||S.camerasNearby!==w.camerasNearby||Math.abs(S.detectionProgress-w.detectionProgress)>.5||S.alertState!==w.alertState||S.activeCameraId!==w.activeCameraId||S.networkAlertActive!==w.networkAlertActive||S.networkAlertExpiresAt!==w.networkAlertExpiresAt)&&(l(Fs(w)),x.hudSnapshot=w),fe&&!d?(l(F(i.reinforcementsIncoming)),l(za()),l(Yt(we.ALARMED))):te?(l(F(i.curfewReinforcement)),l(Yt(we.ALARMED))):fe&&m!==we.ALARMED&&l(Yt(we.ALARMED)),en[t.areaId]={...x,lastPlayerPosition:{...r.position},lastUpdateTimestamp:o}},tt=[],Ro=e=>{const t=tt.findIndex(n=>n.id===e.id);if(t>=0){tt[t]={...tt[t],...e},tt[t].fired=!1,tt[t].lastFiredAt=void 0;return}tt.push({...e})},Do=e=>{e.forEach(Ro)},jo=(e,t,n=Date.now())=>{const r=t();tt.forEach(a=>{a.once&&a.fired||typeof a.cooldownMs=="number"&&a.lastFiredAt!==void 0&&n-a.lastFiredAt<a.cooldownMs||!a.when(r)||(a.fire({dispatch:e,getState:t,now:n}),a.lastFiredAt=n,a.once&&(a.fired=!0))})},Lo={low:[{id:"rumor.low.coyotes-logo",groupId:"slum-barflies",flag:"gangHeat",value:"low",storyFunction:"world-building",description:"Warm-up chatter when the streets are calm.",lines:["Coyotes rebranded again. Same howls, new accounting font.","CorpSec confiscated their synth-leather jackets. Fashion crime unit, I guess.","If the gang war is over, someone forgot to tell the bullet holes."]},{id:"rumor.low.tax-audit",groupId:"dock-liquor-patrons",flag:"gangHeat",value:"low",storyFunction:"foreshadow",description:"Hints at upcoming tensions despite low heat.",lines:["Heard the Coyotes scheduled a tax audit. They grow up so fast.","You know it’s quiet when the bartops stop vibrating.","Peace smells like ozone and unpaid protection money."]}],med:[{id:"rumor.med.return",groupId:"slum-barflies",flag:"gangHeat",value:"med",storyFunction:"misdirect",description:"Contradicts official statements to set up later payoffs.",lines:["Coyotes are back. Again. They brought merch this time.","Saw their lieutenant handing out coupons for muggings. 20% off with code “WHOOPS”.","If the city says everything is fine, duck."]},{id:"rumor.med.payroll",groupId:"dock-liquor-patrons",flag:"gangHeat",value:"med",storyFunction:"payoff",description:"Signals growing pressure around the docks.",lines:["Dock payroll went missing. Must have taken the scenic route through a heist.","CorpSec switched to hazard pay. They called it “enthusiasm adjustment”.","Graffiti keeps spelling “WE ARE TEMPORARY”. Someone stamped “UNTIL AUDIT COMPLETE” on top."]}],high:[{id:"rumor.high.curfew",groupId:"slum-barflies",flag:"gangHeat",value:"high",storyFunction:"foreshadow",description:"Signals impending clampdowns.",lines:["Curfew now starts before brunch. Crime brunch still sold out.","Coyotes swapped bullets for invoices. Same damage, more paperwork.","Saw CorpSec drones high-fiving. Never a good omen."]},{id:"rumor.high.wanted",groupId:"dock-liquor-patrons",flag:"gangHeat",value:"high",storyFunction:"payoff",description:"Pairs with power glitch triggers that reveal wanted posters.",lines:["CRTs keep flashing some wanted face. He already skipped town, obviously.","Dock sirens learned harmony. It’s unnerving in four-part.","When the lights flicker, we clap. Keeps the grid on edge."]}]},No=e=>Lo[e]??[],Oo=[{id:"note.supply.norm.crate",flag:"supplyScarcity",value:"norm",storyFunction:"world-building",description:"Everyday logistics with a dry punchline.",preferredZoneId:"downtown_checkpoint",position:{x:28,y:26},lines:["[DATE STAMP SMEARED]","Shift log: 6 crates “medical”.","Counted 5.","Crate 6 coughing."]},{id:"note.supply.tight.ammo-iou",flag:"supplyScarcity",value:"tight",storyFunction:"misdirect",description:"Sets up later gag about returned bullets.",preferredZoneId:"downtown_checkpoint",position:{x:34,y:30},lines:["IOU: 3 bullets. Return unused.","Signed: Depot Clerk, with love.","PS: Bring wipes."]},{id:"note.supply.rationed.bullet-receipt",flag:"supplyScarcity",value:"rationed",storyFunction:"payoff",description:"Punchline for earlier IOU rumor.",preferredZoneId:"downtown_checkpoint",position:{x:36,y:28},lines:["Receipt: All three bullets returned.","Two still lodged in debtor.","Processing fee waived."]},{id:"note.curfew.tier2",flag:"curfewLevel",value:2,storyFunction:"foreshadow",description:"Hints at creeping curfew changes.",preferredZoneId:"downtown_checkpoint",position:{x:40,y:24},lines:["Memo: Curfew trial balloon.","Please begin night at 3 PM.","Public feedback: “Already dark”."]},{id:"note.gangHeat.high",flag:"gangHeat",value:"high",storyFunction:"payoff",description:"Ties to high-heat rumors.",preferredZoneId:"downtown_checkpoint",position:{x:32,y:34},lines:["Wanted poster: “Seen smiling. Suspicious.”","Reward: Half-price cola (while grid stable).","Report sightings to CO-LAW vending kiosks."]},{id:"note.gangHeat.low.suspicion-drill",flag:"gangHeat",value:"low",storyFunction:"world-building",description:"Field memo coaching crews on witness heat drills.",preferredZoneId:"downtown_checkpoint",position:{x:30,y:24},lines:["Ops memo: Trigger one patrol sighting and log the heat spike.","Break line-of-sight, watch the Suspicion Inspector cool to calm.","Report anomalies to George so the city remembers accurately."]}],zo=(e,t)=>Oo.filter(n=>n.flag===e&&n.value===t),Ja=[{id:"sign.blackout.none.cola",signId:"downtown.vending.primary",flag:"blackoutTier",value:"none",storyFunction:"world-building",description:"Default advertising bluster.",text:"COLA: Now with 12 essential sugars."},{id:"sign.blackout.brownout.colaw",signId:"downtown.vending.primary",flag:"blackoutTier",value:"brownout",storyFunction:"misdirect",description:"First hint the grid is lying.",text:"CO-LAW: Report loiterers, earn fizz miles."},{id:"sign.blackout.rolling.alert",signId:"downtown.vending.primary",flag:"blackoutTier",value:"rolling",storyFunction:"payoff",description:"Full propaganda mode during outages.",text:"CO-LAW: Lights out? Snitch brighter."},{id:"sign.supply.tight.milk",signId:"corner.bodega.priceboard",flag:"supplyScarcity",value:"tight",storyFunction:"foreshadow",description:"Price jumps signal scarcity.",text:"Milk: 45 credits. Bottles scowl included."},{id:"sign.supply.rationed.ammo",signId:"corner.bodega.priceboard",flag:"supplyScarcity",value:"rationed",storyFunction:"payoff",description:"Ammo “sale” becomes a comedic beat.",text:"Ammo Sale*: *Bring your own casing."}],Rr=(e,t)=>Ja.filter(n=>n.flag===e&&n.value===t),Fo=e=>Ja.find(t=>t.id===e),Un=[{id:"weather.curfew.0",flag:"curfewLevel",value:0,rainIntensity:0,thunderActive:!1,sirenLoop:!1,storyFunction:"world-building",description:"Dry air wobble when curfew is dormant."},{id:"weather.curfew.1",flag:"curfewLevel",value:1,rainIntensity:.2,thunderActive:!1,sirenLoop:!1,storyFunction:"foreshadow",description:"Light drizzle telegraphs rising tension."},{id:"weather.curfew.2",flag:"curfewLevel",value:2,rainIntensity:.6,thunderActive:!1,sirenLoop:!0,storyFunction:"payoff",description:"Rain and sirens when curfew crosses enforcement threshold."},{id:"weather.curfew.3",flag:"curfewLevel",value:3,rainIntensity:.85,thunderActive:!0,sirenLoop:!0,storyFunction:"world-building",description:"Thunderclaps sync with decision beats at max curfew."},{id:"weather.gangHeat.high",flag:"gangHeat",value:"high",rainIntensity:.75,thunderActive:!0,sirenLoop:!0,storyFunction:"misdirect",description:"Extra thunder during high gang heat for dramatic cues."}],Bo=e=>Un.find(t=>t.flag==="curfewLevel"&&typeof t.value=="number"&&t.value===e),Ho=e=>Un.find(t=>t.flag==="gangHeat"&&t.value===e),Wo=e=>Un.find(t=>t.id===e),Dr={"slum-barflies":[{dialogueId:"npc_lira_vendor"},{dialogueId:"npc_courier_brant"}],"dock-liquor-patrons":[{dialogueId:"npc_captain_reyna"},{dialogueId:"npc_drone_handler_kesh"}]},$o=()=>["low","med","high"].flatMap(t=>No(t).map(r=>({id:`environment.rumor.${r.id}`,cooldownMs:1e3,when:a=>{const{flags:o,rumorSets:l}=a.world.environment;if(o.gangHeat!==t||!(r.groupId in Dr))return!1;const i=l[r.groupId];return!i||i.sourceId!==r.id},fire:({dispatch:a,getState:o,now:l})=>{const d=o().settings.locale,m=Xe(d).logs,f=Dr[r.groupId];a(Bs({groupId:r.groupId,snapshot:{lines:[...r.lines],storyFunction:r.storyFunction,sourceId:r.id,updatedAt:l}})),f.forEach(u=>{a(Hs({match:u,profile:{lines:[...r.lines],storyFunction:r.storyFunction,sourceId:r.id,updatedAt:l}}))}),a(F(m.environmentRumorSwap(r.description)))}}))),jr=e=>{const{flags:t}=e.world.environment;if(t.curfewLevel<3){const n=Ho(t.gangHeat);if(n)return n}return Bo(t.curfewLevel)??null},Uo=()=>[{id:"environment.weather.update",when:e=>{const t=jr(e);if(!t)return!1;const n=e.world.environment.weather,r=e.world.timeOfDay,a=n.presetId!==t.id,o=n.timeOfDay!==r;return a||o},fire:({dispatch:e,getState:t,now:n})=>{const r=t(),a=jr(r);if(!a)return;const o=r.world.environment.weather,l=r.world.timeOfDay,i=r.settings.locale,d=Xe(i).logs;if(e(Ws({presetId:a.id,rainIntensity:a.rainIntensity,sirenLoop:a.sirenLoop,thunderActive:a.thunderActive,storyFunction:a.storyFunction,updatedAt:n,timeOfDay:l})),o.presetId!==a.id||o.timeOfDay!==l){const m=a.description??a.id;e(F(d.environmentWeatherShift(m)))}}}],Go=()=>{const e=["none","brownout","rolling"],t=["norm","tight","rationed"],n=e.flatMap(a=>Rr("blackoutTier",a).map(l=>({id:`environment.signage.${l.id}`,cooldownMs:4e3,when:i=>{if(i.world.environment.flags.blackoutTier!==a)return!1;const d=i.world.environment.signage[l.signId];return!d||d.variantId!==l.id},fire:({dispatch:i,getState:d,now:m})=>{const f=d().settings.locale,u=Xe(f).logs;i(ur({signId:l.signId,snapshot:{variantId:l.id,storyFunction:l.storyFunction,updatedAt:m}})),i(F(u.environmentSignageSwap(l.text)))}}))),r=t.flatMap(a=>Rr("supplyScarcity",a).map(l=>({id:`environment.signage.${l.id}`,cooldownMs:4e3,when:i=>{if(i.world.environment.flags.supplyScarcity!==a)return!1;const d=i.world.environment.signage[l.signId];return!d||d.variantId!==l.id},fire:({dispatch:i,getState:d,now:m})=>{const f=d().settings.locale,u=Xe(f).logs;i(ur({signId:l.signId,snapshot:{variantId:l.id,storyFunction:l.storyFunction,updatedAt:m}})),i(F(u.environmentSignageSwap(l.text)))}})));return[...n,...r]},Vo=()=>{const e=["norm","tight","rationed"],t=["low","med","high"],n=[0,1,2,3],r=(a,o)=>o.flatMap(l=>zo(a,l).map(d=>({id:`environment.notes.${d.id}`,cooldownMs:5e3,when:m=>{const f=m.world.environment.flags;return(a==="supplyScarcity"?f.supplyScarcity===l:a==="gangHeat"?f.gangHeat===l:f.curfewLevel===l)?!m.world.environment.notes.some(h=>h.definitionId===d.id):!1},fire:({dispatch:m,getState:f,now:u})=>{const h=f(),v=h.world.currentMapArea.id,x=h.settings.locale,b=Xe(x).logs;m($s({instanceId:`env-note::${d.id}`,definitionId:d.id,areaId:v,lines:[...d.lines],storyFunction:d.storyFunction,spawnedAt:u})),m(F(b.environmentNoteSpawned(d.description??"new memo recovered")))}})));return[...r("supplyScarcity",e),...r("gangHeat",t),...r("curfewLevel",n)]};let Lr=!1;const qo=()=>{if(Lr)return;const e=[...$o(),...Uo(),...Go(),...Vo()];Do(e),Lr=!0},Nr={light:0,balanced:1,heavy:2,sensor:3},Or={open:0,restricted:1,sealed:2},zr={clear:0,caution:1,severe:2},Yo={"smog:none":{},"smog:light":{behavior:{sightMultiplier:.9,chaseMultiplier:.95,routineIntervalMultiplier:1.05},travel:{visibilityMultiplier:.85,staminaDrainPerMinute:1,encounterRiskModifier:1.1,advisoryLevel:"caution"}},"smog:heavy":{behavior:{sightMultiplier:.65,chaseMultiplier:.8,loadoutBias:"sensor",routineIntervalMultiplier:1.2},travel:{visibilityMultiplier:.55,staminaDrainPerMinute:3,encounterRiskModifier:1.35,vehicleWearMultiplier:1.2,advisoryLevel:"severe"}},"blackout:none":{},"blackout:brownout":{behavior:{sightMultiplier:.95},faction:{shopMarkupDelta:.05,reinforcementDelayMultiplier:1.1,safehouseAccess:"restricted"},travel:{visibilityMultiplier:.8,advisoryLevel:"caution"}},"blackout:rolling":{behavior:{sightMultiplier:.85,loadoutBias:"sensor"},faction:{shopMarkupDelta:.12,reinforcementDelayMultiplier:.9,safehouseAccess:"restricted"},travel:{visibilityMultiplier:.7,vehicleWearMultiplier:1.1,advisoryLevel:"caution"}},"surveillance:low":{},"surveillance:elevated":{behavior:{chaseMultiplier:1.15,routineIntervalMultiplier:1.05},faction:{reinforcementDelayMultiplier:.95},travel:{encounterRiskModifier:1.2,advisoryLevel:"caution"}},"surveillance:extreme":{behavior:{sightMultiplier:1.1,chaseMultiplier:1.3,loadoutBias:"sensor",routineIntervalMultiplier:1.15},faction:{shopMarkupDelta:.08,reinforcementDelayMultiplier:.75,safehouseAccess:"restricted"},travel:{encounterRiskModifier:1.4,advisoryLevel:"severe"}},"radiation:none":{},"radiation:localized":{behavior:{routineIntervalMultiplier:1.08},faction:{safehouseAccess:"restricted"},travel:{staminaDrainPerMinute:2,vehicleWearMultiplier:1.15,advisoryLevel:"caution"}},"radiation:pervasive":{behavior:{routineIntervalMultiplier:1.18,loadoutBias:"heavy"},faction:{shopMarkupDelta:.1,safehouseAccess:"sealed"},travel:{staminaDrainPerMinute:4,vehicleWearMultiplier:1.3,encounterRiskModifier:1.25,advisoryLevel:"severe"}},"curfew:off":{},"curfew:tight":{behavior:{chaseMultiplier:1.1,routineIntervalMultiplier:1.05},faction:{shopMarkupDelta:.08,reinforcementDelayMultiplier:.85,safehouseAccess:"restricted"},travel:{encounterRiskModifier:1.25,advisoryLevel:"caution"}},"curfew:lockdown":{behavior:{chaseMultiplier:1.35,routineIntervalMultiplier:1.25,loadoutBias:"heavy"},faction:{shopMarkupDelta:.2,reinforcementDelayMultiplier:.65,safehouseAccess:"sealed"},travel:{encounterRiskModifier:1.6,advisoryLevel:"severe"}}},nt=(e,t,n)=>Me(e,t,n),Ko=()=>({behavior:{sightMultiplier:1,chaseMultiplier:1,routineIntervalMultiplier:1,loadoutBias:"balanced"},faction:{shopMarkupDelta:0,reinforcementDelayMultiplier:1,safehouseAccess:"open"},travel:{staminaDrainPerMinute:0,vehicleWearMultiplier:1,encounterRiskModifier:1,advisoryLevel:"clear",visibilityMultiplier:1}}),Xo=(e,t)=>{if(t&&(typeof t.sightMultiplier=="number"&&(e.sightMultiplier=nt(e.sightMultiplier*t.sightMultiplier,.35,1.8)),typeof t.chaseMultiplier=="number"&&(e.chaseMultiplier=nt(e.chaseMultiplier*t.chaseMultiplier,.5,2)),typeof t.routineIntervalMultiplier=="number"&&(e.routineIntervalMultiplier=nt(e.routineIntervalMultiplier*t.routineIntervalMultiplier,.7,2.2)),t.loadoutBias)){const n=Nr[e.loadoutBias];Nr[t.loadoutBias]>n&&(e.loadoutBias=t.loadoutBias)}},Qo=(e,t)=>{if(t&&(typeof t.shopMarkupDelta=="number"&&(e.shopMarkupDelta=Me(e.shopMarkupDelta+t.shopMarkupDelta,-.5,1)),typeof t.reinforcementDelayMultiplier=="number"&&(e.reinforcementDelayMultiplier=nt(e.reinforcementDelayMultiplier*t.reinforcementDelayMultiplier,.4,1.6)),t.safehouseAccess)){const n=Or[e.safehouseAccess];Or[t.safehouseAccess]>n&&(e.safehouseAccess=t.safehouseAccess)}},Zo=(e,t)=>{if(t&&(typeof t.staminaDrainPerMinute=="number"&&(e.staminaDrainPerMinute=Me(e.staminaDrainPerMinute+t.staminaDrainPerMinute,0,12)),typeof t.vehicleWearMultiplier=="number"&&(e.vehicleWearMultiplier=nt(e.vehicleWearMultiplier*t.vehicleWearMultiplier,.6,2)),typeof t.encounterRiskModifier=="number"&&(e.encounterRiskModifier=nt(e.encounterRiskModifier*t.encounterRiskModifier,.5,3)),typeof t.visibilityMultiplier=="number"&&(e.visibilityMultiplier=nt(e.visibilityMultiplier*t.visibilityMultiplier,.2,1)),t.advisoryLevel)){const n=zr[e.advisoryLevel];zr[t.advisoryLevel]>n&&(e.advisoryLevel=t.advisoryLevel)}},Jo=e=>{const t=Ko();return e.forEach(n=>{const r=Yo[n];r&&(r.behavior&&Xo(t.behavior,r.behavior),r.faction&&Qo(t.faction,r.faction),r.travel&&Zo(t.travel,r.travel))}),t},el=e=>{if(!e||e.length===0)return"none";const t=e.map(n=>n.toLowerCase());return t.some(n=>n.includes("dense smog")||n.includes("toxic smog"))?"heavy":t.some(n=>n.includes("smog")||n.includes("gas cloud"))?"light":"none"},tl=(e,t)=>{let n="low";(e.gangHeat!=="low"||e.curfewLevel>=1)&&(n="elevated");const r=(t==null?void 0:t.map(a=>a.toLowerCase()))??[];return(e.gangHeat==="high"||e.curfewLevel>=3||r.some(a=>a.includes("camera")||a.includes("drone")||a.includes("surveillance")||a.includes("riot squad")))&&(n="extreme"),n},nl=e=>{if(!e||e.length===0)return"none";const t=e.map(n=>n.toLowerCase());return t.some(n=>n.includes("radiation pocket")||n.includes("reactor"))?"localized":t.some(n=>n.includes("radiation")||n.includes("toxic sludge"))?"pervasive":"none"},rl=e=>e>=3?"lockdown":e>=1?"tight":"off",al=e=>{const t=el(e.zoneHazards);let n=nl(e.zoneHazards);n==="none"&&e.zoneId&&(e.zoneId.includes("industrial")||e.zoneId.includes("wasteland"))&&(n="localized");const r=tl(e.flags,e.zoneHazards),a=rl(e.flags.curfewLevel),o=`blackout:${e.flags.blackoutTier}`;return[`smog:${t}`,o,`surveillance:${r}`,`radiation:${n}`,`curfew:${a}`]},Gn=e=>e.world.environment,Nt=X(Gn,e=>e.flags);X(Nt,e=>e.gangHeat);X(Nt,e=>e.curfewLevel);X(Nt,e=>e.supplyScarcity);X(Nt,e=>e.blackoutTier);X(Gn,e=>e.notes);const es=e=>e.world.currentMapArea,sl=X([Nt,es],(e,t)=>({flags:e,zoneHazards:(t==null?void 0:t.hazards)??[],zoneId:(t==null?void 0:t.zoneId)??null})),il=X(sl,e=>al(e)),ts=X(il,e=>Jo(e)),ol=e=>e.length===0?null:[...e].sort((n,r)=>((r==null?void 0:r.updatedAt)??0)-((n==null?void 0:n.updatedAt)??0))[0]??null,ll=e=>e.length===0?null:[...e].sort((n,r)=>((r==null?void 0:r.updatedAt)??0)-((n==null?void 0:n.updatedAt)??0))[0]??null,cl=X([Gn,es,ts],(e,t,n)=>{const r=Object.entries(e.rumorSets).map(([d,m])=>({groupId:d,lines:[...m.lines],storyFunction:m.storyFunction,updatedAt:m.updatedAt})),a=Object.entries(e.signage).map(([d,m])=>{const f=Fo(m.variantId);return{signId:d,text:(f==null?void 0:f.text)??"",storyFunction:(f==null?void 0:f.storyFunction)??m.storyFunction,updatedAt:m.updatedAt}}),o=e.weather.presetId?Wo(e.weather.presetId):null,l={presetId:e.weather.presetId,description:(o==null?void 0:o.description)??"",storyFunction:(o==null?void 0:o.storyFunction)??e.weather.storyFunction,updatedAt:e.weather.updatedAt,rainIntensity:e.weather.rainIntensity,thunderActive:e.weather.thunderActive,timeOfDay:e.weather.timeOfDay},i={zoneId:(t==null?void 0:t.zoneId)??null,zoneName:(t==null?void 0:t.displayName)??(t==null?void 0:t.name)??null,dangerRating:(t==null?void 0:t.dangerRating)??null,hazards:Array.isArray(t==null?void 0:t.hazards)?[...t.hazards]:[],summary:(t==null?void 0:t.summary)??null,directives:Array.isArray(t==null?void 0:t.objectives)?t.objectives.filter(d=>d&&d.trim().length>0).map(d=>d.trim()):[]};return{flags:{...e.flags},impacts:n,rumor:ol(r),signage:ll(a),weather:l,zone:i}}),ns=e=>!!e.settings.reputationSystemsEnabled,rs=e=>e.suspicion,as=e=>X(rs,ns,(t,n)=>!n||!e?null:t.zones[e]??null),ss=e=>X(as(e),t=>t?t.heat:{zoneId:e??"unknown",totalHeat:0,tier:"calm",leadingWitnessIds:[]});X(rs,ns,(e,t)=>t?Us(e.zones):"calm");const dl=e=>X(as(e),t=>{if(!t)return[];const{heat:n,memories:r}=t;return n.leadingWitnessIds.map(a=>r[a]).filter(a=>!!a).map(a=>Gs(a))}),yt=e=>e.paranoia,is=X(yt,e=>e.value),ul=X(yt,e=>e.tier);X(is,e=>Math.max(0,Math.min(1,e/100)));X(yt,e=>e.cooldowns);const fl=X(yt,e=>e.lastSnapshot);X(yt,e=>e.frozen);const ml=()=>({cameraAlarmedAt:{},guardAlertRank:{},lastCurfewActive:!1,lastLowHealth:!1,lastLowAmmo:!1,lastSafehouse:!1}),Fr=()=>ml(),Br=e=>{switch(e){case we.ALARMED:return 3;case we.INVESTIGATING:return 2;case we.SUSPICIOUS:return 1;default:return 0}},pl=e=>e.type==="motionSensor"?e.motionRadius??e.range:e.range,gl=(e,t)=>{var n,r,a;return e?!!((n=e.zoneId)!=null&&n.toLowerCase().includes("safehouse")||(r=e.name)!=null&&r.toLowerCase().includes("safehouse")||(a=t==null?void 0:t.zoneId)!=null&&a.toLowerCase().includes("safehouse")):!1},hl=(e,t)=>t<=0?0:Me(e/t,0,1),bl=e=>e>=7?.5:e>=5?.8:1,yl=(e,t,n,r)=>e!=="day"||t||n>.02?!1:r===0,xl=(e,t)=>{var me;const n=Math.max(0,e.deltaMs)/1e3,r={},a={},o={},l=e.player,i=e.mapArea,d=e.surveillanceZone,m=Math.max(1,l.skills.perception??5),f=Math.max(1,l.skills.endurance??5),u=Math.max(1,l.skills.intelligence??5),h=Math.max(1,l.skills.charisma??5),v=Math.max(1,l.skills.luck??5),x=Me(1+m*.02-f*.03-u*.03-h*.02,.5,1.8),b=1+f*.02+u*.02+v*.01,C=bl(v);if(d&&i){let g=0,w=0;if(Object.values(d.cameras).forEach(S=>{if(!S.isActive||S.alertState===J.DISABLED)return;const L=pl(S),T=S.position.x-l.position.x,I=S.position.y-l.position.y,q=Math.hypot(T,I);if(q<=he.surveillance.proximityRadius){const ee=1-Math.min(q/he.surveillance.proximityRadius,1);g+=ee*he.surveillance.proximityGainPerSecond*n}if(S.type!=="motionSensor"&&Pn(S.position,l.position,{range:L,angle:S.fieldOfView,direction:S.currentDirection})&&_n(S.position,l.position,i)&&(w+=he.surveillance.coneGainPerSecond*n),S.alertState===J.ALARMED){const ee=t.cameraAlarmedAt[S.id]??0;e.timestamp-ee>=1e4&&(o[`camera:${S.id}`]=he.surveillance.alertSpike*C,t.cameraAlarmedAt[S.id]=e.timestamp)}}),g>0){const S=Math.min(g,he.surveillance.maxProximityContributionPerSecond*n);r.camerasProximity=S}w>0&&(r.camerasSweep=w)}let _=0;e.enemies.forEach(g=>{if(!i||!g.visionCone){t.guardAlertRank[g.id]=Br(g.alertLevel);return}(Pn(g.position,l.position,g.visionCone)?_n(g.position,l.position,i):!1)&&(_+=1,r[`guardLOS:${g.id}`]=(r[`guardLOS:${g.id}`]??0)+he.guards.lineOfSightGainPerSecond*n);const S=Br(g.alertLevel),L=t.guardAlertRank[g.id]??0;t.guardAlertRank[g.id]=S,g.alertLevel===we.ALARMED&&(r[`guardPursuit:${g.id}`]=(r[`guardPursuit:${g.id}`]??0)+he.guards.pursuitGainPerSecond*n),S>=3&&L<3&&(o[`guardChase:${g.id}`]=he.guards.pursuitSpike*C)});let y=0;if(e.zoneHeat){const g=Vs(((me=e.mapArea)==null?void 0:me.zoneId)??null);y=hl(e.zoneHeat.totalHeat,g.tierThresholds.crackdown),y>0&&(r.heat=y*he.heat.baselineGainPerSecond*n)}e.timeOfDay==="night"&&(r.night=he.circadian.nightGainPerSecond*n),e.curfewActive&&!t.lastCurfewActive&&(o.curfew=he.circadian.curfewSpike*C),t.lastCurfewActive=e.curfewActive;const N=Math.max(1,l.maxHealth);l.health/N<he.health.criticalThreshold?(r.lowHealth=he.health.sustainedGainPerSecond*n,t.lastLowHealth||(o.lowHealth=he.health.spike*C),t.lastLowHealth=!0):t.lastLowHealth=!1,t.lastLowAmmo=!1,e.environmentImpacts.travel.staminaDrainPerMinute>0&&(r.hazards=(r.hazards??0)+he.hazards.smogGainPerSecond*n),e.environmentImpacts.travel.visibilityMultiplier<.75&&(r.hazards=(r.hazards??0)+he.hazards.blackoutGainPerSecond*n);const A=gl(i,d);A&&(a.safehouse=(a.safehouse??0)+he.safehouse.reliefPerSecond*n,t.lastSafehouse||(a.safehouseEntry=(a.safehouseEntry??0)+he.safehouse.entryRelief)),t.lastSafehouse=A,yl(e.timeOfDay,e.curfewActive,r.camerasProximity??0,_)&&(a.daylight=(a.daylight??0)+he.circadian.daylightReliefPerSecond*n);const Y=1+y,te={};Object.entries(r).forEach(([g,w])=>{if(g==="heat"){te[g]=w;return}te[g]=w*Y});const fe={gain:x,decay:b};return Object.keys(o).forEach(g=>{o[g]=o[g]*C}),{gains:te,losses:a,spikes:o,multipliers:fe}},Vn=e=>!!e.settings.reputationSystemsEnabled,wl={},qn=e=>e.reputation,vl=X(Vn,qn,(e,t)=>e&&t.debug.heatmapEnabled),os=X(qn,Vn,(e,t)=>t?e.profiles:wl),Sl=e=>X(os,t=>t[e]),Il=(e,t=3)=>X(os,n=>{const r=n[e];return r?qs.map(a=>{const o=r.traits[a];return{trait:a,value:(o==null?void 0:o.value)??0,confidence:(o==null?void 0:o.confidence)??0}}).filter(a=>a.value!==0).sort((a,o)=>Math.abs(o.value)-Math.abs(a.value)).slice(0,t):[]}),kl=X(Vn,qn,(e,t)=>e?t.debug.inspectorTargetId??null:null),El=()=>{if(typeof process<"u")return"production";if(typeof window<"u"){const e=window;if(typeof e.__VITE_MODE__=="string")return e.__VITE_MODE__}return"development"},Ml=e=>`${Math.round(e*100)}`,Cl=e=>e.charAt(0).toUpperCase()+e.slice(1),wn=e=>{if(!Number.isFinite(e))return"—";const t=Wn.cycleDuration,n=(e%t+t)%t,r=Math.floor(n/60),a=Math.floor(n%60);return`${r.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`},Tl={fontSize:"0.64rem",letterSpacing:"0.18em",textTransform:"uppercase",color:"rgba(226, 232, 240, 0.72)"},Pl={all:"unset",display:"flex",alignItems:"center",justifyContent:"space-between",gap:"0.5rem",width:"100%",marginBottom:"0.35rem",cursor:"pointer",letterSpacing:"0.18em",textTransform:"uppercase",color:"rgba(226, 232, 240, 0.86)"},_l={fontSize:"0.68rem",color:"rgba(148, 163, 184, 0.72)"},Al={display:"none"},Ye={display:"flex",justifyContent:"space-between",fontSize:"0.78rem",marginBottom:"0.22rem"},Hr={listStyle:"none",margin:0,padding:0,display:"grid",gap:"0.35rem"},Wr={padding:"0.45rem 0.55rem",borderRadius:"0.55rem",backgroundColor:"rgba(24, 36, 52, 0.78)",border:"1px solid rgba(70, 104, 150, 0.3)"},Rl={display:"flex",flexDirection:"column",alignItems:"flex-start",gap:"0.5rem",pointerEvents:"auto"},Dl={all:"unset",display:"inline-flex",alignItems:"center",gap:"0.45rem",padding:"0.45rem 0.85rem",borderRadius:"999px",border:"1px solid rgba(59, 130, 246, 0.42)",background:"linear-gradient(135deg, rgba(15, 23, 42, 0.92), rgba(30, 41, 59, 0.92))",color:"#e2e8f0",fontFamily:'"DM Mono","IBM Plex Mono",monospace',fontSize:"0.62rem",letterSpacing:"0.2em",textTransform:"uppercase",cursor:"pointer",transition:"transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease"},Ke={all:"unset",display:"inline-flex",alignItems:"center",justifyContent:"center",padding:"0.35rem 0.65rem",borderRadius:"0.55rem",border:"1px solid rgba(148, 163, 184, 0.45)",background:"rgba(15, 23, 42, 0.88)",color:"rgba(226, 232, 240, 0.92)",fontSize:"0.58rem",letterSpacing:"0.18em",textTransform:"uppercase",cursor:"pointer"},jl={padding:"0.85rem 1rem",borderRadius:"0.85rem",backgroundColor:"rgba(12, 18, 28, 0.9)",color:"#f1f5ff",backdropFilter:"blur(6px)",border:"1px solid rgba(59, 130, 246, 0.38)",width:"min(360px, 28vw)",display:"grid",gap:"0.75rem",fontFamily:'"DM Mono","IBM Plex Mono",monospace',boxShadow:"0 18px 40px rgba(15, 23, 42, 0.32)",zIndex:5},Ll=[],ls=({zoneId:e,rendererInfo:t})=>{const n=De(),r=e??"unknown",a=c.useMemo(()=>ss(r),[r]),o=c.useMemo(()=>dl(r),[r]),l=E(vl),i=E(kl),d=E(D=>D.world.currentMapArea.entities.npcs),m=E(D=>D.world.currentMapArea),f=E(D=>D.settings.testMode),u=E(D=>!!D.settings.reputationSystemsEnabled),h=c.useMemo(()=>i?Sl(i):null,[i]),v=c.useMemo(()=>i?Il(i,4):null,[i]),x=E(D=>h?h(D):null),b=E(D=>v?v(D):Ll),[C,_]=c.useState({renderer:!1,time:!1,suspicion:!1,reputation:!1,paranoia:!1}),y={renderer:"Renderer diagnostics",time:"Time/lighting debug",suspicion:"Suspicion snapshot",reputation:"Reputation debug",paranoia:"Paranoia debug"},[N,R]=c.useState(null),[$,A]=c.useState(null),Y=c.useCallback(D=>{_(ne=>({...ne,[D]:!ne[D]}))},[]);c.useEffect(()=>{!i&&d.length>0&&n(fr(d[0].id))},[n,i,d]);const te=c.useCallback(()=>{const D=Ys||Ks;n(mr(D)),A(`Set to day (${wn(D)})`)},[n]),fe=c.useCallback(()=>{n(mr(pr)),A(`Set to night (${wn(pr)})`)},[n]),me=c.useMemo(()=>d.find(D=>D.id===i),[d,i]),[g,w]=c.useState(!0),S=El(),L=E(D=>a(D)),T=E(D=>o(D)),I=E(D=>yt(D)),q=E(fl),ee=E(D=>D.world.currentTime),de=E(D=>D.world.timeOfDay),be=c.useCallback(()=>{if(!u){R("Reputation systems are disabled for MVP.");return}if(!i||!m){R("Select an NPC inside the current map to seed a sample event.");return}const D=d.find(ne=>ne.id===i);if(!D){R("Selected NPC is no longer present in this area.");return}n(Xs({actorId:"player",actorLabel:"Player",zoneId:m.zoneId??"zone::debug",position:{...D.position},intensity:"legendary",traits:{heroic:28,intimidating:8},tags:["debug_sample"],mapArea:m,npcsOverride:[D],ambientLighting:1,ambientNoise:.8,disguisePenalty:0,timestamp:Date.now()})),R(`Seeded a heroic event around ${D.name}. If nothing appears, try again nearby or toggle the reputation heatmap.`)},[n,i,m,d,u]);if(c.useEffect(()=>{N&&b.length>0&&R(null)},[N,b.length]),S==="production"||!f)return null;const G="command-debug-panel",Q=(t==null?void 0:t.label)??"Detecting…",le=(t==null?void 0:t.detail)??"Negotiating renderer",ue=g?"Show Debug Inspector":"Hide Debug Inspector",ie=(D,ne,O,Fe)=>{const _e=C[D],Be=`${G}-${Fe}`,at=typeof ne=="string"?ne:y[D];return s.jsxs("section",{children:[s.jsxs("button",{type:"button",style:Pl,onClick:()=>Y(D),"aria-expanded":!_e,"aria-controls":Be,"aria-label":`${_e?"Expand":"Collapse"} ${at}`,children:[s.jsx("span",{style:Tl,children:ne}),s.jsx("span",{style:_l,children:_e?"▸":"▾"})]}),s.jsx("div",{id:Be,style:_e?Al:void 0,"aria-hidden":_e,children:_e?null:O()})]})};return s.jsxs("div",{style:Rl,children:[s.jsxs("button",{type:"button",style:Dl,onClick:()=>w(D=>!D),"aria-expanded":!g,"aria-controls":G,children:[s.jsx("span",{children:ue}),s.jsx("span",{style:{fontSize:"0.58rem",letterSpacing:"0.2em",textTransform:"uppercase",opacity:.75},children:Q})]}),!g&&s.jsxs("div",{id:G,style:jl,role:"region","aria-label":"Debug Inspector",children:[ie("renderer","Renderer Diagnostics",()=>s.jsxs(s.Fragment,{children:[s.jsxs("div",{style:Ye,children:[s.jsx("span",{children:"Mode"}),s.jsx("span",{children:Q})]}),s.jsxs("div",{style:{...Ye,alignItems:"flex-start"},children:[s.jsx("span",{children:"Detail"}),s.jsx("span",{style:{textAlign:"right",maxWidth:"18rem"},children:le})]}),s.jsxs("div",{style:Ye,children:[s.jsx("span",{children:"Phaser"}),s.jsx("span",{children:ze.VERSION})]})]}),"renderer"),ie("time","Time & Lighting",()=>s.jsxs(s.Fragment,{children:[s.jsxs("div",{style:Ye,children:[s.jsx("span",{children:"Current"}),s.jsxs("strong",{children:[wn(ee)," · ",de]})]}),s.jsxs("div",{style:Ye,children:[s.jsx("span",{children:"Cycle Duration"}),s.jsxs("strong",{children:[Wn.cycleDuration,"s"]})]}),s.jsxs("div",{style:{display:"flex",gap:"0.35rem",flexWrap:"wrap"},children:[s.jsx("button",{type:"button",style:Ke,onClick:te,children:"Set Day"}),s.jsx("button",{type:"button",style:Ke,onClick:fe,children:"Set Night"})]}),$&&s.jsx("div",{style:{fontSize:"0.62rem",color:"rgba(96, 165, 250, 0.8)"},children:$})]}),"time"),u&&ie("suspicion",`Suspicion Snapshot · ${r}`,()=>s.jsxs(s.Fragment,{children:[s.jsxs("div",{style:Ye,children:[s.jsx("span",{children:"Heat Tier"}),s.jsx("span",{children:L.tier})]}),s.jsxs("div",{style:Ye,children:[s.jsx("span",{children:"Total Heat"}),s.jsx("span",{children:L.totalHeat.toFixed(2)})]}),T.length>0?s.jsx("ul",{style:Hr,children:T.map(D=>s.jsxs("li",{style:Wr,children:[s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.72rem",marginBottom:"0.18rem"},children:[s.jsx("span",{children:D.witnessLabel??D.witnessId}),s.jsxs("span",{children:[Ml(D.certainty),"%"]})]}),s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.68rem",opacity:.75},children:[s.jsx("span",{children:D.recognitionChannel}),s.jsx("span",{children:D.reported?"reported":"unreported"})]})]},D.id))}):s.jsx("div",{style:{fontSize:"0.7rem",opacity:.65},children:"No active witnesses."})]}),"suspicion"),u&&ie("reputation",`Reputation Debug · ${(me==null?void 0:me.name)??"Local Cell"}`,()=>s.jsxs(s.Fragment,{children:[s.jsx("div",{style:{display:"flex",gap:"0.4rem",flexWrap:"wrap",marginBottom:"0.45rem"},children:s.jsx("button",{type:"button",style:{...Ke,borderColor:l?"rgba(96, 165, 250, 0.65)":Ke.border},onClick:()=>n(Qs(!l)),children:l?"Hide Heatmap":"Show Heatmap"})}),s.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"0.35rem",marginBottom:"0.45rem"},children:d.length?d.map(D=>s.jsx("button",{type:"button",style:{...Ke,borderColor:i===D.id?"rgba(96, 165, 250, 0.65)":Ke.border},onClick:()=>n(fr(D.id)),"aria-pressed":i===D.id,children:D.name},D.id)):s.jsx("span",{style:{fontSize:"0.68rem",opacity:.6},children:"No NPCs in this map."})}),s.jsx("div",{style:{fontSize:"0.62rem",color:"rgba(148, 163, 184, 0.75)",marginBottom:"0.35rem"},children:"1) Pick an NPC in the active cell. 2) Trigger an in-game action or use the seed button below. 3) Inspect the traits that populate here and toggle the heatmap to see cell sentiment."}),x?b.length?s.jsx("ul",{style:Hr,children:b.map(D=>{const ne=x.traits[D.trait],O=(ne==null?void 0:ne.sources)??[];return s.jsxs("li",{style:Wr,children:[s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.7rem",marginBottom:"0.18rem"},children:[s.jsx("span",{children:Cl(D.trait)}),s.jsx("span",{children:D.value.toFixed(1)})]}),s.jsxs("div",{style:{fontSize:"0.64rem",opacity:.72},children:["Confidence ",Math.round(D.confidence*100),"%"]}),O.length?s.jsxs("div",{style:{fontSize:"0.62rem",opacity:.62,marginTop:"0.2rem"},children:["Rumors: ",O.slice(0,3).join(", ")]}):s.jsx("div",{style:{fontSize:"0.62rem",opacity:.45,marginTop:"0.2rem"},children:"No rumor sources tracked."})]},D.trait)})}):s.jsxs("div",{style:{display:"grid",gap:"0.35rem"},children:[s.jsx("div",{style:{fontSize:"0.68rem",opacity:.6},children:"No localized reputation yet. Trigger a nearby event so NPCs can witness something."}),s.jsx("button",{type:"button",onClick:be,style:{...Ke,borderColor:"rgba(96, 165, 250, 0.55)",justifyContent:"center"},disabled:!m,children:"Seed Sample Heroic Event"}),N&&s.jsx("div",{style:{fontSize:"0.62rem",color:"rgba(96, 165, 250, 0.8)"},children:N})]}):s.jsxs("div",{style:{display:"grid",gap:"0.35rem"},children:[s.jsx("div",{style:{fontSize:"0.68rem",opacity:.6},children:"Select an NPC to inspect reputation."}),s.jsx("button",{type:"button",onClick:be,style:{...Ke,borderColor:"rgba(96, 165, 250, 0.55)",justifyContent:"center"},disabled:!m,children:"Seed Sample Heroic Event"}),N&&s.jsx("div",{style:{fontSize:"0.62rem",color:"rgba(96, 165, 250, 0.8)"},children:N})]})]}),"reputation"),ie("paranoia",`Paranoia Debug · ${I.tier}`,()=>s.jsxs(s.Fragment,{children:[s.jsxs("div",{style:Ye,children:[s.jsx("span",{children:"Value"}),s.jsx("span",{children:I.value.toFixed(1)})]}),q?s.jsxs("div",{style:{display:"grid",gap:"0.3rem",fontSize:"0.72rem"},children:[s.jsxs("div",{children:[s.jsx("strong",{style:{opacity:.8},children:"Δ"})," ",q.delta>=0?"+":"",q.delta.toFixed(3)]}),s.jsxs("div",{children:[s.jsx("strong",{style:{opacity:.8},children:"Gains"})," ",Object.keys(q.breakdown.gains).length===0?"—":Object.entries(q.breakdown.gains).map(([D,ne])=>`${D}:${ne.toFixed(3)}`).join(" | ")]}),s.jsxs("div",{children:[s.jsx("strong",{style:{opacity:.8},children:"Losses"})," ",Object.keys(q.breakdown.losses).length===0?"—":Object.entries(q.breakdown.losses).map(([D,ne])=>`${D}:${ne.toFixed(3)}`).join(" | ")]}),s.jsxs("div",{children:[s.jsx("strong",{style:{opacity:.8},children:"Spikes"})," ",Object.keys(q.breakdown.spikes).length===0?"—":Object.entries(q.breakdown.spikes).map(([D,ne])=>`${D}:${ne.toFixed(3)}`).join(" | ")]})]}):s.jsx("div",{style:{fontSize:"0.7rem",opacity:.65},children:"No recent paranoia stimuli."})]}),"paranoia")]})]})},Nl=e=>e.world.engagementMode,Ol=e=>e.player.data.stealthModeEnabled,cs=e=>e.player.data.stealthCooldownExpiresAt,Yn=e=>e.quests.activeDialogue.dialogueId,zl=X([e=>e.world.inCombat,Yn,cs],(e,t,n)=>!(e||t||typeof n=="number"&&n>Date.now())),ds=X([Ol,zl,cs],(e,t,n)=>({enabled:e,eligible:t,cooldownExpiresAt:typeof n=="number"?n:null,onCooldown:typeof n=="number"})),Fl=e=>{switch(e){case"on_edge":return 1.1;case"panicked":return 1.2;case"breakdown":return 1.3;default:return 1}},Bl=4500,Hl=e=>{switch(e){case we.SUSPICIOUS:return 1;case we.INVESTIGATING:return 2;case we.ALARMED:return 3;default:return 0}},Wl={silent:{radius:2,gain:0},normal:{radius:4,gain:4},sprint:{radius:6,gain:8}},$l=e=>e.reduce((t,n)=>{const r=Array.isArray(n.tags)?n.tags:[],a=n.stackable?n.quantity??1:1;return r.includes("paranoia:calmtabs")&&(t.calmTabs+=a),r.includes("paranoia:cigarettes")&&(t.cigarettes+=a),t},{calmTabs:0,cigarettes:0}),us=e=>e.stackable?Math.max(1,e.quantity??1):1,fs=(e,t)=>e.type!=="collect"||e.isCompleted?!1:e.targetResourceKey&&t.resourceKey?e.targetResourceKey===t.resourceKey:e.target===t.name,Ul=(e,t)=>t.reduce((n,r)=>fs(e,r)?n+us(r):n,0),Gt=1.5,Gl=(e,t,n)=>{var f;if(!e||!t||!Array.isArray(e.buildings)||e.buildings.length===0)return{available:!1,note:"No workbench nearby"};const{x:r,y:a}=t.position,o=e.buildings.find(u=>{if(!u.workbench)return!1;const{from:h,to:v}=u.footprint;return r>=h.x-Gt&&r<=v.x+Gt&&a>=h.y-Gt&&a<=v.y+Gt});if(!o||!o.workbench)return{available:!1,note:"No workbench nearby"};let l=!1;if(n){const u=$n(((f=t.factionReputation)==null?void 0:f.scavengers)??0);l=u.id==="friendly"||u.id==="allied"}const i=o.workbench.type==="market"&&(!n||!l)?o.workbench.feeRequired??50:void 0,d=i?t.credits>=i:!0,m=i&&!d?n?`Requires ${i} credits or Friendly scavenger standing`:`Requires ${i} credits`:i?n?"Fee applies if scavenger standing is below Friendly":"Market workbench fee applies":void 0;return{available:d,locationName:o.name,type:o.workbench.type,feeRequired:i,note:m}},Vl=()=>{var lr;const e=c.useMemo(()=>Fa("GameController"),[]),t=De(),n=Ps(),r=E(p=>p.player.data),a=r.encumbrance.level,o=r.encumbrance.warning,l=r.encumbrance.percentage,i=E(p=>p.world.currentMapArea),d=i==null?void 0:i.entities.items,m=i==null?void 0:i.id,f=(i==null?void 0:i.isInterior)??!1,u=E(p=>p.world.inCombat),h=E(p=>p.world.isPlayerTurn),v=E(p=>p.world.timeOfDay),x=E(p=>p.world.curfewActive),b=E(p=>p.world.currentMapArea.entities.enemies),C=E(p=>p.world.mapAreas),_=E(p=>p.world.mapConnections),y=E(p=>p.world),N=E(p=>p.quests.quests),R=E(p=>p.quests.dialogues),$=c.useMemo(()=>N.map(p=>`${p.id}:${p.isActive?1:0}:${p.isCompleted?1:0}`).join("|"),[N]),A=E(Yn),Y=E(p=>p.settings.locale),te=E(p=>p.settings.autoBattleEnabled),fe=E(p=>p.settings.autoBattleProfile),me=E(ds),g=me.cooldownExpiresAt,w=me.eligible,S=typeof g=="number",L=E(p=>p.world.engagementMode),T=E(p=>p.settings.autoStealthEnabled),I=E(p=>!!p.settings.reputationSystemsEnabled),q=E(p=>p.world.turnCount),ee=E(p=>p.world.globalAlertLevel),de=E(p=>p.world.reinforcementsScheduled),be=E(p=>m?p.surveillance.zones[m]:void 0),G=E(p=>p.surveillance.hud.overlayEnabled),Q=E(ts),le=E(p=>p.world.environment.flags),ue=E(p=>p.world.currentTime),ie=E(ul),D=c.useMemo(()=>ss((i==null?void 0:i.zoneId)??null),[i==null?void 0:i.zoneId]),ne=E(p=>D(p)),O=c.useMemo(()=>Xe(Y).logs,[Y]),Fe=c.useMemo(()=>Pe(Y),[Y]),_e=c.useMemo(()=>Fe.autoBattle,[Fe]),Be=c.useMemo(()=>Math.max(220,Math.round(320*Q.behavior.routineIntervalMultiplier)),[Q.behavior.routineIntervalMultiplier]),at=c.useMemo(()=>Math.max(750,Math.round(Zs()*Q.faction.reinforcementDelayMultiplier)),[Q.faction.reinforcementDelayMultiplier]),st=c.useRef(u),it=c.useRef(v),xt=c.useRef(ee),Qe=c.useRef(void 0),Ge=c.useRef(r),wt=c.useRef(i??null),vt=c.useRef(de),ot=c.useRef(io()),Le=c.useRef(null),St=c.useRef(null),M=c.useRef(ee),B=c.useRef(v),ae=c.useRef(A),re=c.useRef(G),ge=c.useRef(ue),oe=c.useRef(null),ye=c.useRef(null),ve=c.useRef(new Map),It=c.useRef(null),Ne=c.useRef(N),kt=c.useRef(null),Jn=c.useRef(Fr()),er=c.useRef(ie),tr=c.useRef(ne),nr=c.useRef({calmTabs:0,cigarettes:0}),ks=((lr=y.workbenchStatus)==null?void 0:lr.available)!==void 0?{...y.workbenchStatus}:{available:y.workbenchAvailable??!1,note:y.workbenchAvailable?void 0:"No workbench nearby"},rr=c.useRef(ks),[Ae,lt]=c.useState(0),Ot=c.useRef(null),zt=c.useRef(null),He=c.useRef(null),[Ft,Ve]=c.useState("clear"),[Te,Se]=c.useState([]),ct=c.useRef(new Set),Et=c.useRef([]),Ze=c.useRef(new Map),Bt=c.useRef(null),[sn,Ie]=c.useState(null),[on,ke]=c.useState(null),Ht=c.useCallback(p=>{var P;if(!p.isInteractive||!p.dialogueId)return t(F(O.npcNotReady(p.name))),!1;if(A===p.dialogueId)return!0;const k=R.find(z=>z.id===p.dialogueId);if(!k||k.nodes.length===0)return t(F(O.npcNoNewInfo(p.name))),!1;const j=(P=k.nodes[0])==null?void 0:P.id;return j?(t(gr({dialogueId:k.id,nodeId:j})),t(F(O.npcChannelOpened(p.name))),!0):(t(F(O.npcChannelEmpty(p.name))),!1)},[t,R,A,O]),dt=c.useCallback((p={})=>{const{sprint:k=!1}=p;if(u)return!0;if(k&&r.isExhausted)return t(F(O.tooTiredToSprint)),!1;let P=l>=80?hr.strenuousInteraction:0;return k&&(P+=hr.sprintTile),P<=0?(r.stamina<r.maxStamina&&t(Js(void 0)),!0):r.stamina<P?(t(F(O.notEnoughStamina(P,r.stamina))),!1):(t(ei(P)),!0)},[l,t,u,O,r.isExhausted,r.stamina,r.maxStamina]),Re=c.useCallback((p=!0)=>{p&&Ot.current!==null&&window.clearTimeout(Ot.current),Ot.current=null,zt.current=null},[]),ut=c.useRef(null),ft=()=>typeof performance<"u"?performance.now():Date.now(),ar=c.useCallback(()=>{var p;t(dn({enabled:!0,cooldownExpiresAt:null})),((p=Ge.current)==null?void 0:p.movementProfile)!=="silent"&&t(br("silent"))},[t]),mt=c.useCallback(p=>{var j;const k=typeof performance<"u"?performance.now():Date.now();t(dn({enabled:!1,cooldownExpiresAt:p?k+Bl:null})),((j=Ge.current)==null?void 0:j.movementProfile)==="silent"&&t(br("normal"))},[t]);c.useEffect(()=>{Qe.current=be},[be]),c.useEffect(()=>{er.current=ie},[ie]),c.useEffect(()=>{tr.current=ne},[ne]),c.useEffect(()=>{Ge.current=r},[r]),c.useEffect(()=>{ae.current=A},[A]),c.useEffect(()=>{Ne.current=N},[N]),c.useEffect(()=>{wt.current=i??null},[i]),c.useEffect(()=>{if(!d||d.length===0)return;const p=d.filter(j=>{var P,z;return((P=j.position)==null?void 0:P.x)===r.position.x&&((z=j.position)==null?void 0:z.y)===r.position.y});if(p.length===0)return;const k=Ne.current.filter(j=>j.isActive&&!j.isCompleted);p.forEach(j=>{var W,se;const P=us(j),z=ti(j);t(Ba(j)),t(ni({id:j.id,position:j.position,name:j.name})),window.dispatchEvent(new CustomEvent(ri,{detail:{areaId:i.id,itemId:j.id,position:j.position}})),t(Tt({id:We(),value:P,gridX:((W=j.position)==null?void 0:W.x)??r.position.x,gridY:((se=j.position)==null?void 0:se.y)??r.position.y,type:"pickup",label:z})),t(F(O.itemPickedUp(z,P))),k.forEach(H=>{H.objectives.forEach(U=>{fs(U,j)&&t(yr({questId:H.id,objectiveId:U.id,count:P}))})})})},[t,d,r.position,O,i==null?void 0:i.id]),c.useEffect(()=>{const p=Ne.current.filter(j=>j.isActive&&!j.isCompleted);if(p.length===0)return;const k=r.inventory.items??[];k.length!==0&&p.forEach(j=>{j.objectives.forEach(P=>{if(P.type!=="collect"||P.isCompleted)return;const z=Ul(P,k);if(z<=0)return;const W=P.count??1,se=P.currentCount??0,U=Math.min(z,W)-se;U<=0||t(yr({questId:j.id,objectiveId:P.id,count:U}))})})},[t,r.inventory.items,$]),c.useEffect(()=>{const p=Qe.current??be,k=Ge.current,P=b.reduce((U,pe)=>{const K=Hl(pe.alertLevel);return K>U?K:U},0)>=2,W=(p?Object.values(p.cameras):[]).some(U=>U.alertState===J.ALARMED),se=ft();!(k!=null&&k.stealthModeEnabled)&&(k!=null&&k.stealthCooldownExpiresAt)&&k.stealthCooldownExpiresAt<=se&&t(dn({enabled:!1,cooldownExpiresAt:null}));let H="none";u?(H="combat",k!=null&&k.stealthModeEnabled&&(mt(!0),t(F(O.stealthCompromised)))):ae.current?(H="dialog",k!=null&&k.stealthModeEnabled&&mt(!1)):k!=null&&k.stealthModeEnabled&&(P||W?(mt(!0),t(F(O.stealthCompromised))):H="stealth"),L!==H&&t(un(H))},[A,mt,t,L,b,u,O,be]),c.useEffect(()=>{Jn.current=Fr()},[m]),c.useEffect(()=>{if(!i){ve.current=new Map(b.map(j=>[j.id,j]));return}const p=new Map(b.map(j=>[j.id,j]));if(!I){ve.current=p;return}ve.current.forEach((j,P)=>{const z=p.get(P);(!z||z.health<=0)&&t(ai({witnessId:P,zoneId:i.zoneId}))}),ve.current=p},[b,i,t,I]),c.useEffect(()=>{vt.current=de},[de]),c.useEffect(()=>{!de&&Le.current!==null&&(ot.current.cancel(Le.current),Le.current=null)},[de]),c.useEffect(()=>{const p=$l(r.inventory.items??[]),k=nr.current;nr.current=p;const j=ft();p.calmTabs<k.calmTabs&&t(xr({amount:he.calmTabs.relief,timestamp:j,cooldownKey:"calmTabs",cooldownMs:he.calmTabs.cooldownMs})),p.cigarettes<k.cigarettes&&(t(xr({amount:he.cigarettes.relief,timestamp:j})),t(si({amountPerSecond:he.cigarettes.decayBoostPerSecond,durationMs:he.cigarettes.durationMs,timestamp:j})))},[r.inventory.items,t]),c.useEffect(()=>{M.current=ee},[ee]),c.useEffect(()=>{B.current=v},[v]),c.useEffect(()=>{re.current=G},[G]),c.useEffect(()=>{ge.current=ue},[ue]),c.useEffect(()=>{kt.current||(kt.current=new ii(t,n))},[t,n]),c.useEffect(()=>{kt.current&&kt.current.update({enabled:te,profileId:fe,player:r,enemies:b,mapArea:i??null,inCombat:u,isPlayerTurn:h,turnCount:q,activeDialogueId:A,logStrings:O,autoBattleStrings:_e})},[te,fe,r,b,i,u,h,q,A,O,_e]),c.useEffect(()=>{ut.current&&ut.current.focus();const p=k=>{if(!ut.current)return;const j=k.target;j&&(ut.current.contains(j)||j.closest('[data-controller-focus-ignore="true"]'))||ut.current.focus()};return document.addEventListener("click",p),()=>{document.removeEventListener("click",p)}},[]),c.useEffect(()=>{const p=wt.current;if(!p||!m)return;ye.current!==null&&(window.clearTimeout(ye.current),ye.current=null);const k=oe.current;k&&k!==m&&Ar({areaId:k,dispatch:t});const j=Qe.current;return(!j||j.areaId!==m)&&Po({area:p,timeOfDay:B.current,dispatch:t,timestamp:ft()}),oe.current=m,()=>{const P=oe.current;P&&(ye.current=window.setTimeout(()=>{Ar({areaId:P,dispatch:t}),oe.current=null,ye.current=null},0))}},[m,t]),c.useEffect(()=>{if(!i||!m)return;const p=Qe.current??be;p&&_o({zone:p,area:i,timeOfDay:v,dispatch:t,timestamp:ft()})},[v,m,be,i,t]),c.useEffect(()=>{const p=k=>{if(!k.defaultPrevented){if(k.key==="Tab"){if(k.preventDefault(),k.repeat)return;t(wi({enabled:!re.current}));return}if(k.key.toLowerCase()==="x"){if(k.repeat)return;k.preventDefault();const j=Ge.current;if(!j)return;if(j.stealthModeEnabled){mt(!1),t(un("none")),t(F(O.stealthDisengaged));return}if(!w){if(u){t(F(O.stealthUnavailableCombat));return}if(ae.current){t(F(O.stealthUnavailableDialogue));return}if(S&&typeof g=="number"){const P=typeof performance<"u"?performance.now():Date.now(),z=Math.max(0,g-P);if(z>0){const W=Math.ceil(z/1e3);t(F(O.stealthCooldown(W)))}}return}ar(),t(un("stealth")),t(F(O.stealthEngaged))}}};return window.addEventListener("keydown",p),()=>{window.removeEventListener("keydown",p)}},[t,mt,ar,u,O,w,S,g]),c.useEffect(()=>{if(!m||typeof window>"u")return;qo();let p=null,k=ft();const j=()=>{const P=Qe.current,z=wt.current,W=Ge.current,se=ft(),H=se-k;k=se;const pe=n.getState().world;if(z&&W){const K=I?tr.current:null,V=xl({player:W,enemies:z.entities.enemies,mapArea:z,surveillanceZone:P,zoneHeat:K,environmentImpacts:Q,timeOfDay:pe.timeOfDay,curfewActive:pe.curfewActive,worldTimeSeconds:pe.currentTime,deltaMs:H,timestamp:se},Jn.current),Z=Object.values(V.gains).reduce((pt,qe)=>pt+qe,0),ce=Object.values(V.losses).reduce((pt,qe)=>pt+qe,0),Oe=Object.values(V.spikes).reduce((pt,qe)=>pt+qe,0),Mt=Z*V.multipliers.gain-ce+Oe;(Mt!==0||Z>0||ce>0||Oe!==0)&&t(vi({timestamp:se,delta:Mt,deltaMs:H,breakdown:{gains:V.gains,losses:V.losses,spikes:V.spikes}})),t(Si({deltaMs:H,timestamp:se,decayMultiplier:V.multipliers.decay}))}if(P&&z&&W){const K=I?V=>{t(kr(V)),e.debug(`Suspicion: camera ${V.witnessId} reported player in ${V.zoneId} (${V.recognitionChannel})`)}:void 0;Ao({zone:P,mapArea:z,player:W,deltaMs:H,timestamp:se,dispatch:t,logStrings:O,reinforcementsScheduled:vt.current??!1,globalAlertLevel:M.current??we.IDLE,timeOfDay:pe.timeOfDay,environmentFlags:pe.environment.flags,worldTimeSeconds:pe.currentTime,onWitnessObservation:K})}if(!u&&L==="stealth"&&T&&z&&W){const K=ao();K&&t(F(`[Auto-Stealth]: ${K.summary}`))}if(z&&W){const K=Gl(z,W,I),V=rr.current;(V.available!==K.available||V.type!==K.type||V.locationName!==K.locationName||V.feeRequired!==K.feeRequired||V.note!==K.note)&&(rr.current=K,t(Ii(K)))}jo(t,n.getState),p=window.requestAnimationFrame(j)};return p=window.requestAnimationFrame(j),()=>{p!==null&&window.cancelAnimationFrame(p)}},[m,t,O,n,e,Q,T,L,u,I]),c.useEffect(()=>{const p=k=>{const P=k.detail;if(!P||!i||P.areaId!==i.id||u)return;const z=P.position;if(Ie(null),ke(null),z.x===r.position.x&&z.y===r.position.y){Se([]),ke(null);return}const W=i.entities.npcs.find(U=>U.position.x===z.x&&U.position.y===z.y);if(W){if(u){t(F(O.combatChatterOverrides));return}if(Math.abs(W.position.x-r.position.x)+Math.abs(W.position.y-r.position.y)<=1){Ht(W);return}const pe=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}];let K=null;for(const V of pe){const Z={x:W.position.x+V.x,y:W.position.y+V.y};if(Z.x===r.position.x&&Z.y===r.position.y||Z.x<0||Z.y<0||Z.x>=i.width||Z.y>=i.height||!$t(Z,i,r,b,{npcs:i.entities.npcs}))continue;const ce=Pt(r.position,Z,i,{player:r,enemies:b,npcs:i.entities.npcs});if(ce.length>0){K=ce;break}}K?(Ie(W.id),Se(K)):t(F(O.npcBoxedIn(W.name)));return}const se=i.entities.enemies.find(U=>U.position.x===z.x&&U.position.y===z.y&&U.health>0);if(se){if(Math.abs(se.position.x-r.position.x)+Math.abs(se.position.y-r.position.y)<=1){u||(t(_t()),t(F(O.enteredCombat)));return}const pe=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}];let K=null;for(const V of pe){const Z={x:se.position.x+V.x,y:se.position.y+V.y};if(Z.x===r.position.x&&Z.y===r.position.y||Z.x<0||Z.y<0||Z.x>=i.width||Z.y>=i.height||!$t(Z,i,r,b,{npcs:i.entities.npcs}))continue;const ce=Pt(r.position,Z,i,{player:r,enemies:b,npcs:i.entities.npcs});if(ce.length>0){K=ce;break}}K?(ke(se.id),Se(K)):t(F(O.enemyOutOfRange));return}const H=Pt(r.position,z,i,{player:r,enemies:b,npcs:i.entities.npcs});if(H.length===0){window.dispatchEvent(new CustomEvent(fn,{detail:{areaId:i.id,path:[]}})),ke(null);return}Se(H)};return window.addEventListener(wr,p),()=>{window.removeEventListener(wr,p)}},[i,r,b,u,t,Ht,_,O]),c.useEffect(()=>{i&&window.dispatchEvent(new CustomEvent(fn,{detail:{areaId:i.id,path:Te}}))},[Te,i]),c.useEffect(()=>{if(!i)return;const p=k=>{const j=k.detail;if(!j||j.areaId!==i.id)return;const P=Pt(r.position,j.target,i,{player:r,enemies:b,npcs:i.entities.npcs});Se(P),window.dispatchEvent(new CustomEvent(fn,{detail:{areaId:i.id,path:P}}))};return window.addEventListener(vr,p),()=>{window.removeEventListener(vr,p)}},[i,r,b]),c.useEffect(()=>{Se(p=>p.length>0?[]:p),Ie(null),ke(null)},[i==null?void 0:i.id]),c.useEffect(()=>{f&&Ve("clear")},[m,f]),c.useEffect(()=>{const p=ct.current,k=Et.current,j=Ze.current;p.clear(),k.forEach(P=>{window.clearTimeout(P)}),k.length=0,j.clear()},[i==null?void 0:i.id]);const sr=c.useCallback((p,k)=>{if(k.length===0){Ze.current.delete(p.id);return}if(ct.current.has(p.id))return;const j=k[k.length-1];Ze.current.set(p.id,j),ct.current.add(p.id);const P=Be;let z=0,W=p;const se=()=>{if(z>=k.length){ct.current.delete(p.id),Ze.current.delete(p.id);return}const H=k[z];if(z+=1,W={...W,position:H},t(ki(W)),z<k.length){const U=window.setTimeout(()=>{const pe=Et.current.indexOf(U);pe>-1&&Et.current.splice(pe,1),se()},P);Et.current.push(U)}else ct.current.delete(p.id),Ze.current.delete(p.id)};se()},[t,Be]);c.useEffect(()=>{i&&i.entities.npcs.forEach(p=>{const k=p.routine.find(W=>W.timeOfDay===v);if(!k||p.position.x===k.position.x&&p.position.y===k.position.y)return;const j=i.entities.npcs.filter(W=>W.id!==p.id).map(W=>W.position),P=Array.from(Ze.current.entries()).filter(([W])=>W!==p.id).map(([,W])=>W),z=Pt(p.position,k.position,i,{player:r,enemies:b,blockedPositions:[...j,...P]});z.length>0&&sr(p,z)})},[i,v,r,b,sr]),c.useEffect(()=>{const p=Et.current,k=ct.current,j=Ze.current;return()=>{p.forEach(P=>{window.clearTimeout(P)}),p.length=0,k.clear(),j.clear()}},[]),c.useEffect(()=>{var se;if(Te.length===0)return;if(u){Se([]),Ie(null);return}if(r.encumbrance.level==="immobile"){r.encumbrance.warning&&t(F(r.encumbrance.warning)),Se([]),Ie(null),ke(null);return}const p=Te[0],k=r.position.x,j=r.position.y;if(k===p.x&&j===p.y){Se(H=>H.slice(1));return}if(!$t(p,i,r,b,{npcs:i.entities.npcs})){Se([]),Ie(null),ke(null);return}const P=i.tiles[p.y][p.x],z=_.find(H=>H.fromAreaId===i.id&&H.fromPosition.x===p.x&&H.fromPosition.y===p.y);if(z){const H=C[z.toAreaId];if(x&&P.type===Sr.DOOR&&H&&!H.isInterior){t(F(O.checkpointSealed)),Se([]),Ie(null),ke(null);return}if(H){if(I&&H.factionRequirement){const U=H.factionRequirement,pe=Fe.playerStatus.factions[U.factionId]??U.factionId,K=((se=r.factionReputation)==null?void 0:se[U.factionId])??0,V=$n(K);let Z=!0;if(U.minimumStanding){const ce=ht(V.id),Oe=ht(U.minimumStanding);ce<Oe&&(Z=!1)}if(Z&&typeof U.minimumReputation=="number"&&K<U.minimumReputation&&(Z=!1),!Z){const ce=[];U.minimumStanding&&ce.push(Qt(Y,U.minimumStanding)),typeof U.minimumReputation=="number"&&ce.push(`${Fe.factionPanel.reputationLabel} ${U.minimumReputation}+`);const Oe=ce.join(" • ")||Qt(Y,V.id);t(F(O.factionAccessDenied(pe,Oe))),Se([]),Ie(null),ke(null);return}}if(!dt()){Se([]),Ie(null),ke(null);return}t(Ir(H)),t(Ut(z.toPosition)),H.isInterior&&(t(Kt({type:"campfireRest",locationId:H.id})),t(F(O.slipInsideStructure)),Ve("clear"))}else e.warn(`Missing target area in state for ${z.toAreaId}`);Se([]),Ie(null),ke(null);return}if(!dt()){Se([]),Ie(null),ke(null);return}const W=r.movementProfile==="silent"?140:0;He.current===null&&(He.current=window.setTimeout(()=>{He.current=null,t(Ut(p))},W))},[Te,r,i,b,u,x,t,C,_,e,O,dt,Y,Fe,I]),c.useEffect(()=>{Te.length===0&&He.current!==null&&(window.clearTimeout(He.current),He.current=null)},[Te.length]),c.useEffect(()=>()=>{He.current!==null&&(window.clearTimeout(He.current),He.current=null)},[]),c.useEffect(()=>{const p=o??null;if(p&&p!==Bt.current&&t(F(p)),!p&&Bt.current&&a==="normal"){Bt.current=null;return}Bt.current=p},[a,o,t]),c.useEffect(()=>{if(!sn||!i)return;const p=i.entities.npcs.find(j=>j.id===sn);if(!p){Ie(null);return}if(Math.abs(p.position.x-r.position.x)+Math.abs(p.position.y-r.position.y)<=1){if(u)Ie(null);else{const j=Ht(p);Ie(null),j&&Se([])}return}Te.length===0&&(t(F(O.npcOutOfReach(p.name))),Ie(null))},[sn,i,r,u,Te.length,t,_,Ht,O]),c.useEffect(()=>{if(!on||!i)return;const p=i.entities.enemies.find(j=>j.id===on);if(!p||p.health<=0){ke(null);return}if(Math.abs(p.position.x-r.position.x)+Math.abs(p.position.y-r.position.y)<=1){ke(null),Se([]),u||(t(_t()),t(F(O.enteredCombat)));return}Te.length===0&&ke(null)},[on,i,r,u,Te.length,t,O,b]),c.useEffect(()=>{it.current!==v&&(v==="night"?(t(F(O.nightFalls)),Ve("clear")):it.current==="night"&&(t(F(O.dawnBreaks)),Ve("clear")),it.current=v)},[v,t,O]),c.useEffect(()=>{I&&t(oi(!!A))},[A,t,I]),c.useEffect(()=>{var K;if(!r||b.length===0||!i){It.current=null;return}const p=[i.id,`${r.position.x},${r.position.y}`,r.movementProfile,u?"combat":"field",v,b.map(V=>{var Z;return`${V.id}:${V.health}:${V.position.x},${V.position.y}:${V.facing}:${((Z=V.visionCone)==null?void 0:Z.direction)??"na"}`}).join("|")].join("::");if(It.current===p)return;It.current=p;const k=Fl(er.current),j=r.movementProfile==="silent"?.6:r.movementProfile==="sprint"?1.6:1,P=((K=r.skillTraining)==null?void 0:K.stealth)??0,z=Math.max(.7,1-Math.min(.3,P/333)),W=(B.current??v)==="night"?.85:1,se=k*j*z*W,{updatedEnemies:H,maxAlertLevel:U,guardPerception:pe}=li(b,r,i,se);if(r.movementProfile!=="silent"){const V=Wl[r.movementProfile];H.forEach((Z,ce)=>{const Oe=pe[ce];if(!Z||Oe!=null&&Oe.playerVisible)return;const cn=Z.position.x-r.position.x,Mt=Z.position.y-r.position.y;if(Math.sqrt(cn*cn+Mt*Mt)>V.radius||V.gain<=0)return;const qe=Z.alertProgress??0,Ct=Math.min(100,qe+V.gain);if(Ct<=qe)return;let Wt=Z.alertLevel??we.IDLE;Ct>=mn.alarmThreshold?Wt=we.ALARMED:Ct>=mn.investigationThreshold?Wt=we.INVESTIGATING:Ct>=mn.suspicionThreshold&&(Wt=we.SUSPICIOUS),H[ce]={...Z,alertProgress:Ct,alertLevel:Wt}})}if(H.forEach((V,Z)=>{const ce=b[Z];ce&&(V.alertLevel!==ce.alertLevel||V.alertProgress!==ce.alertProgress)&&t(pn(V))}),I&&pe.forEach(({enemy:V,playerVisible:Z})=>{if(!Z)return;const ce=yo({enemy:V,player:r,mapArea:i,timeOfDay:v,environmentFlags:le,playerVisible:Z,timestamp:ue});ce&&(t(kr(ce)),e.debug(`Suspicion: guard ${V.id} observed player in ${i.zoneId} (certainty ${(ce.baseCertainty*ce.distanceModifier).toFixed(2)})`))}),U!==xt.current){const V=ci(xt.current,U);V&&t(F(O[V])),t(Yt(U)),xt.current=U,di(U,de)&&(t(za()),t(F(O.reinforcementsIncoming)),Le.current!==null&&ot.current.cancel(Le.current),Le.current=ot.current.schedule(()=>{Le.current=null,u||t(_t());const Z=u&&!h,ce={id:We(),name:O.curfewPatrolName,position:{x:r.position.x+5,y:r.position.y+2},facing:"west",coverOrientation:null,suppression:0,health:45,maxHealth:45,actionPoints:Z?0:4,maxActionPoints:4,damage:7,attackRange:2,isHostile:!0,visionCone:{range:10,angle:90,direction:180},alertLevel:we.ALARMED,alertProgress:100};t(Er(ce)),t(gt()),Z&&!h&&(t(Je()),t(gt())),Re(),lt(0),t(ui())},at))}},[r,b,i,t,O,u,h,de,Re,at,v,le,ue,e,I]),c.useEffect(()=>{if(e.debug(`=== useEffect RUNNING === Turn: ${h?"Player":"Enemy"}, Combat: ${u}, Processing: ${zt.current?"true":"false"}, EnemyIdx: ${Ae}`),!u||h||b.length===0){Re(),(!u||h)&&Ae!==0&&lt(0);return}if(b.filter(P=>P.health>0).length===0){Re(),e.warn("Enemy turn effect running but no living enemies found.");return}if(Ae>=b.length){e.debug(`Enemy index ${Ae} out of bounds (length: ${b.length}). Ending enemy turn.`),Re(),t(Je()),t(gt()),lt(0);return}const k=b[Ae];if(!k||k.health<=0||k.actionPoints<=0){e.debug(`Enemy ${(k==null?void 0:k.id)??`at index ${Ae}`} cannot act (Dead or 0 AP). Checking next.`),Re();let P=Ae+1,z=!1;for(;P<b.length;){const W=b[P];if(W&&W.health>0&&W.actionPoints>0){z=!0;break}P+=1}z?(e.debug(`Moving to next valid enemy at index ${P}`),lt(P)):(e.debug("All enemies processed, switching back to player."),t(Je()),t(gt()),lt(0));return}if(zt.current)return;e.debug(`Scheduling action for enemy index ${Ae}: ${k.id} (AP: ${k.actionPoints})`),zt.current=k.id;let j=null;Ot.current=window.setTimeout(()=>{if(e.debug(`>>> setTimeout CALLBACK for index ${Ae}`),!u){e.debug("Combat ended, skipping enemy action"),Re(!1);return}try{e.debug(`Enemy Turn AI: START for ${k.id}`);const P=[];for(let W=0;W<i.height;W+=1)for(let se=0;se<i.width;se+=1)i.tiles[W][se].provideCover&&P.push({x:se,y:W});e.debug(`Enemy Turn AI: Got cover positions for ${k.id}`);const z=fi(k,r,i,b,P,i.entities.npcs,ge.current);if(j=z,e.debug(`Enemy ${k.id} action: ${z.action}, AP left: ${z.enemy.actionPoints}`),z.action==="attack"||z.action==="attack_missed"){const W=r.health-z.player.health;W>0?(t(Tt({id:We(),value:W,gridX:r.position.x,gridY:r.position.y,type:z.isCritical?"crit":"damage"})),t(mi({id:We(),type:z.isCritical?"crit":"damage",intensity:.6,duration:300}))):z.action==="attack_missed"&&t(Tt({id:We(),value:0,gridX:r.position.x,gridY:r.position.y,type:"miss"}))}e.debug(`Enemy Turn AI: BEFORE dispatching updates for ${k.id}`),t(pn(z.enemy)),e.debug(`Enemy Turn AI: AFTER dispatch(updateEnemy) for ${k.id}`),z.player.id===r.id&&(e.debug(`Enemy Turn AI: BEFORE dispatch(setPlayerData) for ${k.id}`),t(Mr(z.player)),e.debug(`Enemy Turn AI: AFTER dispatch(setPlayerData) for ${k.id}`)),e.debug(`Enemy Turn AI: END AI & Dispatches for ${k.id}`)}catch(P){e.error("Error during enemy turn AI:",{enemyId:k==null?void 0:k.id,error:P})}finally{const P=(j==null?void 0:j.enemy)??k,z=P&&P.health>0&&P.actionPoints>0;e.debug(`Enemy Turn FINALLY for index ${Ae}. Remaining AP: ${(P==null?void 0:P.actionPoints)??k.actionPoints}. Repeat: ${z}`),Re(!1),z||lt(W=>W+1)}},500)},[u,h,Ae,b,t,r,i,Re,e]),c.useEffect(()=>()=>{Re()},[Re]),c.useEffect(()=>{const p=ot.current;return()=>{p.dispose(),Le.current=null}},[]),c.useEffect(()=>{if(!u){St.current=null;return}h&&St.current!==q&&(St.current=q,t(pi()))},[t,u,h,q]),c.useEffect(()=>{st.current&&!u&&(t(F(O.combatOver)),e.debug("Combat ended (detected via useEffect watching inCombat)."),t(gt())),st.current=u},[u,t,e,O]);const ir=c.useCallback((p,k)=>{var V,Z;const j=((V=r.equipped.weapon)==null?void 0:V.apCost)??gi,P=Number.isFinite(r.encumbrance.attackApMultiplier)?Math.max(r.encumbrance.attackApMultiplier,0):Number.POSITIVE_INFINITY,z=hi(r)?0:Math.ceil(Math.max(0,j)*P);if(!Number.isFinite(z)||r.actionPoints<z){t(F(O.notEnoughAp));return}const W=((Z=r.equipped.weapon)==null?void 0:Z.range)??1;if(!gn(r.position,p.position,W)){t(F(O.enemyOutOfRange));return}const se=k.tiles[p.position.y][p.position.x].provideCover;e.debug("attackEnemy: PRE-ATTACK",{enemyId:p.id,enemyPosition:p.position,isBehindCover:se,playerAP_before:r.actionPoints,attackCost:z});const H=bi(r,p,se),U=H.newAttacker;t(Mr(U)),H.events&&H.events.forEach(ce=>t(F(ce.message))),e.debug("attackEnemy: POST-ATTACK",{apCost:z,playerAP_after:U.actionPoints}),H.success?(t(F(O.hitEnemy(p.name,H.damage))),t(Tt({id:We(),value:H.damage,gridX:p.position.x,gridY:p.position.y,type:H.isCritical?"crit":"damage"}))):(t(F(O.missedEnemy(p.name))),t(Tt({id:We(),value:0,gridX:p.position.x,gridY:p.position.y,type:"miss"})));const pe=H.newTarget;e.debug("attackEnemy: PRE-DISPATCH updateEnemy",{enemyId:pe.id,healthBeforeUpdate:p.health,healthInNewTarget:pe.health}),t(pn(pe)),b.some(ce=>ce.id!==p.id||ce.id===p.id&&H.newTarget.health>0)?U.actionPoints<=0&&(e.debug("attackEnemy: Player out of AP after attack, switching turn."),t(Je())):t(F(O.allEnemiesDefeated))},[r,b,t,e,O]),ln=c.useCallback(p=>b.length===0?null:b.reduce((k,j)=>{const P=Math.abs(j.position.x-p.x)+Math.abs(j.position.y-p.y),z=Math.abs(k.position.x-p.x)+Math.abs(k.position.y-p.y);return P<z?j:k}),[b]),or=c.useCallback(p=>{if(!i)return null;const k=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1},{x:1,y:1},{x:-1,y:-1},{x:-1,y:1},{x:1,y:-1}];for(const j of k){const P={x:p.x+j.x,y:p.y+j.y};if(P.x<0||P.y<0||P.x>=i.width||P.y>=i.height)continue;const z=i.tiles[P.y],W=z?z[P.x]:void 0;if(!W||!W.isWalkable)continue;if(!b.some(H=>H.position.x===P.x&&H.position.y===P.y))return P}return null},[i,b]),Es=c.useCallback(p=>{var z,W,se;const k=p.key,j=(i==null?void 0:i.isInterior)??!1;if(p.shiftKey&&(k==="A"||k==="a")){p.preventDefault(),p.stopPropagation(),t(An(!te));return}if(te&&u&&((z=kt.current)==null||z.notifyManualOverride("manual_input"),t(An(!1))),A){p.preventDefault(),p.stopPropagation(),k==="Escape"&&(t(Zt()),t(F(O.conversationEnded)));return}if(k==="e"||k==="E"){if(p.preventDefault(),p.stopPropagation(),!i)return;const H=i.entities.npcs.find(K=>!K.isInteractive||!K.dialogueId?!1:Math.abs(K.position.x-r.position.x)+Math.abs(K.position.y-r.position.y)<=1);if(!H){t(F(O.noFriendlyContact));return}const U=R.find(K=>K.id===H.dialogueId);if(!U||U.nodes.length===0){t(F(O.npcNoNewInfo(H.name)));return}const pe=U.nodes[0].id;t(gr({dialogueId:U.id,nodeId:pe})),t(F(O.npcChannelOpened(H.name)));return}if(k==="Tab"&&u&&h){p.preventDefault(),p.stopPropagation(),t(F(O.endingTurn??"Ending turn...")),t(Je());return}if(k===" "){if(p.preventDefault(),p.stopPropagation(),Te.length>0&&(Se([]),Ie(null),ke(null)),!u){const H=ln(r.position),U=((W=r.equipped.weapon)==null?void 0:W.range)??1;if(H&&gn(r.position,H.position,U)){t(_t()),t(F(O.enteredCombat));return}}if(u&&h){const H=ln(r.position),U=((se=r.equipped.weapon)==null?void 0:se.range)??1;if(H&&gn(r.position,H.position,U)){ir(H,i);return}t(F(O.noEnemiesInRange));return}return}if(u&&(!h||r.actionPoints<=0)){if(b.filter(U=>U.health>0).length===0){t(yi()),t(gt()),t(F(O.zoneSecured));return}if(!h){t(F(O.notYourTurn));return}if(r.actionPoints<=0){t(F(O.actionPointsDepleted)),t(Je());return}}Te.length>0&&(Se([]),Ie(null),ke(null));const P={...r.position};switch(k){case"ArrowUp":case"w":case"W":P.y-=1;break;case"ArrowDown":case"s":case"S":P.y+=1;break;case"ArrowLeft":case"a":case"A":P.x-=1;break;case"ArrowRight":case"d":case"D":P.x+=1;break;default:return}if(p.preventDefault(),p.stopPropagation(),$t(P,i,r,b,{npcs:i.entities.npcs})){const H=i.tiles[P.y][P.x],U=_.find(K=>K.fromAreaId===i.id&&K.fromPosition.x===P.x&&K.fromPosition.y===P.y),pe=!u&&p.shiftKey;if(U){const K=C[U.toAreaId];if(x&&H.type===Sr.DOOR&&K&&!K.isInterior){t(F(O.checkpointSealed));return}if(K){if(!dt({sprint:pe}))return;t(Ir(K)),t(Ut(U.toPosition)),K.isInterior&&(t(Kt({type:"campfireRest",locationId:K.id})),t(F(O.slipInsideStructure)),Ve("clear"))}else e.warn(`Missing target area in state for ${U.toAreaId}`);Se([]),Ie(null);return}if(!dt({sprint:pe}))return;if(t(Ut(P)),x&&!j){if(Ft==="clear")t(F(O.searchlightsWarning)),Ve("warning");else if(Ft==="warning"){const K=or(P);if(K){const V={id:We(),name:O.curfewPatrolName,position:K,maxHealth:30,health:30,actionPoints:6,maxActionPoints:6,damage:6,attackRange:1,isHostile:!0};t(Er(V)),t(Kt({type:"patrolAmbush",locationId:i==null?void 0:i.id,tags:["corpsec"]})),u?t(F(O.curfewReinforcement)):(t(_t()),t(F(O.curfewOpenFire)))}else t(F(O.curfewFootsteps));Ve("spawned")}}else Ft!=="clear"&&Ve("clear");u&&(e.debug("handleKeyDown: PRE-MOVE AP DEDUCTION",{apCost:1,playerAP_before:r.actionPoints}),t(xi(-1)),e.debug("handleKeyDown: POST-MOVE AP DEDUCTION",{apCost:1,playerAP_after:r.actionPoints-1}),r.actionPoints<=1&&(e.debug("handleKeyDown: Player out of AP after move, switching turn."),t(Je())))}},[r,i,u,h,t,b,ir,ln,x,Ft,or,C,Te,Se,Ie,A,_,R,e,O,dt,te]),Ms=c.useCallback(p=>{p.key},[]);return s.jsx("div",{ref:ut,tabIndex:0,onKeyDown:Es,onKeyUp:Ms,className:"fixed inset-0 focus:outline-none",style:{zIndex:1},"data-testid":"game-controller",children:s.jsx(ls,{zoneId:(i==null?void 0:i.zoneId)??null})})},ql=(...e)=>e.filter(Boolean).join(" "),Yl=(e,t,n,r)=>r==="none"?"base":r==="ascending"?e>=n?"critical":e>=t?"warning":"base":e<=n?"critical":e<=t?"warning":"base",$r=({label:e,current:t,max:n,icon:r,variant:a="neutral",lowThreshold:o=50,criticalThreshold:l=25,disableGlow:i=!1,dangerDirection:d="descending"})=>{const m=c.useMemo(()=>{if(n<=0)return 0;const u=t/n*100;return Math.max(0,Math.min(100,u))},[t,n]),f=Yl(m,o,l,d);return s.jsxs("div",{className:"hud-stat","data-variant":a,"data-level":f,"data-glow":i?"off":"on",children:[s.jsxs("div",{className:ql("hud-stat__row",f!=="base"?"hud-stat__row--emphasis":null),children:[s.jsxs("div",{className:"flex items-center gap-[0.4rem]",children:[r?s.jsx("span",{className:"hud-stat__icon",children:r}):null,s.jsx("span",{children:e})]}),s.jsxs("span",{className:"hud-stat__value","aria-live":"polite",children:[t,"/",n]})]}),s.jsx("div",{className:"hud-stat__bar",children:s.jsx("div",{className:"hud-stat__fill",style:{width:`${m}%`}})})]})},Kl=(...e)=>e.filter(Boolean).join(" "),ms=c.forwardRef(({className:e,title:t,children:n,role:r,...a},o)=>s.jsxs("svg",{ref:o,viewBox:"0 0 24 24",className:Kl("h-4 w-4 shrink-0 text-current",e),role:t?r??"img":"presentation","aria-hidden":t?void 0:!0,...a,children:[t?s.jsx("title",{children:t}):null,n]}));ms.displayName="IconBase";const Xl=({className:e,...t})=>s.jsxs(ms,{className:e,...t,children:[s.jsx("path",{d:"M12 4.8 4 18.4c-.4.7.1 1.6.9 1.6h14.2c.8 0 1.3-.9.9-1.6L12 4.8z",fill:"currentColor",fillOpacity:.2}),s.jsx("path",{d:"M12 4.8 4 18.4c-.4.7.1 1.6.9 1.6h14.2c.8 0 1.3-.9.9-1.6L12 4.8z",stroke:"currentColor",strokeWidth:1.8,strokeLinejoin:"round",fill:"none"}),s.jsx("path",{d:"M12 9.8v3.8",stroke:"currentColor",strokeWidth:1.8,strokeLinecap:"round",fill:"none"}),s.jsx("circle",{cx:12,cy:16.6,r:1,fill:"currentColor"})]}),Ql=({onOpenCharacter:e,characterOpen:t=!1,showActionButton:n=!0,className:r,variant:a="default"})=>{const o=De(),l=E(y=>y.player.data),i=E(is),d=E(y=>y.settings.locale),m=E(y=>y.settings.testMode),f=Pe(d),u=l.backgroundId?Ei[l.backgroundId]:void 0,h=(u==null?void 0:u.name)??f.playerStatus.backgroundFallback,v=Math.round(i),x=f.playerStatus.movementBadge[l.movementProfile]??l.movementProfile.toUpperCase(),b=()=>{const y=l.level,N=Ci(y+1),R=l.experience,$=N-R;o(Rn({amount:Math.max(1,$),reason:"Test mode XP boost"}))},C=a==="frameless"?"flex h-full min-h-0 flex-1 flex-col gap-[0.5rem] px-0 py-0 text-[#f8fafc] font-body":"flex flex-col gap-[0.5rem] rounded-[18px] border border-[rgba(59,130,246,0.22)] bg-[linear-gradient(145deg,rgba(8,15,30,0.92),rgba(12,22,42,0.82),rgba(6,12,28,0.92))] px-[0.9rem] py-[0.9rem] text-[#f8fafc] shadow-[0_20px_30px_-20px_rgba(8,12,24,0.5)] backdrop-blur-[14px] font-body",_=r?`${C} ${r}`:C;return s.jsxs("div",{className:_,"data-testid":"player-summary-panel",children:[s.jsx("div",{className:"flex items-start justify-between gap-[0.75rem]",children:s.jsxs("div",{className:"flex min-w-0 flex-1 flex-col gap-[0.2rem]",children:[s.jsxs("div",{className:"flex items-center gap-[0.5rem] text-[0.9rem] uppercase tracking-[0.26em] text-[#bfdbfe] drop-shadow-[0_0_8px_rgba(56,189,248,0.4)]",children:[s.jsx("span",{className:"truncate",children:l.name}),s.jsxs("span",{className:"inline-flex items-center gap-[0.25rem] rounded-[999px] border border-[rgba(56,189,248,0.45)] bg-[rgba(56,189,248,0.18)] px-[0.55rem] py-[0.22rem] text-[0.6rem] font-semibold tracking-[0.14em] text-[#f8fafc] shadow-[0_10px_20px_-10px_rgba(56,189,248,0.55)]",children:[f.playerStatus.levelLabel," ",l.level]}),l.movementProfile!=="normal"&&s.jsx("span",{className:"inline-flex items-center gap-[0.25rem] rounded-[999px] border border-[rgba(148,163,184,0.65)] bg-[rgba(148,163,184,0.12)] px-[0.55rem] py-[0.22rem] text-[0.55rem] font-semibold tracking-[0.14em] text-[#e2e8f0] shadow-[0_8px_18px_-12px_rgba(148,163,184,0.55)]",children:x})]}),s.jsx("div",{className:"text-[0.6rem] uppercase tracking-[0.12em] text-[rgba(226,232,240,0.72)]",children:h})]})}),s.jsx($r,{label:f.playerStatus.healthLabel,current:l.health,max:l.maxHealth,variant:"health",lowThreshold:50,criticalThreshold:25}),s.jsx($r,{label:f.playerStatus.paranoiaLabel,current:v,max:100,variant:"paranoia",lowThreshold:50,criticalThreshold:75,dangerDirection:"ascending"}),l.isExhausted&&s.jsxs("span",{className:"mt-[0.35rem] inline-flex items-center gap-[0.3rem] rounded-[999px] border border-[rgba(250,204,21,0.65)] bg-[rgba(250,204,21,0.08)] px-[0.55rem] py-[0.22rem] text-[0.55rem] font-semibold uppercase tracking-[0.14em] text-[#facc15] shadow-[0_8px_18px_-12px_rgba(250,204,21,0.6)]",title:f.playerStatus.fatigueHint,children:[s.jsx(Xl,{className:"text-[#facc15]","aria-hidden":!0}),s.jsx("span",{children:f.playerStatus.fatigueStatus})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-[0.28rem]",children:[s.jsxs("div",{className:"flex min-w-0 flex-col gap-[0.12rem] rounded-[12px] border border-[rgba(248,250,252,0.08)] bg-[linear-gradient(160deg,rgba(14,26,52,0.88),rgba(10,18,34,0.88))] px-[0.5rem] py-[0.45rem] shadow-[0_16px_30px_-20px_rgba(13,148,136,0.6)]",children:[s.jsx("span",{className:"text-[0.5rem] uppercase tracking-[0.12em] text-[rgba(148,163,184,0.7)]",children:f.playerStatus.creditsLabel}),s.jsxs("span",{className:"text-[0.85rem] font-semibold text-[#fbbf24] drop-shadow-[0_0_12px_rgba(251,191,36,0.5)]",children:["₿",l.credits]})]}),s.jsxs("div",{className:"flex min-w-0 flex-col gap-[0.12rem] rounded-[12px] border border-[rgba(248,250,252,0.08)] bg-[linear-gradient(160deg,rgba(14,26,52,0.88),rgba(10,18,34,0.88))] px-[0.5rem] py-[0.45rem] shadow-[0_16px_30px_-20px_rgba(13,148,136,0.6)]",children:[s.jsx("span",{className:"text-[0.5rem] uppercase tracking-[0.12em] text-[rgba(148,163,184,0.7)]",children:f.playerStatus.experienceLabel}),s.jsx("span",{className:"text-[0.85rem] font-semibold text-[#38bdf8] drop-shadow-[0_0_12px_rgba(56,189,248,0.45)]",children:Mi(l.experience,l.level)})]})]}),e&&n&&s.jsxs("div",{className:"flex gap-[0.5rem]",children:[s.jsx("button",{type:"button",onClick:e,className:["flex-1 rounded-[999px] border px-[0.75rem] py-[0.42rem] text-[0.58rem] font-semibold uppercase tracking-[0.18em] text-[#e0f2fe] shadow-[0_12px_20px_-18px_rgba(56,189,248,0.45)] transition-transform duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-neon/60 focus-visible:ring-offset-2 focus-visible:ring-offset-gunmetal-900",t?"border-[rgba(251,191,36,0.9)] bg-[linear-gradient(130deg,rgba(251,191,36,0.6),rgba(249,115,22,0.55))] text-[#fff7e1]":"border-[rgba(56,189,248,0.55)] bg-[linear-gradient(130deg,rgba(56,189,248,0.48),rgba(14,165,233,0.45))]"].join(" "),"data-testid":"summary-open-character","aria-pressed":t,children:f.shell.characterButton}),m&&s.jsx("button",{type:"button",onClick:b,className:"flex-1 rounded-[999px] border border-[rgba(251,191,36,0.9)] bg-[linear-gradient(130deg,rgba(251,191,36,0.48),rgba(249,115,22,0.45))] px-[0.75rem] py-[0.38rem] text-[0.58rem] font-semibold uppercase tracking-[0.18em] text-[#fff8dc] shadow-[0_12px_20px_-16px_rgba(251,191,36,0.48)] transition-all duration-200 hover:-translate-y-[2px] hover:scale-[1.01] hover:border-[rgba(251,191,36,1)] hover:shadow-[0_0_0_2px_rgba(251,191,36,0.4),0_14px_24px_-16px_rgba(251,191,36,0.6)] focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-400 focus-visible:ring-offset-2 focus-visible:ring-offset-gunmetal-900",title:"Test Mode: Gain XP to level up",children:"⬆ Level Up"})]})]})},Zl=Lt.memo(Ql),Jl=new Set(["morning","day"]),ec=e=>{const t=Math.max(0,Math.round(e)),n=Math.floor(t/60),r=t%60;return`${n.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`},tc=(e,t)=>{const n=Wn,{cycleDuration:r,morningStartTime:a,eveningStartTime:o}=n;if(r<=0)return{progress:1,secondsUntilChange:0};const i=(e%r+r)%r/r,d=t==="day"?a:o,m=t==="day"?o:a+1;let f=i;f<d&&(f+=1);const u=m-d,h=Math.max(u*r,0),v=Math.min(h,Math.max(0,(f-d)*r)),x=Math.max(0,h-v),b=h>0?v/h:1;return{progress:Math.min(1,Math.max(0,b)),secondsUntilChange:x}},nc=()=>{const{currentTime:e,timeOfDay:t,curfewActive:n}=E(C=>C.world),r=E(C=>C.settings.locale),o=Pe(r).dayNight,l=Jl.has(t)?"day":"night",{progress:i,secondsUntilChange:d}=tc(e,l),m=l==="day"?o.timeOfDay.day:o.timeOfDay.night,f=l==="day"?o.timeOfDay.night:o.timeOfDay.day,u=Math.min(100,Math.max(4,i*100)),h=Math.round(i*100),v=ec(d),x=`${m} phase; ${h}% complete; ${f} in ${v}.`;return s.jsxs(s.Fragment,{children:[s.jsx("style",{children:`
    .day-night-wafer {
      --accent: rgba(56, 189, 248, 0.78);
      --accent-border: rgba(56, 189, 248, 0.42);
      --accent-shadow: rgba(37, 99, 235, 0.28);
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.55rem 0.85rem;
      min-width: 14.5rem;
      width: 14.5rem;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(14, 19, 31, 0.96), rgba(17, 24, 39, 0.84));
      border: 1px solid var(--accent-border);
      box-shadow: 0 18px 32px rgba(6, 11, 21, 0.55);
      color: #e2e8f0;
      font-family: 'DM Mono', 'IBM Plex Mono', monospace;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      overflow: hidden;
      pointer-events: none;
    }

    .day-night-wafer::before,
    .day-night-wafer::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 2px;
      background: rgba(56, 189, 248, 0.28);
      pointer-events: none;
    }

    .day-night-wafer::before {
      top: 9px;
      left: 12px;
      transform: rotate(-14deg);
      box-shadow: 0 0 8px var(--accent-border);
    }

    .day-night-wafer::after {
      bottom: 10px;
      right: 14px;
      transform: rotate(18deg);
      box-shadow: 0 0 8px rgba(148, 163, 184, 0.24);
    }

    .day-night-wafer[data-phase="day"] {
      --accent: rgba(251, 191, 36, 0.82);
      --accent-border: rgba(251, 191, 36, 0.42);
      --accent-shadow: rgba(245, 158, 11, 0.3);
    }

    .day-night-wafer[data-phase="night"] {
      --accent: rgba(94, 234, 212, 0.8);
      --accent-border: rgba(94, 234, 212, 0.45);
      --accent-shadow: rgba(45, 212, 191, 0.32);
    }

    .day-night-wafer[data-curfew="true"] {
      --accent: rgba(248, 113, 113, 0.78);
      --accent-border: rgba(248, 113, 113, 0.5);
      --accent-shadow: rgba(185, 28, 28, 0.38);
      box-shadow: 0 0 24px rgba(127, 29, 29, 0.38);
    }

    .day-night-wafer__scanline {
      position: absolute;
      inset: 0;
      left: -120%;
      width: 120%;
      background: linear-gradient(90deg, transparent 0%, rgba(94, 234, 212, 0.18) 45%, transparent 85%);
      mix-blend-mode: screen;
      opacity: 0;
      animation: hud-wafer-scan 12s linear infinite;
      pointer-events: none;
    }

    @keyframes hud-wafer-scan {
      0% { transform: translateX(-35%); opacity: 0; }
      10% { opacity: 0.35; }
      22% { transform: translateX(55%); opacity: 0; }
      100% { transform: translateX(55%); opacity: 0; }
    }

    .day-night-wafer__icon {
      position: relative;
      width: 2.25rem;
      height: 2.25rem;
      border-radius: 0.7rem;
      background: linear-gradient(140deg, rgba(32, 45, 63, 0.9), rgba(20, 28, 44, 0.84));
      box-shadow: inset 0 0 12px rgba(8, 12, 20, 0.7), 0 0 14px var(--accent-shadow);
      transition: transform 180ms ease-out, box-shadow 240ms ease-out;
    }

    .day-night-wafer[data-phase="day"] .day-night-wafer__icon {
      transform: rotate(2deg);
      box-shadow: inset 0 0 14px rgba(15, 23, 42, 0.72), 0 0 18px var(--accent-shadow);
    }

    .day-night-wafer[data-phase="night"] .day-night-wafer__icon {
      transform: rotate(-3deg);
      box-shadow: inset 0 0 16px rgba(10, 12, 24, 0.82), 0 0 18px var(--accent-shadow);
    }

    .day-night-wafer__icon::before,
    .day-night-wafer__icon::after {
      content: '';
      position: absolute;
      pointer-events: none;
    }

    .day-night-wafer[data-phase="day"] .day-night-wafer__icon::before {
      top: 50%;
      left: 50%;
      width: 1.35rem;
      height: 1.35rem;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      background: radial-gradient(circle at 40% 35%, rgba(255, 237, 179, 0.95) 0%, rgba(251, 191, 36, 0.85) 55%, rgba(217, 119, 6, 0.2) 100%);
      box-shadow: 0 0 16px var(--accent-shadow);
    }

    .day-night-wafer[data-phase="day"] .day-night-wafer__icon::after {
      top: 50%;
      left: 50%;
      width: 2rem;
      height: 2rem;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      background: conic-gradient(
        from 0deg,
        rgba(251, 191, 36, 0.45) 0deg 18deg,
        transparent 18deg 45deg
      );
      filter: blur(0.35px);
    }

    .day-night-wafer[data-phase="night"] .day-night-wafer__icon::before {
      top: 50%;
      left: 50%;
      width: 1.45rem;
      height: 1.45rem;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      background: radial-gradient(circle at 45% 40%, rgba(199, 210, 254, 0.9) 0%, rgba(129, 140, 248, 0.88) 55%, rgba(79, 70, 229, 0.25) 100%);
      box-shadow: 0 0 16px var(--accent-shadow);
    }

    .day-night-wafer[data-phase="night"] .day-night-wafer__icon::after {
      top: 50%;
      left: 58%;
      width: 1.45rem;
      height: 1.45rem;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      background: rgba(14, 21, 35, 0.95);
      box-shadow: -6px 0 12px rgba(53, 63, 91, 0.38);
    }

    .day-night-wafer__content {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .day-night-wafer__tag {
      font-size: 0.74rem;
      letter-spacing: 0.24em;
      color: rgba(226, 232, 240, 0.8);
    }

    .day-night-wafer[data-phase="day"] .day-night-wafer__tag,
    .day-night-wafer[data-phase="night"] .day-night-wafer__tag,
    .day-night-wafer[data-curfew="true"] .day-night-wafer__tag {
      color: var(--accent);
    }

    .day-night-wafer__bar {
      position: relative;
      width: 8.9rem;
      height: 6px;
      border-radius: 999px;
      background: rgba(11, 17, 28, 0.92);
      border: 1px solid rgba(94, 107, 139, 0.45);
      overflow: hidden;
    }

    .day-night-wafer__bar-fill {
      position: relative;
      height: 100%;
      width: 50%;
      background: var(--accent);
      box-shadow: 0 0 12px var(--accent-shadow);
      transition: width 240ms ease-out, background 200ms ease-out, box-shadow 200ms ease-out;
    }

    .day-night-wafer__bar-noise {
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(
        90deg,
        rgba(148, 163, 184, 0.06) 0px 7px,
        transparent 7px 14px
      );
      mix-blend-mode: overlay;
      opacity: 0.35;
      pointer-events: none;
    }

    @media (max-width: 1120px) {
      .day-night-wafer {
        min-width: auto;
      }
    }
  `}),s.jsxs("div",{className:"day-night-wafer","data-phase":l,"data-curfew":n||void 0,role:"status","aria-label":x,children:[s.jsx("span",{className:"day-night-wafer__scanline","aria-hidden":!0}),s.jsx("div",{className:"day-night-wafer__icon","aria-hidden":!0}),s.jsxs("div",{className:"day-night-wafer__content","aria-hidden":!0,children:[s.jsx("span",{className:"day-night-wafer__tag",children:l==="day"?"DAY":"NIGHT"}),s.jsxs("div",{className:"day-night-wafer__bar",children:[s.jsx("div",{className:"day-night-wafer__bar-fill",style:{width:`${u}%`}}),s.jsx("div",{className:"day-night-wafer__bar-noise"})]})]})]})]})},Vt=8,ps={liveArea:20,stroke:2},Ur={floor:"#101b32",wall:"#1f2937",door:"#fbbf24",cover:"#1d4ed8",water:"#0ea5e9",trap:"#7c3aed",default:"#101b32"},Gr={player:"#60a5fa",enemy:"#f87171",npc:"#34d399",objective:"#facc15"},Vr={[J.IDLE]:"#38bdf8",[J.SUSPICIOUS]:"#fbbf24",[J.ALARMED]:"#ef4444",[J.DISABLED]:"#64748b"},tn=ps.stroke,gs=ps.liveArea/2,rc="rgba(15, 23, 42, 0.95)",qr=16,ac=256,sc=192,ic=192,oc=160,hs=(e,t)=>{if(typeof window>"u"||typeof document>"u")return t;try{const n=window.getComputedStyle(document.documentElement).getPropertyValue(e);return(n==null?void 0:n.trim())||t}catch{return t}},bs=()=>hs("--color-hud-surface",rc),lc=()=>{const e=hs("--hud-radius-lg",`${qr}px`),t=Number.parseFloat(e);return Number.isFinite(t)?t:qr},Dn=e=>({minX:0,minY:0,maxX:Math.max(0,e.mapWidth-1),maxY:Math.max(0,e.mapHeight-1),width:Math.max(1,e.mapWidth),height:Math.max(1,e.mapHeight)}),qt=e=>{var n;if(!e)return!1;const t=((n=e.type)==null?void 0:n.toString().toLowerCase())??"";return t==="wall"||t==="door"||t==="cover"?!0:e.isWalkable===!1},vn=e=>{var b;const t=e.tiles;if(!t.length||!((b=t[0])!=null&&b.length))return Dn(e);const n=(C,_,y)=>Math.min(Math.max(C,_),y),r=C=>{if(!C)return-1;for(let _=0;_<C.length;_+=1)if(qt(C[_]))return _;return-1},a=C=>{if(!C)return-1;for(let _=C.length-1;_>=0;_-=1)if(qt(C[_]))return _;return-1},o=C=>{for(let _=0;_<t.length;_+=1){const y=t[_];if(y&&qt(y[C]))return _}return-1},l=C=>{for(let _=t.length-1;_>=0;_-=1){const y=t[_];if(y&&qt(y[C]))return _}return-1};let i=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY,m=Number.POSITIVE_INFINITY,f=Number.NEGATIVE_INFINITY;for(let C=0;C<t.length;C+=1){const _=t[C],y=r(_);y!==-1&&y<i&&(i=y);const N=a(_);N!==-1&&N>d&&(d=N)}for(let C=0;C<e.mapWidth;C+=1){const _=o(C);_!==-1&&_<m&&(m=_);const y=l(C);y!==-1&&y>f&&(f=y)}if(!Number.isFinite(i)||!Number.isFinite(d)||!Number.isFinite(m)||!Number.isFinite(f))return Dn(e);const u=n(i,0,Math.max(0,e.mapWidth-1)),h=n(d,u,Math.max(0,e.mapWidth-1)),v=n(m,0,Math.max(0,e.mapHeight-1)),x=n(f,v,Math.max(0,e.mapHeight-1));return{minX:u,minY:v,maxX:h,maxY:x,width:Math.max(1,h-u+1),height:Math.max(1,x-v+1)}},At=(e,t,n)=>Math.min(Math.max(e,t),n),Yr=(e,t)=>Math.min(gs,Math.max(3,e*t)),rt=(e,t=tn)=>Math.max(.5,t)/Math.max(e,1e-4),cc=(e,t,n,r,a,o)=>{const l=Math.max(0,Math.min(o,Math.min(r,a)/2));e.beginPath(),e.moveTo(t+l,n),e.lineTo(t+r-l,n),e.quadraticCurveTo(t+r,n,t+r,n+l),e.lineTo(t+r,n+a-l),e.quadraticCurveTo(t+r,n+a,t+r-l,n+a),e.lineTo(t+l,n+a),e.quadraticCurveTo(t,n+a,t,n+a-l),e.lineTo(t,n+l),e.quadraticCurveTo(t,n,t+l,n),e.closePath()},Sn=(e,t)=>{const n=1.3333333333333333,r=Math.max(1,Math.round(t.width)),a=Math.max(1,Math.round(t.height));let o=Math.max(1,e.width),l=Math.max(1,e.height);return o/l>n?o=l*n:l=o/n,o>r&&(o=r,l=o/n),l>a&&(l=a,o=l*n,o>r&&(o=r,l=o/n)),{width:Math.max(1,Math.round(o)),height:Math.max(1,Math.round(l))}},dc=(e,t,n)=>{if(!e)return null;const r=window.devicePixelRatio||1,a=Math.max(1,Math.round(t*r)),o=Math.max(1,Math.round(n*r));e.width!==a&&(e.width=a),e.height!==o&&(e.height=o),e.style.width=`${t}px`,e.style.height=`${n}px`;const l=e.getContext("2d");return l?(l.setTransform(r,0,0,r,0,0),l.imageSmoothingEnabled=!1,l):null},uc=({ctx:e,state:t,crop:n})=>{const{tiles:r,tileScale:a}=t,o=bs();e.fillStyle=o,e.fillRect(n.minX*a,n.minY*a,n.width*a,n.height*a);for(let l=n.minY;l<=n.maxY;l+=1){const i=r[l];if(i)for(let d=n.minX;d<=n.maxX;d+=1){const m=i[d];if(!m)continue;const f=Ur[m.type.toLowerCase()]??Ur.default;e.fillStyle=f,e.fillRect(d*a,l*a,a,a),m.provideCover&&(e.fillStyle="rgba(59, 130, 246, 0.15)",e.fillRect(d*a,l*a,a,a))}}},fc=({ctx:e,state:t,scale:n,crop:r})=>{const{tileScale:a,entities:o,cameras:l}=t,i=t.objectiveMarkers??[];o.forEach(d=>{if(d.x<r.minX||d.x>r.maxX||d.y<r.minY||d.y>r.maxY)return;const m=Gr[d.kind]??Gr.npc,f=Yr(a,d.kind==="player"?.7:.5),u=(d.x+.5)*a,h=(d.y+.5)*a;d.kind==="player"?(e.fillStyle=m,e.beginPath(),e.moveTo(u,h-f),e.lineTo(u+f,h+f),e.lineTo(u-f,h+f),e.closePath(),e.fill()):(e.fillStyle=d.status==="inactive"?"rgba(148, 163, 184, 0.35)":m,e.beginPath(),e.arc(u,h,f*.85,0,Math.PI*2),e.fill(),d.kind==="enemy"&&(e.strokeStyle="rgba(15, 23, 42, 0.85)",e.lineWidth=rt(n),e.stroke()))}),i.forEach(d=>{if(d.x<r.minX||d.x>r.maxX||d.y<r.minY||d.y>r.maxY)return;const m=Math.min(gs,Math.max(5,a*.55)),f=(d.x+.5)*a,u=(d.y+.5)*a;e.fillStyle="rgba(251, 191, 36, 0.2)",e.beginPath(),e.arc(f,u,m,0,Math.PI*2),e.fill(),e.strokeStyle="rgba(251, 191, 36, 0.95)",e.lineWidth=rt(n),e.beginPath(),e.arc(f,u,m*.7,0,Math.PI*2),e.stroke()}),l.forEach(d=>{if(d.x<r.minX||d.x>r.maxX||d.y<r.minY||d.y>r.maxY)return;const m=d.isActive?Vr[d.alertState]:Vr[J.DISABLED],f=Yr(a,.5),u=(d.x+.5)*a,h=(d.y+.5)*a;e.save(),e.fillStyle=m,e.beginPath(),e.moveTo(u,h-f),e.lineTo(u+f,h+f),e.lineTo(u-f,h+f),e.closePath(),e.fill(),e.lineWidth=rt(n),e.strokeStyle="rgba(15, 23, 42, 0.65)",e.stroke(),e.restore()})},mc=({ctx:e,state:t,scale:n})=>{const{path:r,tileScale:a}=t;if(!r||r.length<2)return;e.strokeStyle="rgba(59, 130, 246, 0.6)",e.lineWidth=rt(n,tn*.95),e.lineJoin="round",e.lineCap="round",e.setLineDash([a*.8,a*.5]),e.beginPath(),r.forEach((d,m)=>{const f=(d.x+.5)*a,u=(d.y+.5)*a;m===0?e.moveTo(f,u):e.lineTo(f,u)}),e.stroke(),e.setLineDash([]);const o=r[r.length-1],l=(o.x+.5)*a,i=(o.y+.5)*a;e.fillStyle="rgba(59, 130, 246, 0.12)",e.beginPath(),e.arc(l,i,Math.max(4,a*.4),0,Math.PI*2),e.fill(),e.strokeStyle="rgba(59, 130, 246, 0.7)",e.lineWidth=rt(n),e.beginPath(),e.arc(l,i,Math.max(3,a*.28),0,Math.PI*2),e.stroke()},pc=({ctx:e,state:t,scale:n},r)=>{const{viewport:a,tileScale:o}=t;if(!a||a.width<=0||a.height<=0)return;const l=r.width,i=r.height,d=l*o,m=i*o,f=(a.x+a.width/2)*o,u=(a.y+a.height/2)*o,h=f-d/2,v=u-m/2,x=Math.min(Math.max(4,d*.12),lc()/Math.max(n,1e-4));e.save(),e.lineWidth=rt(n,tn*.85),e.strokeStyle="rgba(148, 163, 184, 0.4)",cc(e,h,v,d,m,x),e.stroke(),e.restore();const b=Math.max(2,o*.5);e.save(),e.strokeStyle="rgba(148, 163, 184, 0.5)",e.lineWidth=rt(n,tn*.75),e.beginPath(),e.moveTo(f-b,u),e.lineTo(f+b,u),e.moveTo(f,u-b),e.lineTo(f,u+b),e.stroke(),e.restore()},gc=(e,t,n,r,a,o)=>{const l=dc(e,n,r);if(!l)return;l.clearRect(0,0,n,r),l.fillStyle=bs(),l.fillRect(0,0,n,r);const i=o.width*t.tileScale,d=o.height*t.tileScale;if(i<=0||d<=0)return;const m=Math.min(n/i,r/d),f=(n-i*m)/2,u=(r-d*m)/2;l.save(),l.translate(f,u),l.scale(m,m),l.translate(-o.minX*t.tileScale,-o.minY*t.tileScale);const h={ctx:l,state:t,scale:m,crop:o};uc(h),mc(h),fc(h),pc(h,a),l.restore()},hc=()=>{const e=c.useRef(null),t=c.useRef(null),n=c.useRef(et.getState()),r=c.useRef(n.current?vn(n.current):null),[a,o]=c.useState({width:ac,height:sc}),[l,i]=c.useState(0),d=c.useRef(null),m=c.useRef(null),f=c.useRef(!1),u=c.useRef(null),h=c.useRef(!1),v=c.useCallback(()=>n.current,[]),x=c.useCallback(g=>g?(r.current||(r.current=vn(g)),r.current??Dn(g)):null,[]),b=c.useCallback(g=>{const w=g.viewport;if(!w)return;m.current!==g.areaId&&(d.current=null,m.current=g.areaId);const S=Sn(w,{width:g.mapWidth,height:g.mapHeight}),L=d.current;(!L||L.width!==S.width||L.height!==S.height)&&(d.current=S)},[]);c.useEffect(()=>{const g=w=>{const S=w.detail;n.current=S,r.current=vn(S),b(S),i(S.version)};return et.addEventListener(Cr,g),et.requestImmediateState(),()=>{et.removeEventListener(Cr,g)}},[b]),c.useEffect(()=>{const g=e.current;if(!g||typeof ResizeObserver>"u")return;const w=new ResizeObserver(()=>{const S=Math.max(ic,Math.floor(g.clientWidth/Vt)*Vt),L=Math.max(oc,Math.floor(g.clientHeight/Vt)*Vt);o(T=>T.width===S&&T.height===L?T:{width:S,height:L}),et.setCanvasBounds(S,L)});return w.observe(g),()=>w.disconnect()},[]),c.useEffect(()=>{const g=v(),w=d.current,S=x(g);!g||!w||!S||gc(t.current,g,a.width,a.height,w,S)},[a.width,a.height,l,v,x]);const C=c.useCallback(g=>{const w=v(),S=t.current,L=x(w);if(!w||!S||!L)return null;const T=S.getBoundingClientRect(),I=T.width,q=T.height;if(I===0||q===0)return null;const ee=L.width*w.tileScale,de=L.height*w.tileScale,be=Math.min(I/ee,q/de),G=(I-ee*be)/2,Q=(q-de*be)/2,le=(g.clientX-T.left-G)/be,ue=(g.clientY-T.top-Q)/be,ie=le+L.minX*w.tileScale,D=ue+L.minY*w.tileScale,ne=At(ie/w.tileScale,0,w.mapWidth),O=At(D/w.tileScale,0,w.mapHeight);return{gridX:ne,gridY:O}},[x,v]),_=c.useCallback((g,w)=>{if(!g)return;const S=v(),L=S==null?void 0:S.viewport;if(!S||!L)return;const T=d.current??Sn(L,{width:S.mapWidth,height:S.mapHeight}),I=T.width/2,q=T.height/2,ee=At(g.gridX,I,Math.max(I,S.mapWidth-I)),de=At(g.gridY,q,Math.max(q,S.mapHeight-q));d.current=T,et.emitInteraction({type:Ti,gridX:ee,gridY:de,animate:w})},[v]),y=g=>{if(g.pointerType!=="touch"&&g.button!==0)return;const w=C(g);if(w){if(f.current=!0,h.current=!1,u.current=g.pointerId,typeof g.currentTarget.setPointerCapture=="function")try{g.currentTarget.setPointerCapture(g.pointerId)}catch{}_(w,!0)}},N=g=>{if(!f.current||u.current!==g.pointerId)return;const w=C(g);w&&(h.current=!0,_(w,!1))},R=g=>{if(!f.current||u.current!==g.pointerId)return;const w=C(g);_(w,!h.current),f.current=!1,u.current=null},$=g=>{u.current===g.pointerId&&(f.current=!1,u.current=null)},A=()=>{f.current=!1,u.current=null},Y=g=>{g.preventDefault();const w=At(g.deltaY,-120,120);et.adjustZoom(w<0?.15:-.15)},te=g=>{if(!["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(g.key))return;g.preventDefault();const w=v();if(!w)return;const S=d.current??Sn(w.viewport,{width:w.mapWidth,height:w.mapHeight}),L=Math.max(1,Math.floor(S.width*.2));let T=w.viewport.x+w.viewport.width/2,I=w.viewport.y+w.viewport.height/2;switch(g.key){case"ArrowUp":I-=L;break;case"ArrowDown":I+=L;break;case"ArrowLeft":T-=L;break;case"ArrowRight":T+=L;break}_({gridX:T,gridY:I},!1)};return!(v()&&d.current)?null:s.jsx("section",{className:"mini-map-panel","aria-label":"MiniMap panel",children:s.jsx("div",{ref:e,className:"mini-map-canvas",role:"application","aria-label":"MiniMap viewport",tabIndex:0,onKeyDown:te,onWheel:Y,onPointerDown:y,onPointerMove:N,onPointerUp:R,onPointerCancel:$,onPointerLeave:A,children:s.jsx("canvas",{ref:t,style:{width:"100%",height:"100%",display:"block"}})})})},bc=Lt.memo(hc),yc=({children:e,className:t,variant:n="default"})=>{const r=n==="frameless"?"flex h-full min-h-0 flex-1 flex-col gap-[0.5rem] px-0 py-0 text-[#f8fafc] font-body":"flex h-full min-h-0 flex-1 flex-col gap-[0.5rem] rounded-[18px] border border-[rgba(59,130,246,0.22)] bg-[linear-gradient(145deg,rgba(8,15,30,0.92),rgba(12,22,42,0.82),rgba(6,12,28,0.92))] px-[0.9rem] py-[0.9rem] text-[#f8fafc] shadow-[0_20px_30px_-20px_rgba(8,12,24,0.5)] backdrop-blur-[14px] font-body",a=t?`${r} ${t}`:r;return s.jsx("div",{className:a,"data-testid":"tactical-panel",children:e})},xc=Lt.memo(yc),Kn=e=>e.missions,wc=e=>e.quests.quests,vc=X(Kn,e=>e.levels[e.currentLevelIndex]??null),Sc=e=>e?e.isCompleted?!0:e.objectives.length>0&&e.objectives.every(t=>t.isCompleted):!1,Ic=(e,t)=>{const n=e.questIds.map(l=>t.find(i=>i.id===l)),r=e.questIds.length,a=n.filter(Sc).length;return{...e,totalQuests:r,completedQuests:a,isComplete:r===0?!1:a===r}},Kr=(e,t)=>e.map(n=>Ic(n,t)),je=X([vc,wc],(e,t)=>{if(!e)return null;const n=Kr(e.objectives.filter(o=>o.kind==="primary"),t),r=Kr(e.objectives.filter(o=>o.kind==="side"),t),a=n.length>0&&n.every(o=>o.isComplete);return{level:e.level,levelId:e.levelId,name:e.name,zoneId:e.zoneId,primary:n,side:r,allPrimaryComplete:a}});X(je,e=>(e==null?void 0:e.primary)??[]);X(je,e=>(e==null?void 0:e.side)??[]);const kc=X(je,e=>(e==null?void 0:e.primary.find(t=>!t.isComplete))??null),Ec=X(je,e=>(e==null?void 0:e.side.find(t=>!t.isComplete))??null);X(je,e=>(e==null?void 0:e.allPrimaryComplete)??!1);const Xn=X(Kn,e=>e.pendingAdvance),Mc=X(Kn,e=>e.celebrationAcknowledged);X(je,e=>(e==null?void 0:e.level)??0);X(je,e=>(e==null?void 0:e.name)??"");const Xr={margin:0,padding:0,display:"flex",flexDirection:"column",listStyle:"none"},Cc=({collapsed:e=!1,onToggle:t})=>{const n=De(),r=E(y=>y.settings.locale),a=E(je),o=E(Xn),l=E(y=>y.world.currentMapArea),i=Pe(r),d=(l==null?void 0:l.displayName)??(l==null?void 0:l.name)??(a==null?void 0:a.name)??i.levelIndicator.unknownLevel,m=(l==null?void 0:l.level)??(a==null?void 0:a.level)??0,f=a==null?void 0:a.name,u=(a==null?void 0:a.primary)??[],h=(a==null?void 0:a.side)??[],v=(a==null?void 0:a.allPrimaryComplete)??!1,x=()=>{n(Pi())},b=()=>{t&&t()},C={width:e?"min(90vw, 240px)":"min(92vw, 320px)",background:"linear-gradient(145deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.82))",border:"1px solid rgba(148, 163, 184, 0.35)",borderRadius:"14px",padding:e?"0.7rem 0.85rem":"0.9rem 1.05rem",fontFamily:"'DM Mono', 'IBM Plex Mono', monospace",color:"#f8fafc",letterSpacing:"0.05em",display:"flex",flexDirection:"column",gap:e?"0.2rem":"0.4rem",boxShadow:"0 12px 32px rgba(15, 23, 42, 0.45)",pointerEvents:"auto",backdropFilter:"blur(4px)",transition:"width 0.2s ease, padding 0.2s ease"},_={display:"flex",flexDirection:"column",gap:f&&f!==d?"0.25rem":0,flex:1,minWidth:0,width:"100%",cursor:t?"pointer":"default",textTransform:"uppercase",textAlign:"left",transition:"color 0.2s ease",userSelect:"none",pointerEvents:"auto"};return s.jsxs("div",{style:C,children:[s.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"0.35rem",pointerEvents:"auto"},children:[s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"0.5rem"},children:[s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",minWidth:0},children:[s.jsx("span",{style:{fontSize:"0.7rem",color:"#94a3b8",opacity:.9},children:i.levelIndicator.levelLabel}),s.jsx("span",{style:{fontSize:"0.96rem",fontWeight:600,whiteSpace:"nowrap"},children:m})]}),s.jsx("div",{style:{display:"flex",alignItems:"center",gap:"0.4rem",minHeight:"1.25rem"},children:o&&s.jsx("button",{type:"button",onClick:x,style:{all:"unset",cursor:"pointer",fontSize:"0.66rem",color:"#5eead4",border:"1px solid rgba(94, 234, 212, 0.38)",borderRadius:"999px",padding:"0.18rem 0.55rem",textTransform:"uppercase",letterSpacing:"0.18em",transition:"all 0.2s ease",pointerEvents:"auto"},onMouseEnter:y=>{y.currentTarget.style.background="rgba(15, 118, 110, 0.22)",y.currentTarget.style.borderColor="rgba(94, 234, 212, 0.55)"},onMouseLeave:y=>{y.currentTarget.style.background="transparent",y.currentTarget.style.borderColor="rgba(94, 234, 212, 0.38)"},children:i.levelIndicator.missionReadyBadge})})]}),s.jsxs("div",{onClick:b,role:"button",tabIndex:0,onKeyDown:y=>{t&&(y.key==="Enter"||y.key===" ")&&(y.preventDefault(),b())},style:_,onMouseEnter:y=>{t&&(y.currentTarget.style.color="rgba(226, 232, 240, 0.92)")},onMouseLeave:y=>{y.currentTarget.style.color="inherit"},children:[s.jsxs("span",{style:{fontSize:"0.72rem",color:"rgba(148, 163, 184, 0.82)",letterSpacing:"0.12em",whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden"},children:[d," ",t&&s.jsx("span",{style:{fontSize:"0.65rem",opacity:.7},children:e?"▸":"▾"})]}),f&&f!==d&&s.jsx("span",{style:{fontSize:"0.62rem",color:"rgba(148, 163, 184, 0.6)",letterSpacing:"0.14em",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:f})]})]}),!e&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{style:{borderTop:"1px solid rgba(148, 163, 184, 0.22)",paddingTop:"0.45rem",display:"flex",flexDirection:"column",gap:"0.3rem"},children:[s.jsx("span",{style:{fontSize:"0.7rem",color:"#94a3b8",opacity:.85},children:i.levelIndicator.objectivesLabel}),u.length===0?s.jsx("span",{style:{fontSize:"0.72rem",color:"#cbd5f5",opacity:.85},children:i.levelIndicator.emptyObjectives}):s.jsx("ul",{style:{...Xr,gap:"0.32rem"},children:u.map((y,N)=>s.jsxs("li",{style:{display:"flex",alignItems:"center",gap:"0.45rem",fontSize:"0.74rem",lineHeight:1.2,color:y.isComplete?"rgba(148, 163, 184, 0.7)":"rgba(226, 232, 240, 0.92)",textDecoration:y.isComplete?"line-through":"none",textDecorationThickness:"1px",textDecorationColor:"rgba(94, 234, 212, 0.75)",transition:"color 0.18s ease"},children:[s.jsx("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:"0.85rem",height:"0.85rem",borderRadius:"999px",border:"1px solid rgba(94, 234, 212, 0.45)",background:y.isComplete?"linear-gradient(135deg, rgba(94, 234, 212, 0.45), rgba(56, 189, 248, 0.35))":"rgba(14, 165, 233, 0.14)",color:y.isComplete?"#0f172a":"#5eead4",fontSize:"0.64rem",fontWeight:600},"aria-hidden":!0,children:y.isComplete?"✓":N+1}),s.jsx("span",{style:{flex:1},children:y.label}),y.totalQuests>1&&s.jsxs("span",{style:{fontSize:"0.62rem",color:"rgba(148, 163, 184, 0.75)",fontFamily:"'DM Mono', 'IBM Plex Mono', monospace"},children:[y.completedQuests,"/",y.totalQuests]})]},y.id))})]}),s.jsxs("div",{style:{borderTop:"1px solid rgba(148, 163, 184, 0.16)",paddingTop:"0.4rem",display:"flex",flexDirection:"column",gap:"0.24rem"},children:[s.jsx("span",{style:{fontSize:"0.68rem",color:"rgba(148, 163, 184, 0.7)"},children:i.levelIndicator.sideObjectivesLabel}),h.length===0?s.jsx("span",{style:{fontSize:"0.68rem",color:"rgba(148, 163, 184, 0.55)"},children:i.levelIndicator.noSideObjectives}):s.jsx("ul",{style:{...Xr,gap:"0.22rem"},children:h.map(y=>s.jsxs("li",{style:{display:"flex",alignItems:"center",gap:"0.4rem",fontSize:"0.68rem",color:y.isComplete?"rgba(148, 163, 184, 0.6)":"rgba(226, 232, 240, 0.78)",textDecoration:y.isComplete?"line-through":"none",textDecorationThickness:"1px",textDecorationColor:"rgba(99, 102, 241, 0.6)"},children:[s.jsx("span",{style:{width:"0.5rem",height:"0.5rem",borderRadius:"999px",background:y.isComplete?"linear-gradient(135deg, rgba(129, 140, 248, 0.6), rgba(99, 102, 241, 0.45))":"rgba(99, 102, 241, 0.25)",display:"inline-flex",alignItems:"center",justifyContent:"center",color:"#0f172a",fontSize:"0.55rem"},"aria-hidden":!0,children:y.isComplete?"✓":""}),s.jsx("span",{style:{flex:1},children:y.label})]},y.id))})]}),v&&!o&&s.jsx("span",{style:{marginTop:"0.3rem",fontSize:"0.66rem",color:"rgba(94, 234, 212, 0.76)",fontFamily:"'DM Mono', 'IBM Plex Mono', monospace"},children:i.levelIndicator.primaryCompleteFootnote})]})]})},rn=e=>e.player.data,Tc=e=>!!e.settings.reputationSystemsEnabled,Pc={resistance:0,corpsec:0,scavengers:0};X(rn,e=>e.karma);const _c=X(rn,Tc,(e,t)=>t?e.factionReputation:Pc),Ac={corpsec_defector:{earnest:.6,stoic:.4},street_urchin:{sarcastic:.7,ruthless:.3},underground_hacker:{sarcastic:.6,earnest:.4},wasteland_scavenger:{ruthless:.6,stoic:.4}},Rc=e=>{let t="earnest",n=Number.NEGATIVE_INFINITY;return Object.keys(e).forEach(r=>{const a=e[r];a>n&&(t=r,n=a)}),t},Dc=e=>{const t={earnest:0,sarcastic:0,ruthless:0,stoic:0},n={...t,...e},r=Object.values(n).reduce((a,o)=>a+o,0);return r<=0?{...t,earnest:1}:Object.keys(n).reduce((a,o)=>(a[o]=Number.parseFloat((n[o]/r).toFixed(3)),a),t)},jc=X(rn,e=>{const t={...e.personality.flags};if(e.backgroundId){const r=Ac[e.backgroundId];r&&Object.keys(r).forEach(a=>{const o=t[a]??0;t[a]=o+r[a]})}const n=Dc(t);return{alignment:Rc(n),flags:n,lastUpdated:e.personality.lastUpdated,lastChangeSource:e.personality.lastChangeSource}});X(rn,e=>e.name);const Lc=e=>e.quests.quests,Nc=X(Lc,e=>e.filter(t=>t.isActive&&!t.isCompleted)),Oc=(e,t)=>/main/i.test(e.id)||/main/i.test(e.name)?-50+t:/datapad|operation|cold|iron/i.test(e.id)?-25+t:t,Qn=X(Nc,e=>{const t=[];return e.forEach((n,r)=>{n.objectives.filter(a=>!a.isCompleted).forEach((a,o)=>{t.push({questId:n.id,questName:n.name,questDescription:n.description,objective:a,priority:Oc(n,r)*10+o,isPrimary:r===0})})}),t.sort((n,r)=>n.priority-r.priority)});X(Qn,e=>e.length>0?e[0]:null);X(Qn,e=>e.length>1?e[1]:null);const jn={banter:{earnest:[{text:"Shelterline kids started a rumor that thunder is just the ocean applauding us. Let’s stay worth the encore.",guidelineRef:"plot.tone.guideline.7"},{text:"Amara logged a new morale playlist: ninety minutes of clattering cutlery recorded during a pre-war dinner rush. We could dance to that later.",guidelineRef:"plot.tone.guideline.6"}],sarcastic:[{text:"CorpSec just issued an alert about “unauthorized optimism in Sector 12.” Congratulations, you’re contraband joy.",guidelineRef:"plot.tone.guideline.4"},{text:"Fun fact: drone firmware now includes “coyote deterrent mode.” Somewhere an engineer thinks we’re wildlife. Let’s give them a nature documentary.",guidelineRef:"plot.tone.guideline.2"}],ruthless:[{text:"Found an ESD memo describing us as “surgical entropy.” I’ll embrace the brand if you do.",guidelineRef:"plot.tone.guideline.5"},{text:"CorpSec requisitioned riot foam flavored like citrus. Imagine choking on oranges while we dismantle their barricade.",guidelineRef:"plot.tone.guideline.2"}],stoic:[{text:"Filed under anomalies: pigeons roosting in the comms tower tapped out Morse for “stay loud.” No human hands detected.",guidelineRef:"plot.tone.guideline.2"},{text:"Supply ledger shows someone requisitioned 40 kilos of glitter for “psychological operations.” I logged it as “to be determined.”",guidelineRef:"plot.tone.guideline.3"}]},interjections:{questCompleted:{earnest:[{text:"Objective archived. You just stretched curfew a little thinner.",guidelineRef:"plot.tone.guideline.1"},{text:"Quest wrapped. Shelterline will taste this win in their next ration drop.",guidelineRef:"plot.tone.guideline.7"}],sarcastic:[{text:"You crushed that objective so hard the drones filed a workplace grievance.",guidelineRef:"plot.tone.guideline.4"},{text:"Quest complete. Somewhere an ESD analyst just spat in their nutrient slurry.",guidelineRef:"plot.tone.guideline.4"}],ruthless:[{text:"Target neutralized. Momentum stays with us.",guidelineRef:"plot.tone.guideline.5"},{text:"Objective cleared. Line them up for the next strike.",guidelineRef:"plot.tone.guideline.5"}],stoic:[{text:"Task completed. Logging success before it cools.",guidelineRef:"plot.tone.guideline.3"},{text:"Objective done. Updating projections now.",guidelineRef:"plot.tone.guideline.3"}]},reputationPositive:{earnest:[{text:"Your name circulates with smiles today. Resistance morale just spiked.",guidelineRef:"plot.tone.guideline.7"}],sarcastic:[{text:"Congrats, you’re trending on the underground net for something other than property damage.",guidelineRef:"plot.tone.guideline.4"}],ruthless:[{text:"Factions noticed your precision. They’ll expect more sharp edges.",guidelineRef:"plot.tone.guideline.5"}],stoic:[{text:"Reputation bump logged. Allies recalibrating expectations.",guidelineRef:"plot.tone.guideline.3"}]},reputationNegative:{earnest:[{text:"Heads up: whispers turned uneasy. We might need to mend fences soon.",guidelineRef:"plot.tone.guideline.1"}],sarcastic:[{text:"Your popularity dip just broke a few pirate radio polls. Impressive in its own way.",guidelineRef:"plot.tone.guideline.4"}],ruthless:[{text:"Standing dropped. Intimidation can be leverage, but watch the collateral.",guidelineRef:"plot.tone.guideline.5"}],stoic:[{text:"Faction trust decaying. Rebalancing recommendations forthcoming.",guidelineRef:"plot.tone.guideline.3"}]},hostileEntered:{earnest:[{text:"Sensors scream hostile territory. Stay quick, stay breathing.",guidelineRef:"plot.tone.guideline.1"}],sarcastic:[{text:"Welcome to enemy hospitality. Complimentary bullets on the mezzanine.",guidelineRef:"plot.tone.guideline.4"}],ruthless:[{text:"Hostile zone confirmed. Perfect conditions for decisive violence.",guidelineRef:"plot.tone.guideline.5"}],stoic:[{text:"Hostility detected. Updating threat overlay now.",guidelineRef:"plot.tone.guideline.3"}]}}},zc=e=>{const t=jn.banter[e]??jn.banter.earnest;return t[Math.floor(Math.random()*t.length)]},Fc=(e,t)=>{const n=jn.interjections[e];if(!n)return null;const r=n[t]??n.earnest;return!r||r.length===0?null:r[Math.floor(Math.random()*r.length)]},Bc=["gangHeat","curfewLevel","supplyScarcity","blackoutTier"],Hc={rumor:45e3,signage:45e3,weather:3e4,zoneDanger:15e3,hazardChange:12e3,zoneBrief:6e4},Ln=e=>({gangHeat:e.gangHeat,curfewLevel:e.curfewLevel,supplyScarcity:e.supplyScarcity,blackoutTier:e.blackoutTier}),Qr=e=>({flags:Ln(e.flags),impacts:{behavior:{...e.impacts.behavior},faction:{...e.impacts.faction},travel:{...e.impacts.travel}},rumor:e.rumor?{groupId:e.rumor.groupId,lines:[...e.rumor.lines],storyFunction:e.rumor.storyFunction,updatedAt:e.rumor.updatedAt}:null,signage:e.signage?{signId:e.signage.signId,text:e.signage.text,storyFunction:e.signage.storyFunction,updatedAt:e.signage.updatedAt}:null,weather:{presetId:e.weather.presetId,description:e.weather.description,storyFunction:e.weather.storyFunction,updatedAt:e.weather.updatedAt,rainIntensity:e.weather.rainIntensity,thunderActive:e.weather.thunderActive,timeOfDay:e.weather.timeOfDay},zone:{zoneId:e.zone.zoneId,zoneName:e.zone.zoneName,dangerRating:e.zone.dangerRating,hazards:[...e.zone.hazards],summary:e.zone.summary,directives:[...e.zone.directives]}}),Zr=e=>{const t=new Map;return e.forEach(n=>{const r=n.trim();if(!r)return;const a=r.toLowerCase();t.has(a)||t.set(a,r)}),t},Wc=(e,t)=>{if(e.length!==t.length)return!1;for(let n=0;n<e.length;n+=1)if(e[n]!==t[n])return!1;return!0};class $c{constructor(t){Ce(this,"previous",null);Ce(this,"lastEmitted",{});Ce(this,"cooldowns");this.cooldowns={...Hc,...(t==null?void 0:t.cooldowns)??{}}}prime(t){this.previous=Qr(t),this.lastEmitted={}}reset(){this.previous=null,this.lastEmitted={}}collect(t,n=Date.now()){const r=Qr(t);if(!this.previous)return this.previous=r,[];const a=this.diff(this.previous,r,n),o=[];for(const l of a){const i=this.lastEmitted[l.category],d=this.cooldowns[l.category]??0;typeof i=="number"&&d>0&&n-i<d||(o.push(l),this.lastEmitted[l.category]=n)}return this.previous=r,o}diff(t,n,r){const a=[];n.rumor&&n.rumor.lines.length>0&&(!t.rumor||t.rumor.updatedAt!==n.rumor.updatedAt)&&a.push({category:"rumor",timestamp:r,groupId:n.rumor.groupId,lines:[...n.rumor.lines],storyFunction:n.rumor.storyFunction}),n.signage&&(!t.signage||t.signage.updatedAt!==n.signage.updatedAt||t.signage.text!==n.signage.text)&&a.push({category:"signage",timestamp:r,signId:n.signage.signId,text:n.signage.text,storyFunction:n.signage.storyFunction}),(t.weather.presetId!==n.weather.presetId||t.weather.updatedAt!==n.weather.updatedAt||t.weather.rainIntensity!==n.weather.rainIntensity||t.weather.thunderActive!==n.weather.thunderActive||t.weather.timeOfDay!==n.weather.timeOfDay)&&a.push({category:"weather",timestamp:r,presetId:n.weather.presetId,previousPresetId:t.weather.presetId,description:n.weather.description,storyFunction:n.weather.storyFunction,rainIntensity:n.weather.rainIntensity,thunderActive:n.weather.thunderActive,timeOfDay:n.weather.timeOfDay});const l=Bc.reduce((x,b)=>(t.flags[b]!==n.flags[b]&&x.push({key:b,previous:t.flags[b],next:n.flags[b]}),x),[]),i=t.zone.dangerRating!==n.zone.dangerRating,d=n.zone.zoneName??t.zone.zoneName??null;(i||l.length>0)&&a.push({category:"zoneDanger",timestamp:r,dangerRating:n.zone.dangerRating??null,previousDangerRating:t.zone.dangerRating??null,flags:Ln(n.flags),previousFlags:Ln(t.flags),changedFlags:l,zoneName:d});const m=Zr(t.zone.hazards),f=Zr(n.zone.hazards),u=[];f.forEach((x,b)=>{m.has(b)||u.push(x)});const h=[];return m.forEach((x,b)=>{f.has(b)||h.push(x)}),(u.length>0||h.length>0)&&a.push({category:"hazardChange",timestamp:r,added:u,removed:h,zoneName:d}),(t.zone.zoneId!==n.zone.zoneId||t.zone.zoneName!==n.zone.zoneName||t.zone.summary!==n.zone.summary||!Wc(t.zone.directives,n.zone.directives))&&a.push({category:"zoneBrief",timestamp:r,zoneName:n.zone.zoneName??d,summary:n.zone.summary??null,dangerRating:n.zone.dangerRating??null,hazards:[...n.zone.hazards],directives:[...n.zone.directives]}),a}}const Nn="MISSION_ACCOMPLISHED",On="LEVEL_ADVANCE_REQUESTED",Uc=e=>{typeof window>"u"||window.dispatchEvent(new CustomEvent(Nn,{detail:e}))},Gc=e=>{typeof window>"u"||window.dispatchEvent(new CustomEvent(On,{detail:e}))},Vc=9e3,Jr=48e3,qc=96e3,ea=12,Yc=['Diagnostics show morale at "manageable"—keep it that way.',"Filed another complaint against the rain. Status: pending since 2034.","If you spot Theo, remind him the coffee synth still needs a filter.","Today’s lucky number is 404. Let’s try not to vanish."],Kc={operation:{badge:"OP",tone:"operation"},status:{badge:"ST",tone:"status"},interjection:{badge:"BC",tone:"broadcast"},player:{badge:"ME",tone:"player"},broadcast:{badge:"BC",tone:"broadcast"},battle:{badge:"BT",tone:"battle"},dialog:{badge:"DG",tone:"dialog"},stealth:{badge:"SF",tone:"stealth"}},Xc={badge:"--",tone:"broadcast"},ta=({size:e=32,className:t})=>{const n=c.useId(),r=`${n}-bg`,a=`${n}-glow`;return s.jsxs("svg",{className:t,width:e,height:e,viewBox:"0 0 64 64",role:"img","aria-hidden":"true",focusable:"false",children:[s.jsxs("defs",{children:[s.jsxs("linearGradient",{id:r,x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[s.jsx("stop",{offset:"0%",stopColor:"#1e293b",stopOpacity:1}),s.jsx("stop",{offset:"100%",stopColor:"#0f172a",stopOpacity:1})]}),s.jsxs("linearGradient",{id:a,x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[s.jsx("stop",{offset:"0%",stopColor:"#38bdf8",stopOpacity:1}),s.jsx("stop",{offset:"100%",stopColor:"#0ea5e9",stopOpacity:1})]})]}),s.jsx("circle",{cx:"32",cy:"32",r:"32",fill:`url(#${r})`}),s.jsx("path",{d:"M32 16 L46 24 L32 32 L18 24 Z",fill:"#475569",opacity:"0.6"}),s.jsx("circle",{cx:"32",cy:"32",r:"10",fill:"none",stroke:`url(#${a})`,strokeWidth:"2.5"}),s.jsx("circle",{cx:"32",cy:"32",r:"6",fill:"none",stroke:`url(#${a})`,strokeWidth:"1.5"}),s.jsx("line",{x1:"32",y1:"22",x2:"32",y2:"26",stroke:"#38bdf8",strokeWidth:"2",strokeLinecap:"round"}),s.jsx("line",{x1:"32",y1:"38",x2:"32",y2:"42",stroke:"#38bdf8",strokeWidth:"2",strokeLinecap:"round"}),s.jsx("line",{x1:"22",y1:"32",x2:"26",y2:"32",stroke:"#38bdf8",strokeWidth:"2",strokeLinecap:"round"}),s.jsx("line",{x1:"38",y1:"32",x2:"42",y2:"32",stroke:"#38bdf8",strokeWidth:"2",strokeLinecap:"round"}),s.jsx("circle",{cx:"32",cy:"32",r:"2",fill:"#38bdf8"}),s.jsx("path",{d:"M8 8 L12 8 L12 12",fill:"none",stroke:"#0ea5e9",strokeWidth:"1.5",opacity:.4}),s.jsx("path",{d:"M56 8 L52 8 L52 12",fill:"none",stroke:"#0ea5e9",strokeWidth:"1.5",opacity:.4}),s.jsx("path",{d:"M8 56 L12 56 L12 52",fill:"none",stroke:"#0ea5e9",strokeWidth:"1.5",opacity:.4}),s.jsx("path",{d:"M56 56 L52 56 L52 52",fill:"none",stroke:"#0ea5e9",strokeWidth:"1.5",opacity:.4})]})},Qc=(e,t,n)=>{if(e.length===0)return[t.questNone];const a=e.slice(0,n).map(o=>{const l=o.objective.count&&o.objective.count>1?` (${o.objective.currentCount??0}/${o.objective.count})`:"";return`${o.questName}: ${o.objective.description}${l}`});return e.length>n&&a.push(t.questMore),a},Zc=e=>{const t=e.replace(/\s+/g," ").trim();return t.length<=140?t:`${t.slice(0,137).trimEnd()}…`},Jc=(e,t)=>{const n=e.trim(),r=n.length?n:"---",a=r.toLowerCase(),o=l=>l.some(i=>a.includes(i));return o(["attack","enemy","combat","battle","damage","hostile"])?{category:"battle",label:t.battle,text:r,timestamp:Date.now()}:o(["dialog","dialogue","whispers","says","conversation","briefing","speech"])?{category:"dialog",label:t.dialog,text:r,timestamp:Date.now()}:o(["stealth","hidden","sneak","shadow","camouflage","conceal"])?{category:"stealth",label:t.stealth,text:r,timestamp:Date.now()}:{category:"broadcast",label:t.broadcast,text:r,timestamp:Date.now()}},ed=()=>{const e=E(M=>M.settings.locale),t=c.useMemo(()=>Pe(e),[e]),n=c.useMemo(()=>t.george,[t]),{feedLabels:r,levelAdvance:a,missionComplete:o,promptPlaceholder:l,askPlaceholder:i,askInputLabel:d,sendLabel:m}=n,f=E(Qn),u=E(je),h=E(kc),v=E(Ec),x=E(jc),b=E(_c),C=E(M=>!!M.settings.reputationSystemsEnabled),_=E(M=>M.quests.quests),y=E(M=>M.world),N=E(cl),R=E(M=>M.log.messages),$=c.useMemo(()=>{var M;return(M=n.ambient)!=null&&M.length?n.ambient:Yc},[n]),[A,Y]=c.useState([]),[te,fe]=c.useState(""),me=c.useRef(0),g=c.useRef(null),w=c.useRef(new Set),S=c.useRef(b),L=c.useRef({level:y.globalAlertLevel,inCombat:y.inCombat}),T=c.useRef(null),I=c.useRef(null),q=c.useRef(""),ee=c.useRef(R.length),de=c.useRef(null),be=c.useRef(!1),G=c.useRef([]),Q=c.useRef(null),le=c.useCallback(()=>{if(!G.current.length){Q.current=null;return}const M=G.current.shift();M&&Y(B=>{const ae=[...B,M];return ae.length>ea?ae.slice(ae.length-ea):ae}),Q.current=window.setTimeout(le,1e3)},[]),ue=c.useCallback(({category:M,label:B,text:ae,timestamp:re})=>{const ge=re??Date.now(),oe=Kc[M]??Xc,ye={id:`${ge}-${Math.random().toString(36).slice(2)}`,category:M,text:Zc(ae),label:B,timestamp:ge,badge:oe.badge,tone:oe.tone};G.current=[...G.current,ye],Q.current===null&&le()},[le]),ie=c.useCallback(M=>{ue(M)},[ue]),D=c.useCallback(M=>{me.current=Date.now()+Vc,g.current=null,ie({category:"interjection",label:n.feedLabels.interjection,text:M.text,timestamp:Date.now()})},[n.feedLabels.interjection,ie]),ne=c.useCallback(M=>{const B=Fc(M,x.alignment);if(!B)return;if(Date.now()>=me.current){D(B);return}g.current=B},[x.alignment,D]),O=c.useCallback(()=>$.length&&Math.random()<.5?{text:$[Math.floor(Math.random()*$.length)],guidelineRef:"ambient.line"}:zc(x.alignment),[$,x.alignment]),Fe=c.useCallback(M=>{fe(M.target.value)},[]),_e=c.useCallback(M=>{var ge,oe;M&&M.preventDefault();const B=te.trim();if(!B){(ge=de.current)==null||ge.focus();return}ue({category:"player",label:r.player,text:B,timestamp:Date.now()}),fe(""),(oe=de.current)==null||oe.focus();const ae=O(),re=l(ae.text);ue({category:"interjection",label:r.interjection,text:re,timestamp:Date.now()})},[ue,r.interjection,r.player,O,l,te]),Be=c.useCallback(()=>{T.current!==null&&window.clearTimeout(T.current);const M=Math.floor(Jr+Math.random()*(qc-Jr));T.current=window.setTimeout(()=>{const B=O();Date.now()>=me.current?D(B):g.current=B,Be()},M)},[O,D]);c.useEffect(()=>{const M=window.setInterval(()=>{const B=g.current;B&&Date.now()>=me.current&&D(B)},400);return()=>window.clearInterval(M)},[D]),c.useEffect(()=>(Be(),()=>{T.current!==null&&(window.clearTimeout(T.current),T.current=null),Q.current!==null&&(window.clearTimeout(Q.current),Q.current=null),G.current=[]}),[Be]),c.useEffect(()=>{if(R.length<=ee.current){ee.current=R.length;return}R.slice(ee.current).forEach(B=>{const ae=Jc(B,{battle:r.battle,dialog:r.dialog,stealth:r.stealth,broadcast:r.broadcast});ie(ae)}),ee.current=R.length},[r.battle,r.broadcast,r.dialog,r.stealth,R,ie]),c.useEffect(()=>{const M=(u==null?void 0:u.name)??n.zoneFallback,B=[];if(u){if(u.allPrimaryComplete)B.push(n.guidancePrimaryComplete(M));else if(h){const oe=h.totalQuests>1?n.guidanceProgress(h.completedQuests??0,h.totalQuests):"";B.push(n.guidancePrimaryObjective(h.label,oe))}v&&B.push(n.guidanceSideObjective(v.label))}const ae=Qc(f,n,3),re=[n.guidanceIntro];B.length>0&&re.push(...B),ae.length>0&&(B.length>0&&re.push(""),re.push(...ae));const ge=re.join(`
`).trim();!ge||q.current===ge||(q.current=ge,ie({category:"operation",label:r.operation,text:ge,timestamp:Date.now()}))},[r.operation,n,u,h,v,f,ie]);const at=c.useCallback(M=>{if(!M)return"";try{return new Intl.DateTimeFormat(e,{hour:"2-digit",minute:"2-digit"}).format(new Date(M))}catch{return new Date(M).toLocaleTimeString()}},[e]),st=c.useCallback(M=>{var ge;const B=n.ambientFeed,ae=x.alignment,re=oe=>({category:"broadcast",text:oe,label:r.broadcast,timestamp:M.timestamp});switch(M.category){case"rumor":{const oe=((ge=M.lines.find(ve=>ve&&ve.trim().length>0))==null?void 0:ge.trim())??B.fallbacks.rumor,ye=M.storyFunction?B.storyFunctionLabels[M.storyFunction]??M.storyFunction.replace(/-/g," ").toUpperCase():void 0;return re(B.formatRumor({line:oe,storyLabel:ye},ae))}case"signage":{const oe=M.text&&M.text.trim().length>0?M.text.trim():B.fallbacks.signage,ye=M.storyFunction?B.storyFunctionLabels[M.storyFunction]??M.storyFunction.replace(/-/g," ").toUpperCase():void 0;return re(B.formatSignage({text:oe,storyLabel:ye},ae))}case"weather":{const oe=M.description&&M.description.trim().length>0?M.description.trim():B.fallbacks.weather,ye=M.storyFunction?B.storyFunctionLabels[M.storyFunction]??M.storyFunction.replace(/-/g," ").toUpperCase():void 0;return re(B.formatWeather({description:oe,storyLabel:ye},ae))}case"zoneDanger":{const oe=t.levelIndicator.dangerLevels,ye=M.dangerRating?oe[M.dangerRating]??M.dangerRating:B.dangerFallback,ve=M.previousDangerRating?oe[M.previousDangerRating]??M.previousDangerRating:null,It=M.changedFlags.map(Ne=>({label:B.flagLabels[Ne.key]??Ne.key,previous:B.formatFlagValue(Ne.key,Ne.previous),next:B.formatFlagValue(Ne.key,Ne.next)}));return re(B.formatZoneDanger({zoneName:M.zoneName,dangerLabel:ye,previousDangerLabel:ve,flagChanges:It},ae))}case"hazardChange":{const oe=M.added.map(ve=>ve.trim()).filter(ve=>ve.length>0),ye=M.removed.map(ve=>ve.trim()).filter(ve=>ve.length>0);return re(B.formatHazards({zoneName:M.zoneName,additions:oe,removals:ye},ae))}case"zoneBrief":{const oe=t.levelIndicator.dangerLevels,ye=M.dangerRating?oe[M.dangerRating]??M.dangerRating:B.dangerFallback;return re(B.formatZoneBrief({zoneName:M.zoneName,summary:M.summary??null,dangerLabel:ye,hazards:M.hazards,directives:M.directives},ae))}default:return null}},[r.broadcast,n.ambientFeed,x.alignment,t.levelIndicator.dangerLevels]);c.useEffect(()=>{const M=ae=>{const re=ae.detail;if(!re)return;const ge=o(re.name);ie({category:"operation",label:r.operation,text:ge,timestamp:Date.now()}),ne("questCompleted")},B=ae=>{const re=ae.detail;if(!re)return;const ge=re.nextLevelId??`level ${re.nextLevel}`,oe=a(ge);ie({category:"operation",label:r.operation,text:oe,timestamp:Date.now()})};return window.addEventListener(Nn,M),window.addEventListener(On,B),()=>{window.removeEventListener(Nn,M),window.removeEventListener(On,B)}},[r.operation,a,o,ie,ne]),c.useEffect(()=>{const M=new Set(_.filter(re=>re.isCompleted).map(re=>re.id)),B=w.current;Array.from(M).filter(re=>!B.has(re)).length>0&&ne("questCompleted"),w.current=M},[_,ne]),c.useEffect(()=>{if(!N)return;if(!I.current){const ae=new $c;ae.prime(N),I.current=ae;const re={category:"zoneBrief",timestamp:Date.now(),zoneName:N.zone.zoneName,summary:N.zone.summary,dangerRating:N.zone.dangerRating??null,hazards:[...N.zone.hazards],directives:[...N.zone.directives]},ge=st(re);ge&&ie(ge);return}const B=I.current.collect(N);B.length&&B.forEach(ae=>{const re=st(ae);re&&ie(re)})},[N,st,ie]),c.useEffect(()=>{const M=S.current,B=b;if(!C){S.current=B;return}const ae=new Set([...Object.keys(B),...Object.keys(M)]),re=Array.from(ae).some(oe=>{const ye=B[oe]??0,ve=M[oe]??0;return ye-ve>=20}),ge=Array.from(ae).some(oe=>{const ye=B[oe]??0,ve=M[oe]??0;return ye-ve<=-20});re?ne("reputationPositive"):ge&&ne("reputationNegative"),S.current=B},[b,ne,C]),c.useEffect(()=>{const M=L.current;(!M.inCombat&&y.inCombat||M.level!=="alarmed"&&y.globalAlertLevel==="alarmed")&&ne("hostileEntered"),L.current={level:y.globalAlertLevel,inCombat:y.inCombat}},[ne,y.globalAlertLevel,y.inCombat]);const it=c.useRef(null),xt=c.useCallback(M=>{var B;M.preventDefault(),(B=de.current)==null||B.focus()},[]),Qe=c.useCallback(()=>{be.current=!0},[]),Ge=c.useCallback(()=>{be.current=!1},[]);c.useEffect(()=>{var B;const M=it.current;M&&(M.scrollTo({top:M.scrollHeight,behavior:"smooth"}),be.current&&((B=de.current)==null||B.focus()))},[A]);const wt={id:"george-placeholder",category:"status",text:n.logEmpty,label:r.broadcast,timestamp:0,badge:"NB",tone:"broadcast"},vt=A.length>0?A:[wt],ot=A.length>0,Le=vt.length-1,St=te.trim().length===0;return s.jsxs("div",{className:"george-inline","data-controller-focus-ignore":"true",children:[s.jsx("div",{className:"george-chat",role:"log","aria-live":"polite",ref:it,children:vt.map((M,B)=>{const ae=ot&&B===Le,re=M.timestamp?at(M.timestamp):"";return s.jsxs("div",{className:"george-chat-entry",children:[s.jsx("div",{className:"george-chat-avatar","aria-hidden":"true",children:s.jsx(ta,{size:32})}),s.jsxs("div",{className:`george-chat-bubble george-chat-bubble--${M.tone}${ae?" george-chat-bubble--latest":""}`,children:[s.jsxs("div",{className:"george-chat-bubble__header",children:[s.jsxs("div",{className:"george-chat-bubble__title",children:[s.jsx("span",{className:`george-chat-badge george-chat-badge--${M.tone}`,"aria-hidden":"true",children:M.badge}),s.jsx("span",{className:"george-chat-bubble__label",children:M.label})]}),re?s.jsx("span",{className:"george-chat-bubble__time",children:re}):null]}),s.jsx("p",{className:"george-chat-bubble__text",children:M.text})]})]},M.id)})}),s.jsxs("form",{className:"george-input-row",onSubmit:_e,children:[s.jsx(ta,{size:36}),s.jsx("div",{className:"george-input",children:s.jsx("input",{id:"george-prompt-input",className:"george-input__field",type:"text",placeholder:i,"aria-label":d,value:te,onChange:Fe,autoComplete:"off",ref:de,onFocus:Qe,onBlur:Ge})}),s.jsx("button",{type:"submit",className:"george-send-button","data-disabled":St,"aria-label":m,onMouseDown:xt,children:s.jsx("span",{className:"george-send-icon","aria-hidden":"true",children:"↗"})})]})]})},an=["warmth","melancholy","sarcasm","surrealism","urgency","steadiness","wit"],td={author:.4,persona:.4,scene:.2},$e={sentenceLengthMean:14,sentenceLengthStdDev:4,metaphorRate:.35,fragmentPreference:.2,motifDensity:.25},na=an.reduce((e,t)=>(e[t]=.5,e),{});an.reduce((e,t)=>(e[t]={type:"number",minimum:0,maximum:1},e),{});const In=e=>e.rhetoric?{sentenceLengthMean:e.rhetoric.sentenceLengthMean??$e.sentenceLengthMean,sentenceLengthStdDev:e.rhetoric.sentenceLengthStdDev??$e.sentenceLengthStdDev,metaphorRate:e.rhetoric.metaphorRate??$e.metaphorRate,fragmentPreference:e.rhetoric.fragmentPreference??$e.fragmentPreference,motifDensity:e.rhetoric.motifDensity??$e.motifDensity}:{...$e},nd=e=>{let t=1779033703,n=3144134277,r=1013904242,a=2773480762;for(let o=0;o<e.length;o+=1){const l=e.charCodeAt(o);t=Math.imul(t^l,597399067),n=Math.imul(n^l,2869860233),r=Math.imul(r^l,951274213),a=Math.imul(a^l,2716044179)}return t=Math.imul(t^t>>>18,597399067),n=Math.imul(n^n>>>22,2869860233),r=Math.imul(r^r>>>17,951274213),a=Math.imul(a^a>>>19,2716044179),[t^n^r^a,n^t,r^t,a^t]},rd=e=>()=>{let t=e+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296},jt=e=>{const t=typeof e=="number"?e.toString(36):e,n=nd(t),r=rd(n[0]),a=()=>r(),o=i=>i<=0?0:Math.floor(a()*i);return{next:a,nextInt:o,pick:i=>{if(i.length===0)throw new Error("Cannot pick from an empty list.");return i[o(i.length)]}}},Rt=(e,t,n)=>Math.min(Math.max(e,t),n),ad=(e,t)=>{const n={...td,...e};if(!t){const a=n.author+n.persona;return a===0?{author:.5,persona:.5,scene:0}:{author:n.author/a,persona:n.persona/a,scene:0}}const r=n.author+n.persona+n.scene;return r===0?{author:.4,persona:.4,scene:.2}:{author:n.author/r,persona:n.persona/r,scene:n.scene/r}},kn=e=>e?an.reduce((t,n)=>{var a;const r=(a=e.traits)==null?void 0:a[n];return typeof r=="number"&&!Number.isNaN(r)?t[n]=Rt(r,0,1):t[n]=na[n],t},{}):{...na},sd=(e,t,n,r)=>an.reduce((a,o)=>{const l=t[o]??.5,i=n[o]??.5,d=r?r[o]??.5:.5,m=l*e.author+i*e.persona+d*e.scene;return a[o]=Rt(m,0,1),a},{}),id=(e,t,n,r)=>{const a=In(t),o=In(n),l=r?In(r):$e;return{sentenceLengthMean:a.sentenceLengthMean*e.author+o.sentenceLengthMean*e.persona+l.sentenceLengthMean*e.scene,sentenceLengthStdDev:a.sentenceLengthStdDev*e.author+o.sentenceLengthStdDev*e.persona+l.sentenceLengthStdDev*e.scene,metaphorRate:a.metaphorRate*e.author+o.metaphorRate*e.persona+l.metaphorRate*e.scene,fragmentPreference:a.fragmentPreference*e.author+o.fragmentPreference*e.persona+l.fragmentPreference*e.scene,motifDensity:a.motifDensity*e.author+o.motifDensity*e.persona+l.motifDensity*e.scene}},od=(e,t)=>{const n=[],r=$e.sentenceLengthMean+e.melancholy*4-e.urgency*5+e.surrealism*3+e.wit*1-e.sarcasm*1,a=Rt((t.sentenceLengthMean+r)/2,6,28);Math.abs(a-t.sentenceLengthMean)>.01&&(n.push({trait:"urgency",from:t.sentenceLengthMean,to:a}),t.sentenceLengthMean=a);const o=.15+e.sarcasm*.25+e.urgency*.3-e.steadiness*.2,l=Rt((t.fragmentPreference+o)/2,0,.85);Math.abs(l-t.fragmentPreference)>.01&&(n.push({trait:"sarcasm",from:t.fragmentPreference,to:l}),t.fragmentPreference=l);const i=$e.metaphorRate+e.surrealism*.4+e.melancholy*.2-e.urgency*.25,d=Rt((t.metaphorRate+i)/2,0,.9);return Math.abs(d-t.metaphorRate)>.01&&(n.push({trait:"surrealism",from:t.metaphorRate,to:d}),t.metaphorRate=d),n},ld=e=>Object.entries(e).reduce((t,[n,r])=>{const a=Math.max(0,r-1);return a>0&&(t[n]=a),t},{}),cd=(e,t,n)=>{switch(e.type){case"requiresTrait":return!e.trait||typeof e.threshold!="number"?!0:t[e.trait]>=e.threshold;case"forbidsTrait":return!e.trait||typeof e.threshold!="number"?!0:t[e.trait]<=e.threshold;case"maxSentenceLength":return!0;case"requiresMotif":return e.motifId?(n[e.motifId]??0)>0:!0;default:return!0}},dd=(e,t,n)=>e.requiredTraits&&Object.entries(e.requiredTraits).some(([a,o])=>t[a]<o)||e.forbiddenTraits&&Object.entries(e.forbiddenTraits).some(([a,o])=>t[a]>o)?!1:e.constraints?e.constraints.every(r=>cd(r,t,n)):!0,ud=(e,t,n,r)=>{var o,l;let a=1;if(e.traitWeightBoost)for(const[i,d]of Object.entries(e.traitWeightBoost))a+=(t[i]??.5)*d;return(o=n.templateBias)!=null&&o.includes(e.id)&&(a+=.75),(l=r.templateBias)!=null&&l.includes(e.id)&&(a+=.75),Math.max(a,.1)},fd=(e,t,n,r)=>{var m,f;if(e.requestedTemplateId){const u=t.templates.find(h=>h.id===e.requestedTemplateId);if(u)return u}const a=t.templates.filter(u=>dd(u,n,r));if(a.length===0){const u=((m=e.persona.fallbackTemplates)==null?void 0:m[0])??((f=e.author.fallbackTemplates)==null?void 0:f[0]),h=u?t.templates.find(v=>v.id===u):void 0;if(h)return h;if(t.templates.length===0)throw new Error("No dialogue tone templates defined.");return t.templates[0]}const o=jt(`${e.seed??"tone"}::template`),l=a.map(u=>({template:u,weight:ud(u,n,e.author,e.persona)})),i=l.reduce((u,h)=>u+h.weight,0);let d=o.next()*i;for(const u of l){if(d<=u.weight)return u.template;d-=u.weight}return l[l.length-1].template},md=(e,t)=>{const n=e.palettes.find(r=>r.id===t);if(!n)throw new Error(`Missing palette ${t} referenced by tone template.`);return n},pd=(e,t)=>{var n;return(n=e.lexiconOverrides)==null?void 0:n[t]},gd=(e,t,n,r)=>{var o;let a=e.weight;if(e.traitInfluence)for(const[l,i]of Object.entries(e.traitInfluence))a+=(t[l]??.5)*i;if(e.motifId){const l=r[e.motifId]??0;a-=l*.35,(o=n.motifBias)!=null&&o.includes(e.motifId)&&(a+=.5)}return Math.max(a,0)},hd=(e,t,n,r,a,o,l)=>{var x;const i=pd(r.persona,t);if(i&&i.length>0){const b=jt(`${l}::override::${t}`),C=i[b.nextInt(i.length)];return{paletteId:e,entryId:"override",text:C}}const d=md(a,e),m=jt(`${l}::palette::${e}`),f=d.entries.map(b=>({entry:b,weight:gd(b,n,r.persona,o)})),u=f.reduce((b,C)=>b+C.weight,0);if(u<=0){const b=d.defaultText??((x=d.entries[0])==null?void 0:x.text);if(!b)throw new Error(`Palette ${e} has no viable entries.`);return{paletteId:e,entryId:"fallback",text:b}}let h=m.next()*u;for(const{entry:b,weight:C}of f){if(h<=C)return{paletteId:e,entryId:b.id,text:b.text};h-=C}const v=f[f.length-1].entry;return{paletteId:e,entryId:v.id,text:v.text}},bd=(e,t)=>e.template.replace(/\{\{(.*?)\}\}/g,(n,r)=>{var l;const a=r.trim(),o=t[a];return o?o.text:((l=e.slots.find(i=>i.id===a))==null?void 0:l.fallback)??""}),yd=(e,t)=>{var C;const n=ad(e.weights,!!e.scene),r=kn(e.author),a=kn(e.persona),o=e.scene?kn(e.scene):void 0,l=sd(n,r,a,o),i=id(n,e.author,e.persona,e.scene),d=od(l,i),m=ld(e.motifState??{}),f=fd(e,t,l,m);!f.supportsFragments&&i.fragmentPreference>.55&&(d.push({trait:"steadiness",from:i.fragmentPreference,to:.45}),i.fragmentPreference=.45),f.maxSentenceLength&&i.sentenceLengthMean>f.maxSentenceLength&&(d.push({trait:"steadiness",from:i.sentenceLengthMean,to:f.maxSentenceLength}),i.sentenceLengthMean=f.maxSentenceLength);const u={...m},h=f.slots.reduce((_,y)=>{var A;const N=hd(y.paletteId,y.id,l,e,t,u,e.seed??"tone");_[y.id]=N;const R=(A=t.palettes.find(Y=>Y.id===y.paletteId))==null?void 0:A.entries.find(Y=>Y.id===N.entryId),$=R==null?void 0:R.motifId;return $&&(u[$]=(u[$]??0)+2),_},{}),v=bd(f,h),x=e.motifState??{},b={templateId:f.id,text:v,slots:h,motifsApplied:Object.keys(u).filter(_=>(u[_]??0)>(x[_]??0))};return{traits:l,rhetoric:i,weights:n,clampLog:d,render:b,motifState:u,seed:e.seed??"tone",metadata:{authorId:e.author.id,personaId:e.persona.id,sceneId:(C=e.scene)==null?void 0:C.id,templateId:f.id}}},zn={id:"author.vonnegut_brautigan_core",label:"Vonnegut-Brautigan Core Voice",influences:["plot.tone.guideline.1","plot.tone.guideline.2","plot.tone.guideline.7"],traits:{wit:.75,melancholy:.6,surrealism:.68,sarcasm:.55,warmth:.52,urgency:.48,steadiness:.5},rhetoric:{sentenceLengthMean:18,sentenceLengthStdDev:5,metaphorRate:.48,fragmentPreference:.22},templateBias:["template.deadpan.reassure","template.surreal.resilience"],fallbackTemplates:["template.deadpan.reassure"]},ra={id:"author.propaganda_glitch",label:"Glitched Broadcast Satire",influences:["plot.tone.guideline.4","plot.tone.guideline.2"],traits:{wit:.55,melancholy:.35,surrealism:.5,sarcasm:.7,warmth:.32,urgency:.6,steadiness:.44},rhetoric:{sentenceLengthMean:14,sentenceLengthStdDev:3,metaphorRate:.28,fragmentPreference:.32},templateBias:["template.urgent.push"],fallbackTemplates:["template.urgent.push"]},Fn={[zn.id]:zn,[ra.id]:ra},ys=zn.id,xs=e=>Fn[e]??Fn[ys],Bn={id:"persona.trace",label:"Trace (Player)",personaTags:["player","resistance"],traits:{wit:.65,warmth:.54,urgency:.62,steadiness:.4,sarcasm:.58,melancholy:.47,surrealism:.44},rhetoric:{sentenceLengthMean:14,sentenceLengthStdDev:4,fragmentPreference:.28},motifBias:["motif.streetlight","motif.rain_hum"],templateBias:["template.urgent.push","template.deadpan.reassure"],lexiconOverrides:{directive:["Keep moving like the cameras forgot you.","Drift along the blackout fringe—quiet shoes, loud mission."]}},aa={id:"persona.amara_velez",label:"Amara Velez",personaTags:["mentor","resistance"],traits:{wit:.52,warmth:.66,urgency:.48,steadiness:.68,sarcasm:.38,melancholy:.55,surrealism:.42},rhetoric:{sentenceLengthMean:17,sentenceLengthStdDev:3,fragmentPreference:.18},motifBias:["motif.compass","motif.streetlight"],templateBias:["template.deadpan.reassure","template.surreal.resilience"],lexiconOverrides:{comfort:["Breathe—we’ve lived through harsher tides.","You held the line; I’ll hold the fallout."]}},sa={id:"persona.theo_anders",label:"Theo Anders",personaTags:["hacker","ally"],traits:{wit:.7,warmth:.5,urgency:.57,steadiness:.38,sarcasm:.64,melancholy:.42,surrealism:.58},rhetoric:{sentenceLengthMean:13,sentenceLengthStdDev:5,fragmentPreference:.36},motifBias:["motif.glowsticks","motif.rain_hum"],templateBias:["template.urgent.push"],lexiconOverrides:{opener:["Signal’s noisy but alive.","Console’s humming like a nervous choir."]}},ia={id:"persona.sadiq_rahm",label:"Sadiq Rahm",personaTags:["strategist","ally"],traits:{wit:.48,warmth:.4,urgency:.52,steadiness:.6,sarcasm:.46,melancholy:.58,surrealism:.36},rhetoric:{sentenceLengthMean:16,sentenceLengthStdDev:3,fragmentPreference:.22},motifBias:["motif.compass"],templateBias:["template.deadpan.reassure"],lexiconOverrides:{promise:["We bank this win, re-draw the map, hit harder tomorrow.","Blueprints shift in our favour; we keep walking."]}},Hn={[Bn.id]:Bn,[aa.id]:aa,[sa.id]:sa,[ia.id]:ia},ws=Bn.id,vs=e=>Hn[e]??Hn[ws],oa={id:"scene.share_scarce_food",label:"Share Scarce Food",intent:"break bread after a risky supply run",traits:{warmth:.72,melancholy:.58,wit:.46,surrealism:.42,sarcasm:.3,urgency:.28,steadiness:.64},rhetoric:{sentenceLengthMean:17,metaphorRate:.38}},la={id:"scene.post_ambush_reassurance",label:"Post-Ambush Reassurance",intent:"steady the squad after scraping through an ambush",traits:{warmth:.62,melancholy:.55,wit:.4,surrealism:.37,sarcasm:.34,urgency:.46,steadiness:.68},rhetoric:{sentenceLengthMean:16,fragmentPreference:.2}},ca={id:"scene.pre_heist_briefing",label:"Pre-Heist Briefing",intent:"sharpen focus during mission prep",traits:{warmth:.38,melancholy:.32,wit:.5,surrealism:.28,sarcasm:.52,urgency:.72,steadiness:.58},rhetoric:{sentenceLengthMean:14,fragmentPreference:.26}},da={id:"scene.radio_counter_speech",label:"Counter-Broadcast Speech",intent:"mock the regime broadcast while rallying allies",traits:{warmth:.44,melancholy:.36,wit:.68,surrealism:.5,sarcasm:.74,urgency:.6,steadiness:.46},rhetoric:{sentenceLengthMean:15,sentenceLengthStdDev:4,fragmentPreference:.34}},Ss={[oa.id]:oa,[la.id]:la,[ca.id]:ca,[da.id]:da},xd=e=>Ss[e],wd=[{id:"template.deadpan.reassure",label:"Deadpan Reassurance",template:"{{opener}} {{comfort}} {{promise}}",supportsFragments:!1,maxSentenceLength:22,requiredTraits:{warmth:.4,steadiness:.45},traitWeightBoost:{warmth:.6,steadiness:.3,wit:.2},slots:[{id:"opener",paletteId:"palette.opener.deadpan"},{id:"comfort",paletteId:"palette.comfort.solidarity"},{id:"promise",paletteId:"palette.promise.grit"}]},{id:"template.urgent.push",label:"Urgent Push",template:"{{urgent_intro}} {{directive}}",supportsFragments:!0,maxSentenceLength:18,requiredTraits:{urgency:.55},forbiddenTraits:{warmth:.85},traitWeightBoost:{urgency:.8,wit:.2,sarcasm:.3},slots:[{id:"urgent_intro",paletteId:"palette.urgent.intro",allowFragments:!0},{id:"directive",paletteId:"palette.directive.push",allowFragments:!0}]},{id:"template.surreal.resilience",label:"Surreal Resilience",template:"{{opener}} {{surreal_image}} {{resolution}}",supportsFragments:!1,maxSentenceLength:24,requiredTraits:{surrealism:.45},traitWeightBoost:{surrealism:.9,melancholy:.4,wit:.25},slots:[{id:"opener",paletteId:"palette.opener.deadpan"},{id:"surreal_image",paletteId:"palette.surreal.image"},{id:"resolution",paletteId:"palette.resolution.resilience"}]}],vd=[{id:"palette.opener.deadpan",slotId:"opener",defaultText:"Streetlight holds.",entries:[{id:"opener.streetlight",text:"Streetlight holds.",weight:1,traitInfluence:{steadiness:.4,warmth:.2},motifId:"motif.streetlight"},{id:"opener.ashtray",text:"Ashtray smoke braids the curfew alarm.",weight:.8,traitInfluence:{melancholy:.3,surrealism:.4},motifId:"motif.rain_hum"},{id:"opener.static",text:"Static licks the PA like a bored coyote.",weight:.9,traitInfluence:{wit:.3,sarcasm:.35}}]},{id:"palette.comfort.solidarity",slotId:"comfort",defaultText:"We bend so we do not break.",entries:[{id:"comfort.breathe",text:"Breathe; the city hums but our pulse sets tempo.",weight:1,traitInfluence:{warmth:.35,steadiness:.35}},{id:"comfort.hum",text:"We hum louder than their drones tonight.",weight:.9,traitInfluence:{wit:.25,urgency:.2},motifId:"motif.rain_hum"},{id:"comfort.coffee",text:"Ration coffee still tastes like defiance.",weight:.8,traitInfluence:{wit:.3,warmth:.3}}]},{id:"palette.promise.grit",slotId:"promise",defaultText:"We bank this and push the next door.",entries:[{id:"promise.grid",text:"Map updates in our favour; we move before dawn.",weight:1,traitInfluence:{urgency:.35,steadiness:.4},motifId:"motif.compass"},{id:"promise.neon",text:"Neon farms glow for us tonight if we choose.",weight:.85,traitInfluence:{surrealism:.4,warmth:.25}},{id:"promise.ledger",text:"Ledger tilts our way; we cash it in soon.",weight:.9,traitInfluence:{wit:.2,melancholy:.2}}]},{id:"palette.urgent.intro",slotId:"urgent_intro",defaultText:"Sirens kick a four count.",entries:[{id:"urgent.metro",text:"Metro lights stutter; sweepers reroute.",weight:1,traitInfluence:{urgency:.45,surrealism:.25},motifId:"motif.glowsticks"},{id:"urgent.chopper",text:"Chopper rotors chew the humidity early.",weight:.9,traitInfluence:{urgency:.4,sarcasm:.3}},{id:"urgent.clocks",text:"Every stolen clock ticks loud right now.",weight:.85,traitInfluence:{melancholy:.25,wit:.3}}]},{id:"palette.directive.push",slotId:"directive",defaultText:"Push past the surveillance bloom.",entries:[{id:"directive.sprint",text:"Sprint the blackout seam before it seals.",weight:1,traitInfluence:{urgency:.5,wit:.2}},{id:"directive.slide",text:"Slide between floodlights like you rehearsed it.",weight:.9,traitInfluence:{steadiness:.2,wit:.35},motifId:"motif.glowsticks"},{id:"directive.smile",text:"Smile like the scanners owe you rent.",weight:.75,traitInfluence:{sarcasm:.45}}]},{id:"palette.surreal.image",slotId:"surreal_image",defaultText:"Drones drift like bored gulls.",entries:[{id:"surreal.malls",text:"Flooded malls grow neon algae halos.",weight:1,traitInfluence:{surrealism:.55,melancholy:.25},motifId:"motif.rain_hum"},{id:"surreal.balloons",text:"Propaganda balloons sag like tired saints.",weight:.9,traitInfluence:{sarcasm:.3,wit:.25}},{id:"surreal.kites",text:"Kids fly hacked drones like paper kites.",weight:.85,traitInfluence:{warmth:.3,wit:.3}}]},{id:"palette.resolution.resilience",slotId:"resolution",defaultText:"We walk out together and louder.",entries:[{id:"resolution.compass",text:"Compass north re-centers on us tonight.",weight:1,traitInfluence:{steadiness:.45,warmth:.3},motifId:"motif.compass"},{id:"resolution.lunch",text:"Save me a ration bar; we earned dessert.",weight:.8,traitInfluence:{wit:.35,warmth:.25}},{id:"resolution.rain",text:"Let the rain mask our getaway beats.",weight:.85,traitInfluence:{melancholy:.3,surrealism:.3},motifId:"motif.rain_hum"}]}],Sd=()=>({authors:Fn,personas:Hn,scenes:Ss,templates:wd,palettes:vd,motifDefaults:{"motif.streetlight":0,"motif.rain_hum":0,"motif.compass":0,"motif.glowsticks":0}}),Id=()=>xs(ys),kd=()=>vs(ws),Ed=e=>xd(e),Md=(e,t)=>e?t?{...e,...t}:e:t,Cd=(e,t,n,r,a)=>`${e}::persona:${t}::author:${n}::scene:${r??"none"}::template:${a??"any"}`,Td=(e,t)=>e?{...e}:t.motifDefaults?{...t.motifDefaults}:{},Pd=(e,t,n,r)=>{const a=(n==null?void 0:n.seedKey)??r??"default";return`${e.id}:${t.id}:${a}`},_d=(e,t)=>{var n;if(t!=null&&t.personaId)return t.personaId;if((n=e.toneDefaults)!=null&&n.personaId)return e.toneDefaults.personaId};class Ad{constructor(){Ce(this,"library");Ce(this,"motifStates");Ce(this,"cache");Ce(this,"defaultAuthor",Id());Ce(this,"defaultPersona",kd());Ce(this,"resolvePersona",t=>t?vs(t):this.defaultPersona);Ce(this,"resolveShouldGenerate",t=>(t==null?void 0:t.useGenerated)!==!1);Ce(this,"reset",()=>{this.cache.clear(),this.motifStates.clear()});Ce(this,"resetDialogue",t=>{for(const n of this.cache.keys())n.startsWith(`${t}:`)&&this.cache.delete(n)});Ce(this,"resolveLine",t=>{const{dialogue:n,node:r,fallbackText:a,seedOverride:o}=t,l=Md(n.toneDefaults,r.tone);if(!l||!this.resolveShouldGenerate(l))return{text:a,source:"fallback"};const i=l.authorId?xs(l.authorId):this.defaultAuthor,d=this.resolvePersona(_d(n,l)),m=l.sceneId?Ed(l.sceneId):void 0,f=Pd(n,r,l,o),u=Cd(f,d.id,i.id,m==null?void 0:m.id,l.templateId),h=this.cache.get(u);if(h)return{text:h.render.text,source:"generated",metadata:h};const v=Td(this.motifStates.get(d.id),this.library),x=yd({author:i,persona:d,scene:m,requestedTemplateId:l.templateId,seed:f,motifState:v},this.library);return this.cache.set(u,x),this.motifStates.set(d.id,x.motifState),{text:x.render.text,source:"generated",metadata:x}});this.library=Sd(),this.motifStates=new Map,this.cache=new Map}}const Rd=new Ad,Dd=(e,t)=>{try{const n=Ai(e);return t==="charisma"?n.dialogueThresholdBonus:0}catch(n){console.warn("[DialogueSystem] Falling back to base stats for dialogue bonus.",n);const r=Ri(e.skills);return t==="charisma"?r.dialogueThresholdBonus:0}},jd=(e,t)=>{if(!t.skillCheck)return!0;const{skill:n,threshold:r,domain:a}=t.skillCheck;if((a??"attribute")==="skill"){const m=n;return(e.skillTraining[m]??0)>=r}const l=n,i=e.skills[l],d=Dd(e,l);return _i(i,r,d)},En={blackout:["blackout","brownout"],smog:["smog","toxic","fumes"],surveillance:["surveillance","camera","drone"]},ua=["ration bricks","filtered water packs","reactive dampeners","silenced carbines","patch kits"],fa=["battery bricks","jury-rigged lanterns","hand-crank dynamos"],ma=["homemade filters","charcoal respirators","sealed goggles"],pa=["signal scrubbers","anti-drone flares","masking foil"],ga=["Keep your head down; CorpSec doubled patrol rotations.","George whispered about a convoy slipping through the south gate tonight.","If you see a checkpoint scanner, go around—no one’s calibrating them right now.","Word is the resistance safehouse stashed contraband in the hollow neon signs."],Ld=[{id:"merchant.default_greeting.resistanceFriend",roleId:"merchant",templateKey:"default_greeting",summary:"Warm greeting for resistance-aligned players during regular hours.",content:"Signal's clean for you. {{highlightItem}} just landed—priced for family. {{rumorHook}}",fallbackContent:"Welcome back. Supplies are stocked.",gating:{faction:[{factionId:"resistance",minimumReputation:25}],forbiddenTimesOfDay:["night"]},tokens:[{id:"highlightItem",fallback:"Ration bricks",resolve:(e,t)=>{const n=e.world.hazards.join(" ").toLowerCase();return En.blackout.some(r=>n.includes(r))?t.pickOne(fa,fa[0]):En.smog.some(r=>n.includes(r))?t.pickOne(ma,ma[0]):En.surveillance.some(r=>n.includes(r))?t.pickOne(pa,pa[0]):t.pickOne(ua,ua[0])}},{id:"rumorHook",fallback:"Stay nimble out there.",resolve:(e,t)=>t.pickOne(ga,ga[0])}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.amara_velez",useGenerated:!0},weight:3},{id:"merchant.default_greeting.curfewUrgent",roleId:"merchant",templateKey:"default_greeting",summary:"Curt greeting while curfew is active.",content:"Curfew sirens already spun up. {{highlightItem}} on the counter—take it and bolt.",fallbackContent:"Curfew's live. Make it quick.",gating:{requireCurfewActive:!0},tokens:[{id:"highlightItem",fallback:"Emergency stim kit",resolve:(e,t)=>e.player.perks.includes("quickDraw")?"reflex chems—your speed deserves it":e.player.perks.includes("toughness")?"impact gel armor—fits right onto your plates":t.pickOne(["emergency stim kit","flashburst grenade","thermal cloak"],"emergency stim kit")}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"merchant.default_greeting.corpsecWatcher",roleId:"merchant",templateKey:"default_greeting",summary:"Wary exchange when player reputation is low with CorpSec.",content:"CorpSec sniffers are wired to sniffing you. Credits up front, {{highlightItem}} after.",fallbackContent:"No trust, no chatter—show credits.",gating:{faction:[{factionId:"corpsec",maximumReputation:-10}]},tokens:[{id:"highlightItem",fallback:"scrambler chip",resolve:(e,t)=>t.pickOne(["scrambler chip","masking foil strip","signal foam"],"scrambler chip")}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"merchant.default_greeting.genericFallback",roleId:"merchant",templateKey:"default_greeting",summary:"Default line when no other gating applies.",content:"Stock's thin but serviceable. {{highlightItem}} still on the shelves.",fallbackContent:"Limited stock today.",tokens:[{id:"highlightItem",fallback:"standard issue kits",resolve:(e,t)=>t.pickOne(["standard issue kits","bulk rations","basic medpacks"],"basic medpacks")}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},weight:1,isFallback:!0}],ha=["Keep your papers visible and your hands where the drones can see them.","If you spot a rebel courier, flag Ops immediately.","Curfew level's rising—movement passes expire at sundown.","Checkpoint scanners lag two beats; don't test them."],ba=["Orders say we hit siege level if one more rumor spikes.","CorpSec command wants names; don't make me drag you in.","We're one alert away from full lockdown."],Nd=[{id:"checkpoint_guard.default_greeting.standard",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Baseline checkpoint greeting with procedural warning.",content:"Checkpoint Delta online. {{instructionHook}}",fallbackContent:"Checkpoint active. Move along.",tokens:[{id:"instructionHook",fallback:"Stay within curfew limits.",resolve:(e,t)=>t.pickOne(ha,ha[0])}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"checkpoint_guard.default_greeting.highAlert",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Escalated warning when curfew level is high.",content:"Alert tier is {{alertTier}}. Any resistance contact gets you cuffed.",fallbackContent:"High alert. Don't test me.",gating:{environment:[{flag:"curfewLevel",minimumNumeric:2}]},tokens:[{id:"alertTier",fallback:"escalating",resolve:e=>e.world.environmentFlags.curfewLevel>=3?"siege":"escalating"}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},weight:3},{id:"checkpoint_guard.default_greeting.blackout",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Warning when blackout tier is active.",content:"Power grid's unstable; blackout tier {{blackoutTier}}. Expect spot checks.",fallbackContent:"Power grid's shaky. Expect spot checks.",gating:{environment:[{flag:"blackoutTier",allowed:["brownout","rolling"]}]},tokens:[{id:"blackoutTier",fallback:"brownout",resolve:e=>e.world.environmentFlags.blackoutTier}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"checkpoint_guard.default_greeting.crackdown",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Threatening line for hostile resistance reputation.",content:"Your face is flagged on half the scanners in this grid. {{warning}}",fallbackContent:"I've got eyes on you.",gating:{faction:[{factionId:"resistance",maximumReputation:-10}]},tokens:[{id:"warning",fallback:"Step out of line and I'm calling it in.",resolve:(e,t)=>t.pickOne(ba,ba[0])}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"checkpoint_guard.default_greeting.nightShift",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Night-time variant referencing curfew sweeps.",content:"Night shift sweep in progress. Curfew papers or back to shelter.",fallbackContent:"Curfew papers or move.",gating:{allowedTimesOfDay:["night"]},toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},isFallback:!0}],ya=["Keep wounds sealed; alley dust is lethal.","Rotating sutures hourly keeps CorpSec toxins from setting in.","Swap filters every hour—mutation spores love stagnant air.","Use the city's steam vents to sterilise gear if the clinic is compromised."],xa=["Don't stack stim packs unless you want your heart to stage a protest.","Hydrate with electrolytes after each stim; trust me, you need them.","If the stim crash hits, sleep it off. No negotiation."],Od=[{id:"street_doc.default_greeting.resistanceAlly",roleId:"street_doc",templateKey:"default_greeting",summary:"Compassionate line for resistance allies.",content:"Clinic's running hot, but I carved out a cot for you. {{advice}}",fallbackContent:"Clinic's open for resistance blood.",gating:{faction:[{factionId:"resistance",minimumStanding:"friendly"}],forbiddenTimesOfDay:["night"]},tokens:[{id:"advice",fallback:"Stay hydrated and bandage often.",resolve:(e,t)=>t.pickOne(ya,ya[0])}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.amara_velez",useGenerated:!0},weight:2},{id:"street_doc.default_greeting.stimWarning",roleId:"street_doc",templateKey:"default_greeting",summary:"Warns players who lean on adrenaline perks.",content:"Saw your vitals spike mid-field. {{stimulantNote}}",fallbackContent:"Your vitals scream stim abuse.",gating:{forbiddenTimesOfDay:["morning"]},tokens:[{id:"stimulantNote",fallback:"Dial down the stim packs or you'll pancake.",resolve:(e,t)=>e.player.perks.includes("adrenalineRush")?t.pickOne(xa,xa[0]):"Your heart rate needs calm, not more gunfire."}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.amara_velez",useGenerated:!0}},{id:"street_doc.default_greeting.hazardClinic",roleId:"street_doc",templateKey:"default_greeting",summary:"Environmental note when hazardous clouds are active.",content:"Smog's thick tonight. I packed spare filters and anti-rad chems.",fallbackContent:"Air's poison. Use the filters.",gating:{requiredHazardKeywords:["smog","toxic","radiation"]},toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"street_doc.default_greeting.overrun",roleId:"street_doc",templateKey:"default_greeting",summary:"Terse line when curfew is active.",content:"I'm triaging patrol victims on the floor. Sit, bleed, talk later.",fallbackContent:"Busy. Sit and wait.",gating:{requireCurfewActive:!0},toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"street_doc.default_greeting.defaultFallback",roleId:"street_doc",templateKey:"default_greeting",summary:"General-purpose greeting.",content:"Slide onto the stool. Tools are clean; I made sure.",fallbackContent:"Seat's open. Let's patch you.",toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},isFallback:!0}],wa=["CorpSec squads shifted to the mag-line every half hour.","Drone lattice thins out near the collapsed tram. Use it.","Rumor says resistance cracked the western floodgate. Check it tonight.","The scavengers set a new killbox under the viaduct. Don't stray."],va=["Step wrong and I tip off the enforcers.","You smell like CorpSec. Two words: back off.","My crew has eyes everywhere. Try nothing."],zd=[{id:"gang_scout.default_greeting.friendly",roleId:"gang_scout",templateKey:"default_greeting",summary:"Alliance tone when player reputation with scavengers is high.",content:"Scav nets flagged you green. {{intel}}",fallbackContent:"You're clear with the crew.",gating:{faction:[{factionId:"scavengers",minimumReputation:10}]},tokens:[{id:"intel",fallback:"Stick to the alleys; corp eyes are thick tonight.",resolve:(e,t)=>t.pickOne(wa,wa[0])}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"gang_scout.default_greeting.hostile",roleId:"gang_scout",templateKey:"default_greeting",summary:"Threatening line when player reputation is poor.",content:"Crew tagged you as trouble. {{warning}}",fallbackContent:"Crew doesn't trust you.",gating:{faction:[{factionId:"scavengers",maximumReputation:-5}]},tokens:[{id:"warning",fallback:"You move, we respond.",resolve:(e,t)=>t.pickOne(va,va[0])}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"gang_scout.default_greeting.blackoutRecon",roleId:"gang_scout",templateKey:"default_greeting",summary:"Intel drop during blackout scenarios.",content:"Blackout's blanketing the grid. Use it to ghost past scanners.",fallbackContent:"Blackout cover tonight. Move quiet.",gating:{environment:[{flag:"blackoutTier",allowed:["brownout","rolling"]}]},toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0}},{id:"gang_scout.default_greeting.nightWatch",roleId:"gang_scout",templateKey:"default_greeting",summary:"Night-only greeting referencing curfew sweeps.",content:"Night patrol spotted a CorpSec sweeper moving east. Stay in the shadows.",fallbackContent:"Night sweeps inbound. Stay sharp.",gating:{allowedTimesOfDay:["night"]},toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"gang_scout.default_greeting.fallback",roleId:"gang_scout",templateKey:"default_greeting",summary:"General-purpose line.",content:"Eyes are open. Feed me intel if you want safe passage.",fallbackContent:"Watch your angles out there.",toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},isFallback:!0}],Sa=["Bunks are sanitised—don't bleed on them.","We rotate guard shifts every twenty minutes; slot in if you can.","Leave broken gear on the workbench; the techs are patching it nightly."],Ia=["Food stores run dry in two days unless the next convoy lands.","Filters arrive at dawn—ration what you have left.","Ammo press needs parts; scavenge springs if you spot any."],Fd=[{id:"safehouse_handler.default_greeting.welcome",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Warm welcome when the player returns to a safehouse.",content:"Safehouse doors are sealed. {{restNote}}",fallbackContent:"Safehouse secured. Rest while you can.",tokens:[{id:"restNote",fallback:"Grab a bunk and breathe.",resolve:(e,t)=>t.pickOne(Sa,Sa[0])}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.amara_velez",useGenerated:!0},weight:2},{id:"safehouse_handler.default_greeting.lowSupplies",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Warns about low supplies when scarcity flag is high.",content:"Pantry's thin—{{supplyNote}}",fallbackContent:"Supplies low. Make your run count.",gating:{environment:[{flag:"supplyScarcity",allowed:["tight","rationed"]}]},tokens:[{id:"supplyNote",fallback:"stretch your rations.",resolve:(e,t)=>t.pickOne(Ia,Ia[0])}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0}},{id:"safehouse_handler.default_greeting.hazardShelter",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Highlights shelter when hazards are active outside.",content:"Outside's a killbox tonight. Trade routes stay closed until daybreak.",fallbackContent:"Outside is lethal right now. Stay in.",gating:{requiredHazardKeywords:["smog","radiation","patrol"]},toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0}},{id:"safehouse_handler.default_greeting.curfewShelter",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Curfew-specific shelter reminder.",content:"Curfew alarms are peaking. Lock-in lasts until morning.",fallbackContent:"Curfew locked. Sit tight.",gating:{requireCurfewActive:!0},toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0}},{id:"safehouse_handler.default_greeting.fallback",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Default handler line.",content:"We keep the lights dim and the exits mapped. Rest easy.",fallbackContent:"Safehouse steady.",toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},isFallback:!0}],Bd=[...Ld,...Nd,...Od,...zd,...Fd],Hd=Bd.reduce((e,t)=>(e[t.roleId]||(e[t.roleId]=[]),e[t.roleId].push(t),e),{}),ka=1,Wd=(e,t)=>{const n=t[e.flag];return!(e.allowed&&e.allowed.length>0&&!e.allowed.includes(n)||e.forbidden&&e.forbidden.includes(n)||typeof n=="number"&&(typeof e.minimumNumeric=="number"&&n<e.minimumNumeric||typeof e.maximumNumeric=="number"&&n>e.maximumNumeric))},$d=(e,t,n)=>{try{const r=e.resolve(t,n);return n.ensure(r,e.fallback)}catch(r){return console.warn("[RoleTemplateResolver] Token resolver failed",e.id,r),e.fallback}},Ud=(e,t,n)=>{if(!e.tokens||e.tokens.length===0)return{};const r=jt(`${n}::${e.id}::tokens`),a={rng:()=>r.next(),pickOne:(o,l)=>!o||o.length===0?l:o[r.nextInt(o.length)],ensure:(o,l)=>o&&o.trim().length>0?o:l};return e.tokens.reduce((o,l)=>(o[l.id]=$d(l,t,a),o),{})},Ea=(e,t)=>e?e.replace(/{{\s*([\w.]+)\s*}}/g,(n,r)=>{const a=t[r];return typeof a=="string"&&a.length>0?a:n}):"",Gd=(e,t,n)=>!(t&&t.some(r=>!e.includes(r))||n&&n.some(r=>e.includes(r))),Vd=(e,t)=>e.reputationSystemsEnabled===!1||!t||t.length===0?!0:t.every(n=>{var o;const r=((o=e.player.factionReputation)==null?void 0:o[n.factionId])??0;if(typeof n.minimumReputation=="number"&&r<n.minimumReputation||typeof n.maximumReputation=="number"&&r>n.maximumReputation)return!1;const a=$n(r);if(n.minimumStanding){const l=ht(a.id),i=ht(n.minimumStanding);if(l<i)return!1}if(n.maximumStanding){const l=ht(a.id),i=ht(n.maximumStanding);if(l>i)return!1}return!0}),qd=(e,t,n)=>!(t&&t.length>0&&!t.every(a=>e.some(o=>o.toLowerCase().includes(a.toLowerCase())))||n&&n.length>0&&n.some(a=>e.some(o=>o.toLowerCase().includes(a.toLowerCase())))),Yd=(e,t)=>{const n=e.gating;if(!n)return!0;const{world:r,player:a,npc:o}=t;if(!Vd(t,n.faction)||!Gd(a.perks??[],n.requiresPerkIds,n.forbiddenPerkIds)||n.allowedTimesOfDay&&n.allowedTimesOfDay.length>0&&!n.allowedTimesOfDay.includes(r.timeOfDay)||n.forbiddenTimesOfDay&&n.forbiddenTimesOfDay.includes(r.timeOfDay)||typeof n.requireCurfewActive=="boolean"&&n.requireCurfewActive!==r.curfewActive||typeof n.forbidCurfewActive=="boolean"&&n.forbidCurfewActive===r.curfewActive||!qd(r.hazards??[],n.requiredHazardKeywords,n.forbiddenHazardKeywords)||n.environment&&n.environment.length>0&&!n.environment.every(i=>Wd(i,r.environmentFlags)))return!1;if(n.requiredNpcTags&&n.requiredNpcTags.length>0){const l=(o==null?void 0:o.tags)??[];if(!n.requiredNpcTags.every(d=>l.includes(d)))return!1}if(n.forbiddenNpcTags&&n.forbiddenNpcTags.length>0){const l=(o==null?void 0:o.tags)??[];if(n.forbiddenNpcTags.some(i=>l.includes(i)))return!1}return!(n.requiredZoneIds&&n.requiredZoneIds.length>0&&!n.requiredZoneIds.includes(r.zoneId))},Kd=(e,t)=>{if(!e.length)return null;if(e.length===1)return e[0];const n=jt(`${t}::templatePick`),r=e.reduce((o,l)=>o+(l.weight??ka),0);let a=n.next()*r;for(const o of e)if(a-=o.weight??ka,a<=0)return o;return e[n.nextInt(e.length)]},Xd=(e,t)=>{const n=Hd[e];return n?n.filter(r=>r.templateKey===t):[]},Qd=e=>{const{roleId:t,templateKey:n,context:r}=e,a=Xd(t,n);if(a.length===0)return console.warn("[RoleTemplateResolver] Missing templates for role",t,"template",n),null;const o=a.filter(v=>Yd(v,r)),l=o.length>0?o:a.filter(v=>v.isFallback)||a,i=e.seedOverride??r.randomSeed??`${t}:${n}`,d=Kd(l,i)??l[0],m=`${i}::${d.seedHint??d.id}`,f=Ud(d,r,m),u=Ea(d.content,f),h=Ea(d.fallbackContent,f);return{templateId:d.id,roleId:t,text:u,fallbackText:h,tokens:f,seed:m,toneOverrides:d.toneOverrides,metadata:d.metadata}},Ma=e=>e.charAt(0).toUpperCase()+e.slice(1),Zd=/^\[roleTemplate:([a-zA-Z0-9_]+)\.([a-zA-Z0-9_]+)\]$/i,Ca={resistance:0,corpsec:0,scavengers:0},Mn=e=>e.objectives.some(t=>t.type!=="talk"&&!t.isCompleted),Jd=e=>{if(!e)return null;const t=e.trim(),n=Zd.exec(t);if(!n)return null;const[,r,a]=n;return{roleId:r,templateKey:a}},eu=()=>{const e=De(),t=E(g=>g.quests.quests),n=E(g=>g.settings.locale),r=E(g=>!!g.settings.reputationSystemsEnabled),a=Xe(n),o=Pe(n),{logs:l}=a,i=E(g=>g.player.data),d=E(g=>g.world),[m,f]=Lt.useState(null),u=(g,w="attribute")=>{if(w==="skill")try{return Oi(g).name}catch(S){return console.warn("[DialogueOverlay] Missing skill definition for",g,S),Ma(g)}return o.skills[g]??Ma(g)},h=c.useCallback(g=>{const w=t.find(L=>L.id===g);if(!w)return;let S=!1;if(w.rewards.forEach(L=>{switch(L.type){case"experience":L.amount>0&&(e(Rn({amount:L.amount,reason:`Quest complete: ${w.name}`})),e(F(l.rewardExperience(L.amount,w.name))),S=!0);break;case"currency":L.amount>0&&(e(Di(L.amount)),e(F(l.rewardCredits(L.amount,w.name))));break;case"item":if(L.id){const T=Math.max(1,L.amount||1);for(let I=0;I<T;I+=1){const q={id:We(),name:L.id,description:o.dialogueOverlay.itemRecoveredDescription(w.name),weight:1,value:0,isQuestItem:!1};e(Ba(q))}e(F(l.rewardItem(L.id,w.name)))}break}}),!S){const L=Math.max(40,(w.objectives.length||1)*30);e(Rn({amount:L,reason:`Quest complete: ${w.name}`})),e(F(l.rewardExperience(L,w.name)))}},[e,t,l,o]),v=c.useCallback(g=>{if(!g.questEffect)return;const{questId:w,effect:S,objectiveId:L}=g.questEffect;switch(S){case"start":{const T=t.find(I=>I.id===w);T&&!T.isActive&&!T.isCompleted&&(e(Ha(w)),e(F(l.questAccepted(T.name))))}break;case"complete":{const T=t.find(I=>I.id===w);if(T&&T.isActive&&!T.isCompleted){if(Mn(T))break;e(Li(w)),h(w),e(F(l.questCompleted(T.name)))}}break;case"update":if(L){e(ji({questId:w,objectiveId:L,isCompleted:!0}));const T=t.find(q=>q.id===w),I=T==null?void 0:T.objectives.find(q=>q.id===L);T&&I&&e(F(l.objectiveUpdated(I.description,T.name)))}break}},[e,h,t,l]),{activeDialogue:{dialogueId:x,currentNodeId:b},dialogues:C}=E(g=>g.quests),_=c.useMemo(()=>x?C.find(g=>g.id===x)??null:null,[x,C]),y=c.useMemo(()=>!_||_.nodes.length===0?null:_.nodes.find(w=>w.id===b)??_.nodes[0],[_,b]),N=c.useMemo(()=>{var I,q,ee;if(!_||!y)return null;const g=_.nodes.find(de=>de.id===y.id)??y;let w=g.text,S=g,L;const T=Jd(g.text);if(T&&i&&d){const de=T.roleId,{templateKey:be}=T,G={level:i.level,perks:i.perks??[],factionReputation:r?i.factionReputation??Ca:Ca},Q={locale:n,reputationSystemsEnabled:r,player:G,world:{timeOfDay:d.timeOfDay,curfewActive:d.curfewActive,zoneId:((I=d.currentMapArea)==null?void 0:I.zoneId)??"unknown_zone",zoneName:(q=d.currentMapArea)==null?void 0:q.name,hazards:((ee=d.currentMapArea)==null?void 0:ee.hazards)??[],environmentFlags:d.environment.flags},npc:void 0,randomSeed:`${_.id}:${g.id}`},le=Qd({roleId:de,templateKey:be,context:Q});le&&(w=le.text,L=le.seed,S={...g,text:le.text,tone:{...g.tone??{},...le.toneOverrides??{}}})}return{dialogue:_,node:S,fallbackText:w,seedOverride:L}},[_,y,n,i,d,r]),R=c.useMemo(()=>N?Rd.resolveLine({dialogue:N.dialogue,node:N.node,fallbackText:N.fallbackText,seedOverride:N.seedOverride}):null,[N]),$=c.useCallback(g=>{if(!g.questEffect)return null;const w=t.find(S=>{var L;return S.id===((L=g.questEffect)==null?void 0:L.questId)});if(!w)return null;switch(g.questEffect.effect){case"start":if(w.isCompleted)return"alreadyCompleted";if(w.isActive)return"alreadyActive";break;case"complete":if(w.isCompleted)return"alreadyCompleted";if(!w.isActive)return"notActive";if(Mn(w))return"objectivesIncomplete";break;case"update":if(g.questEffect.objectiveId){const S=w.objectives.find(L=>{var T;return L.id===((T=g.questEffect)==null?void 0:T.objectiveId)});if(S!=null&&S.isCompleted)return"objectiveCompleted"}break}return null},[t]),A=c.useCallback(g=>{if(!g.questEffect)return!0;const w=t.find(S=>{var L;return S.id===((L=g.questEffect)==null?void 0:L.questId)});if(!w)return!1;switch(g.questEffect.effect){case"start":return!w.isActive&&!w.isCompleted;case"complete":return w.isActive&&!w.isCompleted&&!Mn(w);case"update":return!w.isActive||w.isCompleted?!1:g.questEffect.objectiveId?!w.objectives.some(S=>{var L;return S.id===((L=g.questEffect)==null?void 0:L.objectiveId)&&S.isCompleted}):!0;default:return!0}},[t]),Y=c.useCallback(g=>$(g)?!0:g.skillCheck?!jd(i,g):!1,[$,i]),te=c.useMemo(()=>y?y.options.filter(A):[],[y,A]),fe=c.useCallback(g=>{Y(g)||(v(g),g.nextNodeId?e(Ni(g.nextNodeId)):e(Zt()))},[e,v,Y]);if(c.useEffect(()=>{if(!y)return;const g=S=>{var q;if(S.target instanceof HTMLElement&&(S.target.tagName==="INPUT"||S.target.tagName==="TEXTAREA"||S.target.getAttribute("contenteditable")==="true"))return;let L=null;if(/^[0-9]$/.test(S.key))L=Number(S.key);else if((q=S.code)!=null&&q.startsWith("Numpad")){const ee=Number(S.code.replace("Numpad",""));L=Number.isNaN(ee)?null:ee}if(L===null||L<1)return;const T=L-1,I=te[T];I&&(S.preventDefault(),S.stopPropagation(),typeof S.stopImmediatePropagation=="function"&&S.stopImmediatePropagation(),fe(I))},w={capture:!0};return window.addEventListener("keydown",g,w),()=>{window.removeEventListener("keydown",g,w)}},[y,fe,te]),!x||!_||!y)return null;const me=(R==null?void 0:R.text)??(y==null?void 0:y.text)??"...";return s.jsx("div",{style:{position:"absolute",inset:0,display:"flex",alignItems:"flex-end",justifyContent:"center",pointerEvents:"none"},children:s.jsxs("div",{style:{width:"min(620px, 90%)",marginBottom:"calc(var(--bottom-panel-height, 0px) + 2.5rem)",background:"linear-gradient(160deg, rgba(15, 23, 42, 0.94), rgba(15, 23, 42, 0.78))",border:"1px solid rgba(148, 163, 184, 0.35)",borderRadius:"18px",padding:"1.5rem 1.7rem",color:"#e2e8f0",fontFamily:"'DM Sans', 'Inter', sans-serif",boxShadow:"0 28px 48px rgba(15, 23, 42, 0.55)",pointerEvents:"auto",display:"flex",flexDirection:"column",gap:"1.2rem"},children:[s.jsxs("div",{children:[s.jsx("span",{style:{display:"block",fontSize:"0.72rem",letterSpacing:"0.28em",textTransform:"uppercase",color:"rgba(148, 163, 184, 0.85)",marginBottom:"0.35rem"},children:_.npcId}),s.jsx("h2",{style:{fontSize:"1.28rem",fontWeight:700,margin:0,color:"#f8fafc"},children:me})]}),s.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"0.75rem"},children:te.map((g,w)=>{const S=Y(g),L=g.skillCheck?`${u(g.skillCheck.skill,g.skillCheck.domain??"attribute")} ${g.skillCheck.threshold}`:null,T=$(g),I=T?o.dialogueOverlay.questLocks[T]:L?S?o.dialogueOverlay.requiresSkill(L):o.dialogueOverlay.checkSkill(L):null;return s.jsxs("button",{type:"button",onClick:()=>fe(g),onMouseEnter:()=>!S&&f(w),onMouseLeave:()=>f(null),style:{border:S?"1px solid rgba(148, 163, 184, 0.3)":m===w?"1px solid rgba(96, 165, 250, 0.7)":"1px solid rgba(96, 165, 250, 0.4)",borderRadius:"12px",padding:"0.85rem 1rem",background:S?"linear-gradient(135deg, rgba(15, 23, 42, 0.65), rgba(30, 41, 59, 0.75))":m===w?"linear-gradient(135deg, rgba(37, 99, 235, 0.35), rgba(56, 189, 248, 0.3))":"linear-gradient(135deg, rgba(37, 99, 235, 0.22), rgba(56, 189, 248, 0.18))",color:S?"rgba(148, 163, 184, 0.8)":"#e2e8f0",fontSize:"0.9rem",textAlign:"left",cursor:S?"not-allowed":"pointer",display:"flex",gap:"0.6rem",alignItems:"center",opacity:S?.75:1,pointerEvents:S?"none":"auto",boxShadow:S?"none":m===w?"0 0 20px rgba(56, 189, 248, 0.4), 0 4px 12px rgba(0, 0, 0, 0.3)":"0 0 8px rgba(56, 189, 248, 0.15)",transform:m===w&&!S?"translateY(-2px)":"translateY(0)",transition:"all 0.2s cubic-bezier(0.4, 0, 0.2, 1)"},children:[s.jsx("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:"1.25rem",height:"1.25rem",borderRadius:"50%",background:S?"rgba(148, 163, 184, 0.25)":"rgba(96, 165, 250, 0.35)",color:S?"#cbd5f5":"#bfdbfe",fontWeight:600,fontSize:"0.75rem"},children:w+1}),s.jsx("span",{style:{flex:1},children:g.text}),I&&s.jsx("span",{style:{fontSize:"0.68rem",textTransform:"uppercase",letterSpacing:"0.16em",color:S?"#f87171":"#5eead4"},children:I})]},`${g.text}-${w}`)})}),s.jsx("span",{style:{fontSize:"0.68rem",color:"rgba(148, 163, 184, 0.7)",textAlign:"right",letterSpacing:"0.22em",textTransform:"uppercase"},children:o.dialogueOverlay.escHint})]})})},tu=(...e)=>e.filter(Boolean).join(" "),nu=({showCompleted:e=!1})=>{const t=E(x=>x.quests.quests),n=E(x=>x.settings.locale),r=Pe(n),a=t.filter(x=>x.isActive&&!x.isCompleted),o=t.filter(x=>x.isCompleted).sort((x,b)=>x.name.localeCompare(b.name)),l=e?o:o.slice(0,1),i=a.length>0,d=e?l.length>0:!1,m=e?a.length+l.length>2:a.length>1,f=(x,b)=>x<=0?null:n==="en"?x>1?`${x} ${b}s`:`${x} ${b}`:`${x} ${b}`,u=x=>{const b=t.find(R=>R.id===x);if(!b)return null;const C=b.rewards.filter(R=>R.type==="currency").reduce((R,$)=>R+$.amount,0),_=b.rewards.filter(R=>R.type==="experience").reduce((R,$)=>R+$.amount,0),y=b.rewards.filter(R=>R.type==="item"),N=[C?r.questLog.currencyLabel(C):null,_?r.questLog.experienceLabel(_):null,...y.map(R=>f(Math.max(1,R.amount||1),R.id??r.questLog.supplyFallback))].filter(Boolean);return N.length===0?null:s.jsxs("div",{className:"text-[0.68rem] uppercase tracking-[0.18em] text-[#34d399]",children:[r.questLog.rewardsHeading,": ",N.join(" • ")]})},h=x=>s.jsxs("div",{className:"hud-ops-card hud-ops-card--active flex flex-col gap-3.5 p-[0.95rem]",children:[s.jsx("div",{className:"text-[0.92rem] font-semibold tracking-[0.08em] text-slate-50",children:x.name}),s.jsx("p",{className:"hud-ops-text-muted text-[0.78rem] leading-[1.55]",children:x.description}),s.jsx("div",{className:"flex flex-col gap-3",children:x.objectives.map(b=>s.jsxs("div",{className:"flex items-start gap-[0.55rem] text-[0.76rem] text-[#cbd5f5]",children:[s.jsx("span",{"aria-hidden":"true",className:"hud-ops-objective-check mt-[2px]","data-completed":b.isCompleted,children:"✓"}),s.jsx("span",{className:"flex-1 leading-tight",children:b.description}),b.count&&s.jsxs("span",{className:"text-[0.65rem] uppercase tracking-[0.16em] text-[#facc15]",children:[b.currentCount??0,"/",b.count]})]},b.id))}),u(x.id)]},x.id),v=x=>s.jsxs("div",{className:"hud-ops-card hud-ops-card--completed flex flex-col gap-3.5 p-[0.9rem]",children:[s.jsxs("div",{className:"flex items-center justify-between gap-[0.75rem]",children:[s.jsx("div",{className:"text-[0.85rem] font-semibold tracking-[0.05em] text-[#ede9fe]",children:x.name}),s.jsx("span",{"aria-hidden":"true",className:"hud-ops-complete-badge inline-flex h-[1.25rem] w-[1.25rem] items-center justify-center rounded-[0.35rem] text-[0.78rem] font-bold",children:"✓"})]}),s.jsx("p",{className:"hud-ops-text-muted text-[0.74rem] leading-[1.6]",children:x.description})]},x.id);return!i&&!d?s.jsx("div",{className:"hud-ops-empty flex flex-1 items-center justify-center text-xs italic",children:r.questLog.empty}):s.jsxs("div",{className:tu("flex flex-col gap-3.5 pr-1",m?"overflow-y-auto":"overflow-y-hidden"),children:[i&&a.map(x=>h(x)),e&&d&&l.map(x=>v(x))]})},Ta=Lt.memo(nu),nn={cyan:"#38bdf8",textPrimary:"#f8fafc",textSecondary:"rgba(226, 232, 240, 0.78)",textMuted:"rgba(148, 163, 184, 0.72)"},zf={background:"rgba(15, 23, 42, 0.6)",borderRadius:"12px",border:"1px solid rgba(148, 163, 184, 0.18)",padding:"0.8rem",boxShadow:"inset 0 1px 0 rgba(148, 163, 184, 0.18)"},Ff={display:"flex",flexDirection:"column",gap:"0.14rem"},Bf={fontSize:"0.52rem",letterSpacing:"0.19em",textTransform:"uppercase",color:"rgba(148, 163, 184, 0.72)"},Hf={fontSize:"0.72rem",fontWeight:600,letterSpacing:"0.05em",color:"#f8fafc",margin:0},Wf={fontFamily:'"DM Sans", "Inter", sans-serif',fontSize:"0.85rem",fontWeight:700,color:nn.textPrimary},$f={fontFamily:'"DM Sans", "Inter", sans-serif',fontSize:"0.62rem",color:nn.textMuted},Uf=(e,t)=>({background:`linear-gradient(135deg, ${e}, ${t})`,WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text"}),ru=(e,t=8)=>({textShadow:`0 0 ${t}px ${e}, 0 0 ${t*2}px ${e}40`}),Pa=24,au=e=>{if(!e)return null;const t=e.canvasDisplayWidth/(e.canvasWidth||1),n=e.canvasDisplayHeight/(e.canvasHeight||1);return{x:e.canvasLeft+e.screenX*t,y:e.canvasTop+e.screenY*n}},su=()=>{const[e,t]=c.useState(null),n=c.useRef(null),r=c.useCallback(a=>{n.current=a;const o=au(a);o&&t(o)},[]);return c.useEffect(()=>{if(typeof window<"u"){const a=window.__getawayPlayerScreenPosition;a&&r(a)}},[r]),c.useEffect(()=>{const a=o=>{r(o.detail)};return window.addEventListener(Jt,a),()=>window.removeEventListener(Jt,a)},[r]),c.useEffect(()=>{const a=()=>{n.current&&r(n.current)};return window.addEventListener("resize",a),()=>window.removeEventListener("resize",a)},[r]),e},iu=({notification:e,onComplete:t})=>{const[n,r]=c.useState(!1);c.useEffect(()=>{const i=setTimeout(()=>r(!0),10),d=setTimeout(()=>{r(!1),setTimeout(()=>t(e.id),200)},2200);return()=>{clearTimeout(i),clearTimeout(d)}},[e.id,t]);const a={display:"inline-flex",alignItems:"center",gap:"0.28rem",padding:"0.28rem 0.45rem",minWidth:"fit-content",background:"linear-gradient(150deg, rgba(7, 13, 26, 0.92) 0%, rgba(12, 148, 136, 0.58) 100%)",border:"1px solid rgba(56, 189, 248, 0.45)",borderRadius:"999px",boxShadow:"0 10px 18px -16px rgba(13, 148, 136, 0.55)",opacity:n?1:0,transform:n?"translateY(0)":"translateY(10px)",transition:"opacity 0.18s ease-out, transform 0.18s ease-out",pointerEvents:"none"},o={fontSize:"0.9rem",fontWeight:800,letterSpacing:"0.16em",textTransform:"uppercase",color:nn.textPrimary,...ru(nn.cyan,6)},l={fontSize:"0.55rem",fontWeight:700,letterSpacing:"0.24em",textTransform:"uppercase",color:"rgba(148, 233, 255, 0.92)"};return s.jsxs("div",{style:a,children:[s.jsxs("span",{style:o,children:["+",e.amount]}),s.jsx("span",{style:l,children:"XP"})]})},ou=({notifications:e,onDismiss:t})=>{const n=su(),r=c.useMemo(()=>({right:28,top:72}),[]);return s.jsx(s.Fragment,{children:e.map((a,o)=>{const l=n&&typeof window<"u"?(()=>{const i=(v,x,b)=>Math.min(Math.max(v,x),b),d=window.innerWidth||r.right*2,m=window.innerHeight||r.top*2,f=i(n.x,24,d-24),u=i(n.y,24,m-24),h=i(u-56-o*Pa,16,m-16);return{position:"fixed",left:f,top:h,transform:"translateX(-50%)",zIndex:9998,pointerEvents:"none"}})():{position:"fixed",right:`${r.right}px`,top:`${r.top+o*Pa}px`,zIndex:9998,pointerEvents:"none"};return s.jsx("div",{style:l,children:s.jsx(iu,{notification:a,onComplete:t})},a.id)})})},lu=()=>{const{currentMapArea:e,inCombat:t,engagementMode:n}=E(h=>h.world),r=E(h=>h.surveillance.hud),a=E(h=>!!h.settings.reputationSystemsEnabled),o=E(h=>h.world.currentMapArea.zoneId),l=E(h=>{var v;return a?(v=h.suspicion.zones[o])==null?void 0:v.heat:void 0}),[i,d]=c.useState(()=>new Date),m=n==="stealth",f=n==="dialog",u=c.useMemo(()=>{const h=(r==null?void 0:r.detectionProgress)??0,v=(l==null?void 0:l.totalHeat)??0,x=Math.max(0,Math.min(100,Math.round(v)));return Math.max(h,x)},[r==null?void 0:r.detectionProgress,l==null?void 0:l.totalHeat]);return c.useEffect(()=>{const h=window.setInterval(()=>d(new Date),1e3);return()=>window.clearInterval(h)},[]),s.jsxs("div",{className:"pointer-events-none absolute inset-0 select-none font-mono uppercase tracking-[0.18em] text-[#38bdf8]",children:[s.jsx("div",{className:"hud-corner","data-position":"top-left"}),s.jsx("div",{className:"hud-corner","data-position":"top-right"}),s.jsx("div",{className:"hud-corner","data-position":"bottom-right"}),s.jsx("div",{className:"hud-corner","data-position":"bottom-left"}),s.jsxs("div",{className:"hud-frame-top",children:[s.jsxs("div",{className:"hud-frame-chip","data-state":t?"alert":m?"stealth":"idle",children:[s.jsx("span",{className:"text-[0.45rem]",children:"●"}),s.jsx("span",{children:t?"COMBAT":m?"STEALTH":f?"DIALOG":"TACTICAL"})]}),s.jsxs("div",{className:"hud-frame-chip",children:[s.jsx("span",{children:"LOC"}),s.jsx("span",{className:"text-slate-100",children:(e==null?void 0:e.id)??"UNKNOWN"})]}),s.jsx("div",{className:"hud-frame-chip",children:s.jsx("span",{children:i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"})})})]}),s.jsx("div",{className:"hud-threat","data-alert":t?"true":"false",children:m?s.jsxs("span",{children:["DETECTION: ",u,"%"]}):f?s.jsx(s.Fragment,{children:"DIALOG MODE ACTIVE"}):s.jsxs(s.Fragment,{children:["THREAT LEVEL: ",t?"HOSTILE":"CLEAR"]})}),s.jsx("div",{className:"hud-frame-line","data-orientation":"top"}),s.jsx("div",{className:"hud-frame-line","data-orientation":"bottom"})]})},cu=({value:e,gridX:t,gridY:n,type:r,label:a,onComplete:o})=>{const[l,i]=c.useState(!0),[d,m]=c.useState(null),f=c.useRef(null),u=E(y=>y.player.data.position),h=c.useCallback(y=>{if(!y)return;f.current=y;const N=t-u.x,R=n-u.y,$=64,A=$,Y=$/2,te=(N-R)*(A/2),fe=(N+R)*(Y/2),me=y.worldX+te,g=y.worldY+fe,w=y.worldX-y.screenX/y.zoom,S=y.worldY-y.screenY/y.zoom,L=(me-w)*y.zoom,T=(g-S)*y.zoom,I=y.canvasDisplayWidth/y.canvasWidth,q=y.canvasDisplayHeight/y.canvasHeight,ee=y.canvasLeft+L*I,de=y.canvasTop+T*q;m({x:ee,y:de})},[t,n,u.x,u.y]);if(c.useEffect(()=>{if(typeof window<"u"){const y=window.__getawayPlayerScreenPosition;y&&h(y)}},[h]),c.useEffect(()=>{const y=N=>{h(N.detail)};return window.addEventListener(Jt,y),()=>window.removeEventListener(Jt,y)},[h]),c.useEffect(()=>{const y=setTimeout(()=>{i(!1),o==null||o()},1500);return()=>clearTimeout(y)},[o]),!l||!d)return null;const x=(()=>{switch(r){case"damage":return{color:"#ef4444",glow:"rgba(239, 68, 68, 0.8)",prefix:"-",scale:1};case"heal":return{color:"#34d399",glow:"rgba(52, 211, 153, 0.8)",prefix:"+",scale:1};case"crit":return{color:"#fbbf24",glow:"rgba(251, 191, 36, 0.9)",prefix:"-",scale:1.4};case"miss":return{color:"#94a3b8",glow:"rgba(148, 163, 184, 0.6)",prefix:"",scale:.9};case"block":return{color:"#38bdf8",glow:"rgba(56, 189, 248, 0.8)",prefix:"",scale:1};case"pickup":return{color:"#22d3ee",glow:"rgba(34, 211, 238, 0.85)",prefix:"+",scale:1.05};default:return{color:"#ffffff",glow:"rgba(255, 255, 255, 0.6)",prefix:"",scale:1}}})(),b=r==="miss"?"MISS":r==="block"?"BLOCK":r==="pickup"?`PICKED UP: ${e>1?`${e}x `:""}${a??(e===1?"ITEM":"ITEMS")}`:`${x.prefix}${e}`,C={position:"fixed",left:`${d.x}px`,top:`${d.y}px`,transform:"translate(-50%, -100%)",pointerEvents:"none",userSelect:"none",zIndex:1e4,animation:"floatUp 1.5s cubic-bezier(0.4, 0, 0.2, 1) forwards"},_={fontSize:`${1.2*x.scale}rem`,fontWeight:r==="crit"?900:800,color:x.color,textShadow:`0 0 12px ${x.glow}, 0 0 6px ${x.glow}, 0 2px 4px rgba(0, 0, 0, 0.8)`,fontFamily:'"DM Mono", "IBM Plex Mono", monospace',letterSpacing:"0.05em",WebkitTextStroke:r==="crit"?`1px ${x.color}dd`:"none"};return s.jsxs(s.Fragment,{children:[s.jsx("style",{children:`
        @keyframes floatUp {
          0% {
            transform: translateY(0) scale(${x.scale*.8});
            opacity: 0;
          }
          20% {
            opacity: 1;
          }
          100% {
            transform: translateY(-60px) scale(${x.scale});
            opacity: 0;
          }
        }
      `}),s.jsx("div",{style:C,children:s.jsx("span",{style:_,children:b})})]})},du=({active:e,type:t="damage",intensity:n=.6,duration:r=300})=>{const[a,o]=c.useState(!1);if(c.useEffect(()=>{if(e){o(!0);const m=setTimeout(()=>{o(!1)},r);return()=>clearTimeout(m)}},[e,r]),!a)return null;const d={...{position:"absolute",inset:0,pointerEvents:"none",zIndex:9999,animation:`hitFlash ${r}ms ease-out forwards`},...(()=>{switch(t){case"damage":return{background:`radial-gradient(circle at center, rgba(239, 68, 68, ${Math.max(0,n*.22)}) 0%, rgba(239, 68, 68, 0) 65%)`,mixBlendMode:"screen"};case"heal":return{background:`rgba(52, 211, 153, ${n})`,mixBlendMode:"lighten"};case"crit":return{background:`rgba(251, 191, 36, ${n*.8})`,mixBlendMode:"screen"};case"block":return{background:`rgba(56, 189, 248, ${n*.7})`,mixBlendMode:"screen"};default:return{background:`rgba(255, 255, 255, ${n})`,mixBlendMode:"screen"}}})()};return s.jsxs(s.Fragment,{children:[s.jsx("style",{children:`
        @keyframes hitFlash {
          0% {
            opacity: 1;
          }
          100% {
            opacity: 0;
          }
        }
      `}),s.jsx("div",{style:d})]})},uu=()=>{const e=De(),{floatingNumbers:t,activeFlashId:n,hitFlashes:r}=E(o=>o.combatFeedback),a=r.find(o=>o.id===n);return s.jsxs(s.Fragment,{children:[a&&s.jsx(du,{active:!0,type:a.type,intensity:a.intensity,duration:a.duration}),t.map(o=>s.jsx(cu,{value:o.value,gridX:o.gridX,gridY:o.gridY,type:o.type,label:o.label,onComplete:()=>e(zi(o.id))},o.id))]})},fu=e=>{switch(e){case J.ALARMED:return{label:"ALARMED",intent:"alarmed"};case J.SUSPICIOUS:return{label:"SUSPICIOUS",intent:"suspicious"};case J.DISABLED:return{label:"DISABLED",intent:"disabled"};case J.IDLE:default:return{label:"SPY ACTIVITY",intent:"idle"}}},mu=`
  .camera-wafer {
    --accent: rgba(60, 199, 255, 0.75);
    --accent-border: rgba(56, 189, 248, 0.42);
    --accent-shadow: rgba(56, 189, 248, 0.32);
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    min-width: 14.5rem;
    padding: 0.55rem 0.85rem;
    width: 14.5rem;
    border-radius: 12px;
    background: linear-gradient(135deg, rgba(14, 19, 31, 0.96), rgba(17, 24, 39, 0.84));
    border: 1px solid var(--accent-border);
    box-shadow: 0 16px 28px rgba(8, 12, 20, 0.52);
    color: #e2e8f0;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    font-family: 'DM Mono', 'IBM Plex Mono', monospace;
    pointer-events: none;
    overflow: hidden;
  }

  .camera-wafer::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(120deg, rgba(56, 189, 248, 0.12), transparent 42%);
    opacity: 0.45;
    mix-blend-mode: screen;
    pointer-events: none;
  }

  .camera-wafer[data-alert="suspicious"] {
    --accent: rgba(251, 191, 36, 0.82);
    --accent-border: rgba(251, 191, 36, 0.4);
    --accent-shadow: rgba(251, 191, 36, 0.28);
    --accent-spark: rgba(251, 191, 36, 0.6);
  }

  .camera-wafer[data-alert="alarmed"] {
    --accent: rgba(239, 68, 68, 0.78);
    --accent-border: rgba(239, 68, 68, 0.5);
    --accent-shadow: rgba(239, 68, 68, 0.32);
    --accent-spark: rgba(239, 68, 68, 0.64);
  }

  .camera-wafer[data-alert="disabled"] {
    --accent: rgba(148, 163, 184, 0.55);
    --accent-border: rgba(148, 163, 184, 0.35);
    --accent-shadow: rgba(148, 163, 184, 0.24);
    --accent-spark: rgba(148, 163, 184, 0.42);
  }

  .camera-wafer[data-overlay="true"] {
    box-shadow: 0 16px 30px rgba(11, 25, 45, 0.58), 0 0 18px var(--accent-shadow);
  }

  .camera-wafer__icon {
    position: relative;
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 0.7rem;
    background: linear-gradient(140deg, rgba(28, 37, 56, 0.92), rgba(16, 24, 38, 0.86));
    box-shadow: inset 0 0 14px rgba(8, 14, 24, 0.8), 0 0 18px var(--accent-shadow);
  }

  .camera-wafer__icon::before,
  .camera-wafer__icon::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    pointer-events: none;
  }

  .camera-wafer__icon::before {
    border: 1px solid rgba(226, 232, 240, 0.08);
  }

  .camera-wafer__icon::after {
    inset: 0.35rem;
    border-radius: 0.45rem;
    background: radial-gradient(circle at 48% 48%, var(--accent) 0%, rgba(12, 14, 22, 0.75) 72%);
    box-shadow: 0 0 22px var(--accent-shadow);
    opacity: 0.85;
  }

  .camera-wafer__pulse {
    position: absolute;
    inset: 0.3rem;
    border-radius: 0.5rem;
    border: 1px solid var(--accent);
    opacity: 0.35;
    animation: wafer-pulse 1800ms ease-in-out infinite;
  }

  .camera-wafer[data-alert="alarmed"] .camera-wafer__pulse {
    animation-duration: 950ms;
  }

  .camera-wafer[data-alert="suspicious"] .camera-wafer__pulse {
    animation-duration: 1400ms;
  }

  .camera-wafer__glyph {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    color: rgba(226, 232, 240, 0.58);
    letter-spacing: 0.3em;
  }

  @keyframes wafer-pulse {
    0% { transform: scale(0.94); opacity: 0.2; }
    40% { transform: scale(1); opacity: 0.45; }
    100% { transform: scale(1.08); opacity: 0; }
  }

  .camera-wafer__body {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    flex: 1 1 auto;
    min-width: 0;
  }

  .camera-wafer__headline {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    position: relative;
    padding-bottom: 0.15rem;
  }

  .camera-wafer__headline::after {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    bottom: 0;
    height: 2px;
    background: linear-gradient(90deg, rgba(239, 181, 64, 0.6), rgba(249, 189, 88, 0.3));
    opacity: 0;
    transform: scaleX(0.68);
    transform-origin: left;
    transition: opacity 140ms ease, transform 160ms ease;
  }

  .camera-wafer[data-network="true"] .camera-wafer__headline::after {
    opacity: 1;
    transform: scaleX(1);
  }

  .camera-wafer__label {
    font-size: 0.74rem;
    color: rgba(226, 232, 240, 0.82);
  }

  .camera-wafer__exposure {
    display: flex;
    align-items: center;
    gap: 0.55rem;
  }

  .camera-wafer__track {
    position: relative;
    flex: 1 1 auto;
    height: 6px;
    border-radius: 999px;
    background: rgba(12, 18, 30, 0.92);
    border: 1px solid rgba(59, 73, 99, 0.4);
    overflow: hidden;
  }

  .camera-wafer__fill {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 0;
    border-radius: inherit;
    background: var(--accent);
    box-shadow: 0 0 14px var(--accent-shadow);
    transition: width 160ms ease-out, background 180ms ease-out, box-shadow 180ms ease-out;
  }

  .camera-wafer__track::after {
    content: '';
    position: absolute;
    inset: 0;
    background: repeating-linear-gradient(
      90deg,
      rgba(148, 163, 184, 0.08) 0 8px,
      transparent 8px 16px
    );
    mix-blend-mode: screen;
    opacity: 0.35;
    pointer-events: none;
  }

  @media (max-width: 1080px) {
    .camera-wafer {
      min-width: 12rem;
      width: auto;
    }
  }
`,pu=()=>{const e=E(f=>f.surveillance.hud),n=E(f=>{var v;const u=(v=f.world.currentMapArea)==null?void 0:v.id;if(!u)return!1;const h=f.surveillance.zones[u];return h?Object.keys(h.cameras).length>0:!1})||e.detectionProgress>0||e.networkAlertActive||e.overlayEnabled,r=c.useMemo(()=>Math.min(100,Math.max(0,e.detectionProgress)),[e.detectionProgress]),a=c.useMemo(()=>Math.round(r),[r]),o=c.useMemo(()=>fu(e.alertState),[e.alertState]),l=o.intent==="idle"?"spy activity idle state":`${o.label.toLowerCase()} state`,i=e.overlayEnabled?"surveillance cones visible":"surveillance cones hidden",d=e.networkAlertActive?"network alert active. ":"",m=`${l}. ${d}Exposure ${a} percent. ${i}.`;return n?s.jsxs(s.Fragment,{children:[s.jsx("style",{children:mu}),s.jsxs("div",{className:"camera-wafer",role:"status","aria-live":"polite","aria-label":m,"data-alert":o.intent,"data-network":e.networkAlertActive||void 0,"data-overlay":e.overlayEnabled||void 0,"data-testid":"camera-detection-hud",children:[s.jsxs("div",{className:"camera-wafer__icon","aria-hidden":!0,children:[s.jsx("span",{className:"camera-wafer__pulse","aria-hidden":!0}),s.jsx("span",{className:"camera-wafer__glyph","aria-hidden":!0,children:"◉"})]}),s.jsxs("div",{className:"camera-wafer__body",children:[s.jsx("div",{className:"camera-wafer__headline","aria-hidden":!0,children:s.jsx("span",{className:"camera-wafer__label",children:o.label})}),s.jsx("div",{className:"camera-wafer__exposure","aria-hidden":!0,children:s.jsx("div",{className:"camera-wafer__track",children:s.jsx("div",{className:"camera-wafer__fill",style:{width:`${r}%`}})})})]})]})]}):null},gu=`
  .stealth-wafer {
    --accent: rgba(45, 212, 191, 0.78);
    --accent-border: rgba(45, 212, 191, 0.45);
    --accent-shadow: rgba(13, 148, 136, 0.38);
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.55rem 0.9rem;
    min-width: 14.5rem;
    width: 14.5rem;
    border-radius: 12px;
    background: linear-gradient(140deg, rgba(11, 20, 29, 0.92), rgba(7, 14, 22, 0.88));
    border: 1px solid var(--accent-border);
    box-shadow: 0 18px 32px rgba(8, 15, 27, 0.48);
    color: #e2e8f0;
    font-family: 'DM Mono', 'IBM Plex Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 0.14em;
  }

  .stealth-wafer__icon {
    width: 2.2rem;
    height: 2.2rem;
    border-radius: 0.7rem;
    background: linear-gradient(135deg, rgba(12, 23, 32, 0.88), rgba(8, 16, 26, 0.86));
    position: relative;
    box-shadow: inset 0 0 18px rgba(7, 16, 24, 0.85), 0 0 18px var(--accent-shadow);
  }

  .stealth-wafer__icon::before {
    content: '';
    position: absolute;
    inset: 0.35rem;
    border-radius: 0.5rem;
    background: radial-gradient(circle at 48% 52%, var(--accent) 0%, rgba(9, 19, 30, 0.8) 70%);
  }

  .stealth-wafer__icon::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    border: 1px solid rgba(148, 163, 184, 0.12);
  }

  .stealth-wafer__glyph {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    color: rgba(226, 232, 240, 0.75);
    letter-spacing: 0.24em;
  }

  .stealth-wafer__body {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    min-width: 0;
  }

  .stealth-wafer__headline {
    display: flex;
    align-items: center;
    gap: 0.45rem;
  }

  .stealth-wafer__label {
    font-size: 0.66rem;
    color: rgba(203, 213, 225, 0.86);
  }

  .stealth-wafer__state {
    font-size: 0.6rem;
    padding: 0.15rem 0.45rem;
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.3);
    background: rgba(15, 23, 42, 0.66);
    letter-spacing: 0.18em;
  }

  .stealth-wafer__meta {
    font-size: 0.54rem;
    letter-spacing: 0.12em;
    color: rgba(148, 163, 184, 0.78);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .stealth-wafer[data-state='exposed'] {
    --accent: rgba(251, 191, 36, 0.82);
    --accent-border: rgba(251, 191, 36, 0.38);
    --accent-shadow: rgba(217, 119, 6, 0.35);
  }

  .stealth-wafer[data-state='compromised'] {
    --accent: rgba(248, 113, 113, 0.78);
    --accent-border: rgba(248, 113, 113, 0.42);
    --accent-shadow: rgba(220, 38, 38, 0.36);
  }

  .stealth-wafer[data-state='standby'] {
    --accent: rgba(148, 163, 184, 0.7);
    --accent-border: rgba(148, 163, 184, 0.35);
    --accent-shadow: rgba(99, 102, 241, 0.24);
  }
`,hu=()=>{const e=E(A=>A.settings.locale),n=c.useMemo(()=>Pe(e),[e]).stealthIndicator,r=E(ds),a=r.enabled,o=r.eligible,l=r.cooldownExpiresAt,i=typeof l=="number",d=i?Math.max(0,l-Date.now()):0,m=E(Nl),f=E(A=>A.world.inCombat),u=E(Yn),h=E(A=>A.surveillance.hud),v=E(A=>!!A.settings.reputationSystemsEnabled),x=E(A=>A.world.currentMapArea.zoneId),b=E(A=>{var Y,te;return v?((te=(Y=A.suspicion.zones[x])==null?void 0:Y.heat)==null?void 0:te.totalHeat)??0:0}),C=(h==null?void 0:h.detectionProgress)??0,_=Math.max(Math.round(C),Math.round(b)),y=a&&m==="stealth";let N="standby",R=n.keyHint;f?(N="compromised",R=n.unavailableReasons.combat):u?(N=y?"exposed":"standby",R=n.unavailableReasons.dialogue):y?(_>=80?N="compromised":_>=30?N="exposed":N="hidden",R=`Detection ${Math.max(0,Math.min(100,_))}%`):i&&d>0?(N="compromised",R=n.cooldown(Math.max(1,Math.ceil(d/1e3)))):o?(N="standby",R=n.keyHint):(N="compromised",R=n.unavailableReasons.cooldown);const $=n.states[N];return s.jsxs("div",{className:"pointer-events-none select-none",children:[s.jsx("style",{children:gu}),s.jsxs("div",{className:"stealth-wafer","data-state":N,children:[s.jsx("div",{className:"stealth-wafer__icon",children:s.jsx("div",{className:"stealth-wafer__glyph",children:"S"})}),s.jsxs("div",{className:"stealth-wafer__body",children:[s.jsxs("div",{className:"stealth-wafer__headline",children:[s.jsx("span",{className:"stealth-wafer__label",children:n.label}),s.jsx("span",{className:"stealth-wafer__state",children:$})]}),s.jsx("div",{className:"stealth-wafer__meta",children:R})]})]})]})},bu={position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",pointerEvents:"none",zIndex:20},yu={padding:"1.8rem 3rem",borderRadius:"18px",background:"rgba(15, 23, 42, 0.85)",border:"1px solid rgba(248, 250, 252, 0.35)",boxShadow:"0 40px 60px rgba(15, 23, 42, 0.55)",display:"flex",flexDirection:"column",alignItems:"center",gap:"0.6rem",textAlign:"center",color:"#f8fafc",letterSpacing:"0.28em",textTransform:"uppercase"},xu={fontSize:"1.6rem",fontWeight:800},wu={fontSize:"0.85rem",fontWeight:600,opacity:.8},vu=()=>{const e=De(),t=E(n=>n.surveillance.curfewBanner.visible);return c.useEffect(()=>{if(!t)return;const n=window.setTimeout(()=>{e(Oa({visible:!1,timestamp:Date.now()}))},3e3);return()=>{window.clearTimeout(n)}},[t,e]),t?s.jsx("div",{style:bu,"aria-live":"assertive","aria-atomic":"true",children:s.jsxs("div",{style:yu,role:"alert",children:[s.jsx("span",{style:xu,children:"Curfew Active"}),s.jsx("span",{style:wu,children:"Surveillance Engaged"})]})}):null},Su=e=>!!e.settings.reputationSystemsEnabled,Iu=e=>e.hudLayout.override,ku=e=>{var n,r,a;if(!Su(e))return 0;const t=((n=e.world.currentMapArea)==null?void 0:n.zoneId)??null;return t?((a=(r=e.suspicion.zones[t])==null?void 0:r.heat)==null?void 0:a.totalHeat)??0:0},Eu=e=>{var t;return((t=e.surveillance.hud)==null?void 0:t.detectionProgress)??0},Mu=X([Iu,e=>e.world.inCombat,e=>e.world.engagementMode,ku,Eu],(e,t,n,r,a)=>e||(t?"combat":n==="stealth"||Math.max(Math.round(r),Math.round(a))>=45?"stealth":"exploration")),Cu=()=>{const e=De(),t=E(je),n=E(Xn),r=c.useRef(!1),a=c.useRef(!1);return c.useEffect(()=>{const o=(t==null?void 0:t.allPrimaryComplete)??!1;o&&!r.current&&!n&&e(Fi()),r.current=o},[t==null?void 0:t.allPrimaryComplete,n,e]),c.useEffect(()=>{if(!t){a.current=!1;return}n&&!a.current&&(Uc({level:t.level,levelId:t.levelId,name:t.name}),e(Kt({type:"missionCompletion",missionId:t.levelId})),a.current=!0),n||(a.current=!1)},[e,n,t]),null},Zn=e=>!!e.settings.reputationSystemsEnabled,Tu={resistance:0,corpsec:0,scavengers:0},Pu=[],_u=[],Is=e=>e.player.data.factionReputation,Au=e=>e.player.pendingFactionEvents;X(Is,Zn,(e,t)=>t?e:Tu);const Ru=X(Au,Zn,(e,t)=>!t||e.length===0?Pu:e),Gf=X(Is,Zn,(e,t)=>t?Bi().map(({id:r})=>{const a=Wi(r),o=Hi(r,e[r]??a.definition.defaultReputation);return{factionId:r,name:a.definition.name,description:a.definition.description,value:o.value,standingId:o.standing.id,standingLabel:o.standing.label,color:o.standing.color,icon:o.standing.icon,effects:o.effects,nextThreshold:o.nextThreshold}}):_u),Du={position:"fixed",top:"80px",right:"28px",display:"flex",flexDirection:"column",gap:"0.45rem",zIndex:9999,pointerEvents:"none"},ju=e=>({minWidth:"220px",maxWidth:"280px",borderRadius:"12px",border:`1px solid ${e}`,background:"rgba(15, 23, 42, 0.92)",boxShadow:"0 18px 32px rgba(2, 6, 23, 0.45)",padding:"0.55rem 0.7rem",display:"flex",flexDirection:"column",gap:"0.28rem",color:"rgba(226, 232, 240, 0.95)",pointerEvents:"auto"}),Lu={fontSize:"0.64rem",letterSpacing:"0.12em",textTransform:"uppercase"},_a={fontSize:"0.58rem",lineHeight:1.35,color:"rgba(203, 213, 225, 0.92)"},Aa=e=>e===0?"±0":`${e>0?"+":""}${e}`,Nu=4200,Ou=()=>{const e=De(),t=E(Ru),n=E(f=>f.settings.locale),r=E(f=>!!f.settings.reputationSystemsEnabled),a=c.useMemo(()=>Pe(n),[n]),o=a.playerStatus.factions,[l,i]=c.useState([]),d=c.useRef({}),m=c.useCallback(f=>{i(h=>h.filter(v=>v.id!==f));const u=d.current[f];u&&(window.clearTimeout(u),delete d.current[f])},[]);return c.useEffect(()=>{if(!r){Object.values(d.current).forEach(u=>window.clearTimeout(u)),d.current={},i(u=>u.length>0?[]:u);return}if(!t.length)return;const f=[];t.forEach(u=>{const h=o[u.factionId]??u.factionId,v=u.standingChanges.find(me=>me.factionId===u.factionId),x=u.standingChanges.find(me=>me.factionId!==u.factionId),b=Object.entries(u.rivalDeltas??{}),C=b.length>0?b[0]:void 0,_=u.reason?a.factionToast.reasons[u.reason]??u.reason:void 0,y=Aa(u.delta),N=v?Qt(n,v.nextStanding):void 0,R=N?a.factionToast.standingChange(N):void 0,$=x?Qt(n,x.nextStanding):void 0,A=C?a.factionToast.rivalChange(o[C[0]]??C[0],Aa(C[1]),$):void 0,Y=a.factionToast.reputationChange(h,y,_),te=`${u.factionId}-${u.timestamp}`,fe=u.delta>0?"rgba(56, 189, 248, 0.65)":u.delta<0?"rgba(248, 113, 113, 0.65)":"rgba(148, 163, 184, 0.65)";f.push({id:te,factionId:u.factionId,message:Y,standingNote:R,rivalNote:A,color:fe}),e(F(Y)),R&&R!==Y&&e(F(R)),A&&e(F(A))}),i(u=>[...u,...f].slice(-6)),f.forEach(u=>{const h=window.setTimeout(()=>m(u.id),Nu);d.current[u.id]=h}),e($i())},[e,t,o,n,m,a.factionToast,r]),c.useEffect(()=>()=>{Object.values(d.current).forEach(f=>window.clearTimeout(f)),d.current={}},[]),!r||l.length===0?null:s.jsx("div",{style:Du,"aria-live":"polite","aria-atomic":"false",children:l.map(f=>s.jsxs("div",{style:ju(f.color),role:"status","aria-live":"polite",children:[s.jsx("span",{style:Lu,children:f.message}),f.standingNote&&s.jsx("span",{style:_a,children:f.standingNote}),f.rivalNote&&s.jsx("span",{style:_a,children:f.rivalNote})]},f.id))})},zu={position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(15, 23, 42, 0.86)",backdropFilter:"blur(6px)",zIndex:20,padding:"1.5rem"},Fu={width:"min(520px, 92vw)",borderRadius:"18px",border:"1px solid rgba(94, 234, 212, 0.2)",background:"linear-gradient(135deg, rgba(6, 15, 28, 0.95), rgba(13, 31, 48, 0.92))",color:"#f8fafc",fontFamily:"'DM Mono', 'IBM Plex Mono', monospace",boxShadow:"0 40px 68px rgba(2, 6, 23, 0.55)",display:"flex",flexDirection:"column",gap:"1.2rem",padding:"2rem 2.2rem"},Bu={display:"flex",gap:"0.75rem"},Ra={all:"unset",cursor:"pointer",flex:1,padding:"0.7rem 1.2rem",borderRadius:"999px",letterSpacing:"0.15em",fontSize:"0.72rem",fontWeight:700,textTransform:"uppercase",textAlign:"center",minWidth:0},Hu=({open:e,levelName:t,missionStrings:n,primaryObjectives:r,sideObjectives:a,onContinue:o,onDefer:l})=>{if(!e)return null;const i=r.filter(m=>m.isComplete),d=a.filter(m=>!m.isComplete);return s.jsx("div",{role:"dialog","aria-modal":"true",style:zu,children:s.jsxs("div",{style:Fu,children:[s.jsxs("header",{style:{display:"flex",flexDirection:"column",gap:"0.4rem"},children:[s.jsx("span",{style:{fontSize:"0.7rem",letterSpacing:"0.28em",color:"rgba(94, 234, 212, 0.75)",textTransform:"uppercase"},children:n.accomplishedTitle}),s.jsx("h2",{style:{fontSize:"1.35rem",fontWeight:700,letterSpacing:"0.08em",margin:0},children:n.accomplishedSubtitle(t)})]}),s.jsxs("section",{style:{display:"flex",flexDirection:"column",gap:"0.9rem"},children:[s.jsxs("div",{style:{border:"1px solid rgba(148, 163, 184, 0.22)",borderRadius:"14px",padding:"0.9rem 1.1rem",background:"rgba(15, 23, 42, 0.68)",display:"flex",flexDirection:"column",gap:"0.6rem"},children:[s.jsx("span",{style:{fontSize:"0.7rem",color:"rgba(148, 163, 184, 0.78)"},children:n.primarySummaryLabel}),i.length===0?s.jsx("span",{style:{fontSize:"0.72rem",color:"rgba(226, 232, 240, 0.86)"},children:"—"}):s.jsx("ul",{style:{margin:0,padding:0,listStyle:"none",display:"flex",flexDirection:"column",gap:"0.45rem"},children:i.map(m=>s.jsxs("li",{style:{display:"flex",gap:"0.55rem",alignItems:"flex-start",fontSize:"0.74rem",color:"rgba(226, 232, 240, 0.9)",lineHeight:1.35},children:[s.jsx("span",{"aria-hidden":!0,style:{width:"0.9rem",height:"0.9rem",borderRadius:"999px",display:"inline-flex",alignItems:"center",justifyContent:"center",background:"linear-gradient(135deg, rgba(56, 189, 248, 0.55), rgba(94, 234, 212, 0.55))",color:"#02111f",fontSize:"0.62rem",fontWeight:700,border:"1px solid rgba(94, 234, 212, 0.5)"},children:"✓"}),s.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"0.2rem",flex:1},children:[s.jsx("span",{style:{fontWeight:600},children:m.label}),m.summary&&s.jsx("span",{style:{fontSize:"0.66rem",color:"rgba(203, 213, 225, 0.82)"},children:m.summary})]})]},m.id))})]}),s.jsxs("div",{style:{border:"1px solid rgba(148, 163, 184, 0.22)",borderRadius:"14px",padding:"0.9rem 1.1rem",background:"rgba(15, 23, 42, 0.6)",display:"flex",flexDirection:"column",gap:"0.65rem"},children:[s.jsx("span",{style:{fontSize:"0.7rem",color:"rgba(148, 163, 184, 0.78)"},children:n.sideReminder}),d.length===0?s.jsx("span",{style:{fontSize:"0.72rem",color:"rgba(226, 232, 240, 0.88)"},children:"—"}):s.jsx("ul",{style:{margin:0,paddingLeft:"1.1rem",display:"flex",flexDirection:"column",gap:"0.35rem",fontSize:"0.72rem",color:"rgba(226, 232, 240, 0.88)",listStyle:"disc"},children:d.map(m=>s.jsx("li",{children:m.label},m.id))})]}),s.jsx("span",{style:{fontSize:"0.64rem",color:"rgba(148, 163, 184, 0.65)"},children:n.deferHint})]}),s.jsxs("div",{style:Bu,children:[s.jsx("button",{type:"button",onClick:o,style:{...Ra,border:"1px solid rgba(94, 234, 212, 0.5)",background:"linear-gradient(135deg, rgba(56, 189, 248, 0.7), rgba(94, 234, 212, 0.65))",color:"#02111f",boxShadow:"0 20px 36px rgba(13, 148, 136, 0.35)"},children:n.continueCta}),s.jsx("button",{type:"button",onClick:l,style:{...Ra,border:"1px solid rgba(148, 163, 184, 0.45)",background:"rgba(15, 23, 42, 0.75)",color:"rgba(226, 232, 240, 0.9)"},children:n.deferCta})]})]})})},Wu=()=>{const e=De(),t=E(f=>f.settings.locale),n=E(je),r=E(f=>f.missions),a=E(Xn),o=E(Mc),l=Pe(t),i=a&&!o,d=()=>{if(!n)return;const f=r.levels[r.currentLevelIndex+1],u=(f==null?void 0:f.zoneId)??null;Gc({level:n.level,levelId:n.levelId,name:n.name,nextLevel:(f==null?void 0:f.level)??n.level+1,nextLevelId:f==null?void 0:f.levelId}),e(Gi()),u&&e(Vi({zoneId:u}))},m=()=>{e(Ui())};return s.jsx(Hu,{open:i,levelName:(n==null?void 0:n.name)??"Current Sector",missionStrings:l.mission,primaryObjectives:(n==null?void 0:n.primary)??[],sideObjectives:(n==null?void 0:n.side)??[],onContinue:d,onDefer:m})},$u=[],Uu={width:"min(360px, 32vw)",minWidth:"280px",padding:"0.85rem 1rem 1.1rem",borderRadius:"16px",background:"linear-gradient(165deg, rgba(10,17,32,0.93), rgba(15,23,42,0.9))",border:"1px solid rgba(56,189,248,0.28)",boxShadow:"0 18px 36px rgba(15,23,42,0.55)",display:"flex",flexDirection:"column",gap:"0.72rem",pointerEvents:"auto"},Gu={display:"flex",alignItems:"center",justifyContent:"space-between",fontSize:"0.62rem",letterSpacing:"0.22em",textTransform:"uppercase",color:"#94a3b8"},Vu={display:"inline-flex",gap:"0.42rem",alignItems:"center",fontSize:"0.62rem",letterSpacing:"0.18em"},qu={fontWeight:700,fontSize:"0.78rem",color:"#38bdf8"},Yu={opacity:.8,color:"#cbd5f5"},Ku=e=>({width:"100%",display:"flex",alignItems:"center",justifyContent:"center",padding:"0.52rem 1rem",borderRadius:"12px",fontWeight:700,letterSpacing:"0.22em",fontSize:"0.76rem",textTransform:"uppercase",color:e?"#0f172a":"#f8fafc",background:e?"linear-gradient(135deg, #38bdf8, #60a5fa)":"linear-gradient(135deg, rgba(248,113,113,0.85), rgba(239,68,68,0.95))",boxShadow:e?"0 0 18px rgba(56,189,248,0.6), 0 14px 24px -10px rgba(56,189,248,0.55)":"0 0 18px rgba(239,68,68,0.6), 0 14px 24px -10px rgba(239,68,68,0.55)"}),Xu={display:"flex",flexDirection:"column",gap:"0.65rem",padding:"0.9rem 1rem 0.85rem",borderRadius:"14px",background:"linear-gradient(155deg, rgba(15,23,42,0.92), rgba(30,41,59,0.8))",border:"1px solid rgba(56,189,248,0.18)",boxShadow:"0 16px 32px rgba(15,23,42,0.45)"},Qu={display:"flex",justifyContent:"space-between",alignItems:"center",fontSize:"0.68rem",letterSpacing:"0.16em",color:"#9ca3c6",textTransform:"uppercase"},Zu=e=>({fontSize:"0.98rem",fontWeight:600,color:e?"#fda4af":"#f8fafc",textShadow:e?"0 0 12px rgba(248,113,113,0.45)":"none"}),Ju={position:"relative",height:"9px",borderRadius:"999px",background:"linear-gradient(90deg, rgba(30,41,59,0.9), rgba(11,16,28,0.85))",overflow:"hidden",boxShadow:"inset 0 0 8px rgba(15,23,42,0.6)"},ef=e=>({position:"absolute",top:0,left:0,height:"100%",width:`${Math.max(0,Math.min(1,e))*100}%`,background:"linear-gradient(90deg, rgba(96,165,250,0.95), rgba(56,189,248,0.85))",boxShadow:"0 0 16px rgba(56,189,248,0.38)",transition:"width 160ms ease-out"}),tf=e=>{const t={off:{border:"rgba(148,163,184,0.32)",glow:"rgba(148,163,184,0.22)",background:"linear-gradient(135deg, rgba(15,23,42,0.86), rgba(30,41,59,0.78))",label:"#cbd5f5",state:"#94a3b8",dot:"#64748b"},running:{border:"rgba(34,197,94,0.55)",glow:"rgba(34,197,94,0.45)",background:"linear-gradient(135deg, rgba(22,163,74,0.25), rgba(74,222,128,0.18))",label:"#d1fae5",state:"#86efac",dot:"#34d399"},paused:{border:"rgba(250,204,21,0.55)",glow:"rgba(250,204,21,0.38)",background:"linear-gradient(135deg, rgba(120,53,15,0.28), rgba(217,119,6,0.22))",label:"#fef3c7",state:"#fde68a",dot:"#fbbf24"}}[e];return{width:"100%",display:"flex",alignItems:"center",justifyContent:"space-between",padding:"0.52rem 0.9rem",borderRadius:"12px",border:`1px solid ${t.border}`,background:t.background,color:t.label,fontWeight:500,fontSize:"0.72rem",letterSpacing:"0.16em",textTransform:"uppercase",cursor:"pointer",boxShadow:`0 0 22px ${t.glow}`,transition:"transform 120ms ease, box-shadow 120ms ease, border-color 160ms ease"}},nf={display:"flex",flexDirection:"column",alignItems:"flex-start",gap:"0.14rem"},rf={fontSize:"0.58rem",letterSpacing:"0.3em",opacity:.74},af=e=>({fontSize:"0.84rem",letterSpacing:"0.14em",color:{off:"#cbd5f5",running:"#bbf7d0",paused:"#fde68a"}[e]}),sf=e=>{const t={off:{background:"#64748b",shadow:"rgba(100,116,139,0.35)"},running:{background:"#34d399",shadow:"rgba(52,211,153,0.55)"},paused:{background:"#fbbf24",shadow:"rgba(251,191,36,0.45)"}};return{width:"0.6rem",height:"0.6rem",borderRadius:"50%",background:t[e].background,boxShadow:`0 0 14px ${t[e].shadow}`}},of={display:"flex",flexDirection:"column",gap:"0.5rem",padding:"0.82rem 0.95rem",borderRadius:"14px",background:"linear-gradient(160deg, rgba(17,24,39,0.86), rgba(15,23,42,0.9))",border:"1px solid rgba(99,102,241,0.22)",boxShadow:"0 16px 32px rgba(15,23,42,0.42)"},lf={display:"block",fontSize:"0.58rem",letterSpacing:"0.24em",color:"#808bb2",textTransform:"uppercase"},cf={display:"grid",gridTemplateColumns:"minmax(0, 1fr) minmax(0, 1.5fr) auto",alignItems:"center",gap:"0.6rem",fontSize:"0.72rem",color:"#d1dcff"},df={position:"relative",height:"6px",borderRadius:"999px",background:"rgba(71,85,105,0.45)",overflow:"hidden"},uf=e=>({position:"absolute",inset:0,width:`${Math.max(0,Math.min(1,e))*100}%`,background:"linear-gradient(90deg, rgba(239,68,68,0.85), rgba(248,113,113,0.78))",boxShadow:"0 0 12px rgba(248,113,113,0.32)",transition:"width 160ms ease-out"}),ff={fontSize:"0.66rem",opacity:.84,minWidth:"44px",textAlign:"right"},mf=()=>{const e=De(),t=E(A=>A.settings.locale),n=E(A=>A.autoBattle.status),r=E(A=>A.world.inCombat),a=E(A=>A.world.isPlayerTurn),o=E(A=>A.settings.autoBattleEnabled),l=E(A=>A.player.data.actionPoints),i=E(A=>A.player.data.maxActionPoints),d=E(A=>{var Y;return((Y=A.world.currentMapArea)==null?void 0:Y.entities.enemies)??$u}),m=Pe(t),f=c.useMemo(()=>d.filter(A=>A.health>0),[d]),u=f.length,h=c.useMemo(()=>f.slice().sort((A,Y)=>Y.actionPoints-A.actionPoints).slice(0,4),[f]),[v,x]=c.useState(l),b=c.useRef(v),C=c.useRef(null);if(c.useEffect(()=>{b.current=v},[v]),c.useEffect(()=>{const A=l;if(C.current&&(window.clearTimeout(C.current),C.current=null),!r){x(A);return}if(!(o&&n==="running")||A>=b.current){x(A);return}const te=()=>{const fe=b.current;if(fe<=A){C.current=null;return}x(fe-1),C.current=window.setTimeout(te,70)};return C.current=window.setTimeout(te,60),()=>{C.current&&(window.clearTimeout(C.current),C.current=null)}},[l,r,o,n]),c.useEffect(()=>()=>{C.current&&window.clearTimeout(C.current)},[]),!r)return null;const _=Math.max(0,i),y=_>0?Math.max(0,Math.min(1,v/_)):0,N=()=>{e(An(!o))},$=o?n==="paused"?"paused":n==="running"?"running":"off":"off";return s.jsxs("div",{style:Uu,"data-testid":"combat-control-widget",children:[s.jsxs("div",{style:Gu,children:[s.jsx("span",{children:m.turnTracker.heading.toUpperCase()}),s.jsxs("span",{style:Vu,children:[s.jsx("span",{style:qu,children:u}),s.jsx("span",{style:Yu,children:m.turnTracker.hostileReadout.toUpperCase()})]})]}),s.jsx("div",{style:Ku(a),children:a?m.turnTracker.playerTurn:m.turnTracker.enemyTurn}),s.jsxs("div",{style:Xu,children:[s.jsxs("div",{style:Qu,children:[s.jsx("span",{children:m.playerStatus.actionPointsLabel}),s.jsxs("span",{style:Zu(v===0),children:[v,"/",i]})]}),s.jsx("div",{style:Ju,children:s.jsx("div",{style:ef(y)})})]}),s.jsxs("button",{type:"button",onClick:N,style:tf($),"aria-pressed":o,"aria-label":m.autoBattle.toggleLabel,children:[s.jsxs("span",{style:nf,children:[s.jsx("span",{style:rf,children:m.autoBattle.heading.toUpperCase()}),s.jsx("span",{style:af($),children:$==="off"?m.autoBattle.hudToggleOffLabel:m.autoBattle.hudToggleOnLabel})]}),s.jsx("span",{style:sf($)})]}),s.jsxs("div",{style:of,children:[s.jsx("span",{style:lf,children:m.turnTracker.hostileReadout.toUpperCase()}),s.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"0.55rem"},children:h.length>0?h.map(A=>{const Y=A.maxActionPoints>0?Math.max(0,Math.min(1,A.actionPoints/A.maxActionPoints)):0;return s.jsxs("div",{style:cf,children:[s.jsx("span",{style:{fontWeight:600,overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"},title:A.name,children:A.name}),s.jsx("div",{style:df,children:s.jsx("div",{style:uf(Y)})}),s.jsxs("span",{style:ff,children:[A.actionPoints,"/",A.maxActionPoints]})]},A.id)}):s.jsx("span",{style:{fontSize:"0.68rem",color:"#9ca3c6",textAlign:"center",letterSpacing:"0.1em"},children:m.turnTracker.playerTurn.toUpperCase()})})]})]})},pf=c.lazy(()=>bt(()=>import("./GameMenu-CLfAxnfK.js"),__vite__mapDeps([0,1,2,3,4,5]))),gf=c.lazy(()=>bt(()=>import("./CharacterCreationScreen-CNJ7JNkw.js"),__vite__mapDeps([6,1,2,4,3,5,7]))),hf=c.lazy(()=>bt(()=>import("./CharacterScreen-DCP4_Mlb.js"),__vite__mapDeps([8,1,2,3,4,7]))),bf=c.lazy(()=>bt(()=>import("./LevelUpModal-BVD2FLv7.js"),__vite__mapDeps([9,1,2,5,4,3])).then(e=>({default:e.LevelUpModal}))),yf=c.lazy(()=>bt(()=>import("./PerkSelectionPanel-DGpYa3F2.js"),__vite__mapDeps([10,1,2,3,4]))),xf=c.lazy(()=>bt(()=>import("./LevelUpPointAllocationPanel-CBufruiv.js"),__vite__mapDeps([11,1,2,4,3,5]))),Da=Fa("App"),wf={margin:0,padding:0,width:"100vw",height:"100vh",overflow:"hidden",position:"relative",backgroundColor:"var(--color-gunmetal-900)",color:"var(--color-hud-text)",fontFamily:"var(--font-mono)"},vf={position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",background:"var(--hud-stage-background)"},Cn=260,Sf=320,If={flex:"1 1 auto",minWidth:0,height:"100%",position:"relative",overflow:"hidden"},kf={position:"absolute",top:"1.25rem",left:"1.25rem",display:"flex",flexDirection:"column",alignItems:"flex-start",gap:"0.75rem",zIndex:5,pointerEvents:"auto"},Ef={position:"absolute",top:"1.25rem",left:"50%",transform:"translateX(-50%)",display:"flex",flexDirection:"column",alignItems:"center",gap:"0.75rem",zIndex:6,pointerEvents:"auto"},Mf={position:"absolute",top:"1.25rem",right:"1.25rem",display:"flex",flexDirection:"column",alignItems:"flex-end",gap:"0.75rem",zIndex:6,pointerEvents:"none"},Cf={all:"unset",display:"flex",alignItems:"center",justifyContent:"space-between",gap:"0.5rem",padding:"0.7rem 0.9rem",boxSizing:"border-box",borderRadius:"14px",border:"var(--hud-command-button-border)",background:"var(--hud-command-button-bg)",boxShadow:"var(--hud-command-button-shadow)",color:"var(--hud-command-button-text)",fontFamily:"var(--font-mono)",fontSize:"0.7rem",letterSpacing:"0.14em",textTransform:"uppercase",cursor:"pointer",pointerEvents:"auto",transition:"transform 0.16s ease, box-shadow 0.16s ease, border-color 0.16s ease, color 0.16s ease"},Tf={fontSize:"0.78rem",letterSpacing:"0.2em",color:"inherit"},Pf={fontSize:"0.62rem",letterSpacing:"0.24em",color:"var(--hud-command-button-text-muted)",textTransform:"uppercase"},_f=({onOpenMenu:e,onToggleCharacter:t,showMenu:n,characterOpen:r,levelPanelCollapsed:a,onToggleLevelPanel:o,hudLayoutPreset:l})=>{const i=E(g=>g.settings.locale),d=E(g=>g.settings.testMode),m=E(g=>g.world.inCombat),f=Pe(i),u=E(g=>{var w;return((w=g.world.currentMapArea)==null?void 0:w.zoneId)??null}),h=l==="combat",v=l==="stealth",[x,b]=c.useState(!1),[C,_]=c.useState(null),y=c.useRef(null),[N,R]=c.useState(null),[$,A]=c.useState(Cn);c.useEffect(()=>{n&&b(!1)},[n]),c.useEffect(()=>{m&&b(!1)},[m]),c.useEffect(()=>{if(typeof window>"u"||typeof ResizeObserver>"u")return;const g=y.current;if(!g)return;const w=new ResizeObserver(S=>{const L=S[0];if(!L)return;const T=Math.round(L.contentRect.height);R(I=>I===T?I:T)});return w.observe(g),()=>w.disconnect()},[]),c.useEffect(()=>{const g=y.current;if(!g)return;const w=Math.round(g.getBoundingClientRect().height);R(S=>S===w?S:w)},[]),c.useEffect(()=>{if(!N){A(Cn);return}if(typeof window>"u"){A(N);return}const w=(parseFloat(window.getComputedStyle(document.documentElement).fontSize||"16")||16)*1.3,S=Math.round(N+w),L=Math.min(Math.max(S,Cn),Sf);A(T=>T===L?T:L)},[N]);const Y=()=>{b(g=>!g)},te=x?f.shell.completedToggleClose:f.shell.completedToggleOpen;return c.useEffect(()=>{if(!(typeof document>"u"))return $?document.documentElement.style.setProperty("--bottom-panel-height",`${$}px`):document.documentElement.style.removeProperty("--bottom-panel-height"),()=>{typeof document<"u"&&document.documentElement.style.removeProperty("--bottom-panel-height")}},[$]),s.jsxs("div",{style:vf,className:"command-shell-stage","data-hud-layout":l,children:[s.jsxs("div",{style:If,children:[s.jsx(lu,{}),s.jsx(no,{onRendererInfo:_}),s.jsx(Vl,{}),s.jsxs("div",{style:kf,children:[s.jsxs("button",{type:"button",onClick:e,style:{...Cf,width:"90vw",maxWidth:"240px"},"data-testid":"menu-overlay-button","aria-label":f.shell.menuButton,title:f.shell.menuButton,onMouseEnter:g=>{g.currentTarget.style.transform="translateY(-2px)",g.currentTarget.style.boxShadow="var(--hud-command-button-shadow-hover)",g.currentTarget.style.borderColor="var(--hud-command-button-border-hover)",g.currentTarget.style.color="var(--hud-command-button-text-hover)"},onMouseLeave:g=>{g.currentTarget.style.transform="translateY(0)",g.currentTarget.style.boxShadow="var(--hud-command-button-shadow)",g.currentTarget.style.borderColor="var(--hud-command-button-border-rest)",g.currentTarget.style.color="var(--hud-command-button-text)"},onFocus:g=>{g.currentTarget.style.boxShadow="var(--hud-command-button-shadow-focus)",g.currentTarget.style.borderColor="var(--hud-command-button-border-focus)"},onBlur:g=>{g.currentTarget.style.boxShadow="var(--hud-command-button-shadow)",g.currentTarget.style.borderColor="var(--hud-command-button-border-rest)"},children:[s.jsx("span",{style:Tf,children:f.shell.menuButton}),s.jsx("span",{style:Pf,children:"ESC"})]}),s.jsx(Cc,{collapsed:a,onToggle:o}),d?s.jsx(ls,{zoneId:u,rendererInfo:C}):null]}),s.jsx("div",{style:Ef,children:s.jsx(mf,{})}),s.jsxs("div",{style:Mf,children:[s.jsx("div",{style:{pointerEvents:"auto"},children:s.jsx(nc,{})}),s.jsx("div",{style:{pointerEvents:"auto"},children:s.jsx(hu,{})}),s.jsx("div",{style:{pointerEvents:"auto"},children:s.jsx(pu,{})})]}),s.jsx(eu,{}),s.jsx(uu,{})]}),s.jsxs("div",{className:"hud-bottom-dock","data-hud-layout":l,children:[s.jsx("div",{className:"hud-bottom-lane hud-bottom-lane--map","data-hud-emphasis":v?"true":void 0,children:s.jsx("div",{className:"hud-bottom-lane-card",children:s.jsx("div",{className:"hud-bottom-card-surface",children:s.jsx(xc,{className:"hud-bottom-map-card",variant:"frameless",children:s.jsx(bc,{})})})})}),s.jsx("div",{className:"hud-bottom-lane hud-bottom-lane--status",ref:y,"data-hud-emphasis":h?"true":void 0,children:s.jsx("div",{className:"hud-bottom-lane-card",children:s.jsx("div",{className:"hud-bottom-card-surface",children:s.jsx(Zl,{onOpenCharacter:t,characterOpen:r,variant:"frameless"})})})}),s.jsx("div",{className:"hud-bottom-lane hud-bottom-lane--george",children:s.jsx("div",{className:"hud-bottom-lane-card",children:s.jsx("div",{className:"hud-bottom-card-surface",children:s.jsx(ed,{})})})}),s.jsxs("div",{className:"hud-bottom-lane hud-bottom-lane--ops",children:[s.jsx("div",{className:"hud-bottom-lane-card",children:s.jsxs("div",{className:"hud-bottom-card-surface",children:[s.jsx("div",{className:"hud-bottom-quests",children:s.jsx(Ta,{})}),s.jsx("div",{className:"hud-bottom-control-row",children:s.jsx("button",{type:"button",className:"hud-bottom-toggle",onClick:Y,"aria-expanded":x,"aria-controls":"command-objective-overlay",children:te})})]})}),s.jsx("div",{id:"command-objective-overlay",className:"hud-bottom-overlay","data-expanded":x,children:s.jsx("div",{className:"hud-bottom-overlay__scroll",children:s.jsx(Ta,{showCompleted:!0})})})]})]})]})},ja=()=>{if(typeof window>"u")return!1;try{return!!window.localStorage.getItem(Wa)}catch(e){return console.warn("[App] Failed to read persisted game state",e),!1}},Xt=e=>Zi().filter(t=>!e.perks.includes(t.id)),Tn=e=>Xt(e).map(t=>Ji(e,t)).filter(t=>t.canSelect);function Af(){const[e,t]=c.useState(!1),[n,r]=c.useState(!0),[a,o]=c.useState(!1),[l,i]=c.useState(()=>ja()),[d,m]=c.useState(null),[f,u]=c.useState([]),[h,v]=c.useState(!1),[x,b]=c.useState(0),[C,_]=c.useState(!1),[y,N]=c.useState(!1),[R,$]=c.useState(!1),[A,Y]=c.useState(!0),te=E(Mu),fe=E(G=>!!G.settings.reputationSystemsEnabled);c.useEffect(()=>{Da.debug("Component mounted"),Da.debug("Store state:",xe.getState())},[]),c.useEffect(()=>xe.subscribe(()=>{const Q=xe.getState(),le=Q.player.pendingLevelUpEvents;m(D=>D||(le.length>0?le[0]:null));const ue=Q.player.data.pendingPerkSelections;b(ue);const ie=Q.player.xpNotifications??[];u(ie)}),[]),c.useEffect(()=>{if(n){if(e){i(!0);return}i(ja())}},[n,e]),c.useEffect(()=>{if(typeof window>"u")return;const G=new URLSearchParams(window.location.search);if(G.get("poc")!=="esb"||e||a)return;try{window.localStorage.removeItem(Wa)}catch{}i(!1),r(!1);const Q={name:G.get("pocName")??"Deus",attributes:Tr,backgroundId:"corpsec_defector",visualPreset:"default"};g(Q)},[e,a]),c.useEffect(()=>{e&&window.requestAnimationFrame(()=>{window.dispatchEvent(new Event("resize"))})},[e]),c.useEffect(()=>{(n||a)&&v(!1)},[n,a]),c.useEffect(()=>{const G=Q=>{Q.key.toLowerCase()==="c"&&e&&!n&&!a&&v(le=>!le),Q.key.toLowerCase()==="l"&&e&&!n&&!a&&Y(le=>!le)};return window.addEventListener("keydown",G),()=>window.removeEventListener("keydown",G)},[e,n,a]);const me=()=>{r(!1),o(!0)},g=G=>{xe.dispatch(qi());const Q=G.attributes??Tr,le=G.backgroundId??"corpsec_defector";xe.dispatch(Yi({name:G.name,skills:Q,backgroundId:le,visualPreset:G.visualPreset}));const ue=xe.getState(),{logs:ie}=Xe(ue.settings.locale);xe.dispatch(F(`${ie.operationStart} - Call sign: ${G.name}`));const D=ue.quests.quests.find(ne=>ne.id==="quest_market_cache");D&&!D.isActive&&!D.isCompleted&&(xe.dispatch(Ha(D.id)),xe.dispatch(F(ie.questAccepted(D.name)))),o(!1),t(!0),i(!0)},w=()=>{o(!1),r(!0)},S=()=>{xe.dispatch(Ki()),t(!0),r(!1),i(!0)};c.useEffect(()=>{if(!e)return;const G=Q=>{if(Q.key!=="Escape")return;if(Q.preventDefault(),h){v(!1),y&&N(!1);return}if(!!xe.getState().quests.activeDialogue.dialogueId){xe.dispatch(Zt());return}if(n){S();return}a||r(!0)};return window.addEventListener("keydown",G),()=>window.removeEventListener("keydown",G)},[e,n,a,h,y]);const L=()=>{if(!e){r(!0);return}if(n){S();return}if(!!xe.getState().quests.activeDialogue.dialogueId){xe.dispatch(Zt());return}r(!0)},T=()=>{!e||n||a||v(G=>!G)},I=()=>{if(!d)return;const Q=xe.getState().player.data,le=Q.pendingPerkSelections,ue=Xt(Q),ie=Tn(Q),D=le>0,ne=ie.length>0,O=Q.skillPoints>0||Q.attributePoints>0;N(D||O),xe.dispatch(Xi()),m(null),D&&ue.length>0?(ne||console.info("[LevelUp] Perk selections available but current requirements are unmet. Player may need to allocate points first."),_(!0)):(D&&ue.length===0&&xe.dispatch(hn()),O?$(!0):N(!1))},q=()=>{if(_(!1),!y)return;const G=xe.getState().player.data,Q=G.pendingPerkSelections,le=G.skillPoints>0||G.attributePoints>0,ue=Xt(G),ie=Tn(G);if(Q>0&&ie.length===0&&ue.length===0&&xe.dispatch(hn()),le){$(!0);return}N(!1)},ee=()=>{v(!1),y&&N(!1)},de=()=>{$(!1);const G=xe.getState().player.data,Q=G.pendingPerkSelections,le=Xt(G),ue=Tn(G);if(Q>0&&ue.length>0){_(!0);return}Q>0&&ue.length===0&&le.length===0&&xe.dispatch(hn()),N(!1)},be=G=>{xe.dispatch(Qi(G))};return s.jsxs(s.Fragment,{children:[s.jsx(Cu,{}),fe&&s.jsx(Ou,{}),s.jsxs("div",{style:wf,children:[e&&s.jsx(_f,{onOpenMenu:L,onToggleCharacter:T,showMenu:n,characterOpen:h,levelPanelCollapsed:A,onToggleLevelPanel:()=>Y(G=>!G),hudLayoutPreset:te}),s.jsx(vu,{})]}),s.jsxs(c.Suspense,{fallback:null,children:[n&&s.jsx(pf,{onStartNewGame:me,onContinue:S,hasActiveGame:e||l}),a&&s.jsx(gf,{onComplete:g,onCancel:w}),d&&s.jsx(bf,{newLevel:d.newLevel,skillPointsEarned:d.skillPointsEarned,attributePointsEarned:d.attributePointsEarned,perksUnlocked:d.perksUnlocked,onContinue:I}),s.jsx(yf,{open:C,pendingSelections:x,onClose:q}),R&&s.jsx(xf,{onComplete:de}),s.jsx(hf,{open:h,onClose:ee}),s.jsx(Wu,{})]}),s.jsx(ou,{notifications:f,onDismiss:be})]})}function Rf(){return s.jsx(_s,{store:xe,children:s.jsx(Af,{})})}As.createRoot(document.getElementById("root")).render(s.jsx(c.StrictMode,{children:s.jsx(Rf,{})}));export{Zl as P,Ff as a,Bf as b,zf as c,Hf as d,Wf as e,Gf as f,Uf as g,nn as n,$f as s};
