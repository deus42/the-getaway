var Ua=Object.defineProperty;var Ka=(e,t,i)=>t in e?Ua(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var y=(e,t,i)=>Ka(e,typeof t!="symbol"?t+"":t,i);import{P}from"./phaser-DkaA9Y8j.js";import{v as se,g as gt,a as ja,e as $a,i as Yt,c as Ya,b as Za,d as Xa,f as Zt,D as Ae,L as Qa,Q as Ja,h as er,P as tr,j as En,k as _n,l as ir,m as sr,n as Is,o as xs}from"./game-content-C9O_rpgO.js";import{c as Q,a as nr,b as ar,d as rr}from"./vendor-Cc93p67d.js";const $e=Object.freeze({qualityPreset:"balanced",lightsEnabled:!1,bloom:{enabled:!1,color:16777215,offsetX:0,offsetY:0,blurStrength:0,strength:0,steps:0},vignette:{enabled:!1,x:.5,y:.5,radius:1,strength:0},colorMatrix:{enabled:!1,saturation:0,brightness:1,contrast:0,hue:0}});let ae={qualityPreset:$e.qualityPreset,lightsEnabled:$e.lightsEnabled,bloom:{...$e.bloom},vignette:{...$e.vignette},colorMatrix:{...$e.colorMatrix}};const wi=new Set,or=()=>{wi.forEach(e=>e(ae))},ti=e=>{ae={qualityPreset:e.qualityPreset??ae.qualityPreset,lightsEnabled:e.lightsEnabled??ae.lightsEnabled,bloom:{...ae.bloom,...e.bloom??{}},vignette:{...ae.vignette,...e.vignette??{}},colorMatrix:{...ae.colorMatrix,...e.colorMatrix??{}}},or()},lr=e=>e==="performance"?{bloomStrengthCap:.18,vignetteCap:.22,colorMatrixEnabled:!1,maxFogBands:2,maxEmissiveZones:6,wetReflectionAlpha:.08,occlusionFadeFloor:.56}:e==="cinematic"?{bloomStrengthCap:.48,vignetteCap:.44,colorMatrixEnabled:!0,maxFogBands:6,maxEmissiveZones:14,wetReflectionAlpha:.2,occlusionFadeFloor:.38}:{bloomStrengthCap:.32,vignetteCap:.34,colorMatrixEnabled:!0,maxFogBands:4,maxEmissiveZones:10,wetReflectionAlpha:.14,occlusionFadeFloor:.48},Cs=e=>lr(e),Dn=e=>(wi.add(e),e(ae),()=>{wi.delete(e)}),cr=(e,t)=>{t.enabled&&e.postFX.addBloom(t.color,t.offsetX,t.offsetY,t.blurStrength,t.strength,t.steps)},dr=(e,t)=>{t.enabled&&e.postFX.addVignette(t.x,t.y,t.radius,t.strength)},ur=(e,t)=>{if(!t.enabled)return;const i=e.postFX.addColorMatrix();let s=!1;const n=a=>{a(s),s=!0};t.saturation!==0&&n(a=>i.saturate(t.saturation,a)),t.hue!==0&&n(a=>i.hue(t.hue,a)),t.contrast!==0&&n(a=>i.contrast(t.contrast,a)),t.brightness!==1&&n(a=>i.brightness(t.brightness,a))},hr=e=>{e.clearFX(),cr(e,ae.bloom),dr(e,ae.vignette),ur(e,ae.colorMatrix)},pr=e=>{const i=Dn(()=>hr(e));return()=>{i(),e.clearFX()}};var B=(e=>(e.IDLE="idle",e.SUSPICIOUS="suspicious",e.INVESTIGATING="investigating",e.ALARMED="alarmed",e))(B||{}),ne=(e=>(e.IDLE="idle",e.SUSPICIOUS="suspicious",e.ALARMED="alarmed",e.DISABLED="disabled",e))(ne||{}),R=(e=>(e.FLOOR="floor",e.WALL="wall",e.DOOR="door",e.COVER="cover",e.WATER="water",e.TRAP="trap",e))(R||{});const J=5,ee=10,Ln=[{id:"combat",label:"Combat",blurb:"Disciplines that determine battlefield performance and weapon mastery.",skills:[{id:"smallGuns",name:"Small Guns",branch:"combat",maxValue:100,increment:J,taggedIncrement:ee,description:"Training with ballistic pistols, SMGs, and rifles.",effectSummary:"+0.5% hit chance per point with ballistic weapons."},{id:"energyWeapons",name:"Energy Weapons",branch:"combat",maxValue:100,increment:J,taggedIncrement:ee,description:"Mastery of beam, laser, and plasma weapon systems.",effectSummary:"+0.4% hit chance and +0.3% crit chance per point with energy weapons."},{id:"meleeCombat",name:"Melee Combat",branch:"combat",maxValue:100,increment:J,taggedIncrement:ee,description:"Close-quarters tactics for blades, clubs, and unarmed strikes.",effectSummary:"+0.3% melee hit chance per point and +1 damage per 10 points."},{id:"explosives",name:"Explosives",branch:"combat",maxValue:100,increment:J,taggedIncrement:ee,description:"Deployment of grenades, mines, and shaped charges.",effectSummary:"+0.25% throw accuracy per point and +1 tile radius per 25 points."}]},{id:"tech",label:"Tech",blurb:"System infiltration, fabrication, and field engineering aptitudes.",skills:[{id:"hacking",name:"Hacking",branch:"tech",maxValue:100,increment:J,taggedIncrement:ee,description:"Bypass security systems and crack encrypted terminals.",effectSummary:"Unlocks advanced intrusion dialogue choices and minigames (stub).",stub:!0},{id:"engineering",name:"Engineering",branch:"tech",maxValue:100,increment:J,taggedIncrement:ee,description:"Maintain drones, turrets, and battlefield gadgets.",effectSummary:"Improves deployable durability and crafting options (stub).",stub:!0},{id:"science",name:"Science",branch:"tech",maxValue:100,increment:J,taggedIncrement:ee,description:"Chemical analysis and experimental tech research.",effectSummary:"Boosts chem crafting and anomaly research (stub).",stub:!0}]},{id:"survival",label:"Survival",blurb:"Field medicine, stealth, and salvage expertise.",skills:[{id:"medicine",name:"Medicine",branch:"survival",maxValue:100,increment:J,taggedIncrement:ee,description:"Treat injuries and synthesize bio-stims under fire.",effectSummary:"Increases healing efficiency and unlocks aid recipes (stub).",stub:!0},{id:"stealth",name:"Stealth",branch:"survival",maxValue:100,increment:J,taggedIncrement:ee,description:"Avoid detection and blend into hostile zones.",effectSummary:"Improves detection thresholds and noise damping (stub).",stub:!0},{id:"scavenging",name:"Scavenging",branch:"survival",maxValue:100,increment:J,taggedIncrement:ee,description:"Recover components and rare materials from ruins.",effectSummary:"Increases loot yields and salvage spots (stub).",stub:!0}]},{id:"social",label:"Social",blurb:"Command presence, negotiation, and underground influence.",skills:[{id:"persuasion",name:"Persuasion",branch:"social",maxValue:100,increment:J,taggedIncrement:ee,description:"Convince allies and sway neutral factions.",effectSummary:"Unlocks diplomatic dialogue options and better rewards (stub).",stub:!0},{id:"intimidation",name:"Intimidation",branch:"social",maxValue:100,increment:J,taggedIncrement:ee,description:"Force compliance through presence and threat.",effectSummary:"Unlocks threat-based dialogue paths (stub).",stub:!0},{id:"barter",name:"Barter",branch:"social",maxValue:100,increment:J,taggedIncrement:ee,description:"Broker deals and hustle black-market channels.",effectSummary:"Improves vendor prices and trade availability (stub).",stub:!0}]}],mr=Ln.flatMap(e=>e.skills).reduce((e,t)=>(e[t.id]=t,e),{});Ln.reduce((e,t)=>(e[t.id]=t,e),{});const Pi=e=>{const t=mr[e];if(!t)throw new Error(`[skills] Unknown skill id: ${e}`);return t},Ki=(e,t)=>e.skillTraining[t]??0,gr=(e,t)=>e.taggedSkillIds.includes(t),ft=(e,t=100)=>!Number.isFinite(e)||e<0?0:Math.min(t,e),op=(e,t)=>{const i=Pi(t);return gr(e,t)?i.taggedIncrement:i.increment},Fn=e=>e?e.skillType??(e.range<=1?"meleeCombat":"smallGuns"):"meleeCombat",Bn=e=>ft(e)*.5,ji=e=>{const t=ft(e);return{hit:t*.4,crit:t*.3}},$i=e=>{const t=ft(e);return{hit:t*.35,damage:Math.floor(t/10)}},On=e=>{const t=ft(e);return{accuracy:t*.25,radius:Math.floor(t/25)}},lp=(e,t)=>{const i=ft(t);switch(e){case"smallGuns":return`Hit chance bonus +${Bn(i).toFixed(1)}% with ballistic weapons`;case"energyWeapons":{const s=ji(i);return`Hit +${s.hit.toFixed(1)}% / Crit +${s.crit.toFixed(1)}% with energy weapons`}case"meleeCombat":{const s=$i(i);return`Hit +${s.hit.toFixed(1)}% / Damage +${s.damage}`}case"explosives":{const s=On(i),n=s.radius===1?"tile":"tiles";return`Throw accuracy +${s.accuracy.toFixed(1)}%, blast radius +${s.radius} ${n}`}default:return"Specialisation effects coming online soon."}},ks=10,Xt=64,fr=(e,t)=>{const i=[];for(let s=0;s<t;s++){i[s]=[];for(let n=0;n<e;n++)i[s][n]={type:R.FLOOR,position:{x:n,y:s},isWalkable:!0,provideCover:!1}}return i},Nn=(e,t=ks,i=ks,s={})=>{const n=fr(t,i);for(let a=0;a<t;a++)n[0][a].type=R.WALL,n[0][a].isWalkable=!1,n[i-1][a].type=R.WALL,n[i-1][a].isWalkable=!1;for(let a=0;a<i;a++)n[a][0].type=R.WALL,n[a][0].isWalkable=!1,n[a][t-1].type=R.WALL,n[a][t-1].isWalkable=!1;return{id:se(),name:e,zoneId:s.zoneId??"unknown_zone",level:s.level??0,objectives:s.objectives??[],isInterior:s.isInterior??!1,factionRequirement:s.factionRequirement,displayName:s.displayName,summary:s.summary,dangerRating:s.dangerRating,hazards:s.hazards??[],width:t,height:i,tiles:n,entities:{enemies:[],npcs:[],items:[]}}},yr=(e,t)=>{const i=[...e.tiles];for(const s of t)s.y>=0&&s.y<e.height&&s.x>=0&&s.x<e.width&&(i[s.y][s.x]={...i[s.y][s.x],type:R.WALL,isWalkable:!1});return{...e,tiles:i}},Sr=(e,t)=>{const i=[...e.tiles];for(const s of t)s.y>=0&&s.y<e.height&&s.x>=0&&s.x<e.width&&(i[s.y][s.x]={...i[s.y][s.x],type:R.COVER,provideCover:!0,isWalkable:!0});return{...e,tiles:i}},vr=(e,t,i)=>{if(!Ke(t,e))return e;const s=e.tiles.map((n,a)=>n.map((r,o)=>a===t.y&&o===t.x?{...r,cover:{...i},provideCover:!0}:r));return{...e,tiles:s}},Ke=(e,t)=>e.x>=0&&e.x<t.width&&e.y>=0&&e.y<t.height,Me=(e,t,i,s=[],n={})=>{if(!Ke(e,t))return!1;const a=t.tiles[e.y][e.x];if(!a.isWalkable||i&&a.skillRequirement&&Ki(i,a.skillRequirement.skill)<a.skillRequirement.threshold)return!1;const{npcs:r=[],ignoreNpcIds:o=[]}=n;return!(i&&i.position.x===e.x&&i.position.y===e.y||s.some(l=>l.position.x===e.x&&l.position.y===e.y)||r.some(l=>!o.includes(l.id)&&l.position.x===e.x&&l.position.y===e.y))},Hn=(e,t,i,s=[])=>[{x:e.x+1,y:e.y},{x:e.x-1,y:e.y},{x:e.x,y:e.y+1},{x:e.x,y:e.y-1}].filter(a=>Me(a,t,i,s)),Yi=(e,t,i,s=[])=>{if(Me(e,t,i,s))return e;const n=new Set,a=[e],r=l=>`${l.x},${l.y}`;n.add(r(e));const o=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}];for(;a.length>0;){const l=a.shift();if(!l)break;for(const c of o){const d={x:l.x+c.x,y:l.y+c.y},u=r(d);if(!n.has(u)&&(n.add(u),!!Ke(d,t))){if(Me(d,t,i,s))return d;a.push(d)}}}return null},me=(e,t)=>e.perks.includes(t),br=e=>e?e.range>1:!1,wr=e=>me(e,"steadyHands")?.1:0,Pr=e=>me(e,"toughness")?3:0,Zi=e=>me(e,"gunFu")?e.perkRuntime.gunFuShotsThisTurn<=0:!1,Mr=e=>me(e,"gunFu")?{...e,perkRuntime:{...e.perkRuntime,gunFuShotsThisTurn:e.perkRuntime.gunFuShotsThisTurn+1}}:e,Ar=e=>me(e,"gunFu")?{...e,perkRuntime:{...e.perkRuntime,gunFuShotsThisTurn:0}}:e,ii=e=>me(e,"adrenalineRush")?(e.maxHealth>0?e.health/e.maxHealth:0)<=.3&&e.perkRuntime.adrenalineRushTurnsRemaining<=0:!1,si=e=>me(e,"adrenalineRush")?{...e,actionPoints:Math.min(e.actionPoints+2,e.maxActionPoints+2),perkRuntime:{...e.perkRuntime,adrenalineRushTurnsRemaining:3}}:e,Ir=e=>{if(!me(e,"adrenalineRush"))return e;const t=Math.max(0,e.perkRuntime.adrenalineRushTurnsRemaining-1);return{...e,actionPoints:Math.min(e.actionPoints+2,e.maxActionPoints+2),perkRuntime:{...e.perkRuntime,adrenalineRushTurnsRemaining:t}}},xr=e=>!me(e,"ghost")||e.perkRuntime.ghostInvisibilityTurns<=0?e:{...e,perkRuntime:{...e.perkRuntime,ghostInvisibilityTurns:Math.max(0,e.perkRuntime.ghostInvisibilityTurns-1)}},Xi=e=>{const t={strengthBonus:0,perceptionBonus:0,enduranceBonus:0,charismaBonus:0,intelligenceBonus:0,agilityBonus:0,luckBonus:0,totalArmorRating:0,totalAPPenalty:0,totalDamageBonus:0},{weapon:i,armor:s}=e.equipped;return i&&i.statModifiers&&Ts(t,i.statModifiers),s&&(t.totalArmorRating+=s.protection||0,s.statModifiers&&Ts(t,s.statModifiers)),t};function Ts(e,t){e.strengthBonus=(e.strengthBonus||0)+(t.strengthBonus||0),e.perceptionBonus=(e.perceptionBonus||0)+(t.perceptionBonus||0),e.enduranceBonus=(e.enduranceBonus||0)+(t.enduranceBonus||0),e.charismaBonus=(e.charismaBonus||0)+(t.charismaBonus||0),e.intelligenceBonus=(e.intelligenceBonus||0)+(t.intelligenceBonus||0),e.agilityBonus=(e.agilityBonus||0)+(t.agilityBonus||0),e.luckBonus=(e.luckBonus||0)+(t.luckBonus||0),e.totalArmorRating=(e.totalArmorRating||0)+(t.armorRating||0),e.totalAPPenalty=(e.totalAPPenalty||0)+(t.apPenalty||0),e.totalDamageBonus=(e.totalDamageBonus||0)+(t.damageBonus||0)}const Cr=(e,t)=>({strength:e.strength+(t.strengthBonus||0),perception:e.perception+(t.perceptionBonus||0),endurance:e.endurance+(t.enduranceBonus||0),charisma:e.charisma+(t.charismaBonus||0),intelligence:e.intelligence+(t.intelligenceBonus||0),agility:e.agility+(t.agilityBonus||0),luck:e.luck+(t.luckBonus||0)}),kr=e=>Xi(e).totalArmorRating+Pr(e),Tr=(e,t)=>{const i=t.totalAPPenalty||0,s=e-i;return Math.max(1,Math.floor(s))},Rr=(e,t,i=0)=>e+(t.totalDamageBonus||0)+i,Er=(e,t)=>{const i=e-t;return Math.max(1,i)},Qi=e=>{const{strength:t,perception:i,endurance:s,charisma:n,intelligence:a,agility:r,luck:o}=e;return{maxHP:50+s*10,baseAP:6+Math.floor((r-5)*.5),maxStamina:50+s*5,carryWeight:25+t*5,criticalChance:5+i*2+o*2,dialogueThresholdBonus:Math.floor(n/2),skillPointsPerLevel:3+Math.floor(a/3),hitChanceModifier:(i-5)*3,dodgeChance:(r-5)*2,meleeDamageBonus:Math.floor(t/2)}},tt=e=>50+e*10,it=e=>6+Math.floor((e-5)*.5),pe=e=>50+e*5,st=e=>25+e*5,cp=(e,t,i=0)=>!Number.isFinite(e)||!Number.isFinite(t)||!Number.isFinite(i)?(console.warn("[StatCalculations] Invalid skill check parameters:",{attributeValue:e,threshold:t,bonus:i}),!1):e+i>=t,_r=e=>{const t=Xi(e),i=Cr(e.skills,t),s=Qi(i),n=Tr(s.baseAP,t);return{...s,baseAP:n}},Dr=(e,t,i)=>Number.isNaN(e)||!Number.isFinite(e)?0:Math.max(t,Math.min(i,Math.round(e))),te=e=>Dr(e,-100,100),re=[{id:"hostile",label:"Hostile",min:-100,max:-61,color:"#ef4444",icon:"⚠️"},{id:"unfriendly",label:"Unfriendly",min:-60,max:-20,color:"#f97316",icon:"⚠"},{id:"neutral",label:"Neutral",min:-19,max:19,color:"#94a3b8",icon:"•"},{id:"friendly",label:"Friendly",min:20,max:59,color:"#4ade80",icon:"★"},{id:"allied",label:"Allied",min:60,max:100,color:"#facc15",icon:"✪"}],Wn=re.reduce((e,t)=>(e[t.id]=t,e),{hostile:re[0],unfriendly:re[1],neutral:re[2],friendly:re[3],allied:re[4]}),ge=e=>{const t=te(e);for(const i of re)if(t>=i.min&&t<=i.max)return i;return Wn.neutral},dp=e=>ge(e),Lr=e=>{const t=ge(e),i=re.findIndex(n=>n.id===t.id);if(i<0||i===re.length-1)return null;const s=re[i+1];return{standing:s,requiredValue:s.min}},De={resistance:{definition:{id:"resistance",name:"Resistance",description:"Anti-regime saboteurs coordinating from hidden cells throughout the slums.",rivalId:"corpsec",defaultReputation:10},effects:{hostile:["Resistance ambush teams hunt you on sight.","Safe houses barred and support staff evacuate when you enter a cell."],unfriendly:["Handlers refuse new operations and keep patrol intel off the record.","Markets charge +50% and watchers shadow your movements."],neutral:["Standard trade access with baseline mission availability."],friendly:["Safe house quartermasters grant -25% discounts.","Resistance fire teams can reinforce nearby encounters.","Access to special sabotage contracts."],allied:["Leadership shares prototype gear and strategic intel.","Full access to command safe houses and staging areas.","Resistance commits strike units to the final mission."]}},corpsec:{definition:{id:"corpsec",name:"CorpSec",description:"Corporate security forces enforcing curfew and regime edicts downtown.",rivalId:"resistance",defaultReputation:-20},effects:{hostile:["CorpSec strike teams engage immediately and post bounties.","Checkpoints sealed; city travel heavily restricted."],unfriendly:["CorpSec enforcers tail you and random searches increase.","Vendor prices +50% and contracts withdrawn."],neutral:["Standard patrol scrutiny with access to routine contracts."],friendly:["Access to restricted checkpoints and heavy weapon requisitions.","CorpSec officers provide enforcement support nearby."],allied:["CorpSec elevates you to trusted asset status.","Elite armories and armored escorts unlocked for the endgame assault."]}},scavengers:{definition:{id:"scavengers",name:"Scavengers",description:"Resourceful traders running the black markets threading the slums and tunnels.",defaultReputation:0},effects:{hostile:["Black market shuts you out and bounty hunters look to cash in."],unfriendly:["Merchants hike prices by 50% and fence only low-tier goods.","Rumours and location intel dry up."],neutral:["Regular trade access with standard supply lists."],friendly:["Negotiated prices drop 25% and rare stock appears more often.","Vehicle parts and crafting materials offered reliably."],allied:["Exclusive caches, contraband routes, and crew hire options unlocked.","Scavengers lend munitions support during the finale."]}}},up=e=>De[e],Fr=()=>Object.values(De).map(e=>e.definition),Br=(e,t)=>De[e].effects[t],Or=e=>{const t={resistance:De.resistance.definition.defaultReputation,corpsec:De.corpsec.definition.defaultReputation,scavengers:De.scavengers.definition.defaultReputation};return e?{resistance:te(e.resistance??t.resistance),corpsec:te(e.corpsec??t.corpsec),scavengers:te(e.scavengers??t.scavengers)}:t},Nr=-70,Hr=60,Wr=.5,qn=(e,t,i)=>{const s=Or(e),n=[],a=te(e[t]??s[t]),r=ge(a),o=te(a+i),l=ge(o);s[t]=o,l.id!==r.id&&n.push({factionId:t,previousStanding:r.id,nextStanding:l.id});const c={},d=De[t].definition.rivalId;if(d){const u=te(e[d]??s[d]),h=ge(u),g=-Math.round(i*Wr);if(g!==0){const p=te(u+g),m=p-u;if(m!==0){s[d]=p,c[d]=m;const f=ge(p);f.id!==h.id&&n.push({factionId:d,previousStanding:h.id,nextStanding:f.id})}}if(o>=Hr){const p=te(Nr);if(s[d]>p){const m=ge(s[d]),f=p-s[d];s[d]=p,c[d]=(c[d]??0)+f;const w=ge(s[d]);w.id!==m.id&&n.push({factionId:d,previousStanding:m.id,nextStanding:w.id})}}}return{values:s,primaryDelta:o-a,rivalDeltas:c,standingChanges:n}},qr=(e,t,i)=>{const s=te(e[t]);return qn(e,t,te(i)-s)},hp=(e,t)=>{const i=ge(t);return{value:t,standing:i,effects:Br(e,i.id),nextThreshold:Lr(t)}},pp=e=>re.findIndex(t=>t.id===e),Gr={en:{hostile:"Hostile",unfriendly:"Unfriendly",neutral:"Neutral",friendly:"Friendly",allied:"Allied"},uk:{hostile:"Ворог",unfriendly:"Недружній",neutral:"Нейтральний",friendly:"Союзний",allied:"Союз"}},mp=(e,t)=>{var i;return((i=Gr[e])==null?void 0:i[t])??Wn[t].label},yt={strength:5,perception:5,endurance:5,charisma:5,intelligence:5,agility:5,luck:5},Rs=tt(yt.endurance),Es=it(yt.agility),Vr=st(yt.strength),_s=pe(yt.endurance),zr=Fr().reduce((e,t)=>(e[t.id]=t.defaultReputation,e),{resistance:0,corpsec:0,scavengers:0}),Ur=()=>({smallGuns:0,energyWeapons:0,meleeCombat:0,explosives:0,hacking:0,engineering:0,science:0,medicine:0,stealth:0,scavenging:0,persuasion:0,intimidation:0,barter:0}),qt=()=>({alignment:"earnest",flags:{earnest:1,sarcastic:0,ruthless:0,stoic:0},lastUpdated:0}),Y={id:se(),name:"Player",position:{x:3,y:1},facing:"south",coverOrientation:null,suppression:0,health:Rs,maxHealth:Rs,actionPoints:Es,maxActionPoints:Es,stamina:_s,maxStamina:_s,isExhausted:!1,movementProfile:"normal",stealthModeEnabled:!1,stealthCooldownExpiresAt:null,skills:yt,skillTraining:Ur(),taggedSkillIds:[],level:1,experience:0,credits:0,skillPoints:0,attributePoints:0,backgroundId:void 0,perks:[],pendingPerkSelections:0,karma:0,personality:qt(),factionReputation:{...zr},appearancePreset:void 0,inventory:{items:[],maxWeight:Vr,currentWeight:0,hotbar:[null,null,null,null,null]},equipped:{weapon:void 0,armor:void 0,accessory:void 0,secondaryWeapon:void 0,meleeWeapon:void 0,bodyArmor:void 0,helmet:void 0,accessory1:void 0,accessory2:void 0},equippedSlots:{},activeWeaponSlot:"primaryWeapon",perkRuntime:{gunFuShotsThisTurn:0,adrenalineRushTurnsRemaining:0,ghostInvisibilityTurns:0,ghostConsumed:!1},encumbrance:{level:"normal",percentage:0,movementApMultiplier:1,attackApMultiplier:1}},Ji=e=>e<=1?0:Math.floor(100*e*(1+e*.15)),Kr=e=>3+Math.floor(e/3),jr=e=>e>0,$r=e=>e>0&&e%2===0,Yr=(e,t)=>{const i=Ji(t+1);return e>=i},Zr=e=>{let t=0,i=0,s=0,n=0;const a={...e};for(;Yr(a.experience,a.level);){const r=Ji(a.level+1);a.experience-=r,a.level+=1,t++;const o=Kr(a.skills.intelligence);i+=o,jr(a.level)&&s++,$r(a.level)&&n++,a.maxHealth+=5,a.health=a.maxHealth,a.maxStamina=pe(a.skills.endurance),a.stamina=a.maxStamina,a.isExhausted=!1,a.level%5===0&&(a.maxActionPoints+=1,a.actionPoints=a.maxActionPoints)}return{player:a,levelsGained:t,skillPointsAwarded:i,attributePointsAwarded:s,perksUnlocked:n}},Xr=(e,t)=>({...e,experience:Math.max(0,e.experience+t)}),gp=(e,t)=>{const i=Ji(t+1);return`${e} / ${i} XP`},Qr=[{id:"corpsec_defector",name:"Corpsec Defector",tagline:"Turned the regime’s training against them.",description:["Former security officer who leaked patrol routes until the alarms sounded on you.","You know their formations by heart and still dream in evac sirens."],factionAdjustments:{resistance:10,corpsec:-20},startingEquipment:[{type:"catalog",definitionId:"weapon_corpsec_service_pistol",equip:!0},{type:"catalog",definitionId:"armor_kevlar_vest",equip:!0},{type:"catalog",definitionId:"misc_corpsec_credentials"},{type:"catalog",definitionId:"consumable_basic_repair_kit",quantity:1}]},{id:"street_urchin",name:"Street Urchin",tagline:"Raised by alleys, guided by whispers.",description:["You hustled the markets since curfew was a bedtime story.","Lockpicks, fast feet, and favor debts keep you breathing."],factionAdjustments:{scavengers:10},startingEquipment:[{type:"catalog",definitionId:"weapon_shiv_knife",equip:!0},{type:"catalog",definitionId:"armor_layered_leather_jacket",equip:!0},{type:"catalog",definitionId:"misc_lockpick_set"},{type:"catalog",definitionId:"consumable_basic_repair_kit",quantity:1}]},{id:"underground_hacker",name:"Underground Hacker",tagline:"Screensaver by day, blackout by night.",description:["Your code toppled curfew drones before dawn.","Signal ghosts and failsafe exploits follow in your wake."],factionAdjustments:{resistance:15,corpsec:-10},startingEquipment:[{type:"catalog",definitionId:"misc_custom_deck"},{type:"catalog",definitionId:"misc_emp_charge"},{type:"catalog",definitionId:"armor_utility_hoodie",equip:!0},{type:"catalog",definitionId:"consumable_basic_repair_kit",quantity:1}]},{id:"wasteland_scavenger",name:"Wasteland Scavenger",tagline:"Dust lungs, steady hands, endless caches.",description:["You crossed toxic badlands with nothing but a crowbar and spite.","Trade routes and buried caches live in your head like lullabies."],factionAdjustments:{scavengers:10,resistance:5},startingEquipment:[{type:"catalog",definitionId:"weapon_industrial_crowbar",equip:!0},{type:"catalog",definitionId:"misc_gas_mask"},{type:"catalog",definitionId:"consumable_field_medkit",quantity:1},{type:"catalog",definitionId:"consumable_basic_repair_kit",quantity:1}]}],Jr=Object.fromEntries(Qr.map(e=>[e.id,e])),Ds={damageMultiplier:1,hitChanceBonus:0,critChanceBonus:0,magazineSizeMultiplier:1,silenced:!1},Gt=(e,t)=>e?(t??e.attachedMods??[]).reduce((s,n)=>{var a,r;try{const l=gt(n.modId).effect;l.damageMultiplier!==void 0&&(s.damageMultiplier*=l.damageMultiplier),l.hitChanceBonus!==void 0&&(s.hitChanceBonus+=l.hitChanceBonus),l.hitChancePenalty!==void 0&&(s.hitChanceBonus-=l.hitChancePenalty),l.critChanceBonus!==void 0&&(s.critChanceBonus+=l.critChanceBonus),l.magazineSizeMultiplier!==void 0&&(s.magazineSizeMultiplier*=l.magazineSizeMultiplier),l.armorPiercingFactor!==void 0&&(s.armorPiercingFactor=s.armorPiercingFactor!==void 0?Math.min(s.armorPiercingFactor,l.armorPiercingFactor):l.armorPiercingFactor),(l.silenced||(a=l.addTags)!=null&&a.includes("silenced"))&&(s.silenced=!0),(r=l.addTags)!=null&&r.includes("armorPiercing")&&(s.armorPiercingFactor=s.armorPiercingFactor??.5)}catch{}return s},{...Ds}):{...Ds},fp=(e,t,i)=>{if(!e)return{compatible:!1,reason:"Weapon not found"};if(!(e.modSlots??[]).includes(i))return{compatible:!1,reason:"This weapon has no matching slot."};const n=gt(t);if(n.slot!==i)return{compatible:!1,reason:"Mod slot mismatch."};const a=e.weaponType??"pistol";return n.compatibleWeaponTypes.includes(a)?{compatible:!0}:{compatible:!1,reason:"Not compatible with this weapon type."}},eo=(e,t)=>({id:se(),amount:e,reason:t}),to=(e,t,i,s)=>({newLevel:e,skillPointsEarned:t,attributePointsEarned:i,perksUnlocked:s}),ni=1e-4,io={normal:{movement:1,attack:1},heavy:{movement:1.25,attack:1.1,warning:"Pack weight is slowing you. You will bleed AP if you keep hauling this much."},overloaded:{movement:2,attack:1.25,warning:"Overloaded. Movement now chews double AP until you off-load gear."},immobile:{movement:Number.POSITIVE_INFINITY,attack:Number.POSITIVE_INFINITY,warning:"You are pinned by your gear. Drop items before you can move or fight."}},so=e=>!Number.isFinite(e)||Number.isNaN(e)?0:Math.max(0,Math.round(e*100)/100),no=e=>e>=120-ni?"immobile":e>=100-ni?"overloaded":e>=80-ni?"heavy":"normal",ao=(e,t,i)=>{const s=t<=0?1:t,n=e/s*100,a=so(n),r=no(a),o=io[r],l=o.warning??((i==null?void 0:i.level)===r?i==null?void 0:i.warning:void 0);return{level:r,percentage:a,movementApMultiplier:o.movement,attackApMultiplier:o.attack,warning:l}},ro=e=>e.level==="immobile"||e.movementApMultiplier===Number.POSITIVE_INFINITY,yp={sprintTile:2,strenuousInteraction:1},oo=3,lo=.3,co=.4,Ve=(e,t)=>!Number.isFinite(e)||!Number.isFinite(t)||t<=0||e<0?0:e>t?t:e,Gn=(e,t)=>!Number.isFinite(e)||!Number.isFinite(t)||t<=0?0:Math.max(0,Math.min(1,e/t)),uo=(e,t)=>Gn(e,t)<lo,ho=(e,t)=>Gn(e,t)>co,nt=(e,t)=>{var i;return((i=e==null?void 0:e.tags)==null?void 0:i.includes(t))??!1},ai=e=>nt(e,"twoHanded"),dt=2,Mi=()=>{const e={...Y,id:se(),position:{...Y.position},skills:{...Y.skills},skillTraining:{...Y.skillTraining},taggedSkillIds:[...Y.taggedSkillIds],inventory:{items:[],maxWeight:Y.inventory.maxWeight,currentWeight:0,hotbar:[null,null,null,null,null]},karma:Y.karma,personality:qt(),equipped:{weapon:void 0,armor:void 0,accessory:void 0,secondaryWeapon:void 0,meleeWeapon:void 0,bodyArmor:void 0,helmet:void 0,accessory1:void 0,accessory2:void 0},equippedSlots:{},activeWeaponSlot:"primaryWeapon",factionReputation:{...Y.factionReputation},perks:[...Y.perks],pendingPerkSelections:Y.pendingPerkSelections,backgroundId:void 0,appearancePreset:Y.appearancePreset,perkRuntime:{...Y.perkRuntime},encumbrance:{level:"normal",percentage:0,movementApMultiplier:1,attackApMultiplier:1}};return Oe(e),Ne(e),e},V={version:dt,data:Mi(),pendingLevelUpEvents:[],xpNotifications:[],pendingFactionEvents:[]},Te=e=>Math.max(1,Math.min(10,Math.round(e))),po=e=>Math.round(e*100)/100,Ai=5,mo=["primaryWeapon","secondaryWeapon","meleeWeapon","bodyArmor","helmet","accessory1","accessory2"],go=20,fo=e=>e.primaryDelta!==0||Object.values(e.rivalDeltas).some(t=>t!==0)||e.standingChanges.length>0,yo=(e,t)=>{e.pendingFactionEvents.push(t),e.pendingFactionEvents.length>go&&e.pendingFactionEvents.shift()},Ls=(e,t,i,s)=>{fo(i)&&yo(e,{factionId:t,delta:i.primaryDelta,updatedValue:e.data.factionReputation[t],rivalDeltas:i.rivalDeltas,standingChanges:i.standingChanges,reason:s==null?void 0:s.reason,source:s==null?void 0:s.source,timestamp:Date.now()})};function qe(e){if(!Number.isFinite(e.maxStamina)||e.maxStamina<=0){e.maxStamina=0,e.stamina=0,e.isExhausted=!1;return}if(e.stamina=Ve(e.stamina,e.maxStamina),uo(e.stamina,e.maxStamina)){e.isExhausted=!0;return}if(e.isExhausted&&ho(e.stamina,e.maxStamina)){e.isExhausted=!1;return}!e.isExhausted&&e.stamina>=e.maxStamina&&(e.isExhausted=!1)}function Re(e,t,i={}){const s=i.preserveRatio??!0,n=Number.isFinite(t)&&t>0?Math.floor(t):0,a=Number.isFinite(e.maxStamina)&&e.maxStamina>0?e.maxStamina:0;let r;if(!s||a===0||n===0)r=n;else{const o=Math.max(0,Math.min(1,Ve(e.stamina,a)/a));r=Math.floor(n*o)}e.maxStamina=n,e.stamina=n===0?0:Ve(r,n),qe(e)}function Oe(e){(!Number.isFinite(e.maxStamina)||e.maxStamina<0)&&(e.maxStamina=pe(e.skills.endurance)),Number.isFinite(e.stamina)?e.stamina=Ve(e.stamina,e.maxStamina):e.stamina=e.maxStamina,typeof e.isExhausted!="boolean"&&(e.isExhausted=!1),qe(e)}const es=e=>{const t=e?[...e]:[];for(;t.length<Ai;)t.push(null);return t.slice(0,Ai)},Qt=e=>{if(!e)return 0;if(!e.stackable)return 1;const t=e.quantity??1;return!Number.isFinite(t)||t<=0?1:Math.floor(t)},So=e=>typeof globalThis.structuredClone=="function"?globalThis.structuredClone(e):JSON.parse(JSON.stringify(e));function Ne(e){e.movementProfile!=="silent"&&e.movementProfile!=="sprint"&&(e.movementProfile="normal"),typeof e.stealthModeEnabled!="boolean"&&(e.stealthModeEnabled=!1),e.stealthCooldownExpiresAt!==null&&(!Number.isFinite(e.stealthCooldownExpiresAt)||e.stealthCooldownExpiresAt<0)&&(e.stealthCooldownExpiresAt=null)}const Vn=e=>e.damage!==void 0,zn=e=>e.protection!==void 0,vo=(e,t)=>{const i=new Set,s=[],n=(a,r)=>{if(!a||i.has(a.id)||!a.durability)return;const o=a.durability.max;if(!Number.isFinite(o)||o<=0)return;const l=a.durability.current;if(l>=o||t==="weapon"&&!Vn(a)||t==="armor"&&!zn(a))return;const c=l<=0?0:Math.max(0,Math.min(1,l/o));i.add(a.id),s.push({item:a,ratio:c,equipped:r})};return n(e.equipped.weapon,!0),n(e.equipped.secondaryWeapon,!0),n(e.equipped.meleeWeapon,!0),n(e.equipped.bodyArmor,!0),n(e.equipped.helmet,!0),e.equippedSlots&&Object.values(e.equippedSlots).forEach(a=>n(a,!0)),e.inventory.items.forEach(a=>n(a,!1)),s},bo=(e,t)=>{var s;const i=vo(e,t);return i.length===0?null:(i.sort((n,a)=>n.ratio!==a.ratio?n.ratio-a.ratio:n.equipped!==a.equipped?n.equipped?-1:1:0),((s=i[0])==null?void 0:s.item.id)??null)},wo=e=>{if(e.equipSlot)return e.equipSlot;const t=e;return(Number.isFinite(t.range)?t.range:0)<=1||t.skillType==="meleeCombat"?"meleeWeapon":"primaryWeapon"},le=(e,t)=>{if(!e)return e;const i={...e};if(Vn(i)){const s=i.durability,n=Number.isFinite(s==null?void 0:s.max)&&((s==null?void 0:s.max)??0)>0?Math.round(s.max):100,a=Number.isFinite(s==null?void 0:s.current)?Math.max(0,Math.round(s.current)):n;i.durability={max:n,current:Math.min(n,a)},i.equipSlot=t??wo(i)}else if(zn(i)){const s=i.durability,n=Number.isFinite(s==null?void 0:s.max)&&((s==null?void 0:s.max)??0)>0?Math.round(s.max):120,a=Number.isFinite(s==null?void 0:s.current)?Math.max(0,Math.round(s.current)):n;i.durability={max:n,current:Math.min(n,a)},i.equipSlot=t??"bodyArmor"}else t&&(i.equipSlot=t);if(i.stackable){const s=Qt(i)||1;i.quantity=s,(!Number.isFinite(i.maxStack)||i.maxStack===void 0||i.maxStack<=0)&&(i.maxStack=Math.max(5,s))}else delete i.quantity,delete i.maxStack;return Number.isFinite(i.weight)||(i.weight=0),Number.isFinite(i.value)||(i.value=0),i},Po=e=>{const t=e.reduce((i,s)=>{const n=Number.isFinite(s.weight)?s.weight:0;return i+n*Qt(s)},0);return po(t)},ie=e=>{e.inventory.items=e.inventory.items.map(s=>le(s)??s);const t=Po(e.inventory.items),i=es(e.inventory.hotbar);e.inventory={...e.inventory,currentWeight:t,hotbar:i},e.encumbrance=ao(e.inventory.currentWeight,e.inventory.maxWeight,e.encumbrance)},Mo=(e,t)=>e.inventory.items.reduce((i,s)=>{if(s.definitionId!==t)return i;const n=s.stackable?s.quantity??1:1;return i+n},0),Ao=(e,t,i)=>{if(i<=0)return!0;let s=i;return e.inventory.items=e.inventory.items.reduce((n,a)=>{if(s<=0||a.definitionId!==t)return n.push(a),n;if(a.stackable){const r=a.quantity??1;return r>s?(n.push({...a,quantity:r-s}),s=0):s-=r,n}return s-=1,s<0&&(s=0),n},[]),ie(e),s===0},Io=(e,t)=>{if(t.find(s=>Mo(e,s.id)<s.quantity))return!1;for(const s of t)if(!Ao(e,s.id,s.quantity))return!1;return!0},ts=(e,t)=>{const i=e.inventory.items.findIndex(n=>n.id===t);if(i===-1)return;const[s]=e.inventory.items.splice(i,1);return s},Un=(e,t)=>t||(e.equipSlot?e.equipSlot:"damage"in e?"primaryWeapon":"protection"in e?"bodyArmor":null),Vt=e=>e.modSlots?e.modSlots:(e.weaponType??"pistol")==="melee"?[]:["barrel","magazine","optics"],Kn=e=>{const t=e.magazineSize??0;if(t<=0)return e;const i=Gt(e),s=Math.max(1,Math.round(t*(i.magazineSizeMultiplier??1))),n=e.currentMagazine??s;return{...e,currentMagazine:Math.max(0,Math.min(s,n))}},xo=(e,t)=>{const i=[...e.attachedMods??[]],s=i.findIndex(a=>a.slot===t);if(s===-1)return{updated:{...e,modSlots:Vt(e)}};const[n]=i.splice(s,1);return{updated:{...e,attachedMods:i,modSlots:Vt(e),currentMagazine:Kn(e).currentMagazine},detachedModId:n.modId}},Co=(e,t)=>{const i=gt(t),s=Vt(e),n=[...e.attachedMods??[]],a=n.findIndex(o=>o.slot===i.slot);let r;return a!==-1&&(r=n[a].modId,n.splice(a,1)),n.push({slot:i.slot,modId:t}),{updated:{...e,attachedMods:n,modSlots:s,currentMagazine:Kn(e).currentMagazine},replacedModId:r}},ko=(e,t)=>{var l;const i=gt(t.modId),s=t.feePaid??0;if(i.crafting.station==="workbench"&&!t.atWorkbench||s>0&&e.credits<s)return!1;const n=((l=e.skillTraining)==null?void 0:l.engineering)??0;if(!Number.isFinite(n)||n<i.crafting.level)return!1;const a=i.crafting.inputs.map(c=>({id:c.id,quantity:c.quantity}));if(!Io(e,a))return!1;s>0&&(e.credits-=s);const o=Yt(t.modId);return e.inventory.items.push(o),ie(e),!0},Pe=(e,t,i)=>{switch(t){case"primaryWeapon":e.equipped.weapon=i;break;case"secondaryWeapon":e.equipped.secondaryWeapon=i;break;case"meleeWeapon":e.equipped.meleeWeapon=i;break;case"bodyArmor":e.equipped.bodyArmor=i,e.equipped.armor=i;break;case"helmet":e.equipped.helmet=i;break;case"accessory1":e.equipped.accessory1=i;break;case"accessory2":e.equipped.accessory2=i;break}e.equippedSlots||(e.equippedSlots={}),i?e.equippedSlots[t]=i:e.equippedSlots&&delete e.equippedSlots[t]},lt=(e,t)=>{if(e.equippedSlots&&e.equippedSlots[t])return e.equippedSlots[t];switch(t){case"primaryWeapon":return e.equipped.weapon;case"secondaryWeapon":return e.equipped.secondaryWeapon;case"meleeWeapon":return e.equipped.meleeWeapon;case"bodyArmor":return e.equipped.bodyArmor??e.equipped.armor;case"helmet":return e.equipped.helmet;case"accessory1":return e.equipped.accessory1;case"accessory2":return e.equipped.accessory2;default:return}},zt=e=>{const t={...e},i=e;return Array.isArray(i.attachedMods)&&(t.attachedMods=[...i.attachedMods]),t},St=(e,t)=>{const i=e.inventory.items.findIndex(s=>s.id===t);if(i!==-1)return{location:"inventory",item:e.inventory.items[i],index:i};for(const s of mo){const n=lt(e,s);if(n&&n.id===t)return{location:"equipped",item:n,slot:s}}},jn=(e,t,i)=>{if(t.location==="inventory"){e.inventory.items[t.index]=i;return}Pe(e,t.slot,i),e.equippedSlots&&(e.equippedSlots[t.slot]=i)},ri=(e,t)=>{const{itemId:i,slot:s}=t,n=e.inventory.items.find(c=>c.id===i);if(!n||n.isQuestItem||n.stackable||n.durability&&n.durability.current<=0)return!1;const a=Un(n,s);if(!a)return!1;const r="damage"in n?n:void 0;if(a==="secondaryWeapon"){if(r&&ai(r))return!1;const c=lt(e,"primaryWeapon");if(ai(c))return!1}const o=ts(e,i);if(!o)return!1;const l=lt(e,a);if(l&&e.inventory.items.push(zt(l)),a==="primaryWeapon"&&"damage"in o&&ai(o)){const c=lt(e,"secondaryWeapon");c&&(e.inventory.items.push(zt(c)),Pe(e,"secondaryWeapon",void 0),e.activeWeaponSlot==="secondaryWeapon"&&(e.activeWeaponSlot="primaryWeapon"))}return Pe(e,a,o),(a==="primaryWeapon"||a==="secondaryWeapon"||a==="meleeWeapon")&&(e.activeWeaponSlot=a),ie(e),!0},oi=(e,t)=>{const{slot:i}=t,s=lt(e,i);return s?(e.inventory.items.push(zt(s)),Pe(e,i,void 0),i===e.activeWeaponSlot&&(e.activeWeaponSlot="primaryWeapon"),ie(e),!0):!1},$n=(e,t)=>{const{itemId:i,amount:s}=t;if(!Number.isFinite(s)||s<=0)return!1;const n=St(e,i);if(!n||!n.item.durability)return!1;const a=Math.floor(s),r=n.item.durability;return r.current=Math.min(r.max,r.current+a),n.location==="equipped"&&Pe(e,n.slot,n.item),!0},To=(e,t)=>{const{itemId:i,quantity:s}=t;if(!Number.isFinite(s)||s<=0)return;const n=St(e,i);if(!n||n.location!=="inventory")return;const a=n.item;if(!a.stackable)return;const r=Qt(a),o=Math.floor(s);if(o>=r)return;const l=zt(a);l.id=se(),l.quantity=o;const c=r-o;return a.quantity=c<=1?void 0:c,a.quantity===void 0&&delete a.quantity,e.inventory.items.push(l),ie(e),l},Ro=(e,t)=>{const{slotIndex:i,itemId:s}=t;if(!Number.isInteger(i)||i<0||i>=Ai)return!1;if(e.inventory.hotbar=es(e.inventory.hotbar),s!==null){const n=St(e,s);if(!n||n.location!=="inventory")return!1;e.inventory.hotbar=e.inventory.hotbar.map((a,r)=>a===s&&r!==i?null:a),e.inventory.hotbar[i]=s}else e.inventory.hotbar[i]=null;return!0},Eo=(e,t)=>{const{weaponId:i,modItemId:s}=t,n=St(e,i);if(!n||!("damage"in n.item))return!1;const a=n.item,r=e.inventory.items.find(p=>p.id===s&&p.weaponModId);if(!r||!r.weaponModId)return!1;const o=r.weaponModId,l=gt(o),c=a.weaponType??"pistol";if(!Vt(a).includes(l.slot)||!l.compatibleWeaponTypes.includes(c)||!ts(e,s))return!1;const{updated:h,replacedModId:g}=Co(a,o);return g&&e.inventory.items.push(Yt(g)),jn(e,n,h),ie(e),!0},_o=(e,t)=>{const{weaponId:i,slot:s}=t,n=St(e,i);if(!n||!("damage"in n.item))return!1;const a=n.item,{updated:r,detachedModId:o}=xo(a,s);return o?(e.inventory.items.push(Yt(o)),jn(e,n,r),ie(e),!0):!1},Do=(e,t)=>{e.inventory.hotbar=es(e.inventory.hotbar);const i=e.inventory.items.findIndex(c=>c.id===t);if(i===-1)return!1;const s=e.inventory.items[i];if(!s||!("effect"in s))return!1;const n=s,a=n.effect;let r=null,o=0;if(a.type==="repair"&&(o=Math.floor(a.value??0),o<=0||(r=bo(e,a.target??"any"),!r)))return!1;let l=!1;if(s.stackable){const c=Qt(s);if(c<=1)e.inventory.items.splice(i,1),l=!0;else{const d=c-1;d<=1?delete n.quantity:n.quantity=d}}else e.inventory.items.splice(i,1),l=!0;switch(l&&(e.inventory.hotbar=e.inventory.hotbar.map(c=>c===t?null:c)),a.type){case"health":{const c=Number.isFinite(a.value)?a.value:0;e.health=Math.min(e.maxHealth,Math.max(0,e.health+c));break}case"actionPoints":{const c=Number.isFinite(a.value)?a.value:0;e.actionPoints=Math.min(e.maxActionPoints,Math.max(0,e.actionPoints+c));break}case"stat":{if(a.statAffected){const c=e.skills[a.statAffected]??0,d=Number.isFinite(a.value)?a.value:0;e.skills[a.statAffected]=c+d}break}case"repair":{r&&$n(e,{itemId:r,amount:o});break}}return ie(e),!0},Lo=(e,t)=>{switch(t.type){case"catalog":{const i=Yt(t.definitionId,{quantity:t.quantity,durability:t.durability});if(t.equip){const s=Un(i);if(s){Pe(e,s,i),(s==="primaryWeapon"||s==="secondaryWeapon"||s==="meleeWeapon")&&(e.activeWeaponSlot=s);break}}e.inventory.items.push(i);break}case"weapon":{const i=Xa(t.name,t.damage,t.range,t.apCost,t.weight,t.statModifiers,t.skillType);t.equip?Pe(e,"primaryWeapon",i):e.inventory.items.push(i);break}case"armor":{const i=Za(t.name,t.protection,t.weight,t.statModifiers);t.equip?Pe(e,"bodyArmor",i):e.inventory.items.push(i);break}case"consumable":{const i=Ya(t.name,t.effectType,t.value,{statAffected:t.statAffected,weight:t.weight,target:t.target,stackable:t.stackable,maxStack:t.maxStack,quantity:t.quantity});e.inventory.items.push(i);break}case"item":{const i={id:se(),name:t.name,description:t.description,weight:t.weight,value:Math.max(10,Math.round(t.weight*15)),isQuestItem:!!t.isQuestItem};e.inventory.items.push(i);break}}ie(e)},Yn=Q({name:"player",initialState:V,reducers:{initializeCharacter:(e,t)=>{const{name:i,skills:s,backgroundId:n,visualPreset:a}=t.payload,r={strength:Te(s.strength),perception:Te(s.perception),endurance:Te(s.endurance),charisma:Te(s.charisma),intelligence:Te(s.intelligence),agility:Te(s.agility),luck:Te(s.luck)},o=Qi(r),l=Jr[n],c=Mi();c.name=i,c.appearancePreset=a,c.skills=r,c.maxHealth=o.maxHP,c.health=o.maxHP,c.maxActionPoints=o.baseAP,c.actionPoints=o.baseAP,c.maxStamina=o.maxStamina,c.stamina=o.maxStamina,c.isExhausted=!1,qe(c),c.inventory={items:[],maxWeight:o.carryWeight,currentWeight:0,hotbar:[null,null,null,null,null]},c.equipped={weapon:void 0,armor:void 0,accessory:void 0,secondaryWeapon:void 0,meleeWeapon:void 0,bodyArmor:void 0,helmet:void 0,accessory1:void 0,accessory2:void 0},c.equippedSlots={},c.activeWeaponSlot="primaryWeapon",c.perks=[],c.pendingPerkSelections=0,c.backgroundId=n,c.factionReputation={resistance:0,corpsec:0,scavengers:0},c.perkRuntime={gunFuShotsThisTurn:0,adrenalineRushTurnsRemaining:0,ghostInvisibilityTurns:0,ghostConsumed:!1},l&&(l.perk&&c.perks.push(l.perk.id),Object.entries(l.factionAdjustments).forEach(([d,u])=>{const h=d,g=u??0,p=c.factionReputation[h]??0;c.factionReputation[h]=te(p+g)}),l.startingEquipment.forEach(d=>Lo(c,d))),e.data=c,e.data.encumbrance={level:"normal",percentage:0,movementApMultiplier:1,attackApMultiplier:1}},adjustFactionReputation:(e,t)=>{const{factionId:i,delta:s,reason:n,source:a}=t.payload;if(!Number.isFinite(s)||s===0)return;const r=qn(e.data.factionReputation,i,s);e.data.factionReputation={...r.values},Ls(e,i,r,{reason:n,source:a})},setFactionReputation:(e,t)=>{const{factionId:i,value:s,reason:n,source:a}=t.payload,r=qr(e.data.factionReputation,i,s);e.data.factionReputation={...r.values},Ls(e,i,r,{reason:n,source:a})},consumeFactionReputationEvents:e=>{e.pendingFactionEvents=[]},adjustPersonalityTrait:(e,t)=>{const{trait:i,delta:s,source:n}=t.payload;e.data.personality||(e.data.personality=qt());const a={...e.data.personality.flags},r=a[i]??0,o=Math.max(-5,Math.min(5,r+s));a[i]=o,e.data.personality={...e.data.personality,flags:a,lastUpdated:Date.now(),lastChangeSource:n??"storylet"}},movePlayer:(e,t)=>{if(e.data.encumbrance.level==="immobile")return;const i=e.data.position;if(e.data.position=t.payload,i){const s=t.payload.x-i.x,n=t.payload.y-i.y;(s!==0||n!==0)&&(Math.abs(s)>=Math.abs(n)?e.data.facing=s>=0?"east":"west":e.data.facing=n>=0?"south":"north")}e.data.coverOrientation=null,e.data.suppression=e.data.suppression??0},updateHealth:(e,t)=>{e.data.health=Math.max(0,Math.min(e.data.maxHealth,e.data.health+t.payload)),ii(e.data)&&(e.data=si(e.data))},setHealth:(e,t)=>{e.data.health=Math.max(0,Math.min(e.data.maxHealth,t.payload)),ii(e.data)&&(e.data=si(e.data))},updateActionPoints:(e,t)=>{e.data.actionPoints=Math.max(0,Math.min(e.data.maxActionPoints,e.data.actionPoints+t.payload))},resetActionPoints:e=>{e.data.actionPoints=e.data.maxActionPoints},consumeStamina:(e,t)=>{Oe(e.data),Ne(e.data);const i=t.payload;if(!Number.isFinite(i)||i<=0)return;const s=Math.max(0,Math.floor(i));e.data.stamina=Ve(e.data.stamina-s,e.data.maxStamina),qe(e.data)},regenerateStamina:(e,t)=>{Oe(e.data),Ne(e.data);const i=t.payload??oo;if(!Number.isFinite(i)||i<=0){qe(e.data);return}const s=Math.max(0,Math.floor(i));e.data.stamina=Ve(e.data.stamina+s,e.data.maxStamina),qe(e.data)},updateMaxStamina:e=>{Oe(e.data),Ne(e.data);const t=pe(e.data.skills.endurance);Re(e.data,t,{preserveRatio:!0})},addExperience:(e,t)=>{const i=typeof t.payload=="number"?{amount:t.payload}:t.payload,s=i.amount;if(!Number.isFinite(s)||s===0)return;e.data=Xr(e.data,s);const n=Zr(e.data);if(e.data=n.player,Oe(e.data),Ne(e.data),n.skillPointsAwarded>0&&(e.data.skillPoints+=n.skillPointsAwarded),n.attributePointsAwarded>0&&(e.data.attributePoints+=n.attributePointsAwarded),n.perksUnlocked>0&&(e.data.pendingPerkSelections+=n.perksUnlocked),n.levelsGained>0&&(e.pendingLevelUpEvents.push(to(e.data.level,n.skillPointsAwarded,n.attributePointsAwarded,n.perksUnlocked)),Re(e.data,pe(e.data.skills.endurance),{preserveRatio:!1})),s>0){const a=i.reason??"Experience gained",r=e.xpNotifications??[];e.xpNotifications=[...r,eo(s,a)]}},addCredits:(e,t)=>{e.data.credits=Math.max(0,e.data.credits+t.payload)},setKarma:(e,t)=>{const i=Math.max(-1e3,Math.min(1e3,t.payload));e.data.karma=i,e.data.personality.lastUpdated=Date.now(),e.data.personality.lastChangeSource="karma:set"},adjustKarma:(e,t)=>{const i=Math.max(-1e3,Math.min(1e3,e.data.karma+t.payload));e.data.karma=i,e.data.personality.lastUpdated=Date.now(),e.data.personality.lastChangeSource="karma:adjust"},removeXPNotification:(e,t)=>{const i=e.xpNotifications??[];e.xpNotifications=i.filter(s=>s.id!==t.payload)},levelUp:e=>{e.data.level+=1,e.data.maxHealth+=10,e.data.health=e.data.maxHealth,e.data.maxActionPoints+=1,e.data.actionPoints=e.data.maxActionPoints;const t=pe(e.data.skills.endurance);Re(e.data,t,{preserveRatio:!1})},updateSkill:(e,t)=>{const{skill:i,amount:s}=t.payload;e.data.skills[i]=Math.max(1,Math.min(10,e.data.skills[i]+s));const n=e.data.skills,a=tt(n.endurance),r=it(n.agility),o=st(n.strength),l=pe(n.endurance),c=Number.isFinite(e.data.health)?e.data.health:0,d=Number.isFinite(e.data.maxHealth)&&e.data.maxHealth>0?e.data.maxHealth:1,u=c/d;e.data.maxHealth=a;const h=Math.floor(a*u);e.data.health=Math.max(0,Math.min(Number.isFinite(h)?h:a,a)),e.data.maxActionPoints=r,e.data.actionPoints=Math.min(e.data.actionPoints,r),e.data.inventory.maxWeight=o,Re(e.data,l,{preserveRatio:!0})},setSkill:(e,t)=>{const{skill:i,value:s}=t.payload;e.data.skills[i]=Math.max(1,Math.min(10,s));const n=e.data.skills;e.data.maxHealth=tt(n.endurance),e.data.health=e.data.maxHealth,e.data.maxActionPoints=it(n.agility),e.data.actionPoints=e.data.maxActionPoints,e.data.inventory.maxWeight=st(n.strength),Re(e.data,pe(n.endurance),{preserveRatio:!1})},addItem:(e,t)=>{e.data.inventory.items.push(t.payload),ie(e.data)},removeItem:(e,t)=>{const i=t.payload;ts(e.data,i)&&ie(e.data)},resetPlayer:e=>{e.version=dt,e.data=Mi(),e.pendingLevelUpEvents=[],e.xpNotifications=[],e.pendingFactionEvents=[]},setPlayerData:(e,t)=>{const i=So(t.payload);if(e.version=dt,e.data=i,e.data.factionReputation||(e.data.factionReputation={...Y.factionReputation}),["resistance","corpsec","scavengers"].forEach(n=>{const a=Y.factionReputation[n]??0,r=e.data.factionReputation[n];e.data.factionReputation[n]=te(typeof r=="number"?r:a)}),e.pendingFactionEvents=[],e.data.perkRuntime||(e.data.perkRuntime={gunFuShotsThisTurn:0,adrenalineRushTurnsRemaining:0,ghostInvisibilityTurns:0,ghostConsumed:!1}),e.data.inventory.hotbar||(e.data.inventory.hotbar=[null,null,null,null,null]),e.data.equipped?e.data.equipped={...e.data.equipped}:e.data.equipped={},e.data.equippedSlots||(e.data.equippedSlots={}),e.data.activeWeaponSlot||(e.data.activeWeaponSlot="primaryWeapon"),e.data.encumbrance||(e.data.encumbrance={level:"normal",percentage:0,movementApMultiplier:1,attackApMultiplier:1}),!e.data.personality)e.data.personality=qt();else{const n=e.data.personality.flags??{};e.data.personality={...e.data.personality,flags:{earnest:n.earnest??0,sarcastic:n.sarcastic??0,ruthless:n.ruthless??0,stoic:n.stoic??0},lastUpdated:e.data.personality.lastUpdated??0}}e.data.inventory.items=e.data.inventory.items.map(n=>le(n)??n),e.data.equipped.weapon=le(e.data.equipped.weapon,"primaryWeapon"),e.data.equipped.secondaryWeapon=le(e.data.equipped.secondaryWeapon,"secondaryWeapon"),e.data.equipped.meleeWeapon=le(e.data.equipped.meleeWeapon,"meleeWeapon"),e.data.equipped.bodyArmor=le(e.data.equipped.bodyArmor,"bodyArmor"),e.data.equipped.helmet=le(e.data.equipped.helmet,"helmet"),e.data.equipped.accessory1=le(e.data.equipped.accessory1,"accessory1"),e.data.equipped.accessory2=le(e.data.equipped.accessory2,"accessory2");const s=e.data.equippedSlots??{};e.data.equippedSlots=s,Object.entries(s).forEach(([n,a])=>{if(!a)return;const r=le(a,n);s[n]=r}),Oe(e.data),Ne(e.data),ie(e.data),ii(e.data)&&(e.data=si(e.data))},setMovementProfile:(e,t)=>{e.data.movementProfile=t.payload},setStealthState:(e,t)=>{e.data.stealthModeEnabled=t.payload.enabled,"cooldownExpiresAt"in t.payload&&(e.data.stealthCooldownExpiresAt=t.payload.cooldownExpiresAt??null)},equipItem:(e,t)=>{ri(e.data,t.payload)},unequipItem:(e,t)=>{oi(e.data,t.payload)},repairItem:(e,t)=>{$n(e.data,t.payload)},splitStack:(e,t)=>{To(e.data,t.payload)},assignHotbarSlot:(e,t)=>{Ro(e.data,t.payload),ie(e.data)},attachWeaponMod:(e,t)=>{Eo(e.data,t.payload)},detachWeaponMod:(e,t)=>{_o(e.data,t.payload)},craftWeaponMod:(e,t)=>{ko(e.data,t.payload)},useInventoryItem:(e,t)=>{Do(e.data,t.payload)},equipWeapon:(e,t)=>{ri(e.data,{itemId:t.payload,slot:"primaryWeapon"})},equipArmor:(e,t)=>{ri(e.data,{itemId:t.payload,slot:"bodyArmor"})},unequipWeapon:e=>{oi(e.data,{slot:"primaryWeapon"})},unequipArmor:e=>{oi(e.data,{slot:"bodyArmor"})},consumeLevelUpEvent:e=>{e.pendingLevelUpEvents.shift()},clearPendingPerkSelections:e=>{e.data.pendingPerkSelections=0},selectPerk:(e,t)=>{const i=t.payload;if(e.data.pendingPerkSelections<=0||e.data.perks.includes(i))return;const s=ja(i);if($a(e.data,s).canSelect)switch(e.data.perks.push(i),e.data.pendingPerkSelections=Math.max(0,e.data.pendingPerkSelections-1),i){case"gunFu":e.data.perkRuntime.gunFuShotsThisTurn=0;break;case"adrenalineRush":e.data.perkRuntime.adrenalineRushTurnsRemaining=0;break;case"ghost":e.data.perkRuntime.ghostConsumed=!1,e.data.perkRuntime.ghostInvisibilityTurns=0;break}},beginPlayerTurn:e=>{e.data=Ar(e.data),e.data.perkRuntime.adrenalineRushTurnsRemaining>0&&(e.data=Ir(e.data)),e.data.perkRuntime.ghostInvisibilityTurns>0&&(e.data=xr(e.data))},spendSkillPoints:(e,t)=>{const i=t.payload;e.data.skillPoints>=i&&i>0&&(e.data.skillPoints-=i)},allocateSkillPointToSkill:(e,t)=>{const i=t.payload;if(e.data.skillPoints<=0)return;const s=Pi(i),n=e.data.skillTraining[i]??0,r=e.data.taggedSkillIds.includes(i)?s.taggedIncrement:s.increment;n>=s.maxValue||n+r>s.maxValue||(e.data.skillTraining[i]=n+r,e.data.skillPoints-=1)},refundSkillPointFromSkill:(e,t)=>{const i=t.payload,s=Pi(i),n=e.data.skillTraining[i]??0;if(n<=0)return;const r=e.data.taggedSkillIds.includes(i)?s.taggedIncrement:s.increment,o=n-r;o<0||(e.data.skillTraining[i]=o,e.data.skillPoints+=1)},spendAttributePoint:(e,t)=>{const i=t.payload;if(e.data.attributePoints<=0||e.data.skills[i]>=10)return;e.data.attributePoints-=1,e.data.skills[i]+=1;const s=e.data.skills,n=tt(s.endurance),a=it(s.agility),r=st(s.strength),o=pe(s.endurance),l=Number.isFinite(e.data.health)?e.data.health:0,c=Number.isFinite(e.data.maxHealth)&&e.data.maxHealth>0?e.data.maxHealth:1,d=l/c;e.data.maxHealth=n;const u=Math.floor(n*d);e.data.health=Math.max(0,Math.min(Number.isFinite(u)?u:n,n)),e.data.maxActionPoints=a,e.data.actionPoints=Math.min(e.data.actionPoints,a),e.data.inventory.maxWeight=r,Re(e.data,o,{preserveRatio:!0})},refundAttributePoint:(e,t)=>{const i=t.payload;if(e.data.skills[i]<=1)return;e.data.attributePoints+=1,e.data.skills[i]-=1;const n=e.data.skills,a=tt(n.endurance),r=it(n.agility),o=st(n.strength),l=pe(n.endurance),c=Number.isFinite(e.data.health)?e.data.health:0,d=Number.isFinite(e.data.maxHealth)&&e.data.maxHealth>0?e.data.maxHealth:1,u=c/d;e.data.maxHealth=a;const h=Math.floor(a*u);e.data.health=Math.max(0,Math.min(Number.isFinite(h)?h:a,a)),e.data.maxActionPoints=r,e.data.actionPoints=Math.min(e.data.actionPoints,r),e.data.inventory.maxWeight=o,Re(e.data,l,{preserveRatio:!0})}}}),{initializeCharacter:Sp,movePlayer:Fo,updateHealth:Bo,setHealth:vp,updateActionPoints:Fs,resetActionPoints:bp,consumeStamina:wp,regenerateStamina:Pp,updateMaxStamina:Mp,addExperience:Ap,addCredits:Ip,setKarma:xp,adjustKarma:Cp,adjustFactionReputation:Oo,setFactionReputation:kp,consumeFactionReputationEvents:Tp,adjustPersonalityTrait:No,removeXPNotification:Rp,levelUp:Ep,updateSkill:_p,setSkill:Dp,addItem:Lp,removeItem:Fp,equipItem:Bp,unequipItem:Op,repairItem:Np,splitStack:Hp,assignHotbarSlot:Wp,attachWeaponMod:qp,detachWeaponMod:Gp,craftWeaponMod:Vp,useInventoryItem:zp,resetPlayer:Up,setPlayerData:Ho,setMovementProfile:Kp,setStealthState:jp,equipWeapon:$p,equipArmor:Yp,unequipWeapon:Zp,unequipArmor:Xp,consumeLevelUpEvent:Qp,clearPendingPerkSelections:Jp,selectPerk:em,beginPlayerTurn:tm,spendSkillPoints:im,spendAttributePoint:sm,refundAttributePoint:nm,allocateSkillPointToSkill:am,refundSkillPointFromSkill:rm}=Yn.actions,Wo=Yn.reducer,ct="corpsec-sentinel",H=e=>({kind:"lineOfSight",state:"chase",weight:0,...e}),qo=[H({kind:"lineOfSight",state:"attack",weight:3}),H({kind:"lineOfSight",state:"chase",weight:2}),H({kind:"lostLineOfSight",state:"search",weight:2}),H({kind:"healthBelow",state:"flee",threshold:.35,weight:3}),H({kind:"suppressionAbove",state:"panic",threshold:.6,weight:2}),H({kind:"alertAtLeast",state:"attack",alert:B.INVESTIGATING,weight:1.5}),H({kind:"alertBelow",state:"patrol",alert:B.SUSPICIOUS,weight:1}),H({kind:"distanceBelow",state:"attack",tiles:2,weight:2.5}),H({kind:"distanceAbove",state:"patrol",tiles:8,weight:1.2}),{kind:"healthBelow",state:"attack",threshold:.4,weight:-3},{kind:"healthBelow",state:"chase",threshold:.4,weight:-3},{kind:"healthBelow",state:"panic",threshold:.35,weight:2}],Go=[H({kind:"lineOfSight",state:"attack",weight:4}),H({kind:"lineOfSight",state:"chase",weight:3}),H({kind:"lostLineOfSight",state:"search",weight:1.5}),H({kind:"healthBelow",state:"panic",threshold:.25,weight:2}),H({kind:"suppressionAbove",state:"flee",threshold:.8,weight:2}),H({kind:"alertAtLeast",state:"attack",alert:B.ALARMED,weight:2}),H({kind:"directorAtLeast",state:"panic",threshold:.8,weight:1.5})],Vo=[H({kind:"lineOfSight",state:"chase",weight:1.5}),H({kind:"lostLineOfSight",state:"search",weight:3}),H({kind:"healthBelow",state:"flee",threshold:.5,weight:3}),H({kind:"alertBelow",state:"patrol",alert:B.SUSPICIOUS,weight:2}),H({kind:"distanceAbove",state:"patrol",tiles:6,weight:1.5}),H({kind:"distanceBelow",state:"inspectNoise",tiles:4,weight:1.2})],li=(e,t)=>({id:e,initialState:"patrol",baseWeights:{idle:.5,patrol:3,chase:1,search:1,attack:.5,inspectNoise:.5,flee:.2,panic:.1},cooldowns:{panic:12e3,flee:8e3,inspectNoise:2e3},minimumSelectableWeight:.05,...t}),Ii={[ct]:{id:ct,label:"CorpSec Sentinel",description:"Baseline guard tuned for perimeter patrols; favours holding ground until line of sight is confirmed.",fsm:li(ct,{baseWeights:{idle:.6,patrol:3.5,chase:.3,search:.9,attack:.9,inspectNoise:.6,flee:.4,panic:.2},utilityModifiers:qo})},"corpsec-enforcer":{id:"corpsec-enforcer",label:"CorpSec Enforcer",description:"Aggressive shock troops that lean into panic suppression and rapid response.",fsm:li("corpsec-enforcer",{initialState:"patrol",baseWeights:{idle:.2,patrol:2.5,chase:1.5,search:.6,attack:1.2,inspectNoise:.4,flee:.2,panic:.4},utilityModifiers:Go,cooldowns:{panic:1e4,flee:6e3,inspectNoise:1500}})},"corpsec-watchman":{id:"corpsec-watchman",label:"CorpSec Watchman",description:"Cautious sentry who prioritises searching and calling in reinforcements.",fsm:li("corpsec-watchman",{baseWeights:{idle:1,patrol:2.5,chase:.6,search:1.4,attack:.5,inspectNoise:.8,flee:.5,panic:.2},utilityModifiers:Vo,cooldowns:{panic:12e3,flee:9e3,inspectNoise:2500}})}},zo=e=>Ii[e],Bs={zoneId:"unknown_zone",name:"Unknown Sector",level:0,danger:"low",hazards:[],objectives:[],summary:"No reconnaissance available for this zone."},Os={downtown_checkpoint:{zoneId:"downtown_checkpoint",name:"Slums Command Grid",level:0,danger:"moderate",hazards:["CorpSec curfew sweeps after sundown","Autonomous patrol drones scanning alleys","Tight choke points with improvised barricades"],objectives:["Recover Lira's contraband cache from the downtown evidence lockers.","Decrypt the surveillance manifests Archivist Naila smuggled out.","Re-establish Brant's courier drop routes across the grid before curfew.","Black out the CorpSec camera grid guarding the barricades.","Map patrol drone loops and assign safe counter-routes.","Restock Medic Yara's rebel clinic with field medkits.","Ambush the transit patrol escorting the sweep captain."],summary:"Primary resistance staging ground on the edge of Downtown. Expect constant patrol loops and rapid curfew escalations once alarms trip."},gov_complex:{zoneId:"gov_complex",name:"Downtown Governance Ring",level:1,danger:"high",hazards:["Omnidirectional camera grids with rapid resync pulses","CorpSec riot squads supported by shield drones","Encrypted checkpoints requiring forged credentials"],objectives:["Breaching the executive archives for blackmail dossiers","Subverting curfew order terminals","Exfiltrating detained resistance couriers"],summary:"Corporate command nerve centre governing the city core. Security density spikes during curfew and when alert level rises above Suspicious."},corporate_plaza:{zoneId:"corporate_plaza",name:"Skyline Transit Spire",level:1,danger:"moderate",hazards:["Precision sniper nests covering rooftop routes","Kinetic response teams dispatched via mag-rails","Marketing holo projectors causing navigation glare"],objectives:["Sabotage skyline transit relays to halt corporate reinforcements","Secure encrypted comm relays for resistance broadcasts","Extract high-value defectors under corporate escort"],summary:"Vertical plaza bridging transit hubs and corporate towers. Movement is exposed but offers vantage points if you neutralise overwatch nests."},industrial_corridor:{zoneId:"industrial_corridor",name:"Industrial Wasteland",level:2,danger:"critical",hazards:["Toxic smog plumes reducing visibility and draining health","Open radiation pockets around collapsed reactors","Unstable power conduits causing electrical surges","Hostile scavenger clans with improvised explosives"],objectives:["Stabilise the resistance refinery outpost","Disrupt CorpSec convoy routes feeding the upper city","Recover prototype filtration tech before corp retrieval teams arrive"],summary:"Decommissioned industrial belt now weaponised by corp security. Navigation requires filtration gear and constant hazard monitoring."},resistance_safehouse:{zoneId:"resistance_safehouse",name:"Resistance Safehouse Network",level:0,danger:"low",hazards:["Tight corridors with limited firing lanes"],objectives:["Resupply from hidden caches","Brief with cell leadership for mission intel","Coordinate evac routes ahead of major operations"],summary:"Hidden safehouse offering respite between sorties. Minimal patrol risk but expect limited mobility and quick extraction drills."}},Uo=e=>e.includes("::")?e.split("::")[0]??e:e,Zn=e=>{if(!e)return Bs;const t=Os[e];if(t)return t;const i=Os[Uo(e)];return i||{...Bs,zoneId:e}},Ko={performance:{maxDecorPropsPerBuilding:2,maxAmbientGlows:12,enableAnimatedHazards:!1,enableHighDensityLabels:!1,maxFogBands:2,maxEmissiveZones:6,wetReflectionAlpha:.08,occlusionFadeFloor:.56},balanced:{maxDecorPropsPerBuilding:4,maxAmbientGlows:24,enableAnimatedHazards:!0,enableHighDensityLabels:!0,maxFogBands:4,maxEmissiveZones:10,wetReflectionAlpha:.14,occlusionFadeFloor:.48},cinematic:{maxDecorPropsPerBuilding:6,maxAmbientGlows:36,enableAnimatedHazards:!0,enableHighDensityLabels:!0,maxFogBands:6,maxEmissiveZones:14,wetReflectionAlpha:.2,occlusionFadeFloor:.38}},Ns=(e,t,i,s,n,a,r,o,l,c,d,u,h,g)=>({district:e,signageStyle:t,propDensity:i,facadePattern:s,lotPattern:n,massingStyle:a,massingHeight:r,accentHex:o,glowHex:l,trimHex:c,atmosphereHex:d,signagePrimaryHex:u,signageSecondaryHex:h,backdropHex:g}),Xn={downtown:Ns("downtown","corp_holo","medium","ribbed","plaza","block",1.8,"#38bdf8","#67e8f9","#b6f7ff","#081126","#9beafe","#67e8f9","#0d1b2a"),slums:Ns("slums","slums_neon","medium","banded","market","stacked",1,"#f97316","#fb923c","#ffd08d","#170c09","#6ff2ff","#9c8cff","#0b1220")},jo={player:{role:"player",baseColor:988970,outlineColor:6333946,primaryColor:3900150,accentColor:6809849,glowColor:3718648,columnHeight:1.65,widthScale:.78,heightScale:.5,depthOffset:12},friendlyNpc:{role:"friendlyNpc",baseColor:1713208,outlineColor:2282478,primaryColor:959977,accentColor:6809849,glowColor:2282478,columnHeight:1.35,widthScale:.74,heightScale:.48,depthOffset:9},hostileNpc:{role:"hostileNpc",baseColor:2758171,outlineColor:15680580,primaryColor:14427686,accentColor:16347926,glowColor:16478597,columnHeight:1.4,widthScale:.75,heightScale:.49,depthOffset:9},interactiveNpc:{role:"interactiveNpc",baseColor:1057336,outlineColor:10980346,primaryColor:9133302,accentColor:2282478,glowColor:12616956,columnHeight:1.45,widthScale:.77,heightScale:.5,depthOffset:10}},is=e=>({id:"noir-vector-v1",preset:e,qualityBudget:Ko[e],tilePalettes:{floorEven:1317418,floorOdd:1844280,wallEven:3096416,wallOdd:2569554,coverEven:2640722,coverOdd:2244423,waterEven:1066081,waterOdd:997200,trapEven:5644612,trapOdd:4528694,doorEven:3093058,doorOdd:2369333},districtDefaults:Xn,entityProfiles:jo}),Ot=(e,t,i)=>{const n=Xn[e==="downtown"?"downtown":"slums"],a=t??n.signageStyle,r=i??n.propDensity;return a==="corp_brass"?{...n,signageStyle:a,propDensity:r,facadePattern:"chevron",lotPattern:"plaza",massingStyle:"block",massingHeight:2,accentHex:"#f3ca75",glowHex:"#fbbf24",trimHex:"#ffe4a3",atmosphereHex:"#1a140a",signagePrimaryHex:"#f3ca75",signageSecondaryHex:"#f9e2af",backdropHex:"#1a140a"}:a==="slums_scrap"?{...n,signageStyle:a,propDensity:r,facadePattern:"solid",lotPattern:"service",massingStyle:"block",massingHeight:.95,accentHex:"#f97316",glowHex:"#fb923c",trimHex:"#ffd299",atmosphereHex:"#190f08",signagePrimaryHex:"#f97316",signageSecondaryHex:"#fb923c",backdropHex:"#190f08"}:{...n,signageStyle:a,propDensity:r}},Hs=["solid","ribbed","banded","chevron"],$o=["ribbed","chevron"],Yo=["solid","banded"],Zo=["plaza","service"],Xo=["market","service"],Qo=["block"],Jo=["stacked","block"],el=e=>{let t=0;for(let i=0;i<e.length;i+=1)t=t*31+e.charCodeAt(i)>>>0;return t},ci=e=>Math.max(0,Math.min(255,Math.round(e))),At=(e,t)=>{const i=e.startsWith("#")?e.slice(1):e;if(i.length!==6)return e;const s=parseInt(i.slice(0,2),16),n=parseInt(i.slice(2,4),16),a=parseInt(i.slice(4,6),16),r=t*255;return`#${[ci(s+r),ci(n+r),ci(a+r)].map(l=>l.toString(16).padStart(2,"0")).join("")}`},tl=e=>{const t={};return e.forEach(i=>{const s=Ot(i.district,i.signageStyle,i.propDensity),n=el(`${i.id}:${i.name}`),a=i.district==="downtown"?"downtown":"slums",r=a==="downtown"?$o:Yo,o=a==="downtown"?Zo:Xo,l=a==="downtown"?Qo:Jo,c=r[n%r.length]??Hs[n%Hs.length],d=o[(n>>1)%o.length]??s.lotPattern,u=l[(n>>2)%l.length]??s.massingStyle,h=a==="downtown"?1.45:1,g=(n%7-3)*.09,p=Math.max(.85,h+g),m=a==="downtown"?(n%5-2)*.05:(n%7-3)*.06;t[i.id]={...s,facadePattern:c,lotPattern:d,massingStyle:u,massingHeight:p,accentHex:At(s.accentHex,m),glowHex:At(s.glowHex,m*.7),trimHex:At(s.trimHex,m*.45),atmosphereHex:At(s.atmosphereHex,m*.28)}}),{profilesByBuildingId:t}},il=96,sl=72,nl=e=>e>=24&&e<=26||e>=60&&e<=62,al=e=>e>=20&&e<=21||e>=44&&e<=45,rl=(e,t)=>nl(e)||al(t),ol=(e,t)=>t.some(i=>{const{from:s,to:n}=i.footprint;return e.x>=s.x&&e.x<=n.x&&e.y>=s.y&&e.y<=n.y}),ll=(e,t,i,s)=>{const n=Nn(e,t,i,{level:s.level,isInterior:!0,zoneId:s.zoneId,factionRequirement:s.factionRequirement,displayName:s.displayName,summary:s.summary,dangerRating:s.dangerRating,hazards:s.hazards}),a={x:Math.floor(t/2),y:i-1},r={x:a.x,y:Math.max(1,a.y-1)},o=n.tiles[a.y][a.x];return o.type=R.DOOR,o.isWalkable=!0,{area:n,entryPosition:r,doorPosition:a}},cl=(e,t,i)=>{const s=[],n=[];return i.forEach(a=>{var d,u;const{from:r,to:o}=a.footprint;for(let h=r.y;h<=o.y;h++)for(let g=r.x;g<=o.x;g++){const p=(d=e.tiles[h])==null?void 0:d[g];p&&p.type===R.DOOR&&(p.type=R.WALL,p.isWalkable=!1)}const l=(u=e.tiles[a.door.y])==null?void 0:u[a.door.x];if(!l)return;l.type=R.DOOR,l.isWalkable=!0;const c=ll(`${t} :: ${a.name}`,a.interior.width,a.interior.height,{level:e.level??0,zoneId:`${e.zoneId}::interior`,factionRequirement:a.factionRequirement,displayName:`${t} :: ${a.name}`,summary:e.summary,dangerRating:e.dangerRating,hazards:e.hazards});n.push(c.area),s.push({fromAreaId:e.id,fromPosition:{...a.door},toAreaId:c.area.id,toPosition:{...c.entryPosition}}),s.push({fromAreaId:c.area.id,fromPosition:{...c.doorPosition},toAreaId:e.id,toPosition:{...a.door}})}),{connections:s,interiors:n}},dl=e=>e,ul=(e,t,i,s,n,a,r)=>{const o=Nn(e,il,sl,{level:0,objectives:i,zoneId:t}),l=Zn(t),c={...o,name:l.name,displayName:l.name,level:l.level,objectives:l.objectives.length?l.objectives:o.objectives,dangerRating:l.danger,hazards:l.hazards,summary:l.summary},d=[],u=(S,C,F,q,Le=!1)=>{for(let Ie=C;Ie<=q;Ie++)for(let xe=S;xe<=F;xe++)(Le||!rl(xe,Ie))&&d.push({x:xe,y:Ie})};s.forEach(S=>{u(S.footprint.from.x,S.footprint.from.y,S.footprint.to.x,S.footprint.to.y,S.id==="block_2_2")});const h=yr(c,d),p=n.map(S=>S.position).filter(S=>{var F;const C=(F=h.tiles[S.y])==null?void 0:F[S.x];return C?C.isWalkable:!1}),m=Sr(h,p),f=new Set(p.map(S=>`${S.x}:${S.y}`)),w=n.reduce((S,C)=>{if(!C.profile)return S;const F=`${C.position.x}:${C.position.y}`;return f.has(F)?vr(S,C.position,C.profile):S},m),v=dl(w),M=tl(s),b=s.map(S=>({id:S.id,name:S.name,signageStyle:S.signageStyle,district:S.district,propDensity:S.propDensity,encounterProfile:S.encounterProfile,workbench:S.workbench,footprint:{from:{...S.footprint.from},to:{...S.footprint.to}},door:{...S.door},visualProfile:M.profilesByBuildingId[S.id]?{facadePattern:M.profilesByBuildingId[S.id].facadePattern,lotPattern:M.profilesByBuildingId[S.id].lotPattern,massingStyle:M.profilesByBuildingId[S.id].massingStyle,massingHeight:M.profilesByBuildingId[S.id].massingHeight,accentHex:M.profilesByBuildingId[S.id].accentHex,glowHex:M.profilesByBuildingId[S.id].glowHex,trimHex:M.profilesByBuildingId[S.id].trimHex,atmosphereHex:M.profilesByBuildingId[S.id].atmosphereHex,signagePrimaryHex:M.profilesByBuildingId[S.id].signagePrimaryHex,signageSecondaryHex:M.profilesByBuildingId[S.id].signageSecondaryHex,backdropHex:M.profilesByBuildingId[S.id].backdropHex}:void 0}));v.buildings=b;const A=S=>{var F;const C=(F=v.tiles[S.y])==null?void 0:F[S.x];return!C||!C.isWalkable||C.type===R.DOOR||C.type===R.WALL?!1:!ol(S,s)},x=S=>{const C=Yi(S,v)??S;return A(C)?C:Hn(C,v).find(Le=>A(Le))??null};a.forEach(S=>{const C=x(S.position);C&&v.entities.npcs.push({...S,id:se(),position:C})});const I=p.length?p:[{x:32,y:74},{x:84,y:28},{x:54,y:64}];r.forEach((S,C)=>{const F=I[C%I.length],q=x(F)??F;v.entities.items.push({...S,id:se(),position:q})});const{connections:k,interiors:L}=cl(v,e,s);return L.forEach(S=>{S.level=S.level??0,S.objectives=S.objectives??[]}),{area:v,connections:k,interiorAreas:L}},hl=({locale:e})=>{const t=Zt(e),i=ul(t.world.areaName,t.world.zoneId,t.world.objectives,t.buildingDefinitions,t.coverSpots.all,t.npcBlueprints,t.itemBlueprints),s=i.area,a=[...i.interiorAreas].reduce((r,o)=>(r[o.id]=o,r),{[s.id]:s});return{slumsArea:s,mapAreas:a,connections:[...i.connections]}},W={cycleDuration:300,timeMultiplier:1,morningStartTime:0,dayStartTime:.1,eveningStartTime:.4,dayEndTime:.5},ze=(e,t=W)=>{const i=e%t.cycleDuration/t.cycleDuration;return i>=t.morningStartTime&&i<t.dayStartTime?"morning":i>=t.dayStartTime&&i<t.eveningStartTime?"day":i>=t.eveningStartTime&&i<t.dayEndTime?"evening":"night"},pl=(e,t=W)=>{const i=e%t.cycleDuration/t.cycleDuration;return i>=t.morningStartTime&&i<t.dayStartTime?.4+(i-t.morningStartTime)/(t.dayStartTime-t.morningStartTime)*.6:i>=t.dayStartTime&&i<t.eveningStartTime?1:i>=t.eveningStartTime&&i<t.dayEndTime?1-(i-t.eveningStartTime)/(t.dayEndTime-t.eveningStartTime)*.6:.2},ml=(e,t=W)=>{const i=ze(e,t),s=pl(e,t);switch(i){case"morning":return`rgba(180, 208, 255, ${(1-s)*.22})`;case"day":return"rgba(255, 255, 255, 0)";case"evening":return`rgba(214, 179, 255, ${(1-s)*.28})`;case"night":return`rgba(18, 30, 64, ${.72*(1-s)})`;default:return"rgba(0, 0, 0, 0)"}},ut=(e,t=W)=>ze(e,t)==="night";var di={};const gl=()=>{},fl=()=>typeof process<"u"?"production":"development",yl=()=>[typeof process<"u"?di==null?void 0:di.ENABLE_VERBOSE_LOGS:void 0,typeof globalThis<"u"?globalThis.__ENABLE_VERBOSE_LOGS:void 0].some(t=>typeof t=="string"?t.toLowerCase()==="true":t===!0),Sl=!yl()&&fl()==="test",vl=e=>{const t=console[e]??console.log;return typeof t=="function"?t.bind(console):console.log.bind(console)},It=(e,t)=>{const i=vl(e);return Sl&&(e==="debug"||e==="info")?gl:(...s)=>{i(`[${t}]`,...s)}},ss=e=>({debug:It("debug",e),info:It("info",e),warn:It("warn",e),error:It("error",e)});ss("app");const ce=ss("worldSlice"),bl=()=>({flags:{gangHeat:"low",curfewLevel:0,supplyScarcity:"norm",blackoutTier:"none"},weather:{presetId:null,rainIntensity:0,thunderActive:!1,sirenLoop:!1,updatedAt:0,timeOfDay:null},signage:{},rumorSets:{},notes:[]}),wl=(e,t)=>(e.buildings??[]).some(i=>{const{from:s,to:n}=i.footprint;return t.x>=s.x&&t.x<=n.x&&t.y>=s.y&&t.y<=n.y}),Pl=e=>({id:se(),name:e,position:{x:34,y:24},facing:"west",coverOrientation:null,suppression:0,maxHealth:45,health:45,actionPoints:4,maxActionPoints:4,damage:7,attackRange:2,isHostile:!0,visionCone:{range:10,angle:90,direction:180},alertLevel:B.IDLE,alertProgress:0,lastKnownPlayerPosition:null,aiProfileId:ct,aiState:"patrol",aiLastTransitionAt:0,aiCooldowns:{}}),om=Math.floor(W.dayEndTime*W.cycleDuration),Ml=Math.floor(W.dayStartTime*W.cycleDuration),Qn=Math.floor((W.dayStartTime+W.eveningStartTime)/2*W.cycleDuration),Jn=e=>{const t=hl({locale:e}),i=Zt(e),s=t.slumsArea,n=Pl(i.world.initialEnemyName),a=Yi(n.position,s);a&&(n.position=a),s.entities.enemies.push(n),ce.debug("Initial map generated with enemy:",n);const r=Qn;return{currentMapArea:s,mapAreas:t.mapAreas,mapConnections:t.connections,currentTime:r,timeOfDay:ze(r,W),curfewActive:ut(r,W),inCombat:!1,isPlayerTurn:!0,turnCount:1,globalAlertLevel:B.IDLE,reinforcementsScheduled:!1,environment:bl(),engagementMode:"none",workbenchAvailable:!1,workbenchStatus:{available:!1,note:"No workbench nearby"}}},Al=Jn(Ae),ea=Q({name:"world",initialState:Al,reducers:{setEnvironmentFlags:(e,t)=>{e.environment.flags={...e.environment.flags,...t.payload}},setWorkbenchAvailable:(e,t)=>{e.workbenchAvailable=t.payload,e.workbenchStatus={available:t.payload,note:t.payload?void 0:"No workbench nearby"}},setWorkbenchStatus:(e,t)=>{e.workbenchStatus={...t.payload},e.workbenchAvailable=t.payload.available},applyEnvironmentWeather:(e,t)=>{e.environment.weather={...t.payload}},applyEnvironmentSignage:(e,t)=>{const{signId:i,snapshot:s}=t.payload;e.environment.signage={...e.environment.signage,[i]:{...s}}},removeEnvironmentSignage:(e,t)=>{const i={...e.environment.signage};delete i[t.payload],e.environment.signage=i},applyEnvironmentRumorSet:(e,t)=>{const{groupId:i,snapshot:s}=t.payload;e.environment.rumorSets={...e.environment.rumorSets,[i]:{...s}}},removeEnvironmentRumorSet:(e,t)=>{const i={...e.environment.rumorSets};delete i[t.payload],e.environment.rumorSets=i},registerEnvironmentalNote:(e,t)=>{const i=t.payload,s=e.environment.notes.findIndex(n=>n.instanceId===i.instanceId);s>=0?e.environment.notes[s]={...i}:e.environment.notes.push({...i})},clearEnvironmentalNotesForArea:(e,t)=>{const i=t.payload;e.environment.notes=e.environment.notes.filter(s=>s.areaId!==i)},setNpcAmbientProfile:(e,t)=>{const{profile:i,match:s}=t.payload,{dialogueId:n,name:a}=s,r=o=>{let l=!1;const c=o.map(d=>{const u=n?d.dialogueId===n:!1,h=a?d.name===a:!1;return!u&&!h?d:(l=!0,{...d,ambientProfile:i?{...i}:void 0})});return l?c:o};e.currentMapArea.entities.npcs=r(e.currentMapArea.entities.npcs),Object.values(e.mapAreas).forEach(o=>{o.entities.npcs=r(o.entities.npcs)})},setMapArea:(e,t)=>{e.currentMapArea=t.payload,e.inCombat=!1,e.isPlayerTurn=!0,e.turnCount=1,e.engagementMode="none",e.workbenchAvailable=!1,e.workbenchStatus={available:!1,note:"No workbench nearby"}},setCurrentMapAreaZoneMetadata:(e,t)=>{const i=Zn(t.payload.zoneId),s=e.currentMapArea;s.zoneId=i.zoneId,s.name=i.name,s.displayName=i.name,s.level=i.level,s.summary=i.summary,s.dangerRating=i.danger,s.hazards=[...i.hazards],s.objectives=[...i.objectives],e.workbenchAvailable=!1,e.workbenchStatus={available:!1,note:"No workbench nearby"};const n=e.mapAreas[s.id];n&&(n.zoneId=s.zoneId,n.name=s.name,n.displayName=s.displayName,n.level=s.level,n.summary=s.summary,n.dangerRating=s.dangerRating,n.hazards=[...s.hazards],n.objectives=[...s.objectives])},updateGameTime:(e,t)=>{e.currentTime+=t.payload,e.timeOfDay=ze(e.currentTime,W),e.curfewActive=ut(e.currentTime,W),e.curfewActive?e.environment.flags.curfewLevel=e.reinforcementsScheduled?3:2:e.environment.flags.curfewLevel=0,e.environment.flags.blackoutTier!=="rolling"&&(e.environment.flags.blackoutTier=e.curfewActive?"brownout":"none")},setGameTime:(e,t)=>{e.currentTime=t.payload,e.timeOfDay=ze(e.currentTime,W),e.curfewActive=ut(e.currentTime,W),e.curfewActive?e.environment.flags.curfewLevel=e.reinforcementsScheduled?3:2:e.environment.flags.curfewLevel=0,e.environment.flags.blackoutTier!=="rolling"&&(e.environment.flags.blackoutTier=e.curfewActive?"brownout":"none")},enterCombat:e=>{if(!e.inCombat){if(e.currentMapArea.entities.enemies.filter(i=>i.health>0).length===0){ce.debug("Cannot enter combat: no living enemies");return}ce.debug("Entering Combat Mode"),e.inCombat=!0,e.isPlayerTurn=!0,e.turnCount=1,e.engagementMode="combat"}},exitCombat:e=>{e.inCombat&&(ce.debug("Exiting Combat Mode"),e.inCombat=!1,e.isPlayerTurn=!0,e.turnCount=1,e.engagementMode="none")},setEngagementMode:(e,t)=>{e.engagementMode=t.payload},switchTurn:e=>{e.inCombat&&(e.isPlayerTurn=!e.isPlayerTurn,e.isPlayerTurn?(e.turnCount++,ce.debug(`switchTurn: Starting Player Turn ${e.turnCount}`)):(ce.debug(`switchTurn: Starting Enemy Turn (during Player Turn ${e.turnCount})`),ce.debug("switchTurn: Resetting AP for all living enemies"),e.currentMapArea.entities.enemies.forEach((t,i)=>{t.health>0&&(e.currentMapArea.entities.enemies[i].actionPoints=t.maxActionPoints)})))},updateEnemy:(e,t)=>{const i=t.payload,s=a=>{const r=a.entities.enemies.findIndex(o=>o.id===i.id);return r===-1?!1:(i.health<=0?a.entities.enemies.splice(r,1):a.entities.enemies[r]=i,a.entities.enemies=[...a.entities.enemies],!0)};ce.debug("updateEnemy reducer running",{enemyId:i.id,health:i.health});const n=s(e.currentMapArea);Object.values(e.mapAreas).forEach(a=>{const r=s(a);!n&&r&&a.id===e.currentMapArea.id&&(e.currentMapArea.entities.enemies=[...e.currentMapArea.entities.enemies])}),i.health<=0&&(ce.debug(`updateEnemy: Enemy ${i.id} removed from all areas.`),e.currentMapArea.entities.enemies.filter(r=>r.health>0).length===0&&(ce.debug("updateEnemy: No living enemies remain. Clearing combat state."),e.inCombat=!1,e.isPlayerTurn=!0,e.turnCount=1))},addEnemy:(e,t)=>{const i={...t.payload};let s=Yi(i.position,e.currentMapArea);s||(s=Hn(i.position,e.currentMapArea,void 0,[]).find(r=>e.currentMapArea.entities.enemies.every(o=>o.position.x!==r.x||o.position.y!==r.y))??i.position),i.position=s,e.currentMapArea.entities.enemies.push(i),e.currentMapArea.entities.enemies=[...e.currentMapArea.entities.enemies]},removeEnemy:(e,t)=>{const i=t.payload;e.currentMapArea.entities.enemies=e.currentMapArea.entities.enemies.filter(s=>s.id!==i),e.currentMapArea.entities.enemies=[...e.currentMapArea.entities.enemies]},updateNPC:(e,t)=>{const i=t.payload,s=e.currentMapArea.entities.npcs.findIndex(n=>n.id===i.id);s!==-1&&(e.currentMapArea.entities.npcs[s]=i,e.currentMapArea.entities.npcs=[...e.currentMapArea.entities.npcs])},addNPC:(e,t)=>{e.currentMapArea.entities.npcs.push(t.payload),e.currentMapArea.entities.npcs=[...e.currentMapArea.entities.npcs]},removeNPC:(e,t)=>{const i=t.payload;e.currentMapArea.entities.npcs=e.currentMapArea.entities.npcs.filter(s=>s.id!==i),e.currentMapArea.entities.npcs=[...e.currentMapArea.entities.npcs]},addItemToMap:(e,t)=>{var r;const{item:i,position:s}=t.payload,n=(r=e.currentMapArea.tiles[s.y])==null?void 0:r[s.x];if(!n||!n.isWalkable||n.type===R.DOOR||n.type===R.WALL||wl(e.currentMapArea,s))return;const a={...i,position:s};e.currentMapArea.entities.items.push(a)},removeItemFromMap:(e,t)=>{const i=t.payload;e.currentMapArea.entities.items=e.currentMapArea.entities.items.filter(s=>s.id!==i)},removeItemInstanceFromMap:(e,t)=>{const{id:i,position:s,name:n}=t.payload,a=e.currentMapArea.entities.items,r=a.filter(o=>{var d,u;const l=!!(i&&o.id===i),c=!!(s&&((d=o.position)==null?void 0:d.x)===s.x&&((u=o.position)==null?void 0:u.y)===s.y&&(!n||o.name===n));return!(l||c)});r.length!==a.length&&(e.currentMapArea.entities.items=r)},applyLocaleToWorld:(e,t)=>Jn(t.payload),setGlobalAlertLevel:(e,t)=>{e.globalAlertLevel=t.payload;const i=t.payload===B.ALARMED?"high":t.payload===B.IDLE?"low":"med",s=t.payload===B.ALARMED?"rationed":t.payload===B.IDLE?"norm":"tight";e.environment.flags.gangHeat=i,e.environment.flags.supplyScarcity=s,t.payload===B.ALARMED?(e.environment.flags.blackoutTier="rolling",e.environment.flags.curfewLevel=Math.max(e.environment.flags.curfewLevel,3)):e.environment.flags.blackoutTier==="rolling"&&(e.environment.flags.blackoutTier=e.curfewActive?"brownout":"none",e.environment.flags.curfewLevel=e.curfewActive?2:0)},scheduleReinforcements:e=>{e.reinforcementsScheduled=!0,e.environment.flags.curfewLevel=3,e.globalAlertLevel===B.ALARMED&&(e.environment.flags.blackoutTier="rolling")},clearReinforcementsSchedule:e=>{e.reinforcementsScheduled=!1,e.environment.flags.curfewLevel=e.curfewActive?2:0,e.environment.flags.blackoutTier!=="rolling"&&(e.environment.flags.blackoutTier=e.curfewActive?"brownout":"none")}}}),{setEnvironmentFlags:lm,applyEnvironmentWeather:cm,applyEnvironmentSignage:dm,removeEnvironmentSignage:um,applyEnvironmentRumorSet:hm,removeEnvironmentRumorSet:pm,registerEnvironmentalNote:mm,clearEnvironmentalNotesForArea:gm,setNpcAmbientProfile:fm,setMapArea:ym,setCurrentMapAreaZoneMetadata:Sm,updateGameTime:ta,setGameTime:Il,enterCombat:vm,exitCombat:bm,switchTurn:xt,updateEnemy:xl,addEnemy:wm,removeEnemy:Pm,updateNPC:Mm,addNPC:Am,removeNPC:Im,addItemToMap:xm,removeItemFromMap:Cm,removeItemInstanceFromMap:km,applyLocaleToWorld:Cl,setGlobalAlertLevel:Tm,scheduleReinforcements:Rm,clearReinforcementsSchedule:Em,setEngagementMode:_m,setWorkbenchAvailable:Dm,setWorkbenchStatus:Lm}=ea.actions,ia=ea.reducer,xi=e=>{const t=Zt(e);return{quests:t.quests,dialogues:t.dialogues,activeDialogue:{dialogueId:null,currentNodeId:null},lastBriefing:{dialogueId:null,nodeId:null}}},kl=xi(Ae),sa=Q({name:"quests",initialState:kl,reducers:{addQuest:(e,t)=>{e.quests.push(t.payload)},updateQuest:(e,t)=>{const i=t.payload,s=e.quests.findIndex(n=>n.id===i.id);s!==-1&&(e.quests[s]=i)},startQuest:(e,t)=>{const i=t.payload,s=e.quests.find(n=>n.id===i);s&&!s.isActive&&!s.isCompleted&&(s.isActive=!0)},completeQuest:(e,t)=>{const i=t.payload,s=e.quests.find(n=>n.id===i);s&&s.isActive&&(s.isActive=!1,s.isCompleted=!0)},updateObjectiveStatus:(e,t)=>{const{questId:i,objectiveId:s,isCompleted:n}=t.payload,a=e.quests.find(r=>r.id===i);if(a){const r=a.objectives.find(o=>o.id===s);r&&(r.isCompleted=n)}},updateObjectiveCounter:(e,t)=>{const{questId:i,objectiveId:s,count:n}=t.payload,a=e.quests.find(r=>r.id===i);if(a){const r=a.objectives.find(o=>o.id===s);if(r&&(r.type==="collect"||r.type==="kill")){const o=r.count||1,l=(r.currentCount||0)+n;r.currentCount=Math.min(l,o),r.currentCount>=o&&(r.isCompleted=!0)}}},addDialogue:(e,t)=>{e.dialogues.push(t.payload)},startDialogue:(e,t)=>{const{dialogueId:i,nodeId:s}=t.payload;e.activeDialogue={dialogueId:i,currentNodeId:s},e.lastBriefing={dialogueId:i,nodeId:s}},setDialogueNode:(e,t)=>{e.activeDialogue.currentNodeId=t.payload,t.payload&&(e.lastBriefing={dialogueId:e.activeDialogue.dialogueId,nodeId:t.payload})},endDialogue:e=>{e.activeDialogue={dialogueId:null,currentNodeId:null}},resetQuests:(e,t)=>xi(t.payload??Ae),applyLocaleToQuests:(e,t)=>xi(t.payload)}}),{addQuest:Fm,updateQuest:Bm,startQuest:Om,completeQuest:Nm,updateObjectiveStatus:Hm,updateObjectiveCounter:Wm,addDialogue:qm,startDialogue:Gm,setDialogueNode:Vm,endDialogue:zm,resetQuests:Um,applyLocaleToQuests:Tl}=sa.actions,Rl=sa.reducer,El={id:"level0_recover_cache",resourceKey:"missions.level0.recover_cache",levelKey:"levels.slums_command_grid",kind:"primary",questKeys:["quests.market_cache"],relatedNpcKeys:["npcs.lira_smuggler"],generatedSceneKeys:["scenes.level0.recover_cache.ambush_route"]},_l={id:"level0_decrypt_manifests",resourceKey:"missions.level0.decrypt_manifests",levelKey:"levels.slums_command_grid",kind:"primary",questKeys:["quests.datapad_truth"],relatedNpcKeys:["npcs.archivist_naila"]},Dl={id:"level0_rebuild_courier_network",resourceKey:"missions.level0.rebuild_courier_network",levelKey:"levels.slums_command_grid",kind:"primary",questKeys:["quests.courier_network"],relatedNpcKeys:["npcs.courier_brant"]},Ll={id:"level0_blackout_camera_grid",resourceKey:"missions.level0.blackout_camera_grid",levelKey:"levels.slums_command_grid",kind:"side",questKeys:["quests.equipment_sabotage"],factionTag:"resistance",relatedNpcKeys:["npcs.firebrand_juno"]},Fl={id:"level0_map_drone_patrols",resourceKey:"missions.level0.map_drone_patrols",levelKey:"levels.slums_command_grid",kind:"side",questKeys:["quests.drone_recon"],relatedNpcKeys:["npcs.drone_handler_kesh"]},Bl={id:"level0_restock_rebel_clinic",resourceKey:"missions.level0.restock_rebel_clinic",levelKey:"levels.slums_command_grid",kind:"side",questKeys:["quests.medkit_supplies"],relatedNpcKeys:["npcs.medic_yara"]},Ol={id:"level0_clear_transit_patrol",resourceKey:"missions.level0.clear_transit_patrol",levelKey:"levels.slums_command_grid",kind:"side",questKeys:["quests.combat_patrol"],relatedNpcKeys:["npcs.captain_reyna"]},Nl={id:"level1_seize_governance_archives",resourceKey:"missions.level1.seize_governance_archives",levelKey:"levels.downtown_governance_ring",kind:"primary",questKeys:["quests.government_archives"],relatedNpcKeys:[]},Hl={id:"level1_override_curfew_terminals",resourceKey:"missions.level1.override_curfew_terminals",levelKey:"levels.downtown_governance_ring",kind:"primary",questKeys:["quests.curfew_override"],relatedNpcKeys:[]},Wl={id:"level1_extract_detained_couriers",resourceKey:"missions.level1.extract_detained_couriers",levelKey:"levels.downtown_governance_ring",kind:"primary",questKeys:["quests.prison_break"],relatedNpcKeys:[]},ql={id:"level1_hijack_camera_resync",resourceKey:"missions.level1.hijack_camera_resync",levelKey:"levels.downtown_governance_ring",kind:"side",questKeys:["quests.camera_resync"],relatedNpcKeys:[]},Gl={id:"level1_divert_supply_convoys",resourceKey:"missions.level1.divert_supply_convoys",levelKey:"levels.downtown_governance_ring",kind:"side",questKeys:["quests.supply_diversion"],relatedNpcKeys:[]},Vl={id:"level1_broadcast_resistance_propaganda",resourceKey:"missions.level1.broadcast_resistance_propaganda",levelKey:"levels.downtown_governance_ring",kind:"side",questKeys:["quests.plaza_broadcast"],relatedNpcKeys:[]},zl={id:"level2_stabilise_refinery_outpost",resourceKey:"missions.level2.stabilise_refinery_outpost",levelKey:"levels.industrial_wasteland",kind:"primary",questKeys:["quests.refinery_stabilization"],relatedNpcKeys:[]},Ul={id:"level2_cripple_convoy_routes",resourceKey:"missions.level2.cripple_convoy_routes",levelKey:"levels.industrial_wasteland",kind:"primary",questKeys:["quests.convoy_ambush"],relatedNpcKeys:[]},Kl={id:"level2_recover_filtration_core",resourceKey:"missions.level2.recover_filtration_core",levelKey:"levels.industrial_wasteland",kind:"primary",questKeys:["quests.filtration_recovery"],relatedNpcKeys:[]},jl={id:"level2_broker_scavenger_truce",resourceKey:"missions.level2.broker_scavenger_truce",levelKey:"levels.industrial_wasteland",kind:"side",questKeys:["quests.scavenger_truce"],factionTag:"scavengers",relatedNpcKeys:[]},$l={id:"level2_stabilise_power_grid",resourceKey:"missions.level2.stabilise_power_grid",levelKey:"levels.industrial_wasteland",kind:"side",questKeys:["quests.power_grid"],relatedNpcKeys:[]},Yl={id:"level2_secure_evacuation_lanes",resourceKey:"missions.level2.secure_evacuation_lanes",levelKey:"levels.industrial_wasteland",kind:"side",questKeys:["quests.industrial_evac"],relatedNpcKeys:[]},Zl=[El,_l,Dl,Ll,Fl,Bl,Ol,Nl,Hl,Wl,ql,Gl,Vl,zl,Ul,Kl,jl,$l,Yl],Xl=Zl.reduce((e,t)=>(e[t.resourceKey]=t,e),{}),Ql=e=>{const t=Xl[e];if(!t)throw new Error(`Unknown mission resource key: ${e}`);return t},Jl=(e,t)=>{const i=t.missions[e.resourceKey];if(!i)throw new Error(`Missing locale entry for mission ${e.resourceKey}`);const s=e.questKeys.map(n=>{const a=Ja[n];if(!a)throw new Error(`Mission ${e.resourceKey} references unknown quest key ${n}`);return a.id});return{id:e.id,label:i.label,summary:i.summary,questIds:s,kind:e.kind,recommendedLevel:e.recommendedLevel,factionTag:e.factionTag}},ec=(e,t)=>{const i=t.levels[e.resourceKey],s=e.missionKeys.map(Ql).map(n=>Jl(n,t));return{level:e.order,levelId:e.id,name:(i==null?void 0:i.name)??e.id,zoneId:e.zoneKey,objectives:s}},tc=e=>{const t=er(e);return Qa.map(i=>ec(i,t))},ic=e=>tc(e).map(i=>({level:i.level,levelId:i.levelId,name:i.name,zoneId:i.zoneId,objectives:i.objectives.map(s=>({...s,questIds:[...s.questIds]}))})),Ci=(e=Ae)=>({levels:ic(e),currentLevelIndex:0,pendingAdvance:!1,celebrationAcknowledged:!1,lastMissionCompletedAt:null}),sc=Ci(Ae),na=Q({name:"missions",initialState:sc,reducers:{missionAccomplished(e){e.pendingAdvance||(e.pendingAdvance=!0,e.celebrationAcknowledged=!1,e.lastMissionCompletedAt=Date.now())},acknowledgeMissionAccomplished(e){e.celebrationAcknowledged=!0},deferMissionAdvance(e){e.celebrationAcknowledged=!0},showMissionAdvancePrompt(e){e.pendingAdvance&&(e.celebrationAcknowledged=!1)},advanceToNextLevel(e){e.currentLevelIndex<e.levels.length-1&&(e.currentLevelIndex+=1),e.pendingAdvance=!1,e.celebrationAcknowledged=!1},resetMissions:(e,t)=>Ci(t.payload??Ae),applyLocaleToMissions:(e,t)=>Ci(t.payload)}}),{missionAccomplished:Km,acknowledgeMissionAccomplished:jm,deferMissionAdvance:$m,showMissionAdvancePrompt:Ym,advanceToNextLevel:Zm,resetMissions:Xm,applyLocaleToMissions:nc}=na.actions,ac=na.reducer,rc={messages:[]},aa=Q({name:"log",initialState:rc,reducers:{addLogMessage(e,t){const s=[...e.messages,t.payload];s.length>50&&s.shift(),e.messages=s,console.log(`[Log] ${t.payload}`)},clearLog(e){e.messages=[]}},extraReducers:e=>{e.addCase(Il,(t,i)=>{ut(i.payload,W)&&t.messages.length===0&&(t.messages=["Searchlights pin you in the open—duck inside before the patrols lock on."])})}}),{addLogMessage:be,clearLog:Qm}=aa.actions,oc=aa.reducer,ui=e=>e,ki={balanced:ui({id:"balanced",label:"Balanced",description:"Evaluates offence and defence evenly. Prioritises clear shots, keeps moderate AP reserve, and falls back to cover if health dips.",weights:{attackBias:1,focusLowestHealth:.75,focusOverwatchThreat:.85,maintainCover:.8,pursuitAggression:.65,consumableAggression:.5,retreatBias:.6},thresholds:{panicHealthFraction:.35,apReserve:1,minimumConsumableCharges:1}}),aggressive:ui({id:"aggressive",label:"Aggressive",description:"Closes distance, spends AP rapidly, and consumes resources to finish priority targets. Retreats only when near death.",weights:{attackBias:1.35,focusLowestHealth:1.1,focusOverwatchThreat:.7,maintainCover:.35,pursuitAggression:1.2,consumableAggression:1,retreatBias:.2},thresholds:{panicHealthFraction:.2,apReserve:0,minimumConsumableCharges:0}}),defensive:ui({id:"defensive",label:"Defensive",description:"Holds positions with strong cover, conserves consumables, and only advances when safe. Will disengage early if health drops.",weights:{attackBias:.6,focusLowestHealth:.55,focusOverwatchThreat:1.25,maintainCover:1.6,pursuitAggression:.3,consumableAggression:.25,retreatBias:1.4},thresholds:{panicHealthFraction:.5,apReserve:2,minimumConsumableCharges:2}})},lc="balanced",Jm=Object.keys(ki),Ws=e=>ki[e]??ki.balanced,cc={locale:Ae,testMode:!1,autoBattleEnabled:!1,autoBattleProfile:lc,visualQualityPreset:"balanced",lightsEnabled:!1,autoStealthEnabled:!1,reputationSystemsEnabled:!1},ra=Q({name:"settings",initialState:cc,reducers:{setLocale:(e,t)=>{e.locale=t.payload},setTestMode:(e,t)=>{e.testMode=t.payload},setAutoBattleEnabled:(e,t)=>{e.autoBattleEnabled=t.payload},setAutoBattleProfile:(e,t)=>{e.autoBattleProfile=t.payload},setVisualQualityPreset:(e,t)=>{e.visualQualityPreset=t.payload},setLightsEnabled:(e,t)=>{e.lightsEnabled=t.payload},setAutoStealthEnabled:(e,t)=>{e.autoStealthEnabled=t.payload},setReputationSystemsEnabled:(e,t)=>{e.reputationSystemsEnabled=t.payload}}}),{setLocale:eg,setTestMode:tg,setAutoBattleEnabled:ig,setAutoBattleProfile:sg,setVisualQualityPreset:ng,setLightsEnabled:qs,setAutoStealthEnabled:ag,setReputationSystemsEnabled:rg}=ra.actions,oa=ra.reducer,dc={floatingNumbers:[],hitFlashes:[],activeFlashId:null},la=Q({name:"combatFeedback",initialState:dc,reducers:{addFloatingNumber:(e,t)=>{e.floatingNumbers.push(t.payload)},removeFloatingNumber:(e,t)=>{e.floatingNumbers=e.floatingNumbers.filter(i=>i.id!==t.payload)},triggerHitFlash:(e,t)=>{e.activeFlashId=t.payload.id,e.hitFlashes.push(t.payload)},clearHitFlash:e=>{e.activeFlashId=null,e.hitFlashes=[]},clearAllFeedback:e=>{e.floatingNumbers=[],e.hitFlashes=[],e.activeFlashId=null}}}),{addFloatingNumber:uc,removeFloatingNumber:og,triggerHitFlash:lg,clearHitFlash:cg,clearAllFeedback:dg}=la.actions,hc=la.reducer,pc=()=>({overlayEnabled:!0,camerasNearby:0,detectionProgress:0,activeCameraId:null,alertState:ne.IDLE,networkAlertActive:!1,networkAlertExpiresAt:null}),Gs={zones:{},hud:pc(),curfewBanner:{visible:!1,lastActivatedAt:null}},ca=Q({name:"surveillance",initialState:Gs,reducers:{registerZoneCameras:(e,t)=>{const{areaId:i,zoneId:s,cameras:n,timestamp:a}=t.payload,r=n.reduce((o,l)=>(o[l.id]={...l},o),{});e.zones[i]={areaId:i,zoneId:s,cameras:r,networkAlert:null,lastUpdatedAt:a}},updateCameraState:(e,t)=>{const{areaId:i,cameraId:s,changes:n,timestamp:a}=t.payload,r=e.zones[i];if(!r)return;const o=r.cameras[s];o&&(r.cameras[s]={...o,...n},r.lastUpdatedAt=a)},setCameraNetworkAlert:(e,t)=>{const{areaId:i,alert:s}=t.payload,n=e.zones[i];n&&(n.networkAlert=s?{...s}:null)},updateHudState:(e,t)=>{const i=t.payload;e.hud={...e.hud,...i},typeof i.networkAlertActive=="boolean"&&!i.networkAlertActive&&(e.hud.networkAlertExpiresAt=null),typeof i.networkAlertExpiresAt=="number"&&(e.hud.networkAlertActive=!0)},setOverlayEnabled:(e,t)=>{e.hud.overlayEnabled=t.payload.enabled},setCurfewBanner:(e,t)=>{e.curfewBanner.visible=t.payload.visible,t.payload.visible&&(e.curfewBanner.lastActivatedAt=t.payload.timestamp)},clearZoneCameras:(e,t)=>{const{areaId:i}=t.payload;delete e.zones[i]},resetSurveillanceState:()=>Gs}}),{registerZoneCameras:ug,updateCameraState:hg,setCameraNetworkAlert:pg,updateHudState:mg,setOverlayEnabled:gg,setCurfewBanner:fg,clearZoneCameras:yg,resetSurveillanceState:Sg}=ca.actions,da=ca.reducer,mc=[{id:"npc_lira_vendor",name:"Lira the Smuggler",kind:"contact",tags:["resistance","strategist","ally","bonded","quartermaster"],traits:["resistance","strategist","bonded"],factionId:"resistance",relationship:"bonded"},{id:"npc_archivist_naila",name:"Archivist Naila",kind:"contact",tags:["resistance","scholar","ally"],traits:["scholar","resistance"],factionId:"resistance",relationship:"ally"},{id:"npc_courier_brant",name:"Courier Brant",kind:"contact",tags:["resistance","runner","ally"],traits:["runner","ally"],factionId:"resistance",relationship:"ally"},{id:"npc_firebrand_juno",name:"Firebrand Juno",kind:"contact",tags:["resistance","agitator","ally","witness"],traits:["agitator"],factionId:"resistance",relationship:"ally"},{id:"npc_seraph_warden",name:"Seraph Warden",kind:"contact",tags:["corpsec","warden","rival"],traits:["corpsec","rival"],factionId:"corpsec",relationship:"rival"},{id:"npc_drone_handler_kesh",name:"Drone Handler Kesh",kind:"contact",tags:["resistance","tech","ally"],traits:["technician"],factionId:"resistance",relationship:"ally"}],gc={npc_lira_vendor:{tags:["resistance","ally","quartermaster","bonded"],traits:["strategist","bonded"],relationship:"bonded",factionId:"resistance"},npc_archivist_naila:{tags:["resistance","ally","scholar"],traits:["scholar"],relationship:"ally",factionId:"resistance"},npc_courier_brant:{tags:["resistance","ally","runner"],traits:["runner"],relationship:"ally",factionId:"resistance"},npc_firebrand_juno:{tags:["resistance","ally","agitator"],traits:["agitator"],relationship:"ally",factionId:"resistance"},npc_seraph_warden:{tags:["corpsec","rival","warden"],traits:["corpsec","rival"],relationship:"rival",factionId:"corpsec"},npc_drone_handler_kesh:{tags:["resistance","ally","tech"],traits:["technician"],relationship:"ally",factionId:"resistance"},npc_medic_yara:{tags:["resistance","ally","medic"],traits:["medic"],relationship:"ally",factionId:"resistance"},npc_captain_reyna:{tags:["resistance","ally","commander"],traits:["commander"],relationship:"ally",factionId:"resistance"}},Ti=(e,t)=>{e.has(t.id)||e.set(t.id,{...t,tags:[...t.tags],traits:[...t.traits]})},fc=(e,t,i)=>{const s=e.get(t.id);if(!s){Ti(e,t);return}s.tags=Array.from(new Set([...s.tags,...t.tags])),s.traits=Array.from(new Set([...s.traits,...t.traits]))},yc=({player:e,npcs:t})=>{var a;const i=new Map;mc.forEach(r=>Ti(i,r));const s=e.maxHealth>0?e.maxHealth*.65:e.maxHealth,n={id:e.id,name:e.name||"Operative",kind:"player",tags:["player","operative","ally"],traits:[((a=e.personality)==null?void 0:a.alignment)??"earnest"],factionId:"resistance",wounded:e.health<s,relationship:"ally",backgroundId:e.backgroundId};return e.backgroundId&&n.tags.push(e.backgroundId),e.perks.length>0&&n.tags.push("perked"),Ti(i,n),t.forEach(r=>{const o=r.dialogueId??r.id;if(!o)return;const l={id:o,name:r.name,kind:r.isInteractive?"contact":"npc",tags:["npc",r.isInteractive?"ally":"witness"],traits:[],wounded:r.health<r.maxHealth,relationship:r.isInteractive?"ally":"witness"},c=gc[o];c&&(l.tags.push(...c.tags),c.traits&&l.traits.push(...c.traits),c.relationship&&(l.relationship=c.relationship),c.factionId&&(l.factionId=c.factionId)),fc(i,l)}),Array.from(i.values())},Vs=(e,t,i)=>{var n;if(t.requiredTags&&!t.requiredTags.every(a=>i.tags.includes(a))||t.forbiddenTags&&t.forbiddenTags.some(a=>i.tags.includes(a))||t.requiredTraits&&!t.requiredTraits.every(a=>i.traits.includes(a))||t.forbiddenTraits&&t.forbiddenTraits.some(a=>i.traits.includes(a))||i.wounded&&t.allowWounded===!1)return null;let s=1;return t.preferredTags&&t.preferredTags.forEach(a=>{i.tags.includes(a)&&(s+=2)}),t.requiredTraits&&(s+=t.requiredTraits.length),i.relationship&&((n=t.preferredTags)!=null&&n.includes(i.relationship))&&(s+=1.5),i.kind==="player"&&e!=="protagonist"&&(s-=.25),s},Sc=(e,t)=>{const i=[...t],s={},n=new Set;let a=0;const r=t.find(o=>o.kind==="player");for(const o of e.roles){let l=null;for(const c of i){if(c.kind!=="player"&&n.has(c.id))continue;const d=Vs(o.id,o,c);d!=null&&(!l||d>l.score)&&(l={roleId:o.id,actor:c,score:d})}if(!l&&o.fallbackToPlayer&&r){const c=Vs(o.id,o,r);c!=null&&(l={roleId:o.id,actor:r,score:Math.max(.5,c)})}if(!l)return null;s[o.id]=l.actor,a+=l.score,l.actor.kind!=="player"&&n.add(l.actor.id)}return{resolvedRoles:s,totalScore:a}},vc=(e,t,i)=>!e.conditions||e.conditions.length===0?!0:e.conditions.every(s=>{var n;switch(s.type){case"roleTrait":{const a=t[s.roleId];return a?a.traits.includes(s.trait):!1}case"roleTag":{const a=t[s.roleId];return a?a.tags.includes(s.tag):!1}case"roleRelationship":{const a=t[s.roleId];return a?a.relationship===s.relationship:!1}case"roleStatus":{const a=t[s.roleId];return s.status==="wounded"?!!(a!=null&&a.wounded):!1}case"contextTag":return!!((n=i.tags)!=null&&n.includes(s.tag));case"contextArc":return i.arc===s.arc;default:return!1}}),bc=(e,t,i)=>{let s=null,n=-1/0;for(const a of e.branches){if(!vc(a,t,i))continue;const r=a.weight??1;(!s||r>n)&&(s=a,n=r)}return s??e.branches[0]??null},wc=(e,t)=>e.triggers.some(i=>{if(i.type!==t.type)return!1;if(i.tags&&i.tags.length>0){const s=t.tags??[];return i.tags.every(n=>s.includes(n))}return!0}),Pc=(e,t,i,s)=>{const n=e.entries[t.id];return!!(n!=null&&n.cooldownExpiresAt&&n.cooldownExpiresAt>s||t.cooldown.perLocation&&i&&e.lastSeenByLocation[i]===t.id&&n!=null&&n.cooldownExpiresAt&&n.cooldownExpiresAt>s)},Mc=({plays:e,runtime:t,trigger:i,actorPool:s,now:n,locationId:a})=>{let r=null,o=-1/0;for(const l of e){if(l.arc!==i.arc||!wc(l,i)||Pc(t,l,a,n))continue;const c=Sc(l,s);if(!c)continue;const d=bc(l,c.resolvedRoles,i);if(!d)continue;const u=t.entries[l.id];let h=(l.weight??1)+c.totalScore+(d.weight??1);u&&(h-=u.timesTriggered*.75),h>o&&(o=h,r={storyletId:l.id,play:l,branch:d,outcome:d.outcome,resolvedRoles:c.resolvedRoles,context:i,timestamp:n,cooldownExpiresAt:n+l.cooldown.durationMs})}return r},Ac=e=>e<=0?"act1_setup":e===1?"act2_escalation":"act3_finale",ua=[{id:"firelight_ambush",arc:"act1_setup",titleKey:"storylets.firelight_ambush.title",synopsisKey:"storylets.firelight_ambush.synopsis",tags:["ambush","resistance","omen"],triggers:[{type:"missionCompletion",tags:["resistance"],intensity:"medium"}],roles:[{id:"protagonist",titleKey:"storylets.roles.protagonist",preferredTags:["operative","player"],fallbackToPlayer:!0,allowWounded:!0},{id:"mentor",titleKey:"storylets.roles.mentor",requiredTags:["resistance"],preferredTags:["strategist","quartermaster"]},{id:"witness",titleKey:"storylets.roles.witness",preferredTags:["civilian","witness"],allowWounded:!1,fallbackToPlayer:!0}],branches:[{id:"scarred_victory",weight:2,conditions:[{type:"roleStatus",roleId:"protagonist",status:"wounded"}],outcome:{id:"scarred_victory",localizationKey:"storylets.firelight_ambush.outcomes.scarred_victory",variantKey:"wounded",effects:[{type:"faction",factionId:"resistance",delta:8,reason:"storylet:firelight_ambush"},{type:"log",logKey:"storylets.firelight_ambush.log.wounded",severity:"info"}],tags:["injury","loyalty"]}},{id:"clean_sweep",outcome:{id:"clean_sweep",localizationKey:"storylets.firelight_ambush.outcomes.clean_sweep",effects:[{type:"faction",factionId:"resistance",delta:5,reason:"storylet:firelight_ambush"},{type:"log",logKey:"storylets.firelight_ambush.log.clean",severity:"info"}],tags:["loyalty"]}}],cooldown:{durationMs:1e3*60*20,perLocation:!0},weight:3},{id:"neon_bivouac",arc:"act2_escalation",titleKey:"storylets.neon_bivouac.title",synopsisKey:"storylets.neon_bivouac.synopsis",tags:["relationship","rest","memory"],triggers:[{type:"campfireRest",tags:["rest"],intensity:"low"}],roles:[{id:"protagonist",titleKey:"storylets.roles.protagonist",preferredTags:["operative","player"],fallbackToPlayer:!0,allowWounded:!0},{id:"confidant",titleKey:"storylets.roles.confidant",requiredTags:["ally"],preferredTags:["bonded","scholar","strategist"],allowWounded:!0}],branches:[{id:"bond_renewed",weight:3,conditions:[{type:"roleRelationship",roleId:"confidant",relationship:"bonded"}],outcome:{id:"bond_renewed",localizationKey:"storylets.neon_bivouac.outcomes.bond_renewed",variantKey:"bonded",effects:[{type:"log",logKey:"storylets.neon_bivouac.log.bonded",severity:"info"},{type:"traitDelta",target:"player",trait:"earnest",delta:1}],tags:["relationship","loyalty"]}},{id:"quiet_distance",outcome:{id:"quiet_distance",localizationKey:"storylets.neon_bivouac.outcomes.quiet_distance",effects:[{type:"log",logKey:"storylets.neon_bivouac.log.distance",severity:"info"}],tags:["memory"]}}],cooldown:{durationMs:1e3*60*30,perLocation:!0},weight:2},{id:"serrated_omen",arc:"act3_finale",titleKey:"storylets.serrated_omen.title",synopsisKey:"storylets.serrated_omen.synopsis",tags:["ambush","corpsec","injury","omen"],triggers:[{type:"patrolAmbush",tags:["corpsec","ambush"],intensity:"high"}],roles:[{id:"protagonist",titleKey:"storylets.roles.protagonist",preferredTags:["operative","player"],fallbackToPlayer:!0,allowWounded:!0},{id:"rival",titleKey:"storylets.roles.rival",requiredTags:["corpsec"],preferredTags:["rival","warden"],allowWounded:!0},{id:"witness",titleKey:"storylets.roles.witness",preferredTags:["resistance","ally"],allowWounded:!0,fallbackToPlayer:!1}],branches:[{id:"rivalry_ignites",weight:2,conditions:[{type:"roleRelationship",roleId:"rival",relationship:"rival"}],outcome:{id:"rivalry_ignites",localizationKey:"storylets.serrated_omen.outcomes.rivalry_ignites",variantKey:"rival",effects:[{type:"faction",factionId:"corpsec",delta:-10,reason:"storylet:serrated_omen"},{type:"playerHealth",delta:-4,allowKO:!1},{type:"log",logKey:"storylets.serrated_omen.log.rival",severity:"warning"}],tags:["injury","corpsec"]}},{id:"shadows_scatter",outcome:{id:"shadows_scatter",localizationKey:"storylets.serrated_omen.outcomes.shadows_scatter",effects:[{type:"log",logKey:"storylets.serrated_omen.log.default",severity:"info"}],tags:["ambush"]}}],cooldown:{durationMs:1e3*60*25,perLocation:!0},weight:3}];ua.reduce((e,t)=>(e[t.id]=t,e),{});const Ic=()=>ua,ha={roles:{protagonist:"Operative",mentor:"Mentor",witness:"Witness",confidant:"Confidant",rival:"Rival"},plays:{firelight_ambush:{title:"Firelight Ambush",synopsis:"After the crates are reclaimed, the cell huddles around a burn barrel to measure the cost of provoking CorpSec patrols.",roles:{protagonist:"Operative",mentor:"Quartermaster",witness:"Runner"},outcomes:{scarred_victory:{base:{narrative:"{mentor} studies the bandaged gouge across {protagonist}’s ribs. “You took the hit so the crates could run. That balance clears.”",logLine:"Lira marks your scars as the price of keeping the supply line alive."},variants:{wounded:{narrative:"{mentor} catches {protagonist} before they slide to the bricks. She seals the fresh wound, the firelight flickering across the stimulant foam. “Next patrol never makes it to the siren,” she vows, voice steady for {witness}’s sake.",logLine:"Lira steadies you, promising the next patrol will never raise an alarm."}}},clean_sweep:{base:{narrative:"The burn barrel sends sparks up past the transit rails. {protagonist} tips confiscated batons into the fire while {mentor} and {witness} sketch new blind spots across a soot-streaked map.",logLine:"The cell celebrates the clean strike and notebooks fill with new patrol gaps."}}}},neon_bivouac:{title:"Neon Bivouac",synopsis:"The crew slumps beneath a humming holo-ad, sharing contraband rations while the grid cools. Stories trade faster than the battered thermos.",roles:{protagonist:"Operative",confidant:"Confidant"},outcomes:{bond_renewed:{base:{narrative:"{confidant} nudges a tin mug into {protagonist}’s hands. “Remember the rooftops in District Eight?” The laugh that follows is low and unguarded, the neon glow framing two conspirators instead of soldiers.",logLine:"{confidant} shares an old war story and the bivouac feels like home again."},variants:{bonded:{narrative:"{confidant} leans shoulder to shoulder with {protagonist}, the steam from the thermos curling between matching scars. “When we ran the Gridfall evac we swore never to sleep alone on watch again. Still true.”",logLine:"{confidant} reaffirms the pact forged during Gridfall and your bond deepens."}}},quiet_distance:{base:{narrative:"The neon hum fills the silence between {protagonist} and {confidant}. They trade reports instead of memories, each syllable an inventory count that never strays into feeling.",logLine:"Camp chatter stays clipped—nerves too raw for stories tonight."}}}},serrated_omen:{title:"Serrated Omen",synopsis:"A CorpSec counter-sweep slams into the team on their way back through the alleys. The clash leaves a metallic stink and unanswered questions.",roles:{protagonist:"Operative",rival:"Adversary",witness:"Witness"},outcomes:{rivalry_ignites:{base:{narrative:"{rival}’s monofilament blade sparks off the barricade, carving a groove through {protagonist}’s armor. “I told you the curfew rites were mine to enforce,” she hisses, visor fractured yet unyielding.",logLine:"Seraph Warden carves a warning across your armor and vows the next hunt will finish it."},variants:{rival:{narrative:"{rival} vents ozone from her pauldrons, the mask reflecting {protagonist}’s blood. “You survived my ambush twice. Next time I bring witnesses.” {witness} pulls you back before the second strike lands.",logLine:"Seraph Warden leaves you bleeding but breathing—her promise of a final duel hangs heavy."}}},shadows_scatter:{base:{narrative:"Sirens bloom and the alleys dissolve into darkness. {protagonist} fires blind, smoke swallowing {rival} while {witness} drags the wounded out before drones arrive.",logLine:"You slip the net, but CorpSec frequencies crackle with renewed suspicion."}}}}},logs:{"storylets.firelight_ambush.log.wounded":"Lira steadies you, promising the next patrol will never raise an alarm.","storylets.firelight_ambush.log.clean":"The cell celebrates the clean strike and notebooks fill with new patrol gaps.","storylets.neon_bivouac.log.bonded":"Sharing Gridfall memories, your confidant reminds you why the fire still burns.","storylets.neon_bivouac.log.distance":"Camp chatter stays clipped—nerves too raw for stories tonight.","storylets.serrated_omen.log.rival":"Seraph Warden leaves you bleeding but breathing—her promise of a final duel hangs heavy.","storylets.serrated_omen.log.default":"You lose her in the smoke, but CorpSec channels crackle with orders to tighten the cordon."}},xc={roles:{protagonist:"Оперативник",mentor:"Кураторка",witness:"Свідок",confidant:"Довірена особа",rival:"Суперниця"},plays:{firelight_ambush:{title:"Засідка у вогнях",synopsis:"Після повернення контрабандних ящиків осередок гріється біля бочки й рахує ціну, яку доведеться платити за розлючені патрулі CorpSec.",roles:{protagonist:"Оперативник",mentor:"Квартирмейстерка",witness:"Розвідник"},outcomes:{scarred_victory:{base:{narrative:"{mentor} розглядає перев’язаний поріз на ребрах {protagonist}. «Ти прийняв удар, щоб вантаж дійшов. Рахунок закрито».",logLine:"Ліра фіксує шрам як обов’язкову плату за живу лінію постачання."},variants:{wounded:{narrative:"{mentor} підхоплює {protagonist}, поки той не впав на бруківку. Вона заливає свіже поранення піною, іскри від вогню тремтять у її очах. «Наступний патруль не доживе до сирени», — кидає вона, щоб заспокоїти {witness}.",logLine:"Ліра підтримує тебе й клянеться, що наступний патруль навіть не встигне подати тривогу."}}},clean_sweep:{base:{narrative:"Жар від бочки освітлює спорядження. {protagonist} кидає конфісковані кийки у вогонь, поки {mentor} та {witness} малюють нові «сліпі зони» на закіптюженій мапі.",logLine:"Осередок святкує чисту операцію й занотовує нові прогалини у патрулях."}}}},neon_bivouac:{title:"Неоновий бівак",synopsis:"Команда притискається під гудінням голографічної реклами, ділячись пайками та історіями, поки мережа остигає.",roles:{protagonist:"Оперативник",confidant:"Довірена особа"},outcomes:{bond_renewed:{base:{narrative:"{confidant} підсовує {protagonist} розігрітий кухоль. «Пам’ятаєш дахи у Восьмому секторі?» Сміх глухий і теплий, неонове сяйво робить із них двох змовників, а не солдатів.",logLine:"{confidant} ділиться старою історією, і бівак знову відчувається домом."},variants:{bonded:{narrative:"{confidant} торкається плечем до плеча {protagonist}, пара від термоса обвішує їхні парні шрами. «На евакуації Gridfall ми поклялися не стояти на варті на самоті. Обіцянка діє», — шепоче вона.",logLine:"{confidant} нагадує про клятву часів Gridfall, і ваш зв’язок міцнішає."}}},quiet_distance:{base:{narrative:"Неонове гудіння заповнює паузу між {protagonist} та {confidant}. Вони обмінюються лише рапортами, кожне слово — це інвентаризація без жодної емоції.",logLine:"Розмови біля вогню уривчасті — нерви надто натягнуті для спогадів."}}}},serrated_omen:{title:"Зазубрений знак",synopsis:"Контр-рейд CorpSec накриває групу у провулках. Металевий присмак зависає в повітрі, залишаючи запитання без відповіді.",roles:{protagonist:"Оперативник",rival:"Суперниця",witness:"Свідок"},outcomes:{rivalry_ignites:{base:{narrative:"Лезо {rival} креслить іскри по барикаді, розрізаючи броню {protagonist}. «Комендантська година — моя прерогатива», — шипить вона крізь тріснутий візор.",logLine:"Сераф-варден залишає поріз на твоїй броні й обіцяє, що наступне полювання буде останнім."},variants:{rival:{narrative:"{rival} випускає озон із наплічників, маска віддзеркалює кров {protagonist}. «Двічі ти вислизнув. Наступного разу я приведу свідків». {witness} шарпає тебе назад, перш ніж вона наносить другий удар.",logLine:"Сераф-варден залишає тебе пораненим, але живим — і призначає фінальний двобій."}}},shadows_scatter:{base:{narrative:"Сирени розквітають, провулки ковтає дим. {protagonist} стріляє навмання, {rival} губиться в тіні, поки {witness} витягує поранених до прибуття дронів.",logLine:"Вам вдається вислизнути, але частоти CorpSec гудуть новими наказами посилити патрулі."}}}}},logs:{"storylets.firelight_ambush.log.wounded":"Ліра підтримує тебе й клянеться, що наступний патруль не встигне підняти тривогу.","storylets.firelight_ambush.log.clean":"Осередок святкує чисту операцію й занотовує нові прогалини у патрулях.","storylets.neon_bivouac.log.bonded":"Довірена особа ділиться спогадами Gridfall, і вогник знову обіцяє тепло.","storylets.neon_bivouac.log.distance":"Розмови біля вогню уривчасті — нерви надто натягнуті для спогадів.","storylets.serrated_omen.log.rival":"Сераф-варден залишає тебе пораненим, але живим, і призначає фінальний двобій.","storylets.serrated_omen.log.default":"Вам вдається вислизнути, але частоти CorpSec гудуть новими наказами посилити патрулі."}},Cc={en:ha,uk:xc},pa=e=>Cc[e]??ha,Nt=(e,t)=>e.replace(/\{([\w\d_]+)\}/g,(i,s)=>t[s]??`{${s}}`),kc=(e,t)=>!t||!e.variants?e.base:e.variants[t]??e.base,zs={entries:{},lastSeenByLocation:{},queue:[]},ma=Q({name:"storylets",initialState:zs,reducers:{enqueueStorylet(e,t){const{resolution:i,queueItem:s,locationId:n}=t.payload,a=e.entries[i.storyletId]??{storyletId:i.storyletId,lastTriggeredAt:null,cooldownExpiresAt:null,timesTriggered:0};a.lastTriggeredAt=i.timestamp,a.cooldownExpiresAt=i.cooldownExpiresAt,a.timesTriggered+=1,e.entries[i.storyletId]=a,n&&(e.lastSeenByLocation[n]=i.storyletId),e.queue.push(s)},dequeueStorylet(e,t){const i=t.payload;if(!i){e.queue.shift();return}e.queue=e.queue.filter(s=>s.id!==i)},clearStorylets:()=>zs}}),{enqueueStorylet:Tc,dequeueStorylet:vg,clearStorylets:bg}=ma.actions,Rc=ma.reducer,Ec=(e,t,i)=>{var o;const s=Ac(t.missions.currentLevelIndex),n=e.locationId??((o=t.world.currentMapArea)==null?void 0:o.id),a=new Set(e.tags??[]);e.type==="patrolAmbush"&&a.add("ambush"),e.type==="campfireRest"&&(a.add("rest"),a.add("relationship"));const r=t.player.data;return r.maxHealth>0&&r.health<r.maxHealth*.7&&a.add("injury"),{type:e.type,arc:s,timestamp:i,locationId:n,missionId:e.missionId,tags:Array.from(a)}},_c=e=>({entries:{...e.entries},lastSeenByLocation:{...e.lastSeenByLocation}}),Dc=(e,t)=>{const s=pa(t).plays[e.storyletId],n={},a={};Object.entries(e.resolvedRoles).forEach(([u,h])=>{n[u]=h.name,a[u]={id:h.id,name:h.name,relationship:h.relationship}});const r=s==null?void 0:s.outcomes[e.branch.id],o=r?kc(r,e.outcome.variantKey):void 0,l=o?Nt(o.narrative,n):"",c=o!=null&&o.epilogue?Nt(o.epilogue,n):void 0,d=o!=null&&o.logLine?Nt(o.logLine,n):void 0;return{id:se(),storyletId:e.storyletId,branchId:e.branch.id,title:(s==null?void 0:s.title)??e.play.id,synopsis:(s==null?void 0:s.synopsis)??"",narrative:l,epilogue:c,logLine:d,resolvedRoles:a,triggeredAt:e.timestamp,locale:t,outcomeLocalizationKey:e.outcome.localizationKey,variantKey:e.outcome.variantKey}},Lc=(e,t,i,s)=>{const n=pa(t),a={};Object.entries(e.resolvedRoles).forEach(([r,o])=>{a[r]=o.name}),e.outcome.effects.forEach(r=>{switch(r.type){case"log":{const o=n.logs[r.logKey]??e.play.titleKey??r.logKey,l=Nt(o,a);i(be(l));break}case"faction":{if(!s)break;i(Oo({factionId:r.factionId,delta:r.delta,reason:r.reason??"storylet",source:e.storyletId}));break}case"playerHealth":{i(Bo(r.delta));break}case"traitDelta":{r.target==="player"&&i(No({trait:r.trait,delta:r.delta,source:e.storyletId}));break}}})},wg=e=>(t,i)=>{var h;const s=i(),n=Date.now(),a=((h=s.settings)==null?void 0:h.locale)??Ae,r=Ec(e,s,n),o=_c(s.storylets),l=Ic(),c=yc({player:s.player.data,npcs:s.world.currentMapArea.entities.npcs}),d=Mc({plays:l,runtime:o,trigger:r,actorPool:c,now:n,locationId:r.locationId});if(!d)return;Lc(d,a,t,!!s.settings.reputationSystemsEnabled);const u=Dc(d,a);t(Tc({resolution:d,queueItem:u,locationId:r.locationId}))},Ri=(e,t,i)=>!Number.isFinite(e)||e<t?t:e>i?i:e,Pg=e=>{if(!Number.isFinite(e))return 0;const t=e%360;return t<0?t+360:t},Mg=(e,t)=>!Number.isFinite(e)||!Number.isFinite(t)?0:(t-e+540)%360-180,Ag=(e,t,i)=>!Number.isFinite(e)||!Number.isFinite(t)||!Number.isFinite(i)?e:e+(t-e)*i,Ig=e=>Number.isFinite(e)?e*(180/Math.PI):0,ga=(e,t,i)=>`${e}:${t}:${i}`,ye=e=>Ri(e,0,1),fa=e=>{const{baseCertainty:t,distanceModifier:i,lightingModifier:s,disguiseModifier:n,postureModifier:a}=e,r=t*ye(i)*ye(s)*ye(n)*ye(a);return ye(r)},Fc=(e,t)=>{var s;const i=fa(e);return{id:ga(e.witnessId,e.targetId,e.recognitionChannel),witnessId:e.witnessId,witnessLabel:e.witnessLabel??e.witnessId,targetId:e.targetId,zoneId:e.zoneId,areaId:e.areaId,source:e.source,recognitionChannel:e.recognitionChannel,certainty:i,halfLifeSeconds:t.halfLifeSeconds,firstSeenAt:e.timestamp,lastSeenAt:e.timestamp,reinforcedAt:void 0,reported:e.reported??!1,suppressed:((s=e.existing)==null?void 0:s.suppressed)??!1,proximityWeight:ye(e.distanceModifier),location:e.location}},Bc=(e,t,i)=>{var r;const s=fa(t),n=s*i.reinforcementBonus,a=ye(Math.max(e.certainty,s)+n);return{...e,witnessLabel:t.witnessLabel??e.witnessLabel??e.witnessId,certainty:a,lastSeenAt:t.timestamp,reinforcedAt:t.timestamp,reported:e.reported||t.reported,suppressed:((r=t.existing)==null?void 0:r.suppressed)??e.suppressed,proximityWeight:ye(Math.max(e.proximityWeight,t.distanceModifier)),location:t.location??e.location}},Oc=(e,t,i)=>{if(t<=0||e.certainty<=0)return{memory:{...e},pruned:e.certainty<i.certaintyFloor};const s=e.halfLifeSeconds>0?e.halfLifeSeconds:i.halfLifeSeconds,n=t/s,a=Math.pow(.5,n);let r=ye(e.certainty*a);e.suppressed&&(r*=i.suppressionPenalty);const o=r<i.certaintyFloor;return{memory:{...e,certainty:r},pruned:o}},Us=e=>({id:e.id,witnessId:e.witnessId,witnessLabel:e.witnessLabel,targetId:e.targetId,zoneId:e.zoneId,areaId:e.areaId,source:e.source,recognitionChannel:e.recognitionChannel,certainty:e.certainty,halfLifeSeconds:e.halfLifeSeconds,firstSeenAt:e.firstSeenAt,lastSeenAt:e.lastSeenAt,reinforcedAt:e.reinforcedAt,reported:e.reported,suppressed:e.suppressed,proximityWeight:e.proximityWeight}),Ei=e=>({id:e.id,witnessId:e.witnessId,witnessLabel:e.witnessLabel,targetId:e.targetId,zoneId:e.zoneId,areaId:e.areaId,source:e.source,recognitionChannel:e.recognitionChannel,certainty:e.certainty,halfLifeSeconds:e.halfLifeSeconds,firstSeenAt:e.firstSeenAt,lastSeenAt:e.lastSeenAt,reinforcedAt:e.reinforcedAt,reported:e.reported,suppressed:e.suppressed,proximityWeight:e.proximityWeight}),Nc=(e,t)=>{const i=Math.pow(Ri(e.proximityWeight,0,1),t.proximityExponent),s=e.reported?t.reportMultiplier:1;return Ri(e.certainty*i*s,0,1.5)},Hc=(e,t)=>e>=t.tierThresholds.crackdown?"crackdown":e>=t.tierThresholds.tracking?"tracking":"calm",Wc=(e,t,i)=>{if(t.length===0)return{zoneId:e,totalHeat:0,tier:"calm",leadingWitnessIds:[]};const s=t.filter(c=>c.suppressed?!1:c.certainty>=i.certaintyFloor);if(s.length===0)return{zoneId:e,totalHeat:0,tier:"calm",leadingWitnessIds:[]};const n=s.map(c=>({memory:c,weight:Nc(c,i)})).sort((c,d)=>d.weight-c.weight),a=i.topK>0?i.topK:5,r=n.slice(0,a),o=r.reduce((c,d)=>c+d.weight,0),l=Hc(o,i);return{zoneId:e,totalHeat:o,tier:l,leadingWitnessIds:r.map(c=>c.memory.id)}},_i=3600,Ut={id:"default",label:"Baseline Urban Patrols",halfLifeSeconds:72*_i,certaintyFloor:.05,reinforcementBonus:.4,reportMultiplier:1.25,suppressionPenalty:.4,topK:5,proximityExponent:.85,tierThresholds:{tracking:.4,crackdown:.75}},qc={downtown:{...Ut,id:"downtown",label:"Downtown Grid Hyper-Patrol",halfLifeSeconds:60*_i,reportMultiplier:1.35,topK:6},industrial:{...Ut,id:"industrial",label:"Industrial Wasteland Patrol",halfLifeSeconds:96*_i,suppressionPenalty:.55}},Di=e=>e?qc[e]??Ut:Ut,Li=1,Gc=(e,t)=>({zoneId:e,memories:{},heat:{zoneId:e,totalHeat:0,tier:"calm",leadingWitnessIds:[]},lastUpdatedAt:t,lastObservationAt:null}),ns=()=>({version:Li,zones:{},paused:!1,lastTickAt:null}),Vc=ns(),Ks=e=>{switch(e){case"calm":return 0;case"tracking":return 1;case"crackdown":return 2;default:return 0}},Ct=e=>{const t=Di(e.zoneId),i=Object.values(e.memories).map(s=>Ei(s));return Wc(e.zoneId,i,t)},ya=Q({name:"suspicion",initialState:Vc,reducers:{ingestObservation:(e,t)=>{if(e.paused)return;const i=t.payload,s=i.zoneId,n=i.witnessLabel??i.witnessId,a=i.timestamp,r=e.zones[s]??(e.zones[s]=Gc(s,a)),o=Di(s),l=ga(i.witnessId,i.targetId,i.recognitionChannel),c=r.memories[l],d=c?Ei(c):void 0,u={...i,witnessLabel:n,existing:d},h=d?Bc(d,u,o):Fc(u,o);r.memories[l]=Us(h),r.heat=Ct(r),r.lastObservationAt=a,r.lastUpdatedAt=a,e.lastTickAt=a},applySuspicionDecay:(e,t)=>{if(e.paused)return;const{elapsedSeconds:i,timestamp:s}=t.payload;i<=0||(Object.values(e.zones).forEach(n=>{const a=Di(n.zoneId),r={};let o=!1;Object.entries(n.memories).forEach(([l,c])=>{const d=Ei(c),{memory:u,pruned:h}=Oc(d,i,a);if(h){o=!0;return}o=o||u.certainty!==c.certainty,r[l]=Us(u)}),o&&(n.memories=r,n.heat=Ct(n),n.lastUpdatedAt=s)}),e.lastTickAt=s)},setSuspicionPaused:(e,t)=>{e.paused=t.payload},suppressWitnessMemory:(e,t)=>{const{zoneId:i,memoryId:s,suppressed:n}=t.payload,a=e.zones[i];if(!a)return;const r=a.memories[s];r&&r.suppressed!==n&&(a.memories[s]={...r,suppressed:n},a.heat=Ct(a))},purgeWitnessMemories:(e,t)=>{const{witnessId:i,zoneId:s}=t.payload;(s?[s]:Object.keys(e.zones)).forEach(a=>{const r=e.zones[a];if(!r)return;const o=Object.keys(r.memories).length;if(o===0)return;const l={};Object.entries(r.memories).forEach(([c,d])=>{d.witnessId!==i&&(l[c]=d)}),Object.keys(l).length!==o&&(r.memories=l,r.heat=Ct(r))})},resetSuspicionState:()=>ns()}}),{ingestObservation:xg,applySuspicionDecay:Sa,setSuspicionPaused:Cg,suppressWitnessMemory:kg,purgeWitnessMemories:Tg,resetSuspicionState:Rg}=ya.actions,Eg=e=>{let t="calm";return Object.values(e).forEach(i=>{Ks(i.heat.tier)>Ks(t)&&(t=i.heat.tier)}),t},zc=ya.reducer,Uc={status:"idle",reason:null,lastDecision:null},va=Q({name:"autoBattle",initialState:Uc,reducers:{setAutoBattleStatus:(e,t)=>{e.status=t.payload.status,e.reason=t.payload.reason??null,e.status!=="running"&&(e.lastDecision=e.lastDecision?{...e.lastDecision,timestamp:Date.now()}:e.lastDecision)},recordAutoBattleDecision:(e,t)=>{e.lastDecision=t.payload,e.status="running",e.reason=null},clearAutoBattleDecision:e=>{e.lastDecision=null}}}),{setAutoBattleStatus:js,recordAutoBattleDecision:Kc,clearAutoBattleDecision:_g}=va.actions,jc=va.reducer,Ht=e=>Math.max(En,Math.min(_n,e)),hi=e=>{const t=Ht(e),i=ir.find(s=>t>=s.min&&t<=s.max);return(i==null?void 0:i.tier)??"calm"},Fi=1,ba=()=>({version:Fi,value:12,tier:"calm",lastUpdatedAt:null,frozen:!1,respiteUntil:null,decayBoostUntil:null,decayBoostPerSecond:0,cooldowns:{},lastSnapshot:null}),$c=ba(),Yc=()=>Q({name:"paranoia",initialState:$c,reducers:{resetParanoiaState:()=>ba(),tickParanoia:(e,t)=>{const{deltaMs:i,timestamp:s,decayMultiplier:n}=t.payload;if(e.frozen||i<=0){e.lastUpdatedAt=s;return}const a=Math.max(0,i)/1e3;if(a===0){e.lastUpdatedAt=s;return}const r=Math.max(0,n??1);let o=sr*r;e.decayBoostUntil&&s<e.decayBoostUntil?o+=Math.max(0,e.decayBoostPerSecond):e.decayBoostUntil&&s>=e.decayBoostUntil&&(e.decayBoostUntil=null,e.decayBoostPerSecond=0);const l=a*o;if(l>0){const c=Ht(e.value-l);e.value=c,e.tier=hi(c),e.lastSnapshot={timestamp:s,delta:-l,breakdown:{gains:{},losses:{passive:l},spikes:{}},value:c,tier:e.tier}}e.lastUpdatedAt=s},applyParanoiaStimuli:(e,t)=>{const{timestamp:i,delta:s,breakdown:n,deltaMs:a}=t.payload;if(!Number.isFinite(s)||s===0&&!n)return;let r=s;e.frozen&&r>0&&(r=0);const c=1.1*Math.max(.1,(a??1e3)/1e3);r>0&&e.respiteUntil&&i<e.respiteUntil&&(r=Math.min(r,tr.respite.maxGainPerTick)),r=Math.max(-c,Math.min(c,r));const d=Ht(e.value+r);e.value=d,e.tier=hi(d),e.lastUpdatedAt=i,n&&(e.lastSnapshot={timestamp:i,delta:r,breakdown:n,value:d,tier:e.tier})},applyParanoiaRelief:(e,t)=>{const{amount:i,timestamp:s,cooldownKey:n,cooldownMs:a}=t.payload,r=Math.max(0,i);if(r===0)return;if(n&&a){const l=e.cooldowns[n];if(typeof l=="number"&&l>s)return;e.cooldowns[n]=s+a}const o=Ht(e.value-r);e.value=o,e.tier=hi(o),e.lastUpdatedAt=s,e.lastSnapshot={timestamp:s,delta:-r,breakdown:{gains:{},losses:{relief:r},spikes:{}},value:o,tier:e.tier}},setParanoiaRespite:(e,t)=>{const{durationMs:i,timestamp:s}=t.payload,n=Math.max(0,i);e.respiteUntil=s+n},setParanoiaDecayBoost:(e,t)=>{const{amountPerSecond:i,durationMs:s,timestamp:n}=t.payload;if(i<=0||s<=0){e.decayBoostUntil=null,e.decayBoostPerSecond=0;return}e.decayBoostPerSecond=i,e.decayBoostUntil=n+s},setParanoiaFrozen:(e,t)=>{e.frozen=t.payload},clearParanoiaSnapshot:e=>{e.lastSnapshot=null}}}),wa=Yc(),{resetParanoiaState:Zc,tickParanoia:Dg,applyParanoiaStimuli:Lg,applyParanoiaRelief:Fg,setParanoiaRespite:Bg,setParanoiaDecayBoost:Og,setParanoiaFrozen:Ng,clearParanoiaSnapshot:Hg}=wa.actions,Pa=wa.reducer,vt=["heroic","cruel","sneaky","intimidating","competent"],Bi=1,Xc={heroic:60*45,cruel:60*50,sneaky:60*35,intimidating:60*40,competent:60*55},Qc=.45,Jc=.25,$s=5,ht=100,Ys=60*90,ed=.1,td=5,Zs=6,Ue={minor:.4,moderate:.65,major:.85,legendary:1},id=.1,sd=vt.reduce((e,t)=>(e[t]=0,e),{}),Xs=12,_=(e,t,i)=>Number.isFinite(e)?Math.max(t,Math.min(i,e)):t,Qs=(e,t,i)=>e+(t-e)*i,Ma=(e,t)=>{const i=e.x-t.x,s=e.y-t.y;return Math.sqrt(i*i+s*s)},as=e=>{const t=Math.floor(e.x/Xs),i=Math.floor(e.y/Xs);return`${t}:${i}`},nd=(e,t,i,s)=>{const n=t.x-e.x,a=t.y-e.y,r=Math.sqrt(n*n+a*a),o=Math.max(1,Math.floor(r/i));for(let l=1;l<=o;l+=1){const c=l/(o+1);s({x:Qs(e.x,t.x,c),y:Qs(e.y,t.y,c)})}},ad=(e,t,i)=>{let s=0,n=0;const a=o=>{if(!o){s+=1;return}!o.isWalkable||o.type===R.WALL?s+=1:o.type===R.DOOR&&(s+=.5)};if(nd(t,i,1.25,o=>{var d;const l=Math.round(o.x),c=Math.round(o.y);a((d=e.tiles[c])==null?void 0:d[l]),n+=1}),n===0)return 1;const r=s/n;return _(1-r,.1,1)},kt={base:.7,noiseLevel:.6,lightingFactor:.85,disguiseFactor:.8},rd=e=>({base:_((e==null?void 0:e.base)??kt.base,0,1),noiseLevel:_((e==null?void 0:e.noiseLevel)??kt.noiseLevel,0,1),lightingFactor:_((e==null?void 0:e.lightingFactor)??kt.lightingFactor,0,1),disguiseFactor:_((e==null?void 0:e.disguiseFactor)??kt.disguiseFactor,0,1),crowdDensity:_((e==null?void 0:e.crowdDensity)??.5,0,1)}),od=e=>vt.reduce((t,i)=>{const s=e[i];return typeof s=="number"&&Number.isFinite(s)&&s!==0&&(t[i]=_(s,-30,30)),t},{}),ld=e=>{const t=se(),i=typeof e.timestamp=="number"?e.timestamp:Date.now(),s=e.cellId??as(e.position),n=rd(e.visibility),a=Ue[e.intensity]??Ue.minor,r=od(Object.keys(e.traits??{}).reduce((o,l)=>{var c;if(vt.includes(l)){const d=l;o[d]=_(((c=e.traits)==null?void 0:c[d])??0,-40,40)*a}return o},{}));return{id:t,actorId:e.actorId,actorLabel:e.actorLabel??"Player",zoneId:e.zoneId,cellId:s,position:{...e.position},intensity:e.intensity,traits:r,tags:[...e.tags],timestamp:i,visibility:n,metadata:e.metadata?{...e.metadata}:void 0}},cd=24,Js={resistance:{heroic:1,cruel:-.6,sneaky:.25,intimidating:-.1,competent:.5},corpsec:{heroic:-.2,cruel:.4,sneaky:-.4,intimidating:.8,competent:.6},scavengers:{heroic:.2,cruel:.1,sneaky:.8,intimidating:.3,competent:.4},civilians:{heroic:.8,cruel:-.8,sneaky:-.1,intimidating:-.2,competent:.4}},dd=(e,t)=>{var a,r,o;const i=e.reputationBias??Js[t??""]??Js.civilians,s=(a=e.socialTags)!=null&&a.includes("gossip_hub")?.35:.55,n=(r=e.socialTags)!=null&&r.includes("gossip_hub")?.75:(o=e.socialTags)!=null&&o.includes("guard")?.25:.5;return{traitWeights:{...i},skepticism:_(s,.15,.85),appetiteForRumors:_(n,.15,.9)}},ud=(e,t)=>{var i,s,n;return e.factionId?e.factionId:(i=e.socialTags)!=null&&i.includes("corpsec")?"corpsec":(s=e.socialTags)!=null&&s.includes("scavenger")?"scavengers":(n=e.socialTags)!=null&&n.includes("resistance")?"resistance":t},hd=(e,t)=>_(e*t,.2,1.1),pd=(e,t)=>_(e-(typeof t=="number"?t:0),.25,1),md=({visibilityScore:e,distanceFactor:t,lineOfSight:i,npc:s})=>{var r,o;const n=(r=s.socialTags)!=null&&r.includes("sentinel")?.15:(o=s.socialTags)!=null&&o.includes("guard")?.1:0,a=e*.65+t*.2+i*.15+n;return _(a,0,1)},gd=({event:e,mapArea:t,npcs:i,ambientLighting:s,ambientNoise:n,disguisePenalty:a,maxDistance:r=cd,visibilityThreshold:o=Qc})=>{const l=i??t.entities.npcs;return l.length?l.map(c=>{var A;const d=Ma(c.position,e.position);if(d>r)return null;const u=_(1-d/(r+1),0,1),h=ad(t,c.position,e.position),g=hd(s,e.visibility.lightingFactor),p=_(n*.35+e.visibility.noiseLevel*.65,.1,1),m=pd(e.visibility.disguiseFactor,a),f=_(e.visibility.base*u*h*g*(.5+p*.5)*(1-(1-m)*.6),0,1);if(f<Jc)return null;const w=ud(c,((A=t.factionRequirement)==null?void 0:A.factionId)??null),v=dd(c,w),M=md({visibilityScore:f,distanceFactor:u,lineOfSight:h,npc:c}),b=f<o;return{witnessId:c.id,name:c.name,factionId:w,zoneId:e.zoneId,cellId:as(c.position),position:{...c.position},distance:d,lineOfSight:h,distanceFactor:u,lightingFactor:g,noiseFactor:p,disguiseFactor:m,visibilityScore:f,baseConfidence:M,isRumorOnly:b,bias:v}}).filter(c=>!!c).sort((c,d)=>d.visibilityScore-c.visibilityScore):[]},fd=(e,t,i)=>{var n;const s=(n=t.traitWeights)==null?void 0:n[e];return typeof s=="number"&&s!==0?i*s:i},yd=(e,t,i,s)=>{const n=i?.45+(1-s.appetiteForRumors)*.3:0,r=e*_(t/30,.25,1)*(1-s.skepticism)*(1-n);return _(r,0,1)},Sd=(e,t,i,s)=>{if(t===0)return null;const n=yd(i,Math.abs(t),s.isRumorOnly,s.bias);return n<id?null:{trait:e,delta:t,confidence:n,source:s.isRumorOnly?"rumor":"witness"}},vd=({event:e,candidates:t,timestamp:i})=>{if(!t.length)return[];const s=e.traits??{},n=Ue[e.intensity]??Ue.minor,a=typeof i=="number"?i:e.timestamp;return t.map(r=>{const o=_(r.baseConfidence*(r.isRumorOnly?.65:1),0,1),l=Object.entries(s).map(([d,u])=>{const h=d,g=fd(h,r.bias,u??0)*n*(r.isRumorOnly?.6:1);return Sd(h,g,o,r)}).filter(d=>d?d.delta!==0:!1);if(!l.length)return null;const c=_(l.reduce((d,u)=>d+u.confidence,0)/l.length,0,1);return{id:se(),eventId:e.id,witnessId:r.witnessId,witnessName:r.name,factionId:r.factionId,zoneId:r.zoneId,cellId:r.cellId,timestamp:a,visibilityScore:r.visibilityScore,confidence:c,isRumorOnly:r.isRumorOnly,traits:l}}).filter(r=>!!r)},Aa=22,bd=5,wd=(e,t,i)=>({id:`${e}::${t}`,fromId:e,toId:t,weight:_(i,.05,1),latencySeconds:_(60*(1.2-i),20,120),remainingEnergy:Zs*i,maxEnergy:Zs,lastSharedAt:null}),Pd=(e,t,i)=>{var a;let s=_(1-i/(Aa+1),0,1);const n=(a=e.socialTags)==null?void 0:a.filter(r=>{var o;return(o=t.socialTags)==null?void 0:o.includes(r)});return n!=null&&n.length&&(s+=n.length*.08),e.factionId&&t.factionId&&e.factionId===t.factionId&&(s+=.15),_(s,0,1)},Md=({mapArea:e,npcs:t})=>{const i=t??e.entities.npcs;if(i.length<2)return[];const s=[];return i.forEach(n=>{i.filter(r=>r.id!==n.id).map(r=>{const o=Ma(n.position,r.position);if(o>Aa)return null;const l=Pd(n,r,o);return l<=0?null:{other:r,weight:l}}).filter(r=>!!r).sort((r,o)=>o.weight-r.weight).slice(0,bd).forEach(({other:r,weight:o})=>{s.push(wd(n.id,r.id,o))})}),s},Ad=(e,t)=>{const i=_(Math.abs(e)/ht,0,1);return _(i*t,0,1)},Id=(e,t,i)=>`${e}:${t}:${i}`,xd=(e,t)=>{if(!t.length)return[];const i={},s=Ue[e.intensity]??Ue.minor;return t.forEach(n=>{n.traits.forEach(a=>{const r=Ad(a.delta,a.confidence)*s;if(r<=ed)return;const o=n.witnessId,l=a.delta>=0?1:-1;i[o]||(i[o]={carrierId:o,cellId:n.cellId,zoneId:n.zoneId,rumors:[]});const c=Id(o,a.trait,e.id);i[o].rumors.push({id:c,eventId:e.id,originWitnessId:n.witnessId,carrierId:o,trait:a.trait,polarity:l,strength:_(r,0,1),confidence:_(a.confidence,0,1),ttlSeconds:Ys,decayRate:1/Ys,lastUpdatedAt:n.timestamp,originCellId:n.cellId,originZoneId:n.zoneId,intensity:e.intensity})})}),Object.values(i).map(n=>({...n,rumors:n.rumors.slice(0,td)}))},Cd=()=>{const e=Date.now();return vt.reduce((t,i)=>(t[i]={value:sd[i]??0,confidence:0,lastUpdatedAt:e,decaySeconds:Xc[i]??60*45,sources:[]},t),{})},kd=(e,t,i,s,n,a)=>({id:e,scope:t,label:i,factionId:n,cellId:a,traits:Cd(),updatedAt:s}),Td={version:Bi,events:{},witnessRecords:{},recordsByEvent:{},profiles:{},carriers:{},edges:{},debug:{heatmapEnabled:!1},lastTickAt:null},Rd=(e,t,i,s,n,a,r)=>{let o=e.profiles[t];return o||(o=kd(t,s,i,n,a,r),e.profiles[t]=o),o},Ed=(e,t,i)=>{const s=e.traits[t.trait];s&&(s.value=_(s.value+t.delta,-ht,ht),s.confidence=_(s.confidence+t.confidence*(1-s.confidence*.5),0,1),s.lastUpdatedAt=i,t.sourceRecordId&&(s.sources.unshift(t.sourceRecordId),s.sources.length>$s&&(s.sources.length=$s)),e.updatedAt=i)},en=(e,t,i)=>{t.forEach(s=>{const n=s.scopeId,a=s.scope==="witness"?`Witness::${s.scopeId}`:s.scope==="cell"?`Cell ${s.scopeId}`:`Faction ${s.scopeId}`,r=Rd(e,n,a,s.scope,i,s.scope==="faction"?s.factionId:null,s.scope==="cell"?s.cellId:null);Ed(r,s,i)})},tn=(e,t)=>{t.forEach(i=>{e.carriers[i.carrierId]={carrierId:i.carrierId,cellId:i.cellId,zoneId:i.zoneId,rumors:i.rumors.map(s=>({...s}))}})},sn=(e,t)=>{t.forEach(i=>{const s=e.edges[i.id];e.edges[i.id]=s?{...s,remainingEnergy:i.remainingEnergy,lastSharedAt:i.lastSharedAt??s.lastSharedAt}:{...i}})},_d=(e,t,i)=>{vt.forEach(s=>{const n=e.traits[s];if(!n)return;const a=_(t/n.decaySeconds,0,1);if(a<=0)return;const r=n.value*a*.5;n.value=_(n.value-r,-ht,ht),n.confidence=_(n.confidence*(1-a*.6),0,1),n.lastUpdatedAt=i,Math.abs(n.value)<.01&&(n.value=0),n.confidence<.02&&(n.confidence=0,n.sources=[])}),e.updatedAt=i},nn=e=>{Object.entries(e.carriers).forEach(([t,i])=>{i.rumors.length||delete e.carriers[t]})},Ia=Q({name:"reputation",initialState:Td,reducers:{applyEventIntegration:(e,t)=>{const{event:i,records:s,profileMutations:n,carriers:a,edges:r}=t.payload;e.events[i.id]=i,e.recordsByEvent[i.id]=s.map(o=>o.id),s.forEach(o=>{e.witnessRecords[o.id]=o}),en(e,n,i.timestamp),tn(e,a),sn(e,r),nn(e),e.lastTickAt=i.timestamp},applyDecay:(e,t)=>{const{timestamp:i,elapsedSeconds:s}=t.payload;Object.values(e.profiles).forEach(n=>_d(n,s,i)),Object.values(e.edges).forEach(n=>{n.remainingEnergy=_(Math.min(n.remainingEnergy+s*.05,n.maxEnergy),0,n.maxEnergy)}),e.lastTickAt=i},applyPropagationResult:(e,t)=>{const{carriers:i,edges:s,profileMutations:n}=t.payload;tn(e,i),sn(e,s),nn(e);const a=Date.now();en(e,n,a),e.lastTickAt=a},toggleReputationHeatmap:(e,t)=>{e.debug.heatmapEnabled=t.payload},setInspectorTarget:(e,t)=>{e.debug.inspectorTargetId=t.payload}}}),{applyEventIntegration:Dd,applyDecay:Wg,applyPropagationResult:qg,toggleReputationHeatmap:Gg,setInspectorTarget:Vg}=Ia.actions,Oi=Ia.reducer,Ld=(e,t)=>{const i=t==="night"?.55:t==="evening"||t==="morning"?.75:1;return e.flags.blackoutTier==="rolling"?i*.4:e.flags.blackoutTier==="brownout"?i*.65:i},Fd=e=>{switch(e.flags.gangHeat){case"high":return .85;case"med":return .7;default:return .55}},Bd=e=>{var a;const t=((a=e.skillTraining)==null?void 0:a.stealth)??0,i=e.skills.agility??5,s=Math.min(t/160,.25),n=Math.max(0,(i-6)*.03);return _(.4-(s+n),0,.4)},Od=e=>{const t=[];return e.forEach(i=>{i.traits.forEach(s=>{const n=s.confidence;t.push({scopeId:i.witnessId,scope:"witness",factionId:i.factionId,cellId:i.cellId,trait:s.trait,delta:s.delta,confidence:s.confidence,sourceRecordId:i.id,witnessId:i.witnessId}),i.factionId&&t.push({scopeId:i.factionId,scope:"faction",factionId:i.factionId,cellId:null,trait:s.trait,delta:s.delta*(.55+n*.2),confidence:s.confidence*.7,sourceRecordId:i.id,witnessId:i.witnessId}),t.push({scopeId:i.cellId,scope:"cell",factionId:i.factionId,cellId:i.cellId,trait:s.trait,delta:s.delta*(.7+n*.15),confidence:s.confidence*.8,sourceRecordId:i.id,witnessId:i.witnessId})})}),t},zg=e=>(t,i)=>{const s=i();if(!s.settings.reputationSystemsEnabled)return;const n=s.world,a=s.player.data,r=e.mapArea??n.currentMapArea,o=e.ambientLighting??Ld(n.environment,n.timeOfDay),l=e.ambientNoise??Fd(n.environment),c=e.disguisePenalty??Bd(a),d=ld({...e,zoneId:e.zoneId??r.zoneId??n.currentMapArea.zoneId,cellId:e.cellId??as(e.position)}),u=gd({event:d,mapArea:r,npcs:e.npcsOverride,ambientLighting:o,ambientNoise:l,disguisePenalty:c});if(!u.length)return;const h=vd({event:d,candidates:u,timestamp:d.timestamp}),g=Od(h),p=xd(d,h),m=Md({mapArea:r});t(Dd({event:d,records:h,profileMutations:g,carriers:p,edges:m}))},Nd={override:null},xa=Q({name:"hudLayout",initialState:Nd,reducers:{setHudLayoutOverride:(e,t)=>{e.override=t.payload},clearHudLayoutOverride:e=>{e.override=null}}}),{setHudLayoutOverride:Ug,clearHudLayoutOverride:Kg}=xa.actions,Hd=xa.reducer;var Wd={};const rs="the-getaway-state",Ca=typeof window<"u",an=typeof process<"u"&&typeof Wd.JEST_WORKER_ID<"u",qd={player:Wo,world:ia,quests:Rl,log:oc,settings:oa,autoBattle:jc,combatFeedback:hc,missions:ac,surveillance:da,storylets:Rc,suspicion:zc,paranoia:Pa,reputation:Oi,hudLayout:Hd},Ye=nr(qd),Gd=ar("app/resetGame"),jg=rs,Tt=(e,t)=>Array.isArray(e)?[...e]:[...t],Vd=e=>{if(!e)return{...V,version:dt,data:{...V.data,perks:[...V.data.perks],perkRuntime:{...V.data.perkRuntime},factionReputation:{...V.data.factionReputation}},pendingLevelUpEvents:[...V.pendingLevelUpEvents],xpNotifications:[...V.xpNotifications],pendingFactionEvents:[...V.pendingFactionEvents]};const t=e.data??null,i={...V.data,...t??{},perks:Tt(t==null?void 0:t.perks,V.data.perks),perkRuntime:{...V.data.perkRuntime,...(t==null?void 0:t.perkRuntime)??{}},factionReputation:{...V.data.factionReputation,...(t==null?void 0:t.factionReputation)??{}}};return{version:dt,data:i,pendingLevelUpEvents:Tt(e.pendingLevelUpEvents,V.pendingLevelUpEvents),xpNotifications:Tt(e.xpNotifications,V.xpNotifications),pendingFactionEvents:Tt(e.pendingFactionEvents,V.pendingFactionEvents)}},zd=e=>{if(!e||e.version!==Fi)return Pa(void 0,Zc());const t=typeof e.value=="number"?e.value:0,i=Number.isFinite(t)?t:0,s=Math.max(En,Math.min(_n,i)),n=Number.isFinite(e.decayBoostPerSecond)?Math.max(0,e.decayBoostPerSecond):0;return{version:Fi,value:s,tier:e.tier??"calm",lastUpdatedAt:typeof e.lastUpdatedAt=="number"?e.lastUpdatedAt:null,frozen:!!e.frozen,respiteUntil:typeof e.respiteUntil=="number"?e.respiteUntil:null,decayBoostUntil:typeof e.decayBoostUntil=="number"?e.decayBoostUntil:null,decayBoostPerSecond:n,cooldowns:{...e.cooldowns??{}},lastSnapshot:e.lastSnapshot??null}},Ud=e=>({zoneId:e.zoneId,memories:{...e.memories},heat:{zoneId:e.heat.zoneId,totalHeat:e.heat.totalHeat,tier:e.heat.tier,leadingWitnessIds:[...e.heat.leadingWitnessIds]},lastUpdatedAt:e.lastUpdatedAt,lastObservationAt:e.lastObservationAt}),Kd=e=>{if(!e||e.version!==Li)return ns();const t={};return e.zones&&Object.entries(e.zones).forEach(([i,s])=>{s&&(t[i]=Ud(s))}),{version:Li,zones:t,paused:!!e.paused,lastTickAt:typeof e.lastTickAt=="number"?e.lastTickAt:null}},jd=e=>{if(!e||e.version!==Bi)return Oi(void 0,{type:"@@INIT"});const t=Oi(void 0,{type:"@@INIT"});return{...t,...e,events:{...e.events??{}},witnessRecords:{...e.witnessRecords??{}},recordsByEvent:{...e.recordsByEvent??{}},profiles:{...e.profiles??{}},carriers:{...e.carriers??{}},edges:{...e.edges??{}},debug:{...t.debug,...e.debug??{}},lastTickAt:typeof e.lastTickAt=="number"?e.lastTickAt:null,version:Bi}},$d=e=>{const t=ia(void 0,{type:"@@INIT"});if(!e)return t;const i={...e,environment:{...e.environment,flags:{...e.environment.flags},weather:{...e.environment.weather},signage:{...e.environment.signage},rumorSets:{...e.environment.rumorSets??{}},notes:Array.isArray(e.environment.notes)?[...e.environment.notes]:[...t.environment.notes]}},s=Qn||Ml;return i.currentTime=s,i.timeOfDay=ze(s,W),i.curfewActive=ut(s,W),i},Yd=e=>{const t=da(void 0,{type:"@@INIT"});return e?{zones:e.zones?{...e.zones}:{},hud:{...t.hud,...e.hud??{},overlayEnabled:!0},curfewBanner:e.curfewBanner?{...e.curfewBanner}:{...t.curfewBanner}}:t},Zd=e=>{const t=oa(void 0,{type:"@@INIT"});return e?{...t,...e,visualQualityPreset:e.visualQualityPreset??t.visualQualityPreset}:t},Xd=()=>{if(Ca)try{const e=window.localStorage.getItem(rs);return e?JSON.parse(e):void 0}catch(e){console.warn("[store] Failed to load state from localStorage:",e);return}},Qd=e=>{if(Ca)try{const t=JSON.stringify(e);window.localStorage.setItem(rs,t)}catch(t){console.warn("[store] Failed to save state to localStorage:",t)}},Jd=e=>{if(e)return{...e,player:Vd(e.player),suspicion:Kd(e.suspicion),paranoia:zd(e.paranoia),world:$d(e.world),surveillance:Yd(e.surveillance),reputation:jd(e.reputation),settings:Zd(e.settings)}},eu=(e,t)=>{if(Gd.match(t)){const i=e==null?void 0:e.settings;let s=Ye(void 0,t);return i&&(s=Ye(s,Tl(i.locale)),s=Ye(s,Cl(i.locale)),s=Ye(s,nc(i.locale)),s={...s,settings:i}),s}return Ye(e,t)},tu=Xd(),iu=Jd(tu),D=rr({reducer:eu,preloadedState:iu,middleware:e=>e({serializableCheck:an?!1:{ignoredActions:["app/resetGame"],warnAfter:128},immutableCheck:an?!1:{warnAfter:128}})});D.subscribe(()=>{const e=D.getState(),t={player:e.player,world:e.world,quests:e.quests,log:e.log,settings:e.settings,autoBattle:e.autoBattle,combatFeedback:e.combatFeedback,missions:e.missions,surveillance:e.surveillance,storylets:e.storylets,suspicion:e.suspicion,paranoia:e.paranoia,reputation:e.reputation,hudLayout:e.hudLayout};Qd(t)});const pi=1023,N=Object.freeze({TILE_BASE:0,TILE_OVERLAY:48,PROP_LOW:96,PROP_TALL:128,CHARACTER_BASE:160,CHARACTER:192,EFFECT:224,FLOATING_UI:256,PATH_PREVIEW:288,OVERLAY:960,DEBUG:992}),He=Object.freeze({BACKDROP:-20,MAP_BASE:-5,VISION_OVERLAY:2,PATH_PREVIEW:4,COVER_DEBUG:5,DAY_NIGHT_OVERLAY:100}),os=(e,t,i=0)=>{const s=(Math.floor(e)&pi)>>>0,n=Math.floor(t),a=P.Math.Clamp(Math.floor(i),-pi,pi);return(n<<10)+s+a};class su{constructor(t){y(this,"registrations",new Map);y(this,"destroyed",!1);this.scene=t,this.handlePreUpdate=this.handlePreUpdate.bind(this),this.destroy=this.destroy.bind(this),this.scene.events.on(P.Scenes.Events.PRE_UPDATE,this.handlePreUpdate),this.scene.events.once(P.Scenes.Events.SHUTDOWN,this.destroy)}registerStatic(t,i){if(this.registrations.has(t))return;const s={target:t,staticDepth:i};this.attachRegistration(t,s),this.applyRegistration(s)}getRegistration(t){return this.registrations.get(t)}refresh(t){const i=this.registrations.get(t);i&&this.applyRegistration(i)}unregister(t){this.registrations.delete(t)}destroy(){this.destroyed||(this.destroyed=!0,this.scene.events.off(P.Scenes.Events.PRE_UPDATE,this.handlePreUpdate),this.scene.events.off(P.Scenes.Events.SHUTDOWN,this.destroy),this.registrations.clear())}upsertDynamic(t,i,s){const n=this.registrations.get(t);if(n){n.dynamicPoint=i,n.dynamicBias=s,n.staticDepth=void 0,this.applyRegistration(n);return}const a={target:t,dynamicPoint:i,dynamicBias:s};this.attachRegistration(t,a),this.applyRegistration(a)}attachRegistration(t,i){this.registrations.set(t,i),t.once(P.GameObjects.Events.DESTROY,()=>this.unregister(t))}handlePreUpdate(){this.destroyed||this.registrations.forEach(t=>{t.dynamicPoint&&this.applyRegistration(t)})}applyRegistration(t){const{target:i,staticDepth:s,dynamicPoint:n}=t;let a=s;n&&(a=os(n.x,n.y,t.dynamicBias??0)),!(a===void 0||a===t.lastApplied)&&(i.setDepth(a),t.lastApplied=a)}}const ka=(e,t,i,s,n)=>{if(e){const a={x:i,y:s};e.upsertDynamic(t,a,n)}else t.setDepth(os(i,s,n))},Fe=(e,t,i)=>Math.max(t,Math.min(i,e)),nu=e=>({r:e>>16&255,g:e>>8&255,b:e&255}),rn=(e,t,i)=>(e&255)<<16|(t&255)<<8|i&255,ue=(e=Xt)=>{const t=e,i=e/2;return{tileWidth:t,tileHeight:i,halfTileWidth:t/2,halfTileHeight:i/2}},de=(e,t,i,s,n=Xt)=>{const a=ue(n),r=(e-t)*a.halfTileWidth+i,o=(e+t)*a.halfTileHeight+s;return{x:r,y:o}},Z=(e,t,i,s)=>{const n=i/2,a=s/2;return[{x:e,y:t-a},{x:e+n,y:t},{x:e,y:t+a},{x:e-n,y:t}]},T=(e,t)=>{const{r:i,g:s,b:n}=nu(e);if(t>=0){const c=Fe(Math.round(i+(255-i)*t),0,255),d=Fe(Math.round(s+(255-s)*t),0,255),u=Fe(Math.round(n+(255-n)*t),0,255);return rn(c,d,u)}const a=Math.max(0,1+t),r=Fe(Math.round(i*a),0,255),o=Fe(Math.round(s*a),0,255),l=Fe(Math.round(n*a),0,255);return rn(r,o,l)};class au{constructor(t,i=Xt,s){y(this,"originX",0);y(this,"originY",0);this.scene=t,this.tileSize=i,this.depthManager=s}assignDepth(t,i,s,n){ka(this.depthManager,t,i,s,n)}setIsoOrigin(t,i){return this.originX=t,this.originY=i,this}createCrate(t,i,s={}){const n=ue(this.tileSize),{x:a,y:r}=de(t,i,this.originX,this.originY,this.tileSize),o=s.scale??.55,l=s.height??.65,c=s.alpha??1,d=s.tint??9262372,u=T(d,.2),h=T(d,-.12),g=T(d,-.35),p=this.scene.add.graphics();p.setAlpha(c);const m=n.tileHeight*l,f=n.tileWidth*o,w=n.tileHeight*o,v=Z(a,r-m,f,w),M=Z(a,r,f,w),b=[M[3],M[0],v[0],v[3]],A=[M[0],M[1],v[1],v[0]];return p.fillStyle(h,1),p.fillPoints(b,!0),p.fillStyle(T(h,-.05),1),p.fillPoints(A,!0),p.fillStyle(u,1),p.fillPoints(v,!0),p.lineStyle(1.2,g,.8),p.strokePoints(M,!0),p.strokePoints(v,!0),this.assignDepth(p,a,r,N.PROP_LOW),p}createHighlightDiamond(t,i,s={}){const{x:n,y:a}=de(t,i,this.originX,this.originY,this.tileSize),r=ue(this.tileSize),o=r.tileWidth*(s.widthScale??1),l=r.tileHeight*(s.heightScale??1),c=s.color??6333946,d=s.alpha??.3,u=Z(n,a,o,l),h=this.scene.add.graphics();return h.fillStyle(c,d),h.fillPoints(u,!0),h.lineStyle(1.5,T(c,.2),d+.2),h.strokePoints(u,!0),this.assignDepth(h,n,a,N.TILE_OVERLAY),h}createCharacterBase(t,i,s={}){const n=this.scene.add.graphics();return this.updateCharacterBase(n,t,i,s),n}createBarricade(t,i,s={}){const n=ue(this.tileSize),{x:a,y:r}=de(t,i,this.originX,this.originY,this.tileSize),o=s.tint??4937059,l=n.tileWidth*(s.widthScale??.9),c=n.tileHeight*.32*(s.height??1),d=n.tileHeight*.34,u=Z(a,r-c,l,d).map(v=>new P.Geom.Point(v.x,v.y)),h=Z(a,r,l,d).map(v=>new P.Geom.Point(v.x,v.y)),g=[h[3],h[0],u[0],u[3]],p=[h[0],h[1],u[1],u[0]],m=[h[1],h[2],u[2],u[1]],f=this.scene.add.graphics();f.fillStyle(o,.96),f.fillPoints(m,!0),f.fillStyle(o,.92),f.fillPoints(g,!0),f.fillStyle(o,.88),f.fillPoints(p,!0),f.lineStyle(1.5,T(o,.18),.9),f.strokePoints(h,!0),f.strokePoints(u,!0);const w=N.PROP_TALL+(s.depthOffset??0);return this.assignDepth(f,a,r,w),f}createStreetLight(t,i,s={}){const n=ue(this.tileSize),{x:a,y:r}=de(t,i,this.originX,this.originY,this.tileSize),o=s.baseColor??988970,l=s.poleColor??1976635,c=s.glowColor??3718648,d=s.height??1.2,u=s.widthScale??.42,h=this.scene.add.container(a,r),g=this.scene.add.graphics(),p=Z(0,0,n.tileWidth*u,n.tileHeight*.32).map(I=>new P.Geom.Point(I.x,I.y));g.fillStyle(o,.95),g.fillPoints(p,!0),g.lineStyle(1.2,T(o,.18),.9),g.strokePoints(p,!0);const m=this.scene.add.graphics(),f=n.tileHeight*(1.8*d),w=Math.max(2,n.tileWidth*.05);m.fillStyle(l,1),m.fillRect(-w/2,-f,w,f),m.setAlpha(.95);const v=this.scene.add.graphics(),M=n.tileWidth*.55,b=n.tileHeight*.3,A=Z(0,-f,M,b).map(I=>new P.Geom.Point(I.x,I.y));v.fillStyle(T(c,-.4),.96),v.fillPoints(A,!0),v.lineStyle(1.2,T(c,.2),.9),v.strokePoints(A,!0);const x=this.scene.add.graphics();return x.fillStyle(c,s.glowAlpha??.22),x.fillEllipse(0,n.tileHeight*.05,n.tileWidth*.9,n.tileHeight*.36),x.setBlendMode(P.BlendModes.ADD),h.add([x,g,m,v]),this.assignDepth(h,a,r,N.PROP_TALL+16),h}createBillboard(t,i,s={}){const n=ue(this.tileSize),{x:a,y:r}=de(t,i,this.originX,this.originY,this.tileSize),o=s.baseColor??1120295,l=s.glowColor??3718648,c=s.panelColor??T(l,-.2),d=s.accentColor??T(l,.25),u=s.widthScale??.9,h=s.heightScale??1.1,g=this.scene.add.container(a,r),p=this.scene.add.graphics(),m=Z(0,0,n.tileWidth*.45,n.tileHeight*.28).map(k=>new P.Geom.Point(k.x,k.y));p.fillStyle(o,.94),p.fillPoints(m,!0),p.lineStyle(1.3,T(o,.15),.9),p.strokePoints(m,!0);const f=this.scene.add.graphics(),w=n.tileHeight*1.35*h,v=Math.max(2,n.tileWidth*.04);f.fillStyle(T(o,.1),1),f.fillRect(-v/2,-w,v,w);const M=this.scene.add.graphics(),b=n.tileWidth*u,A=n.tileHeight*.6*h,x=[new P.Geom.Point(-b/2,-w),new P.Geom.Point(b/2,-w-A*.18),new P.Geom.Point(b/2,-w-A),new P.Geom.Point(-b/2,-w-A*.82)];M.fillStyle(c,.93),M.fillPoints(x,!0),M.lineStyle(1.6,d,.95),M.strokePoints(x,!0);const I=this.scene.add.graphics();return I.fillStyle(l,s.glowAlpha??.25),I.fillEllipse(0,-w-A*.6,b*1.1,A*1.4),I.setBlendMode(P.BlendModes.ADD),g.add([I,p,f,M]),this.assignDepth(g,a,r,N.PROP_TALL+12),g}createPulsingHighlight(t,i,s={}){var x,I;const n=ue(this.tileSize),{x:a,y:r}=de(t,i,this.originX,this.originY,this.tileSize),o=n.tileWidth*(s.widthScale??.8),l=n.tileHeight*(s.heightScale??.8),c=s.color??3718648,d=s.alpha??.2,u=s.pulseColor??T(c,.1),h=s.pulseScale??1.18,g=((x=s.pulseAlpha)==null?void 0:x.from)??d,p=((I=s.pulseAlpha)==null?void 0:I.to)??.05,m=s.duration??1350,f=s.depthOffset??5,w=this.scene.add.container(a,r),v=(k,L,S)=>{const C=Z(0,0,o,l).map(F=>new P.Geom.Point(F.x,F.y));k.clear(),k.fillStyle(L,S),k.fillPoints(C,!0),k.lineStyle(1.3,T(L,.2),Math.min(1,S+.1)),k.strokePoints(C,!0)},M=this.scene.add.graphics();v(M,c,d);const b=this.scene.add.graphics();v(b,u,g),w.add([b,M]),this.assignDepth(w,a,r,N.EFFECT+f);const A=this.scene.tweens.add({targets:b,alpha:{from:g,to:p},scaleX:{from:1,to:h},scaleY:{from:1,to:h},duration:m,ease:"Sine.easeInOut",yoyo:!0,repeat:-1});return w.setData("pulseTween",A),w.once(P.GameObjects.Events.DESTROY,()=>{A&&A.isPlaying()&&A.stop()}),w}createSpriteTile(t,i,s,n={}){var a,r;return this.createIsoSprite(t,i,s,{textureKey:n.textureKey,depthBias:n.depthBias??N.TILE_BASE,origin:{x:((a=n.origin)==null?void 0:a.x)??.5,y:((r=n.origin)==null?void 0:r.y)??.5},normalTextureKey:n.normalTextureKey})}createSpriteProp(t,i,s,n={}){var a,r;return this.createIsoSprite(t,i,s,{textureKey:n.textureKey,depthBias:n.depthBias??N.PROP_TALL,origin:{x:((a=n.origin)==null?void 0:a.x)??.5,y:((r=n.origin)==null?void 0:r.y)??.85},normalTextureKey:n.normalTextureKey})}positionSprite(t,i,s,n){const{x:a,y:r}=de(i,s,this.originX,this.originY,this.tileSize);t.setPosition(a,r);const o=n??t.getData("isoDepthBias")??N.PROP_TALL;this.assignDepth(t,a,r,o),t.setData("isoGrid",{x:i,y:s})}updateCharacterBase(t,i,s,n){const a=t.getData("isoOptions")??{},r={baseColor:(n==null?void 0:n.baseColor)??a.baseColor??1120295,outlineColor:(n==null?void 0:n.outlineColor)??a.outlineColor??T(1120295,.25),alpha:(n==null?void 0:n.alpha)??a.alpha??.85,widthScale:(n==null?void 0:n.widthScale)??a.widthScale??.82,heightScale:(n==null?void 0:n.heightScale)??a.heightScale??.6,depthOffset:(n==null?void 0:n.depthOffset)??a.depthOffset??2};t.setData("isoOptions",r);const{x:o,y:l}=de(i,s,this.originX,this.originY,this.tileSize),c=ue(this.tileSize),d=c.tileWidth*(r.widthScale??1),u=c.tileHeight*(r.heightScale??1),h=Z(o,l,d,u);t.clear(),t.fillStyle(r.baseColor??1120295,r.alpha??.85),t.fillPoints(h,!0),t.lineStyle(1.4,r.outlineColor??T(r.baseColor??1120295,.25),(r.alpha??.85)+.1),t.strokePoints(h,!0);const g=N.CHARACTER_BASE+(r.depthOffset??0);this.assignDepth(t,o,l,g)}createCharacterToken(t,i,s={}){const n=this.scene.add.container(0,0),a=ue(this.tileSize),r=a.tileWidth*(s.widthScale??.8),o=a.tileHeight*(s.heightScale??.5),l=a.tileHeight*(s.columnHeight??1.4),c=Math.max(.55,1-l/(a.tileHeight*3)),d=s.haloRadius??a.tileWidth*.55,u=s.baseColor??1120295,h=s.outlineColor??T(u,.25),g=s.primaryColor??3718648,p=s.accentColor??T(g,.2),m=s.glowColor??g,f=this.scene.add.graphics(),w=Z(0,0,r,o).map(S=>new P.Geom.Point(S.x,S.y));f.fillStyle(u,s.alpha??.92),f.fillPoints(w,!0),f.lineStyle(1.4,h,.9),f.strokePoints(w,!0);const v=this.scene.add.graphics(),M=Z(0,-l,r*c,o*c).map(S=>new P.Geom.Point(S.x,S.y)),b=w,A=[b[1],b[2],M[2],M[1]],x=[b[2],b[3],M[3],M[2]];v.fillStyle(T(g,-.4),.96),v.fillPoints(x,!0),v.fillStyle(T(g,-.25),.98),v.fillPoints(A,!0),v.lineStyle(1.1,T(g,.1),.88),v.strokePoints(x,!0),v.strokePoints(A,!0);const I=this.scene.add.graphics();I.fillStyle(p,.92),I.fillPoints(M,!0),I.lineStyle(1.2,T(p,.3),.95),I.strokePoints(M,!0);const k=this.scene.add.graphics();k.fillStyle(m,.2),k.fillEllipse(0,a.tileHeight*.1,d,d*.45),k.setBlendMode(P.BlendModes.ADD),n.add([k,f,v,I]);const L={container:n,base:f,column:v,beacon:I,halo:k,depthOffset:s.depthOffset??6,options:s};return this.positionCharacterToken(L,t,i),L}positionCharacterToken(t,i,s){const{x:n,y:a}=de(i,s,this.originX,this.originY,this.tileSize);t.container.setPosition(n,a);const r=N.CHARACTER+(t.depthOffset??0);this.assignDepth(t.container,n,a,r)}createIsoSprite(t,i,s,n){var d,u;const a=n.textureKey??"props",r=n.depthBias??N.PROP_TALL,o=this.scene.add.image(0,0,a,s),l=((d=n.origin)==null?void 0:d.x)??.5,c=((u=n.origin)==null?void 0:u.y)??.5;return o.setOrigin(l,c),o.setData("isoDepthBias",r),n.normalTextureKey&&(o.setData("isoNormalTexture",n.normalTextureKey),o.setData("isoLightingApplied",!1)),this.positionSprite(o,t,i,r),o}applyLightingToSprite(t,i){if(!t||!t.getData("isoNormalTexture"))return;const n=t.getData("isoLightingApplied")===!0,a=this.scene.game.renderer instanceof P.Renderer.WebGL.WebGLRenderer;i&&a&&!n?(t.setPipeline("Light2D"),t.setData("isoLightingApplied",!0)):(!i||!a)&&n&&(t.resetPipeline(),t.setData("isoLightingApplied",!1))}}class on{constructor(){y(this,"disposables",[]);y(this,"disposed",!1)}add(t){if(this.disposed){t();return}this.disposables.push(t)}dispose(){if(!this.disposed)for(this.disposed=!0;this.disposables.length>0;){const t=this.disposables.pop();if(t)try{t()}catch(i){console.error("[DisposableBag] Failed to dispose resource.",i)}}}}const ru=(e,t,i)=>{const s=(o,l,c)=>{window.addEventListener(o,l,c),i.add(()=>window.removeEventListener(o,l,c))},n=(o,l,c)=>{document.addEventListener(o,l,c),i.add(()=>document.removeEventListener(o,l,c))},a=(o,l,c)=>{e.scale.on(o,l,c),i.add(()=>e.scale.off(o,l,c))},r=(o,l,c)=>{e.input&&(e.input.on(o,l,c),i.add(()=>{var d;(d=e.input)==null||d.off(o,l,c)}))};return{scene:e,getState:t.getState,dispatch:t.dispatch,disposables:i,listenWindow:s,listenDocument:n,listenScale:a,listenInput:r}};class ou{constructor(t){y(this,"modulesByKey",new Map);y(this,"orderedModules",[]);y(this,"orderDirty",!1);this.context=t}register(t){if(this.modulesByKey.has(t.key))throw new Error(`[SceneModuleRegistry] Duplicate module key "${t.key}".`);t.init(this.context),this.modulesByKey.set(t.key,t),this.orderDirty=!0}getOrderedModules(){if(!this.orderDirty)return this.orderedModules;const t=Array.from(this.modulesByKey.keys()),i=new Map(t.map((o,l)=>[o,l])),s=new Map(t.map(o=>[o,0])),n=new Map(t.map(o=>[o,[]]));this.modulesByKey.forEach(o=>{(o.dependsOn??[]).forEach(c=>{var d;if(!this.modulesByKey.has(c))throw new Error(`[SceneModuleRegistry] Module "${o.key}" depends on missing module "${c}".`);s.set(o.key,(s.get(o.key)??0)+1),(d=n.get(c))==null||d.push(o.key)})});const a=t.filter(o=>(s.get(o)??0)===0),r=[];for(;a.length>0;){const o=a.shift();if(!o)continue;r.push(o),(n.get(o)??[]).forEach(c=>{const d=(s.get(c)??0)-1;s.set(c,d),d===0&&(a.push(c),a.sort((u,h)=>(i.get(u)??0)-(i.get(h)??0)))})}if(r.length!==this.modulesByKey.size){const o=t.filter(l=>(s.get(l)??0)>0);throw new Error(`[SceneModuleRegistry] Dependency cycle detected: ${o.join(" -> ")}.`)}return this.orderedModules=r.map(o=>{const l=this.modulesByKey.get(o);if(!l)throw new Error(`[SceneModuleRegistry] Internal error: module "${o}" not found.`);return l}),this.orderDirty=!1,this.orderedModules}onCreate(){this.getOrderedModules().forEach(t=>{var i;(i=t.onCreate)==null||i.call(t)})}onStateChange(t,i){this.getOrderedModules().forEach(s=>{var n;(n=s.onStateChange)==null||n.call(s,t,i)})}onResize(){this.getOrderedModules().forEach(t=>{var i;(i=t.onResize)==null||i.call(t)})}onUpdate(t,i){this.getOrderedModules().forEach(s=>{var n;(n=s.onUpdate)==null||n.call(s,t,i)})}onShutdown(){var i;const t=this.getOrderedModules();for(let s=t.length-1;s>=0;s-=1){const n=t[s];n&&((i=n.onShutdown)==null||i.call(n))}this.modulesByKey.clear(),this.orderedModules=[],this.orderDirty=!1}}const lu=1.25,mi=.6,Rt=2.3,cu=6,ln=.08,du=1.28,uu=.22,hu=340,j=(e,t)=>Reflect.get(e,t),Et=(e,t)=>{const i=j(e,t);if(i==null)throw new Error(`[CameraModule] Missing required scene value: ${t}`);return i},cn=(e,t,i)=>{const s=j(e,t);return typeof s=="number"?s:i},K=(e,t,...i)=>{const s=j(e,t);if(typeof s!="function")throw new Error(`[CameraModule] Missing required scene method: ${t}`);return s.apply(e,i)},pu=e=>({cameras:Et(e,"cameras"),scale:Et(e,"scale"),sys:Et(e,"sys"),tweens:Et(e,"tweens"),getCurrentMapArea:()=>j(e,"currentMapArea")??null,getPlayerInitialPosition:()=>j(e,"playerInitialPosition"),getPlayerTokenContainer:()=>{const t=j(e,"playerToken");return t==null?void 0:t.container},getTileSize:()=>cn(e,"tileSize",0),setIsoOrigin:(t,i)=>{Reflect.set(e,"isoOriginX",t),Reflect.set(e,"isoOriginY",i)},ensureIsoFactory:()=>{K(e,"ensureIsoFactory")},ensureVisualPipeline:()=>{K(e,"ensureVisualPipeline")},getIsoMetrics:()=>K(e,"getIsoMetrics"),calculatePixelPosition:(t,i)=>K(e,"calculatePixelPosition",t,i),computeIsoBounds:()=>K(e,"computeIsoBounds"),renderStaticProps:()=>{K(e,"renderStaticProps")},drawBackdrop:()=>{K(e,"drawBackdrop")},drawMap:t=>{K(e,"drawMap",t)},drawBuildingMasses:()=>{K(e,"drawBuildingMasses")},drawBuildingLabels:()=>{K(e,"drawBuildingLabels")},clearPathPreview:()=>{K(e,"clearPathPreview")},resizeDayNightOverlay:()=>{K(e,"resizeDayNightOverlay")},applyOverlayZoom:()=>{K(e,"applyOverlayZoom")},emitViewportUpdate:()=>{K(e,"emitViewportUpdate")},dispatchPlayerScreenPosition:()=>{K(e,"dispatchPlayerScreenPosition")},isInCombat:()=>!!j(e,"inCombat"),readRuntimeState:()=>({isCameraFollowingPlayer:!!j(e,"isCameraFollowingPlayer"),hasInitialZoomApplied:!!j(e,"hasInitialZoomApplied"),userAdjustedZoom:!!j(e,"userAdjustedZoom"),pendingCameraRestore:!!j(e,"pendingCameraRestore"),preCombatZoom:j(e,"preCombatZoom")??null,preCombatUserAdjusted:!!j(e,"preCombatUserAdjusted"),pendingRestoreUserAdjusted:j(e,"pendingRestoreUserAdjusted")??null,baselineCameraZoom:cn(e,"baselineCameraZoom",1),cameraZoomTween:j(e,"cameraZoomTween")??null}),writeRuntimeState:t=>{Reflect.set(e,"isCameraFollowingPlayer",t.isCameraFollowingPlayer),Reflect.set(e,"hasInitialZoomApplied",t.hasInitialZoomApplied),Reflect.set(e,"userAdjustedZoom",t.userAdjustedZoom),Reflect.set(e,"pendingCameraRestore",t.pendingCameraRestore),Reflect.set(e,"preCombatZoom",t.preCombatZoom),Reflect.set(e,"preCombatUserAdjusted",t.preCombatUserAdjusted),Reflect.set(e,"pendingRestoreUserAdjusted",t.pendingRestoreUserAdjusted),Reflect.set(e,"baselineCameraZoom",t.baselineCameraZoom),Reflect.set(e,"cameraZoomTween",t.cameraZoomTween)}}),mu=()=>({isCameraFollowingPlayer:!1,hasInitialZoomApplied:!1,userAdjustedZoom:!1,pendingCameraRestore:!1,preCombatZoom:null,preCombatUserAdjusted:!1,pendingRestoreUserAdjusted:null,baselineCameraZoom:1,cameraZoomTween:null});class gu{constructor(t,i){y(this,"key","camera");y(this,"context");y(this,"ports");y(this,"runtimeState");y(this,"handleWheel",(t,i,s,n)=>{if(!this.ports.sys.isActive())return;const a=this.ports.cameras.main,r=n>0?.82:1.18,o=a.zoom,l=P.Math.Clamp(o*r,mi,Rt);if(Math.abs(l-o)<5e-4)return;this.ports.isInCombat()||(this.runtimeState.userAdjustedZoom=!0),this.stopCameraZoomTween();let c=null;if(this.runtimeState.isCameraFollowingPlayer||(c=a.getWorldPoint(t.x,t.y)),a.setZoom(l),this.runtimeState.isCameraFollowingPlayer)a.setDeadzone(Math.max(120,this.ports.scale.width*.22),Math.max(160,this.ports.scale.height*.28)),this.recenterCameraOnPlayer();else{const d=a.getWorldPoint(t.x,t.y),u=((c==null?void 0:c.x)??0)-d.x,h=((c==null?void 0:c.y)??0)-d.y;a.scrollX+=u,a.scrollY+=h,this.clampCameraToBounds(a)}this.ports.applyOverlayZoom(),this.ports.emitViewportUpdate(),this.ports.isInCombat()||(this.runtimeState.baselineCameraZoom=l),this.pushRuntimeStateToPorts()});var s,n;this.ports=i??pu(t),this.runtimeState={...mu(),...(n=(s=this.ports).readRuntimeState)==null?void 0:n.call(s)},this.pushRuntimeStateToPorts()}init(t){this.context=t}onCreate(){this.context.listenInput("wheel",this.handleWheel)}onResize(){this.ports.sys.isActive()&&this.ports.getCurrentMapArea()&&(this.setupCameraAndMap(),this.enablePlayerCameraFollow(),this.ports.resizeDayNightOverlay())}onShutdown(){this.stopCameraZoomTween()}setupCameraAndMap(){const t=this.ports.getCurrentMapArea();if(!t)return;const{width:i,height:s}=t,{tileHeight:n,halfTileWidth:a,halfTileHeight:r}=this.ports.getIsoMetrics(),o=this.ports.scale.width,l=this.ports.scale.height;this.ports.setIsoOrigin((s-1)*a,n),this.ports.ensureIsoFactory(),this.ports.ensureVisualPipeline();const c=(i+s)*a,d=(i+s)*r,u=o/c,h=l/d,g=Math.min(u,h),p=P.Math.Clamp(g*lu,mi,Rt),m=this.ports.cameras.main,f=this.runtimeState.pendingCameraRestore||!!this.runtimeState.cameraZoomTween;this.ports.isInCombat()||(this.runtimeState.hasInitialZoomApplied?!this.runtimeState.userAdjustedZoom&&!f&&Math.abs(m.zoom-p)>8e-4&&(this.runtimeState.userAdjustedZoom=!1,this.animateCameraZoom(p)):f||m.setZoom(p));const w=this.ports.computeIsoBounds(),v=this.ports.getTileSize()*cu;m.setBounds(w.minX-v,w.minY-v,w.maxX-w.minX+v*2,w.maxY-w.minY+v*2);const M=(i-1)/2,b=(s-1)/2,A=this.ports.calculatePixelPosition(M,b),x=this.ports.getPlayerInitialPosition(),k=(x?this.ports.calculatePixelPosition(x.x,x.y):null)??A;this.runtimeState.isCameraFollowingPlayer?this.recenterCameraOnPlayer():m.centerOn(k.x,k.y+n*.25),this.ports.renderStaticProps(),this.ports.drawBackdrop(),this.ports.drawMap(t.tiles),this.ports.drawBuildingMasses(),this.ports.drawBuildingLabels(),this.ports.clearPathPreview(),this.ports.resizeDayNightOverlay(),this.ports.emitViewportUpdate(),!this.ports.isInCombat()&&!f&&(this.runtimeState.baselineCameraZoom=m.zoom),this.runtimeState.hasInitialZoomApplied=!0,this.pushRuntimeStateToPorts()}enablePlayerCameraFollow(){const t=this.ports.getPlayerTokenContainer();if(!t||!this.ports.sys.isActive())return;const i=this.ports.cameras.main;this.runtimeState.isCameraFollowingPlayer||i.startFollow(t,!1,ln,ln),i.setDeadzone(Math.max(120,this.ports.scale.width*.22),Math.max(160,this.ports.scale.height*.28)),this.runtimeState.isCameraFollowingPlayer=!0,this.pushRuntimeStateToPorts(),this.recenterCameraOnPlayer(),this.ports.dispatchPlayerScreenPosition()}recenterCameraOnPlayer(){const t=this.ports.getPlayerTokenContainer();if(!t||!this.ports.sys.isActive())return;this.ports.cameras.main.centerOn(t.x,t.y),this.ports.dispatchPlayerScreenPosition()}isFollowingPlayer(){return this.runtimeState.isCameraFollowingPlayer}clampCameraToBounds(t){const i=t.getBounds();if(!i)return;const s=t.width/t.zoom,n=t.height/t.zoom,a=i.x,r=i.x+Math.max(0,i.width-s),o=i.y,l=i.y+Math.max(0,i.height-n);t.scrollX=P.Math.Clamp(t.scrollX,a,r),t.scrollY=P.Math.Clamp(t.scrollY,o,l)}clampCameraCenterTarget(t,i){const s=this.ports.cameras.main,n=s.getBounds();if(!n)return{x:t,y:i};const a=s.worldView.width,r=s.worldView.height,o=a/2,l=r/2,c=n.x+o,d=n.x+Math.max(o,n.width-o),u=n.y+l,h=n.y+Math.max(l,n.height-l),g=P.Math.Clamp(t,c,Math.max(c,d)),p=P.Math.Clamp(i,u,Math.max(u,h));return{x:g,y:p}}focusCameraOnGridPosition(t,i,s=!0){if(!this.ports.sys.isActive()||!this.ports.getCurrentMapArea())return;const n=this.ports.getIsoMetrics(),a=this.ports.calculatePixelPosition(t,i),r=a.x,o=a.y+n.halfTileHeight,{x:l,y:c}=this.clampCameraCenterTarget(r,o),d=this.ports.cameras.main;this.runtimeState.isCameraFollowingPlayer=!1,this.pushRuntimeStateToPorts(),d.stopFollow();const u=()=>{this.clampCameraToBounds(d),this.ports.emitViewportUpdate()};s?d.pan(l,c,300,"Sine.easeInOut",!1,(h,g)=>{this.ports.emitViewportUpdate(),g===1&&u()}):(d.centerOn(l,c),u())}stopCameraZoomTween(){this.runtimeState.cameraZoomTween&&(this.runtimeState.cameraZoomTween.remove(),this.runtimeState.cameraZoomTween=null,this.runtimeState.pendingCameraRestore&&(this.runtimeState.pendingCameraRestore=!1,this.runtimeState.pendingRestoreUserAdjusted!==null&&(this.runtimeState.userAdjustedZoom=this.runtimeState.pendingRestoreUserAdjusted),this.runtimeState.preCombatZoom=null,this.runtimeState.preCombatUserAdjusted=!1,this.runtimeState.pendingRestoreUserAdjusted=null),this.pushRuntimeStateToPorts())}animateCameraZoom(t){if(!this.ports.sys.isActive())return;const i=this.ports.cameras.main;if(!i)return;const s=P.Math.Clamp(t,mi,Rt),n=i.zoom;if(this.stopCameraZoomTween(),Math.abs(n-s)<5e-4){i.setZoom(s),this.ports.applyOverlayZoom(),this.ports.emitViewportUpdate(),this.ports.isInCombat()||(this.runtimeState.baselineCameraZoom=i.zoom),this.runtimeState.pendingCameraRestore&&(this.runtimeState.pendingCameraRestore=!1,this.runtimeState.pendingRestoreUserAdjusted!==null&&(this.runtimeState.userAdjustedZoom=this.runtimeState.pendingRestoreUserAdjusted),this.runtimeState.preCombatZoom=null,this.runtimeState.preCombatUserAdjusted=!1,this.runtimeState.pendingRestoreUserAdjusted=null),this.pushRuntimeStateToPorts();return}this.runtimeState.cameraZoomTween=this.ports.tweens.add({targets:i,zoom:s,duration:hu,ease:"Sine.easeInOut",onUpdate:()=>{this.ports.applyOverlayZoom(),this.ports.emitViewportUpdate()},onComplete:()=>{this.runtimeState.cameraZoomTween=null,this.ports.isInCombat()||(this.runtimeState.baselineCameraZoom=i.zoom),this.runtimeState.pendingCameraRestore&&(this.runtimeState.pendingCameraRestore=!1,this.runtimeState.pendingRestoreUserAdjusted!==null&&(this.runtimeState.userAdjustedZoom=this.runtimeState.pendingRestoreUserAdjusted),this.runtimeState.preCombatZoom=null,this.runtimeState.preCombatUserAdjusted=!1,this.runtimeState.pendingRestoreUserAdjusted=null),this.pushRuntimeStateToPorts()}}),this.pushRuntimeStateToPorts()}zoomCameraForCombat(){const t=this.ports.cameras.main;if(!t)return;this.runtimeState.pendingCameraRestore=!1;const i=t.zoom;this.runtimeState.preCombatZoom===null&&(this.runtimeState.preCombatZoom=i,this.runtimeState.preCombatUserAdjusted=this.runtimeState.userAdjustedZoom),this.runtimeState.baselineCameraZoom=i;const s=Math.min(Rt,Math.max(i*du,i+uu));this.runtimeState.userAdjustedZoom=!1,this.pushRuntimeStateToPorts(),this.animateCameraZoom(s)}restoreCameraAfterCombat(){const t=this.ports.cameras.main;if(!t)return;const i=this.runtimeState.preCombatZoom??this.runtimeState.baselineCameraZoom??t.zoom;this.runtimeState.pendingRestoreUserAdjusted=this.runtimeState.preCombatUserAdjusted,this.runtimeState.userAdjustedZoom=!0,this.runtimeState.pendingCameraRestore=!0,this.pushRuntimeStateToPorts(),this.animateCameraZoom(i)}resetForMapTransition(){this.runtimeState.hasInitialZoomApplied=!1,this.runtimeState.userAdjustedZoom=!1,this.runtimeState.pendingCameraRestore=!1,this.runtimeState.preCombatZoom=null,this.runtimeState.preCombatUserAdjusted=!1,this.runtimeState.pendingRestoreUserAdjusted=null,this.pushRuntimeStateToPorts()}pushRuntimeStateToPorts(){var t,i;(i=(t=this.ports).writeRuntimeState)==null||i.call(t,this.runtimeState)}}const Ta=.5,Ni=5,ls=(e,t)=>Reflect.get(e,t),Ze=(e,t,i)=>{const s=ls(e,t);return typeof s=="number"?s:i},_t=(e,t,...i)=>{const s=ls(e,t);if(typeof s!="function")throw new Error(`[ClockModule] Missing required scene method: ${t}`);return s.apply(e,i)},fu=e=>({getCurrentGameTime:()=>Ze(e,"currentGameTime",D.getState().world.currentTime),getAtmosphereRedrawBucket:()=>Ze(e,"lastAtmosphereRedrawBucket",-1),setAtmosphereRedrawBucket:t=>{Reflect.set(e,"lastAtmosphereRedrawBucket",t)},signalAtmosphereRedraw:()=>{const t=ls(e,"currentMapArea");t&&(_t(e,"drawBackdrop"),_t(e,"drawMap",t.tiles))},signalOverlayUpdate:()=>{_t(e,"updateDayNightOverlay")},signalOcclusionUpdate:()=>{_t(e,"applyOcclusionReadability")},dispatchGameTime:t=>{D.dispatch(ta(t))},shouldApplySuspicionDecay:()=>!!D.getState().settings.reputationSystemsEnabled,dispatchSuspicionDecay:(t,i)=>{D.dispatch(Sa({elapsedSeconds:t,timestamp:i}))},readRuntimeState:()=>({currentGameTime:Ze(e,"currentGameTime",D.getState().world.currentTime),timeDispatchAccumulator:Ze(e,"timeDispatchAccumulator",0),lastAtmosphereRedrawBucket:Ze(e,"lastAtmosphereRedrawBucket",-1),dispatchCadenceSeconds:Ta,atmosphereBucketSeconds:Ni}),writeRuntimeState:t=>{Reflect.set(e,"currentGameTime",t.currentGameTime),Reflect.set(e,"timeDispatchAccumulator",t.timeDispatchAccumulator),Reflect.set(e,"lastAtmosphereRedrawBucket",t.lastAtmosphereRedrawBucket)}}),yu=e=>({currentGameTime:e,timeDispatchAccumulator:0,lastAtmosphereRedrawBucket:Math.floor(e/Ni),dispatchCadenceSeconds:Ta,atmosphereBucketSeconds:Ni});class Su{constructor(t,i){y(this,"key","clock");y(this,"dependsOn",["stateSync","worldRender","dayNightOverlay"]);y(this,"ports");y(this,"runtimeState");var s,n;this.ports=i??fu(t),this.runtimeState={...yu(this.ports.getCurrentGameTime()),...(n=(s=this.ports).readRuntimeState)==null?void 0:n.call(s)},this.runtimeState.lastAtmosphereRedrawBucket<0&&(this.runtimeState.lastAtmosphereRedrawBucket=Math.floor(this.runtimeState.currentGameTime/this.runtimeState.atmosphereBucketSeconds)),this.ports.setAtmosphereRedrawBucket(this.runtimeState.lastAtmosphereRedrawBucket),this.pushRuntimeStateToPorts()}init(t){}onStateChange(t,i){const s=i.world.currentTime;Math.abs(s-this.runtimeState.currentGameTime)>1e-4&&(this.runtimeState.currentGameTime=s,this.pushRuntimeStateToPorts())}onUpdate(t,i){const s=i/1e3;if(!Number.isFinite(s)||s<=0)return;this.runtimeState.currentGameTime+=s,this.runtimeState.timeDispatchAccumulator+=s;const n=Math.floor(this.runtimeState.currentGameTime/this.runtimeState.atmosphereBucketSeconds),a=this.ports.getAtmosphereRedrawBucket();if(n!==a&&(this.runtimeState.lastAtmosphereRedrawBucket=n,this.ports.setAtmosphereRedrawBucket(n),this.ports.signalAtmosphereRedraw()),this.ports.signalOverlayUpdate(),this.ports.signalOcclusionUpdate(),this.runtimeState.timeDispatchAccumulator>=this.runtimeState.dispatchCadenceSeconds){const r=this.runtimeState.timeDispatchAccumulator;this.ports.dispatchGameTime(r),this.ports.shouldApplySuspicionDecay()&&this.ports.dispatchSuspicionDecay(r,this.runtimeState.currentGameTime),this.runtimeState.timeDispatchAccumulator=0}this.pushRuntimeStateToPorts()}getCurrentGameTime(){return this.runtimeState.currentGameTime}pushRuntimeStateToPorts(){var t,i;(i=(t=this.ports).writeRuntimeState)==null||i.call(t,this.runtimeState)}}const vu=.28,bu=16777215,Jt=(e,t)=>Reflect.get(e,t),Dt=(e,t)=>{const i=Jt(e,t);if(i==null)throw new Error(`[DayNightOverlayModule] Missing required scene value: ${t}`);return i},wu=(e,t,i)=>{const s=Jt(e,t);return typeof s=="number"?s:i},dn=(e,t,...i)=>{const s=Jt(e,t);if(typeof s!="function")throw new Error(`[DayNightOverlayModule] Missing required scene method: ${t}`);return s.apply(e,i)},Pu=e=>({add:Dt(e,"add"),cameras:Dt(e,"cameras"),scale:Dt(e,"scale"),sys:Dt(e,"sys"),getCurrentGameTime:()=>wu(e,"currentGameTime",0),isInCombat:()=>!!Jt(e,"inCombat"),resolveAtmosphereProfile:t=>dn(e,"resolveAtmosphereProfile",t),registerStaticDepth:(t,i)=>{dn(e,"registerStaticDepth",t,i)}});class Mu{constructor(t,i){y(this,"key","dayNightOverlay");y(this,"context");y(this,"overlay");y(this,"ports");y(this,"handleVisibilityChange",()=>{var t;this.ports.sys.isActive()&&document.visibilityState==="visible"&&(this.resizeDayNightOverlay(),this.updateDayNightOverlay(),(t=this.overlay)==null||t.setVisible(!0))});this.ports=i??Pu(t)}init(t){this.context=t}onCreate(){this.context.listenDocument("visibilitychange",this.handleVisibilityChange)}onShutdown(){this.overlay&&(this.overlay.destroy(),this.overlay=void 0)}initializeDayNightOverlay(){const t=this.ports.scale.width,i=this.ports.scale.height,s=this.ports.add.rectangle(0,0,t,i,0,0);s.setOrigin(.5,.5),s.setScrollFactor(0),this.ports.registerStaticDepth(s,He.DAY_NIGHT_OVERLAY),s.setBlendMode(P.BlendModes.MULTIPLY),s.setSize(t,i),s.setDisplaySize(t,i),this.overlay=s,this.applyOverlayZoom()}applyOverlayZoom(){const t=this.overlay;if(!t)return;const s=1/(this.ports.cameras.main.zoom||1);t.setScale(s,s),t.setPosition(this.ports.scale.width/2,this.ports.scale.height/2)}resizeDayNightOverlay(){const t=this.overlay;if(!t)return;const i=this.ports.scale.width,s=this.ports.scale.height;t.setSize(i,s),t.setDisplaySize(i,s),this.applyOverlayZoom()}updateDayNightOverlay(){const t=this.overlay;if(!t)return;const i=ml(this.ports.getCurrentGameTime(),W),s=this.ports.resolveAtmosphereProfile(i),n=this.ports.isInCombat(),a=n?Math.min(s.overlayAlpha,vu):s.overlayAlpha,r=n?bu:s.overlayColor;t.setFillStyle(r,a)}}const Au="isoTileSelected",Hi="isoPathPreview",Iu="minimapViewportClick",xu="minimapStateUpdate",Cu="minimapZoomUpdate",$g="minimapPathPreview",ku="minimapObjectiveFocus",Tu="playerScreenPositionUpdate",Ru="pickupStateSync",X=(e,t)=>Reflect.get(e,t),ve=(e,t)=>{const i=X(e,t);if(i==null)throw new Error(`[EntityRenderModule] Missing required scene value: ${t}`);return i},Xe=(e,t,...i)=>{const s=X(e,t);if(typeof s!="function")throw new Error(`[EntityRenderModule] Missing required scene method: ${t}`);return s.apply(e,i)},Eu=e=>({add:ve(e,"add"),cameras:ve(e,"cameras"),game:ve(e,"game"),scale:ve(e,"scale"),sys:ve(e,"sys"),hasMapGraphics:()=>!!X(e,"mapGraphics"),ensureIsoFactory:()=>{Xe(e,"ensureIsoFactory")},getIsoMetrics:()=>Xe(e,"getIsoMetrics"),calculatePixelPosition:(t,i)=>Xe(e,"calculatePixelPosition",t,i),syncDepth:(t,i,s,n)=>{Xe(e,"syncDepth",t,i,s,n)},enablePlayerCameraFollow:()=>{Xe(e,"enablePlayerCameraFollow")},isInCombat:()=>!!X(e,"inCombat"),isCameraFollowingPlayer:()=>!!X(e,"isCameraFollowingPlayer"),createCharacterToken:(t,i,s)=>{const n=X(e,"characterRigFactory");let a;if(n)a=n.createToken(t,i,s);else{const r=ve(e,"isoFactory"),o=ve(e,"visualTheme");a=r.createCharacterToken(i,s,o.entityProfiles[t])}if(!a)throw new Error("[EntityRenderModule] Failed to create character token.");return a},positionCharacterToken:(t,i,s)=>{const n=X(e,"characterRigFactory");if(n){n.positionToken(t,i,s);return}ve(e,"isoFactory").positionCharacterToken(t,i,s)},readRuntimeState:()=>({playerToken:X(e,"playerToken"),playerNameLabel:X(e,"playerNameLabel"),playerVitalsIndicator:X(e,"playerVitalsIndicator"),enemySprites:X(e,"enemySprites")??new Map,npcSprites:X(e,"npcSprites")??new Map,lastPlayerGridPosition:X(e,"lastPlayerGridPosition")??null,lastPlayerScreenDetail:X(e,"lastPlayerScreenDetail")}),writeRuntimeState:t=>{Reflect.set(e,"playerToken",t.playerToken),Reflect.set(e,"playerNameLabel",t.playerNameLabel),Reflect.set(e,"playerVitalsIndicator",t.playerVitalsIndicator),Reflect.set(e,"enemySprites",t.enemySprites),Reflect.set(e,"npcSprites",t.npcSprites),Reflect.set(e,"lastPlayerGridPosition",t.lastPlayerGridPosition),Reflect.set(e,"lastPlayerScreenDetail",t.lastPlayerScreenDetail)}}),_u=()=>({playerToken:void 0,playerNameLabel:void 0,playerVitalsIndicator:void 0,enemySprites:new Map,npcSprites:new Map,lastPlayerGridPosition:null,lastPlayerScreenDetail:void 0});class Du{constructor(t,i){y(this,"key","entityRender");y(this,"ports");y(this,"runtimeState");this.ports=i??Eu(t),this.runtimeState=_u(),this.pullRuntimeStateFromPorts(),this.pushRuntimeStateToPorts()}init(){}onUpdate(){this.dispatchPlayerScreenPosition()}onShutdown(){this.pullRuntimeStateFromPorts(),this.clearEntities(),this.runtimeState.playerToken&&(this.runtimeState.playerToken.container.destroy(!0),this.runtimeState.playerToken=void 0),this.runtimeState.playerNameLabel&&(this.runtimeState.playerNameLabel.destroy(),this.runtimeState.playerNameLabel=void 0),this.runtimeState.lastPlayerGridPosition=null,this.runtimeState.lastPlayerScreenDetail=void 0,this.destroyPlayerVitalsIndicator(),this.pushRuntimeStateToPorts()}initializePlayer(t,i){if(this.pullRuntimeStateFromPorts(),!t)return!1;this.ports.ensureIsoFactory(),this.runtimeState.playerToken=this.ports.createCharacterToken("player",t.x,t.y);const s=this.ports.getIsoMetrics(),n=this.ports.calculatePixelPosition(t.x,t.y);return this.runtimeState.playerNameLabel=this.createCharacterNameLabel(i,3718648,14),this.positionCharacterLabel(this.runtimeState.playerNameLabel,n.x,n.y,s.tileHeight*1.6),this.runtimeState.lastPlayerGridPosition={...t},this.pushRuntimeStateToPorts(),!0}getPlayerTokenContainer(){var t;return this.pullRuntimeStateFromPorts(),(t=this.runtimeState.playerToken)==null?void 0:t.container}getLastPlayerGridPosition(){return this.pullRuntimeStateFromPorts(),this.runtimeState.lastPlayerGridPosition}getRuntimeStateSnapshot(){return this.pullRuntimeStateFromPorts(),this.runtimeState}updatePlayerPosition(t){if(this.pullRuntimeStateFromPorts(),!this.runtimeState.playerToken){console.warn("[MainScene] Player token not available for position update.");return}const i=!this.runtimeState.lastPlayerGridPosition||this.runtimeState.lastPlayerGridPosition.x!==t.x||this.runtimeState.lastPlayerGridPosition.y!==t.y;this.ports.ensureIsoFactory(),this.ports.positionCharacterToken(this.runtimeState.playerToken,t.x,t.y);const s=this.ports.calculatePixelPosition(t.x,t.y);if(this.dispatchPlayerScreenPosition(),this.runtimeState.playerNameLabel){const n=this.ports.getIsoMetrics();this.positionCharacterLabel(this.runtimeState.playerNameLabel,s.x,s.y,n.tileHeight*1.6)}i&&(this.runtimeState.lastPlayerGridPosition={...t},this.ports.isCameraFollowingPlayer()||this.ports.enablePlayerCameraFollow()),this.pushRuntimeStateToPorts()}updatePlayerVitalsIndicator(t,i,s){if(this.pullRuntimeStateFromPorts(),!this.ports.isInCombat()){this.destroyPlayerVitalsIndicator();return}if(!this.runtimeState.playerToken||!this.ports.sys.isActive())return;const n=this.ports.getIsoMetrics(),a=this.ports.calculatePixelPosition(t.x,t.y),r=n.tileWidth*.38,o=Math.max(4,n.tileHeight*.08),l=a.x-r/2,c=a.y-n.tileHeight*.7,d=s>0?Math.max(0,Math.min(1,i/s)):0;this.runtimeState.playerVitalsIndicator||(this.runtimeState.playerVitalsIndicator=this.ports.add.graphics());const u=this.runtimeState.playerVitalsIndicator;u.clear(),u.fillStyle(988970,.82),u.fillRoundedRect(l,c,r,o,Math.min(4,o)),d>0&&(u.fillStyle(3718648,1),u.fillRoundedRect(l+1,c+1,(r-2)*d,Math.max(1,o-2),Math.max(2,o-2))),this.ports.syncDepth(u,a.x,a.y,N.FLOATING_UI+9),this.pushRuntimeStateToPorts()}destroyPlayerVitalsIndicator(){this.pullRuntimeStateFromPorts(),this.runtimeState.playerVitalsIndicator&&(this.runtimeState.playerVitalsIndicator.destroy(),this.runtimeState.playerVitalsIndicator=void 0,this.pushRuntimeStateToPorts())}updateEnemies(t){if(this.pullRuntimeStateFromPorts(),!this.ports.hasMapGraphics()||!this.ports.sys.isActive())return;this.ports.ensureIsoFactory(),this.runtimeState.enemySprites.forEach(s=>{s.markedForRemoval=!0});const i=this.ports.getIsoMetrics();for(const s of t){const n=this.runtimeState.enemySprites.get(s.id),a=this.ports.calculatePixelPosition(s.position.x,s.position.y);if(!n){if(s.health<=0)continue;const r=this.ports.createCharacterToken("hostileNpc",s.position.x,s.position.y),o=this.ports.add.graphics();o.setVisible(!1);const l=this.createCharacterNameLabel(s.name??"Hostile",15680580);this.positionCharacterLabel(l,a.x,a.y,i.tileHeight*1.45),this.runtimeState.enemySprites.set(s.id,{token:r,healthBar:o,nameLabel:l,markedForRemoval:!1});const c=this.runtimeState.enemySprites.get(s.id);c&&this.updateEnemyHealthBar(c,a,i,s);continue}if(s.health<=0){n.markedForRemoval=!0;continue}this.ports.positionCharacterToken(n.token,s.position.x,s.position.y),n.markedForRemoval=!1,this.positionCharacterLabel(n.nameLabel,a.x,a.y,i.tileHeight*1.45),this.updateEnemyHealthBar(n,a,i,s)}this.runtimeState.enemySprites.forEach((s,n)=>{s.markedForRemoval&&(s.token.container.destroy(!0),s.healthBar.destroy(),s.nameLabel.destroy(),this.runtimeState.enemySprites.delete(n))}),this.pushRuntimeStateToPorts()}updateNpcs(t){if(this.pullRuntimeStateFromPorts(),!this.ports.sys.isActive())return;this.runtimeState.npcSprites.forEach(s=>{s.markedForRemoval=!0}),this.ports.ensureIsoFactory();const i=this.ports.getIsoMetrics();for(const s of t){const n=this.runtimeState.npcSprites.get(s.id),a=this.ports.calculatePixelPosition(s.position.x,s.position.y);if(!n){const r=s.isInteractive?"interactiveNpc":"friendlyNpc",o=this.ports.createCharacterToken(r,s.position.x,s.position.y),l=this.createCharacterNameLabel(s.name??"Civilian",s.isInteractive?2282478:9741240);this.positionCharacterLabel(l,a.x,a.y,i.tileHeight*1.35);const c={token:o,nameLabel:l,markedForRemoval:!1};this.runtimeState.npcSprites.set(s.id,c),this.updateNpcCombatIndicator(c,a,i,s);continue}this.ports.positionCharacterToken(n.token,s.position.x,s.position.y),n.markedForRemoval=!1,this.positionCharacterLabel(n.nameLabel,a.x,a.y,i.tileHeight*1.35),this.updateNpcCombatIndicator(n,a,i,s)}this.runtimeState.npcSprites.forEach((s,n)=>{s.markedForRemoval&&(s.token.container.destroy(!0),s.nameLabel.destroy(),s.indicator&&s.indicator.destroy(),this.runtimeState.npcSprites.delete(n))}),this.pushRuntimeStateToPorts()}clearForMapTransition(){this.pullRuntimeStateFromPorts(),this.clearEntities(),this.runtimeState.lastPlayerScreenDetail=void 0,this.runtimeState.lastPlayerGridPosition=null,this.destroyPlayerVitalsIndicator(),this.pushRuntimeStateToPorts()}resetCombatIndicators(){this.pullRuntimeStateFromPorts(),this.destroyPlayerVitalsIndicator(),this.runtimeState.enemySprites.forEach(t=>{t.healthBar.clear(),t.healthBar.setVisible(!1)}),this.runtimeState.npcSprites.forEach(t=>{t.indicator&&(t.indicator.destroy(),t.indicator=void 0)}),this.pushRuntimeStateToPorts()}createCharacterNameLabel(t,i,s=12){const n=this.ports.add.text(0,0,t.toUpperCase(),{fontFamily:'Orbitron, "DM Sans", sans-serif',fontSize:`${s}px`,fontStyle:"700",color:this.colorToHex(16317180),align:"center"});return n.setOrigin(.5,1),n.setStroke(this.colorToHex(i),1.4),n.setShadow(0,0,this.colorToHex(i),8,!0,!0),n.setBlendMode(P.BlendModes.ADD),n.setAlpha(.95),n}positionCharacterLabel(t,i,s,n){t.setPosition(i,s-n),t.setDepth(os(i,s,N.OVERLAY))}dispatchPlayerScreenPosition(){var h;if(this.pullRuntimeStateFromPorts(),!this.runtimeState.playerToken||!this.ports.sys.isActive())return;const t=this.ports.cameras.main,i=this.runtimeState.playerToken.container,s=i.x,n=i.y,a=(s-t.worldView.x)*t.zoom,r=(n-t.worldView.y)*t.zoom,o=(h=this.ports.game.canvas)==null?void 0:h.getBoundingClientRect(),l=(o==null?void 0:o.width)??this.ports.scale.width,c=(o==null?void 0:o.height)??this.ports.scale.height,d={worldX:s,worldY:n,screenX:a,screenY:r,canvasWidth:this.ports.scale.width,canvasHeight:this.ports.scale.height,canvasDisplayWidth:l,canvasDisplayHeight:c,canvasLeft:(o==null?void 0:o.left)??0,canvasTop:(o==null?void 0:o.top)??0,zoom:t.zoom,timestamp:typeof performance<"u"?performance.now():Date.now()},u=this.runtimeState.lastPlayerScreenDetail;u&&Math.abs(u.screenX-d.screenX)<.5&&Math.abs(u.screenY-d.screenY)<.5&&Math.abs(u.zoom-d.zoom)<1e-4&&u.canvasWidth===d.canvasWidth&&u.canvasHeight===d.canvasHeight||(this.runtimeState.lastPlayerScreenDetail=d,this.pushRuntimeStateToPorts(),typeof window<"u"&&(window.__getawayPlayerScreenPosition=d,window.dispatchEvent(new CustomEvent(Tu,{detail:d}))))}updateNpcCombatIndicator(t,i,s,n){if(!this.ports.isInCombat()||!n.isInteractive){t.indicator&&(t.indicator.destroy(),t.indicator=void 0);return}t.indicator||(t.indicator=this.ports.add.graphics());const a=t.indicator,r=s.tileWidth*.26,o=Math.max(3,s.tileHeight*.06),l=i.x-r/2,c=i.y-s.tileHeight*.68;a.clear(),a.fillStyle(1059395,.82),a.fillRoundedRect(l,c,r,o,Math.min(3,o)),a.fillStyle(2278750,1),a.fillRoundedRect(l+1,c+1,r-2,Math.max(1,o-2),Math.max(2,o-2)),this.ports.syncDepth(a,i.x,i.y,N.FLOATING_UI+6)}updateEnemyHealthBar(t,i,s,n){const a=t.healthBar;if(!this.ports.isInCombat()){a.clear(),a.setVisible(!1);return}a.setVisible(!0);const r=s.tileWidth*.38,o=Math.max(4,s.tileHeight*.08),l=i.x-r/2,c=i.y-s.tileHeight*.75,d=n.maxHealth>0?P.Math.Clamp(n.health/n.maxHealth,0,1):0;a.clear(),a.fillStyle(4136221,.88),a.fillRoundedRect(l,c,r,o,Math.min(4,o)),d>0&&(a.fillStyle(15680580,1),a.fillRoundedRect(l+1,c+1,(r-2)*d,Math.max(1,o-2),Math.max(2,o-2))),this.ports.syncDepth(a,i.x,i.y,N.FLOATING_UI+7)}pullRuntimeStateFromPorts(){var i,s;const t=(s=(i=this.ports).readRuntimeState)==null?void 0:s.call(i);t&&(t.playerToken!==void 0&&(this.runtimeState.playerToken=t.playerToken),t.playerNameLabel!==void 0&&(this.runtimeState.playerNameLabel=t.playerNameLabel),this.runtimeState.playerVitalsIndicator=t.playerVitalsIndicator,t.enemySprites&&(this.runtimeState.enemySprites=t.enemySprites),t.npcSprites&&(this.runtimeState.npcSprites=t.npcSprites),t.lastPlayerGridPosition!==void 0&&(this.runtimeState.lastPlayerGridPosition=t.lastPlayerGridPosition),this.runtimeState.lastPlayerScreenDetail=t.lastPlayerScreenDetail)}pushRuntimeStateToPorts(){var t,i;(i=(t=this.ports).writeRuntimeState)==null||i.call(t,this.runtimeState)}clearEntities(){this.runtimeState.enemySprites.forEach(t=>{t.token.container.destroy(!0),t.healthBar.destroy(),t.nameLabel.destroy()}),this.runtimeState.enemySprites.clear(),this.runtimeState.npcSprites.forEach(t=>{t.token.container.destroy(!0),t.nameLabel.destroy(),t.indicator&&(t.indicator.destroy(),t.indicator=void 0)}),this.runtimeState.npcSprites.clear()}colorToHex(t){return`#${t.toString(16).padStart(6,"0")}`}}const Wi=5,pt=2,un=1,Lu="south",hn=0,Fu=["none","half","full"],Bu={none:1,half:.75,full:.55},Ou={none:0,half:-.2,full:-.4},Nu=()=>{var e;try{switch(((e=D.getState().paranoia)==null?void 0:e.tier)??"calm"){case"uneasy":return-.05;case"on_edge":return-.1;case"panicked":return-.15;case"breakdown":return-.25;default:return 0}}catch{return 0}},Kt=e=>Fu.indexOf(e),pn=(e,t)=>Kt(t)>Kt(e)?t:e,ei=(e,t)=>{const i=t.x-e.x,s=t.y-e.y;if(Math.abs(i)>=Math.abs(s)){if(i>0)return"east";if(i<0)return"west"}return s>0?"south":s<0?"north":Lu},Ra=(e,t)=>e?e[t]??"none":"none",Hu=e=>{if(!e)return null;let t="north",i="none";return["north","east","south","west"].forEach(s=>{const n=Ra(e,s);Kt(n)>Kt(i)&&(i=n,t=s)}),i==="none"?null:t},Ea=(e,t)=>{var i,s;if(e)return(s=(i=e.tiles[t.y])==null?void 0:i[t.x])==null?void 0:s.cover},_a=e=>typeof e=="boolean"?{isBehindCover:e}:e?{isBehindCover:!!e.isBehindCover,mapArea:e.mapArea}:{isBehindCover:!1},Da=(e,t,i)=>{let s=i.isBehindCover?"half":"none";const n=ei(t.position,e.position),a=Ea(i.mapArea,t.position);return s=pn(s,Ra(a,n)),t.coverOrientation&&t.coverOrientation===n&&(s=pn(s,"half")),{level:s,attackDirection:n}},La=(e,t)=>({...e,facing:t}),qi=(e,t)=>{if(!t)return{...e,coverOrientation:e.coverOrientation??null,suppression:e.suppression??hn};const i=Ea(t,e.position);return{...e,coverOrientation:Hu(i),suppression:e.suppression??hn}},bt=(e,t,i)=>{const s=ei(t,e.position),n=La(e,s);return qi(n,i)};let Wu=()=>Math.random();const mn=()=>{const e=Wu();if(!Number.isFinite(e)||Number.isNaN(e))throw new Error("[CombatSystem] Random generator must return a finite number between 0 and 1.");if(e<0||e>1)throw new Error("[CombatSystem] Random generator must return a value between 0 and 1.");return e},gn=e=>({...e,equipped:{...e.equipped},encumbrance:{...e.encumbrance},inventory:{...e.inventory,items:[...e.inventory.items],hotbar:[...e.inventory.hotbar]},equippedSlots:e.equippedSlots?{...e.equippedSlots}:{},perkRuntime:{...e.perkRuntime}}),Gi=.25,at=e=>{const t=e==null?void 0:e.durability;if(!t||t.max<=0)return 1;const i=t.current/t.max;return Number.isFinite(i)?Math.max(0,Math.min(1,i)):1},fn=e=>{const t=at(e);return t<=0?0:t<=Gi?.75:t<=.5?.9:1},yn=(e,t=1)=>{if(!e.durability)return e;const i=Math.max(0,e.durability.current-t);return{...e,durability:{...e.durability,current:i}}},Sn=(e,t,i,s,n)=>{if(s>0&&n===0){e.push({type:t==="weapon"?"weaponBroken":"armorBroken",message:t==="weapon"?`${i} has broken—switch weapons or repair it to continue fighting.`:`${i} is shredded! Incoming damage will hit you directly.`});return}s>Gi&&n<=Gi&&n>0&&e.push({type:t==="weapon"?"weaponDamaged":"armorDamaged",message:t==="weapon"?`${i} is about to fail. Repair it soon to avoid misfires.`:`${i} can barely absorb hits—seek repairs immediately.`})},qu=(e,t)=>{const i=e.encumbrance,s=(i==null?void 0:i.attackApMultiplier)??1;if(!Number.isFinite(s))return Number.POSITIVE_INFINITY;const n=Math.ceil(t*Math.max(s,0));return Math.max(0,n)},Fa=e=>{var t;if("skills"in e){const i=e;if(ro(i.encumbrance))return Number.POSITIVE_INFINITY;const s=((t=i.encumbrance)==null?void 0:t.movementApMultiplier)??1;return Number.isFinite(s)?Math.max(1,Math.ceil(un*Math.max(s,0))):Number.POSITIVE_INFINITY}return un},Gu=e=>{var t;if("skills"in e){const i=e,s=((t=i.equipped.weapon)==null?void 0:t.apCost)??pt,n=Math.max(0,s);return Zi(i)?0:qu(i,n)}return pt},Vu=(e,t)=>{const i=Math.abs(e.x-t.x),s=Math.abs(e.y-t.y);return i===1&&s===0||i===0&&s===1},_e=(e,t,i)=>{if(!Number.isFinite(i)||i<=0)return console.warn("[CombatSystem] Invalid attack range:",i),!1;const s=Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2));return s>0&&s<=i},zu=(e,t)=>Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)),oe=(e,t)=>Math.abs(t.x-e.x)+Math.abs(t.y-e.y),Vi=e=>{try{return _r(e)}catch(t){return console.warn("[CombatSystem] Failed to calculate equipment-aware stats, falling back to base attributes.",t),Qi(e.skills)}},Uu=(e,t,i)=>{const s=_a(i),{level:n,attackDirection:a}=Da(e,t,s),r=zu(e.position,t.position);let o=.65-r*.05;if(o+=Ou[n],"skills"in e){const d=e,u=Vi(d);o+=u.hitChanceModifier/100;const h=Gt(d.equipped.weapon);o+=h.hitChanceBonus;const g=Fn(d.equipped.weapon),p=Ki(d,g);switch(g){case"smallGuns":{o+=Bn(p)/100;break}case"energyWeapons":{const m=ji(p);o+=m.hit/100;break}case"meleeCombat":{const m=$i(p);o+=m.hit/100;break}case"explosives":{const m=On(p);o+=m.accuracy/100;break}}br(d.equipped.weapon)&&(o+=wr(d))}if("skills"in t){const d=Vi(t);o-=d.dodgeChance/100}const l=Nu();l!==0&&(o+=l);const c=Math.max(.1,Math.min(.95,o));return console.log("[CombatSystem] calculateHitChance:",{attacker:e.id,target:t.id,distance:r,attackDirection:a,coverLevel:n,finalHitChance:c}),c},Ba=(e,t,i)=>{var F,q,Le,Ie,xe,gs,fs,ys,Ss,vs;const s=_a(i),n=Da(e,t,s),a=Gu(e);if(!Number.isFinite(a)||e.actionPoints<a)return{success:!1,damage:0,isCritical:!1,newAttacker:e,newTarget:t,events:void 0};if("skills"in e){const E=e.equipped.weapon;if(E!=null&&E.durability&&E.durability.current<=0)return{success:!1,damage:0,isCritical:!1,newAttacker:e,newTarget:t,events:[{type:"weaponBroken",message:`${E.name} is inoperable—repair or swap weapons before attacking.`}]}}const r=[],o=Uu(e,t,s),c=mn()<=o;let d=0,u=!1,h=e,g;const p=ei(e.position,t.position);let m,f=1,w=!1,v=!1,M=!1,b=!1,A,x=Gt(),I=0,k=0;if("skills"in e){if(m=e.equipped.weapon,f=fn(m),w=nt(m,"silenced"),v=nt(m,"armorPiercing"),M=nt(m,"energy"),b=nt(m,"hollowPoint"),x=Gt(m),m){const z=m.magazineSize??0;I=z>0?Math.max(1,Math.round(z*(x.magazineSizeMultiplier??1))):0,k=I>0?Math.min(I,m.currentMagazine??I):0,I>0&&k<=0&&(k=I)}w=w||x.silenced,x.armorPiercingFactor!==void 0&&(v=!0,A=x.armorPiercingFactor)}let L=1,S,C=0;if("skills"in t){const z=t;S=z.equipped.bodyArmor??z.equipped.armor,L=fn(S),C=Math.max(0,Math.round(kr(z)))}if(c){let z=0;if("skills"in e){const E=e,Ce=Vi(E),U=Xi(E),je=(m==null?void 0:m.damage)??Wi,za=!m||m.range<=1?Ce.meleeDamageBonus:0,ws=Fn(m),Ps=Ki(E,ws);let Pt=Rr(je,U,za);switch(ws){case"energyWeapons":{z=ji(Ps).crit;break}case"meleeCombat":{const ke=$i(Ps);Pt+=ke.damage;break}}Pt=Math.max(0,Pt);let Mt=f;Mt*=x.damageMultiplier??1,Mt*=Bu[n.level],b&&(Mt*=C>0?.5:1.25),d=Math.round(Pt*Mt),d=Math.max(0,d),x.critChanceBonus&&(z+=x.critChanceBonus);const Ms=Math.max(0,Math.min(95,Ce.criticalChance+z));let As=!1;if(!("skills"in t)&&me(E,"executioner")){const ke=t;ke.maxHealth>0&&ke.health<=ke.maxHealth*.25&&(d=Math.round(d*1.5),As=!0,u=!0)}!As&&Ms>0&&mn()<=Ms/100&&(d=Math.round(d*1.5),u=!0)}else d="damage"in e?e.damage:Wi;if("skills"in t&&d>0){let E=Math.round(C*L);v&&E>0&&(E=Math.max(0,Math.floor(E*(A??.5)))),M&&(E=0),E>0&&(d=Er(d,E))}}if("skills"in t){const z=t,E=gn(z);if(E.health=Math.max(0,z.health-d),c&&(S!=null&&S.durability)){const Ce=at(S),U=yn(S,1),je=at(U);Sn(r,"armor",U.name,Ce,je),((F=E.equipped.bodyArmor)==null?void 0:F.id)===S.id&&(E.equipped.bodyArmor=U),((q=E.equipped.armor)==null?void 0:q.id)===S.id&&(E.equipped.armor=U),((Ie=(Le=E.equippedSlots)==null?void 0:Le.bodyArmor)==null?void 0:Ie.id)===S.id&&(E.equippedSlots.bodyArmor=U)}g=E}else g={...t,health:Math.max(0,t.health-d)};if("skills"in e){const E=gn(e);if(m){const Ce=at(m),U=yn(m,1),je=at(U);if(m.durability&&Sn(r,"weapon",U.name,Ce,je),I>0){const bs=Math.max(0,Math.min(I,k-1));U.currentMagazine=bs}E.equipped.weapon=U,((gs=(xe=E.equippedSlots)==null?void 0:xe.primaryWeapon)==null?void 0:gs.id)===m.id&&(E.equippedSlots.primaryWeapon=U),((ys=(fs=E.equippedSlots)==null?void 0:fs.secondaryWeapon)==null?void 0:ys.id)===m.id&&(E.equippedSlots.secondaryWeapon=U),((vs=(Ss=E.equippedSlots)==null?void 0:Ss.meleeWeapon)==null?void 0:vs.id)===m.id&&(E.equippedSlots.meleeWeapon=U)}m&&m.range>1&&!w&&r.push({type:"weaponNoise",message:`${m.name} echoes loudly—nearby hostiles are on edge.`}),E.actionPoints=Math.max(0,E.actionPoints-a),h=Mr(E)}else h={...e,actionPoints:Math.max(0,e.actionPoints-a)};return{success:c,damage:d,isCritical:u,newAttacker:qi(La(h,p),s.mapArea),newTarget:qi(g,s.mapArea),events:r.length>0?r:void 0}},cs=(e,t,i,s,n)=>{const a=Fa(e);if(!Number.isFinite(a)||e.actionPoints<a||!Vu(e.position,t))return!1;const r=n.filter(l=>l.id!==e.id),o=e.id===s.id?{...s,position:{x:-1,y:-1}}:s;return Me(t,i,o,r)},wt=(e,t)=>{const i=Fa(e);return!Number.isFinite(i)||i===Number.POSITIVE_INFINITY?e:{...e,position:t,actionPoints:Math.max(0,e.actionPoints-i)}},Ge=(e,t)=>Reflect.get(e,t),gi=(e,t)=>{const i=Ge(e,t);if(i==null)throw new Error(`[InputModule] Missing required scene value: ${t}`);return i},Qe=(e,t,...i)=>{const s=Ge(e,t);if(typeof s!="function")throw new Error(`[InputModule] Missing required scene method: ${t}`);return s.apply(e,i)},Ku=e=>({cameras:gi(e,"cameras"),sys:gi(e,"sys"),pathGraphics:gi(e,"pathGraphics"),getCurrentMapArea:()=>Ge(e,"currentMapArea")??null,setCurrentMapArea:t=>{Reflect.set(e,"currentMapArea",t)},getPlayerInitialPosition:()=>Ge(e,"playerInitialPosition"),getLastPlayerGridPosition:()=>Ge(e,"lastPlayerGridPosition")??null,getCoverDebugGraphics:()=>Ge(e,"coverDebugGraphics"),worldToGrid:(t,i)=>Qe(e,"worldToGrid",t,i),getIsoMetrics:()=>Qe(e,"getIsoMetrics"),calculatePixelPosition:(t,i)=>Qe(e,"calculatePixelPosition",t,i),getDiamondPoints:(t,i,s,n)=>Qe(e,"getDiamondPoints",t,i,s,n),renderStaticProps:()=>{Qe(e,"renderStaticProps")}});class ju{constructor(t,i){y(this,"key","input");y(this,"context");y(this,"ports");y(this,"handlePickupStateSync",t=>{var n;const i=t,s=this.ports.getCurrentMapArea();!this.ports.sys.isActive()||!s||(n=i.detail)!=null&&n.areaId&&i.detail.areaId!==s.id||(this.ports.setCurrentMapArea(this.context.getState().world.currentMapArea),this.ports.renderStaticProps())});y(this,"handlePathPreview",t=>{if(!this.ports.sys.isActive())return;const s=t.detail;if(!s){this.clearPathPreview();return}const n=this.ports.getCurrentMapArea();if(!n||s.areaId!==n.id){this.clearPathPreview();return}if(this.ports.pathGraphics.clear(),!s.path||s.path.length===0)return;const{tileWidth:a,tileHeight:r}=this.ports.getIsoMetrics(),o=s.path.length;s.path.forEach((c,d)=>{const u=this.ports.calculatePixelPosition(c.x,c.y),h=d===s.path.length-1?.8:.55,g=this.ports.getDiamondPoints(u.x,u.y,a*h,r*h);let p,m;d===s.path.length-1?(p=16762967,m=.5):o<=3?(p=3462041,m=.32):o<=6?(p=16498468,m=.35):o<=9?(p=16486972,m=.38):(p=16281969,m=.4),this.ports.pathGraphics.fillStyle(p,m),this.ports.pathGraphics.fillPoints(g,!0)});const l=s.path[s.path.length-1];this.renderCoverPreview(l)});this.ports=i??Ku(t)}init(t){this.context=t}onCreate(){this.context.listenWindow(Hi,this.handlePathPreview),this.context.listenWindow(Ru,this.handlePickupStateSync),this.context.listenInput("pointerdown",this.handlePointerDown,this)}handlePointerDown(t){const i=this.ports.getCurrentMapArea();if(!i||!this.ports.sys.isActive()||!t.leftButtonDown())return;const s=this.ports.cameras.main.getWorldPoint(t.x,t.y),n=this.ports.worldToGrid(s.x,s.y);if(!n)return;const{x:a,y:r}=n;if(a<0||r<0||a>=i.width||r>=i.height)return;const o=i.tiles[r][a];!o.isWalkable&&o.type!==R.DOOR||window.dispatchEvent(new CustomEvent(Au,{detail:{position:n,areaId:i.id}}))}clearPathPreview(){var t;(t=this.ports.pathGraphics)==null||t.clear(),this.renderCoverPreview()}renderCoverPreview(t){var v;const i=this.ports.getCoverDebugGraphics();if(!i)return;i.clear();const s=this.ports.getCurrentMapArea();if(!t||!s){i.setVisible(!1);return}const n=this.ports.getLastPlayerGridPosition()??this.ports.getPlayerInitialPosition();if(!n){i.setVisible(!1);return}const a=(v=s.tiles[t.y])==null?void 0:v[t.x];if(!(a!=null&&a.cover)){i.setVisible(!1);return}const r=ei(t,n),o=a.cover[r];if(!o||o==="none"){i.setVisible(!1);return}const{tileWidth:l,tileHeight:c}=this.ports.getIsoMetrics(),d=this.ports.calculatePixelPosition(t.x,t.y),u=this.ports.getDiamondPoints(d.x,d.y,l*.7,c*.7),[h,g,p,m]=u,f=o==="full"?3718648:16498468,w=o==="full"?.35:.25;switch(i.fillStyle(f,w),r){case"north":i.fillTriangle(h.x,h.y,g.x,g.y,m.x,m.y);break;case"south":i.fillTriangle(p.x,p.y,g.x,g.y,m.x,m.y);break;case"east":i.fillTriangle(g.x,g.y,h.x,h.y,p.x,p.y);break;case"west":i.fillTriangle(m.x,m.y,p.x,p.y,h.x,h.y);break}i.fillCircle(d.x,d.y,c*.08),i.setVisible(!0)}}const fe=(e,t,i)=>i<t?t:Math.min(Math.max(e,t),i),rt=(e,t=4)=>{const i=10**t;return Math.round(e*i)/i},vn=2,$u=(e,t,i,s,n)=>{const a=e.map(o=>`${o.id}:${o.position.x}:${o.position.y}:${o.health}`).join("|"),r=t.map(o=>`${o.id}:${o.position.x}:${o.position.y}`).join("|");return`${i??"player"}:${s}:${n}::${a}::${r}`},Yu=e=>e.map(t=>`${t.id}:${t.x}:${t.y}:${t.status}`).join("|"),Zu=()=>typeof window>"u"?1:window.devicePixelRatio||1,Xu=(e,t,i)=>{const s=t/Math.max(1,e.width),n=i/Math.max(1,e.height),a=Math.min(s,n),r=Math.max(.6,Math.min(4,a||vn));return Number.isFinite(r)&&r>0?r:vn},Qu=(e,t)=>{const i=Math.max(1,t.width),s=Math.max(1,t.height),n=Math.max(1e-4,e.width),a=Math.max(1e-4,e.height),r=e.x+n/2,o=e.y+a/2,l=.001,c=Math.max(l,n),d=Math.max(l,a),u=Math.min(i,c),h=Math.min(s,d),g=u/2,p=h/2,m=g,f=Math.max(g,i-g),w=p,v=Math.max(p,s-p),M=fe(r,m,f),b=fe(o,w,v),A=rt(u),x=rt(h),I=fe(M,A/2,Math.max(A/2,i-A/2)),k=fe(b,x/2,Math.max(x/2,s-x/2)),L=fe(rt(I-A/2),0,Math.max(0,i-A)),S=fe(rt(k-x/2),0,Math.max(0,s-x));return{x:L,y:S,width:A,height:x,zoom:e.zoom}};class Ju{constructor(t){y(this,"scene",null);y(this,"viewport",null);y(this,"tileSignature",null);y(this,"config");y(this,"lastRenderState",null);this.config={maxCanvasWidth:(t==null?void 0:t.maxCanvasWidth)??180,maxCanvasHeight:(t==null?void 0:t.maxCanvasHeight)??160,minZoom:(t==null?void 0:t.minZoom)??.6,maxZoom:(t==null?void 0:t.maxZoom)??3}}bindScene(t){this.scene=t}setViewport(t){this.viewport=t}setCanvasBounds(t,i){const s=Number.isFinite(t)?Math.floor(t):0,n=Number.isFinite(i)?Math.floor(i):0;if(s<=0||n<=0)return!1;const a=fe(s,120,4096),r=fe(n,80,4096);return a===this.config.maxCanvasWidth&&r===this.config.maxCanvasHeight?!1:(this.config={...this.config,maxCanvasWidth:a,maxCanvasHeight:r},!0)}compose(t,i,s){var S,C;const n=t.world.currentMapArea;if(!n)return null;const a=Xu(n,this.config.maxCanvasWidth,this.config.maxCanvasHeight),r=rt(a*fe(i,this.config.minZoom,this.config.maxZoom)),o=Math.ceil(n.width*r),l=Math.ceil(n.height*r),c=Zu(),d=t.player.data,u=t.world.currentMapArea.entities.enemies,h=t.world.currentMapArea.entities.npcs,g=t.world.currentMapArea.entities.items,p=t.surveillance.zones[n.id],m=$u(u,h,d.id,d.position.x,d.position.y),f=p?this.buildCameras(p.cameras):[],w=this.createCameraSignature(f),v=n.tiles;let M=((S=this.tileSignature)==null?void 0:S.version)??0;(!this.tileSignature||this.tileSignature.areaId!==n.id||this.tileSignature.ref!==v)&&(M+=1,this.tileSignature={areaId:n.id,ref:v,version:M});const b=this.viewport??{x:0,y:0,width:Math.min(n.width,Math.ceil(n.width*.4)),height:Math.min(n.height,Math.ceil(n.height*.4)),zoom:this.scene?this.scene.cameras.main.zoom:1},A=Qu(b,n);this.viewport=A;const x=this.buildObjectives(g),I=Yu(x),k=s&&s.length?s.map(F=>`${F.x}:${F.y}`).join("|"):"",L={version:(((C=this.lastRenderState)==null?void 0:C.version)??0)+1,areaId:n.id,areaName:n.name,mapWidth:n.width,mapHeight:n.height,logicalWidth:o,logicalHeight:l,tileScale:r,devicePixelRatio:c,baseTileScale:a,userZoom:r/a,tileVersion:M,tiles:v,entities:this.buildEntities(d.id??"player",d.position.x,d.position.y,u,h),entitiesSignature:m,cameras:f,camerasSignature:w,viewport:A,curfewActive:t.world.curfewActive,timestamp:Date.now(),path:s??void 0,pathSignature:k,objectiveMarkers:x,objectivesSignature:I,dirtyLayers:this.resolveDirtyLayers({tileVersion:M,entitySignature:m,cameraSignature:w,objectivesSignature:I,pathSignature:k,viewport:A,curfewActive:t.world.curfewActive,tileScale:r,areaId:n.id})};return this.lastRenderState=L,L}buildEntities(t,i,s,n,a){const r=[{id:t,kind:"player",x:i,y:s,status:"active"}];return n.forEach(o=>{r.push({id:o.id,kind:"enemy",x:o.position.x,y:o.position.y,status:o.health>0?"active":"inactive"})}),a.forEach(o=>{r.push({id:o.id,kind:"npc",x:o.position.x,y:o.position.y,status:"active"})}),r}buildCameras(t){return Object.values(t).map(i=>({id:i.id,type:i.type,x:i.position.x,y:i.position.y,alertState:i.alertState,isActive:i.isActive}))}createCameraSignature(t){return t.length?t.map(i=>`${i.id}:${i.type}:${i.x}:${i.y}:${i.alertState}:${i.isActive?1:0}`).join("|"):""}buildObjectives(t){return t.filter(i=>!!i.position).map(i=>({id:i.id,label:i.name,x:i.position.x,y:i.position.y,status:"active"}))}resolveDirtyLayers(t){const i=this.lastRenderState;if(!i)return{tiles:!0,overlays:!0,entities:!0,viewport:!0,path:!!t.pathSignature};const s=i.areaId!==t.areaId,n=i.tileScale!==t.tileScale,a=s||i.tileVersion!==t.tileVersion||n,r=s||i.camerasSignature!==t.cameraSignature||n,o=s||i.entitiesSignature!==t.entitySignature||n||r,l=s||i.objectivesSignature!==t.objectivesSignature||n,c=s||i.viewport.x!==t.viewport.x||i.viewport.y!==t.viewport.y||i.viewport.width!==t.viewport.width||i.viewport.height!==t.viewport.height||i.viewport.zoom!==t.viewport.zoom||i.tileScale!==t.tileScale,d=i.pathSignature!==t.pathSignature||n,u=s||i.curfewActive!==t.curfewActive||l||c;return{tiles:a,overlays:u,entities:o||l,viewport:c,path:d}}}const eh=typeof window<"u"?window.requestAnimationFrame.bind(window):void 0,bn=typeof window<"u"?window.cancelAnimationFrame.bind(window):void 0,th=(e,t,i)=>i<t?t:Math.min(Math.max(e,t),i);class ih extends EventTarget{constructor(){super(...arguments);y(this,"scene",null);y(this,"storeUnsubscribe",null);y(this,"pendingFrame",null);y(this,"pendingStoreUpdate",!1);y(this,"pendingViewportUpdate",!1);y(this,"controller",new Ju);y(this,"lastState",null);y(this,"userZoom",1);y(this,"minZoom",.6);y(this,"maxZoom",3);y(this,"lastPath",null);y(this,"raf",eh);y(this,"handlePathPreview",i=>{const s=i.detail,a=D.getState().world.currentMapArea;if(!a||s.areaId!==a.id)return;const r=s.path??[];this.lastPath=r.length?r:null,this.pendingStoreUpdate=!0,this.scheduleBroadcast()})}initialize(i){this.scene!==i&&(this.shutdown(),this.scene=i,this.controller.bindScene(i),this.storeUnsubscribe=D.subscribe(()=>{this.pendingStoreUpdate=!0,this.scheduleBroadcast()}),typeof window<"u"&&window.addEventListener(Hi,this.handlePathPreview),this.pendingStoreUpdate=!0,this.scheduleBroadcast(!0))}shutdown(){this.storeUnsubscribe&&(this.storeUnsubscribe(),this.storeUnsubscribe=null),this.pendingFrame!==null&&this.raf&&bn&&bn(this.pendingFrame),this.pendingFrame=null,this.controller.bindScene(null),this.scene=null,typeof window<"u"&&window.removeEventListener(Hi,this.handlePathPreview)}getState(){return this.lastState}updateViewport(i){this.controller.setViewport({x:i.x,y:i.y,width:i.width,height:i.height,zoom:i.zoom}),this.pendingViewportUpdate=!0,this.scheduleBroadcast()}emitInteraction(i){if(this.scene)switch(i.type){case Iu:{const s=i.animate??!0;this.scene.focusCameraOnGridPosition(i.gridX,i.gridY,s);break}case ku:{const s=i.animate??!0;this.scene.focusCameraOnGridPosition(i.target.x,i.target.y,s);break}}}setZoom(i){const s=th(i,this.minZoom,this.maxZoom);Math.abs(s-this.userZoom)<1e-4||(this.userZoom=s,this.pendingStoreUpdate=!0,this.dispatchEvent(new CustomEvent(Cu,{detail:{zoom:this.userZoom}})),this.scheduleBroadcast())}adjustZoom(i){this.setZoom(this.userZoom+i)}getZoom(){return this.userZoom}centerOnPlayer(i=!0){if(!this.scene)return;const n=D.getState().player.data.position;this.scene.focusCameraOnGridPosition(n.x,n.y,i)}setCanvasBounds(i,s){this.controller.setCanvasBounds(i,s)&&(this.pendingStoreUpdate=!0,this.scheduleBroadcast())}requestImmediateState(){this.pendingStoreUpdate=!0,this.scheduleBroadcast(!0)}scheduleBroadcast(i=!1){if(i||!this.raf){this.broadcast();return}this.pendingFrame===null&&(this.pendingFrame=this.raf(()=>{this.pendingFrame=null,this.broadcast()}))}composeState(){return this.controller.compose(D.getState(),this.userZoom,this.lastPath)}broadcast(){if(!this.pendingStoreUpdate&&!this.pendingViewportUpdate)return;const i=this.composeState();if(this.pendingStoreUpdate=!1,this.pendingViewportUpdate=!1,!i)return;const s=this.shouldEmit(i);this.lastState=i,s&&this.dispatchEvent(new CustomEvent(xu,{detail:i}))}shouldEmit(i){if(!this.lastState)return!0;const s=this.lastState;if(i.areaId!==s.areaId)return!0;const n=i.dirtyLayers;return n.tiles||n.entities||n.overlays||n.viewport||n.path}}const fi=new ih,ds=(e,t)=>Reflect.get(e,t),wn=(e,t)=>{const i=ds(e,t);if(i==null)throw new Error(`[MinimapBridgeModule] Missing required scene value: ${t}`);return i},sh=(e,t,...i)=>{const s=ds(e,t);if(typeof s!="function")throw new Error(`[MinimapBridgeModule] Missing required scene method: ${t}`);return s.apply(e,i)},nh=e=>({cameras:wn(e,"cameras"),sys:wn(e,"sys"),getCurrentMapArea:()=>ds(e,"currentMapArea")??null,worldToGridContinuous:(t,i)=>sh(e,"worldToGridContinuous",t,i)});class ah{constructor(t,i){y(this,"key","minimapBridge");y(this,"ports");this.scene=t,this.ports=i??nh(t)}init(t){}onCreate(){fi.initialize(this.scene)}onShutdown(){fi.shutdown()}emitViewportUpdate(){if(!this.ports.getCurrentMapArea()||!this.ports.sys.isActive())return;const i=this.ports.cameras.main,s=i.worldView,n=this.ports.worldToGridContinuous(s.x,s.y),a=this.ports.worldToGridContinuous(s.x+s.width,s.y),r=this.ports.worldToGridContinuous(s.x,s.y+s.height),o=this.ports.worldToGridContinuous(s.x+s.width,s.y+s.height);if(!n||!a||!r||!o)return;const l=(n.x+a.x+r.x+o.x)/4,c=(n.y+a.y+r.y+o.y)/4,d=[Math.abs(a.x-n.x),Math.abs(o.x-r.x)].filter(w=>Number.isFinite(w)),u=[Math.abs(r.y-n.y),Math.abs(o.y-a.y)].filter(w=>Number.isFinite(w)),h=d.length?d.reduce((w,v)=>w+v,0)/d.length:0,g=u.length?u.reduce((w,v)=>w+v,0)/u.length:0,p=Math.max(1e-4,h),m=Math.max(1e-4,g),f={x:l-p/2,y:c-m/2,width:p,height:m};fi.updateViewport({...f,zoom:i.zoom})}}const he=(e,t)=>Reflect.get(e,t),rh=(e,t)=>{const i=he(e,t);if(i==null)throw new Error(`[StateSyncModule] Missing required scene value: ${t}`);return i},G=(e,t,...i)=>{const s=he(e,t);if(typeof s!="function")throw new Error(`[StateSyncModule] Missing required scene method: ${t}`);return s.apply(e,i)},oh=e=>({sys:rh(e,"sys"),getCurrentMapArea:()=>he(e,"currentMapArea")??null,setCurrentMapArea:t=>{Reflect.set(e,"currentMapArea",t)},getItemMarkerSignature:t=>G(e,"getItemMarkerSignature",t),renderStaticProps:()=>{G(e,"renderStaticProps")},updateDayNightOverlay:()=>{G(e,"updateDayNightOverlay")},updatePlayerPosition:t=>{G(e,"updatePlayerPosition",t)},updatePlayerVitalsIndicator:(t,i,s)=>{G(e,"updatePlayerVitalsIndicator",t,i,s)},updateEnemies:t=>{G(e,"updateEnemies",t)},updateNpcs:t=>{G(e,"updateNpcs",t)},renderVisionCones:()=>{G(e,"renderVisionCones")},updateSurveillanceCameras:(t,i)=>{G(e,"updateSurveillanceCameras",t,i)},zoomCameraForCombat:()=>{G(e,"zoomCameraForCombat")},restoreCameraAfterCombat:()=>{G(e,"restoreCameraAfterCombat")},destroyPlayerVitalsIndicator:()=>{G(e,"destroyPlayerVitalsIndicator")},destroyCameraSprites:()=>{G(e,"destroyCameraSprites")},setupCameraAndMap:()=>{G(e,"setupCameraAndMap")},clearPathPreview:()=>{G(e,"clearPathPreview")},enablePlayerCameraFollow:()=>{G(e,"enablePlayerCameraFollow")},resetCameraRuntimeStateForMapTransition:()=>{var i;const t=he(e,"cameraModule");(i=t==null?void 0:t.resetForMapTransition)==null||i.call(t)},clearEntityRuntimeStateForMapTransition:()=>{var i;const t=he(e,"entityRenderModule");(i=t==null?void 0:t.clearForMapTransition)==null||i.call(t)},clearWorldRuntimeStateForMapTransition:()=>{var i;const t=he(e,"worldRenderModule");(i=t==null?void 0:t.clearForMapTransition)==null||i.call(t)},resetEntityCombatIndicators:()=>{var i;const t=he(e,"entityRenderModule");(i=t==null?void 0:t.resetCombatIndicators)==null||i.call(t)},readRuntimeState:()=>{const t=he(e,"currentMapArea");return{curfewActive:!!he(e,"curfewActive"),inCombat:!!he(e,"inCombat"),lastMapAreaId:(t==null?void 0:t.id)??null,isMapTransitionPending:!1}},writeRuntimeState:t=>{Reflect.set(e,"curfewActive",t.curfewActive),Reflect.set(e,"inCombat",t.inCombat)}}),lh=()=>({curfewActive:!1,inCombat:!1,lastMapAreaId:null,isMapTransitionPending:!1});class ch{constructor(t,i){y(this,"key","stateSync");y(this,"ports");y(this,"runtimeState");var s,n;this.ports=i??oh(t),this.runtimeState={...lh(),...(n=(s=this.ports).readRuntimeState)==null?void 0:n.call(s)},this.pushRuntimeStateToPorts()}init(){}isInCombat(){return this.runtimeState.inCombat}isCurfewActive(){return this.runtimeState.curfewActive}onStateChange(t,i){var m,f,w,v,M,b,A,x,I,k,L,S;const s=this.ports.getCurrentMapArea();if(!this.ports.sys.isActive()||!s)return;const n=i.player.data,a=i.world,r=a.currentMapArea.entities.enemies,o=this.runtimeState.inCombat;if(this.runtimeState.inCombat=a.inCombat,this.runtimeState.inCombat&&!o&&this.ports.zoomCameraForCombat(),!this.runtimeState.inCombat&&o&&(this.ports.restoreCameraAfterCombat(),this.ports.destroyPlayerVitalsIndicator(),(f=(m=this.ports).resetEntityCombatIndicators)==null||f.call(m)),this.ports.updateDayNightOverlay(),!a.currentMapArea||!s){this.pushRuntimeStateToPorts();return}const l=a.currentMapArea,c=this.runtimeState.lastMapAreaId??s.id,d=l.id;this.runtimeState.isMapTransitionPending=c!==d,this.runtimeState.isMapTransitionPending&&((v=(w=this.ports).resetCameraRuntimeStateForMapTransition)==null||v.call(w),(b=(M=this.ports).clearEntityRuntimeStateForMapTransition)==null||b.call(M),(x=(A=this.ports).clearWorldRuntimeStateForMapTransition)==null||x.call(A),this.ports.destroyCameraSprites(),this.ports.setCurrentMapArea(l),this.ports.setupCameraAndMap(),this.ports.clearPathPreview(),this.ports.enablePlayerCameraFollow(),this.runtimeState.lastMapAreaId=d,this.runtimeState.isMapTransitionPending=!1);const u=this.ports.getItemMarkerSignature(s);this.ports.setCurrentMapArea(l);const h=this.ports.getItemMarkerSignature(l);u!==h&&this.ports.renderStaticProps(),this.runtimeState.curfewActive=a.curfewActive,this.ports.updatePlayerPosition(n.position),this.ports.updatePlayerVitalsIndicator(n.position,n.health,n.maxHealth),this.ports.updateEnemies(r),this.ports.updateNpcs(l.entities.npcs),this.ports.renderVisionCones();const g=(k=(I=i.surveillance)==null?void 0:I.zones)==null?void 0:k[l.id],p=((S=(L=i.surveillance)==null?void 0:L.hud)==null?void 0:S.overlayEnabled)??!1;this.ports.updateSurveillanceCameras(g,p),this.runtimeState.lastMapAreaId=d,this.pushRuntimeStateToPorts()}pushRuntimeStateToPorts(){var t,i;(i=(t=this.ports).writeRuntimeState)==null||i.call(t,this.runtimeState)}}const We={suspicionThreshold:30,investigationThreshold:60,alarmThreshold:100,progressGainPerTick:10,progressDecayPerTick:5,reinforcementDelay:2e3},Oa=(e,t,i)=>{const s=t.x-e.x,n=t.y-e.y;if(Math.sqrt(s*s+n*n)>i.range)return!1;const o=(Math.atan2(n,s)*(180/Math.PI)+360)%360,l=(i.direction+360)%360;let c=Math.abs(o-l);return c>180&&(c=360-c),c<=i.angle/2},Na=(e,t,i)=>{const s=dh(e,t);for(const n of s){if(n.x===e.x&&n.y===e.y||n.x===t.x&&n.y===t.y)continue;if(n.x<0||n.y<0||n.y>=i.height||n.x>=i.width)return!1;const a=i.tiles[n.y][n.x];if(!a.isWalkable&&a.type!=="cover")return!1}return!0},dh=(e,t)=>{const i=[];let s=Math.floor(e.x),n=Math.floor(e.y);const a=Math.floor(t.x),r=Math.floor(t.y),o=Math.abs(a-s),l=Math.abs(r-n),c=s<a?1:-1,d=n<r?1:-1;let u=o-l;for(;i.push({x:s,y:n}),!(s===a&&n===r);){const h=2*u;h>-l&&(u-=l,s+=c),h<o&&(u+=o,n+=d)}return i},Ha=(e,t,i)=>!e.visionCone||!Oa(e.position,t.position,e.visionCone)?!1:Na(e.position,t.position,i),uh=(e,t,i=1)=>{const s=e.alertProgress??0;let n=s;if(t){const o=We.progressGainPerTick*Math.max(0,i);n=Math.min(100,s+o)}else n=Math.max(0,s-We.progressDecayPerTick);let a=B.IDLE;n>=We.alarmThreshold?a=B.ALARMED:n>=We.investigationThreshold?a=B.INVESTIGATING:n>=We.suspicionThreshold&&(a=B.SUSPICIOUS);const r=t?void 0:e.lastKnownPlayerPosition;return{...e,alertProgress:n,alertLevel:a,lastKnownPlayerPosition:r}},hh=(e,t)=>{if(!e.visionCone)return e;const i=t.x-e.position.x,s=t.y-e.position.y,a=(Math.atan2(s,i)*(180/Math.PI)+360)%360;return{...e,visionCone:{...e.visionCone,direction:a}}},ph=(e,t,i)=>{const s=[],{range:n}=t;for(let a=-n;a<=n;a++)for(let r=-n;r<=n;r++){const o={x:e.x+r,y:e.y+a};o.x<0||o.y<0||o.y>=i.height||o.x>=i.width||Oa(e,o,t)&&Na(e,o,i)&&s.push(o)}return s},Pn=P.Math.DEG_TO_RAD,Je={[ne.IDLE]:{fill:3900150,alpha:.15},[ne.SUSPICIOUS]:{fill:16436245,alpha:.22},[ne.ALARMED]:{fill:15680580,alpha:.3},[ne.DISABLED]:{fill:6583435,alpha:.12}};class mh extends P.GameObjects.Container{constructor(i,s,n,a){super(i,s,n);y(this,"housing");y(this,"lens");y(this,"led");y(this,"cone");y(this,"ledTween",null);y(this,"rangePixels");y(this,"fieldOfView");y(this,"direction");y(this,"tileSize");y(this,"isActiveSprite",!1);y(this,"alertState",ne.DISABLED);y(this,"overlayVisible",!1);const{tileSize:r,rangeTiles:o,fieldOfView:l,initialDirection:c}=a;this.tileSize=r,this.fieldOfView=l,this.direction=c,this.rangePixels=o*r,this.housing=i.add.rectangle(0,0,r*.5,r*.35,3355443,1),this.housing.setOrigin(.5,.5),this.lens=i.add.ellipse(r*.15,0,r*.22,r*.16,0,1),this.lens.setStrokeStyle(1,2042167,.6),this.led=i.add.circle(-r*.18,-r*.08,r*.12,16711680,1),this.led.setAlpha(0),this.cone=i.add.graphics(),this.cone.setAlpha(0),this.cone.setDepth(-1),this.add([this.cone,this.housing,this.lens,this.led]),this.setSize(r,r),this.scene.add.existing(this),this.drawVisionCone(),this.setAlertState(ne.DISABLED)}setActiveState(i){this.isActiveSprite!==i&&(this.isActiveSprite=i,i?this.ledTween?this.ledTween.resume():this.ledTween=this.scene.tweens.add({targets:this.led,alpha:{from:1,to:.3},duration:1e3,ease:"Sine.easeInOut",yoyo:!0,repeat:-1}):(this.ledTween&&this.ledTween.pause(),this.led.setAlpha(0)),this.refreshConeAlpha())}setAlertState(i){this.alertState=i;const{fill:s}=Je[i];this.drawVisionCone(s),this.isActiveSprite&&i!==ne.DISABLED?this.led.setFillStyle(i===ne.ALARMED?16731471:2282478,1):i===ne.DISABLED&&this.led.setFillStyle(6583435,.8),this.refreshConeAlpha()}setDirection(i){this.direction=i,this.drawVisionCone(),this.refreshConeAlpha()}setRangeTiles(i){this.rangePixels=i*this.tileSize,this.drawVisionCone(),this.refreshConeAlpha()}updateVision(i){this.cone.setPosition(i.x-this.x,i.y-this.y)}setOverlayVisible(i){this.overlayVisible!==i&&(this.overlayVisible=i,this.refreshConeAlpha())}destroy(i){this.ledTween&&(this.ledTween.stop(),this.ledTween.remove(),this.ledTween=null),super.destroy(i)}drawVisionCone(i){const s=i??Je[this.alertState].fill;this.cone.clear();const n=(this.direction-this.fieldOfView/2)*Pn,a=(this.direction+this.fieldOfView/2)*Pn;this.cone.fillStyle(s,Je[this.alertState].alpha),this.cone.slice(0,0,this.rangePixels,n,a,!1),this.cone.fillPath(),this.cone.lineStyle(1.2,s,Math.min(.65,Je[this.alertState].alpha+.1)),this.cone.beginPath(),this.cone.moveTo(0,0),this.cone.arc(0,0,this.rangePixels,n,a,!1),this.cone.closePath(),this.cone.strokePath()}refreshConeAlpha(){const s=this.isActiveSprite&&this.overlayVisible&&this.alertState!==ne.DISABLED?Je[this.alertState].alpha:0;this.cone.setAlpha(s)}}const Wt=(e,t)=>Reflect.get(e,t),yi=(e,t,...i)=>{const s=Wt(e,t);if(typeof s!="function")throw new Error(`[SurveillanceRenderModule] Missing required scene method: ${t}`);return s.apply(e,i)},gh=e=>({getCurrentMapArea:()=>Wt(e,"currentMapArea")??null,getVisionConeGraphics:()=>Wt(e,"visionConeGraphics"),getTileSize:()=>{const t=Wt(e,"tileSize");return typeof t=="number"?t:0},getIsoMetrics:()=>yi(e,"getIsoMetrics"),calculatePixelPosition:(t,i)=>yi(e,"calculatePixelPosition",t,i),syncDepth:(t,i,s,n)=>{yi(e,"syncDepth",t,i,s,n)}});class fh{constructor(t,i){y(this,"key","surveillanceRender");y(this,"cameraSprites",new Map);y(this,"ports");this.scene=t,this.ports=i??gh(t)}init(t){}onShutdown(){this.clearCameraSprites()}clearCameraSprites(){this.cameraSprites.forEach(t=>{t.destroy(!0)}),this.cameraSprites.clear()}renderVisionCones(){const t=this.ports.getCurrentMapArea(),i=this.ports.getVisionConeGraphics();if(!t||!i)return;i.clear();const s=t.entities.enemies,n=this.ports.getIsoMetrics();s.forEach(a=>{if(!a.visionCone||a.health<=0)return;const r=ph(a.position,a.visionCone,t);if(r.length===0)return;let o=16776960,l=.1;switch(a.alertLevel){case B.SUSPICIOUS:o=16755200,l=.15;break;case B.INVESTIGATING:o=16737792,l=.2;break;case B.ALARMED:o=16711680,l=.25;break;default:o=16776960,l=.1}i.fillStyle(o,l),r.forEach(c=>{const d=this.ports.calculatePixelPosition(c.x,c.y),u=[d.x,d.y-n.tileHeight/2,d.x+n.tileWidth/2,d.y,d.x,d.y+n.tileHeight/2,d.x-n.tileWidth/2,d.y];i.fillPoints(u,!0)})})}updateSurveillanceCameras(t,i=!1){const s=this.ports.getCurrentMapArea();if(!t||!s){this.cameraSprites.size>0&&this.clearCameraSprites();return}const n=new Set(this.cameraSprites.keys()),a=this.ports.getIsoMetrics();Object.values(t.cameras).forEach(r=>{n.delete(r.id);const o=this.ports.calculatePixelPosition(r.position.x,r.position.y);let l=this.cameraSprites.get(r.id);l?(l.setPosition(o.x,o.y),l.setRangeTiles(r.range)):(l=new mh(this.scene,o.x,o.y,{tileSize:this.ports.getTileSize(),rangeTiles:r.range,fieldOfView:r.fieldOfView,initialDirection:r.currentDirection}),this.cameraSprites.set(r.id,l));const c=N.PROP_TALL+Math.round(a.tileHeight*.5);this.ports.syncDepth(l,o.x,o.y,c),l.setOverlayVisible(i),l.setActiveState(r.isActive),l.setAlertState(r.alertState),l.setDirection(r.currentDirection)}),n.forEach(r=>{const o=this.cameraSprites.get(r);o&&o.destroy(!0),this.cameraSprites.delete(r)})}}class yh{constructor(t,i){y(this,"wetReflectionAlpha");y(this,"emissiveIntensity");this.graphics=t,this.theme=i,this.wetReflectionAlpha=i.qualityBudget.wetReflectionAlpha,this.emissiveIntensity=.35}setAtmosphereProfile(t){this.wetReflectionAlpha=P.Math.Clamp(t.wetReflectionAlpha,0,.4),this.emissiveIntensity=P.Math.Clamp(t.emissiveIntensity,0,1)}drawTile(t,i){const s=i.groundOnly?{...t,type:R.FLOOR}:t,n=this.getTileBaseColor(s,i.gridX,i.gridY),a=((i.gridX*13^i.gridY*9)%9-4)*.01,r=T(n,a);if(this.drawGround(s,i,r),!i.groundOnly)switch(t.type){case R.COVER:this.drawCover(t,i,r);break;case R.WALL:this.drawWallVolume(t,i,r);break;case R.DOOR:this.drawDoorPortal(t,i,r);break;case R.WATER:case R.TRAP:this.drawHazardVariant(t,i,r);break}}drawGround(t,i,s){const n=this.getPoints(i.center.x,i.center.y,i.tileWidth,i.tileHeight),r=((Math.floor(i.gridX/4)^Math.floor(i.gridY/4))%5-2)*.03,o=T(s,r),l=T(o,.2),c=T(o,-.22);this.graphics.fillStyle(o,1),this.graphics.fillPoints(n,!0);const[d,u,h,g]=n,p=new P.Geom.Point(i.center.x,i.center.y);this.graphics.fillStyle(l,.35),this.graphics.fillPoints([d,u,p],!0),this.graphics.fillPoints([d,p,g],!0),this.graphics.fillStyle(c,.3),this.graphics.fillPoints([h,u,p],!0),this.graphics.fillPoints([h,p,g],!0),this.graphics.lineStyle(1,T(o,-.3),.42),this.graphics.strokePoints(n,!0),t.type===R.FLOOR?(i.gridX%5===0||i.gridY%5===0?(this.graphics.lineStyle(1.1,6809849,.12),this.graphics.strokePoints([d,p,h],!1),this.graphics.strokePoints([g,p,u],!1)):(i.gridX+i.gridY)%4===0&&(this.graphics.lineStyle(.85,3718648,.08),this.graphics.strokePoints(n,!0)),this.drawRoadReflection(t,i,n)):(t.type===R.COVER||t.type===R.WALL)&&(this.graphics.lineStyle(.9,16317180,.08),this.graphics.strokePoints(n,!0))}drawCover(t,i,s){const n=this.getElevationProfile(.5,i.tileWidth,i.tileHeight),a=this.getPoints(i.center.x,i.center.y,i.tileWidth,i.tileHeight),r=this.getPoints(i.center.x,i.center.y-n.heightOffset,n.topWidth,n.topHeight),o=[a[1],a[2],r[2],r[1]],l=[a[2],a[3],r[3],r[2]];this.graphics.fillStyle(T(s,-.15),.98),this.graphics.fillPoints(l,!0),this.graphics.fillStyle(T(s,-.08),.98),this.graphics.fillPoints(o,!0),this.graphics.fillStyle(T(s,.2),.95),this.graphics.fillPoints(r,!0),this.graphics.lineStyle(1.1,16498468,.3),this.graphics.strokePoints(r,!0)}drawWallVolume(t,i,s){const n=this.getElevationProfile(1.2,i.tileWidth,i.tileHeight),a=this.getPoints(i.center.x,i.center.y,i.tileWidth,i.tileHeight),r=this.getPoints(i.center.x,i.center.y-n.heightOffset,n.topWidth,n.topHeight),o=[a[1],a[2],r[2],r[1]],l=[a[2],a[3],r[3],r[2]];this.graphics.fillStyle(T(s,-.28),1),this.graphics.fillPoints(l,!0),this.graphics.fillStyle(T(s,-.16),1),this.graphics.fillPoints(o,!0);const c=T(s,.18);this.graphics.fillStyle(c,1),this.graphics.fillPoints(r,!0),this.graphics.lineStyle(1.2,2282478,.18),this.graphics.strokePoints(r,!0);const[d,u,h,g]=a,[p,m,f,w]=r;this.graphics.lineStyle(1,8246268,.2),this.graphics.strokePoints([g,w],!1),this.graphics.strokePoints([h,f],!1),this.graphics.strokePoints([u,m],!1),this.graphics.strokePoints([d,p],!1)}drawDoorPortal(t,i,s){const n=this.getPoints(i.center.x,i.center.y,i.tileWidth,i.tileHeight),[a,r,o,l]=n,c=this.lerpPoint(a,l,.22),d=this.lerpPoint(a,r,.22),u=this.lerpPoint(o,r,.3),h=this.lerpPoint(o,l,.3);this.graphics.fillStyle(T(s,-.2),.96),this.graphics.fillPoints([c,d,u,h],!0);const g=this.lerpPoint(c,h,.12),p=this.lerpPoint(d,u,.12),m=this.lerpPoint(d,u,.86),f=this.lerpPoint(c,h,.86);this.graphics.fillStyle(988970,.84),this.graphics.fillPoints([g,p,m,f],!0),this.graphics.lineStyle(1.3,3718648,.4),this.graphics.strokePoints([g,p],!1)}drawHazardVariant(t,i,s){const n=this.getPoints(i.center.x,i.center.y,i.tileWidth*.72,i.tileHeight*.72);if(t.type===R.WATER){const r=this.theme.qualityBudget.enableAnimatedHazards?.22+.12*(.5+.5*Math.sin(Date.now()%2e3/2e3*Math.PI*2)):.2;this.graphics.fillStyle(T(s,.2),r),this.graphics.fillPoints(n,!0),this.graphics.lineStyle(1,6809849,.22),this.graphics.strokePoints(n,!0);return}const a=this.theme.qualityBudget.enableAnimatedHazards?.18+.1*(.5+.5*Math.sin(Date.now()%1500/1500*Math.PI*2)):.18;this.graphics.fillStyle(T(s,.35),a),this.graphics.fillPoints(n,!0),this.graphics.lineStyle(1.1,16020150,.35),this.graphics.strokePoints(n,!0)}getTileBaseColor(t,i,s){const n=(i+s)%2===0,a=this.theme.tilePalettes;switch(t.type){case R.WALL:return n?a.wallEven:a.wallOdd;case R.COVER:return n?a.coverEven:a.coverOdd;case R.WATER:return n?a.waterEven:a.waterOdd;case R.TRAP:return n?a.trapEven:a.trapOdd;case R.DOOR:return n?a.doorEven:a.doorOdd;default:return n?a.floorEven:a.floorOdd}}getElevationProfile(t,i,s){return{heightOffset:s*(.48+t*.78),topWidth:i*Math.max(.7,1-t*.08),topHeight:s*Math.max(.62,1-t*.1)}}lerpPoint(t,i,s){return new P.Geom.Point(P.Math.Linear(t.x,i.x,s),P.Math.Linear(t.y,i.y,s))}getPoints(t,i,s,n){return Z(t,i,s,n).map(a=>new P.Geom.Point(a.x,a.y))}drawRoadReflection(t,i,s){if(!t.isWalkable||this.wetReflectionAlpha<=.01)return;const[n,a,r,o]=s,l=((i.gridX*11+i.gridY*17)%9-4)*.04,c=P.Math.Clamp(this.wetReflectionAlpha*(.7+this.emissiveIntensity*.65),.03,.28),d=T(6809849,-.12+l),u=T(16486972,-.25+l*.7);this.graphics.lineStyle(1,d,c),this.graphics.strokePoints([this.lerpPoint(o,n,.3),this.lerpPoint(r,a,.3)],!1),this.graphics.lineStyle(.8,u,c*.6),this.graphics.strokePoints([this.lerpPoint(n,a,.55),this.lerpPoint(o,r,.55)],!1)}}const Sh="block_2_2",Mn="esb",vh="esb_iso",Be=(e,t)=>{if(e===null)return t;const i=Number(e);return Number.isFinite(i)?i:t},bh=()=>{const e={heightTiles:48,baseTiles:18,scale:1.1,rotateDeg:0,offsetX:0,offsetY:0};if(typeof window>"u")return e;const t=new URLSearchParams(window.location.search);return{heightTiles:Math.max(1,Be(t.get("esbHeightTiles"),e.heightTiles)),baseTiles:Math.max(1,Be(t.get("esbBaseTiles"),e.baseTiles)),scale:Math.max(.05,Be(t.get("esbScale"),e.scale)),rotateDeg:Be(t.get("esbRot"),e.rotateDeg),offsetX:Be(t.get("esbOffX"),e.offsetX),offsetY:Be(t.get("esbOffY"),e.offsetY)}};class wh{constructor(t,i){this.scene=t,this.theme=i}createMassing(t,i,s){const n=this.scene.add.container(s.center.x,s.center.y),a=this.toLocal(s.center,s.footprint);if(t.id===Sh&&this.scene.textures.exists(Mn)){const p=bh(),m=this.scene.add.image(a.bottom.x+p.offsetX,a.bottom.y+p.offsetY,Mn,vh);m.setOrigin(.5,1);const f=s.tileHeight*p.heightTiles,w=P.Math.Distance.Between(a.left.x,a.left.y,a.right.x,a.right.y),v=f/Math.max(1,m.height),M=w/Math.max(1,m.width),b=Math.max(v,M);return m.setScale(b*p.scale),p.rotateDeg&&m.setRotation(P.Math.DegToRad(p.rotateDeg)),m.setAlpha(.98),n.add(m),n}const r=this.scene.add.graphics(),o=this.scene.add.graphics(),l=this.scene.add.graphics(),c=s.widthTiles+s.depthTiles,d=i.district==="downtown"?.78:.7,u=s.tileHeight*Math.max(.58,i.massingHeight*d),h=i.district==="downtown"?.03:.015,g=this.createRoof(a,u,h);return this.drawBaseShadow(r,a),this.drawBody(o,l,i,a,g),this.drawDistrictDetails(l,i,a,g,c),n.add([r,o,l]),n}createLabel(t,i,s,n){const a=this.scene.add.container(i.x,i.y-s*.24),r=this.scene.add.text(0,0,t.name,{fontFamily:'Orbitron, "DM Sans", sans-serif',fontSize:this.theme.qualityBudget.enableHighDensityLabels?"13px":"11px",fontStyle:"700",color:n.signagePrimaryHex,stroke:n.signageSecondaryHex,strokeThickness:1.6,align:"center"});r.setOrigin(.5),r.setShadow(0,0,n.glowHex,8,!0,!0);const c=this.scene.add.rectangle(0,0,r.width+14,r.height+8,this.hexToColor(n.backdropHex),.58);return c.setStrokeStyle(1.1,this.hexToColor(n.signageSecondaryHex),.72),a.add([c,r]),a}drawBaseShadow(t,i){t.fillStyle(132622,.14),t.fillPoints([i.top,i.right,i.bottom,i.left],!0)}drawBody(t,i,s,n,a){const r=[n.right,n.bottom,a.bottom,a.right],o=[n.bottom,n.left,a.left,a.bottom],l=[n.left,n.top,a.top,a.left],c=this.hexToColor(s.backdropHex),d=T(c,-.06),u=T(c,-.13),h=T(c,-.1),g=T(c,.03);t.fillStyle(h,.72),t.fillPoints(l,!0),t.fillStyle(d,.74),t.fillPoints(r,!0),t.fillStyle(u,.78),t.fillPoints(o,!0),t.fillStyle(g,.8),t.fillPoints([a.top,a.right,a.bottom,a.left],!0),t.lineStyle(1.2,this.hexToColor(s.trimHex),.24),t.strokePoints([a.top,a.right,a.bottom,a.left],!0),i.lineStyle(1,this.hexToColor(s.trimHex),.16),i.strokePoints([n.bottom,a.bottom],!1),i.strokePoints([n.left,a.left],!1),i.strokePoints([n.right,a.right],!1)}drawDistrictDetails(t,i,s,n,a){const r=[s.right,s.bottom,n.bottom,n.right],o=[s.bottom,s.left,n.left,n.bottom];if(i.district==="downtown"){const g=Math.max(4,Math.min(10,Math.floor(a*.8))),p=Math.max(3,Math.min(8,Math.floor(i.massingHeight*1.7))),m=this.hexToColor(i.signageSecondaryHex);this.drawFaceGrid(t,o,g,p,m,.2),this.drawFaceGrid(t,r,g,p,m,.16),t.lineStyle(1,this.hexToColor(i.signagePrimaryHex),.36),t.strokePoints([n.left,n.bottom,n.right],!1);return}const l=this.hexToColor(i.accentHex);t.lineStyle(1,l,.2);const c=this.lerpPoint(o[0],o[3],.44),d=this.lerpPoint(o[1],o[2],.44);t.strokePoints([c,d],!1);const u=this.lerpPoint(r[0],r[3],.36),h=this.lerpPoint(r[1],r[2],.36);t.strokePoints([u,h],!1)}drawFaceGrid(t,i,s,n,a,r){t.lineStyle(1,a,r);for(let o=1;o<s;o+=1){const l=o/s,c=this.lerpPoint(i[0],i[1],l),d=this.lerpPoint(i[3],i[2],l);t.strokePoints([c,d],!1)}for(let o=1;o<n;o+=1){const l=o/n,c=this.lerpPoint(i[0],i[3],l),d=this.lerpPoint(i[1],i[2],l);t.strokePoints([c,d],!1)}}createRoof(t,i,s){return{top:this.liftAndInset(t.top,i,s),right:this.liftAndInset(t.right,i,s),bottom:this.liftAndInset(t.bottom,i,s),left:this.liftAndInset(t.left,i,s)}}liftAndInset(t,i,s){return new P.Geom.Point(t.x*(1-s),t.y*(1-s)-i)}toLocal(t,i){const s=n=>new P.Geom.Point(n.x-t.x,n.y-t.y);return{top:s(i.top),right:s(i.right),bottom:s(i.bottom),left:s(i.left)}}lerpPoint(t,i,s){return new P.Geom.Point(P.Math.Linear(t.x,i.x,s),P.Math.Linear(t.y,i.y,s))}hexToColor(t){return P.Display.Color.HexStringToColor(t).color}}const Ph=(e,t)=>{const i=e.entityProfiles[t];return{baseColor:i.baseColor,outlineColor:i.outlineColor,primaryColor:i.primaryColor,accentColor:i.accentColor,glowColor:i.glowColor,columnHeight:i.columnHeight,widthScale:i.widthScale,heightScale:i.heightScale,depthOffset:i.depthOffset}};class Mh{constructor(t,i){y(this,"motionByToken",new WeakMap);this.isoFactory=t,this.theme=i}createToken(t,i,s){const n=this.isoFactory.createCharacterToken(i,s,Ph(this.theme,t));return this.decorateToken(t,n),this.motionByToken.set(n,{lastX:i,lastY:s,cadence:Math.abs(i*17+s*31)%11*.23}),n}positionToken(t,i,s){this.isoFactory.positionCharacterToken(t,i,s);const n=this.motionByToken.get(t),a=t.container.getData("rigShell"),r=t.container.getData("rigStride");if(!n||!a||!r)return;const o=i-n.lastX,l=s-n.lastY;if(o!==0||l!==0){n.cadence+=.55;const d=P.Math.Clamp(o*.22,-.24,.24);a.setRotation(d),t.container.scaleX=o<0?-1:1,r.setAlpha(.28+Math.min(.42,Math.abs(o)*.2+Math.abs(l)*.2)),r.setScale(1+Math.abs(o)*.1,1+Math.abs(l)*.08),t.halo.setAlpha(.2+Math.min(.16,(Math.abs(o)+Math.abs(l))*.08))}else n.cadence+=.08,a.setRotation(a.rotation*.86),r.setAlpha(Math.max(.12,r.alpha*.85)),r.setScale(P.Math.Linear(r.scaleX,1,.25),P.Math.Linear(r.scaleY,1,.25)),t.halo.setAlpha(P.Math.Linear(t.halo.alpha,.2,.2));a.y=-2+Math.sin(n.cadence)*1.8,t.beacon.y=-Math.sin(n.cadence+.45)*1.25,n.lastX=i,n.lastY=s}decorateToken(t,i){const s=this.theme.entityProfiles[t],n=i.container.scene.add.graphics(),a=i.container.scene.add.graphics(),r=i.container.scene.add.graphics(),o=16*s.widthScale,l=24*s.columnHeight*.64;switch(n.fillStyle(T(s.primaryColor,-.2),.9),n.lineStyle(1.2,s.outlineColor,.95),n.fillEllipse(0,-l*.3,o,l),n.strokeEllipse(0,-l*.3,o,l),a.fillStyle(s.accentColor,.94),a.lineStyle(1,T(s.accentColor,.35),.92),r.fillStyle(s.glowColor,.18),r.fillEllipse(0,2.5,21*s.widthScale,8.4*s.heightScale),r.setBlendMode(P.BlendModes.ADD),t){case"player":n.fillStyle(T(s.accentColor,-.15),.95),n.fillTriangle(0,-l*1.08,-4.4,-l*.64,4.4,-l*.64),a.fillTriangle(0,-l*.96,-3.4,-l*.7,3.4,-l*.7);break;case"hostileNpc":n.fillStyle(T(s.primaryColor,-.34),.98),n.fillRect(-o*.55,-l*.75,o*1.1,l*.32),a.fillTriangle(-4.5,-l*.85,-8.2,-l*.58,-2.2,-l*.58),a.fillTriangle(4.5,-l*.85,2.2,-l*.58,8.2,-l*.58);break;case"interactiveNpc":n.fillStyle(T(s.primaryColor,.08),.95),n.fillEllipse(0,-l*.86,o*.88,o*.72),a.fillStyle(s.accentColor,.9),a.fillCircle(0,-l*1.02,3.2),a.fillRect(-.8,-l*.96,1.6,9.6);break;case"friendlyNpc":default:n.fillStyle(T(s.primaryColor,.04),.92),n.fillEllipse(0,-l*.87,o*.92,o*.62),a.fillTriangle(0,-l*.96,-3.8,-l*.78,3.8,-l*.78);break}i.container.addAt(n,2),i.container.add(a),i.container.add(r),i.container.setData("rigShell",n),i.container.setData("rigStride",r);const c=i.container.scene.tweens.add({targets:a,alpha:{from:.4,to:.95},yoyo:!0,repeat:-1,duration:920+(t==="hostileNpc"?180:0),ease:"Sine.easeInOut"});i.container.once(P.GameObjects.Events.DESTROY,()=>{c.isPlaying()&&c.stop()})}}const we=e=>P.Math.Clamp(e,0,1),$=(e,t,i)=>{const s=P.Display.Color.ValueToColor(e),n=P.Display.Color.ValueToColor(t),a=we(i),r=P.Math.Linear(s.red,n.red,a),o=P.Math.Linear(s.green,n.green,a),l=P.Math.Linear(s.blue,n.blue,a);return P.Display.Color.GetColor(r,o,l)},Ah=e=>{if(!e)return null;const t=e.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([0-9.]+)\)/i);if(!t)return null;const[,i,s,n,a]=t;return{color:P.Display.Color.GetColor(Number(i),Number(s),Number(n)),alpha:we(Number(a))}};class Ih{constructor(t){this.theme=t}resolveAtmosphereProfile(t){const i=we(t.districtWeight),s=t.timeSeconds%180/180*Math.PI*2,a=1-we(.5+.5*Math.sin(s-Math.PI*.5)),r=$(1323092,728122,a*.45),o=$(4071715,2166805,a*.42),l=$(o,r,i),c=$(l,396053,.3+a*.38),d=$(l,792880,.24+i*.22+a*.24),u=$(1707796,926264,i*.58),h=$(593173,1189440,i*.62),g=Math.max(1,this.theme.qualityBudget.maxFogBands),p=[];for(let A=0;A<g;A+=1){const x=(A+1)/(g+1),I=$(2760230,1522266,i*.7+x*.2),k=we((.16+a*.12)*(1-x*.72));p.push({widthFactor:1.1+x*.95,heightFactor:.34+x*.28,yFactor:.66+x*.2,color:I,alpha:k})}const m=we(.28+a*.56+i*.12+this.theme.qualityBudget.maxEmissiveZones*.012),f=we(this.theme.qualityBudget.wetReflectionAlpha*(.68+a*.65)),w=Ah(t.baseOverlayRgba),v=$(725536,2298136,1-i),M=w?$(w.color,v,.22+a*.26):v,b=we(((w==null?void 0:w.alpha)??.12+a*.32)*(.9+a*.2));return{gradientTopLeft:c,gradientTopRight:d,gradientBottomLeft:u,gradientBottomRight:h,skylineDowntownColor:$(2051962,1391198,a*.45),skylineSlumsColor:$(5909034,3808548,a*.4),skylineColumns:this.theme.preset==="cinematic"?34:this.theme.preset==="balanced"?30:24,skylineSplit:P.Math.Clamp(.24+i*.52,.2,.82),skylineAlphaBase:.22+a*.16,skylineAlphaVariance:.12,horizonGlowColor:$(6105141,2972550,i),horizonGlowAlpha:.14+a*.1,lowerHazeColor:$(329485,659485,i*.4),lowerHazeAlpha:.42+a*.2,fogBands:p,emissiveIntensity:m,wetReflectionAlpha:f,overlayColor:M,overlayAlpha:b}}}const Lt=20,An=1.06;class xh{constructor(){y(this,"previousFrameMassAlpha",new WeakMap);y(this,"previousFrameEntityVisuals",new WeakMap)}applyOcclusionReadability(t){const i=P.Math.Clamp(t.occlusionFadeFloor,.2,.9),s=P.Math.Clamp(.14+t.emissiveIntensity*.3,.12,.5);this.restorePreviousFrameState(t),t.masses.forEach(n=>{this.previousFrameMassAlpha.has(n.container)||this.previousFrameMassAlpha.set(n.container,n.container.alpha)}),t.masses.forEach(n=>{const a=new P.Geom.Rectangle(n.bounds.x-Lt,n.bounds.y-Lt,n.bounds.width+Lt*2,n.bounds.height+Lt*2),r=t.entities.filter(o=>a.contains(o.pixelX,o.pixelY));r.length&&(this.previousFrameMassAlpha.has(n.container)||this.previousFrameMassAlpha.set(n.container,n.container.alpha),n.container.setAlpha(Math.min(n.container.alpha,i)),r.forEach(o=>{var d,u,h,g,p;const l=o.token.container;this.previousFrameEntityVisuals.has(l)||this.previousFrameEntityVisuals.set(l,{haloAlpha:o.token.halo.alpha,beaconAlpha:o.token.beacon.alpha,nameAlpha:((d=o.nameLabel)==null?void 0:d.alpha)??1,nameScaleX:((u=o.nameLabel)==null?void 0:u.scaleX)??1,nameScaleY:((h=o.nameLabel)==null?void 0:h.scaleY)??1,healthAlpha:((g=o.healthBar)==null?void 0:g.alpha)??1,indicatorAlpha:((p=o.indicator)==null?void 0:p.alpha)??1});const c=o.token;c.halo.setAlpha(Math.max(c.halo.alpha,.28+s)),c.beacon.setAlpha(Math.max(c.beacon.alpha,.36+s*.75)),o.nameLabel&&(o.nameLabel.setAlpha(1),o.nameLabel.setScale(Math.max(o.nameLabel.scaleX,An),Math.max(o.nameLabel.scaleY,An))),o.healthBar&&o.healthBar.visible&&o.healthBar.setAlpha(Math.max(o.healthBar.alpha,.94)),o.indicator&&o.indicator.visible&&o.indicator.setAlpha(Math.max(o.indicator.alpha,.94))}))})}restorePreviousFrameState(t){t.masses.forEach(i=>{const s=this.previousFrameMassAlpha.get(i.container);typeof s=="number"&&i.container.setAlpha(s),this.previousFrameMassAlpha.delete(i.container)}),t.entities.forEach(i=>{this.restoreEntityBaseState(i)})}restoreEntityBaseState(t){const i=t.token.container,s=this.previousFrameEntityVisuals.get(i);s&&(t.token.halo.setAlpha(s.haloAlpha),t.token.beacon.setAlpha(s.beaconAlpha),t.nameLabel&&(t.nameLabel.setAlpha(s.nameAlpha),t.nameLabel.setScale(s.nameScaleX,s.nameScaleY)),t.healthBar&&t.healthBar.setAlpha(s.healthAlpha),t.indicator&&t.indicator.setAlpha(s.indicatorAlpha),this.previousFrameEntityVisuals.delete(i))}}const In={"items.corporate_keycard":"Keycard","items.encrypted_datapad":"Datapad","items.transit_tokens":"Transit Token","items.abandoned_medkit":"Medkit","items.holo_projector_lens":"Lens","items.saboteur_charge_kit":"Charge Kit"},xn={misc_corporate_keycard:"Keycard",misc_encrypted_datapad:"Datapad",misc_transit_tokens:"Transit Token",misc_abandoned_medkit:"Medkit",misc_holo_projector_lens:"Lens",misc_saboteur_charge_kit:"Charge Kit"},Ch=e=>e.resourceKey&&In[e.resourceKey]?In[e.resourceKey]:e.definitionId&&xn[e.definitionId]?xn[e.definitionId]:e.name,O=(e,t)=>Reflect.get(e,t),Ft=(e,t)=>{const i=O(e,t);if(i==null)throw new Error(`[WorldRenderModule] Missing required scene value: ${t}`);return i},Bt=(e,t,i)=>{const s=O(e,t);return typeof s=="number"?s:i},et=(e,t,...i)=>{const s=O(e,t);if(typeof s!="function")throw new Error(`[WorldRenderModule] Missing required scene method: ${t}`);return s.apply(e,i)},kh=()=>({visualTheme:is("balanced"),tilePainter:void 0,buildingPainter:void 0,characterRigFactory:void 0,atmosphereDirector:void 0,occlusionReadabilityController:void 0,buildingVisualProfiles:{},buildingLabels:[],buildingMassings:[],buildingMassingEntries:[],currentAtmosphereProfile:void 0,lastAtmosphereRedrawBucket:-1,lastItemMarkerSignature:""}),Th=e=>({add:Ft(e,"add"),game:Ft(e,"game"),lights:Ft(e,"lights"),mapGraphics:Ft(e,"mapGraphics"),getBackdropGraphics:()=>O(e,"backdropGraphics"),getCurrentMapArea:()=>O(e,"currentMapArea")??null,getCurrentGameTime:()=>Bt(e,"currentGameTime",0),getTileSize:()=>Bt(e,"tileSize",0),getIsoFactory:()=>O(e,"isoFactory"),ensureIsoFactory:()=>{et(e,"ensureIsoFactory")},getIsoMetrics:()=>et(e,"getIsoMetrics"),calculatePixelPosition:(t,i)=>et(e,"calculatePixelPosition",t,i),syncDepth:(t,i,s,n)=>{et(e,"syncDepth",t,i,s,n)},renderVisionCones:()=>{et(e,"renderVisionCones")},getStaticPropGroup:()=>O(e,"staticPropGroup"),setStaticPropGroup:t=>{Reflect.set(e,"staticPropGroup",t)},getLightsFeatureEnabled:()=>!!O(e,"lightsFeatureEnabled"),setLightsFeatureEnabled:t=>{Reflect.set(e,"lightsFeatureEnabled",t)},getDemoLampGrid:()=>O(e,"demoLampGrid"),setDemoLampGrid:t=>{Reflect.set(e,"demoLampGrid",t)},getDemoPointLight:()=>O(e,"demoPointLight"),setDemoPointLight:t=>{Reflect.set(e,"demoPointLight",t)},getLightingAmbientColor:()=>Bt(e,"lightingAmbientColor",988970),readEntityRuntimeState:()=>({playerToken:O(e,"playerToken"),playerNameLabel:O(e,"playerNameLabel"),enemySprites:O(e,"enemySprites")??new Map,npcSprites:O(e,"npcSprites")??new Map}),readRuntimeState:()=>({visualTheme:O(e,"visualTheme")??is("balanced"),tilePainter:O(e,"tilePainter"),buildingPainter:O(e,"buildingPainter"),characterRigFactory:O(e,"characterRigFactory"),atmosphereDirector:O(e,"atmosphereDirector"),occlusionReadabilityController:O(e,"occlusionReadabilityController"),buildingVisualProfiles:O(e,"buildingVisualProfiles")??{},buildingLabels:O(e,"buildingLabels")??[],buildingMassings:O(e,"buildingMassings")??[],buildingMassingEntries:O(e,"buildingMassingEntries")??[],currentAtmosphereProfile:O(e,"currentAtmosphereProfile"),lastAtmosphereRedrawBucket:Bt(e,"lastAtmosphereRedrawBucket",-1),lastItemMarkerSignature:O(e,"lastItemMarkerSignature")??""}),writeRuntimeState:t=>{Reflect.set(e,"visualTheme",t.visualTheme),Reflect.set(e,"tilePainter",t.tilePainter),Reflect.set(e,"buildingPainter",t.buildingPainter),Reflect.set(e,"characterRigFactory",t.characterRigFactory),Reflect.set(e,"atmosphereDirector",t.atmosphereDirector),Reflect.set(e,"occlusionReadabilityController",t.occlusionReadabilityController),Reflect.set(e,"buildingVisualProfiles",t.buildingVisualProfiles),Reflect.set(e,"buildingLabels",t.buildingLabels),Reflect.set(e,"buildingMassings",t.buildingMassings),Reflect.set(e,"buildingMassingEntries",t.buildingMassingEntries),Reflect.set(e,"currentAtmosphereProfile",t.currentAtmosphereProfile),Reflect.set(e,"lastAtmosphereRedrawBucket",t.lastAtmosphereRedrawBucket),Reflect.set(e,"lastItemMarkerSignature",t.lastItemMarkerSignature)}});class Rh{constructor(t,i){y(this,"key","worldRender");y(this,"ports");y(this,"runtimeState");var s,n;this.scene=t,this.ports=i??Th(t),this.runtimeState={...kh(),...(n=(s=this.ports).readRuntimeState)==null?void 0:n.call(s)},this.pushRuntimeStateToPorts()}init(){}onShutdown(){this.clearForMapTransition(),this.disableLighting(!0)}createCharacterToken(t,i,s){if(this.ensureVisualPipeline(),this.ports.ensureIsoFactory(),this.runtimeState.characterRigFactory)return this.runtimeState.characterRigFactory.createToken(t,i,s);const n=this.ports.getIsoFactory();if(!n)throw new Error("[WorldRenderModule] IsoObjectFactory not available while creating character token.");return n.createCharacterToken(i,s,this.runtimeState.visualTheme.entityProfiles[t])}positionCharacterToken(t,i,s){if(this.runtimeState.characterRigFactory){this.runtimeState.characterRigFactory.positionToken(t,i,s);return}const n=this.ports.getIsoFactory();if(!n)throw new Error("[WorldRenderModule] IsoObjectFactory not available while positioning character token.");n.positionCharacterToken(t,i,s)}getAtmosphereRedrawBucket(){return this.runtimeState.lastAtmosphereRedrawBucket}setAtmosphereRedrawBucket(t){this.runtimeState.lastAtmosphereRedrawBucket=t,this.pushRuntimeStateToPorts()}ensureVisualPipeline(){const t=D.getState().settings.visualQualityPreset,i=!this.runtimeState.visualTheme||this.runtimeState.visualTheme.preset!==t;(!this.runtimeState.visualTheme||this.runtimeState.visualTheme.preset!==t)&&(this.runtimeState.visualTheme=is(t)),this.ports.mapGraphics&&(!this.runtimeState.tilePainter||i)&&(this.runtimeState.tilePainter=new yh(this.ports.mapGraphics,this.runtimeState.visualTheme)),(!this.runtimeState.buildingPainter||i)&&(this.runtimeState.buildingPainter=new wh(this.scene,this.runtimeState.visualTheme)),(!this.runtimeState.atmosphereDirector||i)&&(this.runtimeState.atmosphereDirector=new Ih(this.runtimeState.visualTheme),this.runtimeState.lastAtmosphereRedrawBucket=-1),(!this.runtimeState.occlusionReadabilityController||i)&&(this.runtimeState.occlusionReadabilityController=new xh);const s=this.ports.getIsoFactory();s&&(!this.runtimeState.characterRigFactory||i)&&(this.runtimeState.characterRigFactory=new Mh(s,this.runtimeState.visualTheme));const n=this.ports.getCurrentMapArea();if(n!=null&&n.buildings){const a={};n.buildings.forEach(r=>{const o=Ot(r.district,r.signageStyle,r.propDensity);a[r.id]=r.visualProfile?{district:r.district==="downtown"?"downtown":"slums",signageStyle:r.signageStyle??o.signageStyle,propDensity:r.propDensity??o.propDensity,facadePattern:r.visualProfile.facadePattern??o.facadePattern,lotPattern:r.visualProfile.lotPattern??o.lotPattern,massingStyle:r.visualProfile.massingStyle??o.massingStyle,massingHeight:r.visualProfile.massingHeight??o.massingHeight,accentHex:r.visualProfile.accentHex??o.accentHex,glowHex:r.visualProfile.glowHex??o.glowHex,trimHex:r.visualProfile.trimHex??o.trimHex,atmosphereHex:r.visualProfile.atmosphereHex??o.atmosphereHex,signagePrimaryHex:r.visualProfile.signagePrimaryHex??o.signagePrimaryHex,signageSecondaryHex:r.visualProfile.signageSecondaryHex??o.signageSecondaryHex,backdropHex:r.visualProfile.backdropHex??o.backdropHex}:o}),this.runtimeState.buildingVisualProfiles=a}else this.runtimeState.buildingVisualProfiles={};this.pushRuntimeStateToPorts()}renderStaticProps(){const t=this.ports.getStaticPropGroup();if(t&&t.clear(!0,!0),this.ports.setDemoLampGrid(void 0),this.destroyDemoPointLight(),!this.ports.getIsoFactory()||!this.ports.getCurrentMapArea())return;this.ensureVisualPipeline(),this.ports.getStaticPropGroup()||this.ports.setStaticPropGroup(this.ports.add.group());const i=l=>{var c;l&&((c=this.ports.getStaticPropGroup())==null||c.add(l))},s=this.ports.getCurrentMapArea();if(!s)return;const n=(s.entities.npcs??[]).filter(l=>l.isInteractive),a=(s.entities.items??[]).filter(l=>!!l.position),r=this.ports.getIsoFactory();if(!r)return;const o=this.ports.getIsoMetrics();n.forEach(l=>{i(r.createPulsingHighlight(l.position.x,l.position.y,{color:2282478,alpha:.14,pulseColor:8246268,pulseAlpha:{from:.26,to:.05},pulseScale:1.22,widthScale:.58,heightScale:.58,depthOffset:9,duration:1400}))}),a.forEach(l=>{const c=l.isQuestItem?16436245:2282478,d=l.isQuestItem?16774079:8246268,u=this.ports.calculatePixelPosition(l.position.x,l.position.y),h=Ch(l);i(r.createPulsingHighlight(l.position.x,l.position.y,{color:c,alpha:l.isQuestItem?.24:.22,pulseColor:d,pulseAlpha:{from:l.isQuestItem?.34:.3,to:.08},pulseScale:l.isQuestItem?1.28:1.22,widthScale:.72,heightScale:.72,depthOffset:8,duration:l.isQuestItem?1150:1300}));const g=this.ports.add.text(u.x,u.y-o.tileHeight*.7,h,{fontFamily:'Orbitron, "DM Sans", sans-serif',fontSize:"10px",fontStyle:"700",color:l.isQuestItem?"#fde68a":"#dbeafe",align:"center"});g.setOrigin(.5,1),g.setStroke(l.isQuestItem?"#f59e0b":"#0284c7",1.1),g.setShadow(0,0,l.isQuestItem?"#f59e0b":"#38bdf8",8,!0,!0),this.ports.syncDepth(g,u.x,u.y,N.FLOATING_UI+14),i(g)}),this.ports.getLightsFeatureEnabled()&&this.rebuildLightingDemoLight(),this.runtimeState.lastItemMarkerSignature=this.getItemMarkerSignature(s),this.pushRuntimeStateToPorts()}getItemMarkerSignature(t){if(!t)return"";const i=(t.entities.items??[]).filter(s=>!!s.position);return i.length===0?"":i.map(s=>`${s.id??s.name}@${s.position.x},${s.position.y}`).sort().join("|")}applyLightingSettings(t){var a;const i=(a=this.runtimeState.visualTheme)==null?void 0:a.preset;(!this.runtimeState.visualTheme||i!==t.qualityPreset)&&(this.ensureVisualPipeline(),this.refreshVisualLayers());const s=Cs(t.qualityPreset),n=t.lightsEnabled&&t.qualityPreset!=="performance";if(n&&!this.hasLightPipelineSupport()){console.warn("[MainScene] Light2D not supported by current renderer; disabling lighting toggle."),D.dispatch(qs(!1)),ti({lightsEnabled:!1}),this.disableLighting(!0);return}n?this.enableLighting():this.disableLighting(),!s.colorMatrixEnabled&&t.colorMatrix.enabled&&ti({colorMatrix:{enabled:!1}})}refreshVisualLayers(){const t=this.ports.getCurrentMapArea();t&&(this.runtimeState.currentAtmosphereProfile=void 0,this.drawBackdrop(),this.drawMap(t.tiles),this.drawBuildingMasses(),this.drawBuildingLabels(),this.renderStaticProps(),this.ports.renderVisionCones(),this.applyOcclusionReadability(),this.pushRuntimeStateToPorts())}drawMap(t){var o,l,c;if(!this.ports.mapGraphics)return;this.ensureVisualPipeline();const i=this.resolveAtmosphereProfile();(o=this.runtimeState.tilePainter)==null||o.setAtmosphereProfile({wetReflectionAlpha:i.wetReflectionAlpha,emissiveIntensity:i.emissiveIntensity}),this.ports.mapGraphics.clear();const{tileWidth:s,tileHeight:n}=this.ports.getIsoMetrics(),a=this.ports.getCurrentMapArea(),r=new Set;(l=a==null?void 0:a.buildings)==null||l.forEach(d=>{for(let u=d.footprint.from.y;u<=d.footprint.to.y;u+=1)for(let h=d.footprint.from.x;h<=d.footprint.to.x;h+=1)r.add(`${h}:${u}`)});for(let d=0;d<t.length;d+=1)for(let u=0;u<t[0].length;u+=1){const h=t[d][u],g=this.ports.calculatePixelPosition(u,d),p=((c=a==null?void 0:a.zoneId)==null?void 0:c.startsWith("downtown_checkpoint"))&&h.type===R.COVER,m=r.has(`${u}:${d}`),f=p||m&&(h.type===R.WALL||h.type===R.COVER||h.type===R.DOOR);this.renderTile(h,g,s,n,u,d,f)}}drawBuildingMasses(){var a;this.runtimeState.buildingMassings.forEach(r=>r.destroy(!0)),this.runtimeState.buildingMassings=[],this.runtimeState.buildingMassingEntries=[];const t=this.ports.getCurrentMapArea();if(!((a=t==null?void 0:t.buildings)!=null&&a.length)||!this.runtimeState.buildingPainter){this.pushRuntimeStateToPorts();return}this.ensureVisualPipeline();const i=this.runtimeState.buildingPainter;if(!i)return;const{tileWidth:s,tileHeight:n}=this.ports.getIsoMetrics();t.buildings.forEach(r=>{const o=this.runtimeState.buildingVisualProfiles[r.id]??Ot(r.district,r.signageStyle,r.propDensity),l=r.footprint.to.x-r.footprint.from.x+1,c=r.footprint.to.y-r.footprint.from.y+1,d=this.ports.calculatePixelPosition(r.footprint.from.x,r.footprint.from.y),u=this.ports.calculatePixelPosition(r.footprint.to.x,r.footprint.from.y),h=this.ports.calculatePixelPosition(r.footprint.to.x,r.footprint.to.y),g=this.ports.calculatePixelPosition(r.footprint.from.x,r.footprint.to.y),p={top:new P.Geom.Point(d.x,d.y-n*.5),right:new P.Geom.Point(u.x+s*.5,u.y),bottom:new P.Geom.Point(h.x,h.y+n*.5),left:new P.Geom.Point(g.x-s*.5,g.y)},m={x:(p.top.x+p.right.x+p.bottom.x+p.left.x)/4,y:(p.top.y+p.right.y+p.bottom.y+p.left.y)/4},f=i.createMassing(r,o,{center:m,tileHeight:n,widthTiles:l,depthTiles:c,footprint:p});if(f.setScrollFactor(1),r.id==="block_2_2"){const I=Math.min(N.CHARACTER_BASE-1,N.PROP_TALL+Math.round(o.massingHeight*12));this.ports.syncDepth(f,p.bottom.x,p.bottom.y,I),this.runtimeState.buildingMassings.push(f);const k=this.ports.calculatePixelPosition(r.door.x,r.door.y),L=this.ports.add.container(k.x,k.y);if(L.setScrollFactor(1),typeof window<"u"&&new URLSearchParams(window.location.search).get("pocDebug")==="1"){const F=this.ports.add.text(0,-n*1.6,`door ${r.door.x},${r.door.y}`,{fontFamily:"monospace",fontSize:"10px",color:"#39d5ff",stroke:"#000000",strokeThickness:3});F.setOrigin(.5,1),L.add(F)}const S=this.ports.add.graphics();S.setBlendMode(P.BlendModes.ADD),S.fillStyle(16757596,.06),S.fillCircle(0,0,n*1.1),S.fillStyle(16742936,.04),S.fillCircle(0,0,n*.75),S.lineStyle(2,3790335,.09),S.strokeRoundedRect(-10,-18,20,30,4),S.lineStyle(1,12667903,.06),S.strokeRoundedRect(-13,-21,26,36,6),S.fillStyle(3790335,.025),S.fillRoundedRect(n*1,-n*1.25,n*2.4,n*.85,6),S.lineStyle(2,3790335,.08),S.strokeRoundedRect(n*1,-n*1.25,n*2.4,n*.85,6),S.lineStyle(1,16757596,.05),S.strokeRoundedRect(n*1.05,-n*1.2,n*2.3,n*.75,6),L.add(S),this.ports.syncDepth(L,k.x,k.y,N.PROP_LOW),this.runtimeState.buildingMassings.push(L),this.scene.tweens.add({targets:S,alpha:{from:.85,to:1},duration:2800,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});return}this.ports.syncDepth(f,p.bottom.x,p.bottom.y,N.PROP_TALL+Math.round(o.massingHeight*12)),this.runtimeState.buildingMassings.push(f);const w=o.district==="downtown"?.78:.7,v=n*Math.max(.58,o.massingHeight*w),M=Math.min(p.top.x,p.right.x,p.bottom.x,p.left.x),b=Math.max(p.top.x,p.right.x,p.bottom.x,p.left.x),A=Math.min(p.top.y-v,p.right.y-v,p.bottom.y-v,p.left.y-v),x=Math.max(p.top.y,p.right.y,p.bottom.y,p.left.y);this.runtimeState.buildingMassingEntries.push({id:r.id,container:f,bounds:new P.Geom.Rectangle(M,A,Math.max(1,b-M),Math.max(1,x-A))})}),this.pushRuntimeStateToPorts()}drawBuildingLabels(){this.runtimeState.buildingLabels.forEach(s=>s.destroy(!0)),this.runtimeState.buildingLabels=[];const t=this.ports.getCurrentMapArea();if(!(t!=null&&t.buildings)||t.buildings.length===0){this.pushRuntimeStateToPorts();return}this.ensureVisualPipeline();const{tileHeight:i}=this.ports.getIsoMetrics();t.buildings.forEach(s=>{const n=this.runtimeState.buildingVisualProfiles[s.id]??Ot(s.district,s.signageStyle,s.propDensity),a=(s.footprint.from.x+s.footprint.to.x)/2,r=Math.min(s.footprint.from.y,s.door.y)-.4,o=this.ports.calculatePixelPosition(a,r),l=i*(.8+n.massingHeight*.18),c=this.runtimeState.buildingPainter?this.runtimeState.buildingPainter.createLabel(s,o,l,n):this.ports.add.container(o.x,o.y-i*.2);c.setScrollFactor(1),this.ports.syncDepth(c,o.x,o.y,N.FLOATING_UI+20),this.runtimeState.buildingLabels.push(c)}),this.pushRuntimeStateToPorts()}resolveAtmosphereProfile(t){if(this.ensureVisualPipeline(),!this.runtimeState.atmosphereDirector)throw new Error("AtmosphereDirector is not initialized.");const i=this.runtimeState.atmosphereDirector.resolveAtmosphereProfile({districtWeight:this.resolveDistrictWeight(),timeSeconds:this.ports.getCurrentGameTime(),baseOverlayRgba:t}),s=Cs(this.runtimeState.visualTheme.preset);return this.runtimeState.currentAtmosphereProfile={...i,fogBands:i.fogBands.slice(0,s.maxFogBands),emissiveIntensity:P.Math.Clamp(i.emissiveIntensity,0,1),wetReflectionAlpha:P.Math.Clamp(i.wetReflectionAlpha,0,s.wetReflectionAlpha)},this.pushRuntimeStateToPorts(),this.runtimeState.currentAtmosphereProfile}applyOcclusionReadability(){var n,a,r,o;if(!this.runtimeState.occlusionReadabilityController||!this.runtimeState.buildingMassingEntries.length)return;const t=(a=(n=this.ports).readEntityRuntimeState)==null?void 0:a.call(n),i=[];t!=null&&t.playerToken&&i.push({id:"player",pixelX:t.playerToken.container.x,pixelY:t.playerToken.container.y,token:t.playerToken,nameLabel:t.playerNameLabel}),(r=t==null?void 0:t.enemySprites)==null||r.forEach((l,c)=>{i.push({id:c,pixelX:l.token.container.x,pixelY:l.token.container.y,token:l.token,nameLabel:l.nameLabel,healthBar:l.healthBar})}),(o=t==null?void 0:t.npcSprites)==null||o.forEach((l,c)=>{i.push({id:c,pixelX:l.token.container.x,pixelY:l.token.container.y,token:l.token,nameLabel:l.nameLabel,indicator:l.indicator})});const s=this.runtimeState.currentAtmosphereProfile??this.resolveAtmosphereProfile();this.runtimeState.occlusionReadabilityController.applyOcclusionReadability({masses:this.runtimeState.buildingMassingEntries,entities:i,occlusionFadeFloor:this.runtimeState.visualTheme.qualityBudget.occlusionFadeFloor,emissiveIntensity:s.emissiveIntensity})}drawBackdrop(){const t=this.ports.getBackdropGraphics(),i=this.ports.getCurrentMapArea();if(!t||!i)return;const s=this.computeIsoBounds(),n=this.ports.getTileSize()*4,a=s.maxX-s.minX+n*2,r=s.maxY-s.minY+n*2,o=s.minX-n,l=s.minY-n,c=this.resolveAtmosphereProfile(),d=c.skylineSplit;t.clear(),t.fillGradientStyle(c.gradientTopLeft,c.gradientTopRight,c.gradientBottomLeft,c.gradientBottomRight,1,1,1,1),t.fillRect(o,l,a,r);const u=l+r*.52,h=c.skylineColumns,g=c.skylineDowntownColor,p=c.skylineSlumsColor;for(let f=0;f<h;f+=1){const w=f/h,v=o+w*a,M=.68+f*13%7*.08,b=a/h*M,A=f*29%11/11,x=r*(.12+A*.28)*(w<d?1.12:.78),I=w<d?.78:.26,k=P.Display.Color.Interpolate.ColorWithColor(P.Display.Color.ValueToColor(p),P.Display.Color.ValueToColor(g),1,I),L=P.Display.Color.GetColor(k.r,k.g,k.b);t.fillStyle(L,c.skylineAlphaBase+A*c.skylineAlphaVariance),t.fillRect(v,u-x,b,x),t.fillStyle(T(L,.12),.14+c.emissiveIntensity*.1),t.fillRect(v+b*.72,u-x,b*.16,x)}const m=l+r*.35;t.fillStyle(c.horizonGlowColor,c.horizonGlowAlpha),t.fillEllipse(o+a/2,m,a*1.08,r*.52),t.fillStyle(c.lowerHazeColor,c.lowerHazeAlpha),t.fillRect(o,l+r*.6,a,r*.6),c.fogBands.forEach(f=>{f.alpha<=0||(t.lineStyle(2,f.color,f.alpha),t.strokeEllipse(o+a/2,l+r*f.yFactor,a*f.widthFactor,r*f.heightFactor))})}computeIsoBounds(){const t=this.ports.getCurrentMapArea();if(!t)return{minX:0,maxX:0,minY:0,maxY:0};const{width:i,height:s}=t,n=[this.ports.calculatePixelPosition(0,0),this.ports.calculatePixelPosition(i-1,0),this.ports.calculatePixelPosition(0,s-1),this.ports.calculatePixelPosition(i-1,s-1)];return{minX:Math.min(...n.map(a=>a.x)),maxX:Math.max(...n.map(a=>a.x)),minY:Math.min(...n.map(a=>a.y)),maxY:Math.max(...n.map(a=>a.y))}}hasLightPipelineSupport(){return this.ports.game.renderer instanceof P.Renderer.WebGL.WebGLRenderer}enableLighting(){if(!this.hasLightPipelineSupport()){console.warn("[MainScene] WebGL renderer unavailable; Light2D disabled."),this.ports.setLightsFeatureEnabled(!1),D.dispatch(qs(!1)),ti({lightsEnabled:!1});return}if(this.ports.getLightsFeatureEnabled()){this.rebuildLightingDemoLight();return}this.ports.lights.enable().setAmbientColor(this.ports.getLightingAmbientColor()),this.ports.setLightsFeatureEnabled(!0),this.rebuildLightingDemoLight()}disableLighting(t=!1){if(!this.ports.getLightsFeatureEnabled()&&!t){this.destroyDemoPointLight();return}if(this.destroyDemoPointLight(),this.hasLightPipelineSupport()){const i=this.ports.lights;typeof i.removeAll=="function"&&i.removeAll(),this.ports.lights.disable()}this.ports.setLightsFeatureEnabled(!1)}rebuildLightingDemoLight(){const t=this.ports.getDemoLampGrid();if(!this.ports.getLightsFeatureEnabled()||!t){this.destroyDemoPointLight();return}const{x:i,y:s}=this.ports.calculatePixelPosition(t.x,t.y),n=s-this.ports.getTileSize()*.35,a=this.ports.getTileSize()*1.6,r=.4,o=this.ports.getDemoPointLight();if(!o){const l=this.ports.add.pointlight(i,n,8246268,a,r);l.setScrollFactor(1),this.ports.setDemoPointLight(l);return}o.setPosition(i,n),o.radius=a,o.intensity=r}destroyDemoPointLight(){const t=this.ports.getDemoPointLight();t&&(t.destroy(),this.ports.setDemoPointLight(void 0))}clearForMapTransition(){this.runtimeState.buildingLabels.forEach(t=>t.destroy(!0)),this.runtimeState.buildingLabels=[],this.runtimeState.buildingMassings.forEach(t=>t.destroy(!0)),this.runtimeState.buildingMassings=[],this.runtimeState.buildingMassingEntries=[],this.runtimeState.currentAtmosphereProfile=void 0,this.runtimeState.lastAtmosphereRedrawBucket=-1,this.runtimeState.lastItemMarkerSignature="",this.pushRuntimeStateToPorts()}renderTile(t,i,s,n,a,r,o=!1){var l;this.ensureVisualPipeline(),(l=this.runtimeState.tilePainter)==null||l.drawTile(t,{center:i,tileWidth:s,tileHeight:n,gridX:a,gridY:r,groundOnly:o})}resolveDistrictWeight(){const t=Object.values(this.runtimeState.buildingVisualProfiles);return t.length?t.filter(s=>s.district==="downtown").length/t.length:.5}pushRuntimeStateToPorts(){var t,i;(i=(t=this.ports).writeRuntimeState)==null||i.call(t,this.runtimeState)}}class Yg extends P.Scene{constructor(){super({key:"MainScene"});y(this,"tileSize",Xt);y(this,"depthManager");y(this,"mapGraphics");y(this,"backdropGraphics");y(this,"pathGraphics");y(this,"visionConeGraphics");y(this,"coverDebugGraphics");y(this,"currentMapArea",null);y(this,"playerInitialPosition");y(this,"isoOriginX",0);y(this,"isoOriginY",0);y(this,"isoFactory");y(this,"staticPropGroup");y(this,"lightsFeatureEnabled",!1);y(this,"demoLampGrid");y(this,"demoPointLight");y(this,"lightingAmbientColor",988970);y(this,"unsubscribe",null);y(this,"disposeVisualSettings");y(this,"disposeLightingSettings");y(this,"moduleDisposables",new on);y(this,"sceneModuleRegistry");y(this,"dayNightOverlayModule");y(this,"minimapBridgeModule");y(this,"surveillanceRenderModule");y(this,"worldRenderModule");y(this,"entityRenderModule");y(this,"inputModule");y(this,"cameraModule");y(this,"stateSyncModule");y(this,"clockModule");y(this,"lastStoreSnapshot",D.getState())}init(i){this.currentMapArea=i.mapArea,this.playerInitialPosition=i.playerPosition}create(){var n,a;if(!this.currentMapArea){console.error("[MainScene] currentMapArea is null on create!");return}this.cameras.main.setBackgroundColor(1710618),this.depthManager=new su(this),this.backdropGraphics=this.add.graphics(),this.registerStaticDepth(this.backdropGraphics,He.BACKDROP),this.mapGraphics=this.add.graphics(),this.registerStaticDepth(this.mapGraphics,He.MAP_BASE),this.visionConeGraphics=this.add.graphics(),this.registerStaticDepth(this.visionConeGraphics,He.VISION_OVERLAY),this.pathGraphics=this.add.graphics(),this.registerStaticDepth(this.pathGraphics,He.PATH_PREVIEW),this.coverDebugGraphics=this.add.graphics(),this.registerStaticDepth(this.coverDebugGraphics,He.COVER_DEBUG),this.coverDebugGraphics.setVisible(!1),this.initializeSceneModules(),this.worldRenderModule.ensureVisualPipeline(),this.cameraModule.setupCameraAndMap(),this.dayNightOverlayModule.initializeDayNightOverlay(),this.dayNightOverlayModule.updateDayNightOverlay(),this.cameras.main.setRoundPixels(!1),this.disposeVisualSettings=pr(this.cameras.main),this.disposeLightingSettings=Dn(r=>{this.applyLightingSettings(r)}),this.events.once(P.Scenes.Events.SHUTDOWN,this.cleanupScene,this);const i=D.getState().player.data.name??"Operative";if(this.entityRenderModule.initializePlayer(this.playerInitialPosition,i)){if(this.cameraModule.enablePlayerCameraFollow(),typeof window<"u"&&new URLSearchParams(window.location.search).get("poc")==="esb"){const o=(a=(n=this.currentMapArea)==null?void 0:n.buildings)==null?void 0:a.find(l=>l.id==="block_2_2");if(o){const l=(o.footprint.from.x+o.footprint.to.x)/2,c=(o.footprint.from.y+o.footprint.to.y)/2;this.focusCameraOnGridPosition(l,c,!1)}else this.focusCameraOnGridPosition(14,33,!1)}}else console.error("[MainScene] playerInitialPosition is null");this.unsubscribe=D.subscribe(this.handleStateChange.bind(this)),this.lastStoreSnapshot=D.getState(),this.queueInitialStateSync()}shutdown(){this.cleanupScene()}update(i,s){var n;this.sys.isActive()&&((n=this.sceneModuleRegistry)==null||n.onUpdate(i,s))}worldToGrid(i,s){const{halfTileWidth:n,halfTileHeight:a}=this.getIsoMetrics(),r=i-this.isoOriginX,o=s-this.isoOriginY,l=(o/a+r/n)*.5,c=(o/a-r/n)*.5,d=Math.round(l),u=Math.round(c);return Number.isNaN(d)||Number.isNaN(u)?null:{x:d,y:u}}worldToGridContinuous(i,s){const{halfTileWidth:n,halfTileHeight:a}=this.getIsoMetrics(),r=i-this.isoOriginX,o=s-this.isoOriginY,l=(o/a+r/n)*.5,c=(o/a-r/n)*.5;return!Number.isFinite(l)||!Number.isFinite(c)?null:{x:l,y:c}}emitViewportUpdate(){this.minimapBridgeModule.emitViewportUpdate()}focusCameraOnGridPosition(i,s,n=!0){this.cameraModule.focusCameraOnGridPosition(i,s,n)}initializeSceneModules(){this.moduleDisposables.dispose(),this.moduleDisposables=new on,this.dayNightOverlayModule=new Mu(this,{add:this.add,cameras:this.cameras,scale:this.scale,sys:this.sys,getCurrentGameTime:()=>{var s;return((s=this.clockModule)==null?void 0:s.getCurrentGameTime())??D.getState().world.currentTime},isInCombat:()=>{var s;return((s=this.stateSyncModule)==null?void 0:s.isInCombat())??D.getState().world.inCombat},resolveAtmosphereProfile:s=>this.worldRenderModule.resolveAtmosphereProfile(s),registerStaticDepth:(s,n)=>this.registerStaticDepth(s,n)}),this.minimapBridgeModule=new ah(this,{cameras:this.cameras,sys:this.sys,getCurrentMapArea:()=>this.currentMapArea,worldToGridContinuous:(s,n)=>this.worldToGridContinuous(s,n)}),this.surveillanceRenderModule=new fh(this,{getCurrentMapArea:()=>this.currentMapArea,getVisionConeGraphics:()=>this.visionConeGraphics,getTileSize:()=>this.tileSize,getIsoMetrics:()=>this.getIsoMetrics(),calculatePixelPosition:(s,n)=>this.calculatePixelPosition(s,n),syncDepth:(s,n,a,r)=>this.syncDepth(s,n,a,r)}),this.worldRenderModule=new Rh(this,{add:this.add,game:this.game,lights:this.lights,mapGraphics:this.mapGraphics,getBackdropGraphics:()=>this.backdropGraphics,getCurrentMapArea:()=>this.currentMapArea,getCurrentGameTime:()=>{var s;return((s=this.clockModule)==null?void 0:s.getCurrentGameTime())??D.getState().world.currentTime},getTileSize:()=>this.tileSize,getIsoFactory:()=>this.isoFactory,ensureIsoFactory:()=>this.ensureIsoFactory(),getIsoMetrics:()=>this.getIsoMetrics(),calculatePixelPosition:(s,n)=>this.calculatePixelPosition(s,n),syncDepth:(s,n,a,r)=>this.syncDepth(s,n,a,r),renderVisionCones:()=>this.surveillanceRenderModule.renderVisionCones(),getStaticPropGroup:()=>this.staticPropGroup,setStaticPropGroup:s=>{this.staticPropGroup=s},getLightsFeatureEnabled:()=>this.lightsFeatureEnabled,setLightsFeatureEnabled:s=>{this.lightsFeatureEnabled=s},getDemoLampGrid:()=>this.demoLampGrid,setDemoLampGrid:s=>{this.demoLampGrid=s},getDemoPointLight:()=>this.demoPointLight,setDemoPointLight:s=>{this.demoPointLight=s},getLightingAmbientColor:()=>this.lightingAmbientColor,readEntityRuntimeState:()=>this.entityRenderModule.getRuntimeStateSnapshot()}),this.entityRenderModule=new Du(this,{add:this.add,cameras:this.cameras,game:this.game,scale:this.scale,sys:this.sys,hasMapGraphics:()=>!!this.mapGraphics,ensureIsoFactory:()=>this.ensureIsoFactory(),getIsoMetrics:()=>this.getIsoMetrics(),calculatePixelPosition:(s,n)=>this.calculatePixelPosition(s,n),syncDepth:(s,n,a,r)=>this.syncDepth(s,n,a,r),enablePlayerCameraFollow:()=>this.cameraModule.enablePlayerCameraFollow(),isInCombat:()=>this.stateSyncModule.isInCombat(),isCameraFollowingPlayer:()=>this.cameraModule.isFollowingPlayer(),createCharacterToken:(s,n,a)=>this.worldRenderModule.createCharacterToken(s,n,a),positionCharacterToken:(s,n,a)=>this.worldRenderModule.positionCharacterToken(s,n,a)}),this.inputModule=new ju(this,{cameras:this.cameras,sys:this.sys,pathGraphics:this.pathGraphics,getCurrentMapArea:()=>this.currentMapArea,setCurrentMapArea:s=>{this.currentMapArea=s},getPlayerInitialPosition:()=>this.playerInitialPosition,getLastPlayerGridPosition:()=>this.entityRenderModule.getLastPlayerGridPosition(),getCoverDebugGraphics:()=>this.coverDebugGraphics,worldToGrid:(s,n)=>this.worldToGrid(s,n),getIsoMetrics:()=>this.getIsoMetrics(),calculatePixelPosition:(s,n)=>this.calculatePixelPosition(s,n),getDiamondPoints:(s,n,a,r)=>this.getDiamondPoints(s,n,a,r),renderStaticProps:()=>this.worldRenderModule.renderStaticProps()}),this.cameraModule=new gu(this,{cameras:this.cameras,scale:this.scale,sys:this.sys,tweens:this.tweens,getCurrentMapArea:()=>this.currentMapArea,getPlayerInitialPosition:()=>this.playerInitialPosition,getPlayerTokenContainer:()=>this.entityRenderModule.getPlayerTokenContainer(),getTileSize:()=>this.tileSize,setIsoOrigin:(s,n)=>{this.isoOriginX=s,this.isoOriginY=n},ensureIsoFactory:()=>this.ensureIsoFactory(),ensureVisualPipeline:()=>this.worldRenderModule.ensureVisualPipeline(),getIsoMetrics:()=>this.getIsoMetrics(),calculatePixelPosition:(s,n)=>this.calculatePixelPosition(s,n),computeIsoBounds:()=>this.worldRenderModule.computeIsoBounds(),renderStaticProps:()=>this.worldRenderModule.renderStaticProps(),drawBackdrop:()=>this.worldRenderModule.drawBackdrop(),drawMap:s=>this.worldRenderModule.drawMap(s),drawBuildingMasses:()=>this.worldRenderModule.drawBuildingMasses(),drawBuildingLabels:()=>this.worldRenderModule.drawBuildingLabels(),clearPathPreview:()=>this.inputModule.clearPathPreview(),resizeDayNightOverlay:()=>this.dayNightOverlayModule.resizeDayNightOverlay(),applyOverlayZoom:()=>this.dayNightOverlayModule.applyOverlayZoom(),emitViewportUpdate:()=>this.minimapBridgeModule.emitViewportUpdate(),dispatchPlayerScreenPosition:()=>this.entityRenderModule.dispatchPlayerScreenPosition(),isInCombat:()=>this.stateSyncModule.isInCombat()}),this.stateSyncModule=new ch(this,{sys:this.sys,getCurrentMapArea:()=>this.currentMapArea,setCurrentMapArea:s=>{this.currentMapArea=s},getItemMarkerSignature:s=>this.worldRenderModule.getItemMarkerSignature(s),renderStaticProps:()=>this.worldRenderModule.renderStaticProps(),updateDayNightOverlay:()=>this.dayNightOverlayModule.updateDayNightOverlay(),updatePlayerPosition:s=>this.entityRenderModule.updatePlayerPosition(s),updatePlayerVitalsIndicator:(s,n,a)=>this.entityRenderModule.updatePlayerVitalsIndicator(s,n,a),updateEnemies:s=>this.entityRenderModule.updateEnemies(s),updateNpcs:s=>this.entityRenderModule.updateNpcs(s),renderVisionCones:()=>this.surveillanceRenderModule.renderVisionCones(),updateSurveillanceCameras:(s,n)=>this.surveillanceRenderModule.updateSurveillanceCameras(s,n??!1),zoomCameraForCombat:()=>this.cameraModule.zoomCameraForCombat(),restoreCameraAfterCombat:()=>this.cameraModule.restoreCameraAfterCombat(),destroyPlayerVitalsIndicator:()=>this.entityRenderModule.destroyPlayerVitalsIndicator(),destroyCameraSprites:()=>this.surveillanceRenderModule.clearCameraSprites(),setupCameraAndMap:()=>this.cameraModule.setupCameraAndMap(),clearPathPreview:()=>this.inputModule.clearPathPreview(),enablePlayerCameraFollow:()=>this.cameraModule.enablePlayerCameraFollow(),resetCameraRuntimeStateForMapTransition:()=>this.cameraModule.resetForMapTransition(),clearEntityRuntimeStateForMapTransition:()=>this.entityRenderModule.clearForMapTransition(),clearWorldRuntimeStateForMapTransition:()=>this.worldRenderModule.clearForMapTransition(),resetEntityCombatIndicators:()=>this.entityRenderModule.resetCombatIndicators(),readRuntimeState:()=>{var s;return{curfewActive:D.getState().world.curfewActive,inCombat:D.getState().world.inCombat,lastMapAreaId:((s=this.currentMapArea)==null?void 0:s.id)??null,isMapTransitionPending:!1}}}),this.clockModule=new Su(this,{getCurrentGameTime:()=>D.getState().world.currentTime,getAtmosphereRedrawBucket:()=>this.worldRenderModule.getAtmosphereRedrawBucket(),setAtmosphereRedrawBucket:s=>this.worldRenderModule.setAtmosphereRedrawBucket(s),signalAtmosphereRedraw:()=>{this.currentMapArea&&(this.worldRenderModule.drawBackdrop(),this.worldRenderModule.drawMap(this.currentMapArea.tiles))},signalOverlayUpdate:()=>this.dayNightOverlayModule.updateDayNightOverlay(),signalOcclusionUpdate:()=>this.worldRenderModule.applyOcclusionReadability(),dispatchGameTime:s=>{D.dispatch(ta(s))},shouldApplySuspicionDecay:()=>!!D.getState().settings.reputationSystemsEnabled,dispatchSuspicionDecay:(s,n)=>{D.dispatch(Sa({elapsedSeconds:s,timestamp:n}))},readRuntimeState:()=>({currentGameTime:D.getState().world.currentTime,timeDispatchAccumulator:0,lastAtmosphereRedrawBucket:this.worldRenderModule.getAtmosphereRedrawBucket(),dispatchCadenceSeconds:.5,atmosphereBucketSeconds:5})});const i=ru(this,{getState:()=>D.getState(),dispatch:D.dispatch},this.moduleDisposables);this.sceneModuleRegistry=new ou(i),this.sceneModuleRegistry.register(this.dayNightOverlayModule),this.sceneModuleRegistry.register(this.minimapBridgeModule),this.sceneModuleRegistry.register(this.surveillanceRenderModule),this.sceneModuleRegistry.register(this.worldRenderModule),this.sceneModuleRegistry.register(this.entityRenderModule),this.sceneModuleRegistry.register(this.inputModule),this.sceneModuleRegistry.register(this.cameraModule),this.sceneModuleRegistry.register(this.stateSyncModule),this.sceneModuleRegistry.register(this.clockModule),this.sceneModuleRegistry.onCreate(),i.listenScale("resize",this.handleResize,this)}queueInitialStateSync(){setTimeout(()=>{var s;if(!this.sys.isActive())return;const i=D.getState();(s=this.sceneModuleRegistry)==null||s.onStateChange(i,i)},0)}handleStateChange(){var s;if(!this.sys.isActive()||!this.currentMapArea)return;const i=D.getState();(s=this.sceneModuleRegistry)==null||s.onStateChange(this.lastStoreSnapshot,i),this.lastStoreSnapshot=i}cleanupScene(){var i,s;(i=this.sceneModuleRegistry)==null||i.onShutdown(),this.sceneModuleRegistry=void 0,this.moduleDisposables.dispose(),this.disposeVisualSettings&&(this.disposeVisualSettings(),this.disposeVisualSettings=void 0),this.disposeLightingSettings&&(this.disposeLightingSettings(),this.disposeLightingSettings=void 0),this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null),(s=this.coverDebugGraphics)==null||s.destroy(),this.coverDebugGraphics=void 0}handleResize(){var i;(i=this.sceneModuleRegistry)==null||i.onResize()}applyLightingSettings(i){this.worldRenderModule.applyLightingSettings(i)}ensureIsoFactory(){this.isoFactory||(this.isoFactory=new au(this,this.tileSize,this.depthManager)),this.isoFactory.setIsoOrigin(this.isoOriginX,this.isoOriginY)}registerStaticDepth(i,s){this.depthManager.registerStatic(i,s)}syncDepth(i,s,n,a){ka(this.depthManager,i,s,n,a)}calculatePixelPosition(i,s){return de(i,s,this.isoOriginX,this.isoOriginY,this.tileSize)}getIsoMetrics(){return ue(this.tileSize)}getDiamondPoints(i,s,n,a){return Z(i,s,n,a).map(r=>new P.Geom.Point(r.x,r.y))}}class Zg extends P.Scene{constructor(){super({key:"BootScene"})}preload(){this.load.atlas("props","atlases/props.png","atlases/props.json"),this.load.atlas("esb","atlases/esb_iso_trim_pad.png","atlases/esb_iso_trim_pad.json"),this.load.image("lamp_slim_a_n","normals/lamp_slim_a_n.png")}create(){console.log("[BootScene] create: Fetching initial state and starting MainScene...");const t=D.getState(),i=t.world.currentMapArea,s=t.player.data.position,n=this.textures.get("props"),a=this.textures.get("lamp_slim_a_n");if(n&&a&&n.dataSource.length===0){const c=a.getSourceImage();n.setDataSource(c),this.textures.remove("lamp_slim_a_n")}i||console.error("[BootScene] Error: initialMapArea is null or undefined in Redux state!"),s||console.error("[BootScene] Error: initialPlayerPosition is null or undefined in Redux state!");const r=t.settings.locale,l=Zt(r).buildingDefinitions;this.scene.start("MainScene",{mapArea:i,playerPosition:s,buildings:l})}}const Si=e=>`${e.x},${e.y}`,us=(e,t,i,s={})=>{if(e.x===t.x&&e.y===t.y)return[];const n=s.allowDiagonals?[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1},{x:1,y:1},{x:-1,y:-1},{x:1,y:-1},{x:-1,y:1}]:[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}],a=new Set,r=[{position:e,path:[]}];a.add(Si(e));const{player:o,enemies:l=[],blockedPositions:c=[],npcs:d=[],ignoreNpcIds:u=[]}=s,h=new Set(c.map(Si)),g=p=>p.x>=0&&p.y>=0&&p.x<i.width&&p.y<i.height;for(;r.length>0;){const p=r.shift();if(!p)break;for(const m of n){const f={x:p.position.x+m.x,y:p.position.y+m.y};if(!g(f))continue;const w=Si(f);if(a.has(w))continue;const v=f.x===t.x&&f.y===t.y,M=i.tiles[f.y][f.x];if(!M||!M.isWalkable)continue;if(v){const A=o?o.position.x===f.x&&o.position.y===f.y:!1,x=l.some(k=>k.position.x===f.x&&k.position.y===f.y),I=d.some(k=>!u.includes(k.id)&&k.position.x===f.x&&k.position.y===f.y);if(A||x||I)continue}else if(h.has(w)||!Me(f,i,o,l,{npcs:d,ignoreNpcIds:u}))continue;const b=[...p.path,f];if(v)return b;a.add(w),r.push({position:f,path:b})}}return[]},Wa=4294967295,Eh=e=>()=>{let t=e+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/(Wa+1)},mt=e=>{let t=1779033703^e.length;for(let i=0;i<e.length;i+=1)t=Math.imul(t^e.charCodeAt(i),3432918353),t=t<<13|t>>>19;return(Math.imul(t^t>>>16,2246822507)^Math.imul(t^t>>>13,3266489909))>>>0},hs=(e,t=0)=>{const i=Math.floor(t)>>>0,s=mt(e)^i,n=Eh(s||1),a=()=>n();return{next:a,nextInRange:(r,o)=>{if(o<=r)return r;const l=a();return r+l*(o-r)},fork:r=>{const o=Math.floor(a()*Wa);return hs(`${e}:${r}`,o)}}},Se=["idle","patrol","chase","search","attack","inspectNoise","flee","panic"],Cn=e=>e?Se.reduce((t,i)=>(typeof e[i]=="number"&&(t[i]=e[i]),t),{}):{},_h=e=>Se.reduce((t,i)=>{const s=e[i];return t[i]=typeof s=="number"?Math.max(0,s):0,t},{}),Dh=(e,t,i,s)=>{if(!(!t||t.length===0))for(const n of t){const{state:a,weight:r}=n;let o=0;switch(n.kind){case"healthBelow":i.healthRatio<=n.threshold&&(o=r);break;case"healthAbove":i.healthRatio>=n.threshold&&(o=r);break;case"lineOfSight":i.hasLineOfSight&&(o=r);break;case"lostLineOfSight":i.hasLineOfSight||(o=r);break;case"alertAtLeast":(i.alertLevel??0)>=n.alert&&(o=r);break;case"alertBelow":(i.alertLevel??0)<n.alert&&(o=r);break;case"suppressionAbove":i.suppressionRatio>=n.threshold&&(o=r);break;case"distanceBelow":i.distanceToPlayer<=n.tiles&&(o=r);break;case"distanceAbove":i.distanceToPlayer>=n.tiles&&(o=r);break;case"directorAtLeast":typeof i.directorIntensity=="number"&&i.directorIntensity>=n.threshold&&(o=r);break}if(o!==0){const l=Math.max(0,(e[a]??0)+o);e[a]=l,s[a]=(s[a]??0)+o}}},Lh=(e,t,i)=>{Se.forEach(s=>{const n=t[s];typeof n=="number"&&n>i&&(e[s]=0)})},Fh=(e,t)=>{t<=0||Se.forEach(i=>{e[i]>0&&e[i]<t&&(e[i]=t)})},Bh=(e,t)=>{let i=0;if(Se.forEach(a=>{i+=e[a]}),i<=0)return"idle";const s=t()*i;let n=0;for(const a of Se)if(n+=e[a],s<=n)return a;return Se[Se.length-1]},Oh=(e,t,i,s)=>{const n=t==null?void 0:t[i];typeof n=="number"&&n>0&&(e[i]=s+n)},Nh=(e,t)=>{const i=(t==null?void 0:t.personalitySeed)??mt(e.id),s=hs(`${e.id}:${i}`,i);let n=(t==null?void 0:t.currentState)??e.initialState,a=(t==null?void 0:t.lastTransitionAt)??0;const r=Cn(t==null?void 0:t.cooldowns),o=e.cooldowns??{},l=e.minimumSelectableWeight??0;return{getState:()=>n,getSnapshot:()=>({currentState:n,lastTransitionAt:a,cooldowns:Cn(r),personalitySeed:i}),step:(h,g)=>{const p=_h(e.baseWeights),m=Se.reduce((b,A)=>(b[A]=0,b),{});Dh(p,e.utilityModifiers,h,m),Lh(p,r,h.now),Fh(p,l),p[n]>0&&(p[n]+=.5);const f=Bh(p,s.next),w=n;f!==n&&(Oh(r,o,f,h.now),n=f,a=h.now);const v={previousState:w,selectedState:f,weights:p,utilityBreakdown:m,now:h.now},M=g==null?void 0:g[f];return M&&M(h,v),{state:f,metadata:v}}}},Hh=e=>{const t=e.suppression??0;return t<=0?0:Math.max(0,Math.min(1,t/100))},Wh=({enemy:e,player:t,mapArea:i,squad:s,npcs:n,hasLineOfSight:a,now:r})=>({enemy:e,player:t,mapArea:i,squad:s,civilians:n,hasLineOfSight:a,distanceToPlayer:oe(e.position,t.position),tookRecentDamage:e.health<e.maxHealth,healthRatio:e.maxHealth>0?e.health/e.maxHealth:0,suppressionRatio:Hh(e),alertLevel:e.alertLevel,lastKnownPlayerPosition:e.lastKnownPlayerPosition,directorIntensity:void 0,now:r}),qh=(e,t)=>({currentState:e.aiState??t,lastTransitionAt:e.aiLastTransitionAt??0,cooldowns:e.aiCooldowns??{},personalitySeed:e.aiPersonalitySeed??mt(e.id)}),Gh=(e,t,i,s)=>({...e,aiProfileId:t,aiState:i.currentState,aiLastTransitionAt:i.lastTransitionAt,aiCooldowns:i.cooldowns,aiPersonalitySeed:i.personalitySeed,aiTelemetry:{state:s.selectedState,previousState:s.previousState,weights:{...s.weights},utilities:{...s.utilityBreakdown},updatedAt:s.now}}),ot=(e,t,i,s)=>{if(!_e(e.position,t.position,e.attackRange))return null;if(e.actionPoints<pt)return{enemy:{...e,actionPoints:0},player:t,action:"no_ap"};const n=s.some(c=>c.x===t.position.x&&c.y===t.position.y),a=Ba(e,t,{isBehindCover:n,mapArea:i});let r=e,o=t;a.newAttacker.id===e.id&&(r=a.newAttacker),a.newTarget.id===t.id&&(o=a.newTarget);const l=a.success?"attack":"attack_missed";return{enemy:r,player:o,action:l,isCritical:a.isCritical}},Vh=(e,t,i,s,n,a)=>{if(!Ke(t,i))return null;const r=n.filter(l=>l.id!==e.id),o=us(e.position,t,i,{player:s,enemies:r,npcs:a});return o.length===0?null:o[0]},Ee=(e,t,i,s,n)=>{const a=Ui(e,t,i,s,n);if(!a)return null;const r=wt(e,a);return{enemy:bt(r,e.position,i),player:t,action:"move"}},zi=(e,t,i,s,n,a)=>{const r=jh(e,t,i,s,n,a);if(!r)return null;const o=wt(e,r);return{enemy:bt(o,e.position,i),player:t,action:"seek_cover"}},qa=(e,t,i,s,n)=>{if(!e.lastKnownPlayerPosition)return null;const a=Vh(e,e.lastKnownPlayerPosition,i,t,s,n);if(!a)return null;const r=wt(e,a);return{enemy:bt(r,e.position,i),player:t,action:"search"}},kn=(e,t,i,s,n,a,r)=>{const o=ps(e.position),l=s.filter(m=>m.id!==e.id),c=o.filter(m=>cs(e,m,i,t,l));if(c.length===0)return null;const d=hs(a,r),u=Math.floor(d.nextInRange(0,c.length)),h=c[u]??c[0],g=wt(e,h);return{enemy:bt(g,e.position,i),player:t,action:"inspect_noise"}},zh=(e,t)=>({enemy:{...e,actionPoints:Math.max(0,e.actionPoints-1)},player:t,action:"idle"}),Uh=(e,t,i,s,n,a,r,o)=>{switch(e){case"attack":return ot(t,i,s,r);case"chase":return Ee(t,i,s,n,a);case"search":return qa(t,i,s,n,a);case"inspectNoise":return kn(t,i,s,n,a,`${t.id}:${o.selectedState}:${o.now}`,mt(t.id));case"flee":case"panic":return zi(t,i,s,n,r,a);case"patrol":return(t.alertLevel??B.IDLE)>=B.SUSPICIOUS?Ee(t,i,s,n,a):kn(t,i,s,n,a,`${t.id}:patrol:${o.now}`,mt(t.id));case"idle":return zh(t,i);default:return null}},vi=(e,t)=>({enemy:{...e,actionPoints:0},player:t,action:"no_valid_move"}),Kh=e=>{if(e){const t=zo(e);if(t)return t}return Ii[ct]??Object.values(Ii)[0]},Xg=(e,t,i,s,n,a=[],r=Date.now())=>{let o={...e},l={...t};if(e.health<=0)return{enemy:o,player:l,action:"dead"};if(e.actionPoints<=0)return{enemy:o,player:l,action:"no_ap"};if(_e(e.position,t.position,e.attackRange)){const C=ot(e,l,i,n);if(C)return C}const c=Kh(e.aiProfileId),d=qh(e,c.fsm.initialState),u=Nh(c.fsm,d),h=Ha(e,t,i),g=s.filter(C=>C.id!==e.id),p=Wh({enemy:e,player:t,mapArea:i,squad:g,npcs:a,hasLineOfSight:h,now:r});let m=null;const f={idle:()=>{m="idle"},patrol:()=>{m="patrol"},chase:()=>{m="chase"},search:()=>{m="search"},attack:()=>{m="attack"},inspectNoise:()=>{m="inspectNoise"},flee:()=>{m="flee"},panic:()=>{m="panic"}},{state:w,metadata:v}=u.step(p,f);let b=Uh(m??w,e,l,i,s,a,n,v)??null;if(b||(b=ot(e,l,i,n)??Ee(e,l,i,s,a)??zi(e,l,i,s,n,a)??vi(e,l)),p.hasLineOfSight){const C=b.enemy??e,F=_e(C.position,l.position,C.attackRange);if((b.action==="idle"||b.action==="inspect_noise")&&F){const q=ot(C,l,i,n);q&&(b=q)}else if(b.action==="inspect_noise"&&!F){const q=Ee(C,l,i,s,a);q&&(b=q)}else if(b.action==="idle"&&!F){const q=Ee(C,l,i,s,a);q&&(b=q)}}if(!p.hasLineOfSight&&b.action==="idle"){const C=Ee(e,l,i,s,a);C&&(b=C)}if(!p.hasLineOfSight&&b.action==="inspect_noise"){const C=qa(e,l,i,s,a)??Ee(e,l,i,s,a);C&&(b=C)}if(p.healthRatio<=.4&&b.action!=="seek_cover"){const C=zi(e,l,i,s,n,a);C&&(b=C)}if(b.action==="move"&&b.enemy&&b.enemy.position.x===e.position.x&&b.enemy.position.y===e.position.y){const C=Ui(b.enemy,l,i,s,a);if(C){const F=wt(b.enemy,C);b={...b,enemy:bt(F,b.enemy.position,i)}}}const A=b.enemy??e,x=_e(A.position,l.position,A.attackRange),I=!!Ui(A,l,i,s,a);b.action==="idle"&&!x&&!I&&(b=vi(A,l));const k=b.enemy??A,L=_e(k.position,l.position,k.attackRange);if(p.hasLineOfSight&&L&&!["attack","attack_missed","seek_cover","flee","dead","no_ap"].includes(b.action)){const C=ot(k,l,i,n);C&&(b=C)}b.action==="idle"&&!p.hasLineOfSight&&!x&&(b=vi(b.enemy??e,l));const S=u.getSnapshot();return o=Gh(b.enemy,c.id,S,v),l=b.player,{...b,enemy:o,player:l}},Ui=(e,t,i,s,n=[])=>{const a=s.filter(h=>h.id!==e.id),r=Math.max(1,Math.ceil(e.attackRange)),o=[];for(let h=-r;h<=r;h+=1)for(let g=-r;g<=r;g+=1){if(h===0&&g===0)continue;const p={x:t.position.x+h,y:t.position.y+g};Ke(p,i)&&_e(p,t.position,e.attackRange)&&o.push(p)}const l=o.sort((h,g)=>{const p=oe(e.position,h),m=oe(e.position,g);return p-m});let c=null;for(const h of l){if(!Me(h,i,t,a,{npcs:n}))continue;const g=us(e.position,h,i,{player:t,enemies:a,npcs:n});if(g.length!==0&&(!c||g.length<c.length)&&(c=g,g.length===1))break}if(c&&c.length>0)return c[0];const u=ps(e.position).filter(h=>cs(e,h,i,t,a));return u.length===0?null:u.reduce((h,g)=>{const p=oe(g,t.position),m=oe(h,t.position);return p<m?g:h},u[0])},jh=(e,t,i,s,n,a=[])=>{var h,g;if(n.length===0||(g=(h=i.tiles[e.position.y])==null?void 0:h[e.position.x])!=null&&g.provideCover)return null;const r=s.filter(p=>p.id!==e.id);let o=null;for(const p of n){if(!Ke(p,i)||!Me(p,i,t,r,{npcs:a}))continue;const m=us(e.position,p,i,{player:t,enemies:r,npcs:a});if(m.length!==0&&(!o||m.length<o.length)&&(o=m,m.length===1))break}if(o&&o.length>0)return o[0];const c=ps(e.position).filter(p=>cs(e,p,i,t,r));if(c.length===0)return null;const d=c.filter(p=>n.some(m=>m.x===p.x&&m.y===p.y));if(d.length>0)return d[0];const u=$h(e.position,n);return u?c.reduce((p,m)=>{const f=oe(m,u),w=oe(p,u);return f<w?m:p},c[0]):null},$h=(e,t)=>t.length===0?null:t.reduce((i,s)=>{const n=oe(e,s),a=oe(e,i);return n<a?s:i},t[0]),ps=e=>[{x:e.x+1,y:e.y},{x:e.x-1,y:e.y},{x:e.x,y:e.y+1},{x:e.x,y:e.y-1}],Qg=(e,t,i,s=1)=>{let n=B.IDLE;const a=[];return{updatedEnemies:e.map(o=>{if(!o.visionCone)return a.push({enemy:o,playerVisible:!1}),o;const l=Ha(o,t,i);let c=uh(o,l,s);if(l&&(c=hh(c,t.position),c.lastKnownPlayerPosition=t.position),a.push({enemy:c,playerVisible:l}),c.alertLevel){const d=jt(c.alertLevel),u=jt(n);d>u&&(n=c.alertLevel)}return c}),maxAlertLevel:n,guardPerception:a}},jt=e=>{switch(e){case B.IDLE:return 0;case B.SUSPICIOUS:return 1;case B.INVESTIGATING:return 2;case B.ALARMED:return 3;default:return 0}},Jg=(e,t)=>{const i=jt(e);if(jt(t)<=i)return null;switch(t){case B.SUSPICIOUS:return"alertSuspicious";case B.INVESTIGATING:return"alertInvestigating";case B.ALARMED:return"alertAlarmed";default:return null}},ef=(e,t)=>e===B.ALARMED&&!t,tf=()=>We.reinforcementDelay,Yh=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}],$t=(e,t)=>{var s;const i=(s=e.tiles[t.y])==null?void 0:s[t.x];return i?i.cover?1:i.provideCover?.75:0:0},Zh=e=>{var t;return((t=e.equipped.weapon)==null?void 0:t.damage)??Wi},Ga=e=>{var t;return((t=e.equipped.weapon)==null?void 0:t.range)??1},Xh=e=>{var n;const t=((n=e.equipped.weapon)==null?void 0:n.apCost)??pt,i=Number.isFinite(e.encumbrance.attackApMultiplier)?Math.max(e.encumbrance.attackApMultiplier,0):Number.POSITIVE_INFINITY,s=Zi(e)?0:Math.ceil(Math.max(0,t)*i);return Number.isFinite(s)?s:Number.POSITIVE_INFINITY},ms=e=>e.filter(t=>t.health>0),Tn=(e,t)=>t.length===0?Number.POSITIVE_INFINITY:t.reduce((i,s)=>{const n=oe(e,s.position);return n<i?n:i},Number.POSITIVE_INFINITY),Va=e=>Number.isFinite(e)?e:Number.NEGATIVE_INFINITY,Qh=(e,t)=>{const{player:i,enemies:s,map:n,profile:a}=e,r=ms(s),o=Xh(i);if(!Number.isFinite(o)||o>i.actionPoints)return[];const l=Zh(i),c=Ga(i),d=$t(n,i.position);return r.filter(u=>_e(i.position,u.position,c)).map(u=>{const h=oe(i.position,u.position),g=u.maxHealth>0?u.health/u.maxHealth:1,p=$t(n,u.position),m=l*(p>0?.75:1),f=(1-g)*a.weights.focusLowestHealth*m,w=a.weights.focusOverwatchThreat*u.damage*.05,v=d<.5?.25:0,M=t?a.weights.retreatBias*(m*.2+(d<.5?2:0)):0,b=i.actionPoints-o,A=b<a.thresholds.apReserve?(a.thresholds.apReserve-b)*.4:0,x=a.weights.attackBias*m+f+w-v-M-A,I=[];return I.push(`Distance ${h}`),I.push(`Expected damage ${m.toFixed(1)}`),f>.1&&I.push("Target vulnerable"),M>.1&&I.push("Panic dampening attack"),A>.1&&I.push("Preserve AP reserve"),{type:"attack",targetId:u.id,targetName:u.name,targetPosition:u.position,expectedDamage:m,apCost:o,distance:h,score:Va(x),summary:`Attack ${u.name}`,rationale:I}})},Jh=(e,t)=>{const{player:i,enemies:s,map:n,profile:a}=e;if(i.actionPoints<=0)return[];const r=ms(s);if(r.length===0)return[];const o=$t(n,i.position),l=Tn(i.position,r),c=Ga(i),d=[];return Yh.forEach(u=>{const h={x:i.position.x+u.x,y:i.position.y+u.y};if(!Me(h,n,i,r))return;const g=$t(n,h),p=Math.max(0,g-o),m=Tn(h,r),f=l>0?l-m:0,w=a.weights.pursuitAggression*(c>0?f/c:0),v=t||a.weights.retreatBias>.8?a.weights.retreatBias*Math.max(0,m-l):0,M=a.weights.maintainCover*g,b=i.actionPoints-1,A=b<a.thresholds.apReserve?(a.thresholds.apReserve-b)*.35:0,x=M+w+v-Math.max(0,-f)*.1-A,I=[];p>.01?I.push("Gain cover"):g>.4&&I.push("Maintain cover"),f>.2&&I.push("Advance on target"),v>.2&&I.push("Create distance"),A>.1&&I.push("Hold AP reserve"),d.push({type:"move",destination:h,coverGain:p,distanceToNearestEnemy:m,apCost:1,score:Va(x),summary:p>0?"Move to cover":"Reposition",rationale:I})}),d},ep=()=>({type:"wait",score:-.5,summary:"Hold position",rationale:["No advantageous action"]}),tp=e=>{const{player:t,profile:i,enemies:s}=e;if(ms(s).length===0)return{type:"wait",score:Number.NEGATIVE_INFINITY,summary:"No targets",rationale:["No living enemies"]};const r=(t.maxHealth>0?t.health/t.maxHealth:1)<=i.thresholds.panicHealthFraction,o=Qh(e,r),l=Jh(e,r),c=ep();return[...o,...l,c].reduce((h,g)=>!h||g.score>h.score?g:h,null)??c},ip=ss("AutoBattleController"),Rn=(e,t)=>{if(!e)return t.hudPauseReasons.none;switch(e){case"manual_input":return t.hudPauseReasons.manualInput;case"dialogue":return t.hudPauseReasons.dialogue;case"objective":return t.hudPauseReasons.objective;case"resources":return t.hudPauseReasons.resources;case"ap":return t.hudPauseReasons.ap;case"settings":default:return t.hudPauseReasons.none}},bi=220;class sf{constructor(t,i){y(this,"dispatch");y(this,"getState");y(this,"lastSignature",null);y(this,"currentStatus","idle");y(this,"currentReason",null);y(this,"manualOverride",!1);y(this,"turnStartTimestamp",null);y(this,"lastProcessedTurn",null);y(this,"pendingBufferTimeout",null);this.dispatch=t,this.getState=i.getState.bind(i)}notifyManualOverride(t){this.manualOverride=!0,this.lastSignature=null;const s=this.getState().settings.locale,n=Is(s).autoBattle,a=xs(s).logs,r=Rn(t,n);this.dispatch(js({status:"paused",reason:t})),this.dispatch(be(a.autoBattlePaused(r))),this.currentStatus="paused",this.currentReason=t}update(t){if(!t.enabled){this.resetStatus("idle",null,t),this.manualOverride=!1,this.lastSignature=null,this.clearTurnBuffer(),this.lastProcessedTurn=null;return}if(this.manualOverride){this.resetStatus("paused","manual_input",t),this.clearTurnBuffer();return}if(t.isPlayerTurn){if(this.lastProcessedTurn!==t.turnCount){this.lastProcessedTurn=t.turnCount,this.turnStartTimestamp=this.now(),this.lastSignature=null,this.resetStatus("idle",null,t),this.scheduleBufferedUpdate(bi);return}if(this.turnStartTimestamp!==null){const l=this.now()-this.turnStartTimestamp;if(l<bi){this.scheduleBufferedUpdate(bi-l);return}}}else this.clearTurnBuffer();const i=Ws(t.profileId),s=i.label,n=this.resolveFailSafe(t);if(n){this.resetStatus("paused",n,t),this.lastSignature=null,this.clearTurnBuffer();return}const a=this.buildSignature(t);if(a===this.lastSignature)return;const r=tp({player:t.player,enemies:t.enemies,map:t.mapArea,profile:i});this.dispatch(Kc(this.buildDecisionSummary(r,i.id))),this.resetStatus("running",null,t);const o=this.buildDecisionDescription(r);this.dispatch(be(t.logStrings.autoBattleDecision(s,o))),this.executeDecision(r,t),this.lastSignature=a}clearTurnBuffer(){this.pendingBufferTimeout!==null&&(window.clearTimeout(this.pendingBufferTimeout),this.pendingBufferTimeout=null),this.turnStartTimestamp=null}scheduleBufferedUpdate(t){const i=Math.max(0,Math.round(t));this.pendingBufferTimeout!==null&&window.clearTimeout(this.pendingBufferTimeout),this.pendingBufferTimeout=window.setTimeout(()=>{this.pendingBufferTimeout=null;const s=this.buildContextFromStore();s&&this.update(s)},i)}buildContextFromStore(){const t=this.getState(),{autoBattleEnabled:i,autoBattleProfile:s,locale:n}=t.settings,a=t.world,r=a.currentMapArea??null;return{enabled:i,profileId:s,player:t.player.data,enemies:(r==null?void 0:r.entities.enemies)??[],mapArea:r,inCombat:a.inCombat,isPlayerTurn:a.isPlayerTurn,turnCount:a.turnCount,activeDialogueId:t.quests.activeDialogue.dialogueId,logStrings:xs(n).logs,autoBattleStrings:Is(n).autoBattle}}now(){return typeof performance<"u"&&typeof performance.now=="function"?performance.now():Date.now()}resolveFailSafe(t){return!t.inCombat||!t.isPlayerTurn||!t.mapArea?"settings":t.player.actionPoints<=0?"ap":t.activeDialogueId?"dialogue":t.enemies.some(i=>i.health>0)?null:"settings"}resetStatus(t,i,s){if(!(this.currentStatus===t&&this.currentReason===i)){if(this.currentStatus=t,this.currentReason=i,this.dispatch(js({status:t,reason:i})),t==="running"){this.dispatch(be(s.logStrings.autoBattleEngaged(Ws(s.profileId).label)));return}if(t==="paused"){const n=Rn(i,s.autoBattleStrings);this.dispatch(be(s.logStrings.autoBattlePaused(n)))}}}buildSignature(t){const{player:i}=t;return[t.turnCount,i.actionPoints,i.position.x,i.position.y,t.enemies.map(s=>`${s.id}:${s.health}`).join("|")].join(":")}buildDecisionSummary(t,i){return{profileId:i,action:t.summary,targetId:t.type==="attack"?t.targetId:void 0,targetName:t.type==="attack"?t.targetName:void 0,score:t.score,explanation:t.rationale.join(", "),timestamp:Date.now()}}buildDecisionDescription(t){const i=t.rationale.length>0?t.rationale[0]:"";return i?`${t.summary} (${i})`:t.summary}executeDecision(t,i){switch(t.type){case"attack":this.executeAttack(t,i);break;case"move":this.executeMove(t,i);break;case"wait":default:this.executeWait(i);break}}executeAttack(t,i){var u;const s=this.getState(),n=s.player.data,a=s.world.currentMapArea.entities.enemies.find(h=>h.id===t.targetId);if(!a||a.health<=0){ip.warn("Attack target no longer valid; falling back to wait",{targetId:t.targetId}),this.executeWait(i);return}const r=s.world.currentMapArea,o=(u=r.tiles[a.position.y])==null?void 0:u[a.position.x],l=(o==null?void 0:o.provideCover)??!1,c=Ba(n,a,{isBehindCover:l,mapArea:r});this.dispatch(Ho(c.newAttacker)),this.dispatch(xl(c.newTarget)),c.events&&c.events.forEach(h=>this.dispatch(be(h.message))),c.success?(this.dispatch(be(i.logStrings.hitEnemy(t.targetName,Math.round(c.damage??t.expectedDamage)))),this.dispatch(uc({id:se(),value:Math.round(c.damage??t.expectedDamage),gridX:a.position.x,gridY:a.position.y,type:c.isCritical?"crit":"damage"}))):this.dispatch(be(i.logStrings.missedEnemy(t.targetName))),c.newAttacker.actionPoints<=0&&this.dispatch(xt())}executeMove(t,i){this.dispatch(Fo(t.destination)),this.dispatch(Fs(-t.apCost)),i.player.actionPoints-t.apCost<=0&&this.dispatch(xt())}executeWait(t){const i=Zi(t.player)?0:pt;t.player.actionPoints<=i?this.dispatch(xt()):(this.dispatch(Fs(-t.player.actionPoints)),this.dispatch(xt()))}}export{Tg as $,B as A,Zg as B,ne as C,Il as D,Qn as E,Ml as F,zg as G,W as H,Gg as I,ss as J,tf as K,Gm as L,Yg as M,om as N,Pp as O,wp as P,jp as Q,vt as R,yp as S,Kp as T,Ch as U,Lp as V,km as W,Ru as X,uc as Y,Wm as Z,_m as _,yg as a,Km as a$,Fg as a0,Og as a1,sf as a2,Au as a3,Hi as a4,$g as a5,us as a6,Me as a7,R as a8,dp as a9,zm as aA,bm as aB,Fs as aC,gg as aD,Lg as aE,Dg as aF,Lm as aG,Mm as aH,Jr as aI,gp as aJ,Ap as aK,Ji as aL,fi as aM,xu as aN,Iu as aO,Ym as aP,cp as aQ,_r as aR,Qi as aS,Ip as aT,Hm as aU,Nm as aV,Om as aW,Vm as aX,Pi as aY,Tu as aZ,og as a_,pp as aa,mp as ab,ym as ac,Fo as ad,wg as ae,vm as af,Cg as ag,Qg as ah,We as ai,xl as aj,xg as ak,Jg as al,ef as am,wm as an,bp as ao,xt as ap,Em as aq,Xg as ar,lg as as,Ho as at,tm as au,pt as av,Zi as aw,_e as ax,Ba as ay,ig as az,ug as b,Fr as b0,hp as b1,up as b2,Tp as b3,$m as b4,Zm as b5,Sm as b6,D as b7,jg as b8,Gd as b9,Op as bA,Gt as bB,Np as bC,zp as bD,Wp as bE,Gp as bF,fp as bG,qp as bH,Vp as bI,em as bJ,nm as bK,Sp as ba,yt as bb,dg as bc,Qp as bd,Jp as be,Rp as bf,Jm as bg,eg as bh,Tl as bi,Cl as bj,nc as bk,sg as bl,qs as bm,Ug as bn,Qr as bo,Xi as bp,Cr as bq,sm as br,Ln as bs,lp as bt,Ki as bu,gr as bv,op as bw,rm as bx,am as by,Bp as bz,Ri as c,hg as d,fg as e,be as f,pg as g,mg as h,Rm as i,Tm as j,Oa as k,Ag as l,Na as m,hm as n,fm as o,cm as p,dm as q,Ig as r,Mg as s,mm as t,ti as u,Eg as v,Pg as w,Ei as x,Di as y,Vg as z};
