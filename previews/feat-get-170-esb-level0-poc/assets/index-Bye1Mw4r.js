const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/GameMenu-h628ydeX.js","assets/vendor-Cc93p67d.js","assets/phaser-DkaA9Y8j.js","assets/game-content-C9O_rpgO.js","assets/game-core-ChunzXPs.js","assets/EnhancedButton-DVdhyrz_.js","assets/CharacterCreationScreen-Derer2jd.js","assets/Tooltip-CnX58fCC.js","assets/CharacterScreen-DPRr6bzy.js","assets/LevelUpModal-BkRZt7Bl.js","assets/PerkSelectionPanel-CGNMNxCY.js","assets/LevelUpPointAllocationPanel-DjehWJVy.js"])))=>i.map(i=>d[i]);
var ks=Object.defineProperty;var Es=(e,t,n)=>t in e?ks(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var Ce=(e,t,n)=>Es(e,typeof t!="symbol"?t+"":t,n);import{r as c,u as E,j as s,e as K,f as je,g as Ms,R as Rt,P as Cs,h as Ts}from"./vendor-Cc93p67d.js";import{P as Oe}from"./phaser-DkaA9Y8j.js";import{B as Ps,M as _s,u as As,C as ee,w as Rs,l as ir,c as Me,r as Ra,s as Ds,A as xe,a as js,b as Ls,d as Da,e as ja,f as F,g as or,h as Ns,i as La,j as Gt,k as Cn,m as Tn,n as Os,o as zs,p as Fs,q as lr,t as Bs,v as Hs,x as Ws,y as $s,R as Us,z as cr,D as dr,E as Gs,F as Vs,N as ur,G as qs,H as Bn,I as Ys,J as Na,K as Ks,L as fr,O as Xs,S as mr,P as Qs,Q as ln,T as pr,U as Zs,V as Oa,W as Js,X as ei,Y as kt,Z as gr,_ as cn,$ as ti,a0 as hr,a1 as ni,a2 as ri,a3 as br,a4 as dn,a5 as yr,a6 as Et,a7 as Ht,a8 as xr,a9 as Hn,aa as bt,ab as Yt,ac as wr,ad as Mt,ae as Vt,af as Ct,ag as ai,ah as si,ai as un,aj as fn,ak as vr,al as ii,am as oi,an as Sr,ao as ht,ap as tt,aq as li,ar as ci,as as di,at as Ir,au as ui,av as fi,aw as mi,ax as mn,ay as pi,az as Pn,aA as Kt,aB as gi,aC as hi,aD as bi,aE as yi,aF as xi,aG as wi,aH as vi,aI as Si,aJ as Ii,aK as _n,aL as ki,aM as nt,aN as kr,aO as Ei,aP as Mi,aQ as Ci,aR as Ti,aS as Pi,aT as _i,aU as Ai,aV as Ri,aW as za,aX as Di,aY as ji,aZ as Xt,a_ as Li,a$ as Ni,b0 as Oi,b1 as zi,b2 as Fi,b3 as Bi,b4 as Hi,b5 as Wi,b6 as $i,b7 as ye,b8 as Fa,b9 as Ui,ba as Gi,bb as Er,bc as Vi,bd as qi,be as pn,bf as Yi}from"./game-core-ChunzXPs.js";import{o as Qe,P as ge,n as Pe,v as $e,p as Ki,e as Xi}from"./game-content-C9O_rpgO.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}})();const Qi="modulepreload",Zi=function(e){return"/the-getaway/previews/feat-get-170-esb-level0-poc/"+e},Mr={},yt=function(t,n,r){let a=Promise.resolve();if(n&&n.length>0){let l=function(m){return Promise.all(m.map(f=>Promise.resolve(f).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),d=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));a=l(n.map(m=>{if(m=Zi(m),m in Mr)return;Mr[m]=!0;const f=m.endsWith(".css"),u=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${m}"]${u}`))return;const h=document.createElement("link");if(h.rel=f?"stylesheet":Qi,f||(h.as="script"),h.crossOrigin="",h.href=m,d&&h.setAttribute("nonce",d),document.head.appendChild(h),f)return new Promise((v,x)=>{h.addEventListener("load",v),h.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${m}`)))})}))}function o(l){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=l,window.dispatchEvent(i),!i.defaultPrevented)throw l}return a.then(l=>{for(const i of l||[])i.status==="rejected"&&o(i.reason);return t().catch(o)})},Ji=({onRendererInfo:e})=>{const t=c.useRef(null),n=c.useRef(null),[r,a]=c.useState({label:"Detecting…",detail:"Negotiating renderer"}),o=c.useRef({width:0,height:0});c.useEffect(()=>{if(console.log("[GameCanvas] useEffect running"),console.log("[GameCanvas] gameContainerRef.current:",t.current),!t.current){console.error("[GameCanvas] No container ref available");return}const m=t.current.offsetWidth,f=t.current.offsetHeight;console.log("[GameCanvas] Container dimensions:",{parentWidth:m,parentHeight:f});const u=_=>{switch(_){case Oe.WEBGL:return{label:"WebGL",detail:"GPU accelerated (shaders, batching)",type:_};case Oe.CANVAS:return{label:"Canvas",detail:"CPU rasterization fallback",type:_};case Oe.HEADLESS:return{label:"Headless",detail:"No renderer active",type:_};default:return{label:"Detecting…",detail:"Negotiating renderer",type:_}}},h=()=>{const _=n.current;if(!_||!_.renderer){a({label:"Detecting…",detail:"Negotiating renderer",type:void 0});return}const L=u(_.renderer.type);a(L)},v={type:Oe.AUTO,width:m>0?m:800,height:f>0?f:600,backgroundColor:"#05070d",parent:t.current,scene:[Ps,_s],scale:{mode:Oe.Scale.FIT,autoCenter:Oe.Scale.CENTER_BOTH,width:m>0?m:800,height:f>0?f:600},render:{antialias:!0,pixelArt:!1,roundPixels:!1,transparent:!1,powerPreference:"high-performance"},physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!1}},pixelArt:!1,roundPixels:!1,transparent:!1};if(console.log("[GameCanvas] Phaser config:",v),!n.current)try{n.current=new Oe.Game(v);const _=n.current;_.isBooted?h():_.events.once(Oe.Core.Events.READY,h),console.log("[GameCanvas] Phaser game initialized successfully")}catch(_){console.error("[GameCanvas] Error initializing Phaser:",_)}let x,b=null;const A={width:m,height:f},C=(_,L)=>{if(!n.current)return;const B=Math.max(0,Math.floor(_)),Q=Math.max(0,Math.floor(L));if(B===0||Q===0)return;const{width:se,height:me}=o.current;if(se===B&&me===Q)return;o.current={width:B,height:Q},n.current.scale.resize(B,Q)},y=(_,L)=>{typeof _=="number"&&typeof L=="number"?(A.width=_,A.height=L):t.current&&(A.width=t.current.offsetWidth,A.height=t.current.offsetHeight),b!==null&&window.clearTimeout(b),b=window.setTimeout(()=>{b=null,C(A.width,A.height)},40)},O=()=>{y()};return typeof ResizeObserver<"u"&&t.current&&(x=new ResizeObserver(_=>{const L=_[0];L&&y(L.contentRect.width,L.contentRect.height)}),x.observe(t.current)),window.addEventListener("resize",O),()=>{console.log("[GameCanvas] Cleanup running"),window.removeEventListener("resize",O),b!==null&&window.clearTimeout(b),x&&x.disconnect(),n.current&&(n.current.events.off(Oe.Core.Events.READY,h),n.current.destroy(!0),n.current=null,console.log("[GameCanvas] Phaser game destroyed"))}},[]),console.log("[GameCanvas] Rendering component");const l=E(m=>m.settings.testMode),i=E(m=>m.settings.lightsEnabled),d=E(m=>m.settings.visualQualityPreset);return c.useEffect(()=>{As({lightsEnabled:i,qualityPreset:d})},[i,d]),c.useEffect(()=>{n.current&&window.requestAnimationFrame(()=>{window.dispatchEvent(new Event("resize"))})},[l]),c.useEffect(()=>{e&&e(r)},[e,r]),s.jsx("div",{style:{position:"relative",width:"100%",height:"100%",backgroundColor:"var(--color-gunmetal-900)",overflow:"hidden",display:"flex",justifyContent:"center",alignItems:"center",pointerEvents:"none"},children:s.jsx("div",{ref:t,style:{position:"absolute",width:"100%",height:"100%",top:0,left:0,right:0,bottom:0,display:"flex",justifyContent:"center",alignItems:"center",backgroundColor:"var(--color-gunmetal-900)",minWidth:"400px",minHeight:"300px",pointerEvents:"auto"}})})},eo=()=>({type:"wait",score:0,summary:"Hold position",rationale:["No safer move available"]}),to=e=>eo(),gn=typeof window<"u"?window:globalThis;class no{constructor(){Ce(this,"timeouts",new Set)}schedule(t,n){const r=gn.setTimeout(()=>{this.timeouts.delete(r),t()},n);return this.timeouts.add(r),r}cancel(t){t!=null&&(gn.clearTimeout(t),this.timeouts.delete(t))}dispose(){this.timeouts.forEach(t=>{gn.clearTimeout(t)}),this.timeouts.clear()}}const ro=()=>new no,Ee=["evening","night"],ao=[{zoneId:"downtown_checkpoint",cameras:[{id:"downtown_training_static",type:"static",position:{x:28,y:18},range:6,fieldOfView:90,activationPhases:Ee,sweep:{angles:[300,270,240],cycleDurationMs:2600}},{id:"downtown_static_01",type:"static",position:{x:18,y:22},range:8,fieldOfView:90,activationPhases:Ee,sweep:{angles:[310,270,230],cycleDurationMs:3200}},{id:"downtown_static_02",type:"static",position:{x:52,y:20},range:8,fieldOfView:90,activationPhases:Ee,sweep:{angles:[45,90,135],cycleDurationMs:3e3}},{id:"downtown_motion_01",type:"motionSensor",position:{x:36,y:44},range:4,fieldOfView:360,activationPhases:Ee,motionRadius:4},{id:"downtown_drone_01",type:"drone",position:{x:70,y:16},range:10,fieldOfView:90,activationPhases:Ee,patrolPath:{waypoints:[{x:70,y:16},{x:78,y:28},{x:64,y:34},{x:56,y:22}],travelDurationMs:12e3},sweep:{angles:[0,45,0,-45],cycleDurationMs:2800}}]},{zoneId:"gov_complex",cameras:[{id:"gov_static_01",type:"static",position:{x:14,y:12},range:9,fieldOfView:90,activationPhases:Ee,sweep:{angles:[315,270,225,180],cycleDurationMs:3600}},{id:"gov_static_02",type:"static",position:{x:40,y:10},range:9,fieldOfView:90,activationPhases:Ee,sweep:{angles:[0,45,90],cycleDurationMs:3600}},{id:"gov_motion_01",type:"motionSensor",position:{x:27,y:26},range:4,fieldOfView:360,activationPhases:Ee,motionRadius:4},{id:"gov_motion_02",type:"motionSensor",position:{x:48,y:26},range:4,fieldOfView:360,activationPhases:Ee,motionRadius:4},{id:"gov_drone_01",type:"drone",position:{x:56,y:18},range:12,fieldOfView:90,activationPhases:Ee,patrolPath:{waypoints:[{x:56,y:18},{x:70,y:24},{x:60,y:36},{x:46,y:28}],travelDurationMs:14e3},sweep:{angles:[15,0,-15],cycleDurationMs:2600}},{id:"gov_static_03",type:"static",position:{x:32,y:6},range:9,fieldOfView:90,activationPhases:Ee,sweep:{angles:[200,240,280],cycleDurationMs:3400}}]},{zoneId:"corporate_plaza",cameras:[{id:"corp_static_01",type:"static",position:{x:12,y:12},range:8,fieldOfView:90,activationPhases:Ee,sweep:{angles:[40,0,-40],cycleDurationMs:3e3}},{id:"corp_motion_01",type:"motionSensor",position:{x:26,y:22},range:4,fieldOfView:360,activationPhases:Ee,motionRadius:4},{id:"corp_drone_01",type:"drone",position:{x:34,y:14},range:10,fieldOfView:90,activationPhases:Ee,patrolPath:{waypoints:[{x:34,y:14},{x:42,y:16},{x:40,y:28},{x:30,y:24}],travelDurationMs:1e4},sweep:{angles:[90,120,90,60],cycleDurationMs:2400}}]},{zoneId:"industrial_corridor",cameras:[{id:"ind_static_01",type:"static",position:{x:8,y:32},range:9,fieldOfView:90,activationPhases:Ee,sweep:{angles:[180,210,240],cycleDurationMs:3200}},{id:"ind_motion_01",type:"motionSensor",position:{x:22,y:40},range:4,fieldOfView:360,activationPhases:Ee,motionRadius:4}]},{zoneId:"resistance_safehouse",cameras:[]}],so=e=>{const t=ao.find(n=>n.zoneId===e);return t?t.cameras.map(n=>({...n})):[]},io=400,oo=3200,Ba=e=>{const t=typeof e=="number"&&Number.isFinite(e)?Math.abs(e):oo;return Math.max(io,t)},_t=e=>{const t=Rs(e);return t<0?t+360:t},lo=e=>{var r;const t=((r=e.sweep)==null?void 0:r.angles)??[],n=t.length>0?_t(t[0]):_t(e.fieldOfView>=360?0:e.fieldOfView/2);return{...e,alertState:ee.IDLE,detectionProgress:0,isActive:!1,hackState:{},lastDetectionTimestamp:void 0,currentDirection:n,sweepDirection:1,sweepElapsedMs:0,sweepIndex:0,patrolProgressMs:0,currentWaypointIndex:0,networkAlertContributionAt:void 0,trackingPlayer:!1,trackingDirection:void 0}},Ha=(e,t,n,r)=>{const a=e.sweep;if(!a||a.angles.length===0)return{direction:n?r:e.currentDirection,sweepDirection:e.sweepDirection??1,sweepIndex:e.sweepIndex??0,sweepElapsedMs:e.sweepElapsedMs??0};const o=a.angles,l=o.length;if(l===1){const y=n?r+o[0]:o[0];return{direction:_t(y),sweepDirection:e.sweepDirection??1,sweepIndex:0,sweepElapsedMs:0}}let i=e.sweepDirection??1,d=Me(e.sweepIndex??0,0,l-1),m=(e.sweepElapsedMs??0)+t;const f=Ba(a.cycleDurationMs)/(l-1);for(;m>=f;){m-=f;let y=d+i;y>=l?(i=-1,y=l-2):y<0&&(i=1,y=1),d=Me(y,0,l-1)}const u=Me(d+i,0,l-1),h=Me(f===0?0:m/f,0,1),v=o[d],x=o[u],b=Ds(v,x),A=v+b*h,C=n?r+A:A;return{direction:_t(C),sweepDirection:i,sweepIndex:d,sweepElapsedMs:m}},Wa=(e,t)=>{const n=Ha(e,t,!1,0);return e.currentDirection=n.direction,e.sweepDirection=n.sweepDirection,e.sweepIndex=n.sweepIndex,e.sweepElapsedMs=n.sweepElapsedMs,e},hn=(e,t)=>t===0?0:e<0?t-1:e>=t?0:e,co=(e,t)=>{const n=e.patrolPath;if(!n||n.waypoints.length===0)return Wa(e,t);const r=n.waypoints,a=Ba(n.travelDurationMs)/r.length;let o=(e.patrolProgressMs??0)+t,l=hn(e.currentWaypointIndex??0,r.length),i=hn(l+1,r.length);for(;o>=a;)o-=a,l=i,i=hn(l+1,r.length);const d=r[l],m=r[i],f=a<=0?0:Me(o/a,0,1),u=ir(d.x,m.x,f),h=ir(d.y,m.y,f),v=Math.atan2(m.y-d.y,m.x-d.x),x=Ra(v),b=Ha(e,t,!0,x);return e.position={x:u,y:h},e.currentDirection=b.direction,e.currentWaypointIndex=l,e.patrolProgressMs=o,e.sweepDirection=b.sweepDirection,e.sweepIndex=b.sweepIndex,e.sweepElapsedMs=b.sweepElapsedMs,e},uo=(e,t)=>{let n;switch(e.type){case"drone":n=co(e,t);break;case"motionSensor":case"static":default:n=Wa(e,t);break}return n.trackingPlayer&&typeof n.trackingDirection=="number"&&(n.currentDirection=_t(n.trackingDirection)),n},fo=(e,t)=>{const{hackState:n}=e;return n?!!(n.disabledUntil&&n.disabledUntil>t):!1},mo=(e,t)=>{const{hackState:n}=e;return!!(n!=null&&n.loopFootageUntil&&n.loopFootageUntil>t)},bn=e=>{switch(e){case xe.IDLE:return 0;case xe.SUSPICIOUS:return 1;case xe.INVESTIGATING:return 2;case xe.ALARMED:return 3;default:return 0}},$a=(e,t)=>{const n=e.x-t.x,r=e.y-t.y;return Math.sqrt(n*n+r*r)},Ua=(e,t)=>t.blackoutTier==="rolling"?.55:t.blackoutTier==="brownout"?.65:e==="night"?.7:e==="evening"||e==="morning"?.85:1,Ga=e=>{var l;const t=((l=e.skillTraining)==null?void 0:l.stealth)??0,n=e.skills.agility??5,r=Math.min(t/120,.35),a=Math.max(0,(n-6)*.03),o=Math.min(.45,r+a);return Me(1-o,.55,1)},Va=e=>{switch(e.movementProfile){case"silent":return .7;case"sprint":return 1.15;default:return 1}},po=e=>{const t=e.label;return typeof t=="string"&&t.trim().length>0?t:e.id.split(/[_-]/g).map(n=>n.charAt(0).toUpperCase()+n.slice(1)).join(" ")},go=({enemy:e,player:t,mapArea:n,timeOfDay:r,environmentFlags:a,playerVisible:o,timestamp:l})=>{const i=e.visionCone;if(!i||!o)return null;const d=e.alertLevel??xe.IDLE,m=$a(e.position,t.position),f=i.range||8,u=Me(.7+bn(d)*.06,.6,.95),h=Me(1-m/(f+1),.25,1),v=Ua(r,a),x=Ga(t),b=Va(t);return{witnessId:e.id,witnessLabel:e.name??"Guard",targetId:t.id,zoneId:n.zoneId,areaId:n.id,timestamp:l,source:"guard",recognitionChannel:"face",baseCertainty:u,distanceModifier:h,lightingModifier:v,disguiseModifier:x,postureModifier:b,reported:bn(d)>=bn(xe.INVESTIGATING),location:{...e.position}}},ho=({camera:e,player:t,mapArea:n,timeOfDay:r,environmentFlags:a,timestamp:o,alertState:l})=>{const i=$a(e.position,t.position),d=e.range||8,m=l===ee.ALARMED?.88:l===ee.SUSPICIOUS?.65:.5,f=Me(1-i/(d+1),.3,1),u=Ua(r,a),h=Ga(t),v=Va(t);return{witnessId:e.id,witnessLabel:po(e),targetId:t.id,zoneId:n.zoneId,areaId:n.id,timestamp:o,source:"camera",recognitionChannel:"face",baseCertainty:m,distanceModifier:f,lightingModifier:u,disguiseModifier:h,postureModifier:v,reported:l===ee.ALARMED,location:{...e.position}}},bo=100/3e3,Cr=100/4e3,yo=6e4,xo=5*60*1e3,Qt={},Ge={},qa=(e,t)=>!e.activationPhases||e.activationPhases.length===0?!0:e.activationPhases.includes(t),wo=e=>{const t=e%360;return t<0?t+360:t},vo=(e,t)=>{const n=Math.atan2(t.position.y-e.position.y,t.position.x-e.position.x),r=Ra(n);return wo(r)},Ya=(e,t)=>{const n=t.x-e.x,r=t.y-e.y;return Math.sqrt(n*n+r*r)},Ka=(e,t)=>{var r;const n=(r=e.skillTraining)==null?void 0:r[t];return typeof n=="number"?n:0},So=(e,t)=>{const n=e.type==="motionSensor"?e.motionRadius??e.range:e.range,r=Ka(t,"stealth"),a=Me(r/200,0,.75);let o=n*(1-a);const l=t.movementProfile==="silent"?.8:t.movementProfile==="sprint"?1.2:1;return o*=l,t.stealthModeEnabled&&(o*=.75),Math.max(1,o)},Io=(e,t,n,r,a,o,l)=>{if(!e.isActive)return{state:ee.DISABLED,progress:0,detectionActive:!1,lastDetectionTimestamp:void 0};if(fo(t,l))return{state:ee.DISABLED,progress:0,detectionActive:!1,lastDetectionTimestamp:void 0};const i=mo(t,l),d=So(e,n),m=Ya(e.position,n.position);let f=!1;if(!i)if(e.type==="motionSensor"){const x=n.movementProfile!=="silent";f=m<=d&&a&&x}else Cn(e.position,n.position,{range:d,angle:e.fieldOfView,direction:e.currentDirection})&&Tn(e.position,n.position,r)&&(f=!0);let u=t.detectionProgress,h=t.lastDetectionTimestamp;if(f){const x=Ka(n,"hacking"),b=Me(x/400,0,.25),A=n.movementProfile==="silent"?.7:n.movementProfile==="sprint"?1.2:1,C=n.stealthModeEnabled?.75:1;u+=bo*o*(1-b)*A*C,u=Math.min(100,u),h=l}else{const x=t.trackingPlayer?Cr*1.8:Cr;u-=x*o,u=Math.max(0,u)}let v=ee.IDLE;return u>=100?(v=ee.ALARMED,u=100):u>0&&(v=ee.SUSPICIOUS),{state:v,progress:u,detectionActive:f,lastDetectionTimestamp:h}},ko=(e,t,n)=>{Ge[e]||(Ge[e]=[]),Ge[e].push({cameraId:t,timestamp:n}),Ge[e]=Ge[e].filter(r=>n-r.timestamp<=yo)},Eo=e=>{const t=Ge[e];return t?t.length>=3:!1},Mo=e=>{const{area:t,timeOfDay:n,dispatch:r,timestamp:a}=e,l=so(t.zoneId).map(i=>{const d=lo(i),m=qa(d,n);return d.isActive=m,d.alertState=m?ee.IDLE:ee.DISABLED,d.detectionProgress=0,d.lastDetectionTimestamp=void 0,d});r(Ls({areaId:t.id,zoneId:t.zoneId,cameras:l,timestamp:a})),Qt[t.id]={lastPlayerPosition:void 0,lastUpdateTimestamp:a,hudSnapshot:void 0},Ge[t.id]=[]},Tr=e=>{const{areaId:t,dispatch:n}=e;n(js({areaId:t})),delete Qt[t],delete Ge[t]},Co=e=>{const{zone:t,area:n,timeOfDay:r,dispatch:a,timestamp:o}=e;if(!t||!n)return;const l=[];let i=!1;Object.values(t.cameras).forEach(d=>{const m=qa(d,r);if(m===d.isActive&&(m||d.alertState===ee.DISABLED&&(d.detectionProgress??0)===0))return;const f={isActive:m,detectionProgress:m?d.detectionProgress:0,lastDetectionTimestamp:m?d.lastDetectionTimestamp:void 0,alertState:m?ee.IDLE:ee.DISABLED,trackingPlayer:!1,trackingDirection:void 0};m?i=!0:i=i||d.isActive,l.push({cameraId:d.id,changes:f})}),l.forEach(d=>{a(Da({areaId:t.areaId,cameraId:d.cameraId,changes:d.changes,timestamp:o}))}),i&&r!=="day"&&r!=="morning"&&a(ja({visible:!0,timestamp:o}))},To=e=>{const{zone:t,mapArea:n,player:r,deltaMs:a,timestamp:o,dispatch:l,logStrings:i,reinforcementsScheduled:d,globalAlertLevel:m,timeOfDay:f,environmentFlags:u,worldTimeSeconds:h,onWitnessObservation:v}=e,x=Qt[t.areaId]??{lastPlayerPosition:void 0},b=x.lastPlayerPosition,A=b?b.x!==r.position.x||b.y!==r.position.y:!1,C=P=>{switch(P){case ee.ALARMED:return 3;case ee.SUSPICIOUS:return 2;case ee.IDLE:return 1;case ee.DISABLED:default:return 0}},y=P=>P.type==="motionSensor"?P.motionRadius??P.range:P.range;let O=0,_=0,L=ee.IDLE,B=null;const Q=[];let se=!1,me=!1;Object.values(t.cameras).forEach(P=>{const I={...P,position:{...P.position},hackState:{...P.hackState}};uo(I,a);const Y=Io(I,P,r,n,A,a,o);if(I.alertState=Y.state,I.detectionProgress=Y.progress,I.lastDetectionTimestamp=Y.lastDetectionTimestamp,I.alertState===ee.DISABLED&&(I.detectionProgress=0),I.type!=="motionSensor")if(I.isActive&&Y.detectionActive&&(I.alertState===ee.SUSPICIOUS||I.alertState===ee.ALARMED)){const re=vo(I,r);I.trackingPlayer=!0,I.trackingDirection=re,I.currentDirection=re}else I.trackingPlayer&&(I.trackingPlayer=!1,I.trackingDirection=void 0);else I.trackingPlayer&&(I.trackingPlayer=!1,I.trackingDirection=void 0);const te=I.alertState!==P.alertState,de=I.currentDirection!==P.currentDirection,he=I.position.x!==P.position.x||I.position.y!==P.position.y,q=Math.abs(I.detectionProgress-P.detectionProgress)>.1,Z=I.lastDetectionTimestamp!==P.lastDetectionTimestamp,ce=I.sweepDirection!==P.sweepDirection||I.sweepIndex!==P.sweepIndex||Math.abs((I.sweepElapsedMs??0)-(P.sweepElapsedMs??0))>.1,ue=(I.trackingPlayer??!1)!==(P.trackingPlayer??!1),le=I.trackingDirection!==P.trackingDirection;if(te&&(I.alertState===ee.SUSPICIOUS||I.alertState===ee.ALARMED)){const R=ho({camera:I,player:r,mapArea:n,timeOfDay:f,environmentFlags:u,timestamp:h,alertState:I.alertState});v&&v(R)}if((te||de||he||q||Z||ce||ue||le)&&Q.push({cameraId:P.id,runtime:I,previous:P}),te&&I.alertState===ee.ALARMED&&(me=!0,ko(t.areaId,P.id,o)),I.isActive&&I.alertState!==ee.DISABLED){const R=y(I);Ya(I.position,r.position)<=R+.5&&(O+=1)}I.detectionProgress>_&&(_=I.detectionProgress,B=P.id),C(I.alertState)>C(L)&&(L=I.alertState)}),Q.forEach(({cameraId:P,runtime:I,previous:Y})=>{const te={alertState:I.alertState,detectionProgress:I.detectionProgress,currentDirection:I.currentDirection,lastDetectionTimestamp:I.lastDetectionTimestamp,position:I.position,sweepDirection:I.sweepDirection,sweepIndex:I.sweepIndex,sweepElapsedMs:I.sweepElapsedMs,patrolProgressMs:I.patrolProgressMs,currentWaypointIndex:I.currentWaypointIndex,trackingPlayer:I.trackingPlayer,trackingDirection:I.trackingDirection};I.isActive||(te.detectionProgress=0,te.alertState=ee.DISABLED,te.lastDetectionTimestamp=void 0,te.trackingPlayer=!1,te.trackingDirection=void 0),l(Da({areaId:t.areaId,cameraId:P,changes:te,timestamp:o})),Y.alertState!==I.alertState&&(I.alertState===ee.SUSPICIOUS&&Y.alertState===ee.IDLE&&l(F(i.alertSuspicious)),I.alertState===ee.ALARMED&&Y.alertState!==ee.ALARMED&&l(F(i.alertAlarmed)))});const G=Ge[t.areaId]??[];let g=t.networkAlert;if(g&&g.expiresAt<=o&&(l(or({areaId:t.areaId,alert:null})),g=null),!g&&Eo(t.areaId)){se=!0;const P=G.slice(-3).map(I=>I.cameraId);g={triggeredAt:o,expiresAt:o+xo,contributingCameraIds:P},l(or({areaId:t.areaId,alert:g}))}const w={camerasNearby:O,detectionProgress:Number(Math.min(100,_).toFixed(2)),alertState:L,activeCameraId:B,networkAlertActive:!!g,networkAlertExpiresAt:(g==null?void 0:g.expiresAt)??null},S=x.hudSnapshot;(!S||S.camerasNearby!==w.camerasNearby||Math.abs(S.detectionProgress-w.detectionProgress)>.5||S.alertState!==w.alertState||S.activeCameraId!==w.activeCameraId||S.networkAlertActive!==w.networkAlertActive||S.networkAlertExpiresAt!==w.networkAlertExpiresAt)&&(l(Ns(w)),x.hudSnapshot=w),me&&!d?(l(F(i.reinforcementsIncoming)),l(La()),l(Gt(xe.ALARMED))):se?(l(F(i.curfewReinforcement)),l(Gt(xe.ALARMED))):me&&m!==xe.ALARMED&&l(Gt(xe.ALARMED)),Qt[t.areaId]={...x,lastPlayerPosition:{...r.position},lastUpdateTimestamp:o}},rt=[],Po=e=>{const t=rt.findIndex(n=>n.id===e.id);if(t>=0){rt[t]={...rt[t],...e},rt[t].fired=!1,rt[t].lastFiredAt=void 0;return}rt.push({...e})},_o=e=>{e.forEach(Po)},Ao=(e,t,n=Date.now())=>{const r=t();rt.forEach(a=>{a.once&&a.fired||typeof a.cooldownMs=="number"&&a.lastFiredAt!==void 0&&n-a.lastFiredAt<a.cooldownMs||!a.when(r)||(a.fire({dispatch:e,getState:t,now:n}),a.lastFiredAt=n,a.once&&(a.fired=!0))})},Ro={low:[{id:"rumor.low.coyotes-logo",groupId:"slum-barflies",flag:"gangHeat",value:"low",storyFunction:"world-building",description:"Warm-up chatter when the streets are calm.",lines:["Coyotes rebranded again. Same howls, new accounting font.","CorpSec confiscated their synth-leather jackets. Fashion crime unit, I guess.","If the gang war is over, someone forgot to tell the bullet holes."]},{id:"rumor.low.tax-audit",groupId:"dock-liquor-patrons",flag:"gangHeat",value:"low",storyFunction:"foreshadow",description:"Hints at upcoming tensions despite low heat.",lines:["Heard the Coyotes scheduled a tax audit. They grow up so fast.","You know it’s quiet when the bartops stop vibrating.","Peace smells like ozone and unpaid protection money."]}],med:[{id:"rumor.med.return",groupId:"slum-barflies",flag:"gangHeat",value:"med",storyFunction:"misdirect",description:"Contradicts official statements to set up later payoffs.",lines:["Coyotes are back. Again. They brought merch this time.","Saw their lieutenant handing out coupons for muggings. 20% off with code “WHOOPS”.","If the city says everything is fine, duck."]},{id:"rumor.med.payroll",groupId:"dock-liquor-patrons",flag:"gangHeat",value:"med",storyFunction:"payoff",description:"Signals growing pressure around the docks.",lines:["Dock payroll went missing. Must have taken the scenic route through a heist.","CorpSec switched to hazard pay. They called it “enthusiasm adjustment”.","Graffiti keeps spelling “WE ARE TEMPORARY”. Someone stamped “UNTIL AUDIT COMPLETE” on top."]}],high:[{id:"rumor.high.curfew",groupId:"slum-barflies",flag:"gangHeat",value:"high",storyFunction:"foreshadow",description:"Signals impending clampdowns.",lines:["Curfew now starts before brunch. Crime brunch still sold out.","Coyotes swapped bullets for invoices. Same damage, more paperwork.","Saw CorpSec drones high-fiving. Never a good omen."]},{id:"rumor.high.wanted",groupId:"dock-liquor-patrons",flag:"gangHeat",value:"high",storyFunction:"payoff",description:"Pairs with power glitch triggers that reveal wanted posters.",lines:["CRTs keep flashing some wanted face. He already skipped town, obviously.","Dock sirens learned harmony. It’s unnerving in four-part.","When the lights flicker, we clap. Keeps the grid on edge."]}]},Do=e=>Ro[e]??[],jo=[{id:"note.supply.norm.crate",flag:"supplyScarcity",value:"norm",storyFunction:"world-building",description:"Everyday logistics with a dry punchline.",preferredZoneId:"downtown_checkpoint",position:{x:28,y:26},lines:["[DATE STAMP SMEARED]","Shift log: 6 crates “medical”.","Counted 5.","Crate 6 coughing."]},{id:"note.supply.tight.ammo-iou",flag:"supplyScarcity",value:"tight",storyFunction:"misdirect",description:"Sets up later gag about returned bullets.",preferredZoneId:"downtown_checkpoint",position:{x:34,y:30},lines:["IOU: 3 bullets. Return unused.","Signed: Depot Clerk, with love.","PS: Bring wipes."]},{id:"note.supply.rationed.bullet-receipt",flag:"supplyScarcity",value:"rationed",storyFunction:"payoff",description:"Punchline for earlier IOU rumor.",preferredZoneId:"downtown_checkpoint",position:{x:36,y:28},lines:["Receipt: All three bullets returned.","Two still lodged in debtor.","Processing fee waived."]},{id:"note.curfew.tier2",flag:"curfewLevel",value:2,storyFunction:"foreshadow",description:"Hints at creeping curfew changes.",preferredZoneId:"downtown_checkpoint",position:{x:40,y:24},lines:["Memo: Curfew trial balloon.","Please begin night at 3 PM.","Public feedback: “Already dark”."]},{id:"note.gangHeat.high",flag:"gangHeat",value:"high",storyFunction:"payoff",description:"Ties to high-heat rumors.",preferredZoneId:"downtown_checkpoint",position:{x:32,y:34},lines:["Wanted poster: “Seen smiling. Suspicious.”","Reward: Half-price cola (while grid stable).","Report sightings to CO-LAW vending kiosks."]},{id:"note.gangHeat.low.suspicion-drill",flag:"gangHeat",value:"low",storyFunction:"world-building",description:"Field memo coaching crews on witness heat drills.",preferredZoneId:"downtown_checkpoint",position:{x:30,y:24},lines:["Ops memo: Trigger one patrol sighting and log the heat spike.","Break line-of-sight, watch the Suspicion Inspector cool to calm.","Report anomalies to George so the city remembers accurately."]}],Lo=(e,t)=>jo.filter(n=>n.flag===e&&n.value===t),Xa=[{id:"sign.blackout.none.cola",signId:"downtown.vending.primary",flag:"blackoutTier",value:"none",storyFunction:"world-building",description:"Default advertising bluster.",text:"COLA: Now with 12 essential sugars."},{id:"sign.blackout.brownout.colaw",signId:"downtown.vending.primary",flag:"blackoutTier",value:"brownout",storyFunction:"misdirect",description:"First hint the grid is lying.",text:"CO-LAW: Report loiterers, earn fizz miles."},{id:"sign.blackout.rolling.alert",signId:"downtown.vending.primary",flag:"blackoutTier",value:"rolling",storyFunction:"payoff",description:"Full propaganda mode during outages.",text:"CO-LAW: Lights out? Snitch brighter."},{id:"sign.supply.tight.milk",signId:"corner.bodega.priceboard",flag:"supplyScarcity",value:"tight",storyFunction:"foreshadow",description:"Price jumps signal scarcity.",text:"Milk: 45 credits. Bottles scowl included."},{id:"sign.supply.rationed.ammo",signId:"corner.bodega.priceboard",flag:"supplyScarcity",value:"rationed",storyFunction:"payoff",description:"Ammo “sale” becomes a comedic beat.",text:"Ammo Sale*: *Bring your own casing."}],Pr=(e,t)=>Xa.filter(n=>n.flag===e&&n.value===t),No=e=>Xa.find(t=>t.id===e),Wn=[{id:"weather.curfew.0",flag:"curfewLevel",value:0,rainIntensity:0,thunderActive:!1,sirenLoop:!1,storyFunction:"world-building",description:"Dry air wobble when curfew is dormant."},{id:"weather.curfew.1",flag:"curfewLevel",value:1,rainIntensity:.2,thunderActive:!1,sirenLoop:!1,storyFunction:"foreshadow",description:"Light drizzle telegraphs rising tension."},{id:"weather.curfew.2",flag:"curfewLevel",value:2,rainIntensity:.6,thunderActive:!1,sirenLoop:!0,storyFunction:"payoff",description:"Rain and sirens when curfew crosses enforcement threshold."},{id:"weather.curfew.3",flag:"curfewLevel",value:3,rainIntensity:.85,thunderActive:!0,sirenLoop:!0,storyFunction:"world-building",description:"Thunderclaps sync with decision beats at max curfew."},{id:"weather.gangHeat.high",flag:"gangHeat",value:"high",rainIntensity:.75,thunderActive:!0,sirenLoop:!0,storyFunction:"misdirect",description:"Extra thunder during high gang heat for dramatic cues."}],Oo=e=>Wn.find(t=>t.flag==="curfewLevel"&&typeof t.value=="number"&&t.value===e),zo=e=>Wn.find(t=>t.flag==="gangHeat"&&t.value===e),Fo=e=>Wn.find(t=>t.id===e),_r={"slum-barflies":[{dialogueId:"npc_lira_vendor"},{dialogueId:"npc_courier_brant"}],"dock-liquor-patrons":[{dialogueId:"npc_captain_reyna"},{dialogueId:"npc_drone_handler_kesh"}]},Bo=()=>["low","med","high"].flatMap(t=>Do(t).map(r=>({id:`environment.rumor.${r.id}`,cooldownMs:1e3,when:a=>{const{flags:o,rumorSets:l}=a.world.environment;if(o.gangHeat!==t||!(r.groupId in _r))return!1;const i=l[r.groupId];return!i||i.sourceId!==r.id},fire:({dispatch:a,getState:o,now:l})=>{const d=o().settings.locale,m=Qe(d).logs,f=_r[r.groupId];a(Os({groupId:r.groupId,snapshot:{lines:[...r.lines],storyFunction:r.storyFunction,sourceId:r.id,updatedAt:l}})),f.forEach(u=>{a(zs({match:u,profile:{lines:[...r.lines],storyFunction:r.storyFunction,sourceId:r.id,updatedAt:l}}))}),a(F(m.environmentRumorSwap(r.description)))}}))),Ar=e=>{const{flags:t}=e.world.environment;if(t.curfewLevel<3){const n=zo(t.gangHeat);if(n)return n}return Oo(t.curfewLevel)??null},Ho=()=>[{id:"environment.weather.update",when:e=>{const t=Ar(e);if(!t)return!1;const n=e.world.environment.weather,r=e.world.timeOfDay,a=n.presetId!==t.id,o=n.timeOfDay!==r;return a||o},fire:({dispatch:e,getState:t,now:n})=>{const r=t(),a=Ar(r);if(!a)return;const o=r.world.environment.weather,l=r.world.timeOfDay,i=r.settings.locale,d=Qe(i).logs;if(e(Fs({presetId:a.id,rainIntensity:a.rainIntensity,sirenLoop:a.sirenLoop,thunderActive:a.thunderActive,storyFunction:a.storyFunction,updatedAt:n,timeOfDay:l})),o.presetId!==a.id||o.timeOfDay!==l){const m=a.description??a.id;e(F(d.environmentWeatherShift(m)))}}}],Wo=()=>{const e=["none","brownout","rolling"],t=["norm","tight","rationed"],n=e.flatMap(a=>Pr("blackoutTier",a).map(l=>({id:`environment.signage.${l.id}`,cooldownMs:4e3,when:i=>{if(i.world.environment.flags.blackoutTier!==a)return!1;const d=i.world.environment.signage[l.signId];return!d||d.variantId!==l.id},fire:({dispatch:i,getState:d,now:m})=>{const f=d().settings.locale,u=Qe(f).logs;i(lr({signId:l.signId,snapshot:{variantId:l.id,storyFunction:l.storyFunction,updatedAt:m}})),i(F(u.environmentSignageSwap(l.text)))}}))),r=t.flatMap(a=>Pr("supplyScarcity",a).map(l=>({id:`environment.signage.${l.id}`,cooldownMs:4e3,when:i=>{if(i.world.environment.flags.supplyScarcity!==a)return!1;const d=i.world.environment.signage[l.signId];return!d||d.variantId!==l.id},fire:({dispatch:i,getState:d,now:m})=>{const f=d().settings.locale,u=Qe(f).logs;i(lr({signId:l.signId,snapshot:{variantId:l.id,storyFunction:l.storyFunction,updatedAt:m}})),i(F(u.environmentSignageSwap(l.text)))}})));return[...n,...r]},$o=()=>{const e=["norm","tight","rationed"],t=["low","med","high"],n=[0,1,2,3],r=(a,o)=>o.flatMap(l=>Lo(a,l).map(d=>({id:`environment.notes.${d.id}`,cooldownMs:5e3,when:m=>{const f=m.world.environment.flags;return(a==="supplyScarcity"?f.supplyScarcity===l:a==="gangHeat"?f.gangHeat===l:f.curfewLevel===l)?!m.world.environment.notes.some(h=>h.definitionId===d.id):!1},fire:({dispatch:m,getState:f,now:u})=>{const h=f(),v=h.world.currentMapArea.id,x=h.settings.locale,b=Qe(x).logs;m(Bs({instanceId:`env-note::${d.id}`,definitionId:d.id,areaId:v,lines:[...d.lines],storyFunction:d.storyFunction,spawnedAt:u})),m(F(b.environmentNoteSpawned(d.description??"new memo recovered")))}})));return[...r("supplyScarcity",e),...r("gangHeat",t),...r("curfewLevel",n)]};let Rr=!1;const Uo=()=>{if(Rr)return;const e=[...Bo(),...Ho(),...Wo(),...$o()];_o(e),Rr=!0},Dr={light:0,balanced:1,heavy:2,sensor:3},jr={open:0,restricted:1,sealed:2},Lr={clear:0,caution:1,severe:2},Go={"smog:none":{},"smog:light":{behavior:{sightMultiplier:.9,chaseMultiplier:.95,routineIntervalMultiplier:1.05},travel:{visibilityMultiplier:.85,staminaDrainPerMinute:1,encounterRiskModifier:1.1,advisoryLevel:"caution"}},"smog:heavy":{behavior:{sightMultiplier:.65,chaseMultiplier:.8,loadoutBias:"sensor",routineIntervalMultiplier:1.2},travel:{visibilityMultiplier:.55,staminaDrainPerMinute:3,encounterRiskModifier:1.35,vehicleWearMultiplier:1.2,advisoryLevel:"severe"}},"blackout:none":{},"blackout:brownout":{behavior:{sightMultiplier:.95},faction:{shopMarkupDelta:.05,reinforcementDelayMultiplier:1.1,safehouseAccess:"restricted"},travel:{visibilityMultiplier:.8,advisoryLevel:"caution"}},"blackout:rolling":{behavior:{sightMultiplier:.85,loadoutBias:"sensor"},faction:{shopMarkupDelta:.12,reinforcementDelayMultiplier:.9,safehouseAccess:"restricted"},travel:{visibilityMultiplier:.7,vehicleWearMultiplier:1.1,advisoryLevel:"caution"}},"surveillance:low":{},"surveillance:elevated":{behavior:{chaseMultiplier:1.15,routineIntervalMultiplier:1.05},faction:{reinforcementDelayMultiplier:.95},travel:{encounterRiskModifier:1.2,advisoryLevel:"caution"}},"surveillance:extreme":{behavior:{sightMultiplier:1.1,chaseMultiplier:1.3,loadoutBias:"sensor",routineIntervalMultiplier:1.15},faction:{shopMarkupDelta:.08,reinforcementDelayMultiplier:.75,safehouseAccess:"restricted"},travel:{encounterRiskModifier:1.4,advisoryLevel:"severe"}},"radiation:none":{},"radiation:localized":{behavior:{routineIntervalMultiplier:1.08},faction:{safehouseAccess:"restricted"},travel:{staminaDrainPerMinute:2,vehicleWearMultiplier:1.15,advisoryLevel:"caution"}},"radiation:pervasive":{behavior:{routineIntervalMultiplier:1.18,loadoutBias:"heavy"},faction:{shopMarkupDelta:.1,safehouseAccess:"sealed"},travel:{staminaDrainPerMinute:4,vehicleWearMultiplier:1.3,encounterRiskModifier:1.25,advisoryLevel:"severe"}},"curfew:off":{},"curfew:tight":{behavior:{chaseMultiplier:1.1,routineIntervalMultiplier:1.05},faction:{shopMarkupDelta:.08,reinforcementDelayMultiplier:.85,safehouseAccess:"restricted"},travel:{encounterRiskModifier:1.25,advisoryLevel:"caution"}},"curfew:lockdown":{behavior:{chaseMultiplier:1.35,routineIntervalMultiplier:1.25,loadoutBias:"heavy"},faction:{shopMarkupDelta:.2,reinforcementDelayMultiplier:.65,safehouseAccess:"sealed"},travel:{encounterRiskModifier:1.6,advisoryLevel:"severe"}}},at=(e,t,n)=>Me(e,t,n),Vo=()=>({behavior:{sightMultiplier:1,chaseMultiplier:1,routineIntervalMultiplier:1,loadoutBias:"balanced"},faction:{shopMarkupDelta:0,reinforcementDelayMultiplier:1,safehouseAccess:"open"},travel:{staminaDrainPerMinute:0,vehicleWearMultiplier:1,encounterRiskModifier:1,advisoryLevel:"clear",visibilityMultiplier:1}}),qo=(e,t)=>{if(t&&(typeof t.sightMultiplier=="number"&&(e.sightMultiplier=at(e.sightMultiplier*t.sightMultiplier,.35,1.8)),typeof t.chaseMultiplier=="number"&&(e.chaseMultiplier=at(e.chaseMultiplier*t.chaseMultiplier,.5,2)),typeof t.routineIntervalMultiplier=="number"&&(e.routineIntervalMultiplier=at(e.routineIntervalMultiplier*t.routineIntervalMultiplier,.7,2.2)),t.loadoutBias)){const n=Dr[e.loadoutBias];Dr[t.loadoutBias]>n&&(e.loadoutBias=t.loadoutBias)}},Yo=(e,t)=>{if(t&&(typeof t.shopMarkupDelta=="number"&&(e.shopMarkupDelta=Me(e.shopMarkupDelta+t.shopMarkupDelta,-.5,1)),typeof t.reinforcementDelayMultiplier=="number"&&(e.reinforcementDelayMultiplier=at(e.reinforcementDelayMultiplier*t.reinforcementDelayMultiplier,.4,1.6)),t.safehouseAccess)){const n=jr[e.safehouseAccess];jr[t.safehouseAccess]>n&&(e.safehouseAccess=t.safehouseAccess)}},Ko=(e,t)=>{if(t&&(typeof t.staminaDrainPerMinute=="number"&&(e.staminaDrainPerMinute=Me(e.staminaDrainPerMinute+t.staminaDrainPerMinute,0,12)),typeof t.vehicleWearMultiplier=="number"&&(e.vehicleWearMultiplier=at(e.vehicleWearMultiplier*t.vehicleWearMultiplier,.6,2)),typeof t.encounterRiskModifier=="number"&&(e.encounterRiskModifier=at(e.encounterRiskModifier*t.encounterRiskModifier,.5,3)),typeof t.visibilityMultiplier=="number"&&(e.visibilityMultiplier=at(e.visibilityMultiplier*t.visibilityMultiplier,.2,1)),t.advisoryLevel)){const n=Lr[e.advisoryLevel];Lr[t.advisoryLevel]>n&&(e.advisoryLevel=t.advisoryLevel)}},Xo=e=>{const t=Vo();return e.forEach(n=>{const r=Go[n];r&&(r.behavior&&qo(t.behavior,r.behavior),r.faction&&Yo(t.faction,r.faction),r.travel&&Ko(t.travel,r.travel))}),t},Qo=e=>{if(!e||e.length===0)return"none";const t=e.map(n=>n.toLowerCase());return t.some(n=>n.includes("dense smog")||n.includes("toxic smog"))?"heavy":t.some(n=>n.includes("smog")||n.includes("gas cloud"))?"light":"none"},Zo=(e,t)=>{let n="low";(e.gangHeat!=="low"||e.curfewLevel>=1)&&(n="elevated");const r=(t==null?void 0:t.map(a=>a.toLowerCase()))??[];return(e.gangHeat==="high"||e.curfewLevel>=3||r.some(a=>a.includes("camera")||a.includes("drone")||a.includes("surveillance")||a.includes("riot squad")))&&(n="extreme"),n},Jo=e=>{if(!e||e.length===0)return"none";const t=e.map(n=>n.toLowerCase());return t.some(n=>n.includes("radiation pocket")||n.includes("reactor"))?"localized":t.some(n=>n.includes("radiation")||n.includes("toxic sludge"))?"pervasive":"none"},el=e=>e>=3?"lockdown":e>=1?"tight":"off",tl=e=>{const t=Qo(e.zoneHazards);let n=Jo(e.zoneHazards);n==="none"&&e.zoneId&&(e.zoneId.includes("industrial")||e.zoneId.includes("wasteland"))&&(n="localized");const r=Zo(e.flags,e.zoneHazards),a=el(e.flags.curfewLevel),o=`blackout:${e.flags.blackoutTier}`;return[`smog:${t}`,o,`surveillance:${r}`,`radiation:${n}`,`curfew:${a}`]},$n=e=>e.world.environment,Dt=K($n,e=>e.flags);K(Dt,e=>e.gangHeat);K(Dt,e=>e.curfewLevel);K(Dt,e=>e.supplyScarcity);K(Dt,e=>e.blackoutTier);K($n,e=>e.notes);const Qa=e=>e.world.currentMapArea,nl=K([Dt,Qa],(e,t)=>({flags:e,zoneHazards:(t==null?void 0:t.hazards)??[],zoneId:(t==null?void 0:t.zoneId)??null})),rl=K(nl,e=>tl(e)),Za=K(rl,e=>Xo(e)),al=e=>e.length===0?null:[...e].sort((n,r)=>((r==null?void 0:r.updatedAt)??0)-((n==null?void 0:n.updatedAt)??0))[0]??null,sl=e=>e.length===0?null:[...e].sort((n,r)=>((r==null?void 0:r.updatedAt)??0)-((n==null?void 0:n.updatedAt)??0))[0]??null,il=K([$n,Qa,Za],(e,t,n)=>{const r=Object.entries(e.rumorSets).map(([d,m])=>({groupId:d,lines:[...m.lines],storyFunction:m.storyFunction,updatedAt:m.updatedAt})),a=Object.entries(e.signage).map(([d,m])=>{const f=No(m.variantId);return{signId:d,text:(f==null?void 0:f.text)??"",storyFunction:(f==null?void 0:f.storyFunction)??m.storyFunction,updatedAt:m.updatedAt}}),o=e.weather.presetId?Fo(e.weather.presetId):null,l={presetId:e.weather.presetId,description:(o==null?void 0:o.description)??"",storyFunction:(o==null?void 0:o.storyFunction)??e.weather.storyFunction,updatedAt:e.weather.updatedAt,rainIntensity:e.weather.rainIntensity,thunderActive:e.weather.thunderActive,timeOfDay:e.weather.timeOfDay},i={zoneId:(t==null?void 0:t.zoneId)??null,zoneName:(t==null?void 0:t.displayName)??(t==null?void 0:t.name)??null,dangerRating:(t==null?void 0:t.dangerRating)??null,hazards:Array.isArray(t==null?void 0:t.hazards)?[...t.hazards]:[],summary:(t==null?void 0:t.summary)??null,directives:Array.isArray(t==null?void 0:t.objectives)?t.objectives.filter(d=>d&&d.trim().length>0).map(d=>d.trim()):[]};return{flags:{...e.flags},impacts:n,rumor:al(r),signage:sl(a),weather:l,zone:i}}),Ja=e=>!!e.settings.reputationSystemsEnabled,es=e=>e.suspicion,ts=e=>K(es,Ja,(t,n)=>!n||!e?null:t.zones[e]??null),ns=e=>K(ts(e),t=>t?t.heat:{zoneId:e??"unknown",totalHeat:0,tier:"calm",leadingWitnessIds:[]});K(es,Ja,(e,t)=>t?Hs(e.zones):"calm");const ol=e=>K(ts(e),t=>{if(!t)return[];const{heat:n,memories:r}=t;return n.leadingWitnessIds.map(a=>r[a]).filter(a=>!!a).map(a=>Ws(a))}),xt=e=>e.paranoia,rs=K(xt,e=>e.value),ll=K(xt,e=>e.tier);K(rs,e=>Math.max(0,Math.min(1,e/100)));K(xt,e=>e.cooldowns);const cl=K(xt,e=>e.lastSnapshot);K(xt,e=>e.frozen);const dl=()=>({cameraAlarmedAt:{},guardAlertRank:{},lastCurfewActive:!1,lastLowHealth:!1,lastLowAmmo:!1,lastSafehouse:!1}),Nr=()=>dl(),Or=e=>{switch(e){case xe.ALARMED:return 3;case xe.INVESTIGATING:return 2;case xe.SUSPICIOUS:return 1;default:return 0}},ul=e=>e.type==="motionSensor"?e.motionRadius??e.range:e.range,fl=(e,t)=>{var n,r,a;return e?!!((n=e.zoneId)!=null&&n.toLowerCase().includes("safehouse")||(r=e.name)!=null&&r.toLowerCase().includes("safehouse")||(a=t==null?void 0:t.zoneId)!=null&&a.toLowerCase().includes("safehouse")):!1},ml=(e,t)=>t<=0?0:Me(e/t,0,1),pl=e=>e>=7?.5:e>=5?.8:1,gl=(e,t,n,r)=>e!=="day"||t||n>.02?!1:r===0,hl=(e,t)=>{var G;const n=Math.max(0,e.deltaMs)/1e3,r={},a={},o={},l=e.player,i=e.mapArea,d=e.surveillanceZone,m=Math.max(1,l.skills.perception??5),f=Math.max(1,l.skills.endurance??5),u=Math.max(1,l.skills.intelligence??5),h=Math.max(1,l.skills.charisma??5),v=Math.max(1,l.skills.luck??5),x=Me(1+m*.02-f*.03-u*.03-h*.02,.5,1.8),b=1+f*.02+u*.02+v*.01,A=pl(v);if(d&&i){let g=0,w=0;if(Object.values(d.cameras).forEach(S=>{if(!S.isActive||S.alertState===ee.DISABLED)return;const j=ul(S),P=S.position.x-l.position.x,I=S.position.y-l.position.y,Y=Math.hypot(P,I);if(Y<=ge.surveillance.proximityRadius){const te=1-Math.min(Y/ge.surveillance.proximityRadius,1);g+=te*ge.surveillance.proximityGainPerSecond*n}if(S.type!=="motionSensor"&&Cn(S.position,l.position,{range:j,angle:S.fieldOfView,direction:S.currentDirection})&&Tn(S.position,l.position,i)&&(w+=ge.surveillance.coneGainPerSecond*n),S.alertState===ee.ALARMED){const te=t.cameraAlarmedAt[S.id]??0;e.timestamp-te>=1e4&&(o[`camera:${S.id}`]=ge.surveillance.alertSpike*A,t.cameraAlarmedAt[S.id]=e.timestamp)}}),g>0){const S=Math.min(g,ge.surveillance.maxProximityContributionPerSecond*n);r.camerasProximity=S}w>0&&(r.camerasSweep=w)}let C=0;e.enemies.forEach(g=>{if(!i||!g.visionCone){t.guardAlertRank[g.id]=Or(g.alertLevel);return}(Cn(g.position,l.position,g.visionCone)?Tn(g.position,l.position,i):!1)&&(C+=1,r[`guardLOS:${g.id}`]=(r[`guardLOS:${g.id}`]??0)+ge.guards.lineOfSightGainPerSecond*n);const S=Or(g.alertLevel),j=t.guardAlertRank[g.id]??0;t.guardAlertRank[g.id]=S,g.alertLevel===xe.ALARMED&&(r[`guardPursuit:${g.id}`]=(r[`guardPursuit:${g.id}`]??0)+ge.guards.pursuitGainPerSecond*n),S>=3&&j<3&&(o[`guardChase:${g.id}`]=ge.guards.pursuitSpike*A)});let y=0;if(e.zoneHeat){const g=$s(((G=e.mapArea)==null?void 0:G.zoneId)??null);y=ml(e.zoneHeat.totalHeat,g.tierThresholds.crackdown),y>0&&(r.heat=y*ge.heat.baselineGainPerSecond*n)}e.timeOfDay==="night"&&(r.night=ge.circadian.nightGainPerSecond*n),e.curfewActive&&!t.lastCurfewActive&&(o.curfew=ge.circadian.curfewSpike*A),t.lastCurfewActive=e.curfewActive;const O=Math.max(1,l.maxHealth);l.health/O<ge.health.criticalThreshold?(r.lowHealth=ge.health.sustainedGainPerSecond*n,t.lastLowHealth||(o.lowHealth=ge.health.spike*A),t.lastLowHealth=!0):t.lastLowHealth=!1,t.lastLowAmmo=!1,e.environmentImpacts.travel.staminaDrainPerMinute>0&&(r.hazards=(r.hazards??0)+ge.hazards.smogGainPerSecond*n),e.environmentImpacts.travel.visibilityMultiplier<.75&&(r.hazards=(r.hazards??0)+ge.hazards.blackoutGainPerSecond*n);const B=fl(i,d);B&&(a.safehouse=(a.safehouse??0)+ge.safehouse.reliefPerSecond*n,t.lastSafehouse||(a.safehouseEntry=(a.safehouseEntry??0)+ge.safehouse.entryRelief)),t.lastSafehouse=B,gl(e.timeOfDay,e.curfewActive,r.camerasProximity??0,C)&&(a.daylight=(a.daylight??0)+ge.circadian.daylightReliefPerSecond*n);const Q=1+y,se={};Object.entries(r).forEach(([g,w])=>{if(g==="heat"){se[g]=w;return}se[g]=w*Q});const me={gain:x,decay:b};return Object.keys(o).forEach(g=>{o[g]=o[g]*A}),{gains:se,losses:a,spikes:o,multipliers:me}},Un=e=>!!e.settings.reputationSystemsEnabled,bl={},Gn=e=>e.reputation,yl=K(Un,Gn,(e,t)=>e&&t.debug.heatmapEnabled),as=K(Gn,Un,(e,t)=>t?e.profiles:bl),xl=e=>K(as,t=>t[e]),wl=(e,t=3)=>K(as,n=>{const r=n[e];return r?Us.map(a=>{const o=r.traits[a];return{trait:a,value:(o==null?void 0:o.value)??0,confidence:(o==null?void 0:o.confidence)??0}}).filter(a=>a.value!==0).sort((a,o)=>Math.abs(o.value)-Math.abs(a.value)).slice(0,t):[]}),vl=K(Un,Gn,(e,t)=>e?t.debug.inspectorTargetId??null:null),Sl=()=>{if(typeof process<"u")return"production";if(typeof window<"u"){const e=window;if(typeof e.__VITE_MODE__=="string")return e.__VITE_MODE__}return"development"},Il=e=>`${Math.round(e*100)}`,kl=e=>e.charAt(0).toUpperCase()+e.slice(1),yn=e=>{if(!Number.isFinite(e))return"—";const t=Bn.cycleDuration,n=(e%t+t)%t,r=Math.floor(n/60),a=Math.floor(n%60);return`${r.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`},El={fontSize:"0.64rem",letterSpacing:"0.18em",textTransform:"uppercase",color:"rgba(226, 232, 240, 0.72)"},Ml={all:"unset",display:"flex",alignItems:"center",justifyContent:"space-between",gap:"0.5rem",width:"100%",marginBottom:"0.35rem",cursor:"pointer",letterSpacing:"0.18em",textTransform:"uppercase",color:"rgba(226, 232, 240, 0.86)"},Cl={fontSize:"0.68rem",color:"rgba(148, 163, 184, 0.72)"},Tl={display:"none"},Ke={display:"flex",justifyContent:"space-between",fontSize:"0.78rem",marginBottom:"0.22rem"},zr={listStyle:"none",margin:0,padding:0,display:"grid",gap:"0.35rem"},Fr={padding:"0.45rem 0.55rem",borderRadius:"0.55rem",backgroundColor:"rgba(24, 36, 52, 0.78)",border:"1px solid rgba(70, 104, 150, 0.3)"},Pl={display:"flex",flexDirection:"column",alignItems:"flex-start",gap:"0.5rem",pointerEvents:"auto"},_l={all:"unset",display:"inline-flex",alignItems:"center",gap:"0.45rem",padding:"0.45rem 0.85rem",borderRadius:"999px",border:"1px solid rgba(59, 130, 246, 0.42)",background:"linear-gradient(135deg, rgba(15, 23, 42, 0.92), rgba(30, 41, 59, 0.92))",color:"#e2e8f0",fontFamily:'"DM Mono","IBM Plex Mono",monospace',fontSize:"0.62rem",letterSpacing:"0.2em",textTransform:"uppercase",cursor:"pointer",transition:"transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease"},Xe={all:"unset",display:"inline-flex",alignItems:"center",justifyContent:"center",padding:"0.35rem 0.65rem",borderRadius:"0.55rem",border:"1px solid rgba(148, 163, 184, 0.45)",background:"rgba(15, 23, 42, 0.88)",color:"rgba(226, 232, 240, 0.92)",fontSize:"0.58rem",letterSpacing:"0.18em",textTransform:"uppercase",cursor:"pointer"},Al={padding:"0.85rem 1rem",borderRadius:"0.85rem",backgroundColor:"rgba(12, 18, 28, 0.9)",color:"#f1f5ff",backdropFilter:"blur(6px)",border:"1px solid rgba(59, 130, 246, 0.38)",width:"min(360px, 28vw)",display:"grid",gap:"0.75rem",fontFamily:'"DM Mono","IBM Plex Mono",monospace',boxShadow:"0 18px 40px rgba(15, 23, 42, 0.32)",zIndex:5},ss=({zoneId:e,rendererInfo:t})=>{const n=je(),r=e??"unknown",a=c.useMemo(()=>ns(r),[r]),o=c.useMemo(()=>ol(r),[r]),l=E(yl),i=E(vl),d=E(R=>R.world.currentMapArea.entities.npcs),m=E(R=>R.world.currentMapArea),f=E(R=>R.settings.testMode),u=E(R=>!!R.settings.reputationSystemsEnabled),h=c.useMemo(()=>i?xl(i):null,[i]),v=c.useMemo(()=>i?wl(i,4):null,[i]),x=E(R=>h?h(R):null),b=E(R=>v?v(R):[]),[A,C]=c.useState({renderer:!1,time:!1,suspicion:!1,reputation:!1,paranoia:!1}),y={renderer:"Renderer diagnostics",time:"Time/lighting debug",suspicion:"Suspicion snapshot",reputation:"Reputation debug",paranoia:"Paranoia debug"},[O,_]=c.useState(null),[L,B]=c.useState(null),Q=c.useCallback(R=>{C(re=>({...re,[R]:!re[R]}))},[]);c.useEffect(()=>{!i&&d.length>0&&n(cr(d[0].id))},[n,i,d]);const se=c.useCallback(()=>{const R=Gs||Vs;n(dr(R)),B(`Set to day (${yn(R)})`)},[n]),me=c.useCallback(()=>{n(dr(ur)),B(`Set to night (${yn(ur)})`)},[n]),G=c.useMemo(()=>d.find(R=>R.id===i),[d,i]),[g,w]=c.useState(!0),S=Sl(),j=E(R=>a(R)),P=E(R=>o(R)),I=E(R=>xt(R)),Y=E(cl),te=E(R=>R.world.currentTime),de=E(R=>R.world.timeOfDay),he=c.useCallback(()=>{if(!u){_("Reputation systems are disabled for MVP.");return}if(!i||!m){_("Select an NPC inside the current map to seed a sample event.");return}const R=d.find(re=>re.id===i);if(!R){_("Selected NPC is no longer present in this area.");return}n(qs({actorId:"player",actorLabel:"Player",zoneId:m.zoneId??"zone::debug",position:{...R.position},intensity:"legendary",traits:{heroic:28,intimidating:8},tags:["debug_sample"],mapArea:m,npcsOverride:[R],ambientLighting:1,ambientNoise:.8,disguisePenalty:0,timestamp:Date.now()})),_(`Seeded a heroic event around ${R.name}. If nothing appears, try again nearby or toggle the reputation heatmap.`)},[n,i,m,d,u]);if(c.useEffect(()=>{O&&b.length>0&&_(null)},[O,b.length]),S==="production"||!f)return null;const q="command-debug-panel",Z=(t==null?void 0:t.label)??"Detecting…",ce=(t==null?void 0:t.detail)??"Negotiating renderer",ue=g?"Show Debug Inspector":"Hide Debug Inspector",le=(R,re,N,ze)=>{const _e=A[R],Fe=`${q}-${ze}`,it=typeof re=="string"?re:y[R];return s.jsxs("section",{children:[s.jsxs("button",{type:"button",style:Ml,onClick:()=>Q(R),"aria-expanded":!_e,"aria-controls":Fe,"aria-label":`${_e?"Expand":"Collapse"} ${it}`,children:[s.jsx("span",{style:El,children:re}),s.jsx("span",{style:Cl,children:_e?"▸":"▾"})]}),s.jsx("div",{id:Fe,style:_e?Tl:void 0,"aria-hidden":_e,children:_e?null:N()})]})};return s.jsxs("div",{style:Pl,children:[s.jsxs("button",{type:"button",style:_l,onClick:()=>w(R=>!R),"aria-expanded":!g,"aria-controls":q,children:[s.jsx("span",{children:ue}),s.jsx("span",{style:{fontSize:"0.58rem",letterSpacing:"0.2em",textTransform:"uppercase",opacity:.75},children:Z})]}),!g&&s.jsxs("div",{id:q,style:Al,role:"region","aria-label":"Debug Inspector",children:[le("renderer","Renderer Diagnostics",()=>s.jsxs(s.Fragment,{children:[s.jsxs("div",{style:Ke,children:[s.jsx("span",{children:"Mode"}),s.jsx("span",{children:Z})]}),s.jsxs("div",{style:{...Ke,alignItems:"flex-start"},children:[s.jsx("span",{children:"Detail"}),s.jsx("span",{style:{textAlign:"right",maxWidth:"18rem"},children:ce})]}),s.jsxs("div",{style:Ke,children:[s.jsx("span",{children:"Phaser"}),s.jsx("span",{children:Oe.VERSION})]})]}),"renderer"),le("time","Time & Lighting",()=>s.jsxs(s.Fragment,{children:[s.jsxs("div",{style:Ke,children:[s.jsx("span",{children:"Current"}),s.jsxs("strong",{children:[yn(te)," · ",de]})]}),s.jsxs("div",{style:Ke,children:[s.jsx("span",{children:"Cycle Duration"}),s.jsxs("strong",{children:[Bn.cycleDuration,"s"]})]}),s.jsxs("div",{style:{display:"flex",gap:"0.35rem",flexWrap:"wrap"},children:[s.jsx("button",{type:"button",style:Xe,onClick:se,children:"Set Day"}),s.jsx("button",{type:"button",style:Xe,onClick:me,children:"Set Night"})]}),L&&s.jsx("div",{style:{fontSize:"0.62rem",color:"rgba(96, 165, 250, 0.8)"},children:L})]}),"time"),u&&le("suspicion",`Suspicion Snapshot · ${r}`,()=>s.jsxs(s.Fragment,{children:[s.jsxs("div",{style:Ke,children:[s.jsx("span",{children:"Heat Tier"}),s.jsx("span",{children:j.tier})]}),s.jsxs("div",{style:Ke,children:[s.jsx("span",{children:"Total Heat"}),s.jsx("span",{children:j.totalHeat.toFixed(2)})]}),P.length>0?s.jsx("ul",{style:zr,children:P.map(R=>s.jsxs("li",{style:Fr,children:[s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.72rem",marginBottom:"0.18rem"},children:[s.jsx("span",{children:R.witnessLabel??R.witnessId}),s.jsxs("span",{children:[Il(R.certainty),"%"]})]}),s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.68rem",opacity:.75},children:[s.jsx("span",{children:R.recognitionChannel}),s.jsx("span",{children:R.reported?"reported":"unreported"})]})]},R.id))}):s.jsx("div",{style:{fontSize:"0.7rem",opacity:.65},children:"No active witnesses."})]}),"suspicion"),u&&le("reputation",`Reputation Debug · ${(G==null?void 0:G.name)??"Local Cell"}`,()=>s.jsxs(s.Fragment,{children:[s.jsx("div",{style:{display:"flex",gap:"0.4rem",flexWrap:"wrap",marginBottom:"0.45rem"},children:s.jsx("button",{type:"button",style:{...Xe,borderColor:l?"rgba(96, 165, 250, 0.65)":Xe.border},onClick:()=>n(Ys(!l)),children:l?"Hide Heatmap":"Show Heatmap"})}),s.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"0.35rem",marginBottom:"0.45rem"},children:d.length?d.map(R=>s.jsx("button",{type:"button",style:{...Xe,borderColor:i===R.id?"rgba(96, 165, 250, 0.65)":Xe.border},onClick:()=>n(cr(R.id)),"aria-pressed":i===R.id,children:R.name},R.id)):s.jsx("span",{style:{fontSize:"0.68rem",opacity:.6},children:"No NPCs in this map."})}),s.jsx("div",{style:{fontSize:"0.62rem",color:"rgba(148, 163, 184, 0.75)",marginBottom:"0.35rem"},children:"1) Pick an NPC in the active cell. 2) Trigger an in-game action or use the seed button below. 3) Inspect the traits that populate here and toggle the heatmap to see cell sentiment."}),x?b.length?s.jsx("ul",{style:zr,children:b.map(R=>{const re=x.traits[R.trait],N=(re==null?void 0:re.sources)??[];return s.jsxs("li",{style:Fr,children:[s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.7rem",marginBottom:"0.18rem"},children:[s.jsx("span",{children:kl(R.trait)}),s.jsx("span",{children:R.value.toFixed(1)})]}),s.jsxs("div",{style:{fontSize:"0.64rem",opacity:.72},children:["Confidence ",Math.round(R.confidence*100),"%"]}),N.length?s.jsxs("div",{style:{fontSize:"0.62rem",opacity:.62,marginTop:"0.2rem"},children:["Rumors: ",N.slice(0,3).join(", ")]}):s.jsx("div",{style:{fontSize:"0.62rem",opacity:.45,marginTop:"0.2rem"},children:"No rumor sources tracked."})]},R.trait)})}):s.jsxs("div",{style:{display:"grid",gap:"0.35rem"},children:[s.jsx("div",{style:{fontSize:"0.68rem",opacity:.6},children:"No localized reputation yet. Trigger a nearby event so NPCs can witness something."}),s.jsx("button",{type:"button",onClick:he,style:{...Xe,borderColor:"rgba(96, 165, 250, 0.55)",justifyContent:"center"},disabled:!m,children:"Seed Sample Heroic Event"}),O&&s.jsx("div",{style:{fontSize:"0.62rem",color:"rgba(96, 165, 250, 0.8)"},children:O})]}):s.jsxs("div",{style:{display:"grid",gap:"0.35rem"},children:[s.jsx("div",{style:{fontSize:"0.68rem",opacity:.6},children:"Select an NPC to inspect reputation."}),s.jsx("button",{type:"button",onClick:he,style:{...Xe,borderColor:"rgba(96, 165, 250, 0.55)",justifyContent:"center"},disabled:!m,children:"Seed Sample Heroic Event"}),O&&s.jsx("div",{style:{fontSize:"0.62rem",color:"rgba(96, 165, 250, 0.8)"},children:O})]})]}),"reputation"),le("paranoia",`Paranoia Debug · ${I.tier}`,()=>s.jsxs(s.Fragment,{children:[s.jsxs("div",{style:Ke,children:[s.jsx("span",{children:"Value"}),s.jsx("span",{children:I.value.toFixed(1)})]}),Y?s.jsxs("div",{style:{display:"grid",gap:"0.3rem",fontSize:"0.72rem"},children:[s.jsxs("div",{children:[s.jsx("strong",{style:{opacity:.8},children:"Δ"})," ",Y.delta>=0?"+":"",Y.delta.toFixed(3)]}),s.jsxs("div",{children:[s.jsx("strong",{style:{opacity:.8},children:"Gains"})," ",Object.keys(Y.breakdown.gains).length===0?"—":Object.entries(Y.breakdown.gains).map(([R,re])=>`${R}:${re.toFixed(3)}`).join(" | ")]}),s.jsxs("div",{children:[s.jsx("strong",{style:{opacity:.8},children:"Losses"})," ",Object.keys(Y.breakdown.losses).length===0?"—":Object.entries(Y.breakdown.losses).map(([R,re])=>`${R}:${re.toFixed(3)}`).join(" | ")]}),s.jsxs("div",{children:[s.jsx("strong",{style:{opacity:.8},children:"Spikes"})," ",Object.keys(Y.breakdown.spikes).length===0?"—":Object.entries(Y.breakdown.spikes).map(([R,re])=>`${R}:${re.toFixed(3)}`).join(" | ")]})]}):s.jsx("div",{style:{fontSize:"0.7rem",opacity:.65},children:"No recent paranoia stimuli."})]}),"paranoia")]})]})},Rl=e=>e.world.engagementMode,Dl=e=>e.player.data.stealthModeEnabled,is=e=>e.player.data.stealthCooldownExpiresAt,Vn=e=>e.quests.activeDialogue.dialogueId,jl=K([e=>e.world.inCombat,Vn,is],(e,t,n)=>!(e||t||typeof n=="number"&&n>Date.now())),os=K([Dl,jl,is],(e,t,n)=>({enabled:e,eligible:t,cooldownExpiresAt:typeof n=="number"?n:null,onCooldown:typeof n=="number"})),Ll=e=>{switch(e){case"on_edge":return 1.1;case"panicked":return 1.2;case"breakdown":return 1.3;default:return 1}},Nl=4500,Ol=e=>{switch(e){case xe.SUSPICIOUS:return 1;case xe.INVESTIGATING:return 2;case xe.ALARMED:return 3;default:return 0}},zl={silent:{radius:2,gain:0},normal:{radius:4,gain:4},sprint:{radius:6,gain:8}},Fl=e=>e.reduce((t,n)=>{const r=Array.isArray(n.tags)?n.tags:[],a=n.stackable?n.quantity??1:1;return r.includes("paranoia:calmtabs")&&(t.calmTabs+=a),r.includes("paranoia:cigarettes")&&(t.cigarettes+=a),t},{calmTabs:0,cigarettes:0}),ls=e=>e.stackable?Math.max(1,e.quantity??1):1,cs=(e,t)=>e.type!=="collect"||e.isCompleted?!1:e.targetResourceKey&&t.resourceKey?e.targetResourceKey===t.resourceKey:e.target===t.name,Bl=(e,t)=>t.reduce((n,r)=>cs(e,r)?n+ls(r):n,0),Wt=1.5,Hl=(e,t,n)=>{var f;if(!e||!t||!Array.isArray(e.buildings)||e.buildings.length===0)return{available:!1,note:"No workbench nearby"};const{x:r,y:a}=t.position,o=e.buildings.find(u=>{if(!u.workbench)return!1;const{from:h,to:v}=u.footprint;return r>=h.x-Wt&&r<=v.x+Wt&&a>=h.y-Wt&&a<=v.y+Wt});if(!o||!o.workbench)return{available:!1,note:"No workbench nearby"};let l=!1;if(n){const u=Hn(((f=t.factionReputation)==null?void 0:f.scavengers)??0);l=u.id==="friendly"||u.id==="allied"}const i=o.workbench.type==="market"&&(!n||!l)?o.workbench.feeRequired??50:void 0,d=i?t.credits>=i:!0,m=i&&!d?n?`Requires ${i} credits or Friendly scavenger standing`:`Requires ${i} credits`:i?n?"Fee applies if scavenger standing is below Friendly":"Market workbench fee applies":void 0;return{available:d,locationName:o.name,type:o.workbench.type,feeRequired:i,note:m}},Wl=()=>{var sr;const e=c.useMemo(()=>Na("GameController"),[]),t=je(),n=Ms(),r=E(p=>p.player.data),a=r.encumbrance.level,o=r.encumbrance.warning,l=r.encumbrance.percentage,i=E(p=>p.world.currentMapArea),d=i==null?void 0:i.entities.items,m=i==null?void 0:i.id,f=(i==null?void 0:i.isInterior)??!1,u=E(p=>p.world.inCombat),h=E(p=>p.world.isPlayerTurn),v=E(p=>p.world.timeOfDay),x=E(p=>p.world.curfewActive),b=E(p=>p.world.currentMapArea.entities.enemies),A=E(p=>p.world.mapAreas),C=E(p=>p.world.mapConnections),y=E(p=>p.world),O=E(p=>p.quests.quests),_=E(p=>p.quests.dialogues),L=c.useMemo(()=>O.map(p=>`${p.id}:${p.isActive?1:0}:${p.isCompleted?1:0}`).join("|"),[O]),B=E(Vn),Q=E(p=>p.settings.locale),se=E(p=>p.settings.autoBattleEnabled),me=E(p=>p.settings.autoBattleProfile),G=E(os),g=G.cooldownExpiresAt,w=G.eligible,S=typeof g=="number",j=E(p=>p.world.engagementMode),P=E(p=>p.settings.autoStealthEnabled),I=E(p=>!!p.settings.reputationSystemsEnabled),Y=E(p=>p.world.turnCount),te=E(p=>p.world.globalAlertLevel),de=E(p=>p.world.reinforcementsScheduled),he=E(p=>m?p.surveillance.zones[m]:void 0),q=E(p=>p.surveillance.hud.overlayEnabled),Z=E(Za),ce=E(p=>p.world.environment.flags),ue=E(p=>p.world.currentTime),le=E(ll),R=c.useMemo(()=>ns((i==null?void 0:i.zoneId)??null),[i==null?void 0:i.zoneId]),re=E(p=>R(p)),N=c.useMemo(()=>Qe(Q).logs,[Q]),ze=c.useMemo(()=>Pe(Q),[Q]),_e=c.useMemo(()=>ze.autoBattle,[ze]),Fe=c.useMemo(()=>Math.max(220,Math.round(320*Z.behavior.routineIntervalMultiplier)),[Z.behavior.routineIntervalMultiplier]),it=c.useMemo(()=>Math.max(750,Math.round(Ks()*Z.faction.reinforcementDelayMultiplier)),[Z.faction.reinforcementDelayMultiplier]),ot=c.useRef(u),lt=c.useRef(v),wt=c.useRef(te),Ze=c.useRef(void 0),Ve=c.useRef(r),vt=c.useRef(i??null),St=c.useRef(de),ct=c.useRef(ro()),Ne=c.useRef(null),jt=c.useRef(te),M=c.useRef(v),H=c.useRef(B),ie=c.useRef(q),ae=c.useRef(ue),pe=c.useRef(null),oe=c.useRef(null),we=c.useRef(new Map),Se=c.useRef(O),Je=c.useRef(null),Be=c.useRef(Nr()),Qn=c.useRef(le),Zn=c.useRef(re),Jn=c.useRef({calmTabs:0,cigarettes:0}),vs=((sr=y.workbenchStatus)==null?void 0:sr.available)!==void 0?{...y.workbenchStatus}:{available:y.workbenchAvailable??!1,note:y.workbenchAvailable?void 0:"No workbench nearby"},er=c.useRef(vs),[Ae,dt]=c.useState(0),Lt=c.useRef(null),Nt=c.useRef(null),He=c.useRef(null),[Ot,qe]=c.useState("clear"),[Te,ve]=c.useState([]),ut=c.useRef(new Set),It=c.useRef([]),et=c.useRef(new Map),zt=c.useRef(null),[nn,Ie]=c.useState(null),[rn,ke]=c.useState(null),Ft=c.useCallback(p=>{var T;if(!p.isInteractive||!p.dialogueId)return t(F(N.npcNotReady(p.name))),!1;if(B===p.dialogueId)return!0;const k=_.find(z=>z.id===p.dialogueId);if(!k||k.nodes.length===0)return t(F(N.npcNoNewInfo(p.name))),!1;const D=(T=k.nodes[0])==null?void 0:T.id;return D?(t(fr({dialogueId:k.id,nodeId:D})),t(F(N.npcChannelOpened(p.name))),!0):(t(F(N.npcChannelEmpty(p.name))),!1)},[t,_,B,N]),ft=c.useCallback((p={})=>{const{sprint:k=!1}=p;if(u)return!0;if(k&&r.isExhausted)return t(F(N.tooTiredToSprint)),!1;let T=l>=80?mr.strenuousInteraction:0;return k&&(T+=mr.sprintTile),T<=0?(r.stamina<r.maxStamina&&t(Xs(void 0)),!0):r.stamina<T?(t(F(N.notEnoughStamina(T,r.stamina))),!1):(t(Qs(T)),!0)},[l,t,u,N,r.isExhausted,r.stamina,r.maxStamina]),Re=c.useCallback((p=!0)=>{p&&Lt.current!==null&&window.clearTimeout(Lt.current),Lt.current=null,Nt.current=null},[]),mt=c.useRef(null),pt=()=>typeof performance<"u"?performance.now():Date.now(),tr=c.useCallback(()=>{var p;t(ln({enabled:!0,cooldownExpiresAt:null})),((p=Ve.current)==null?void 0:p.movementProfile)!=="silent"&&t(pr("silent"))},[t]),gt=c.useCallback(p=>{var D;const k=typeof performance<"u"?performance.now():Date.now();t(ln({enabled:!1,cooldownExpiresAt:p?k+Nl:null})),((D=Ve.current)==null?void 0:D.movementProfile)==="silent"&&t(pr("normal"))},[t]);c.useEffect(()=>{Ze.current=he},[he]),c.useEffect(()=>{Qn.current=le},[le]),c.useEffect(()=>{Zn.current=re},[re]),c.useEffect(()=>{Ve.current=r},[r]),c.useEffect(()=>{H.current=B},[B]),c.useEffect(()=>{Se.current=O},[O]),c.useEffect(()=>{vt.current=i??null},[i]),c.useEffect(()=>{if(!d||d.length===0)return;const p=d.filter(D=>{var T,z;return((T=D.position)==null?void 0:T.x)===r.position.x&&((z=D.position)==null?void 0:z.y)===r.position.y});if(p.length===0)return;const k=Se.current.filter(D=>D.isActive&&!D.isCompleted);p.forEach(D=>{var $,ne;const T=ls(D),z=Zs(D);t(Oa(D)),t(Js({id:D.id,position:D.position,name:D.name})),window.dispatchEvent(new CustomEvent(ei,{detail:{areaId:i.id,itemId:D.id,position:D.position}})),t(kt({id:$e(),value:T,gridX:(($=D.position)==null?void 0:$.x)??r.position.x,gridY:((ne=D.position)==null?void 0:ne.y)??r.position.y,type:"pickup",label:z})),t(F(N.itemPickedUp(z,T))),k.forEach(W=>{W.objectives.forEach(V=>{cs(V,D)&&t(gr({questId:W.id,objectiveId:V.id,count:T}))})})})},[t,d,r.position,N,i==null?void 0:i.id]),c.useEffect(()=>{const p=Se.current.filter(D=>D.isActive&&!D.isCompleted);if(p.length===0)return;const k=r.inventory.items??[];k.length!==0&&p.forEach(D=>{D.objectives.forEach(T=>{if(T.type!=="collect"||T.isCompleted)return;const z=Bl(T,k);if(z<=0)return;const $=T.count??1,ne=T.currentCount??0,V=Math.min(z,$)-ne;V<=0||t(gr({questId:D.id,objectiveId:T.id,count:V}))})})},[t,r.inventory.items,L]),c.useEffect(()=>{const p=Ze.current??he,k=Ve.current,T=b.reduce((V,fe)=>{const U=Ol(fe.alertLevel);return U>V?U:V},0)>=2,$=(p?Object.values(p.cameras):[]).some(V=>V.alertState===ee.ALARMED),ne=pt();!(k!=null&&k.stealthModeEnabled)&&(k!=null&&k.stealthCooldownExpiresAt)&&k.stealthCooldownExpiresAt<=ne&&t(ln({enabled:!1,cooldownExpiresAt:null}));let W="none";u?(W="combat",k!=null&&k.stealthModeEnabled&&(gt(!0),t(F(N.stealthCompromised)))):H.current?(W="dialog",k!=null&&k.stealthModeEnabled&&gt(!1)):k!=null&&k.stealthModeEnabled&&(T||$?(gt(!0),t(F(N.stealthCompromised))):W="stealth"),j!==W&&t(cn(W))},[B,gt,t,j,b,u,N,he]),c.useEffect(()=>{Be.current=Nr()},[m]),c.useEffect(()=>{if(!i){we.current=new Map(b.map(D=>[D.id,D]));return}const p=new Map(b.map(D=>[D.id,D]));if(!I){we.current=p;return}we.current.forEach((D,T)=>{const z=p.get(T);(!z||z.health<=0)&&t(ti({witnessId:T,zoneId:i.zoneId}))}),we.current=p},[b,i,t,I]),c.useEffect(()=>{St.current=de},[de]),c.useEffect(()=>{!de&&Ne.current!==null&&(ct.current.cancel(Ne.current),Ne.current=null)},[de]),c.useEffect(()=>{const p=Fl(r.inventory.items??[]),k=Jn.current;Jn.current=p;const D=pt();p.calmTabs<k.calmTabs&&t(hr({amount:ge.calmTabs.relief,timestamp:D,cooldownKey:"calmTabs",cooldownMs:ge.calmTabs.cooldownMs})),p.cigarettes<k.cigarettes&&(t(hr({amount:ge.cigarettes.relief,timestamp:D})),t(ni({amountPerSecond:ge.cigarettes.decayBoostPerSecond,durationMs:ge.cigarettes.durationMs,timestamp:D})))},[r.inventory.items,t]),c.useEffect(()=>{jt.current=te},[te]),c.useEffect(()=>{M.current=v},[v]),c.useEffect(()=>{ie.current=q},[q]),c.useEffect(()=>{ae.current=ue},[ue]),c.useEffect(()=>{Je.current||(Je.current=new ri(t,n))},[t,n]),c.useEffect(()=>{Je.current&&Je.current.update({enabled:se,profileId:me,player:r,enemies:b,mapArea:i??null,inCombat:u,isPlayerTurn:h,turnCount:Y,activeDialogueId:B,logStrings:N,autoBattleStrings:_e})},[se,me,r,b,i,u,h,Y,B,N,_e]),c.useEffect(()=>{mt.current&&mt.current.focus();const p=k=>{if(!mt.current)return;const D=k.target;D&&(mt.current.contains(D)||D.closest('[data-controller-focus-ignore="true"]'))||mt.current.focus()};return document.addEventListener("click",p),()=>{document.removeEventListener("click",p)}},[]),c.useEffect(()=>{const p=vt.current;if(!p||!m)return;oe.current!==null&&(window.clearTimeout(oe.current),oe.current=null);const k=pe.current;k&&k!==m&&Tr({areaId:k,dispatch:t});const D=Ze.current;return(!D||D.areaId!==m)&&Mo({area:p,timeOfDay:M.current,dispatch:t,timestamp:pt()}),pe.current=m,()=>{const T=pe.current;T&&(oe.current=window.setTimeout(()=>{Tr({areaId:T,dispatch:t}),pe.current=null,oe.current=null},0))}},[m,t]),c.useEffect(()=>{if(!i||!m)return;const p=Ze.current??he;p&&Co({zone:p,area:i,timeOfDay:v,dispatch:t,timestamp:pt()})},[v,m,he,i,t]),c.useEffect(()=>{const p=k=>{if(!k.defaultPrevented){if(k.key==="Tab"){if(k.preventDefault(),k.repeat)return;t(bi({enabled:!ie.current}));return}if(k.key.toLowerCase()==="x"){if(k.repeat)return;k.preventDefault();const D=Ve.current;if(!D)return;if(D.stealthModeEnabled){gt(!1),t(cn("none")),t(F(N.stealthDisengaged));return}if(!w){if(u){t(F(N.stealthUnavailableCombat));return}if(H.current){t(F(N.stealthUnavailableDialogue));return}if(S&&typeof g=="number"){const T=typeof performance<"u"?performance.now():Date.now(),z=Math.max(0,g-T);if(z>0){const $=Math.ceil(z/1e3);t(F(N.stealthCooldown($)))}}return}tr(),t(cn("stealth")),t(F(N.stealthEngaged))}}};return window.addEventListener("keydown",p),()=>{window.removeEventListener("keydown",p)}},[t,gt,tr,u,N,w,S,g]),c.useEffect(()=>{if(!m||typeof window>"u")return;Uo();let p=null,k=pt();const D=()=>{const T=Ze.current,z=vt.current,$=Ve.current,ne=pt(),W=ne-k;k=ne;const fe=n.getState().world;if(z&&$){const U=I?Zn.current:null,X=hl({player:$,enemies:z.entities.enemies,mapArea:z,surveillanceZone:T,zoneHeat:U,environmentImpacts:Z,timeOfDay:fe.timeOfDay,curfewActive:fe.curfewActive,worldTimeSeconds:fe.currentTime,deltaMs:W,timestamp:ne},Be.current),J=Object.values(X.gains).reduce((Ye,De)=>Ye+De,0),be=Object.values(X.losses).reduce((Ye,De)=>Ye+De,0),We=Object.values(X.spikes).reduce((Ye,De)=>Ye+De,0),on=J*X.multipliers.gain-be+We;(on!==0||J>0||be>0||We!==0)&&t(yi({timestamp:ne,delta:on,deltaMs:W,breakdown:{gains:X.gains,losses:X.losses,spikes:X.spikes}})),t(xi({deltaMs:W,timestamp:ne,decayMultiplier:X.multipliers.decay}))}if(T&&z&&$){const U=I?X=>{t(vr(X)),e.debug(`Suspicion: camera ${X.witnessId} reported player in ${X.zoneId} (${X.recognitionChannel})`)}:void 0;To({zone:T,mapArea:z,player:$,deltaMs:W,timestamp:ne,dispatch:t,logStrings:N,reinforcementsScheduled:St.current??!1,globalAlertLevel:jt.current??xe.IDLE,timeOfDay:fe.timeOfDay,environmentFlags:fe.environment.flags,worldTimeSeconds:fe.currentTime,onWitnessObservation:U})}if(!u&&j==="stealth"&&P&&z&&$){const U=to();U&&t(F(`[Auto-Stealth]: ${U.summary}`))}if(z&&$){const U=Hl(z,$,I),X=er.current;(X.available!==U.available||X.type!==U.type||X.locationName!==U.locationName||X.feeRequired!==U.feeRequired||X.note!==U.note)&&(er.current=U,t(wi(U)))}Ao(t,n.getState),p=window.requestAnimationFrame(D)};return p=window.requestAnimationFrame(D),()=>{p!==null&&window.cancelAnimationFrame(p)}},[m,t,N,n,e,Z,P,j,u,I]),c.useEffect(()=>{const p=k=>{const T=k.detail;if(!T||!i||T.areaId!==i.id||u)return;const z=T.position;if(Ie(null),ke(null),z.x===r.position.x&&z.y===r.position.y){ve([]),ke(null);return}const $=i.entities.npcs.find(V=>V.position.x===z.x&&V.position.y===z.y);if($){if(u){t(F(N.combatChatterOverrides));return}if(Math.abs($.position.x-r.position.x)+Math.abs($.position.y-r.position.y)<=1){Ft($);return}const fe=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}];let U=null;for(const X of fe){const J={x:$.position.x+X.x,y:$.position.y+X.y};if(J.x===r.position.x&&J.y===r.position.y||J.x<0||J.y<0||J.x>=i.width||J.y>=i.height||!Ht(J,i,r,b,{npcs:i.entities.npcs}))continue;const be=Et(r.position,J,i,{player:r,enemies:b,npcs:i.entities.npcs});if(be.length>0){U=be;break}}U?(Ie($.id),ve(U)):t(F(N.npcBoxedIn($.name)));return}const ne=i.entities.enemies.find(V=>V.position.x===z.x&&V.position.y===z.y&&V.health>0);if(ne){if(Math.abs(ne.position.x-r.position.x)+Math.abs(ne.position.y-r.position.y)<=1){u||(t(Ct()),t(F(N.enteredCombat)));return}const fe=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}];let U=null;for(const X of fe){const J={x:ne.position.x+X.x,y:ne.position.y+X.y};if(J.x===r.position.x&&J.y===r.position.y||J.x<0||J.y<0||J.x>=i.width||J.y>=i.height||!Ht(J,i,r,b,{npcs:i.entities.npcs}))continue;const be=Et(r.position,J,i,{player:r,enemies:b,npcs:i.entities.npcs});if(be.length>0){U=be;break}}U?(ke(ne.id),ve(U)):t(F(N.enemyOutOfRange));return}const W=Et(r.position,z,i,{player:r,enemies:b,npcs:i.entities.npcs});if(W.length===0){window.dispatchEvent(new CustomEvent(dn,{detail:{areaId:i.id,path:[]}})),ke(null);return}ve(W)};return window.addEventListener(br,p),()=>{window.removeEventListener(br,p)}},[i,r,b,u,t,Ft,C,N]),c.useEffect(()=>{i&&window.dispatchEvent(new CustomEvent(dn,{detail:{areaId:i.id,path:Te}}))},[Te,i]),c.useEffect(()=>{if(!i)return;const p=k=>{const D=k.detail;if(!D||D.areaId!==i.id)return;const T=Et(r.position,D.target,i,{player:r,enemies:b,npcs:i.entities.npcs});ve(T),window.dispatchEvent(new CustomEvent(dn,{detail:{areaId:i.id,path:T}}))};return window.addEventListener(yr,p),()=>{window.removeEventListener(yr,p)}},[i,r,b]),c.useEffect(()=>{ve(p=>p.length>0?[]:p),Ie(null),ke(null)},[i==null?void 0:i.id]),c.useEffect(()=>{f&&qe("clear")},[m,f]),c.useEffect(()=>{const p=ut.current,k=It.current,D=et.current;p.clear(),k.forEach(T=>{window.clearTimeout(T)}),k.length=0,D.clear()},[i==null?void 0:i.id]);const nr=c.useCallback((p,k)=>{if(k.length===0){et.current.delete(p.id);return}if(ut.current.has(p.id))return;const D=k[k.length-1];et.current.set(p.id,D),ut.current.add(p.id);const T=Fe;let z=0,$=p;const ne=()=>{if(z>=k.length){ut.current.delete(p.id),et.current.delete(p.id);return}const W=k[z];if(z+=1,$={...$,position:W},t(vi($)),z<k.length){const V=window.setTimeout(()=>{const fe=It.current.indexOf(V);fe>-1&&It.current.splice(fe,1),ne()},T);It.current.push(V)}else ut.current.delete(p.id),et.current.delete(p.id)};ne()},[t,Fe]);c.useEffect(()=>{i&&i.entities.npcs.forEach(p=>{const k=p.routine.find($=>$.timeOfDay===v);if(!k||p.position.x===k.position.x&&p.position.y===k.position.y)return;const D=i.entities.npcs.filter($=>$.id!==p.id).map($=>$.position),T=Array.from(et.current.entries()).filter(([$])=>$!==p.id).map(([,$])=>$),z=Et(p.position,k.position,i,{player:r,enemies:b,blockedPositions:[...D,...T]});z.length>0&&nr(p,z)})},[i,v,r,b,nr]),c.useEffect(()=>{const p=It.current,k=ut.current,D=et.current;return()=>{p.forEach(T=>{window.clearTimeout(T)}),p.length=0,k.clear(),D.clear()}},[]),c.useEffect(()=>{var ne;if(Te.length===0)return;if(u){ve([]),Ie(null);return}if(r.encumbrance.level==="immobile"){r.encumbrance.warning&&t(F(r.encumbrance.warning)),ve([]),Ie(null),ke(null);return}const p=Te[0],k=r.position.x,D=r.position.y;if(k===p.x&&D===p.y){ve(W=>W.slice(1));return}if(!Ht(p,i,r,b,{npcs:i.entities.npcs})){ve([]),Ie(null),ke(null);return}const T=i.tiles[p.y][p.x],z=C.find(W=>W.fromAreaId===i.id&&W.fromPosition.x===p.x&&W.fromPosition.y===p.y);if(z){const W=A[z.toAreaId];if(x&&T.type===xr.DOOR&&W&&!W.isInterior){t(F(N.checkpointSealed)),ve([]),Ie(null),ke(null);return}if(W){if(I&&W.factionRequirement){const V=W.factionRequirement,fe=ze.playerStatus.factions[V.factionId]??V.factionId,U=((ne=r.factionReputation)==null?void 0:ne[V.factionId])??0,X=Hn(U);let J=!0;if(V.minimumStanding){const be=bt(X.id),We=bt(V.minimumStanding);be<We&&(J=!1)}if(J&&typeof V.minimumReputation=="number"&&U<V.minimumReputation&&(J=!1),!J){const be=[];V.minimumStanding&&be.push(Yt(Q,V.minimumStanding)),typeof V.minimumReputation=="number"&&be.push(`${ze.factionPanel.reputationLabel} ${V.minimumReputation}+`);const We=be.join(" • ")||Yt(Q,X.id);t(F(N.factionAccessDenied(fe,We))),ve([]),Ie(null),ke(null);return}}if(!ft()){ve([]),Ie(null),ke(null);return}t(wr(W)),t(Mt(z.toPosition)),W.isInterior&&(t(Vt({type:"campfireRest",locationId:W.id})),t(F(N.slipInsideStructure)),qe("clear"))}else e.warn(`Missing target area in state for ${z.toAreaId}`);ve([]),Ie(null),ke(null);return}if(!ft()){ve([]),Ie(null),ke(null);return}const $=r.movementProfile==="silent"?140:0;if($>0){if(He.current!==null)return;He.current=window.setTimeout(()=>{He.current=null,t(Mt(p))},$);return}t(Mt(p))},[Te,r,i,b,u,x,t,A,C,e,N,ft,Q,ze,I]),c.useEffect(()=>{Te.length===0&&He.current!==null&&(window.clearTimeout(He.current),He.current=null)},[Te.length]),c.useEffect(()=>()=>{He.current!==null&&(window.clearTimeout(He.current),He.current=null)},[]),c.useEffect(()=>{const p=o??null;if(p&&p!==zt.current&&t(F(p)),!p&&zt.current&&a==="normal"){zt.current=null;return}zt.current=p},[a,o,t]),c.useEffect(()=>{if(!nn||!i)return;const p=i.entities.npcs.find(D=>D.id===nn);if(!p){Ie(null);return}if(Math.abs(p.position.x-r.position.x)+Math.abs(p.position.y-r.position.y)<=1){if(u)Ie(null);else{const D=Ft(p);Ie(null),D&&ve([])}return}Te.length===0&&(t(F(N.npcOutOfReach(p.name))),Ie(null))},[nn,i,r,u,Te.length,t,C,Ft,N]),c.useEffect(()=>{if(!rn||!i)return;const p=i.entities.enemies.find(D=>D.id===rn);if(!p||p.health<=0){ke(null);return}if(Math.abs(p.position.x-r.position.x)+Math.abs(p.position.y-r.position.y)<=1){ke(null),ve([]),u||(t(Ct()),t(F(N.enteredCombat)));return}Te.length===0&&ke(null)},[rn,i,r,u,Te.length,t,N,b]),c.useEffect(()=>{lt.current!==v&&(v==="night"?(t(F(N.nightFalls)),qe("clear")):lt.current==="night"&&(t(F(N.dawnBreaks)),qe("clear")),lt.current=v)},[v,t,N]),c.useEffect(()=>{I&&t(ai(!!B))},[B,t,I]),c.useEffect(()=>{var fe;if(!r||b.length===0||!i)return;const p=Ll(Qn.current),k=r.movementProfile==="silent"?.6:r.movementProfile==="sprint"?1.6:1,D=((fe=r.skillTraining)==null?void 0:fe.stealth)??0,T=Math.max(.7,1-Math.min(.3,D/333)),z=(M.current??v)==="night"?.85:1,$=p*k*T*z,{updatedEnemies:ne,maxAlertLevel:W,guardPerception:V}=si(b,r,i,$);if(r.movementProfile!=="silent"){const U=zl[r.movementProfile];ne.forEach((X,J)=>{const be=V[J];if(!X||be!=null&&be.playerVisible)return;const We=X.position.x-r.position.x,sn=X.position.y-r.position.y;if(Math.sqrt(We*We+sn*sn)>U.radius||U.gain<=0)return;const Ye=X.alertProgress??0,De=Math.min(100,Ye+U.gain);if(De<=Ye)return;let Bt=X.alertLevel??xe.IDLE;De>=un.alarmThreshold?Bt=xe.ALARMED:De>=un.investigationThreshold?Bt=xe.INVESTIGATING:De>=un.suspicionThreshold&&(Bt=xe.SUSPICIOUS),ne[J]={...X,alertProgress:De,alertLevel:Bt}})}if(ne.forEach((U,X)=>{const J=b[X];J&&(U.alertLevel!==J.alertLevel||U.alertProgress!==J.alertProgress)&&t(fn(U))}),I&&V.forEach(({enemy:U,playerVisible:X})=>{if(!X)return;const J=go({enemy:U,player:r,mapArea:i,timeOfDay:v,environmentFlags:ce,playerVisible:X,timestamp:ue});J&&(t(vr(J)),e.debug(`Suspicion: guard ${U.id} observed player in ${i.zoneId} (certainty ${(J.baseCertainty*J.distanceModifier).toFixed(2)})`))}),W!==wt.current){const U=ii(wt.current,W);U&&t(F(N[U])),t(Gt(W)),wt.current=W,oi(W,de)&&(t(La()),t(F(N.reinforcementsIncoming)),Ne.current!==null&&ct.current.cancel(Ne.current),Ne.current=ct.current.schedule(()=>{Ne.current=null,u||t(Ct());const X=u&&!h,J={id:$e(),name:N.curfewPatrolName,position:{x:r.position.x+5,y:r.position.y+2},facing:"west",coverOrientation:null,suppression:0,health:45,maxHealth:45,actionPoints:X?0:4,maxActionPoints:4,damage:7,attackRange:2,isHostile:!0,visionCone:{range:10,angle:90,direction:180},alertLevel:xe.ALARMED,alertProgress:100};t(Sr(J)),t(ht()),X&&!h&&(t(tt()),t(ht())),Re(),dt(0),t(li())},it))}},[r,b,i,t,N,u,h,de,Re,it,v,ce,ue,e,I]),c.useEffect(()=>{if(e.debug(`=== useEffect RUNNING === Turn: ${h?"Player":"Enemy"}, Combat: ${u}, Processing: ${Nt.current?"true":"false"}, EnemyIdx: ${Ae}`),!u||h||b.length===0){Re(),(!u||h)&&Ae!==0&&dt(0);return}if(b.filter(T=>T.health>0).length===0){Re(),e.warn("Enemy turn effect running but no living enemies found.");return}if(Ae>=b.length){e.debug(`Enemy index ${Ae} out of bounds (length: ${b.length}). Ending enemy turn.`),Re(),t(tt()),t(ht()),dt(0);return}const k=b[Ae];if(!k||k.health<=0||k.actionPoints<=0){e.debug(`Enemy ${(k==null?void 0:k.id)??`at index ${Ae}`} cannot act (Dead or 0 AP). Checking next.`),Re();let T=Ae+1,z=!1;for(;T<b.length;){const $=b[T];if($&&$.health>0&&$.actionPoints>0){z=!0;break}T+=1}z?(e.debug(`Moving to next valid enemy at index ${T}`),dt(T)):(e.debug("All enemies processed, switching back to player."),t(tt()),t(ht()),dt(0));return}if(Nt.current)return;e.debug(`Scheduling action for enemy index ${Ae}: ${k.id} (AP: ${k.actionPoints})`),Nt.current=k.id;let D=null;Lt.current=window.setTimeout(()=>{if(e.debug(`>>> setTimeout CALLBACK for index ${Ae}`),!u){e.debug("Combat ended, skipping enemy action"),Re(!1);return}try{e.debug(`Enemy Turn AI: START for ${k.id}`);const T=[];for(let $=0;$<i.height;$+=1)for(let ne=0;ne<i.width;ne+=1)i.tiles[$][ne].provideCover&&T.push({x:ne,y:$});e.debug(`Enemy Turn AI: Got cover positions for ${k.id}`);const z=ci(k,r,i,b,T,i.entities.npcs,ae.current);if(D=z,e.debug(`Enemy ${k.id} action: ${z.action}, AP left: ${z.enemy.actionPoints}`),z.action==="attack"||z.action==="attack_missed"){const $=r.health-z.player.health;$>0?(t(kt({id:$e(),value:$,gridX:r.position.x,gridY:r.position.y,type:z.isCritical?"crit":"damage"})),t(di({id:$e(),type:z.isCritical?"crit":"damage",intensity:.6,duration:300}))):z.action==="attack_missed"&&t(kt({id:$e(),value:0,gridX:r.position.x,gridY:r.position.y,type:"miss"}))}e.debug(`Enemy Turn AI: BEFORE dispatching updates for ${k.id}`),t(fn(z.enemy)),e.debug(`Enemy Turn AI: AFTER dispatch(updateEnemy) for ${k.id}`),z.player.id===r.id&&(e.debug(`Enemy Turn AI: BEFORE dispatch(setPlayerData) for ${k.id}`),t(Ir(z.player)),e.debug(`Enemy Turn AI: AFTER dispatch(setPlayerData) for ${k.id}`)),e.debug(`Enemy Turn AI: END AI & Dispatches for ${k.id}`)}catch(T){e.error("Error during enemy turn AI:",{enemyId:k==null?void 0:k.id,error:T})}finally{const T=(D==null?void 0:D.enemy)??k,z=T&&T.health>0&&T.actionPoints>0;e.debug(`Enemy Turn FINALLY for index ${Ae}. Remaining AP: ${(T==null?void 0:T.actionPoints)??k.actionPoints}. Repeat: ${z}`),Re(!1),z||dt($=>$+1)}},500)},[u,h,Ae,b,t,r,i,Re,e]),c.useEffect(()=>()=>{Re()},[Re]),c.useEffect(()=>{const p=ct.current;return()=>{p.dispose(),Ne.current=null}},[]),c.useEffect(()=>{u&&h&&t(ui())},[t,u,h]),c.useEffect(()=>{ot.current&&!u&&(t(F(N.combatOver)),e.debug("Combat ended (detected via useEffect watching inCombat)."),t(ht())),ot.current=u},[u,t,e,N]);const rr=c.useCallback((p,k)=>{var X,J;const D=((X=r.equipped.weapon)==null?void 0:X.apCost)??fi,T=Number.isFinite(r.encumbrance.attackApMultiplier)?Math.max(r.encumbrance.attackApMultiplier,0):Number.POSITIVE_INFINITY,z=mi(r)?0:Math.ceil(Math.max(0,D)*T);if(!Number.isFinite(z)||r.actionPoints<z){t(F(N.notEnoughAp));return}const $=((J=r.equipped.weapon)==null?void 0:J.range)??1;if(!mn(r.position,p.position,$)){t(F(N.enemyOutOfRange));return}const ne=k.tiles[p.position.y][p.position.x].provideCover;e.debug("attackEnemy: PRE-ATTACK",{enemyId:p.id,enemyPosition:p.position,isBehindCover:ne,playerAP_before:r.actionPoints,attackCost:z});const W=pi(r,p,ne),V=W.newAttacker;t(Ir(V)),W.events&&W.events.forEach(be=>t(F(be.message))),e.debug("attackEnemy: POST-ATTACK",{apCost:z,playerAP_after:V.actionPoints}),W.success?(t(F(N.hitEnemy(p.name,W.damage))),t(kt({id:$e(),value:W.damage,gridX:p.position.x,gridY:p.position.y,type:W.isCritical?"crit":"damage"}))):(t(F(N.missedEnemy(p.name))),t(kt({id:$e(),value:0,gridX:p.position.x,gridY:p.position.y,type:"miss"})));const fe=W.newTarget;e.debug("attackEnemy: PRE-DISPATCH updateEnemy",{enemyId:fe.id,healthBeforeUpdate:p.health,healthInNewTarget:fe.health}),t(fn(fe)),b.some(be=>be.id!==p.id||be.id===p.id&&W.newTarget.health>0)?V.actionPoints<=0&&(e.debug("attackEnemy: Player out of AP after attack, switching turn."),t(tt())):t(F(N.allEnemiesDefeated))},[r,b,t,e,N]),an=c.useCallback(p=>b.length===0?null:b.reduce((k,D)=>{const T=Math.abs(D.position.x-p.x)+Math.abs(D.position.y-p.y),z=Math.abs(k.position.x-p.x)+Math.abs(k.position.y-p.y);return T<z?D:k}),[b]),ar=c.useCallback(p=>{if(!i)return null;const k=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1},{x:1,y:1},{x:-1,y:-1},{x:-1,y:1},{x:1,y:-1}];for(const D of k){const T={x:p.x+D.x,y:p.y+D.y};if(T.x<0||T.y<0||T.x>=i.width||T.y>=i.height)continue;const z=i.tiles[T.y],$=z?z[T.x]:void 0;if(!$||!$.isWalkable)continue;if(!b.some(W=>W.position.x===T.x&&W.position.y===T.y))return T}return null},[i,b]),Ss=c.useCallback(p=>{var z,$,ne;const k=p.key,D=(i==null?void 0:i.isInterior)??!1;if(p.shiftKey&&(k==="A"||k==="a")){p.preventDefault(),p.stopPropagation(),t(Pn(!se));return}if(se&&u&&((z=Je.current)==null||z.notifyManualOverride("manual_input"),t(Pn(!1))),B){p.preventDefault(),p.stopPropagation(),k==="Escape"&&(t(Kt()),t(F(N.conversationEnded)));return}if(k==="e"||k==="E"){if(p.preventDefault(),p.stopPropagation(),!i)return;const W=i.entities.npcs.find(U=>!U.isInteractive||!U.dialogueId?!1:Math.abs(U.position.x-r.position.x)+Math.abs(U.position.y-r.position.y)<=1);if(!W){t(F(N.noFriendlyContact));return}const V=_.find(U=>U.id===W.dialogueId);if(!V||V.nodes.length===0){t(F(N.npcNoNewInfo(W.name)));return}const fe=V.nodes[0].id;t(fr({dialogueId:V.id,nodeId:fe})),t(F(N.npcChannelOpened(W.name)));return}if(k==="Tab"&&u&&h){p.preventDefault(),p.stopPropagation(),t(F(N.endingTurn??"Ending turn...")),t(tt());return}if(k===" "){if(p.preventDefault(),p.stopPropagation(),Te.length>0&&(ve([]),Ie(null),ke(null)),!u){const W=an(r.position),V=(($=r.equipped.weapon)==null?void 0:$.range)??1;if(W&&mn(r.position,W.position,V)){t(Ct()),t(F(N.enteredCombat));return}}if(u&&h){const W=an(r.position),V=((ne=r.equipped.weapon)==null?void 0:ne.range)??1;if(W&&mn(r.position,W.position,V)){rr(W,i);return}t(F(N.noEnemiesInRange));return}return}if(u&&(!h||r.actionPoints<=0)){if(b.filter(V=>V.health>0).length===0){t(gi()),t(ht()),t(F(N.zoneSecured));return}if(!h){t(F(N.notYourTurn));return}if(r.actionPoints<=0){t(F(N.actionPointsDepleted)),t(tt());return}}Te.length>0&&(ve([]),Ie(null),ke(null));const T={...r.position};switch(k){case"ArrowUp":case"w":case"W":T.y-=1;break;case"ArrowDown":case"s":case"S":T.y+=1;break;case"ArrowLeft":case"a":case"A":T.x-=1;break;case"ArrowRight":case"d":case"D":T.x+=1;break;default:return}if(p.preventDefault(),p.stopPropagation(),Ht(T,i,r,b,{npcs:i.entities.npcs})){const W=i.tiles[T.y][T.x],V=C.find(U=>U.fromAreaId===i.id&&U.fromPosition.x===T.x&&U.fromPosition.y===T.y),fe=!u&&p.shiftKey;if(V){const U=A[V.toAreaId];if(x&&W.type===xr.DOOR&&U&&!U.isInterior){t(F(N.checkpointSealed));return}if(U){if(!ft({sprint:fe}))return;t(wr(U)),t(Mt(V.toPosition)),U.isInterior&&(t(Vt({type:"campfireRest",locationId:U.id})),t(F(N.slipInsideStructure)),qe("clear"))}else e.warn(`Missing target area in state for ${V.toAreaId}`);ve([]),Ie(null);return}if(!ft({sprint:fe}))return;if(t(Mt(T)),x&&!D){if(Ot==="clear")t(F(N.searchlightsWarning)),qe("warning");else if(Ot==="warning"){const U=ar(T);if(U){const X={id:$e(),name:N.curfewPatrolName,position:U,maxHealth:30,health:30,actionPoints:6,maxActionPoints:6,damage:6,attackRange:1,isHostile:!0};t(Sr(X)),t(Vt({type:"patrolAmbush",locationId:i==null?void 0:i.id,tags:["corpsec"]})),u?t(F(N.curfewReinforcement)):(t(Ct()),t(F(N.curfewOpenFire)))}else t(F(N.curfewFootsteps));qe("spawned")}}else Ot!=="clear"&&qe("clear");u&&(e.debug("handleKeyDown: PRE-MOVE AP DEDUCTION",{apCost:1,playerAP_before:r.actionPoints}),t(hi(-1)),e.debug("handleKeyDown: POST-MOVE AP DEDUCTION",{apCost:1,playerAP_after:r.actionPoints-1}),r.actionPoints<=1&&(e.debug("handleKeyDown: Player out of AP after move, switching turn."),t(tt())))}},[r,i,u,h,t,b,rr,an,x,Ot,ar,A,Te,ve,Ie,B,C,_,e,N,ft,se]),Is=c.useCallback(p=>{p.key},[]);return s.jsx("div",{ref:mt,tabIndex:0,onKeyDown:Ss,onKeyUp:Is,className:"fixed inset-0 focus:outline-none",style:{zIndex:1},"data-testid":"game-controller",children:s.jsx(ss,{zoneId:(i==null?void 0:i.zoneId)??null})})},$l=(...e)=>e.filter(Boolean).join(" "),Ul=(e,t,n,r)=>r==="none"?"base":r==="ascending"?e>=n?"critical":e>=t?"warning":"base":e<=n?"critical":e<=t?"warning":"base",Br=({label:e,current:t,max:n,icon:r,variant:a="neutral",lowThreshold:o=50,criticalThreshold:l=25,disableGlow:i=!1,dangerDirection:d="descending"})=>{const m=c.useMemo(()=>{if(n<=0)return 0;const u=t/n*100;return Math.max(0,Math.min(100,u))},[t,n]),f=Ul(m,o,l,d);return s.jsxs("div",{className:"hud-stat","data-variant":a,"data-level":f,"data-glow":i?"off":"on",children:[s.jsxs("div",{className:$l("hud-stat__row",f!=="base"?"hud-stat__row--emphasis":null),children:[s.jsxs("div",{className:"flex items-center gap-[0.4rem]",children:[r?s.jsx("span",{className:"hud-stat__icon",children:r}):null,s.jsx("span",{children:e})]}),s.jsxs("span",{className:"hud-stat__value","aria-live":"polite",children:[t,"/",n]})]}),s.jsx("div",{className:"hud-stat__bar",children:s.jsx("div",{className:"hud-stat__fill",style:{width:`${m}%`}})})]})},Gl=(...e)=>e.filter(Boolean).join(" "),ds=c.forwardRef(({className:e,title:t,children:n,role:r,...a},o)=>s.jsxs("svg",{ref:o,viewBox:"0 0 24 24",className:Gl("h-4 w-4 shrink-0 text-current",e),role:t?r??"img":"presentation","aria-hidden":t?void 0:!0,...a,children:[t?s.jsx("title",{children:t}):null,n]}));ds.displayName="IconBase";const Vl=({className:e,...t})=>s.jsxs(ds,{className:e,...t,children:[s.jsx("path",{d:"M12 4.8 4 18.4c-.4.7.1 1.6.9 1.6h14.2c.8 0 1.3-.9.9-1.6L12 4.8z",fill:"currentColor",fillOpacity:.2}),s.jsx("path",{d:"M12 4.8 4 18.4c-.4.7.1 1.6.9 1.6h14.2c.8 0 1.3-.9.9-1.6L12 4.8z",stroke:"currentColor",strokeWidth:1.8,strokeLinejoin:"round",fill:"none"}),s.jsx("path",{d:"M12 9.8v3.8",stroke:"currentColor",strokeWidth:1.8,strokeLinecap:"round",fill:"none"}),s.jsx("circle",{cx:12,cy:16.6,r:1,fill:"currentColor"})]}),ql=({onOpenCharacter:e,characterOpen:t=!1,showActionButton:n=!0,className:r,variant:a="default"})=>{const o=je(),l=E(y=>y.player.data),i=E(rs),d=E(y=>y.settings.locale),m=E(y=>y.settings.testMode),f=Pe(d),u=l.backgroundId?Si[l.backgroundId]:void 0,h=(u==null?void 0:u.name)??f.playerStatus.backgroundFallback,v=Math.round(i),x=f.playerStatus.movementBadge[l.movementProfile]??l.movementProfile.toUpperCase(),b=()=>{const y=l.level,O=ki(y+1),_=l.experience,L=O-_;o(_n({amount:Math.max(1,L),reason:"Test mode XP boost"}))},A=a==="frameless"?"flex h-full min-h-0 flex-1 flex-col gap-[0.5rem] px-0 py-0 text-[#f8fafc] font-body":"flex flex-col gap-[0.5rem] rounded-[18px] border border-[rgba(59,130,246,0.22)] bg-[linear-gradient(145deg,rgba(8,15,30,0.92),rgba(12,22,42,0.82),rgba(6,12,28,0.92))] px-[0.9rem] py-[0.9rem] text-[#f8fafc] shadow-[0_20px_30px_-20px_rgba(8,12,24,0.5)] backdrop-blur-[14px] font-body",C=r?`${A} ${r}`:A;return s.jsxs("div",{className:C,"data-testid":"player-summary-panel",children:[s.jsx("div",{className:"flex items-start justify-between gap-[0.75rem]",children:s.jsxs("div",{className:"flex min-w-0 flex-1 flex-col gap-[0.2rem]",children:[s.jsxs("div",{className:"flex items-center gap-[0.5rem] text-[0.9rem] uppercase tracking-[0.26em] text-[#bfdbfe] drop-shadow-[0_0_8px_rgba(56,189,248,0.4)]",children:[s.jsx("span",{className:"truncate",children:l.name}),s.jsxs("span",{className:"inline-flex items-center gap-[0.25rem] rounded-[999px] border border-[rgba(56,189,248,0.45)] bg-[rgba(56,189,248,0.18)] px-[0.55rem] py-[0.22rem] text-[0.6rem] font-semibold tracking-[0.14em] text-[#f8fafc] shadow-[0_10px_20px_-10px_rgba(56,189,248,0.55)]",children:[f.playerStatus.levelLabel," ",l.level]}),l.movementProfile!=="normal"&&s.jsx("span",{className:"inline-flex items-center gap-[0.25rem] rounded-[999px] border border-[rgba(148,163,184,0.65)] bg-[rgba(148,163,184,0.12)] px-[0.55rem] py-[0.22rem] text-[0.55rem] font-semibold tracking-[0.14em] text-[#e2e8f0] shadow-[0_8px_18px_-12px_rgba(148,163,184,0.55)]",children:x})]}),s.jsx("div",{className:"text-[0.6rem] uppercase tracking-[0.12em] text-[rgba(226,232,240,0.72)]",children:h})]})}),s.jsx(Br,{label:f.playerStatus.healthLabel,current:l.health,max:l.maxHealth,variant:"health",lowThreshold:50,criticalThreshold:25}),s.jsx(Br,{label:f.playerStatus.paranoiaLabel,current:v,max:100,variant:"paranoia",lowThreshold:50,criticalThreshold:75,dangerDirection:"ascending"}),l.isExhausted&&s.jsxs("span",{className:"mt-[0.35rem] inline-flex items-center gap-[0.3rem] rounded-[999px] border border-[rgba(250,204,21,0.65)] bg-[rgba(250,204,21,0.08)] px-[0.55rem] py-[0.22rem] text-[0.55rem] font-semibold uppercase tracking-[0.14em] text-[#facc15] shadow-[0_8px_18px_-12px_rgba(250,204,21,0.6)]",title:f.playerStatus.fatigueHint,children:[s.jsx(Vl,{className:"text-[#facc15]","aria-hidden":!0}),s.jsx("span",{children:f.playerStatus.fatigueStatus})]}),s.jsxs("div",{className:"grid grid-cols-2 gap-[0.28rem]",children:[s.jsxs("div",{className:"flex min-w-0 flex-col gap-[0.12rem] rounded-[12px] border border-[rgba(248,250,252,0.08)] bg-[linear-gradient(160deg,rgba(14,26,52,0.88),rgba(10,18,34,0.88))] px-[0.5rem] py-[0.45rem] shadow-[0_16px_30px_-20px_rgba(13,148,136,0.6)]",children:[s.jsx("span",{className:"text-[0.5rem] uppercase tracking-[0.12em] text-[rgba(148,163,184,0.7)]",children:f.playerStatus.creditsLabel}),s.jsxs("span",{className:"text-[0.85rem] font-semibold text-[#fbbf24] drop-shadow-[0_0_12px_rgba(251,191,36,0.5)]",children:["₿",l.credits]})]}),s.jsxs("div",{className:"flex min-w-0 flex-col gap-[0.12rem] rounded-[12px] border border-[rgba(248,250,252,0.08)] bg-[linear-gradient(160deg,rgba(14,26,52,0.88),rgba(10,18,34,0.88))] px-[0.5rem] py-[0.45rem] shadow-[0_16px_30px_-20px_rgba(13,148,136,0.6)]",children:[s.jsx("span",{className:"text-[0.5rem] uppercase tracking-[0.12em] text-[rgba(148,163,184,0.7)]",children:f.playerStatus.experienceLabel}),s.jsx("span",{className:"text-[0.85rem] font-semibold text-[#38bdf8] drop-shadow-[0_0_12px_rgba(56,189,248,0.45)]",children:Ii(l.experience,l.level)})]})]}),e&&n&&s.jsxs("div",{className:"flex gap-[0.5rem]",children:[s.jsx("button",{type:"button",onClick:e,className:["flex-1 rounded-[999px] border px-[0.75rem] py-[0.42rem] text-[0.58rem] font-semibold uppercase tracking-[0.18em] text-[#e0f2fe] shadow-[0_12px_20px_-18px_rgba(56,189,248,0.45)] transition-transform duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-neon/60 focus-visible:ring-offset-2 focus-visible:ring-offset-gunmetal-900",t?"border-[rgba(251,191,36,0.9)] bg-[linear-gradient(130deg,rgba(251,191,36,0.6),rgba(249,115,22,0.55))] text-[#fff7e1]":"border-[rgba(56,189,248,0.55)] bg-[linear-gradient(130deg,rgba(56,189,248,0.48),rgba(14,165,233,0.45))]"].join(" "),"data-testid":"summary-open-character","aria-pressed":t,children:f.shell.characterButton}),m&&s.jsx("button",{type:"button",onClick:b,className:"flex-1 rounded-[999px] border border-[rgba(251,191,36,0.9)] bg-[linear-gradient(130deg,rgba(251,191,36,0.48),rgba(249,115,22,0.45))] px-[0.75rem] py-[0.38rem] text-[0.58rem] font-semibold uppercase tracking-[0.18em] text-[#fff8dc] shadow-[0_12px_20px_-16px_rgba(251,191,36,0.48)] transition-all duration-200 hover:-translate-y-[2px] hover:scale-[1.01] hover:border-[rgba(251,191,36,1)] hover:shadow-[0_0_0_2px_rgba(251,191,36,0.4),0_14px_24px_-16px_rgba(251,191,36,0.6)] focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-400 focus-visible:ring-offset-2 focus-visible:ring-offset-gunmetal-900",title:"Test Mode: Gain XP to level up",children:"⬆ Level Up"})]})]})},Yl=Rt.memo(ql),Kl=new Set(["morning","day"]),Xl=e=>{const t=Math.max(0,Math.round(e)),n=Math.floor(t/60),r=t%60;return`${n.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`},Ql=(e,t)=>{const n=Bn,{cycleDuration:r,morningStartTime:a,eveningStartTime:o}=n;if(r<=0)return{progress:1,secondsUntilChange:0};const i=(e%r+r)%r/r,d=t==="day"?a:o,m=t==="day"?o:a+1;let f=i;f<d&&(f+=1);const u=m-d,h=Math.max(u*r,0),v=Math.min(h,Math.max(0,(f-d)*r)),x=Math.max(0,h-v),b=h>0?v/h:1;return{progress:Math.min(1,Math.max(0,b)),secondsUntilChange:x}},Zl=()=>{const{currentTime:e,timeOfDay:t,curfewActive:n}=E(A=>A.world),r=E(A=>A.settings.locale),o=Pe(r).dayNight,l=Kl.has(t)?"day":"night",{progress:i,secondsUntilChange:d}=Ql(e,l),m=l==="day"?o.timeOfDay.day:o.timeOfDay.night,f=l==="day"?o.timeOfDay.night:o.timeOfDay.day,u=Math.min(100,Math.max(4,i*100)),h=Math.round(i*100),v=Xl(d),x=`${m} phase; ${h}% complete; ${f} in ${v}.`;return s.jsxs(s.Fragment,{children:[s.jsx("style",{children:`
    .day-night-wafer {
      --accent: rgba(56, 189, 248, 0.78);
      --accent-border: rgba(56, 189, 248, 0.42);
      --accent-shadow: rgba(37, 99, 235, 0.28);
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.55rem 0.85rem;
      min-width: 14.5rem;
      width: 14.5rem;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(14, 19, 31, 0.96), rgba(17, 24, 39, 0.84));
      border: 1px solid var(--accent-border);
      box-shadow: 0 18px 32px rgba(6, 11, 21, 0.55);
      color: #e2e8f0;
      font-family: 'DM Mono', 'IBM Plex Mono', monospace;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      overflow: hidden;
      pointer-events: none;
    }

    .day-night-wafer::before,
    .day-night-wafer::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 2px;
      background: rgba(56, 189, 248, 0.28);
      pointer-events: none;
    }

    .day-night-wafer::before {
      top: 9px;
      left: 12px;
      transform: rotate(-14deg);
      box-shadow: 0 0 8px var(--accent-border);
    }

    .day-night-wafer::after {
      bottom: 10px;
      right: 14px;
      transform: rotate(18deg);
      box-shadow: 0 0 8px rgba(148, 163, 184, 0.24);
    }

    .day-night-wafer[data-phase="day"] {
      --accent: rgba(251, 191, 36, 0.82);
      --accent-border: rgba(251, 191, 36, 0.42);
      --accent-shadow: rgba(245, 158, 11, 0.3);
    }

    .day-night-wafer[data-phase="night"] {
      --accent: rgba(94, 234, 212, 0.8);
      --accent-border: rgba(94, 234, 212, 0.45);
      --accent-shadow: rgba(45, 212, 191, 0.32);
    }

    .day-night-wafer[data-curfew="true"] {
      --accent: rgba(248, 113, 113, 0.78);
      --accent-border: rgba(248, 113, 113, 0.5);
      --accent-shadow: rgba(185, 28, 28, 0.38);
      box-shadow: 0 0 24px rgba(127, 29, 29, 0.38);
    }

    .day-night-wafer__scanline {
      position: absolute;
      inset: 0;
      left: -120%;
      width: 120%;
      background: linear-gradient(90deg, transparent 0%, rgba(94, 234, 212, 0.18) 45%, transparent 85%);
      mix-blend-mode: screen;
      opacity: 0;
      animation: hud-wafer-scan 12s linear infinite;
      pointer-events: none;
    }

    @keyframes hud-wafer-scan {
      0% { transform: translateX(-35%); opacity: 0; }
      10% { opacity: 0.35; }
      22% { transform: translateX(55%); opacity: 0; }
      100% { transform: translateX(55%); opacity: 0; }
    }

    .day-night-wafer__icon {
      position: relative;
      width: 2.25rem;
      height: 2.25rem;
      border-radius: 0.7rem;
      background: linear-gradient(140deg, rgba(32, 45, 63, 0.9), rgba(20, 28, 44, 0.84));
      box-shadow: inset 0 0 12px rgba(8, 12, 20, 0.7), 0 0 14px var(--accent-shadow);
      transition: transform 180ms ease-out, box-shadow 240ms ease-out;
    }

    .day-night-wafer[data-phase="day"] .day-night-wafer__icon {
      transform: rotate(2deg);
      box-shadow: inset 0 0 14px rgba(15, 23, 42, 0.72), 0 0 18px var(--accent-shadow);
    }

    .day-night-wafer[data-phase="night"] .day-night-wafer__icon {
      transform: rotate(-3deg);
      box-shadow: inset 0 0 16px rgba(10, 12, 24, 0.82), 0 0 18px var(--accent-shadow);
    }

    .day-night-wafer__icon::before,
    .day-night-wafer__icon::after {
      content: '';
      position: absolute;
      pointer-events: none;
    }

    .day-night-wafer[data-phase="day"] .day-night-wafer__icon::before {
      top: 50%;
      left: 50%;
      width: 1.35rem;
      height: 1.35rem;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      background: radial-gradient(circle at 40% 35%, rgba(255, 237, 179, 0.95) 0%, rgba(251, 191, 36, 0.85) 55%, rgba(217, 119, 6, 0.2) 100%);
      box-shadow: 0 0 16px var(--accent-shadow);
    }

    .day-night-wafer[data-phase="day"] .day-night-wafer__icon::after {
      top: 50%;
      left: 50%;
      width: 2rem;
      height: 2rem;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      background: conic-gradient(
        from 0deg,
        rgba(251, 191, 36, 0.45) 0deg 18deg,
        transparent 18deg 45deg
      );
      filter: blur(0.35px);
    }

    .day-night-wafer[data-phase="night"] .day-night-wafer__icon::before {
      top: 50%;
      left: 50%;
      width: 1.45rem;
      height: 1.45rem;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      background: radial-gradient(circle at 45% 40%, rgba(199, 210, 254, 0.9) 0%, rgba(129, 140, 248, 0.88) 55%, rgba(79, 70, 229, 0.25) 100%);
      box-shadow: 0 0 16px var(--accent-shadow);
    }

    .day-night-wafer[data-phase="night"] .day-night-wafer__icon::after {
      top: 50%;
      left: 58%;
      width: 1.45rem;
      height: 1.45rem;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      background: rgba(14, 21, 35, 0.95);
      box-shadow: -6px 0 12px rgba(53, 63, 91, 0.38);
    }

    .day-night-wafer__content {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .day-night-wafer__tag {
      font-size: 0.74rem;
      letter-spacing: 0.24em;
      color: rgba(226, 232, 240, 0.8);
    }

    .day-night-wafer[data-phase="day"] .day-night-wafer__tag,
    .day-night-wafer[data-phase="night"] .day-night-wafer__tag,
    .day-night-wafer[data-curfew="true"] .day-night-wafer__tag {
      color: var(--accent);
    }

    .day-night-wafer__bar {
      position: relative;
      width: 8.9rem;
      height: 6px;
      border-radius: 999px;
      background: rgba(11, 17, 28, 0.92);
      border: 1px solid rgba(94, 107, 139, 0.45);
      overflow: hidden;
    }

    .day-night-wafer__bar-fill {
      position: relative;
      height: 100%;
      width: 50%;
      background: var(--accent);
      box-shadow: 0 0 12px var(--accent-shadow);
      transition: width 240ms ease-out, background 200ms ease-out, box-shadow 200ms ease-out;
    }

    .day-night-wafer__bar-noise {
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(
        90deg,
        rgba(148, 163, 184, 0.06) 0px 7px,
        transparent 7px 14px
      );
      mix-blend-mode: overlay;
      opacity: 0.35;
      pointer-events: none;
    }

    @media (max-width: 1120px) {
      .day-night-wafer {
        min-width: auto;
      }
    }
  `}),s.jsxs("div",{className:"day-night-wafer","data-phase":l,"data-curfew":n||void 0,role:"status","aria-label":x,children:[s.jsx("span",{className:"day-night-wafer__scanline","aria-hidden":!0}),s.jsx("div",{className:"day-night-wafer__icon","aria-hidden":!0}),s.jsxs("div",{className:"day-night-wafer__content","aria-hidden":!0,children:[s.jsx("span",{className:"day-night-wafer__tag",children:l==="day"?"DAY":"NIGHT"}),s.jsxs("div",{className:"day-night-wafer__bar",children:[s.jsx("div",{className:"day-night-wafer__bar-fill",style:{width:`${u}%`}}),s.jsx("div",{className:"day-night-wafer__bar-noise"})]})]})]})]})},$t=8,us={liveArea:20,stroke:2},Hr={floor:"#101b32",wall:"#1f2937",door:"#fbbf24",cover:"#1d4ed8",water:"#0ea5e9",trap:"#7c3aed",default:"#101b32"},Wr={player:"#60a5fa",enemy:"#f87171",npc:"#34d399",objective:"#facc15"},$r={[ee.IDLE]:"#38bdf8",[ee.SUSPICIOUS]:"#fbbf24",[ee.ALARMED]:"#ef4444",[ee.DISABLED]:"#64748b"},Zt=us.stroke,fs=us.liveArea/2,Jl="rgba(15, 23, 42, 0.95)",Ur=16,ec=256,tc=192,nc=192,rc=160,ms=(e,t)=>{if(typeof window>"u"||typeof document>"u")return t;try{const n=window.getComputedStyle(document.documentElement).getPropertyValue(e);return(n==null?void 0:n.trim())||t}catch{return t}},ps=()=>ms("--color-hud-surface",Jl),ac=()=>{const e=ms("--hud-radius-lg",`${Ur}px`),t=Number.parseFloat(e);return Number.isFinite(t)?t:Ur},An=e=>({minX:0,minY:0,maxX:Math.max(0,e.mapWidth-1),maxY:Math.max(0,e.mapHeight-1),width:Math.max(1,e.mapWidth),height:Math.max(1,e.mapHeight)}),Ut=e=>{var n;if(!e)return!1;const t=((n=e.type)==null?void 0:n.toString().toLowerCase())??"";return t==="wall"||t==="door"||t==="cover"?!0:e.isWalkable===!1},xn=e=>{var b;const t=e.tiles;if(!t.length||!((b=t[0])!=null&&b.length))return An(e);const n=(A,C,y)=>Math.min(Math.max(A,C),y),r=A=>{if(!A)return-1;for(let C=0;C<A.length;C+=1)if(Ut(A[C]))return C;return-1},a=A=>{if(!A)return-1;for(let C=A.length-1;C>=0;C-=1)if(Ut(A[C]))return C;return-1},o=A=>{for(let C=0;C<t.length;C+=1){const y=t[C];if(y&&Ut(y[A]))return C}return-1},l=A=>{for(let C=t.length-1;C>=0;C-=1){const y=t[C];if(y&&Ut(y[A]))return C}return-1};let i=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY,m=Number.POSITIVE_INFINITY,f=Number.NEGATIVE_INFINITY;for(let A=0;A<t.length;A+=1){const C=t[A],y=r(C);y!==-1&&y<i&&(i=y);const O=a(C);O!==-1&&O>d&&(d=O)}for(let A=0;A<e.mapWidth;A+=1){const C=o(A);C!==-1&&C<m&&(m=C);const y=l(A);y!==-1&&y>f&&(f=y)}if(!Number.isFinite(i)||!Number.isFinite(d)||!Number.isFinite(m)||!Number.isFinite(f))return An(e);const u=n(i,0,Math.max(0,e.mapWidth-1)),h=n(d,u,Math.max(0,e.mapWidth-1)),v=n(m,0,Math.max(0,e.mapHeight-1)),x=n(f,v,Math.max(0,e.mapHeight-1));return{minX:u,minY:v,maxX:h,maxY:x,width:Math.max(1,h-u+1),height:Math.max(1,x-v+1)}},Tt=(e,t,n)=>Math.min(Math.max(e,t),n),Gr=(e,t)=>Math.min(fs,Math.max(3,e*t)),st=(e,t=Zt)=>Math.max(.5,t)/Math.max(e,1e-4),sc=(e,t,n,r,a,o)=>{const l=Math.max(0,Math.min(o,Math.min(r,a)/2));e.beginPath(),e.moveTo(t+l,n),e.lineTo(t+r-l,n),e.quadraticCurveTo(t+r,n,t+r,n+l),e.lineTo(t+r,n+a-l),e.quadraticCurveTo(t+r,n+a,t+r-l,n+a),e.lineTo(t+l,n+a),e.quadraticCurveTo(t,n+a,t,n+a-l),e.lineTo(t,n+l),e.quadraticCurveTo(t,n,t+l,n),e.closePath()},wn=(e,t)=>{const n=1.3333333333333333,r=Math.max(1,Math.round(t.width)),a=Math.max(1,Math.round(t.height));let o=Math.max(1,e.width),l=Math.max(1,e.height);return o/l>n?o=l*n:l=o/n,o>r&&(o=r,l=o/n),l>a&&(l=a,o=l*n,o>r&&(o=r,l=o/n)),{width:Math.max(1,Math.round(o)),height:Math.max(1,Math.round(l))}},ic=(e,t,n)=>{if(!e)return null;const r=window.devicePixelRatio||1,a=Math.max(1,Math.round(t*r)),o=Math.max(1,Math.round(n*r));e.width!==a&&(e.width=a),e.height!==o&&(e.height=o),e.style.width=`${t}px`,e.style.height=`${n}px`;const l=e.getContext("2d");return l?(l.setTransform(r,0,0,r,0,0),l.imageSmoothingEnabled=!1,l):null},oc=({ctx:e,state:t,crop:n})=>{const{tiles:r,tileScale:a}=t,o=ps();e.fillStyle=o,e.fillRect(n.minX*a,n.minY*a,n.width*a,n.height*a);for(let l=n.minY;l<=n.maxY;l+=1){const i=r[l];if(i)for(let d=n.minX;d<=n.maxX;d+=1){const m=i[d];if(!m)continue;const f=Hr[m.type.toLowerCase()]??Hr.default;e.fillStyle=f,e.fillRect(d*a,l*a,a,a),m.provideCover&&(e.fillStyle="rgba(59, 130, 246, 0.15)",e.fillRect(d*a,l*a,a,a))}}},lc=({ctx:e,state:t,scale:n,crop:r})=>{const{tileScale:a,entities:o,cameras:l}=t,i=t.objectiveMarkers??[];o.forEach(d=>{if(d.x<r.minX||d.x>r.maxX||d.y<r.minY||d.y>r.maxY)return;const m=Wr[d.kind]??Wr.npc,f=Gr(a,d.kind==="player"?.7:.5),u=(d.x+.5)*a,h=(d.y+.5)*a;d.kind==="player"?(e.fillStyle=m,e.beginPath(),e.moveTo(u,h-f),e.lineTo(u+f,h+f),e.lineTo(u-f,h+f),e.closePath(),e.fill()):(e.fillStyle=d.status==="inactive"?"rgba(148, 163, 184, 0.35)":m,e.beginPath(),e.arc(u,h,f*.85,0,Math.PI*2),e.fill(),d.kind==="enemy"&&(e.strokeStyle="rgba(15, 23, 42, 0.85)",e.lineWidth=st(n),e.stroke()))}),i.forEach(d=>{if(d.x<r.minX||d.x>r.maxX||d.y<r.minY||d.y>r.maxY)return;const m=Math.min(fs,Math.max(5,a*.55)),f=(d.x+.5)*a,u=(d.y+.5)*a;e.fillStyle="rgba(251, 191, 36, 0.2)",e.beginPath(),e.arc(f,u,m,0,Math.PI*2),e.fill(),e.strokeStyle="rgba(251, 191, 36, 0.95)",e.lineWidth=st(n),e.beginPath(),e.arc(f,u,m*.7,0,Math.PI*2),e.stroke()}),l.forEach(d=>{if(d.x<r.minX||d.x>r.maxX||d.y<r.minY||d.y>r.maxY)return;const m=d.isActive?$r[d.alertState]:$r[ee.DISABLED],f=Gr(a,.5),u=(d.x+.5)*a,h=(d.y+.5)*a;e.save(),e.fillStyle=m,e.beginPath(),e.moveTo(u,h-f),e.lineTo(u+f,h+f),e.lineTo(u-f,h+f),e.closePath(),e.fill(),e.lineWidth=st(n),e.strokeStyle="rgba(15, 23, 42, 0.65)",e.stroke(),e.restore()})},cc=({ctx:e,state:t,scale:n})=>{const{path:r,tileScale:a}=t;if(!r||r.length<2)return;e.strokeStyle="rgba(59, 130, 246, 0.6)",e.lineWidth=st(n,Zt*.95),e.lineJoin="round",e.lineCap="round",e.setLineDash([a*.8,a*.5]),e.beginPath(),r.forEach((d,m)=>{const f=(d.x+.5)*a,u=(d.y+.5)*a;m===0?e.moveTo(f,u):e.lineTo(f,u)}),e.stroke(),e.setLineDash([]);const o=r[r.length-1],l=(o.x+.5)*a,i=(o.y+.5)*a;e.fillStyle="rgba(59, 130, 246, 0.12)",e.beginPath(),e.arc(l,i,Math.max(4,a*.4),0,Math.PI*2),e.fill(),e.strokeStyle="rgba(59, 130, 246, 0.7)",e.lineWidth=st(n),e.beginPath(),e.arc(l,i,Math.max(3,a*.28),0,Math.PI*2),e.stroke()},dc=({ctx:e,state:t,scale:n},r)=>{const{viewport:a,tileScale:o}=t;if(!a||a.width<=0||a.height<=0)return;const l=r.width,i=r.height,d=l*o,m=i*o,f=(a.x+a.width/2)*o,u=(a.y+a.height/2)*o,h=f-d/2,v=u-m/2,x=Math.min(Math.max(4,d*.12),ac()/Math.max(n,1e-4));e.save(),e.lineWidth=st(n,Zt*.85),e.strokeStyle="rgba(148, 163, 184, 0.4)",sc(e,h,v,d,m,x),e.stroke(),e.restore();const b=Math.max(2,o*.5);e.save(),e.strokeStyle="rgba(148, 163, 184, 0.5)",e.lineWidth=st(n,Zt*.75),e.beginPath(),e.moveTo(f-b,u),e.lineTo(f+b,u),e.moveTo(f,u-b),e.lineTo(f,u+b),e.stroke(),e.restore()},uc=(e,t,n,r,a,o)=>{const l=ic(e,n,r);if(!l)return;l.clearRect(0,0,n,r),l.fillStyle=ps(),l.fillRect(0,0,n,r);const i=o.width*t.tileScale,d=o.height*t.tileScale;if(i<=0||d<=0)return;const m=Math.min(n/i,r/d),f=(n-i*m)/2,u=(r-d*m)/2;l.save(),l.translate(f,u),l.scale(m,m),l.translate(-o.minX*t.tileScale,-o.minY*t.tileScale);const h={ctx:l,state:t,scale:m,crop:o};oc(h),cc(h),lc(h),dc(h,a),l.restore()},fc=()=>{const e=c.useRef(null),t=c.useRef(null),n=c.useRef(nt.getState()),r=c.useRef(n.current?xn(n.current):null),[a,o]=c.useState({width:ec,height:tc}),[l,i]=c.useState(0),d=c.useRef(null),m=c.useRef(null),f=c.useRef(!1),u=c.useRef(null),h=c.useRef(!1),v=c.useCallback(()=>n.current,[]),x=c.useCallback(g=>g?(r.current||(r.current=xn(g)),r.current??An(g)):null,[]),b=c.useCallback(g=>{const w=g.viewport;if(!w)return;m.current!==g.areaId&&(d.current=null,m.current=g.areaId);const S=wn(w,{width:g.mapWidth,height:g.mapHeight}),j=d.current;(!j||j.width!==S.width||j.height!==S.height)&&(d.current=S)},[]);c.useEffect(()=>{const g=w=>{const S=w.detail;n.current=S,r.current=xn(S),b(S),i(S.version)};return nt.addEventListener(kr,g),nt.requestImmediateState(),()=>{nt.removeEventListener(kr,g)}},[b]),c.useEffect(()=>{const g=e.current;if(!g||typeof ResizeObserver>"u")return;const w=new ResizeObserver(()=>{const S=Math.max(nc,Math.floor(g.clientWidth/$t)*$t),j=Math.max(rc,Math.floor(g.clientHeight/$t)*$t);o(P=>P.width===S&&P.height===j?P:{width:S,height:j}),nt.setCanvasBounds(S,j)});return w.observe(g),()=>w.disconnect()},[]),c.useEffect(()=>{const g=v(),w=d.current,S=x(g);!g||!w||!S||uc(t.current,g,a.width,a.height,w,S)},[a.width,a.height,l,v,x]);const A=c.useCallback(g=>{const w=v(),S=t.current,j=x(w);if(!w||!S||!j)return null;const P=S.getBoundingClientRect(),I=P.width,Y=P.height;if(I===0||Y===0)return null;const te=j.width*w.tileScale,de=j.height*w.tileScale,he=Math.min(I/te,Y/de),q=(I-te*he)/2,Z=(Y-de*he)/2,ce=(g.clientX-P.left-q)/he,ue=(g.clientY-P.top-Z)/he,le=ce+j.minX*w.tileScale,R=ue+j.minY*w.tileScale,re=Tt(le/w.tileScale,0,w.mapWidth),N=Tt(R/w.tileScale,0,w.mapHeight);return{gridX:re,gridY:N}},[x,v]),C=c.useCallback((g,w)=>{if(!g)return;const S=v(),j=S==null?void 0:S.viewport;if(!S||!j)return;const P=d.current??wn(j,{width:S.mapWidth,height:S.mapHeight}),I=P.width/2,Y=P.height/2,te=Tt(g.gridX,I,Math.max(I,S.mapWidth-I)),de=Tt(g.gridY,Y,Math.max(Y,S.mapHeight-Y));d.current=P,nt.emitInteraction({type:Ei,gridX:te,gridY:de,animate:w})},[v]),y=g=>{if(g.pointerType!=="touch"&&g.button!==0)return;const w=A(g);if(w){if(f.current=!0,h.current=!1,u.current=g.pointerId,typeof g.currentTarget.setPointerCapture=="function")try{g.currentTarget.setPointerCapture(g.pointerId)}catch{}C(w,!0)}},O=g=>{if(!f.current||u.current!==g.pointerId)return;const w=A(g);w&&(h.current=!0,C(w,!1))},_=g=>{if(!f.current||u.current!==g.pointerId)return;const w=A(g);C(w,!h.current),f.current=!1,u.current=null},L=g=>{u.current===g.pointerId&&(f.current=!1,u.current=null)},B=()=>{f.current=!1,u.current=null},Q=g=>{g.preventDefault();const w=Tt(g.deltaY,-120,120);nt.adjustZoom(w<0?.15:-.15)},se=g=>{if(!["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(g.key))return;g.preventDefault();const w=v();if(!w)return;const S=d.current??wn(w.viewport,{width:w.mapWidth,height:w.mapHeight}),j=Math.max(1,Math.floor(S.width*.2));let P=w.viewport.x+w.viewport.width/2,I=w.viewport.y+w.viewport.height/2;switch(g.key){case"ArrowUp":I-=j;break;case"ArrowDown":I+=j;break;case"ArrowLeft":P-=j;break;case"ArrowRight":P+=j;break}C({gridX:P,gridY:I},!1)};return!(v()&&d.current)?null:s.jsx("section",{className:"mini-map-panel","aria-label":"MiniMap panel",children:s.jsx("div",{ref:e,className:"mini-map-canvas",role:"application","aria-label":"MiniMap viewport",tabIndex:0,onKeyDown:se,onWheel:Q,onPointerDown:y,onPointerMove:O,onPointerUp:_,onPointerCancel:L,onPointerLeave:B,children:s.jsx("canvas",{ref:t,style:{width:"100%",height:"100%",display:"block"}})})})},mc=Rt.memo(fc),pc=({children:e,className:t,variant:n="default"})=>{const r=n==="frameless"?"flex h-full min-h-0 flex-1 flex-col gap-[0.5rem] px-0 py-0 text-[#f8fafc] font-body":"flex h-full min-h-0 flex-1 flex-col gap-[0.5rem] rounded-[18px] border border-[rgba(59,130,246,0.22)] bg-[linear-gradient(145deg,rgba(8,15,30,0.92),rgba(12,22,42,0.82),rgba(6,12,28,0.92))] px-[0.9rem] py-[0.9rem] text-[#f8fafc] shadow-[0_20px_30px_-20px_rgba(8,12,24,0.5)] backdrop-blur-[14px] font-body",a=t?`${r} ${t}`:r;return s.jsx("div",{className:a,"data-testid":"tactical-panel",children:e})},gc=Rt.memo(pc),qn=e=>e.missions,hc=e=>e.quests.quests,bc=K(qn,e=>e.levels[e.currentLevelIndex]??null),yc=e=>e?e.isCompleted?!0:e.objectives.length>0&&e.objectives.every(t=>t.isCompleted):!1,xc=(e,t)=>{const n=e.questIds.map(l=>t.find(i=>i.id===l)),r=e.questIds.length,a=n.filter(yc).length;return{...e,totalQuests:r,completedQuests:a,isComplete:r===0?!1:a===r}},Vr=(e,t)=>e.map(n=>xc(n,t)),Le=K([bc,hc],(e,t)=>{if(!e)return null;const n=Vr(e.objectives.filter(o=>o.kind==="primary"),t),r=Vr(e.objectives.filter(o=>o.kind==="side"),t),a=n.length>0&&n.every(o=>o.isComplete);return{level:e.level,levelId:e.levelId,name:e.name,zoneId:e.zoneId,primary:n,side:r,allPrimaryComplete:a}});K(Le,e=>(e==null?void 0:e.primary)??[]);K(Le,e=>(e==null?void 0:e.side)??[]);const wc=K(Le,e=>(e==null?void 0:e.primary.find(t=>!t.isComplete))??null),vc=K(Le,e=>(e==null?void 0:e.side.find(t=>!t.isComplete))??null);K(Le,e=>(e==null?void 0:e.allPrimaryComplete)??!1);const Yn=K(qn,e=>e.pendingAdvance),Sc=K(qn,e=>e.celebrationAcknowledged);K(Le,e=>(e==null?void 0:e.level)??0);K(Le,e=>(e==null?void 0:e.name)??"");const qr={margin:0,padding:0,display:"flex",flexDirection:"column",listStyle:"none"},Ic=({collapsed:e=!1,onToggle:t})=>{const n=je(),r=E(y=>y.settings.locale),a=E(Le),o=E(Yn),l=E(y=>y.world.currentMapArea),i=Pe(r),d=(l==null?void 0:l.displayName)??(l==null?void 0:l.name)??(a==null?void 0:a.name)??i.levelIndicator.unknownLevel,m=(l==null?void 0:l.level)??(a==null?void 0:a.level)??0,f=a==null?void 0:a.name,u=(a==null?void 0:a.primary)??[],h=(a==null?void 0:a.side)??[],v=(a==null?void 0:a.allPrimaryComplete)??!1,x=()=>{n(Mi())},b=()=>{t&&t()},A={width:e?"min(90vw, 240px)":"min(92vw, 320px)",background:"linear-gradient(145deg, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.82))",border:"1px solid rgba(148, 163, 184, 0.35)",borderRadius:"14px",padding:e?"0.7rem 0.85rem":"0.9rem 1.05rem",fontFamily:"'DM Mono', 'IBM Plex Mono', monospace",color:"#f8fafc",letterSpacing:"0.05em",display:"flex",flexDirection:"column",gap:e?"0.2rem":"0.4rem",boxShadow:"0 12px 32px rgba(15, 23, 42, 0.45)",pointerEvents:"auto",backdropFilter:"blur(4px)",transition:"width 0.2s ease, padding 0.2s ease"},C={display:"flex",flexDirection:"column",gap:f&&f!==d?"0.25rem":0,flex:1,minWidth:0,width:"100%",cursor:t?"pointer":"default",textTransform:"uppercase",textAlign:"left",transition:"color 0.2s ease",userSelect:"none",pointerEvents:"auto"};return s.jsxs("div",{style:A,children:[s.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"0.35rem",pointerEvents:"auto"},children:[s.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"0.5rem"},children:[s.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",minWidth:0},children:[s.jsx("span",{style:{fontSize:"0.7rem",color:"#94a3b8",opacity:.9},children:i.levelIndicator.levelLabel}),s.jsx("span",{style:{fontSize:"0.96rem",fontWeight:600,whiteSpace:"nowrap"},children:m})]}),s.jsx("div",{style:{display:"flex",alignItems:"center",gap:"0.4rem",minHeight:"1.25rem"},children:o&&s.jsx("button",{type:"button",onClick:x,style:{all:"unset",cursor:"pointer",fontSize:"0.66rem",color:"#5eead4",border:"1px solid rgba(94, 234, 212, 0.38)",borderRadius:"999px",padding:"0.18rem 0.55rem",textTransform:"uppercase",letterSpacing:"0.18em",transition:"all 0.2s ease",pointerEvents:"auto"},onMouseEnter:y=>{y.currentTarget.style.background="rgba(15, 118, 110, 0.22)",y.currentTarget.style.borderColor="rgba(94, 234, 212, 0.55)"},onMouseLeave:y=>{y.currentTarget.style.background="transparent",y.currentTarget.style.borderColor="rgba(94, 234, 212, 0.38)"},children:i.levelIndicator.missionReadyBadge})})]}),s.jsxs("div",{onClick:b,role:"button",tabIndex:0,onKeyDown:y=>{t&&(y.key==="Enter"||y.key===" ")&&(y.preventDefault(),b())},style:C,onMouseEnter:y=>{t&&(y.currentTarget.style.color="rgba(226, 232, 240, 0.92)")},onMouseLeave:y=>{y.currentTarget.style.color="inherit"},children:[s.jsxs("span",{style:{fontSize:"0.72rem",color:"rgba(148, 163, 184, 0.82)",letterSpacing:"0.12em",whiteSpace:"nowrap",textOverflow:"ellipsis",overflow:"hidden"},children:[d," ",t&&s.jsx("span",{style:{fontSize:"0.65rem",opacity:.7},children:e?"▸":"▾"})]}),f&&f!==d&&s.jsx("span",{style:{fontSize:"0.62rem",color:"rgba(148, 163, 184, 0.6)",letterSpacing:"0.14em",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:f})]})]}),!e&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{style:{borderTop:"1px solid rgba(148, 163, 184, 0.22)",paddingTop:"0.45rem",display:"flex",flexDirection:"column",gap:"0.3rem"},children:[s.jsx("span",{style:{fontSize:"0.7rem",color:"#94a3b8",opacity:.85},children:i.levelIndicator.objectivesLabel}),u.length===0?s.jsx("span",{style:{fontSize:"0.72rem",color:"#cbd5f5",opacity:.85},children:i.levelIndicator.emptyObjectives}):s.jsx("ul",{style:{...qr,gap:"0.32rem"},children:u.map((y,O)=>s.jsxs("li",{style:{display:"flex",alignItems:"center",gap:"0.45rem",fontSize:"0.74rem",lineHeight:1.2,color:y.isComplete?"rgba(148, 163, 184, 0.7)":"rgba(226, 232, 240, 0.92)",textDecoration:y.isComplete?"line-through":"none",textDecorationThickness:"1px",textDecorationColor:"rgba(94, 234, 212, 0.75)",transition:"color 0.18s ease"},children:[s.jsx("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:"0.85rem",height:"0.85rem",borderRadius:"999px",border:"1px solid rgba(94, 234, 212, 0.45)",background:y.isComplete?"linear-gradient(135deg, rgba(94, 234, 212, 0.45), rgba(56, 189, 248, 0.35))":"rgba(14, 165, 233, 0.14)",color:y.isComplete?"#0f172a":"#5eead4",fontSize:"0.64rem",fontWeight:600},"aria-hidden":!0,children:y.isComplete?"✓":O+1}),s.jsx("span",{style:{flex:1},children:y.label}),y.totalQuests>1&&s.jsxs("span",{style:{fontSize:"0.62rem",color:"rgba(148, 163, 184, 0.75)",fontFamily:"'DM Mono', 'IBM Plex Mono', monospace"},children:[y.completedQuests,"/",y.totalQuests]})]},y.id))})]}),s.jsxs("div",{style:{borderTop:"1px solid rgba(148, 163, 184, 0.16)",paddingTop:"0.4rem",display:"flex",flexDirection:"column",gap:"0.24rem"},children:[s.jsx("span",{style:{fontSize:"0.68rem",color:"rgba(148, 163, 184, 0.7)"},children:i.levelIndicator.sideObjectivesLabel}),h.length===0?s.jsx("span",{style:{fontSize:"0.68rem",color:"rgba(148, 163, 184, 0.55)"},children:i.levelIndicator.noSideObjectives}):s.jsx("ul",{style:{...qr,gap:"0.22rem"},children:h.map(y=>s.jsxs("li",{style:{display:"flex",alignItems:"center",gap:"0.4rem",fontSize:"0.68rem",color:y.isComplete?"rgba(148, 163, 184, 0.6)":"rgba(226, 232, 240, 0.78)",textDecoration:y.isComplete?"line-through":"none",textDecorationThickness:"1px",textDecorationColor:"rgba(99, 102, 241, 0.6)"},children:[s.jsx("span",{style:{width:"0.5rem",height:"0.5rem",borderRadius:"999px",background:y.isComplete?"linear-gradient(135deg, rgba(129, 140, 248, 0.6), rgba(99, 102, 241, 0.45))":"rgba(99, 102, 241, 0.25)",display:"inline-flex",alignItems:"center",justifyContent:"center",color:"#0f172a",fontSize:"0.55rem"},"aria-hidden":!0,children:y.isComplete?"✓":""}),s.jsx("span",{style:{flex:1},children:y.label})]},y.id))})]}),v&&!o&&s.jsx("span",{style:{marginTop:"0.3rem",fontSize:"0.66rem",color:"rgba(94, 234, 212, 0.76)",fontFamily:"'DM Mono', 'IBM Plex Mono', monospace"},children:i.levelIndicator.primaryCompleteFootnote})]})]})},en=e=>e.player.data,kc=e=>!!e.settings.reputationSystemsEnabled,Ec={resistance:0,corpsec:0,scavengers:0};K(en,e=>e.karma);const Mc=K(en,kc,(e,t)=>t?e.factionReputation:Ec),Cc={corpsec_defector:{earnest:.6,stoic:.4},street_urchin:{sarcastic:.7,ruthless:.3},underground_hacker:{sarcastic:.6,earnest:.4},wasteland_scavenger:{ruthless:.6,stoic:.4}},Tc=e=>{let t="earnest",n=Number.NEGATIVE_INFINITY;return Object.keys(e).forEach(r=>{const a=e[r];a>n&&(t=r,n=a)}),t},Pc=e=>{const t={earnest:0,sarcastic:0,ruthless:0,stoic:0},n={...t,...e},r=Object.values(n).reduce((a,o)=>a+o,0);return r<=0?{...t,earnest:1}:Object.keys(n).reduce((a,o)=>(a[o]=Number.parseFloat((n[o]/r).toFixed(3)),a),t)},_c=K(en,e=>{const t={...e.personality.flags};if(e.backgroundId){const r=Cc[e.backgroundId];r&&Object.keys(r).forEach(a=>{const o=t[a]??0;t[a]=o+r[a]})}const n=Pc(t);return{alignment:Tc(n),flags:n,lastUpdated:e.personality.lastUpdated,lastChangeSource:e.personality.lastChangeSource}});K(en,e=>e.name);const Ac=e=>e.quests.quests,Rc=K(Ac,e=>e.filter(t=>t.isActive&&!t.isCompleted)),Dc=(e,t)=>/main/i.test(e.id)||/main/i.test(e.name)?-50+t:/datapad|operation|cold|iron/i.test(e.id)?-25+t:t,Kn=K(Rc,e=>{const t=[];return e.forEach((n,r)=>{n.objectives.filter(a=>!a.isCompleted).forEach((a,o)=>{t.push({questId:n.id,questName:n.name,questDescription:n.description,objective:a,priority:Dc(n,r)*10+o,isPrimary:r===0})})}),t.sort((n,r)=>n.priority-r.priority)});K(Kn,e=>e.length>0?e[0]:null);K(Kn,e=>e.length>1?e[1]:null);const Rn={banter:{earnest:[{text:"Shelterline kids started a rumor that thunder is just the ocean applauding us. Let’s stay worth the encore.",guidelineRef:"plot.tone.guideline.7"},{text:"Amara logged a new morale playlist: ninety minutes of clattering cutlery recorded during a pre-war dinner rush. We could dance to that later.",guidelineRef:"plot.tone.guideline.6"}],sarcastic:[{text:"CorpSec just issued an alert about “unauthorized optimism in Sector 12.” Congratulations, you’re contraband joy.",guidelineRef:"plot.tone.guideline.4"},{text:"Fun fact: drone firmware now includes “coyote deterrent mode.” Somewhere an engineer thinks we’re wildlife. Let’s give them a nature documentary.",guidelineRef:"plot.tone.guideline.2"}],ruthless:[{text:"Found an ESD memo describing us as “surgical entropy.” I’ll embrace the brand if you do.",guidelineRef:"plot.tone.guideline.5"},{text:"CorpSec requisitioned riot foam flavored like citrus. Imagine choking on oranges while we dismantle their barricade.",guidelineRef:"plot.tone.guideline.2"}],stoic:[{text:"Filed under anomalies: pigeons roosting in the comms tower tapped out Morse for “stay loud.” No human hands detected.",guidelineRef:"plot.tone.guideline.2"},{text:"Supply ledger shows someone requisitioned 40 kilos of glitter for “psychological operations.” I logged it as “to be determined.”",guidelineRef:"plot.tone.guideline.3"}]},interjections:{questCompleted:{earnest:[{text:"Objective archived. You just stretched curfew a little thinner.",guidelineRef:"plot.tone.guideline.1"},{text:"Quest wrapped. Shelterline will taste this win in their next ration drop.",guidelineRef:"plot.tone.guideline.7"}],sarcastic:[{text:"You crushed that objective so hard the drones filed a workplace grievance.",guidelineRef:"plot.tone.guideline.4"},{text:"Quest complete. Somewhere an ESD analyst just spat in their nutrient slurry.",guidelineRef:"plot.tone.guideline.4"}],ruthless:[{text:"Target neutralized. Momentum stays with us.",guidelineRef:"plot.tone.guideline.5"},{text:"Objective cleared. Line them up for the next strike.",guidelineRef:"plot.tone.guideline.5"}],stoic:[{text:"Task completed. Logging success before it cools.",guidelineRef:"plot.tone.guideline.3"},{text:"Objective done. Updating projections now.",guidelineRef:"plot.tone.guideline.3"}]},reputationPositive:{earnest:[{text:"Your name circulates with smiles today. Resistance morale just spiked.",guidelineRef:"plot.tone.guideline.7"}],sarcastic:[{text:"Congrats, you’re trending on the underground net for something other than property damage.",guidelineRef:"plot.tone.guideline.4"}],ruthless:[{text:"Factions noticed your precision. They’ll expect more sharp edges.",guidelineRef:"plot.tone.guideline.5"}],stoic:[{text:"Reputation bump logged. Allies recalibrating expectations.",guidelineRef:"plot.tone.guideline.3"}]},reputationNegative:{earnest:[{text:"Heads up: whispers turned uneasy. We might need to mend fences soon.",guidelineRef:"plot.tone.guideline.1"}],sarcastic:[{text:"Your popularity dip just broke a few pirate radio polls. Impressive in its own way.",guidelineRef:"plot.tone.guideline.4"}],ruthless:[{text:"Standing dropped. Intimidation can be leverage, but watch the collateral.",guidelineRef:"plot.tone.guideline.5"}],stoic:[{text:"Faction trust decaying. Rebalancing recommendations forthcoming.",guidelineRef:"plot.tone.guideline.3"}]},hostileEntered:{earnest:[{text:"Sensors scream hostile territory. Stay quick, stay breathing.",guidelineRef:"plot.tone.guideline.1"}],sarcastic:[{text:"Welcome to enemy hospitality. Complimentary bullets on the mezzanine.",guidelineRef:"plot.tone.guideline.4"}],ruthless:[{text:"Hostile zone confirmed. Perfect conditions for decisive violence.",guidelineRef:"plot.tone.guideline.5"}],stoic:[{text:"Hostility detected. Updating threat overlay now.",guidelineRef:"plot.tone.guideline.3"}]}}},jc=e=>{const t=Rn.banter[e]??Rn.banter.earnest;return t[Math.floor(Math.random()*t.length)]},Lc=(e,t)=>{const n=Rn.interjections[e];if(!n)return null;const r=n[t]??n.earnest;return!r||r.length===0?null:r[Math.floor(Math.random()*r.length)]},Nc=["gangHeat","curfewLevel","supplyScarcity","blackoutTier"],Oc={rumor:45e3,signage:45e3,weather:3e4,zoneDanger:15e3,hazardChange:12e3,zoneBrief:6e4},Dn=e=>({gangHeat:e.gangHeat,curfewLevel:e.curfewLevel,supplyScarcity:e.supplyScarcity,blackoutTier:e.blackoutTier}),Yr=e=>({flags:Dn(e.flags),impacts:{behavior:{...e.impacts.behavior},faction:{...e.impacts.faction},travel:{...e.impacts.travel}},rumor:e.rumor?{groupId:e.rumor.groupId,lines:[...e.rumor.lines],storyFunction:e.rumor.storyFunction,updatedAt:e.rumor.updatedAt}:null,signage:e.signage?{signId:e.signage.signId,text:e.signage.text,storyFunction:e.signage.storyFunction,updatedAt:e.signage.updatedAt}:null,weather:{presetId:e.weather.presetId,description:e.weather.description,storyFunction:e.weather.storyFunction,updatedAt:e.weather.updatedAt,rainIntensity:e.weather.rainIntensity,thunderActive:e.weather.thunderActive,timeOfDay:e.weather.timeOfDay},zone:{zoneId:e.zone.zoneId,zoneName:e.zone.zoneName,dangerRating:e.zone.dangerRating,hazards:[...e.zone.hazards],summary:e.zone.summary,directives:[...e.zone.directives]}}),Kr=e=>{const t=new Map;return e.forEach(n=>{const r=n.trim();if(!r)return;const a=r.toLowerCase();t.has(a)||t.set(a,r)}),t},zc=(e,t)=>{if(e.length!==t.length)return!1;for(let n=0;n<e.length;n+=1)if(e[n]!==t[n])return!1;return!0};class Fc{constructor(t){Ce(this,"previous",null);Ce(this,"lastEmitted",{});Ce(this,"cooldowns");this.cooldowns={...Oc,...(t==null?void 0:t.cooldowns)??{}}}prime(t){this.previous=Yr(t),this.lastEmitted={}}reset(){this.previous=null,this.lastEmitted={}}collect(t,n=Date.now()){const r=Yr(t);if(!this.previous)return this.previous=r,[];const a=this.diff(this.previous,r,n),o=[];for(const l of a){const i=this.lastEmitted[l.category],d=this.cooldowns[l.category]??0;typeof i=="number"&&d>0&&n-i<d||(o.push(l),this.lastEmitted[l.category]=n)}return this.previous=r,o}diff(t,n,r){const a=[];n.rumor&&n.rumor.lines.length>0&&(!t.rumor||t.rumor.updatedAt!==n.rumor.updatedAt)&&a.push({category:"rumor",timestamp:r,groupId:n.rumor.groupId,lines:[...n.rumor.lines],storyFunction:n.rumor.storyFunction}),n.signage&&(!t.signage||t.signage.updatedAt!==n.signage.updatedAt||t.signage.text!==n.signage.text)&&a.push({category:"signage",timestamp:r,signId:n.signage.signId,text:n.signage.text,storyFunction:n.signage.storyFunction}),(t.weather.presetId!==n.weather.presetId||t.weather.updatedAt!==n.weather.updatedAt||t.weather.rainIntensity!==n.weather.rainIntensity||t.weather.thunderActive!==n.weather.thunderActive||t.weather.timeOfDay!==n.weather.timeOfDay)&&a.push({category:"weather",timestamp:r,presetId:n.weather.presetId,previousPresetId:t.weather.presetId,description:n.weather.description,storyFunction:n.weather.storyFunction,rainIntensity:n.weather.rainIntensity,thunderActive:n.weather.thunderActive,timeOfDay:n.weather.timeOfDay});const l=Nc.reduce((x,b)=>(t.flags[b]!==n.flags[b]&&x.push({key:b,previous:t.flags[b],next:n.flags[b]}),x),[]),i=t.zone.dangerRating!==n.zone.dangerRating,d=n.zone.zoneName??t.zone.zoneName??null;(i||l.length>0)&&a.push({category:"zoneDanger",timestamp:r,dangerRating:n.zone.dangerRating??null,previousDangerRating:t.zone.dangerRating??null,flags:Dn(n.flags),previousFlags:Dn(t.flags),changedFlags:l,zoneName:d});const m=Kr(t.zone.hazards),f=Kr(n.zone.hazards),u=[];f.forEach((x,b)=>{m.has(b)||u.push(x)});const h=[];return m.forEach((x,b)=>{f.has(b)||h.push(x)}),(u.length>0||h.length>0)&&a.push({category:"hazardChange",timestamp:r,added:u,removed:h,zoneName:d}),(t.zone.zoneId!==n.zone.zoneId||t.zone.zoneName!==n.zone.zoneName||t.zone.summary!==n.zone.summary||!zc(t.zone.directives,n.zone.directives))&&a.push({category:"zoneBrief",timestamp:r,zoneName:n.zone.zoneName??d,summary:n.zone.summary??null,dangerRating:n.zone.dangerRating??null,hazards:[...n.zone.hazards],directives:[...n.zone.directives]}),a}}const jn="MISSION_ACCOMPLISHED",Ln="LEVEL_ADVANCE_REQUESTED",Bc=e=>{typeof window>"u"||window.dispatchEvent(new CustomEvent(jn,{detail:e}))},Hc=e=>{typeof window>"u"||window.dispatchEvent(new CustomEvent(Ln,{detail:e}))},Wc=9e3,Xr=48e3,$c=96e3,Qr=12,Uc=['Diagnostics show morale at "manageable"—keep it that way.',"Filed another complaint against the rain. Status: pending since 2034.","If you spot Theo, remind him the coffee synth still needs a filter.","Today’s lucky number is 404. Let’s try not to vanish."],Gc={operation:{badge:"OP",tone:"operation"},status:{badge:"ST",tone:"status"},interjection:{badge:"BC",tone:"broadcast"},player:{badge:"ME",tone:"player"},broadcast:{badge:"BC",tone:"broadcast"},battle:{badge:"BT",tone:"battle"},dialog:{badge:"DG",tone:"dialog"},stealth:{badge:"SF",tone:"stealth"}},Vc={badge:"--",tone:"broadcast"},Zr=({size:e=32,className:t})=>{const n=c.useId(),r=`${n}-bg`,a=`${n}-glow`;return s.jsxs("svg",{className:t,width:e,height:e,viewBox:"0 0 64 64",role:"img","aria-hidden":"true",focusable:"false",children:[s.jsxs("defs",{children:[s.jsxs("linearGradient",{id:r,x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[s.jsx("stop",{offset:"0%",stopColor:"#1e293b",stopOpacity:1}),s.jsx("stop",{offset:"100%",stopColor:"#0f172a",stopOpacity:1})]}),s.jsxs("linearGradient",{id:a,x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[s.jsx("stop",{offset:"0%",stopColor:"#38bdf8",stopOpacity:1}),s.jsx("stop",{offset:"100%",stopColor:"#0ea5e9",stopOpacity:1})]})]}),s.jsx("circle",{cx:"32",cy:"32",r:"32",fill:`url(#${r})`}),s.jsx("path",{d:"M32 16 L46 24 L32 32 L18 24 Z",fill:"#475569",opacity:"0.6"}),s.jsx("circle",{cx:"32",cy:"32",r:"10",fill:"none",stroke:`url(#${a})`,strokeWidth:"2.5"}),s.jsx("circle",{cx:"32",cy:"32",r:"6",fill:"none",stroke:`url(#${a})`,strokeWidth:"1.5"}),s.jsx("line",{x1:"32",y1:"22",x2:"32",y2:"26",stroke:"#38bdf8",strokeWidth:"2",strokeLinecap:"round"}),s.jsx("line",{x1:"32",y1:"38",x2:"32",y2:"42",stroke:"#38bdf8",strokeWidth:"2",strokeLinecap:"round"}),s.jsx("line",{x1:"22",y1:"32",x2:"26",y2:"32",stroke:"#38bdf8",strokeWidth:"2",strokeLinecap:"round"}),s.jsx("line",{x1:"38",y1:"32",x2:"42",y2:"32",stroke:"#38bdf8",strokeWidth:"2",strokeLinecap:"round"}),s.jsx("circle",{cx:"32",cy:"32",r:"2",fill:"#38bdf8"}),s.jsx("path",{d:"M8 8 L12 8 L12 12",fill:"none",stroke:"#0ea5e9",strokeWidth:"1.5",opacity:.4}),s.jsx("path",{d:"M56 8 L52 8 L52 12",fill:"none",stroke:"#0ea5e9",strokeWidth:"1.5",opacity:.4}),s.jsx("path",{d:"M8 56 L12 56 L12 52",fill:"none",stroke:"#0ea5e9",strokeWidth:"1.5",opacity:.4}),s.jsx("path",{d:"M56 56 L52 56 L52 52",fill:"none",stroke:"#0ea5e9",strokeWidth:"1.5",opacity:.4})]})},qc=(e,t,n)=>{if(e.length===0)return[t.questNone];const a=e.slice(0,n).map(o=>{const l=o.objective.count&&o.objective.count>1?` (${o.objective.currentCount??0}/${o.objective.count})`:"";return`${o.questName}: ${o.objective.description}${l}`});return e.length>n&&a.push(t.questMore),a},Yc=e=>{const t=e.replace(/\s+/g," ").trim();return t.length<=140?t:`${t.slice(0,137).trimEnd()}…`},Kc=(e,t)=>{const n=e.trim(),r=n.length?n:"---",a=r.toLowerCase(),o=l=>l.some(i=>a.includes(i));return o(["attack","enemy","combat","battle","damage","hostile"])?{category:"battle",label:t.battle,text:r,timestamp:Date.now()}:o(["dialog","dialogue","whispers","says","conversation","briefing","speech"])?{category:"dialog",label:t.dialog,text:r,timestamp:Date.now()}:o(["stealth","hidden","sneak","shadow","camouflage","conceal"])?{category:"stealth",label:t.stealth,text:r,timestamp:Date.now()}:{category:"broadcast",label:t.broadcast,text:r,timestamp:Date.now()}},Xc=()=>{const e=E(M=>M.settings.locale),t=c.useMemo(()=>Pe(e),[e]),n=c.useMemo(()=>t.george,[t]),{feedLabels:r,levelAdvance:a,missionComplete:o,promptPlaceholder:l,askPlaceholder:i,askInputLabel:d,sendLabel:m}=n,f=E(Kn),u=E(Le),h=E(wc),v=E(vc),x=E(_c),b=E(Mc),A=E(M=>!!M.settings.reputationSystemsEnabled),C=E(M=>M.quests.quests),y=E(M=>M.world),O=E(il),_=E(M=>M.log.messages),L=c.useMemo(()=>{var M;return(M=n.ambient)!=null&&M.length?n.ambient:Uc},[n]),[B,Q]=c.useState([]),[se,me]=c.useState(""),G=c.useRef(0),g=c.useRef(null),w=c.useRef(new Set),S=c.useRef(b),j=c.useRef({level:y.globalAlertLevel,inCombat:y.inCombat}),P=c.useRef(null),I=c.useRef(null),Y=c.useRef(""),te=c.useRef(_.length),de=c.useRef(null),he=c.useRef(!1),q=c.useRef([]),Z=c.useRef(null),ce=c.useCallback(()=>{if(!q.current.length){Z.current=null;return}const M=q.current.shift();M&&Q(H=>{const ie=[...H,M];return ie.length>Qr?ie.slice(ie.length-Qr):ie}),Z.current=window.setTimeout(ce,1e3)},[]),ue=c.useCallback(({category:M,label:H,text:ie,timestamp:ae})=>{const pe=ae??Date.now(),oe=Gc[M]??Vc,we={id:`${pe}-${Math.random().toString(36).slice(2)}`,category:M,text:Yc(ie),label:H,timestamp:pe,badge:oe.badge,tone:oe.tone};q.current=[...q.current,we],Z.current===null&&ce()},[ce]),le=c.useCallback(M=>{ue(M)},[ue]),R=c.useCallback(M=>{G.current=Date.now()+Wc,g.current=null,le({category:"interjection",label:n.feedLabels.interjection,text:M.text,timestamp:Date.now()})},[n.feedLabels.interjection,le]),re=c.useCallback(M=>{const H=Lc(M,x.alignment);if(!H)return;if(Date.now()>=G.current){R(H);return}g.current=H},[x.alignment,R]),N=c.useCallback(()=>L.length&&Math.random()<.5?{text:L[Math.floor(Math.random()*L.length)],guidelineRef:"ambient.line"}:jc(x.alignment),[L,x.alignment]),ze=c.useCallback(M=>{me(M.target.value)},[]),_e=c.useCallback(M=>{var pe,oe;M&&M.preventDefault();const H=se.trim();if(!H){(pe=de.current)==null||pe.focus();return}ue({category:"player",label:r.player,text:H,timestamp:Date.now()}),me(""),(oe=de.current)==null||oe.focus();const ie=N(),ae=l(ie.text);ue({category:"interjection",label:r.interjection,text:ae,timestamp:Date.now()})},[ue,r.interjection,r.player,N,l,se]),Fe=c.useCallback(()=>{P.current!==null&&window.clearTimeout(P.current);const M=Math.floor(Xr+Math.random()*($c-Xr));P.current=window.setTimeout(()=>{const H=N();Date.now()>=G.current?R(H):g.current=H,Fe()},M)},[N,R]);c.useEffect(()=>{const M=window.setInterval(()=>{const H=g.current;H&&Date.now()>=G.current&&R(H)},400);return()=>window.clearInterval(M)},[R]),c.useEffect(()=>(Fe(),()=>{P.current!==null&&(window.clearTimeout(P.current),P.current=null),Z.current!==null&&(window.clearTimeout(Z.current),Z.current=null),q.current=[]}),[Fe]),c.useEffect(()=>{if(_.length<=te.current){te.current=_.length;return}_.slice(te.current).forEach(H=>{const ie=Kc(H,{battle:r.battle,dialog:r.dialog,stealth:r.stealth,broadcast:r.broadcast});le(ie)}),te.current=_.length},[r.battle,r.broadcast,r.dialog,r.stealth,_,le]),c.useEffect(()=>{const M=(u==null?void 0:u.name)??n.zoneFallback,H=[];if(u){if(u.allPrimaryComplete)H.push(n.guidancePrimaryComplete(M));else if(h){const oe=h.totalQuests>1?n.guidanceProgress(h.completedQuests??0,h.totalQuests):"";H.push(n.guidancePrimaryObjective(h.label,oe))}v&&H.push(n.guidanceSideObjective(v.label))}const ie=qc(f,n,3),ae=[n.guidanceIntro];H.length>0&&ae.push(...H),ie.length>0&&(H.length>0&&ae.push(""),ae.push(...ie));const pe=ae.join(`
`).trim();!pe||Y.current===pe||(Y.current=pe,le({category:"operation",label:r.operation,text:pe,timestamp:Date.now()}))},[r.operation,n,u,h,v,f,le]);const it=c.useCallback(M=>{if(!M)return"";try{return new Intl.DateTimeFormat(e,{hour:"2-digit",minute:"2-digit"}).format(new Date(M))}catch{return new Date(M).toLocaleTimeString()}},[e]),ot=c.useCallback(M=>{var pe;const H=n.ambientFeed,ie=x.alignment,ae=oe=>({category:"broadcast",text:oe,label:r.broadcast,timestamp:M.timestamp});switch(M.category){case"rumor":{const oe=((pe=M.lines.find(Se=>Se&&Se.trim().length>0))==null?void 0:pe.trim())??H.fallbacks.rumor,we=M.storyFunction?H.storyFunctionLabels[M.storyFunction]??M.storyFunction.replace(/-/g," ").toUpperCase():void 0;return ae(H.formatRumor({line:oe,storyLabel:we},ie))}case"signage":{const oe=M.text&&M.text.trim().length>0?M.text.trim():H.fallbacks.signage,we=M.storyFunction?H.storyFunctionLabels[M.storyFunction]??M.storyFunction.replace(/-/g," ").toUpperCase():void 0;return ae(H.formatSignage({text:oe,storyLabel:we},ie))}case"weather":{const oe=M.description&&M.description.trim().length>0?M.description.trim():H.fallbacks.weather,we=M.storyFunction?H.storyFunctionLabels[M.storyFunction]??M.storyFunction.replace(/-/g," ").toUpperCase():void 0;return ae(H.formatWeather({description:oe,storyLabel:we},ie))}case"zoneDanger":{const oe=t.levelIndicator.dangerLevels,we=M.dangerRating?oe[M.dangerRating]??M.dangerRating:H.dangerFallback,Se=M.previousDangerRating?oe[M.previousDangerRating]??M.previousDangerRating:null,Je=M.changedFlags.map(Be=>({label:H.flagLabels[Be.key]??Be.key,previous:H.formatFlagValue(Be.key,Be.previous),next:H.formatFlagValue(Be.key,Be.next)}));return ae(H.formatZoneDanger({zoneName:M.zoneName,dangerLabel:we,previousDangerLabel:Se,flagChanges:Je},ie))}case"hazardChange":{const oe=M.added.map(Se=>Se.trim()).filter(Se=>Se.length>0),we=M.removed.map(Se=>Se.trim()).filter(Se=>Se.length>0);return ae(H.formatHazards({zoneName:M.zoneName,additions:oe,removals:we},ie))}case"zoneBrief":{const oe=t.levelIndicator.dangerLevels,we=M.dangerRating?oe[M.dangerRating]??M.dangerRating:H.dangerFallback;return ae(H.formatZoneBrief({zoneName:M.zoneName,summary:M.summary??null,dangerLabel:we,hazards:M.hazards,directives:M.directives},ie))}default:return null}},[r.broadcast,n.ambientFeed,x.alignment,t.levelIndicator.dangerLevels]);c.useEffect(()=>{const M=ie=>{const ae=ie.detail;if(!ae)return;const pe=o(ae.name);le({category:"operation",label:r.operation,text:pe,timestamp:Date.now()}),re("questCompleted")},H=ie=>{const ae=ie.detail;if(!ae)return;const pe=ae.nextLevelId??`level ${ae.nextLevel}`,oe=a(pe);le({category:"operation",label:r.operation,text:oe,timestamp:Date.now()})};return window.addEventListener(jn,M),window.addEventListener(Ln,H),()=>{window.removeEventListener(jn,M),window.removeEventListener(Ln,H)}},[r.operation,a,o,le,re]),c.useEffect(()=>{const M=new Set(C.filter(ae=>ae.isCompleted).map(ae=>ae.id)),H=w.current;Array.from(M).filter(ae=>!H.has(ae)).length>0&&re("questCompleted"),w.current=M},[C,re]),c.useEffect(()=>{if(!O)return;if(!I.current){const ie=new Fc;ie.prime(O),I.current=ie;const ae={category:"zoneBrief",timestamp:Date.now(),zoneName:O.zone.zoneName,summary:O.zone.summary,dangerRating:O.zone.dangerRating??null,hazards:[...O.zone.hazards],directives:[...O.zone.directives]},pe=ot(ae);pe&&le(pe);return}const H=I.current.collect(O);H.length&&H.forEach(ie=>{const ae=ot(ie);ae&&le(ae)})},[O,ot,le]),c.useEffect(()=>{const M=S.current,H=b;if(!A){S.current=H;return}const ie=new Set([...Object.keys(H),...Object.keys(M)]),ae=Array.from(ie).some(oe=>{const we=H[oe]??0,Se=M[oe]??0;return we-Se>=20}),pe=Array.from(ie).some(oe=>{const we=H[oe]??0,Se=M[oe]??0;return we-Se<=-20});ae?re("reputationPositive"):pe&&re("reputationNegative"),S.current=H},[b,re,A]),c.useEffect(()=>{const M=j.current;(!M.inCombat&&y.inCombat||M.level!=="alarmed"&&y.globalAlertLevel==="alarmed")&&re("hostileEntered"),j.current={level:y.globalAlertLevel,inCombat:y.inCombat}},[re,y.globalAlertLevel,y.inCombat]);const lt=c.useRef(null),wt=c.useCallback(M=>{var H;M.preventDefault(),(H=de.current)==null||H.focus()},[]),Ze=c.useCallback(()=>{he.current=!0},[]),Ve=c.useCallback(()=>{he.current=!1},[]);c.useEffect(()=>{var H;const M=lt.current;M&&(M.scrollTo({top:M.scrollHeight,behavior:"smooth"}),he.current&&((H=de.current)==null||H.focus()))},[B]);const vt={id:"george-placeholder",category:"status",text:n.logEmpty,label:r.broadcast,timestamp:0,badge:"NB",tone:"broadcast"},St=B.length>0?B:[vt],ct=B.length>0,Ne=St.length-1,jt=se.trim().length===0;return s.jsxs("div",{className:"george-inline","data-controller-focus-ignore":"true",children:[s.jsx("div",{className:"george-chat",role:"log","aria-live":"polite",ref:lt,children:St.map((M,H)=>{const ie=ct&&H===Ne,ae=M.timestamp?it(M.timestamp):"";return s.jsxs("div",{className:"george-chat-entry",children:[s.jsx("div",{className:"george-chat-avatar","aria-hidden":"true",children:s.jsx(Zr,{size:32})}),s.jsxs("div",{className:`george-chat-bubble george-chat-bubble--${M.tone}${ie?" george-chat-bubble--latest":""}`,children:[s.jsxs("div",{className:"george-chat-bubble__header",children:[s.jsxs("div",{className:"george-chat-bubble__title",children:[s.jsx("span",{className:`george-chat-badge george-chat-badge--${M.tone}`,"aria-hidden":"true",children:M.badge}),s.jsx("span",{className:"george-chat-bubble__label",children:M.label})]}),ae?s.jsx("span",{className:"george-chat-bubble__time",children:ae}):null]}),s.jsx("p",{className:"george-chat-bubble__text",children:M.text})]})]},M.id)})}),s.jsxs("form",{className:"george-input-row",onSubmit:_e,children:[s.jsx(Zr,{size:36}),s.jsx("div",{className:"george-input",children:s.jsx("input",{id:"george-prompt-input",className:"george-input__field",type:"text",placeholder:i,"aria-label":d,value:se,onChange:ze,autoComplete:"off",ref:de,onFocus:Ze,onBlur:Ve})}),s.jsx("button",{type:"submit",className:"george-send-button","data-disabled":jt,"aria-label":m,onMouseDown:wt,children:s.jsx("span",{className:"george-send-icon","aria-hidden":"true",children:"↗"})})]})]})},tn=["warmth","melancholy","sarcasm","surrealism","urgency","steadiness","wit"],Qc={author:.4,persona:.4,scene:.2},Ue={sentenceLengthMean:14,sentenceLengthStdDev:4,metaphorRate:.35,fragmentPreference:.2,motifDensity:.25},Jr=tn.reduce((e,t)=>(e[t]=.5,e),{});tn.reduce((e,t)=>(e[t]={type:"number",minimum:0,maximum:1},e),{});const vn=e=>e.rhetoric?{sentenceLengthMean:e.rhetoric.sentenceLengthMean??Ue.sentenceLengthMean,sentenceLengthStdDev:e.rhetoric.sentenceLengthStdDev??Ue.sentenceLengthStdDev,metaphorRate:e.rhetoric.metaphorRate??Ue.metaphorRate,fragmentPreference:e.rhetoric.fragmentPreference??Ue.fragmentPreference,motifDensity:e.rhetoric.motifDensity??Ue.motifDensity}:{...Ue},Zc=e=>{let t=1779033703,n=3144134277,r=1013904242,a=2773480762;for(let o=0;o<e.length;o+=1){const l=e.charCodeAt(o);t=Math.imul(t^l,597399067),n=Math.imul(n^l,2869860233),r=Math.imul(r^l,951274213),a=Math.imul(a^l,2716044179)}return t=Math.imul(t^t>>>18,597399067),n=Math.imul(n^n>>>22,2869860233),r=Math.imul(r^r>>>17,951274213),a=Math.imul(a^a>>>19,2716044179),[t^n^r^a,n^t,r^t,a^t]},Jc=e=>()=>{let t=e+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296},At=e=>{const t=typeof e=="number"?e.toString(36):e,n=Zc(t),r=Jc(n[0]),a=()=>r(),o=i=>i<=0?0:Math.floor(a()*i);return{next:a,nextInt:o,pick:i=>{if(i.length===0)throw new Error("Cannot pick from an empty list.");return i[o(i.length)]}}},Pt=(e,t,n)=>Math.min(Math.max(e,t),n),ed=(e,t)=>{const n={...Qc,...e};if(!t){const a=n.author+n.persona;return a===0?{author:.5,persona:.5,scene:0}:{author:n.author/a,persona:n.persona/a,scene:0}}const r=n.author+n.persona+n.scene;return r===0?{author:.4,persona:.4,scene:.2}:{author:n.author/r,persona:n.persona/r,scene:n.scene/r}},Sn=e=>e?tn.reduce((t,n)=>{var a;const r=(a=e.traits)==null?void 0:a[n];return typeof r=="number"&&!Number.isNaN(r)?t[n]=Pt(r,0,1):t[n]=Jr[n],t},{}):{...Jr},td=(e,t,n,r)=>tn.reduce((a,o)=>{const l=t[o]??.5,i=n[o]??.5,d=r?r[o]??.5:.5,m=l*e.author+i*e.persona+d*e.scene;return a[o]=Pt(m,0,1),a},{}),nd=(e,t,n,r)=>{const a=vn(t),o=vn(n),l=r?vn(r):Ue;return{sentenceLengthMean:a.sentenceLengthMean*e.author+o.sentenceLengthMean*e.persona+l.sentenceLengthMean*e.scene,sentenceLengthStdDev:a.sentenceLengthStdDev*e.author+o.sentenceLengthStdDev*e.persona+l.sentenceLengthStdDev*e.scene,metaphorRate:a.metaphorRate*e.author+o.metaphorRate*e.persona+l.metaphorRate*e.scene,fragmentPreference:a.fragmentPreference*e.author+o.fragmentPreference*e.persona+l.fragmentPreference*e.scene,motifDensity:a.motifDensity*e.author+o.motifDensity*e.persona+l.motifDensity*e.scene}},rd=(e,t)=>{const n=[],r=Ue.sentenceLengthMean+e.melancholy*4-e.urgency*5+e.surrealism*3+e.wit*1-e.sarcasm*1,a=Pt((t.sentenceLengthMean+r)/2,6,28);Math.abs(a-t.sentenceLengthMean)>.01&&(n.push({trait:"urgency",from:t.sentenceLengthMean,to:a}),t.sentenceLengthMean=a);const o=.15+e.sarcasm*.25+e.urgency*.3-e.steadiness*.2,l=Pt((t.fragmentPreference+o)/2,0,.85);Math.abs(l-t.fragmentPreference)>.01&&(n.push({trait:"sarcasm",from:t.fragmentPreference,to:l}),t.fragmentPreference=l);const i=Ue.metaphorRate+e.surrealism*.4+e.melancholy*.2-e.urgency*.25,d=Pt((t.metaphorRate+i)/2,0,.9);return Math.abs(d-t.metaphorRate)>.01&&(n.push({trait:"surrealism",from:t.metaphorRate,to:d}),t.metaphorRate=d),n},ad=e=>Object.entries(e).reduce((t,[n,r])=>{const a=Math.max(0,r-1);return a>0&&(t[n]=a),t},{}),sd=(e,t,n)=>{switch(e.type){case"requiresTrait":return!e.trait||typeof e.threshold!="number"?!0:t[e.trait]>=e.threshold;case"forbidsTrait":return!e.trait||typeof e.threshold!="number"?!0:t[e.trait]<=e.threshold;case"maxSentenceLength":return!0;case"requiresMotif":return e.motifId?(n[e.motifId]??0)>0:!0;default:return!0}},id=(e,t,n)=>e.requiredTraits&&Object.entries(e.requiredTraits).some(([a,o])=>t[a]<o)||e.forbiddenTraits&&Object.entries(e.forbiddenTraits).some(([a,o])=>t[a]>o)?!1:e.constraints?e.constraints.every(r=>sd(r,t,n)):!0,od=(e,t,n,r)=>{var o,l;let a=1;if(e.traitWeightBoost)for(const[i,d]of Object.entries(e.traitWeightBoost))a+=(t[i]??.5)*d;return(o=n.templateBias)!=null&&o.includes(e.id)&&(a+=.75),(l=r.templateBias)!=null&&l.includes(e.id)&&(a+=.75),Math.max(a,.1)},ld=(e,t,n,r)=>{var m,f;if(e.requestedTemplateId){const u=t.templates.find(h=>h.id===e.requestedTemplateId);if(u)return u}const a=t.templates.filter(u=>id(u,n,r));if(a.length===0){const u=((m=e.persona.fallbackTemplates)==null?void 0:m[0])??((f=e.author.fallbackTemplates)==null?void 0:f[0]),h=u?t.templates.find(v=>v.id===u):void 0;if(h)return h;if(t.templates.length===0)throw new Error("No dialogue tone templates defined.");return t.templates[0]}const o=At(`${e.seed??"tone"}::template`),l=a.map(u=>({template:u,weight:od(u,n,e.author,e.persona)})),i=l.reduce((u,h)=>u+h.weight,0);let d=o.next()*i;for(const u of l){if(d<=u.weight)return u.template;d-=u.weight}return l[l.length-1].template},cd=(e,t)=>{const n=e.palettes.find(r=>r.id===t);if(!n)throw new Error(`Missing palette ${t} referenced by tone template.`);return n},dd=(e,t)=>{var n;return(n=e.lexiconOverrides)==null?void 0:n[t]},ud=(e,t,n,r)=>{var o;let a=e.weight;if(e.traitInfluence)for(const[l,i]of Object.entries(e.traitInfluence))a+=(t[l]??.5)*i;if(e.motifId){const l=r[e.motifId]??0;a-=l*.35,(o=n.motifBias)!=null&&o.includes(e.motifId)&&(a+=.5)}return Math.max(a,0)},fd=(e,t,n,r,a,o,l)=>{var x;const i=dd(r.persona,t);if(i&&i.length>0){const b=At(`${l}::override::${t}`),A=i[b.nextInt(i.length)];return{paletteId:e,entryId:"override",text:A}}const d=cd(a,e),m=At(`${l}::palette::${e}`),f=d.entries.map(b=>({entry:b,weight:ud(b,n,r.persona,o)})),u=f.reduce((b,A)=>b+A.weight,0);if(u<=0){const b=d.defaultText??((x=d.entries[0])==null?void 0:x.text);if(!b)throw new Error(`Palette ${e} has no viable entries.`);return{paletteId:e,entryId:"fallback",text:b}}let h=m.next()*u;for(const{entry:b,weight:A}of f){if(h<=A)return{paletteId:e,entryId:b.id,text:b.text};h-=A}const v=f[f.length-1].entry;return{paletteId:e,entryId:v.id,text:v.text}},md=(e,t)=>e.template.replace(/\{\{(.*?)\}\}/g,(n,r)=>{var l;const a=r.trim(),o=t[a];return o?o.text:((l=e.slots.find(i=>i.id===a))==null?void 0:l.fallback)??""}),pd=(e,t)=>{var A;const n=ed(e.weights,!!e.scene),r=Sn(e.author),a=Sn(e.persona),o=e.scene?Sn(e.scene):void 0,l=td(n,r,a,o),i=nd(n,e.author,e.persona,e.scene),d=rd(l,i),m=ad(e.motifState??{}),f=ld(e,t,l,m);!f.supportsFragments&&i.fragmentPreference>.55&&(d.push({trait:"steadiness",from:i.fragmentPreference,to:.45}),i.fragmentPreference=.45),f.maxSentenceLength&&i.sentenceLengthMean>f.maxSentenceLength&&(d.push({trait:"steadiness",from:i.sentenceLengthMean,to:f.maxSentenceLength}),i.sentenceLengthMean=f.maxSentenceLength);const u={...m},h=f.slots.reduce((C,y)=>{var B;const O=fd(y.paletteId,y.id,l,e,t,u,e.seed??"tone");C[y.id]=O;const _=(B=t.palettes.find(Q=>Q.id===y.paletteId))==null?void 0:B.entries.find(Q=>Q.id===O.entryId),L=_==null?void 0:_.motifId;return L&&(u[L]=(u[L]??0)+2),C},{}),v=md(f,h),x=e.motifState??{},b={templateId:f.id,text:v,slots:h,motifsApplied:Object.keys(u).filter(C=>(u[C]??0)>(x[C]??0))};return{traits:l,rhetoric:i,weights:n,clampLog:d,render:b,motifState:u,seed:e.seed??"tone",metadata:{authorId:e.author.id,personaId:e.persona.id,sceneId:(A=e.scene)==null?void 0:A.id,templateId:f.id}}},Nn={id:"author.vonnegut_brautigan_core",label:"Vonnegut-Brautigan Core Voice",influences:["plot.tone.guideline.1","plot.tone.guideline.2","plot.tone.guideline.7"],traits:{wit:.75,melancholy:.6,surrealism:.68,sarcasm:.55,warmth:.52,urgency:.48,steadiness:.5},rhetoric:{sentenceLengthMean:18,sentenceLengthStdDev:5,metaphorRate:.48,fragmentPreference:.22},templateBias:["template.deadpan.reassure","template.surreal.resilience"],fallbackTemplates:["template.deadpan.reassure"]},ea={id:"author.propaganda_glitch",label:"Glitched Broadcast Satire",influences:["plot.tone.guideline.4","plot.tone.guideline.2"],traits:{wit:.55,melancholy:.35,surrealism:.5,sarcasm:.7,warmth:.32,urgency:.6,steadiness:.44},rhetoric:{sentenceLengthMean:14,sentenceLengthStdDev:3,metaphorRate:.28,fragmentPreference:.32},templateBias:["template.urgent.push"],fallbackTemplates:["template.urgent.push"]},On={[Nn.id]:Nn,[ea.id]:ea},gs=Nn.id,hs=e=>On[e]??On[gs],zn={id:"persona.trace",label:"Trace (Player)",personaTags:["player","resistance"],traits:{wit:.65,warmth:.54,urgency:.62,steadiness:.4,sarcasm:.58,melancholy:.47,surrealism:.44},rhetoric:{sentenceLengthMean:14,sentenceLengthStdDev:4,fragmentPreference:.28},motifBias:["motif.streetlight","motif.rain_hum"],templateBias:["template.urgent.push","template.deadpan.reassure"],lexiconOverrides:{directive:["Keep moving like the cameras forgot you.","Drift along the blackout fringe—quiet shoes, loud mission."]}},ta={id:"persona.amara_velez",label:"Amara Velez",personaTags:["mentor","resistance"],traits:{wit:.52,warmth:.66,urgency:.48,steadiness:.68,sarcasm:.38,melancholy:.55,surrealism:.42},rhetoric:{sentenceLengthMean:17,sentenceLengthStdDev:3,fragmentPreference:.18},motifBias:["motif.compass","motif.streetlight"],templateBias:["template.deadpan.reassure","template.surreal.resilience"],lexiconOverrides:{comfort:["Breathe—we’ve lived through harsher tides.","You held the line; I’ll hold the fallout."]}},na={id:"persona.theo_anders",label:"Theo Anders",personaTags:["hacker","ally"],traits:{wit:.7,warmth:.5,urgency:.57,steadiness:.38,sarcasm:.64,melancholy:.42,surrealism:.58},rhetoric:{sentenceLengthMean:13,sentenceLengthStdDev:5,fragmentPreference:.36},motifBias:["motif.glowsticks","motif.rain_hum"],templateBias:["template.urgent.push"],lexiconOverrides:{opener:["Signal’s noisy but alive.","Console’s humming like a nervous choir."]}},ra={id:"persona.sadiq_rahm",label:"Sadiq Rahm",personaTags:["strategist","ally"],traits:{wit:.48,warmth:.4,urgency:.52,steadiness:.6,sarcasm:.46,melancholy:.58,surrealism:.36},rhetoric:{sentenceLengthMean:16,sentenceLengthStdDev:3,fragmentPreference:.22},motifBias:["motif.compass"],templateBias:["template.deadpan.reassure"],lexiconOverrides:{promise:["We bank this win, re-draw the map, hit harder tomorrow.","Blueprints shift in our favour; we keep walking."]}},Fn={[zn.id]:zn,[ta.id]:ta,[na.id]:na,[ra.id]:ra},bs=zn.id,ys=e=>Fn[e]??Fn[bs],aa={id:"scene.share_scarce_food",label:"Share Scarce Food",intent:"break bread after a risky supply run",traits:{warmth:.72,melancholy:.58,wit:.46,surrealism:.42,sarcasm:.3,urgency:.28,steadiness:.64},rhetoric:{sentenceLengthMean:17,metaphorRate:.38}},sa={id:"scene.post_ambush_reassurance",label:"Post-Ambush Reassurance",intent:"steady the squad after scraping through an ambush",traits:{warmth:.62,melancholy:.55,wit:.4,surrealism:.37,sarcasm:.34,urgency:.46,steadiness:.68},rhetoric:{sentenceLengthMean:16,fragmentPreference:.2}},ia={id:"scene.pre_heist_briefing",label:"Pre-Heist Briefing",intent:"sharpen focus during mission prep",traits:{warmth:.38,melancholy:.32,wit:.5,surrealism:.28,sarcasm:.52,urgency:.72,steadiness:.58},rhetoric:{sentenceLengthMean:14,fragmentPreference:.26}},oa={id:"scene.radio_counter_speech",label:"Counter-Broadcast Speech",intent:"mock the regime broadcast while rallying allies",traits:{warmth:.44,melancholy:.36,wit:.68,surrealism:.5,sarcasm:.74,urgency:.6,steadiness:.46},rhetoric:{sentenceLengthMean:15,sentenceLengthStdDev:4,fragmentPreference:.34}},xs={[aa.id]:aa,[sa.id]:sa,[ia.id]:ia,[oa.id]:oa},gd=e=>xs[e],hd=[{id:"template.deadpan.reassure",label:"Deadpan Reassurance",template:"{{opener}} {{comfort}} {{promise}}",supportsFragments:!1,maxSentenceLength:22,requiredTraits:{warmth:.4,steadiness:.45},traitWeightBoost:{warmth:.6,steadiness:.3,wit:.2},slots:[{id:"opener",paletteId:"palette.opener.deadpan"},{id:"comfort",paletteId:"palette.comfort.solidarity"},{id:"promise",paletteId:"palette.promise.grit"}]},{id:"template.urgent.push",label:"Urgent Push",template:"{{urgent_intro}} {{directive}}",supportsFragments:!0,maxSentenceLength:18,requiredTraits:{urgency:.55},forbiddenTraits:{warmth:.85},traitWeightBoost:{urgency:.8,wit:.2,sarcasm:.3},slots:[{id:"urgent_intro",paletteId:"palette.urgent.intro",allowFragments:!0},{id:"directive",paletteId:"palette.directive.push",allowFragments:!0}]},{id:"template.surreal.resilience",label:"Surreal Resilience",template:"{{opener}} {{surreal_image}} {{resolution}}",supportsFragments:!1,maxSentenceLength:24,requiredTraits:{surrealism:.45},traitWeightBoost:{surrealism:.9,melancholy:.4,wit:.25},slots:[{id:"opener",paletteId:"palette.opener.deadpan"},{id:"surreal_image",paletteId:"palette.surreal.image"},{id:"resolution",paletteId:"palette.resolution.resilience"}]}],bd=[{id:"palette.opener.deadpan",slotId:"opener",defaultText:"Streetlight holds.",entries:[{id:"opener.streetlight",text:"Streetlight holds.",weight:1,traitInfluence:{steadiness:.4,warmth:.2},motifId:"motif.streetlight"},{id:"opener.ashtray",text:"Ashtray smoke braids the curfew alarm.",weight:.8,traitInfluence:{melancholy:.3,surrealism:.4},motifId:"motif.rain_hum"},{id:"opener.static",text:"Static licks the PA like a bored coyote.",weight:.9,traitInfluence:{wit:.3,sarcasm:.35}}]},{id:"palette.comfort.solidarity",slotId:"comfort",defaultText:"We bend so we do not break.",entries:[{id:"comfort.breathe",text:"Breathe; the city hums but our pulse sets tempo.",weight:1,traitInfluence:{warmth:.35,steadiness:.35}},{id:"comfort.hum",text:"We hum louder than their drones tonight.",weight:.9,traitInfluence:{wit:.25,urgency:.2},motifId:"motif.rain_hum"},{id:"comfort.coffee",text:"Ration coffee still tastes like defiance.",weight:.8,traitInfluence:{wit:.3,warmth:.3}}]},{id:"palette.promise.grit",slotId:"promise",defaultText:"We bank this and push the next door.",entries:[{id:"promise.grid",text:"Map updates in our favour; we move before dawn.",weight:1,traitInfluence:{urgency:.35,steadiness:.4},motifId:"motif.compass"},{id:"promise.neon",text:"Neon farms glow for us tonight if we choose.",weight:.85,traitInfluence:{surrealism:.4,warmth:.25}},{id:"promise.ledger",text:"Ledger tilts our way; we cash it in soon.",weight:.9,traitInfluence:{wit:.2,melancholy:.2}}]},{id:"palette.urgent.intro",slotId:"urgent_intro",defaultText:"Sirens kick a four count.",entries:[{id:"urgent.metro",text:"Metro lights stutter; sweepers reroute.",weight:1,traitInfluence:{urgency:.45,surrealism:.25},motifId:"motif.glowsticks"},{id:"urgent.chopper",text:"Chopper rotors chew the humidity early.",weight:.9,traitInfluence:{urgency:.4,sarcasm:.3}},{id:"urgent.clocks",text:"Every stolen clock ticks loud right now.",weight:.85,traitInfluence:{melancholy:.25,wit:.3}}]},{id:"palette.directive.push",slotId:"directive",defaultText:"Push past the surveillance bloom.",entries:[{id:"directive.sprint",text:"Sprint the blackout seam before it seals.",weight:1,traitInfluence:{urgency:.5,wit:.2}},{id:"directive.slide",text:"Slide between floodlights like you rehearsed it.",weight:.9,traitInfluence:{steadiness:.2,wit:.35},motifId:"motif.glowsticks"},{id:"directive.smile",text:"Smile like the scanners owe you rent.",weight:.75,traitInfluence:{sarcasm:.45}}]},{id:"palette.surreal.image",slotId:"surreal_image",defaultText:"Drones drift like bored gulls.",entries:[{id:"surreal.malls",text:"Flooded malls grow neon algae halos.",weight:1,traitInfluence:{surrealism:.55,melancholy:.25},motifId:"motif.rain_hum"},{id:"surreal.balloons",text:"Propaganda balloons sag like tired saints.",weight:.9,traitInfluence:{sarcasm:.3,wit:.25}},{id:"surreal.kites",text:"Kids fly hacked drones like paper kites.",weight:.85,traitInfluence:{warmth:.3,wit:.3}}]},{id:"palette.resolution.resilience",slotId:"resolution",defaultText:"We walk out together and louder.",entries:[{id:"resolution.compass",text:"Compass north re-centers on us tonight.",weight:1,traitInfluence:{steadiness:.45,warmth:.3},motifId:"motif.compass"},{id:"resolution.lunch",text:"Save me a ration bar; we earned dessert.",weight:.8,traitInfluence:{wit:.35,warmth:.25}},{id:"resolution.rain",text:"Let the rain mask our getaway beats.",weight:.85,traitInfluence:{melancholy:.3,surrealism:.3},motifId:"motif.rain_hum"}]}],yd=()=>({authors:On,personas:Fn,scenes:xs,templates:hd,palettes:bd,motifDefaults:{"motif.streetlight":0,"motif.rain_hum":0,"motif.compass":0,"motif.glowsticks":0}}),xd=()=>hs(gs),wd=()=>ys(bs),vd=e=>gd(e),Sd=(e,t)=>e?t?{...e,...t}:e:t,Id=(e,t,n,r,a)=>`${e}::persona:${t}::author:${n}::scene:${r??"none"}::template:${a??"any"}`,kd=(e,t)=>e?{...e}:t.motifDefaults?{...t.motifDefaults}:{},Ed=(e,t,n,r)=>{const a=(n==null?void 0:n.seedKey)??r??"default";return`${e.id}:${t.id}:${a}`},Md=(e,t)=>{var n;if(t!=null&&t.personaId)return t.personaId;if((n=e.toneDefaults)!=null&&n.personaId)return e.toneDefaults.personaId};class Cd{constructor(){Ce(this,"library");Ce(this,"motifStates");Ce(this,"cache");Ce(this,"defaultAuthor",xd());Ce(this,"defaultPersona",wd());Ce(this,"resolvePersona",t=>t?ys(t):this.defaultPersona);Ce(this,"resolveShouldGenerate",t=>(t==null?void 0:t.useGenerated)!==!1);Ce(this,"reset",()=>{this.cache.clear(),this.motifStates.clear()});Ce(this,"resetDialogue",t=>{for(const n of this.cache.keys())n.startsWith(`${t}:`)&&this.cache.delete(n)});Ce(this,"resolveLine",t=>{const{dialogue:n,node:r,fallbackText:a,seedOverride:o}=t,l=Sd(n.toneDefaults,r.tone);if(!l||!this.resolveShouldGenerate(l))return{text:a,source:"fallback"};const i=l.authorId?hs(l.authorId):this.defaultAuthor,d=this.resolvePersona(Md(n,l)),m=l.sceneId?vd(l.sceneId):void 0,f=Ed(n,r,l,o),u=Id(f,d.id,i.id,m==null?void 0:m.id,l.templateId),h=this.cache.get(u);if(h)return{text:h.render.text,source:"generated",metadata:h};const v=kd(this.motifStates.get(d.id),this.library),x=pd({author:i,persona:d,scene:m,requestedTemplateId:l.templateId,seed:f,motifState:v},this.library);return this.cache.set(u,x),this.motifStates.set(d.id,x.motifState),{text:x.render.text,source:"generated",metadata:x}});this.library=yd(),this.motifStates=new Map,this.cache=new Map}}const Td=new Cd,Pd=(e,t)=>{try{const n=Ti(e);return t==="charisma"?n.dialogueThresholdBonus:0}catch(n){console.warn("[DialogueSystem] Falling back to base stats for dialogue bonus.",n);const r=Pi(e.skills);return t==="charisma"?r.dialogueThresholdBonus:0}},_d=(e,t)=>{if(!t.skillCheck)return!0;const{skill:n,threshold:r,domain:a}=t.skillCheck;if((a??"attribute")==="skill"){const m=n;return(e.skillTraining[m]??0)>=r}const l=n,i=e.skills[l],d=Pd(e,l);return Ci(i,r,d)},In={blackout:["blackout","brownout"],smog:["smog","toxic","fumes"],surveillance:["surveillance","camera","drone"]},la=["ration bricks","filtered water packs","reactive dampeners","silenced carbines","patch kits"],ca=["battery bricks","jury-rigged lanterns","hand-crank dynamos"],da=["homemade filters","charcoal respirators","sealed goggles"],ua=["signal scrubbers","anti-drone flares","masking foil"],fa=["Keep your head down; CorpSec doubled patrol rotations.","George whispered about a convoy slipping through the south gate tonight.","If you see a checkpoint scanner, go around—no one’s calibrating them right now.","Word is the resistance safehouse stashed contraband in the hollow neon signs."],Ad=[{id:"merchant.default_greeting.resistanceFriend",roleId:"merchant",templateKey:"default_greeting",summary:"Warm greeting for resistance-aligned players during regular hours.",content:"Signal's clean for you. {{highlightItem}} just landed—priced for family. {{rumorHook}}",fallbackContent:"Welcome back. Supplies are stocked.",gating:{faction:[{factionId:"resistance",minimumReputation:25}],forbiddenTimesOfDay:["night"]},tokens:[{id:"highlightItem",fallback:"Ration bricks",resolve:(e,t)=>{const n=e.world.hazards.join(" ").toLowerCase();return In.blackout.some(r=>n.includes(r))?t.pickOne(ca,ca[0]):In.smog.some(r=>n.includes(r))?t.pickOne(da,da[0]):In.surveillance.some(r=>n.includes(r))?t.pickOne(ua,ua[0]):t.pickOne(la,la[0])}},{id:"rumorHook",fallback:"Stay nimble out there.",resolve:(e,t)=>t.pickOne(fa,fa[0])}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.amara_velez",useGenerated:!0},weight:3},{id:"merchant.default_greeting.curfewUrgent",roleId:"merchant",templateKey:"default_greeting",summary:"Curt greeting while curfew is active.",content:"Curfew sirens already spun up. {{highlightItem}} on the counter—take it and bolt.",fallbackContent:"Curfew's live. Make it quick.",gating:{requireCurfewActive:!0},tokens:[{id:"highlightItem",fallback:"Emergency stim kit",resolve:(e,t)=>e.player.perks.includes("quickDraw")?"reflex chems—your speed deserves it":e.player.perks.includes("toughness")?"impact gel armor—fits right onto your plates":t.pickOne(["emergency stim kit","flashburst grenade","thermal cloak"],"emergency stim kit")}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"merchant.default_greeting.corpsecWatcher",roleId:"merchant",templateKey:"default_greeting",summary:"Wary exchange when player reputation is low with CorpSec.",content:"CorpSec sniffers are wired to sniffing you. Credits up front, {{highlightItem}} after.",fallbackContent:"No trust, no chatter—show credits.",gating:{faction:[{factionId:"corpsec",maximumReputation:-10}]},tokens:[{id:"highlightItem",fallback:"scrambler chip",resolve:(e,t)=>t.pickOne(["scrambler chip","masking foil strip","signal foam"],"scrambler chip")}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"merchant.default_greeting.genericFallback",roleId:"merchant",templateKey:"default_greeting",summary:"Default line when no other gating applies.",content:"Stock's thin but serviceable. {{highlightItem}} still on the shelves.",fallbackContent:"Limited stock today.",tokens:[{id:"highlightItem",fallback:"standard issue kits",resolve:(e,t)=>t.pickOne(["standard issue kits","bulk rations","basic medpacks"],"basic medpacks")}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},weight:1,isFallback:!0}],ma=["Keep your papers visible and your hands where the drones can see them.","If you spot a rebel courier, flag Ops immediately.","Curfew level's rising—movement passes expire at sundown.","Checkpoint scanners lag two beats; don't test them."],pa=["Orders say we hit siege level if one more rumor spikes.","CorpSec command wants names; don't make me drag you in.","We're one alert away from full lockdown."],Rd=[{id:"checkpoint_guard.default_greeting.standard",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Baseline checkpoint greeting with procedural warning.",content:"Checkpoint Delta online. {{instructionHook}}",fallbackContent:"Checkpoint active. Move along.",tokens:[{id:"instructionHook",fallback:"Stay within curfew limits.",resolve:(e,t)=>t.pickOne(ma,ma[0])}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"checkpoint_guard.default_greeting.highAlert",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Escalated warning when curfew level is high.",content:"Alert tier is {{alertTier}}. Any resistance contact gets you cuffed.",fallbackContent:"High alert. Don't test me.",gating:{environment:[{flag:"curfewLevel",minimumNumeric:2}]},tokens:[{id:"alertTier",fallback:"escalating",resolve:e=>e.world.environmentFlags.curfewLevel>=3?"siege":"escalating"}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},weight:3},{id:"checkpoint_guard.default_greeting.blackout",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Warning when blackout tier is active.",content:"Power grid's unstable; blackout tier {{blackoutTier}}. Expect spot checks.",fallbackContent:"Power grid's shaky. Expect spot checks.",gating:{environment:[{flag:"blackoutTier",allowed:["brownout","rolling"]}]},tokens:[{id:"blackoutTier",fallback:"brownout",resolve:e=>e.world.environmentFlags.blackoutTier}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"checkpoint_guard.default_greeting.crackdown",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Threatening line for hostile resistance reputation.",content:"Your face is flagged on half the scanners in this grid. {{warning}}",fallbackContent:"I've got eyes on you.",gating:{faction:[{factionId:"resistance",maximumReputation:-10}]},tokens:[{id:"warning",fallback:"Step out of line and I'm calling it in.",resolve:(e,t)=>t.pickOne(pa,pa[0])}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"checkpoint_guard.default_greeting.nightShift",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Night-time variant referencing curfew sweeps.",content:"Night shift sweep in progress. Curfew papers or back to shelter.",fallbackContent:"Curfew papers or move.",gating:{allowedTimesOfDay:["night"]},toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},isFallback:!0}],ga=["Keep wounds sealed; alley dust is lethal.","Rotating sutures hourly keeps CorpSec toxins from setting in.","Swap filters every hour—mutation spores love stagnant air.","Use the city's steam vents to sterilise gear if the clinic is compromised."],ha=["Don't stack stim packs unless you want your heart to stage a protest.","Hydrate with electrolytes after each stim; trust me, you need them.","If the stim crash hits, sleep it off. No negotiation."],Dd=[{id:"street_doc.default_greeting.resistanceAlly",roleId:"street_doc",templateKey:"default_greeting",summary:"Compassionate line for resistance allies.",content:"Clinic's running hot, but I carved out a cot for you. {{advice}}",fallbackContent:"Clinic's open for resistance blood.",gating:{faction:[{factionId:"resistance",minimumStanding:"friendly"}],forbiddenTimesOfDay:["night"]},tokens:[{id:"advice",fallback:"Stay hydrated and bandage often.",resolve:(e,t)=>t.pickOne(ga,ga[0])}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.amara_velez",useGenerated:!0},weight:2},{id:"street_doc.default_greeting.stimWarning",roleId:"street_doc",templateKey:"default_greeting",summary:"Warns players who lean on adrenaline perks.",content:"Saw your vitals spike mid-field. {{stimulantNote}}",fallbackContent:"Your vitals scream stim abuse.",gating:{forbiddenTimesOfDay:["morning"]},tokens:[{id:"stimulantNote",fallback:"Dial down the stim packs or you'll pancake.",resolve:(e,t)=>e.player.perks.includes("adrenalineRush")?t.pickOne(ha,ha[0]):"Your heart rate needs calm, not more gunfire."}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.amara_velez",useGenerated:!0}},{id:"street_doc.default_greeting.hazardClinic",roleId:"street_doc",templateKey:"default_greeting",summary:"Environmental note when hazardous clouds are active.",content:"Smog's thick tonight. I packed spare filters and anti-rad chems.",fallbackContent:"Air's poison. Use the filters.",gating:{requiredHazardKeywords:["smog","toxic","radiation"]},toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"street_doc.default_greeting.overrun",roleId:"street_doc",templateKey:"default_greeting",summary:"Terse line when curfew is active.",content:"I'm triaging patrol victims on the floor. Sit, bleed, talk later.",fallbackContent:"Busy. Sit and wait.",gating:{requireCurfewActive:!0},toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"street_doc.default_greeting.defaultFallback",roleId:"street_doc",templateKey:"default_greeting",summary:"General-purpose greeting.",content:"Slide onto the stool. Tools are clean; I made sure.",fallbackContent:"Seat's open. Let's patch you.",toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},isFallback:!0}],ba=["CorpSec squads shifted to the mag-line every half hour.","Drone lattice thins out near the collapsed tram. Use it.","Rumor says resistance cracked the western floodgate. Check it tonight.","The scavengers set a new killbox under the viaduct. Don't stray."],ya=["Step wrong and I tip off the enforcers.","You smell like CorpSec. Two words: back off.","My crew has eyes everywhere. Try nothing."],jd=[{id:"gang_scout.default_greeting.friendly",roleId:"gang_scout",templateKey:"default_greeting",summary:"Alliance tone when player reputation with scavengers is high.",content:"Scav nets flagged you green. {{intel}}",fallbackContent:"You're clear with the crew.",gating:{faction:[{factionId:"scavengers",minimumReputation:10}]},tokens:[{id:"intel",fallback:"Stick to the alleys; corp eyes are thick tonight.",resolve:(e,t)=>t.pickOne(ba,ba[0])}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"gang_scout.default_greeting.hostile",roleId:"gang_scout",templateKey:"default_greeting",summary:"Threatening line when player reputation is poor.",content:"Crew tagged you as trouble. {{warning}}",fallbackContent:"Crew doesn't trust you.",gating:{faction:[{factionId:"scavengers",maximumReputation:-5}]},tokens:[{id:"warning",fallback:"You move, we respond.",resolve:(e,t)=>t.pickOne(ya,ya[0])}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"gang_scout.default_greeting.blackoutRecon",roleId:"gang_scout",templateKey:"default_greeting",summary:"Intel drop during blackout scenarios.",content:"Blackout's blanketing the grid. Use it to ghost past scanners.",fallbackContent:"Blackout cover tonight. Move quiet.",gating:{environment:[{flag:"blackoutTier",allowed:["brownout","rolling"]}]},toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0}},{id:"gang_scout.default_greeting.nightWatch",roleId:"gang_scout",templateKey:"default_greeting",summary:"Night-only greeting referencing curfew sweeps.",content:"Night patrol spotted a CorpSec sweeper moving east. Stay in the shadows.",fallbackContent:"Night sweeps inbound. Stay sharp.",gating:{allowedTimesOfDay:["night"]},toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"gang_scout.default_greeting.fallback",roleId:"gang_scout",templateKey:"default_greeting",summary:"General-purpose line.",content:"Eyes are open. Feed me intel if you want safe passage.",fallbackContent:"Watch your angles out there.",toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},isFallback:!0}],xa=["Bunks are sanitised—don't bleed on them.","We rotate guard shifts every twenty minutes; slot in if you can.","Leave broken gear on the workbench; the techs are patching it nightly."],wa=["Food stores run dry in two days unless the next convoy lands.","Filters arrive at dawn—ration what you have left.","Ammo press needs parts; scavenge springs if you spot any."],Ld=[{id:"safehouse_handler.default_greeting.welcome",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Warm welcome when the player returns to a safehouse.",content:"Safehouse doors are sealed. {{restNote}}",fallbackContent:"Safehouse secured. Rest while you can.",tokens:[{id:"restNote",fallback:"Grab a bunk and breathe.",resolve:(e,t)=>t.pickOne(xa,xa[0])}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.amara_velez",useGenerated:!0},weight:2},{id:"safehouse_handler.default_greeting.lowSupplies",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Warns about low supplies when scarcity flag is high.",content:"Pantry's thin—{{supplyNote}}",fallbackContent:"Supplies low. Make your run count.",gating:{environment:[{flag:"supplyScarcity",allowed:["tight","rationed"]}]},tokens:[{id:"supplyNote",fallback:"stretch your rations.",resolve:(e,t)=>t.pickOne(wa,wa[0])}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0}},{id:"safehouse_handler.default_greeting.hazardShelter",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Highlights shelter when hazards are active outside.",content:"Outside's a killbox tonight. Trade routes stay closed until daybreak.",fallbackContent:"Outside is lethal right now. Stay in.",gating:{requiredHazardKeywords:["smog","radiation","patrol"]},toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0}},{id:"safehouse_handler.default_greeting.curfewShelter",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Curfew-specific shelter reminder.",content:"Curfew alarms are peaking. Lock-in lasts until morning.",fallbackContent:"Curfew locked. Sit tight.",gating:{requireCurfewActive:!0},toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0}},{id:"safehouse_handler.default_greeting.fallback",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Default handler line.",content:"We keep the lights dim and the exits mapped. Rest easy.",fallbackContent:"Safehouse steady.",toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},isFallback:!0}],Nd=[...Ad,...Rd,...Dd,...jd,...Ld],Od=Nd.reduce((e,t)=>(e[t.roleId]||(e[t.roleId]=[]),e[t.roleId].push(t),e),{}),va=1,zd=(e,t)=>{const n=t[e.flag];return!(e.allowed&&e.allowed.length>0&&!e.allowed.includes(n)||e.forbidden&&e.forbidden.includes(n)||typeof n=="number"&&(typeof e.minimumNumeric=="number"&&n<e.minimumNumeric||typeof e.maximumNumeric=="number"&&n>e.maximumNumeric))},Fd=(e,t,n)=>{try{const r=e.resolve(t,n);return n.ensure(r,e.fallback)}catch(r){return console.warn("[RoleTemplateResolver] Token resolver failed",e.id,r),e.fallback}},Bd=(e,t,n)=>{if(!e.tokens||e.tokens.length===0)return{};const r=At(`${n}::${e.id}::tokens`),a={rng:()=>r.next(),pickOne:(o,l)=>!o||o.length===0?l:o[r.nextInt(o.length)],ensure:(o,l)=>o&&o.trim().length>0?o:l};return e.tokens.reduce((o,l)=>(o[l.id]=Fd(l,t,a),o),{})},Sa=(e,t)=>e?e.replace(/{{\s*([\w.]+)\s*}}/g,(n,r)=>{const a=t[r];return typeof a=="string"&&a.length>0?a:n}):"",Hd=(e,t,n)=>!(t&&t.some(r=>!e.includes(r))||n&&n.some(r=>e.includes(r))),Wd=(e,t)=>e.reputationSystemsEnabled===!1||!t||t.length===0?!0:t.every(n=>{var o;const r=((o=e.player.factionReputation)==null?void 0:o[n.factionId])??0;if(typeof n.minimumReputation=="number"&&r<n.minimumReputation||typeof n.maximumReputation=="number"&&r>n.maximumReputation)return!1;const a=Hn(r);if(n.minimumStanding){const l=bt(a.id),i=bt(n.minimumStanding);if(l<i)return!1}if(n.maximumStanding){const l=bt(a.id),i=bt(n.maximumStanding);if(l>i)return!1}return!0}),$d=(e,t,n)=>!(t&&t.length>0&&!t.every(a=>e.some(o=>o.toLowerCase().includes(a.toLowerCase())))||n&&n.length>0&&n.some(a=>e.some(o=>o.toLowerCase().includes(a.toLowerCase())))),Ud=(e,t)=>{const n=e.gating;if(!n)return!0;const{world:r,player:a,npc:o}=t;if(!Wd(t,n.faction)||!Hd(a.perks??[],n.requiresPerkIds,n.forbiddenPerkIds)||n.allowedTimesOfDay&&n.allowedTimesOfDay.length>0&&!n.allowedTimesOfDay.includes(r.timeOfDay)||n.forbiddenTimesOfDay&&n.forbiddenTimesOfDay.includes(r.timeOfDay)||typeof n.requireCurfewActive=="boolean"&&n.requireCurfewActive!==r.curfewActive||typeof n.forbidCurfewActive=="boolean"&&n.forbidCurfewActive===r.curfewActive||!$d(r.hazards??[],n.requiredHazardKeywords,n.forbiddenHazardKeywords)||n.environment&&n.environment.length>0&&!n.environment.every(i=>zd(i,r.environmentFlags)))return!1;if(n.requiredNpcTags&&n.requiredNpcTags.length>0){const l=(o==null?void 0:o.tags)??[];if(!n.requiredNpcTags.every(d=>l.includes(d)))return!1}if(n.forbiddenNpcTags&&n.forbiddenNpcTags.length>0){const l=(o==null?void 0:o.tags)??[];if(n.forbiddenNpcTags.some(i=>l.includes(i)))return!1}return!(n.requiredZoneIds&&n.requiredZoneIds.length>0&&!n.requiredZoneIds.includes(r.zoneId))},Gd=(e,t)=>{if(!e.length)return null;if(e.length===1)return e[0];const n=At(`${t}::templatePick`),r=e.reduce((o,l)=>o+(l.weight??va),0);let a=n.next()*r;for(const o of e)if(a-=o.weight??va,a<=0)return o;return e[n.nextInt(e.length)]},Vd=(e,t)=>{const n=Od[e];return n?n.filter(r=>r.templateKey===t):[]},qd=e=>{const{roleId:t,templateKey:n,context:r}=e,a=Vd(t,n);if(a.length===0)return console.warn("[RoleTemplateResolver] Missing templates for role",t,"template",n),null;const o=a.filter(v=>Ud(v,r)),l=o.length>0?o:a.filter(v=>v.isFallback)||a,i=e.seedOverride??r.randomSeed??`${t}:${n}`,d=Gd(l,i)??l[0],m=`${i}::${d.seedHint??d.id}`,f=Bd(d,r,m),u=Sa(d.content,f),h=Sa(d.fallbackContent,f);return{templateId:d.id,roleId:t,text:u,fallbackText:h,tokens:f,seed:m,toneOverrides:d.toneOverrides,metadata:d.metadata}},Ia=e=>e.charAt(0).toUpperCase()+e.slice(1),Yd=/^\[roleTemplate:([a-zA-Z0-9_]+)\.([a-zA-Z0-9_]+)\]$/i,ka={resistance:0,corpsec:0,scavengers:0},kn=e=>e.objectives.some(t=>t.type!=="talk"&&!t.isCompleted),Kd=e=>{if(!e)return null;const t=e.trim(),n=Yd.exec(t);if(!n)return null;const[,r,a]=n;return{roleId:r,templateKey:a}},Xd=()=>{const e=je(),t=E(g=>g.quests.quests),n=E(g=>g.settings.locale),r=E(g=>!!g.settings.reputationSystemsEnabled),a=Qe(n),o=Pe(n),{logs:l}=a,i=E(g=>g.player.data),d=E(g=>g.world),[m,f]=Rt.useState(null),u=(g,w="attribute")=>{if(w==="skill")try{return ji(g).name}catch(S){return console.warn("[DialogueOverlay] Missing skill definition for",g,S),Ia(g)}return o.skills[g]??Ia(g)},h=c.useCallback(g=>{const w=t.find(j=>j.id===g);if(!w)return;let S=!1;if(w.rewards.forEach(j=>{switch(j.type){case"experience":j.amount>0&&(e(_n({amount:j.amount,reason:`Quest complete: ${w.name}`})),e(F(l.rewardExperience(j.amount,w.name))),S=!0);break;case"currency":j.amount>0&&(e(_i(j.amount)),e(F(l.rewardCredits(j.amount,w.name))));break;case"item":if(j.id){const P=Math.max(1,j.amount||1);for(let I=0;I<P;I+=1){const Y={id:$e(),name:j.id,description:o.dialogueOverlay.itemRecoveredDescription(w.name),weight:1,value:0,isQuestItem:!1};e(Oa(Y))}e(F(l.rewardItem(j.id,w.name)))}break}}),!S){const j=Math.max(40,(w.objectives.length||1)*30);e(_n({amount:j,reason:`Quest complete: ${w.name}`})),e(F(l.rewardExperience(j,w.name)))}},[e,t,l,o]),v=c.useCallback(g=>{if(!g.questEffect)return;const{questId:w,effect:S,objectiveId:j}=g.questEffect;switch(S){case"start":{const P=t.find(I=>I.id===w);P&&!P.isActive&&!P.isCompleted&&(e(za(w)),e(F(l.questAccepted(P.name))))}break;case"complete":{const P=t.find(I=>I.id===w);if(P&&P.isActive&&!P.isCompleted){if(kn(P))break;e(Ri(w)),h(w),e(F(l.questCompleted(P.name)))}}break;case"update":if(j){e(Ai({questId:w,objectiveId:j,isCompleted:!0}));const P=t.find(Y=>Y.id===w),I=P==null?void 0:P.objectives.find(Y=>Y.id===j);P&&I&&e(F(l.objectiveUpdated(I.description,P.name)))}break}},[e,h,t,l]),{activeDialogue:{dialogueId:x,currentNodeId:b},dialogues:A}=E(g=>g.quests),C=c.useMemo(()=>x?A.find(g=>g.id===x)??null:null,[x,A]),y=c.useMemo(()=>!C||C.nodes.length===0?null:C.nodes.find(w=>w.id===b)??C.nodes[0],[C,b]),O=c.useMemo(()=>{var I,Y,te;if(!C||!y)return null;const g=C.nodes.find(de=>de.id===y.id)??y;let w=g.text,S=g,j;const P=Kd(g.text);if(P&&i&&d){const de=P.roleId,{templateKey:he}=P,q={level:i.level,perks:i.perks??[],factionReputation:r?i.factionReputation??ka:ka},Z={locale:n,reputationSystemsEnabled:r,player:q,world:{timeOfDay:d.timeOfDay,curfewActive:d.curfewActive,zoneId:((I=d.currentMapArea)==null?void 0:I.zoneId)??"unknown_zone",zoneName:(Y=d.currentMapArea)==null?void 0:Y.name,hazards:((te=d.currentMapArea)==null?void 0:te.hazards)??[],environmentFlags:d.environment.flags},npc:void 0,randomSeed:`${C.id}:${g.id}`},ce=qd({roleId:de,templateKey:he,context:Z});ce&&(w=ce.text,j=ce.seed,S={...g,text:ce.text,tone:{...g.tone??{},...ce.toneOverrides??{}}})}return{dialogue:C,node:S,fallbackText:w,seedOverride:j}},[C,y,n,i,d,r]),_=c.useMemo(()=>O?Td.resolveLine({dialogue:O.dialogue,node:O.node,fallbackText:O.fallbackText,seedOverride:O.seedOverride}):null,[O]),L=c.useCallback(g=>{if(!g.questEffect)return null;const w=t.find(S=>{var j;return S.id===((j=g.questEffect)==null?void 0:j.questId)});if(!w)return null;switch(g.questEffect.effect){case"start":if(w.isCompleted)return"alreadyCompleted";if(w.isActive)return"alreadyActive";break;case"complete":if(w.isCompleted)return"alreadyCompleted";if(!w.isActive)return"notActive";if(kn(w))return"objectivesIncomplete";break;case"update":if(g.questEffect.objectiveId){const S=w.objectives.find(j=>{var P;return j.id===((P=g.questEffect)==null?void 0:P.objectiveId)});if(S!=null&&S.isCompleted)return"objectiveCompleted"}break}return null},[t]),B=c.useCallback(g=>{if(!g.questEffect)return!0;const w=t.find(S=>{var j;return S.id===((j=g.questEffect)==null?void 0:j.questId)});if(!w)return!1;switch(g.questEffect.effect){case"start":return!w.isActive&&!w.isCompleted;case"complete":return w.isActive&&!w.isCompleted&&!kn(w);case"update":return!w.isActive||w.isCompleted?!1:g.questEffect.objectiveId?!w.objectives.some(S=>{var j;return S.id===((j=g.questEffect)==null?void 0:j.objectiveId)&&S.isCompleted}):!0;default:return!0}},[t]),Q=c.useCallback(g=>L(g)?!0:g.skillCheck?!_d(i,g):!1,[L,i]),se=c.useMemo(()=>y?y.options.filter(B):[],[y,B]),me=c.useCallback(g=>{Q(g)||(v(g),g.nextNodeId?e(Di(g.nextNodeId)):e(Kt()))},[e,v,Q]);if(c.useEffect(()=>{if(!y)return;const g=S=>{var Y;if(S.target instanceof HTMLElement&&(S.target.tagName==="INPUT"||S.target.tagName==="TEXTAREA"||S.target.getAttribute("contenteditable")==="true"))return;let j=null;if(/^[0-9]$/.test(S.key))j=Number(S.key);else if((Y=S.code)!=null&&Y.startsWith("Numpad")){const te=Number(S.code.replace("Numpad",""));j=Number.isNaN(te)?null:te}if(j===null||j<1)return;const P=j-1,I=se[P];I&&(S.preventDefault(),S.stopPropagation(),typeof S.stopImmediatePropagation=="function"&&S.stopImmediatePropagation(),me(I))},w={capture:!0};return window.addEventListener("keydown",g,w),()=>{window.removeEventListener("keydown",g,w)}},[y,me,se]),!x||!C||!y)return null;const G=(_==null?void 0:_.text)??(y==null?void 0:y.text)??"...";return s.jsx("div",{style:{position:"absolute",inset:0,display:"flex",alignItems:"flex-end",justifyContent:"center",pointerEvents:"none"},children:s.jsxs("div",{style:{width:"min(620px, 90%)",marginBottom:"calc(var(--bottom-panel-height, 0px) + 2.5rem)",background:"linear-gradient(160deg, rgba(15, 23, 42, 0.94), rgba(15, 23, 42, 0.78))",border:"1px solid rgba(148, 163, 184, 0.35)",borderRadius:"18px",padding:"1.5rem 1.7rem",color:"#e2e8f0",fontFamily:"'DM Sans', 'Inter', sans-serif",boxShadow:"0 28px 48px rgba(15, 23, 42, 0.55)",pointerEvents:"auto",display:"flex",flexDirection:"column",gap:"1.2rem"},children:[s.jsxs("div",{children:[s.jsx("span",{style:{display:"block",fontSize:"0.72rem",letterSpacing:"0.28em",textTransform:"uppercase",color:"rgba(148, 163, 184, 0.85)",marginBottom:"0.35rem"},children:C.npcId}),s.jsx("h2",{style:{fontSize:"1.28rem",fontWeight:700,margin:0,color:"#f8fafc"},children:G})]}),s.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"0.75rem"},children:se.map((g,w)=>{const S=Q(g),j=g.skillCheck?`${u(g.skillCheck.skill,g.skillCheck.domain??"attribute")} ${g.skillCheck.threshold}`:null,P=L(g),I=P?o.dialogueOverlay.questLocks[P]:j?S?o.dialogueOverlay.requiresSkill(j):o.dialogueOverlay.checkSkill(j):null;return s.jsxs("button",{type:"button",onClick:()=>me(g),onMouseEnter:()=>!S&&f(w),onMouseLeave:()=>f(null),style:{border:S?"1px solid rgba(148, 163, 184, 0.3)":m===w?"1px solid rgba(96, 165, 250, 0.7)":"1px solid rgba(96, 165, 250, 0.4)",borderRadius:"12px",padding:"0.85rem 1rem",background:S?"linear-gradient(135deg, rgba(15, 23, 42, 0.65), rgba(30, 41, 59, 0.75))":m===w?"linear-gradient(135deg, rgba(37, 99, 235, 0.35), rgba(56, 189, 248, 0.3))":"linear-gradient(135deg, rgba(37, 99, 235, 0.22), rgba(56, 189, 248, 0.18))",color:S?"rgba(148, 163, 184, 0.8)":"#e2e8f0",fontSize:"0.9rem",textAlign:"left",cursor:S?"not-allowed":"pointer",display:"flex",gap:"0.6rem",alignItems:"center",opacity:S?.75:1,pointerEvents:S?"none":"auto",boxShadow:S?"none":m===w?"0 0 20px rgba(56, 189, 248, 0.4), 0 4px 12px rgba(0, 0, 0, 0.3)":"0 0 8px rgba(56, 189, 248, 0.15)",transform:m===w&&!S?"translateY(-2px)":"translateY(0)",transition:"all 0.2s cubic-bezier(0.4, 0, 0.2, 1)"},children:[s.jsx("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:"1.25rem",height:"1.25rem",borderRadius:"50%",background:S?"rgba(148, 163, 184, 0.25)":"rgba(96, 165, 250, 0.35)",color:S?"#cbd5f5":"#bfdbfe",fontWeight:600,fontSize:"0.75rem"},children:w+1}),s.jsx("span",{style:{flex:1},children:g.text}),I&&s.jsx("span",{style:{fontSize:"0.68rem",textTransform:"uppercase",letterSpacing:"0.16em",color:S?"#f87171":"#5eead4"},children:I})]},`${g.text}-${w}`)})}),s.jsx("span",{style:{fontSize:"0.68rem",color:"rgba(148, 163, 184, 0.7)",textAlign:"right",letterSpacing:"0.22em",textTransform:"uppercase"},children:o.dialogueOverlay.escHint})]})})},Qd=(...e)=>e.filter(Boolean).join(" "),Zd=({showCompleted:e=!1})=>{const t=E(x=>x.quests.quests),n=E(x=>x.settings.locale),r=Pe(n),a=t.filter(x=>x.isActive&&!x.isCompleted),o=t.filter(x=>x.isCompleted).sort((x,b)=>x.name.localeCompare(b.name)),l=e?o:o.slice(0,1),i=a.length>0,d=e?l.length>0:!1,m=e?a.length+l.length>2:a.length>1,f=(x,b)=>x<=0?null:n==="en"?x>1?`${x} ${b}s`:`${x} ${b}`:`${x} ${b}`,u=x=>{const b=t.find(_=>_.id===x);if(!b)return null;const A=b.rewards.filter(_=>_.type==="currency").reduce((_,L)=>_+L.amount,0),C=b.rewards.filter(_=>_.type==="experience").reduce((_,L)=>_+L.amount,0),y=b.rewards.filter(_=>_.type==="item"),O=[A?r.questLog.currencyLabel(A):null,C?r.questLog.experienceLabel(C):null,...y.map(_=>f(Math.max(1,_.amount||1),_.id??r.questLog.supplyFallback))].filter(Boolean);return O.length===0?null:s.jsxs("div",{className:"text-[0.68rem] uppercase tracking-[0.18em] text-[#34d399]",children:[r.questLog.rewardsHeading,": ",O.join(" • ")]})},h=x=>s.jsxs("div",{className:"hud-ops-card hud-ops-card--active flex flex-col gap-3.5 p-[0.95rem]",children:[s.jsx("div",{className:"text-[0.92rem] font-semibold tracking-[0.08em] text-slate-50",children:x.name}),s.jsx("p",{className:"hud-ops-text-muted text-[0.78rem] leading-[1.55]",children:x.description}),s.jsx("div",{className:"flex flex-col gap-3",children:x.objectives.map(b=>s.jsxs("div",{className:"flex items-start gap-[0.55rem] text-[0.76rem] text-[#cbd5f5]",children:[s.jsx("span",{"aria-hidden":"true",className:"hud-ops-objective-check mt-[2px]","data-completed":b.isCompleted,children:"✓"}),s.jsx("span",{className:"flex-1 leading-tight",children:b.description}),b.count&&s.jsxs("span",{className:"text-[0.65rem] uppercase tracking-[0.16em] text-[#facc15]",children:[b.currentCount??0,"/",b.count]})]},b.id))}),u(x.id)]},x.id),v=x=>s.jsxs("div",{className:"hud-ops-card hud-ops-card--completed flex flex-col gap-3.5 p-[0.9rem]",children:[s.jsxs("div",{className:"flex items-center justify-between gap-[0.75rem]",children:[s.jsx("div",{className:"text-[0.85rem] font-semibold tracking-[0.05em] text-[#ede9fe]",children:x.name}),s.jsx("span",{"aria-hidden":"true",className:"hud-ops-complete-badge inline-flex h-[1.25rem] w-[1.25rem] items-center justify-center rounded-[0.35rem] text-[0.78rem] font-bold",children:"✓"})]}),s.jsx("p",{className:"hud-ops-text-muted text-[0.74rem] leading-[1.6]",children:x.description})]},x.id);return!i&&!d?s.jsx("div",{className:"hud-ops-empty flex flex-1 items-center justify-center text-xs italic",children:r.questLog.empty}):s.jsxs("div",{className:Qd("flex flex-col gap-3.5 pr-1",m?"overflow-y-auto":"overflow-y-hidden"),children:[i&&a.map(x=>h(x)),e&&d&&l.map(x=>v(x))]})},Ea=Rt.memo(Zd),Jt={cyan:"#38bdf8",textPrimary:"#f8fafc",textSecondary:"rgba(226, 232, 240, 0.78)",textMuted:"rgba(148, 163, 184, 0.72)"},Af={background:"rgba(15, 23, 42, 0.6)",borderRadius:"12px",border:"1px solid rgba(148, 163, 184, 0.18)",padding:"0.8rem",boxShadow:"inset 0 1px 0 rgba(148, 163, 184, 0.18)"},Rf={display:"flex",flexDirection:"column",gap:"0.14rem"},Df={fontSize:"0.52rem",letterSpacing:"0.19em",textTransform:"uppercase",color:"rgba(148, 163, 184, 0.72)"},jf={fontSize:"0.72rem",fontWeight:600,letterSpacing:"0.05em",color:"#f8fafc",margin:0},Lf={fontFamily:'"DM Sans", "Inter", sans-serif',fontSize:"0.85rem",fontWeight:700,color:Jt.textPrimary},Nf={fontFamily:'"DM Sans", "Inter", sans-serif',fontSize:"0.62rem",color:Jt.textMuted},Of=(e,t)=>({background:`linear-gradient(135deg, ${e}, ${t})`,WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text"}),Jd=(e,t=8)=>({textShadow:`0 0 ${t}px ${e}, 0 0 ${t*2}px ${e}40`}),Ma=24,eu=e=>{if(!e)return null;const t=e.canvasDisplayWidth/(e.canvasWidth||1),n=e.canvasDisplayHeight/(e.canvasHeight||1);return{x:e.canvasLeft+e.screenX*t,y:e.canvasTop+e.screenY*n}},tu=()=>{const[e,t]=c.useState(null),n=c.useRef(null),r=c.useCallback(a=>{n.current=a;const o=eu(a);o&&t(o)},[]);return c.useEffect(()=>{if(typeof window<"u"){const a=window.__getawayPlayerScreenPosition;a&&r(a)}},[r]),c.useEffect(()=>{const a=o=>{r(o.detail)};return window.addEventListener(Xt,a),()=>window.removeEventListener(Xt,a)},[r]),c.useEffect(()=>{const a=()=>{n.current&&r(n.current)};return window.addEventListener("resize",a),()=>window.removeEventListener("resize",a)},[r]),e},nu=({notification:e,onComplete:t})=>{const[n,r]=c.useState(!1);c.useEffect(()=>{const i=setTimeout(()=>r(!0),10),d=setTimeout(()=>{r(!1),setTimeout(()=>t(e.id),200)},2200);return()=>{clearTimeout(i),clearTimeout(d)}},[e.id,t]);const a={display:"inline-flex",alignItems:"center",gap:"0.28rem",padding:"0.28rem 0.45rem",minWidth:"fit-content",background:"linear-gradient(150deg, rgba(7, 13, 26, 0.92) 0%, rgba(12, 148, 136, 0.58) 100%)",border:"1px solid rgba(56, 189, 248, 0.45)",borderRadius:"999px",boxShadow:"0 10px 18px -16px rgba(13, 148, 136, 0.55)",opacity:n?1:0,transform:n?"translateY(0)":"translateY(10px)",transition:"opacity 0.18s ease-out, transform 0.18s ease-out",pointerEvents:"none"},o={fontSize:"0.9rem",fontWeight:800,letterSpacing:"0.16em",textTransform:"uppercase",color:Jt.textPrimary,...Jd(Jt.cyan,6)},l={fontSize:"0.55rem",fontWeight:700,letterSpacing:"0.24em",textTransform:"uppercase",color:"rgba(148, 233, 255, 0.92)"};return s.jsxs("div",{style:a,children:[s.jsxs("span",{style:o,children:["+",e.amount]}),s.jsx("span",{style:l,children:"XP"})]})},ru=({notifications:e,onDismiss:t})=>{const n=tu(),r=c.useMemo(()=>({right:28,top:72}),[]);return s.jsx(s.Fragment,{children:e.map((a,o)=>{const l=n&&typeof window<"u"?(()=>{const i=(v,x,b)=>Math.min(Math.max(v,x),b),d=window.innerWidth||r.right*2,m=window.innerHeight||r.top*2,f=i(n.x,24,d-24),u=i(n.y,24,m-24),h=i(u-56-o*Ma,16,m-16);return{position:"fixed",left:f,top:h,transform:"translateX(-50%)",zIndex:9998,pointerEvents:"none"}})():{position:"fixed",right:`${r.right}px`,top:`${r.top+o*Ma}px`,zIndex:9998,pointerEvents:"none"};return s.jsx("div",{style:l,children:s.jsx(nu,{notification:a,onComplete:t})},a.id)})})},au=()=>{const{currentMapArea:e,inCombat:t,engagementMode:n}=E(h=>h.world),r=E(h=>h.surveillance.hud),a=E(h=>!!h.settings.reputationSystemsEnabled),o=E(h=>h.world.currentMapArea.zoneId),l=E(h=>{var v;return a?(v=h.suspicion.zones[o])==null?void 0:v.heat:void 0}),[i,d]=c.useState(()=>new Date),m=n==="stealth",f=n==="dialog",u=c.useMemo(()=>{const h=(r==null?void 0:r.detectionProgress)??0,v=(l==null?void 0:l.totalHeat)??0,x=Math.max(0,Math.min(100,Math.round(v)));return Math.max(h,x)},[r==null?void 0:r.detectionProgress,l==null?void 0:l.totalHeat]);return c.useEffect(()=>{const h=window.setInterval(()=>d(new Date),1e3);return()=>window.clearInterval(h)},[]),s.jsxs("div",{className:"pointer-events-none absolute inset-0 select-none font-mono uppercase tracking-[0.18em] text-[#38bdf8]",children:[s.jsx("div",{className:"hud-corner","data-position":"top-left"}),s.jsx("div",{className:"hud-corner","data-position":"top-right"}),s.jsx("div",{className:"hud-corner","data-position":"bottom-right"}),s.jsx("div",{className:"hud-corner","data-position":"bottom-left"}),s.jsxs("div",{className:"hud-frame-top",children:[s.jsxs("div",{className:"hud-frame-chip","data-state":t?"alert":m?"stealth":"idle",children:[s.jsx("span",{className:"text-[0.45rem]",children:"●"}),s.jsx("span",{children:t?"COMBAT":m?"STEALTH":f?"DIALOG":"TACTICAL"})]}),s.jsxs("div",{className:"hud-frame-chip",children:[s.jsx("span",{children:"LOC"}),s.jsx("span",{className:"text-slate-100",children:(e==null?void 0:e.id)??"UNKNOWN"})]}),s.jsx("div",{className:"hud-frame-chip",children:s.jsx("span",{children:i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"})})})]}),s.jsx("div",{className:"hud-threat","data-alert":t?"true":"false",children:m?s.jsxs("span",{children:["DETECTION: ",u,"%"]}):f?s.jsx(s.Fragment,{children:"DIALOG MODE ACTIVE"}):s.jsxs(s.Fragment,{children:["THREAT LEVEL: ",t?"HOSTILE":"CLEAR"]})}),s.jsx("div",{className:"hud-frame-line","data-orientation":"top"}),s.jsx("div",{className:"hud-frame-line","data-orientation":"bottom"})]})},su=({value:e,gridX:t,gridY:n,type:r,label:a,onComplete:o})=>{const[l,i]=c.useState(!0),[d,m]=c.useState(null),f=c.useRef(null),u=E(y=>y.player.data.position),h=c.useCallback(y=>{if(!y)return;f.current=y;const O=t-u.x,_=n-u.y,L=64,B=L,Q=L/2,se=(O-_)*(B/2),me=(O+_)*(Q/2),G=y.worldX+se,g=y.worldY+me,w=y.worldX-y.screenX/y.zoom,S=y.worldY-y.screenY/y.zoom,j=(G-w)*y.zoom,P=(g-S)*y.zoom,I=y.canvasDisplayWidth/y.canvasWidth,Y=y.canvasDisplayHeight/y.canvasHeight,te=y.canvasLeft+j*I,de=y.canvasTop+P*Y;m({x:te,y:de})},[t,n,u.x,u.y]);if(c.useEffect(()=>{if(typeof window<"u"){const y=window.__getawayPlayerScreenPosition;y&&h(y)}},[h]),c.useEffect(()=>{const y=O=>{h(O.detail)};return window.addEventListener(Xt,y),()=>window.removeEventListener(Xt,y)},[h]),c.useEffect(()=>{const y=setTimeout(()=>{i(!1),o==null||o()},1500);return()=>clearTimeout(y)},[o]),!l||!d)return null;const x=(()=>{switch(r){case"damage":return{color:"#ef4444",glow:"rgba(239, 68, 68, 0.8)",prefix:"-",scale:1};case"heal":return{color:"#34d399",glow:"rgba(52, 211, 153, 0.8)",prefix:"+",scale:1};case"crit":return{color:"#fbbf24",glow:"rgba(251, 191, 36, 0.9)",prefix:"-",scale:1.4};case"miss":return{color:"#94a3b8",glow:"rgba(148, 163, 184, 0.6)",prefix:"",scale:.9};case"block":return{color:"#38bdf8",glow:"rgba(56, 189, 248, 0.8)",prefix:"",scale:1};case"pickup":return{color:"#22d3ee",glow:"rgba(34, 211, 238, 0.85)",prefix:"+",scale:1.05};default:return{color:"#ffffff",glow:"rgba(255, 255, 255, 0.6)",prefix:"",scale:1}}})(),b=r==="miss"?"MISS":r==="block"?"BLOCK":r==="pickup"?`PICKED UP: ${e>1?`${e}x `:""}${a??(e===1?"ITEM":"ITEMS")}`:`${x.prefix}${e}`,A={position:"fixed",left:`${d.x}px`,top:`${d.y}px`,transform:"translate(-50%, -100%)",pointerEvents:"none",userSelect:"none",zIndex:1e4,animation:"floatUp 1.5s cubic-bezier(0.4, 0, 0.2, 1) forwards"},C={fontSize:`${1.2*x.scale}rem`,fontWeight:r==="crit"?900:800,color:x.color,textShadow:`0 0 12px ${x.glow}, 0 0 6px ${x.glow}, 0 2px 4px rgba(0, 0, 0, 0.8)`,fontFamily:'"DM Mono", "IBM Plex Mono", monospace',letterSpacing:"0.05em",WebkitTextStroke:r==="crit"?`1px ${x.color}dd`:"none"};return s.jsxs(s.Fragment,{children:[s.jsx("style",{children:`
        @keyframes floatUp {
          0% {
            transform: translateY(0) scale(${x.scale*.8});
            opacity: 0;
          }
          20% {
            opacity: 1;
          }
          100% {
            transform: translateY(-60px) scale(${x.scale});
            opacity: 0;
          }
        }
      `}),s.jsx("div",{style:A,children:s.jsx("span",{style:C,children:b})})]})},iu=({active:e,type:t="damage",intensity:n=.6,duration:r=300})=>{const[a,o]=c.useState(!1);if(c.useEffect(()=>{if(e){o(!0);const m=setTimeout(()=>{o(!1)},r);return()=>clearTimeout(m)}},[e,r]),!a)return null;const d={...{position:"absolute",inset:0,pointerEvents:"none",zIndex:9999,animation:`hitFlash ${r}ms ease-out forwards`},...(()=>{switch(t){case"damage":return{background:`radial-gradient(circle at center, rgba(239, 68, 68, ${Math.max(0,n*.22)}) 0%, rgba(239, 68, 68, 0) 65%)`,mixBlendMode:"screen"};case"heal":return{background:`rgba(52, 211, 153, ${n})`,mixBlendMode:"lighten"};case"crit":return{background:`rgba(251, 191, 36, ${n*.8})`,mixBlendMode:"screen"};case"block":return{background:`rgba(56, 189, 248, ${n*.7})`,mixBlendMode:"screen"};default:return{background:`rgba(255, 255, 255, ${n})`,mixBlendMode:"screen"}}})()};return s.jsxs(s.Fragment,{children:[s.jsx("style",{children:`
        @keyframes hitFlash {
          0% {
            opacity: 1;
          }
          100% {
            opacity: 0;
          }
        }
      `}),s.jsx("div",{style:d})]})},ou=()=>{const e=je(),{floatingNumbers:t,activeFlashId:n,hitFlashes:r}=E(o=>o.combatFeedback),a=r.find(o=>o.id===n);return s.jsxs(s.Fragment,{children:[a&&s.jsx(iu,{active:!0,type:a.type,intensity:a.intensity,duration:a.duration}),t.map(o=>s.jsx(su,{value:o.value,gridX:o.gridX,gridY:o.gridY,type:o.type,label:o.label,onComplete:()=>e(Li(o.id))},o.id))]})},lu=e=>{switch(e){case ee.ALARMED:return{label:"ALARMED",intent:"alarmed"};case ee.SUSPICIOUS:return{label:"SUSPICIOUS",intent:"suspicious"};case ee.DISABLED:return{label:"DISABLED",intent:"disabled"};case ee.IDLE:default:return{label:"SPY ACTIVITY",intent:"idle"}}},cu=`
  .camera-wafer {
    --accent: rgba(60, 199, 255, 0.75);
    --accent-border: rgba(56, 189, 248, 0.42);
    --accent-shadow: rgba(56, 189, 248, 0.32);
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    min-width: 14.5rem;
    padding: 0.55rem 0.85rem;
    width: 14.5rem;
    border-radius: 12px;
    background: linear-gradient(135deg, rgba(14, 19, 31, 0.96), rgba(17, 24, 39, 0.84));
    border: 1px solid var(--accent-border);
    box-shadow: 0 16px 28px rgba(8, 12, 20, 0.52);
    color: #e2e8f0;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    font-family: 'DM Mono', 'IBM Plex Mono', monospace;
    pointer-events: none;
    overflow: hidden;
  }

  .camera-wafer::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(120deg, rgba(56, 189, 248, 0.12), transparent 42%);
    opacity: 0.45;
    mix-blend-mode: screen;
    pointer-events: none;
  }

  .camera-wafer[data-alert="suspicious"] {
    --accent: rgba(251, 191, 36, 0.82);
    --accent-border: rgba(251, 191, 36, 0.4);
    --accent-shadow: rgba(251, 191, 36, 0.28);
    --accent-spark: rgba(251, 191, 36, 0.6);
  }

  .camera-wafer[data-alert="alarmed"] {
    --accent: rgba(239, 68, 68, 0.78);
    --accent-border: rgba(239, 68, 68, 0.5);
    --accent-shadow: rgba(239, 68, 68, 0.32);
    --accent-spark: rgba(239, 68, 68, 0.64);
  }

  .camera-wafer[data-alert="disabled"] {
    --accent: rgba(148, 163, 184, 0.55);
    --accent-border: rgba(148, 163, 184, 0.35);
    --accent-shadow: rgba(148, 163, 184, 0.24);
    --accent-spark: rgba(148, 163, 184, 0.42);
  }

  .camera-wafer[data-overlay="true"] {
    box-shadow: 0 16px 30px rgba(11, 25, 45, 0.58), 0 0 18px var(--accent-shadow);
  }

  .camera-wafer__icon {
    position: relative;
    width: 2.25rem;
    height: 2.25rem;
    border-radius: 0.7rem;
    background: linear-gradient(140deg, rgba(28, 37, 56, 0.92), rgba(16, 24, 38, 0.86));
    box-shadow: inset 0 0 14px rgba(8, 14, 24, 0.8), 0 0 18px var(--accent-shadow);
  }

  .camera-wafer__icon::before,
  .camera-wafer__icon::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    pointer-events: none;
  }

  .camera-wafer__icon::before {
    border: 1px solid rgba(226, 232, 240, 0.08);
  }

  .camera-wafer__icon::after {
    inset: 0.35rem;
    border-radius: 0.45rem;
    background: radial-gradient(circle at 48% 48%, var(--accent) 0%, rgba(12, 14, 22, 0.75) 72%);
    box-shadow: 0 0 22px var(--accent-shadow);
    opacity: 0.85;
  }

  .camera-wafer__pulse {
    position: absolute;
    inset: 0.3rem;
    border-radius: 0.5rem;
    border: 1px solid var(--accent);
    opacity: 0.35;
    animation: wafer-pulse 1800ms ease-in-out infinite;
  }

  .camera-wafer[data-alert="alarmed"] .camera-wafer__pulse {
    animation-duration: 950ms;
  }

  .camera-wafer[data-alert="suspicious"] .camera-wafer__pulse {
    animation-duration: 1400ms;
  }

  .camera-wafer__glyph {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    color: rgba(226, 232, 240, 0.58);
    letter-spacing: 0.3em;
  }

  @keyframes wafer-pulse {
    0% { transform: scale(0.94); opacity: 0.2; }
    40% { transform: scale(1); opacity: 0.45; }
    100% { transform: scale(1.08); opacity: 0; }
  }

  .camera-wafer__body {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    flex: 1 1 auto;
    min-width: 0;
  }

  .camera-wafer__headline {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    position: relative;
    padding-bottom: 0.15rem;
  }

  .camera-wafer__headline::after {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    bottom: 0;
    height: 2px;
    background: linear-gradient(90deg, rgba(239, 181, 64, 0.6), rgba(249, 189, 88, 0.3));
    opacity: 0;
    transform: scaleX(0.68);
    transform-origin: left;
    transition: opacity 140ms ease, transform 160ms ease;
  }

  .camera-wafer[data-network="true"] .camera-wafer__headline::after {
    opacity: 1;
    transform: scaleX(1);
  }

  .camera-wafer__label {
    font-size: 0.74rem;
    color: rgba(226, 232, 240, 0.82);
  }

  .camera-wafer__exposure {
    display: flex;
    align-items: center;
    gap: 0.55rem;
  }

  .camera-wafer__track {
    position: relative;
    flex: 1 1 auto;
    height: 6px;
    border-radius: 999px;
    background: rgba(12, 18, 30, 0.92);
    border: 1px solid rgba(59, 73, 99, 0.4);
    overflow: hidden;
  }

  .camera-wafer__fill {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 0;
    border-radius: inherit;
    background: var(--accent);
    box-shadow: 0 0 14px var(--accent-shadow);
    transition: width 160ms ease-out, background 180ms ease-out, box-shadow 180ms ease-out;
  }

  .camera-wafer__track::after {
    content: '';
    position: absolute;
    inset: 0;
    background: repeating-linear-gradient(
      90deg,
      rgba(148, 163, 184, 0.08) 0 8px,
      transparent 8px 16px
    );
    mix-blend-mode: screen;
    opacity: 0.35;
    pointer-events: none;
  }

  @media (max-width: 1080px) {
    .camera-wafer {
      min-width: 12rem;
      width: auto;
    }
  }
`,du=()=>{const e=E(f=>f.surveillance.hud),n=E(f=>{var v;const u=(v=f.world.currentMapArea)==null?void 0:v.id;if(!u)return!1;const h=f.surveillance.zones[u];return h?Object.keys(h.cameras).length>0:!1})||e.detectionProgress>0||e.networkAlertActive||e.overlayEnabled,r=c.useMemo(()=>Math.min(100,Math.max(0,e.detectionProgress)),[e.detectionProgress]),a=c.useMemo(()=>Math.round(r),[r]),o=c.useMemo(()=>lu(e.alertState),[e.alertState]),l=o.intent==="idle"?"spy activity idle state":`${o.label.toLowerCase()} state`,i=e.overlayEnabled?"surveillance cones visible":"surveillance cones hidden",d=e.networkAlertActive?"network alert active. ":"",m=`${l}. ${d}Exposure ${a} percent. ${i}.`;return n?s.jsxs(s.Fragment,{children:[s.jsx("style",{children:cu}),s.jsxs("div",{className:"camera-wafer",role:"status","aria-live":"polite","aria-label":m,"data-alert":o.intent,"data-network":e.networkAlertActive||void 0,"data-overlay":e.overlayEnabled||void 0,"data-testid":"camera-detection-hud",children:[s.jsxs("div",{className:"camera-wafer__icon","aria-hidden":!0,children:[s.jsx("span",{className:"camera-wafer__pulse","aria-hidden":!0}),s.jsx("span",{className:"camera-wafer__glyph","aria-hidden":!0,children:"◉"})]}),s.jsxs("div",{className:"camera-wafer__body",children:[s.jsx("div",{className:"camera-wafer__headline","aria-hidden":!0,children:s.jsx("span",{className:"camera-wafer__label",children:o.label})}),s.jsx("div",{className:"camera-wafer__exposure","aria-hidden":!0,children:s.jsx("div",{className:"camera-wafer__track",children:s.jsx("div",{className:"camera-wafer__fill",style:{width:`${r}%`}})})})]})]})]}):null},uu=`
  .stealth-wafer {
    --accent: rgba(45, 212, 191, 0.78);
    --accent-border: rgba(45, 212, 191, 0.45);
    --accent-shadow: rgba(13, 148, 136, 0.38);
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.55rem 0.9rem;
    min-width: 14.5rem;
    width: 14.5rem;
    border-radius: 12px;
    background: linear-gradient(140deg, rgba(11, 20, 29, 0.92), rgba(7, 14, 22, 0.88));
    border: 1px solid var(--accent-border);
    box-shadow: 0 18px 32px rgba(8, 15, 27, 0.48);
    color: #e2e8f0;
    font-family: 'DM Mono', 'IBM Plex Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 0.14em;
  }

  .stealth-wafer__icon {
    width: 2.2rem;
    height: 2.2rem;
    border-radius: 0.7rem;
    background: linear-gradient(135deg, rgba(12, 23, 32, 0.88), rgba(8, 16, 26, 0.86));
    position: relative;
    box-shadow: inset 0 0 18px rgba(7, 16, 24, 0.85), 0 0 18px var(--accent-shadow);
  }

  .stealth-wafer__icon::before {
    content: '';
    position: absolute;
    inset: 0.35rem;
    border-radius: 0.5rem;
    background: radial-gradient(circle at 48% 52%, var(--accent) 0%, rgba(9, 19, 30, 0.8) 70%);
  }

  .stealth-wafer__icon::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: inherit;
    border: 1px solid rgba(148, 163, 184, 0.12);
  }

  .stealth-wafer__glyph {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    color: rgba(226, 232, 240, 0.75);
    letter-spacing: 0.24em;
  }

  .stealth-wafer__body {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    min-width: 0;
  }

  .stealth-wafer__headline {
    display: flex;
    align-items: center;
    gap: 0.45rem;
  }

  .stealth-wafer__label {
    font-size: 0.66rem;
    color: rgba(203, 213, 225, 0.86);
  }

  .stealth-wafer__state {
    font-size: 0.6rem;
    padding: 0.15rem 0.45rem;
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.3);
    background: rgba(15, 23, 42, 0.66);
    letter-spacing: 0.18em;
  }

  .stealth-wafer__meta {
    font-size: 0.54rem;
    letter-spacing: 0.12em;
    color: rgba(148, 163, 184, 0.78);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .stealth-wafer[data-state='exposed'] {
    --accent: rgba(251, 191, 36, 0.82);
    --accent-border: rgba(251, 191, 36, 0.38);
    --accent-shadow: rgba(217, 119, 6, 0.35);
  }

  .stealth-wafer[data-state='compromised'] {
    --accent: rgba(248, 113, 113, 0.78);
    --accent-border: rgba(248, 113, 113, 0.42);
    --accent-shadow: rgba(220, 38, 38, 0.36);
  }

  .stealth-wafer[data-state='standby'] {
    --accent: rgba(148, 163, 184, 0.7);
    --accent-border: rgba(148, 163, 184, 0.35);
    --accent-shadow: rgba(99, 102, 241, 0.24);
  }
`,fu=()=>{const e=E(B=>B.settings.locale),n=c.useMemo(()=>Pe(e),[e]).stealthIndicator,r=E(os),a=r.enabled,o=r.eligible,l=r.cooldownExpiresAt,i=typeof l=="number",d=i?Math.max(0,l-Date.now()):0,m=E(Rl),f=E(B=>B.world.inCombat),u=E(Vn),h=E(B=>B.surveillance.hud),v=E(B=>!!B.settings.reputationSystemsEnabled),x=E(B=>B.world.currentMapArea.zoneId),b=E(B=>{var Q,se;return v?((se=(Q=B.suspicion.zones[x])==null?void 0:Q.heat)==null?void 0:se.totalHeat)??0:0}),A=(h==null?void 0:h.detectionProgress)??0,C=Math.max(Math.round(A),Math.round(b)),y=a&&m==="stealth";let O="standby",_=n.keyHint;f?(O="compromised",_=n.unavailableReasons.combat):u?(O=y?"exposed":"standby",_=n.unavailableReasons.dialogue):y?(C>=80?O="compromised":C>=30?O="exposed":O="hidden",_=`Detection ${Math.max(0,Math.min(100,C))}%`):i&&d>0?(O="compromised",_=n.cooldown(Math.max(1,Math.ceil(d/1e3)))):o?(O="standby",_=n.keyHint):(O="compromised",_=n.unavailableReasons.cooldown);const L=n.states[O];return s.jsxs("div",{className:"pointer-events-none select-none",children:[s.jsx("style",{children:uu}),s.jsxs("div",{className:"stealth-wafer","data-state":O,children:[s.jsx("div",{className:"stealth-wafer__icon",children:s.jsx("div",{className:"stealth-wafer__glyph",children:"S"})}),s.jsxs("div",{className:"stealth-wafer__body",children:[s.jsxs("div",{className:"stealth-wafer__headline",children:[s.jsx("span",{className:"stealth-wafer__label",children:n.label}),s.jsx("span",{className:"stealth-wafer__state",children:L})]}),s.jsx("div",{className:"stealth-wafer__meta",children:_})]})]})]})},mu={position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",pointerEvents:"none",zIndex:20},pu={padding:"1.8rem 3rem",borderRadius:"18px",background:"rgba(15, 23, 42, 0.85)",border:"1px solid rgba(248, 250, 252, 0.35)",boxShadow:"0 40px 60px rgba(15, 23, 42, 0.55)",display:"flex",flexDirection:"column",alignItems:"center",gap:"0.6rem",textAlign:"center",color:"#f8fafc",letterSpacing:"0.28em",textTransform:"uppercase"},gu={fontSize:"1.6rem",fontWeight:800},hu={fontSize:"0.85rem",fontWeight:600,opacity:.8},bu=()=>{const e=je(),t=E(n=>n.surveillance.curfewBanner.visible);return c.useEffect(()=>{if(!t)return;const n=window.setTimeout(()=>{e(ja({visible:!1,timestamp:Date.now()}))},3e3);return()=>{window.clearTimeout(n)}},[t,e]),t?s.jsx("div",{style:mu,"aria-live":"assertive","aria-atomic":"true",children:s.jsxs("div",{style:pu,role:"alert",children:[s.jsx("span",{style:gu,children:"Curfew Active"}),s.jsx("span",{style:hu,children:"Surveillance Engaged"})]})}):null},yu=e=>!!e.settings.reputationSystemsEnabled,xu=e=>e.hudLayout.override,wu=e=>{var n,r,a;if(!yu(e))return 0;const t=((n=e.world.currentMapArea)==null?void 0:n.zoneId)??null;return t?((a=(r=e.suspicion.zones[t])==null?void 0:r.heat)==null?void 0:a.totalHeat)??0:0},vu=e=>{var t;return((t=e.surveillance.hud)==null?void 0:t.detectionProgress)??0},Su=K([xu,e=>e.world.inCombat,e=>e.world.engagementMode,wu,vu],(e,t,n,r,a)=>e||(t?"combat":n==="stealth"||Math.max(Math.round(r),Math.round(a))>=45?"stealth":"exploration")),Iu=()=>{const e=je(),t=E(Le),n=E(Yn),r=c.useRef(!1),a=c.useRef(!1);return c.useEffect(()=>{const o=(t==null?void 0:t.allPrimaryComplete)??!1;o&&!r.current&&!n&&e(Ni()),r.current=o},[t==null?void 0:t.allPrimaryComplete,n,e]),c.useEffect(()=>{if(!t){a.current=!1;return}n&&!a.current&&(Bc({level:t.level,levelId:t.levelId,name:t.name}),e(Vt({type:"missionCompletion",missionId:t.levelId})),a.current=!0),n||(a.current=!1)},[e,n,t]),null},Xn=e=>!!e.settings.reputationSystemsEnabled,ku={resistance:0,corpsec:0,scavengers:0},ws=e=>e.player.data.factionReputation,Eu=e=>e.player.pendingFactionEvents??[];K(ws,Xn,(e,t)=>t?{...e}:ku);const Mu=K(Eu,Xn,(e,t)=>t?[...e]:[]),zf=K(ws,Xn,(e,t)=>t?Oi().map(({id:r})=>{const a=Fi(r),o=zi(r,e[r]??a.definition.defaultReputation);return{factionId:r,name:a.definition.name,description:a.definition.description,value:o.value,standingId:o.standing.id,standingLabel:o.standing.label,color:o.standing.color,icon:o.standing.icon,effects:o.effects,nextThreshold:o.nextThreshold}}):[]),Cu={position:"fixed",top:"80px",right:"28px",display:"flex",flexDirection:"column",gap:"0.45rem",zIndex:9999,pointerEvents:"none"},Tu=e=>({minWidth:"220px",maxWidth:"280px",borderRadius:"12px",border:`1px solid ${e}`,background:"rgba(15, 23, 42, 0.92)",boxShadow:"0 18px 32px rgba(2, 6, 23, 0.45)",padding:"0.55rem 0.7rem",display:"flex",flexDirection:"column",gap:"0.28rem",color:"rgba(226, 232, 240, 0.95)",pointerEvents:"auto"}),Pu={fontSize:"0.64rem",letterSpacing:"0.12em",textTransform:"uppercase"},Ca={fontSize:"0.58rem",lineHeight:1.35,color:"rgba(203, 213, 225, 0.92)"},Ta=e=>e===0?"±0":`${e>0?"+":""}${e}`,_u=4200,Au=()=>{const e=je(),t=E(Mu),n=E(f=>f.settings.locale),r=E(f=>!!f.settings.reputationSystemsEnabled),a=c.useMemo(()=>Pe(n),[n]),o=a.playerStatus.factions,[l,i]=c.useState([]),d=c.useRef({}),m=c.useCallback(f=>{i(h=>h.filter(v=>v.id!==f));const u=d.current[f];u&&(window.clearTimeout(u),delete d.current[f])},[]);return c.useEffect(()=>{if(!r){Object.values(d.current).forEach(u=>window.clearTimeout(u)),d.current={},i([]);return}if(!t.length)return;const f=[];t.forEach(u=>{const h=o[u.factionId]??u.factionId,v=u.standingChanges.find(G=>G.factionId===u.factionId),x=u.standingChanges.find(G=>G.factionId!==u.factionId),b=Object.entries(u.rivalDeltas??{}),A=b.length>0?b[0]:void 0,C=u.reason?a.factionToast.reasons[u.reason]??u.reason:void 0,y=Ta(u.delta),O=v?Yt(n,v.nextStanding):void 0,_=O?a.factionToast.standingChange(O):void 0,L=x?Yt(n,x.nextStanding):void 0,B=A?a.factionToast.rivalChange(o[A[0]]??A[0],Ta(A[1]),L):void 0,Q=a.factionToast.reputationChange(h,y,C),se=`${u.factionId}-${u.timestamp}`,me=u.delta>0?"rgba(56, 189, 248, 0.65)":u.delta<0?"rgba(248, 113, 113, 0.65)":"rgba(148, 163, 184, 0.65)";f.push({id:se,factionId:u.factionId,message:Q,standingNote:_,rivalNote:B,color:me}),e(F(Q)),_&&_!==Q&&e(F(_)),B&&e(F(B))}),i(u=>[...u,...f].slice(-6)),f.forEach(u=>{const h=window.setTimeout(()=>m(u.id),_u);d.current[u.id]=h}),e(Bi())},[e,t,o,n,m,a.factionToast,r]),c.useEffect(()=>()=>{Object.values(d.current).forEach(f=>window.clearTimeout(f)),d.current={}},[]),!r||l.length===0?null:s.jsx("div",{style:Cu,"aria-live":"polite","aria-atomic":"false",children:l.map(f=>s.jsxs("div",{style:Tu(f.color),role:"status","aria-live":"polite",children:[s.jsx("span",{style:Pu,children:f.message}),f.standingNote&&s.jsx("span",{style:Ca,children:f.standingNote}),f.rivalNote&&s.jsx("span",{style:Ca,children:f.rivalNote})]},f.id))})},Ru={position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(15, 23, 42, 0.86)",backdropFilter:"blur(6px)",zIndex:20,padding:"1.5rem"},Du={width:"min(520px, 92vw)",borderRadius:"18px",border:"1px solid rgba(94, 234, 212, 0.2)",background:"linear-gradient(135deg, rgba(6, 15, 28, 0.95), rgba(13, 31, 48, 0.92))",color:"#f8fafc",fontFamily:"'DM Mono', 'IBM Plex Mono', monospace",boxShadow:"0 40px 68px rgba(2, 6, 23, 0.55)",display:"flex",flexDirection:"column",gap:"1.2rem",padding:"2rem 2.2rem"},ju={display:"flex",gap:"0.75rem"},Pa={all:"unset",cursor:"pointer",flex:1,padding:"0.7rem 1.2rem",borderRadius:"999px",letterSpacing:"0.15em",fontSize:"0.72rem",fontWeight:700,textTransform:"uppercase",textAlign:"center",minWidth:0},Lu=({open:e,levelName:t,missionStrings:n,primaryObjectives:r,sideObjectives:a,onContinue:o,onDefer:l})=>{if(!e)return null;const i=r.filter(m=>m.isComplete),d=a.filter(m=>!m.isComplete);return s.jsx("div",{role:"dialog","aria-modal":"true",style:Ru,children:s.jsxs("div",{style:Du,children:[s.jsxs("header",{style:{display:"flex",flexDirection:"column",gap:"0.4rem"},children:[s.jsx("span",{style:{fontSize:"0.7rem",letterSpacing:"0.28em",color:"rgba(94, 234, 212, 0.75)",textTransform:"uppercase"},children:n.accomplishedTitle}),s.jsx("h2",{style:{fontSize:"1.35rem",fontWeight:700,letterSpacing:"0.08em",margin:0},children:n.accomplishedSubtitle(t)})]}),s.jsxs("section",{style:{display:"flex",flexDirection:"column",gap:"0.9rem"},children:[s.jsxs("div",{style:{border:"1px solid rgba(148, 163, 184, 0.22)",borderRadius:"14px",padding:"0.9rem 1.1rem",background:"rgba(15, 23, 42, 0.68)",display:"flex",flexDirection:"column",gap:"0.6rem"},children:[s.jsx("span",{style:{fontSize:"0.7rem",color:"rgba(148, 163, 184, 0.78)"},children:n.primarySummaryLabel}),i.length===0?s.jsx("span",{style:{fontSize:"0.72rem",color:"rgba(226, 232, 240, 0.86)"},children:"—"}):s.jsx("ul",{style:{margin:0,padding:0,listStyle:"none",display:"flex",flexDirection:"column",gap:"0.45rem"},children:i.map(m=>s.jsxs("li",{style:{display:"flex",gap:"0.55rem",alignItems:"flex-start",fontSize:"0.74rem",color:"rgba(226, 232, 240, 0.9)",lineHeight:1.35},children:[s.jsx("span",{"aria-hidden":!0,style:{width:"0.9rem",height:"0.9rem",borderRadius:"999px",display:"inline-flex",alignItems:"center",justifyContent:"center",background:"linear-gradient(135deg, rgba(56, 189, 248, 0.55), rgba(94, 234, 212, 0.55))",color:"#02111f",fontSize:"0.62rem",fontWeight:700,border:"1px solid rgba(94, 234, 212, 0.5)"},children:"✓"}),s.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"0.2rem",flex:1},children:[s.jsx("span",{style:{fontWeight:600},children:m.label}),m.summary&&s.jsx("span",{style:{fontSize:"0.66rem",color:"rgba(203, 213, 225, 0.82)"},children:m.summary})]})]},m.id))})]}),s.jsxs("div",{style:{border:"1px solid rgba(148, 163, 184, 0.22)",borderRadius:"14px",padding:"0.9rem 1.1rem",background:"rgba(15, 23, 42, 0.6)",display:"flex",flexDirection:"column",gap:"0.65rem"},children:[s.jsx("span",{style:{fontSize:"0.7rem",color:"rgba(148, 163, 184, 0.78)"},children:n.sideReminder}),d.length===0?s.jsx("span",{style:{fontSize:"0.72rem",color:"rgba(226, 232, 240, 0.88)"},children:"—"}):s.jsx("ul",{style:{margin:0,paddingLeft:"1.1rem",display:"flex",flexDirection:"column",gap:"0.35rem",fontSize:"0.72rem",color:"rgba(226, 232, 240, 0.88)",listStyle:"disc"},children:d.map(m=>s.jsx("li",{children:m.label},m.id))})]}),s.jsx("span",{style:{fontSize:"0.64rem",color:"rgba(148, 163, 184, 0.65)"},children:n.deferHint})]}),s.jsxs("div",{style:ju,children:[s.jsx("button",{type:"button",onClick:o,style:{...Pa,border:"1px solid rgba(94, 234, 212, 0.5)",background:"linear-gradient(135deg, rgba(56, 189, 248, 0.7), rgba(94, 234, 212, 0.65))",color:"#02111f",boxShadow:"0 20px 36px rgba(13, 148, 136, 0.35)"},children:n.continueCta}),s.jsx("button",{type:"button",onClick:l,style:{...Pa,border:"1px solid rgba(148, 163, 184, 0.45)",background:"rgba(15, 23, 42, 0.75)",color:"rgba(226, 232, 240, 0.9)"},children:n.deferCta})]})]})})},Nu=()=>{const e=je(),t=E(f=>f.settings.locale),n=E(Le),r=E(f=>f.missions),a=E(Yn),o=E(Sc),l=Pe(t),i=a&&!o,d=()=>{if(!n)return;const f=r.levels[r.currentLevelIndex+1],u=(f==null?void 0:f.zoneId)??null;Hc({level:n.level,levelId:n.levelId,name:n.name,nextLevel:(f==null?void 0:f.level)??n.level+1,nextLevelId:f==null?void 0:f.levelId}),e(Wi()),u&&e($i({zoneId:u}))},m=()=>{e(Hi())};return s.jsx(Lu,{open:i,levelName:(n==null?void 0:n.name)??"Current Sector",missionStrings:l.mission,primaryObjectives:(n==null?void 0:n.primary)??[],sideObjectives:(n==null?void 0:n.side)??[],onContinue:d,onDefer:m})},Ou={width:"min(360px, 32vw)",minWidth:"280px",padding:"0.85rem 1rem 1.1rem",borderRadius:"16px",background:"linear-gradient(165deg, rgba(10,17,32,0.93), rgba(15,23,42,0.9))",border:"1px solid rgba(56,189,248,0.28)",boxShadow:"0 18px 36px rgba(15,23,42,0.55)",display:"flex",flexDirection:"column",gap:"0.72rem",pointerEvents:"auto"},zu={display:"flex",alignItems:"center",justifyContent:"space-between",fontSize:"0.62rem",letterSpacing:"0.22em",textTransform:"uppercase",color:"#94a3b8"},Fu={display:"inline-flex",gap:"0.42rem",alignItems:"center",fontSize:"0.62rem",letterSpacing:"0.18em"},Bu={fontWeight:700,fontSize:"0.78rem",color:"#38bdf8"},Hu={opacity:.8,color:"#cbd5f5"},Wu=e=>({width:"100%",display:"flex",alignItems:"center",justifyContent:"center",padding:"0.52rem 1rem",borderRadius:"12px",fontWeight:700,letterSpacing:"0.22em",fontSize:"0.76rem",textTransform:"uppercase",color:e?"#0f172a":"#f8fafc",background:e?"linear-gradient(135deg, #38bdf8, #60a5fa)":"linear-gradient(135deg, rgba(248,113,113,0.85), rgba(239,68,68,0.95))",boxShadow:e?"0 0 18px rgba(56,189,248,0.6), 0 14px 24px -10px rgba(56,189,248,0.55)":"0 0 18px rgba(239,68,68,0.6), 0 14px 24px -10px rgba(239,68,68,0.55)"}),$u={display:"flex",flexDirection:"column",gap:"0.65rem",padding:"0.9rem 1rem 0.85rem",borderRadius:"14px",background:"linear-gradient(155deg, rgba(15,23,42,0.92), rgba(30,41,59,0.8))",border:"1px solid rgba(56,189,248,0.18)",boxShadow:"0 16px 32px rgba(15,23,42,0.45)"},Uu={display:"flex",justifyContent:"space-between",alignItems:"center",fontSize:"0.68rem",letterSpacing:"0.16em",color:"#9ca3c6",textTransform:"uppercase"},Gu=e=>({fontSize:"0.98rem",fontWeight:600,color:e?"#fda4af":"#f8fafc",textShadow:e?"0 0 12px rgba(248,113,113,0.45)":"none"}),Vu={position:"relative",height:"9px",borderRadius:"999px",background:"linear-gradient(90deg, rgba(30,41,59,0.9), rgba(11,16,28,0.85))",overflow:"hidden",boxShadow:"inset 0 0 8px rgba(15,23,42,0.6)"},qu=e=>({position:"absolute",top:0,left:0,height:"100%",width:`${Math.max(0,Math.min(1,e))*100}%`,background:"linear-gradient(90deg, rgba(96,165,250,0.95), rgba(56,189,248,0.85))",boxShadow:"0 0 16px rgba(56,189,248,0.38)",transition:"width 160ms ease-out"}),Yu=e=>{const t={off:{border:"rgba(148,163,184,0.32)",glow:"rgba(148,163,184,0.22)",background:"linear-gradient(135deg, rgba(15,23,42,0.86), rgba(30,41,59,0.78))",label:"#cbd5f5",state:"#94a3b8",dot:"#64748b"},running:{border:"rgba(34,197,94,0.55)",glow:"rgba(34,197,94,0.45)",background:"linear-gradient(135deg, rgba(22,163,74,0.25), rgba(74,222,128,0.18))",label:"#d1fae5",state:"#86efac",dot:"#34d399"},paused:{border:"rgba(250,204,21,0.55)",glow:"rgba(250,204,21,0.38)",background:"linear-gradient(135deg, rgba(120,53,15,0.28), rgba(217,119,6,0.22))",label:"#fef3c7",state:"#fde68a",dot:"#fbbf24"}}[e];return{width:"100%",display:"flex",alignItems:"center",justifyContent:"space-between",padding:"0.52rem 0.9rem",borderRadius:"12px",border:`1px solid ${t.border}`,background:t.background,color:t.label,fontWeight:500,fontSize:"0.72rem",letterSpacing:"0.16em",textTransform:"uppercase",cursor:"pointer",boxShadow:`0 0 22px ${t.glow}`,transition:"transform 120ms ease, box-shadow 120ms ease, border-color 160ms ease"}},Ku={display:"flex",flexDirection:"column",alignItems:"flex-start",gap:"0.14rem"},Xu={fontSize:"0.58rem",letterSpacing:"0.3em",opacity:.74},Qu=e=>({fontSize:"0.84rem",letterSpacing:"0.14em",color:{off:"#cbd5f5",running:"#bbf7d0",paused:"#fde68a"}[e]}),Zu=e=>{const t={off:{background:"#64748b",shadow:"rgba(100,116,139,0.35)"},running:{background:"#34d399",shadow:"rgba(52,211,153,0.55)"},paused:{background:"#fbbf24",shadow:"rgba(251,191,36,0.45)"}};return{width:"0.6rem",height:"0.6rem",borderRadius:"50%",background:t[e].background,boxShadow:`0 0 14px ${t[e].shadow}`}},Ju={display:"flex",flexDirection:"column",gap:"0.5rem",padding:"0.82rem 0.95rem",borderRadius:"14px",background:"linear-gradient(160deg, rgba(17,24,39,0.86), rgba(15,23,42,0.9))",border:"1px solid rgba(99,102,241,0.22)",boxShadow:"0 16px 32px rgba(15,23,42,0.42)"},ef={display:"block",fontSize:"0.58rem",letterSpacing:"0.24em",color:"#808bb2",textTransform:"uppercase"},tf={display:"grid",gridTemplateColumns:"minmax(0, 1fr) minmax(0, 1.5fr) auto",alignItems:"center",gap:"0.6rem",fontSize:"0.72rem",color:"#d1dcff"},nf={position:"relative",height:"6px",borderRadius:"999px",background:"rgba(71,85,105,0.45)",overflow:"hidden"},rf=e=>({position:"absolute",inset:0,width:`${Math.max(0,Math.min(1,e))*100}%`,background:"linear-gradient(90deg, rgba(239,68,68,0.85), rgba(248,113,113,0.78))",boxShadow:"0 0 12px rgba(248,113,113,0.32)",transition:"width 160ms ease-out"}),af={fontSize:"0.66rem",opacity:.84,minWidth:"44px",textAlign:"right"},sf=()=>{const e=je(),t=E(L=>L.settings.locale),n=E(L=>L.autoBattle.status),r=E(L=>L.world.inCombat),a=E(L=>L.world.isPlayerTurn),o=E(L=>L.settings.autoBattleEnabled),l=E(L=>({actionPoints:L.player.data.actionPoints,maxActionPoints:L.player.data.maxActionPoints})),i=E(L=>{var B;return((B=L.world.currentMapArea)==null?void 0:B.entities.enemies)??[]}),d=Pe(t),m=c.useMemo(()=>i.filter(L=>L.health>0),[i]),f=m.length,u=c.useMemo(()=>m.slice().sort((L,B)=>B.actionPoints-L.actionPoints).slice(0,4),[m]),[h,v]=c.useState(l.actionPoints),x=c.useRef(h),b=c.useRef(null);if(c.useEffect(()=>{x.current=h},[h]),c.useEffect(()=>{const L=l.actionPoints;if(b.current&&(window.clearTimeout(b.current),b.current=null),!r){v(L);return}if(!(o&&n==="running")||L>=x.current){v(L);return}const Q=()=>{const se=x.current;if(se<=L){b.current=null;return}v(se-1),b.current=window.setTimeout(Q,70)};return b.current=window.setTimeout(Q,60),()=>{b.current&&(window.clearTimeout(b.current),b.current=null)}},[l.actionPoints,r,o,n]),c.useEffect(()=>()=>{b.current&&window.clearTimeout(b.current)},[]),!r)return null;const A=Math.max(0,l.maxActionPoints),C=A>0?Math.max(0,Math.min(1,h/A)):0,y=()=>{e(Pn(!o))},_=o?n==="paused"?"paused":n==="running"?"running":"off":"off";return s.jsxs("div",{style:Ou,"data-testid":"combat-control-widget",children:[s.jsxs("div",{style:zu,children:[s.jsx("span",{children:d.turnTracker.heading.toUpperCase()}),s.jsxs("span",{style:Fu,children:[s.jsx("span",{style:Bu,children:f}),s.jsx("span",{style:Hu,children:d.turnTracker.hostileReadout.toUpperCase()})]})]}),s.jsx("div",{style:Wu(a),children:a?d.turnTracker.playerTurn:d.turnTracker.enemyTurn}),s.jsxs("div",{style:$u,children:[s.jsxs("div",{style:Uu,children:[s.jsx("span",{children:d.playerStatus.actionPointsLabel}),s.jsxs("span",{style:Gu(h===0),children:[h,"/",l.maxActionPoints]})]}),s.jsx("div",{style:Vu,children:s.jsx("div",{style:qu(C)})})]}),s.jsxs("button",{type:"button",onClick:y,style:Yu(_),"aria-pressed":o,"aria-label":d.autoBattle.toggleLabel,children:[s.jsxs("span",{style:Ku,children:[s.jsx("span",{style:Xu,children:d.autoBattle.heading.toUpperCase()}),s.jsx("span",{style:Qu(_),children:_==="off"?d.autoBattle.hudToggleOffLabel:d.autoBattle.hudToggleOnLabel})]}),s.jsx("span",{style:Zu(_)})]}),s.jsxs("div",{style:Ju,children:[s.jsx("span",{style:ef,children:d.turnTracker.hostileReadout.toUpperCase()}),s.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"0.55rem"},children:u.length>0?u.map(L=>{const B=L.maxActionPoints>0?Math.max(0,Math.min(1,L.actionPoints/L.maxActionPoints)):0;return s.jsxs("div",{style:tf,children:[s.jsx("span",{style:{fontWeight:600,overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"},title:L.name,children:L.name}),s.jsx("div",{style:nf,children:s.jsx("div",{style:rf(B)})}),s.jsxs("span",{style:af,children:[L.actionPoints,"/",L.maxActionPoints]})]},L.id)}):s.jsx("span",{style:{fontSize:"0.68rem",color:"#9ca3c6",textAlign:"center",letterSpacing:"0.1em"},children:d.turnTracker.playerTurn.toUpperCase()})})]})]})},of=c.lazy(()=>yt(()=>import("./GameMenu-h628ydeX.js"),__vite__mapDeps([0,1,2,3,4,5]))),lf=c.lazy(()=>yt(()=>import("./CharacterCreationScreen-Derer2jd.js"),__vite__mapDeps([6,1,2,4,3,5,7]))),cf=c.lazy(()=>yt(()=>import("./CharacterScreen-DPRr6bzy.js"),__vite__mapDeps([8,1,2,3,4,7]))),df=c.lazy(()=>yt(()=>import("./LevelUpModal-BkRZt7Bl.js"),__vite__mapDeps([9,1,2,5,4,3])).then(e=>({default:e.LevelUpModal}))),uf=c.lazy(()=>yt(()=>import("./PerkSelectionPanel-CGNMNxCY.js"),__vite__mapDeps([10,1,2,3,4]))),ff=c.lazy(()=>yt(()=>import("./LevelUpPointAllocationPanel-DjehWJVy.js"),__vite__mapDeps([11,1,2,4,3,5]))),_a=Na("App"),mf={margin:0,padding:0,width:"100vw",height:"100vh",overflow:"hidden",position:"relative",backgroundColor:"var(--color-gunmetal-900)",color:"var(--color-hud-text)",fontFamily:"var(--font-mono)"},pf={position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",background:"var(--hud-stage-background)"},En=260,gf=320,hf={flex:"1 1 auto",minWidth:0,height:"100%",position:"relative",overflow:"hidden"},bf={position:"absolute",top:"1.25rem",left:"1.25rem",display:"flex",flexDirection:"column",alignItems:"flex-start",gap:"0.75rem",zIndex:5,pointerEvents:"auto"},yf={position:"absolute",top:"1.25rem",left:"50%",transform:"translateX(-50%)",display:"flex",flexDirection:"column",alignItems:"center",gap:"0.75rem",zIndex:6,pointerEvents:"auto"},xf={position:"absolute",top:"1.25rem",right:"1.25rem",display:"flex",flexDirection:"column",alignItems:"flex-end",gap:"0.75rem",zIndex:6,pointerEvents:"none"},wf={all:"unset",display:"flex",alignItems:"center",justifyContent:"space-between",gap:"0.5rem",padding:"0.7rem 0.9rem",boxSizing:"border-box",borderRadius:"14px",border:"var(--hud-command-button-border)",background:"var(--hud-command-button-bg)",boxShadow:"var(--hud-command-button-shadow)",color:"var(--hud-command-button-text)",fontFamily:"var(--font-mono)",fontSize:"0.7rem",letterSpacing:"0.14em",textTransform:"uppercase",cursor:"pointer",pointerEvents:"auto",transition:"transform 0.16s ease, box-shadow 0.16s ease, border-color 0.16s ease, color 0.16s ease"},vf={fontSize:"0.78rem",letterSpacing:"0.2em",color:"inherit"},Sf={fontSize:"0.62rem",letterSpacing:"0.24em",color:"var(--hud-command-button-text-muted)",textTransform:"uppercase"},If=({onOpenMenu:e,onToggleCharacter:t,showMenu:n,characterOpen:r,levelPanelCollapsed:a,onToggleLevelPanel:o,hudLayoutPreset:l})=>{const i=E(G=>G.settings.locale),d=E(G=>G.world.inCombat),m=Pe(i),f=E(G=>{var g;return((g=G.world.currentMapArea)==null?void 0:g.zoneId)??null}),u=l==="combat",h=l==="stealth",[v,x]=c.useState(!1),[b,A]=c.useState(null),C=c.useRef(null),[y,O]=c.useState(null),[_,L]=c.useState(En);c.useEffect(()=>{n&&x(!1)},[n]),c.useEffect(()=>{d&&x(!1)},[d]),c.useEffect(()=>{if(typeof window>"u"||typeof ResizeObserver>"u")return;const G=C.current;if(!G)return;const g=new ResizeObserver(w=>{const S=w[0];if(!S)return;const j=Math.round(S.contentRect.height);O(P=>P===j?P:j)});return g.observe(G),()=>g.disconnect()},[]),c.useEffect(()=>{const G=C.current;if(!G)return;const g=Math.round(G.getBoundingClientRect().height);O(w=>w===g?w:g)},[]),c.useEffect(()=>{if(!y){L(En);return}if(typeof window>"u"){L(y);return}const g=(parseFloat(window.getComputedStyle(document.documentElement).fontSize||"16")||16)*1.3,w=Math.round(y+g),S=Math.min(Math.max(w,En),gf);L(j=>j===S?j:S)},[y]);const B=()=>{x(G=>!G)},Q=v?m.shell.completedToggleClose:m.shell.completedToggleOpen;return c.useEffect(()=>{if(!(typeof document>"u"))return _?document.documentElement.style.setProperty("--bottom-panel-height",`${_}px`):document.documentElement.style.removeProperty("--bottom-panel-height"),()=>{typeof document<"u"&&document.documentElement.style.removeProperty("--bottom-panel-height")}},[_]),s.jsxs("div",{style:pf,className:"command-shell-stage","data-hud-layout":l,children:[s.jsxs("div",{style:hf,children:[s.jsx(au,{}),s.jsx(Ji,{onRendererInfo:A}),s.jsx(Wl,{}),s.jsxs("div",{style:bf,children:[s.jsxs("button",{type:"button",onClick:e,style:{...wf,width:"90vw",maxWidth:"240px"},"data-testid":"menu-overlay-button","aria-label":m.shell.menuButton,title:m.shell.menuButton,onMouseEnter:G=>{G.currentTarget.style.transform="translateY(-2px)",G.currentTarget.style.boxShadow="var(--hud-command-button-shadow-hover)",G.currentTarget.style.borderColor="var(--hud-command-button-border-hover)",G.currentTarget.style.color="var(--hud-command-button-text-hover)"},onMouseLeave:G=>{G.currentTarget.style.transform="translateY(0)",G.currentTarget.style.boxShadow="var(--hud-command-button-shadow)",G.currentTarget.style.borderColor="var(--hud-command-button-border-rest)",G.currentTarget.style.color="var(--hud-command-button-text)"},onFocus:G=>{G.currentTarget.style.boxShadow="var(--hud-command-button-shadow-focus)",G.currentTarget.style.borderColor="var(--hud-command-button-border-focus)"},onBlur:G=>{G.currentTarget.style.boxShadow="var(--hud-command-button-shadow)",G.currentTarget.style.borderColor="var(--hud-command-button-border-rest)"},children:[s.jsx("span",{style:vf,children:m.shell.menuButton}),s.jsx("span",{style:Sf,children:"ESC"})]}),s.jsx(Ic,{collapsed:a,onToggle:o}),s.jsx(ss,{zoneId:f,rendererInfo:b})]}),s.jsx("div",{style:yf,children:s.jsx(sf,{})}),s.jsxs("div",{style:xf,children:[s.jsx("div",{style:{pointerEvents:"auto"},children:s.jsx(Zl,{})}),s.jsx("div",{style:{pointerEvents:"auto"},children:s.jsx(fu,{})}),s.jsx("div",{style:{pointerEvents:"auto"},children:s.jsx(du,{})})]}),s.jsx(Xd,{}),s.jsx(ou,{})]}),s.jsxs("div",{className:"hud-bottom-dock","data-hud-layout":l,children:[s.jsx("div",{className:"hud-bottom-lane hud-bottom-lane--map","data-hud-emphasis":h?"true":void 0,children:s.jsx("div",{className:"hud-bottom-lane-card",children:s.jsx("div",{className:"hud-bottom-card-surface",children:s.jsx(gc,{className:"hud-bottom-map-card",variant:"frameless",children:s.jsx(mc,{})})})})}),s.jsx("div",{className:"hud-bottom-lane hud-bottom-lane--status",ref:C,"data-hud-emphasis":u?"true":void 0,children:s.jsx("div",{className:"hud-bottom-lane-card",children:s.jsx("div",{className:"hud-bottom-card-surface",children:s.jsx(Yl,{onOpenCharacter:t,characterOpen:r,variant:"frameless"})})})}),s.jsx("div",{className:"hud-bottom-lane hud-bottom-lane--george",children:s.jsx("div",{className:"hud-bottom-lane-card",children:s.jsx("div",{className:"hud-bottom-card-surface",children:s.jsx(Xc,{})})})}),s.jsxs("div",{className:"hud-bottom-lane hud-bottom-lane--ops",children:[s.jsx("div",{className:"hud-bottom-lane-card",children:s.jsxs("div",{className:"hud-bottom-card-surface",children:[s.jsx("div",{className:"hud-bottom-quests",children:s.jsx(Ea,{})}),s.jsx("div",{className:"hud-bottom-control-row",children:s.jsx("button",{type:"button",className:"hud-bottom-toggle",onClick:B,"aria-expanded":v,"aria-controls":"command-objective-overlay",children:Q})})]})}),s.jsx("div",{id:"command-objective-overlay",className:"hud-bottom-overlay","data-expanded":v,children:s.jsx("div",{className:"hud-bottom-overlay__scroll",children:s.jsx(Ea,{showCompleted:!0})})})]})]})]})},Aa=()=>{if(typeof window>"u")return!1;try{return!!window.localStorage.getItem(Fa)}catch(e){return console.warn("[App] Failed to read persisted game state",e),!1}},qt=e=>Ki().filter(t=>!e.perks.includes(t.id)),Mn=e=>qt(e).map(t=>Xi(e,t)).filter(t=>t.canSelect);function kf(){const[e,t]=c.useState(!1),[n,r]=c.useState(!0),[a,o]=c.useState(!1),[l,i]=c.useState(()=>Aa()),[d,m]=c.useState(null),[f,u]=c.useState([]),[h,v]=c.useState(!1),[x,b]=c.useState(0),[A,C]=c.useState(!1),[y,O]=c.useState(!1),[_,L]=c.useState(!1),[B,Q]=c.useState(!0),se=E(Su),me=E(q=>!!q.settings.reputationSystemsEnabled);c.useEffect(()=>{_a.debug("Component mounted"),_a.debug("Store state:",ye.getState())},[]),c.useEffect(()=>ye.subscribe(()=>{const Z=ye.getState(),ce=Z.player.pendingLevelUpEvents;m(R=>R||(ce.length>0?ce[0]:null));const ue=Z.player.data.pendingPerkSelections;b(ue);const le=Z.player.xpNotifications??[];u(le)}),[]),c.useEffect(()=>{if(n){if(e){i(!0);return}i(Aa())}},[n,e]),c.useEffect(()=>{if(typeof window>"u")return;const q=new URLSearchParams(window.location.search);if(q.get("poc")!=="esb"||e||a)return;try{window.localStorage.removeItem(Fa)}catch{}i(!1),r(!1);const Z={name:q.get("pocName")??"Deus",attributes:Er,backgroundId:"corpsec_defector",visualPreset:"default"};g(Z)},[e,a]),c.useEffect(()=>{e&&window.requestAnimationFrame(()=>{window.dispatchEvent(new Event("resize"))})},[e]),c.useEffect(()=>{(n||a)&&v(!1)},[n,a]),c.useEffect(()=>{const q=Z=>{Z.key.toLowerCase()==="c"&&e&&!n&&!a&&v(ce=>!ce),Z.key.toLowerCase()==="l"&&e&&!n&&!a&&Q(ce=>!ce)};return window.addEventListener("keydown",q),()=>window.removeEventListener("keydown",q)},[e,n,a]);const G=()=>{r(!1),o(!0)},g=q=>{ye.dispatch(Ui());const Z=q.attributes??Er,ce=q.backgroundId??"corpsec_defector";ye.dispatch(Gi({name:q.name,skills:Z,backgroundId:ce,visualPreset:q.visualPreset}));const ue=ye.getState(),{logs:le}=Qe(ue.settings.locale);ye.dispatch(F(`${le.operationStart} - Call sign: ${q.name}`));const R=ue.quests.quests.find(re=>re.id==="quest_market_cache");R&&!R.isActive&&!R.isCompleted&&(ye.dispatch(za(R.id)),ye.dispatch(F(le.questAccepted(R.name)))),o(!1),t(!0),i(!0)},w=()=>{o(!1),r(!0)},S=()=>{ye.dispatch(Vi()),t(!0),r(!1),i(!0)};c.useEffect(()=>{if(!e)return;const q=Z=>{if(Z.key!=="Escape")return;if(Z.preventDefault(),h){v(!1),y&&O(!1);return}if(!!ye.getState().quests.activeDialogue.dialogueId){ye.dispatch(Kt());return}if(n){S();return}a||r(!0)};return window.addEventListener("keydown",q),()=>window.removeEventListener("keydown",q)},[e,n,a,h,y]);const j=()=>{if(!e){r(!0);return}if(n){S();return}if(!!ye.getState().quests.activeDialogue.dialogueId){ye.dispatch(Kt());return}r(!0)},P=()=>{!e||n||a||v(q=>!q)},I=()=>{if(!d)return;const Z=ye.getState().player.data,ce=Z.pendingPerkSelections,ue=qt(Z),le=Mn(Z),R=ce>0,re=le.length>0,N=Z.skillPoints>0||Z.attributePoints>0;O(R||N),ye.dispatch(qi()),m(null),R&&ue.length>0?(re||console.info("[LevelUp] Perk selections available but current requirements are unmet. Player may need to allocate points first."),C(!0)):(R&&ue.length===0&&ye.dispatch(pn()),N?L(!0):O(!1))},Y=()=>{if(C(!1),!y)return;const q=ye.getState().player.data,Z=q.pendingPerkSelections,ce=q.skillPoints>0||q.attributePoints>0,ue=qt(q),le=Mn(q);if(Z>0&&le.length===0&&ue.length===0&&ye.dispatch(pn()),ce){L(!0);return}O(!1)},te=()=>{v(!1),y&&O(!1)},de=()=>{L(!1);const q=ye.getState().player.data,Z=q.pendingPerkSelections,ce=qt(q),ue=Mn(q);if(Z>0&&ue.length>0){C(!0);return}Z>0&&ue.length===0&&ce.length===0&&ye.dispatch(pn()),O(!1)},he=q=>{ye.dispatch(Yi(q))};return s.jsxs(s.Fragment,{children:[s.jsx(Iu,{}),me&&s.jsx(Au,{}),s.jsxs("div",{style:mf,children:[e&&s.jsx(If,{onOpenMenu:j,onToggleCharacter:P,showMenu:n,characterOpen:h,levelPanelCollapsed:B,onToggleLevelPanel:()=>Q(q=>!q),hudLayoutPreset:se}),s.jsx(bu,{})]}),s.jsxs(c.Suspense,{fallback:null,children:[n&&s.jsx(of,{onStartNewGame:G,onContinue:S,hasActiveGame:e||l}),a&&s.jsx(lf,{onComplete:g,onCancel:w}),d&&s.jsx(df,{newLevel:d.newLevel,skillPointsEarned:d.skillPointsEarned,attributePointsEarned:d.attributePointsEarned,perksUnlocked:d.perksUnlocked,onContinue:I}),s.jsx(uf,{open:A,pendingSelections:x,onClose:Y}),_&&s.jsx(ff,{onComplete:de}),s.jsx(cf,{open:h,onClose:te}),s.jsx(Nu,{})]}),s.jsx(ru,{notifications:f,onDismiss:he})]})}function Ef(){return s.jsx(Cs,{store:ye,children:s.jsx(kf,{})})}Ts.createRoot(document.getElementById("root")).render(s.jsx(c.StrictMode,{children:s.jsx(Ef,{})}));export{Yl as P,Rf as a,Df as b,Af as c,jf as d,Lf as e,zf as f,Of as g,Jt as n,Nf as s};
