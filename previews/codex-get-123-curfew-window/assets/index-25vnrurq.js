const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/GameMenu-5Z21hAsW.js","assets/vendor-Cc93p67d.js","assets/phaser-DkaA9Y8j.js","assets/game-content-C1R4cuJy.js","assets/game-core-BYPPd_qL.js","assets/EnhancedButton-DVdhyrz_.js","assets/CharacterCreationScreen-Cl8BXET8.js","assets/Tooltip-CnX58fCC.js","assets/CharacterScreen-CDES-cnZ.js","assets/LevelUpModal-CEh9CGhX.js","assets/PerkSelectionPanel-DhBsZLfg.js","assets/LevelUpPointAllocationPanel-BrxXHFsF.js"])))=>i.map(i=>d[i]);
var ti=Object.defineProperty;var ni=(e,t,n)=>t in e?ti(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var je=(e,t,n)=>ni(e,typeof t!="symbol"?t+"":t,n);import{r as c,u as P,j as a,e as X,f as Xe,g as ri,R as pn,P as si,h as ai}from"./vendor-Cc93p67d.js";import{P as Ke}from"./phaser-DkaA9Y8j.js";import{B as ii,M as oi,u as li,C as ee,w as ci,l as Dr,c as _e,r as sa,s as di,A as be,a as ui,b as fi,d as lr,e as aa,f as O,g as _r,h as mi,i as ia,j as rn,k as Yn,m as Xn,n as pi,o as gi,p as hi,q as Lr,t as yi,v as bi,x as xi,y as vi,z as oa,D as wi,E as jr,F as Si,S as Nr,G as ki,H as Cn,I as Mn,J as Pn,K as la,L as Ii,N as ca,O as Ei,P as Ti,Q as At,R as Dt,T as Ci,U as Or,V as Mi,W as Pi,X as Fr,Y as Rn,Z as zr,_ as _t,$ as Kt,a0 as Hr,a1 as gn,a2 as Ye,a3 as ln,a4 as Br,a5 as Yt,a6 as sn,a7 as Lt,a8 as Ri,a9 as Ai,aa as An,ab as Dn,ac as $r,ad as Di,ae as _i,af as Wr,ag as kt,ah as ct,ai as Li,aj as ji,ak as Ni,al as Ur,am as Oi,an as Fi,ao as zi,ap as _n,aq as Hi,ar as Qn,as as cn,at as Bi,au as $i,av as Wi,aw as Ui,ax as Gi,ay as Vi,az as qi,aA as Ki,aB as Yi,aC as Xi,aD as Qi,aE as an,aF as Zi,aG as da,aH as dt,aI as Gr,aJ as Ji,aK as eo,aL as to,aM as no,aN as Vr,aO as ro,aP as so,aQ as ao,aR as io,aS as oo,aT as dn,aU as lo,aV as co,aW as uo,aX as fo,aY as mo,aZ as po,a_ as go,a$ as ho,b0 as yo,b1 as bo,b2 as cr,b3 as qr,b4 as Kr,b5 as xo,b6 as vo,b7 as wo,b8 as So,b9 as Me,ba as ua,bb as ko,bc as Io,bd as Yr,be as Eo,bf as To,bg as Ln,bh as Co}from"./game-core-BYPPd_qL.js";import{p as ot,P as Se,o as Qe,v as et,n as fa,h as Mo,q as Po,e as Ro}from"./game-content-C1R4cuJy.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function n(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=n(s);fetch(s.href,i)}})();const Ao="modulepreload",Do=function(e){return"/the-getaway/previews/codex-get-123-curfew-window/"+e},Xr={},It=function(t,n,r){let s=Promise.resolve();if(n&&n.length>0){let l=function(m){return Promise.all(m.map(f=>Promise.resolve(f).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),d=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));s=l(n.map(m=>{if(m=Do(m),m in Xr)return;Xr[m]=!0;const f=m.endsWith(".css"),u=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${m}"]${u}`))return;const g=document.createElement("link");if(g.rel=f?"stylesheet":Ao,f||(g.as="script"),g.crossOrigin="",g.href=m,d&&g.setAttribute("nonce",d),document.head.appendChild(g),f)return new Promise((h,I)=>{g.addEventListener("load",h),g.addEventListener("error",()=>I(new Error(`Unable to preload CSS for ${m}`)))})}))}function i(l){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=l,window.dispatchEvent(o),!o.defaultPrevented)throw l}return s.then(l=>{for(const o of l||[])o.status==="rejected"&&i(o.reason);return t().catch(i)})},_o=({onRendererInfo:e})=>{const t=c.useRef(null),n=c.useRef(null),[r,s]=c.useState({label:"Detecting…",detail:"Negotiating renderer"}),i=c.useRef({width:0,height:0});c.useEffect(()=>{if(console.log("[GameCanvas] useEffect running"),console.log("[GameCanvas] gameContainerRef.current:",t.current),!t.current){console.error("[GameCanvas] No container ref available");return}const m=t.current.offsetWidth,f=t.current.offsetHeight;console.log("[GameCanvas] Container dimensions:",{parentWidth:m,parentHeight:f});const u=G=>{switch(G){case Ke.WEBGL:return{label:"WebGL",detail:"GPU accelerated (shaders, batching)",type:G};case Ke.CANVAS:return{label:"Canvas",detail:"CPU rasterization fallback",type:G};case Ke.HEADLESS:return{label:"Headless",detail:"No renderer active",type:G};default:return{label:"Detecting…",detail:"Negotiating renderer",type:G}}},g=()=>{const G=n.current;if(!G||!G.renderer){s({label:"Detecting…",detail:"Negotiating renderer",type:void 0});return}const B=u(G.renderer.type);s(B)},h={type:Ke.AUTO,width:m>0?m:800,height:f>0?f:600,backgroundColor:"#05070d",parent:t.current,scene:[ii,oi],scale:{mode:Ke.Scale.FIT,autoCenter:Ke.Scale.CENTER_BOTH,width:m>0?m:800,height:f>0?f:600},render:{antialias:!0,pixelArt:!1,roundPixels:!1,transparent:!1,powerPreference:"high-performance"},physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!1}},pixelArt:!1,roundPixels:!1,transparent:!1};if(console.log("[GameCanvas] Phaser config:",h),!n.current)try{n.current=new Ke.Game(h);const G=n.current;G.isBooted?g():G.events.once(Ke.Core.Events.READY,g),console.log("[GameCanvas] Phaser game initialized successfully")}catch(G){console.error("[GameCanvas] Error initializing Phaser:",G)}let I,y=null;const E={width:m,height:f},R=(G,B)=>{if(!n.current)return;const A=Math.max(0,Math.floor(G)),Q=Math.max(0,Math.floor(B));if(A===0||Q===0)return;const{width:$,height:de}=i.current;if($===A&&de===Q)return;i.current={width:A,height:Q},n.current.scale.resize(A,Q)},M=(G,B)=>{typeof G=="number"&&typeof B=="number"?(E.width=G,E.height=B):t.current&&(E.width=t.current.offsetWidth,E.height=t.current.offsetHeight),y!==null&&window.clearTimeout(y),y=window.setTimeout(()=>{y=null,R(E.width,E.height)},40)},F=()=>{M()};return typeof ResizeObserver<"u"&&t.current&&(I=new ResizeObserver(G=>{const B=G[0];B&&M(B.contentRect.width,B.contentRect.height)}),I.observe(t.current)),window.addEventListener("resize",F),()=>{console.log("[GameCanvas] Cleanup running"),window.removeEventListener("resize",F),y!==null&&window.clearTimeout(y),I&&I.disconnect(),n.current&&(n.current.events.off(Ke.Core.Events.READY,g),n.current.destroy(!0),n.current=null,console.log("[GameCanvas] Phaser game destroyed"))}},[]),console.log("[GameCanvas] Rendering component");const l=P(m=>m.settings.testMode),o=P(m=>m.settings.lightsEnabled),d=P(m=>m.settings.visualQualityPreset);return c.useEffect(()=>{li({lightsEnabled:o,qualityPreset:d})},[o,d]),c.useEffect(()=>{n.current&&window.requestAnimationFrame(()=>{window.dispatchEvent(new Event("resize"))})},[l]),c.useEffect(()=>{e&&e(r)},[e,r]),a.jsx("div",{style:{position:"relative",width:"100%",height:"100%",backgroundColor:"var(--color-gunmetal-900)",overflow:"hidden",display:"flex",justifyContent:"center",alignItems:"center",pointerEvents:"none"},children:a.jsx("div",{ref:t,style:{position:"absolute",width:"100%",height:"100%",top:0,left:0,right:0,bottom:0,display:"flex",justifyContent:"center",alignItems:"center",backgroundColor:"var(--color-gunmetal-900)",minWidth:"400px",minHeight:"300px",pointerEvents:"auto"}})})},Lo=()=>({type:"wait",score:0,summary:"Hold position",rationale:["No safer move available"]}),jo=e=>Lo(),jn=typeof window<"u"?window:globalThis;class No{constructor(){je(this,"timeouts",new Set)}schedule(t,n){const r=jn.setTimeout(()=>{this.timeouts.delete(r),t()},n);return this.timeouts.add(r),r}cancel(t){t!=null&&(jn.clearTimeout(t),this.timeouts.delete(t))}dispose(){this.timeouts.forEach(t=>{jn.clearTimeout(t)}),this.timeouts.clear()}}const Oo=()=>new No,De=["night"],Fo=[{zoneId:"downtown_checkpoint",cameras:[{id:"downtown_training_static",type:"static",position:{x:28,y:18},range:6,fieldOfView:90,activationPhases:De,sweep:{angles:[300,270,240],cycleDurationMs:2600}},{id:"downtown_static_01",type:"static",position:{x:18,y:22},range:8,fieldOfView:90,activationPhases:De,sweep:{angles:[310,270,230],cycleDurationMs:3200}},{id:"downtown_static_02",type:"static",position:{x:52,y:20},range:8,fieldOfView:90,activationPhases:De,sweep:{angles:[45,90,135],cycleDurationMs:3e3}},{id:"downtown_motion_01",type:"motionSensor",position:{x:36,y:44},range:4,fieldOfView:360,activationPhases:De,motionRadius:4},{id:"downtown_drone_01",type:"drone",position:{x:70,y:16},range:10,fieldOfView:90,activationPhases:De,patrolPath:{waypoints:[{x:70,y:16},{x:78,y:28},{x:64,y:34},{x:56,y:22}],travelDurationMs:12e3},sweep:{angles:[0,45,0,-45],cycleDurationMs:2800}}]},{zoneId:"gov_complex",cameras:[{id:"gov_static_01",type:"static",position:{x:14,y:12},range:9,fieldOfView:90,activationPhases:De,sweep:{angles:[315,270,225,180],cycleDurationMs:3600}},{id:"gov_static_02",type:"static",position:{x:40,y:10},range:9,fieldOfView:90,activationPhases:De,sweep:{angles:[0,45,90],cycleDurationMs:3600}},{id:"gov_motion_01",type:"motionSensor",position:{x:27,y:26},range:4,fieldOfView:360,activationPhases:De,motionRadius:4},{id:"gov_motion_02",type:"motionSensor",position:{x:48,y:26},range:4,fieldOfView:360,activationPhases:De,motionRadius:4},{id:"gov_drone_01",type:"drone",position:{x:56,y:18},range:12,fieldOfView:90,activationPhases:De,patrolPath:{waypoints:[{x:56,y:18},{x:70,y:24},{x:60,y:36},{x:46,y:28}],travelDurationMs:14e3},sweep:{angles:[15,0,-15],cycleDurationMs:2600}},{id:"gov_static_03",type:"static",position:{x:32,y:6},range:9,fieldOfView:90,activationPhases:De,sweep:{angles:[200,240,280],cycleDurationMs:3400}}]},{zoneId:"corporate_plaza",cameras:[{id:"corp_static_01",type:"static",position:{x:12,y:12},range:8,fieldOfView:90,activationPhases:De,sweep:{angles:[40,0,-40],cycleDurationMs:3e3}},{id:"corp_motion_01",type:"motionSensor",position:{x:26,y:22},range:4,fieldOfView:360,activationPhases:De,motionRadius:4},{id:"corp_drone_01",type:"drone",position:{x:34,y:14},range:10,fieldOfView:90,activationPhases:De,patrolPath:{waypoints:[{x:34,y:14},{x:42,y:16},{x:40,y:28},{x:30,y:24}],travelDurationMs:1e4},sweep:{angles:[90,120,90,60],cycleDurationMs:2400}}]},{zoneId:"industrial_corridor",cameras:[{id:"ind_static_01",type:"static",position:{x:8,y:32},range:9,fieldOfView:90,activationPhases:De,sweep:{angles:[180,210,240],cycleDurationMs:3200}},{id:"ind_motion_01",type:"motionSensor",position:{x:22,y:40},range:4,fieldOfView:360,activationPhases:De,motionRadius:4}]},{zoneId:"resistance_safehouse",cameras:[]}],zo=e=>{const t=Fo.find(n=>n.zoneId===e);return t?t.cameras.map(n=>({...n})):[]},Ho=400,Bo=3200,ma=e=>{const t=typeof e=="number"&&Number.isFinite(e)?Math.abs(e):Bo;return Math.max(Ho,t)},Ft=e=>{const t=ci(e);return t<0?t+360:t},$o=e=>{var r;const t=((r=e.sweep)==null?void 0:r.angles)??[],n=t.length>0?Ft(t[0]):Ft(e.fieldOfView>=360?0:e.fieldOfView/2);return{...e,alertState:ee.IDLE,detectionProgress:0,isActive:!1,hackState:{},lastDetectionTimestamp:void 0,currentDirection:n,sweepDirection:1,sweepElapsedMs:0,sweepIndex:0,patrolProgressMs:0,currentWaypointIndex:0,networkAlertContributionAt:void 0,trackingPlayer:!1,trackingDirection:void 0}},pa=(e,t,n,r)=>{const s=e.sweep;if(!s||s.angles.length===0)return{direction:n?r:e.currentDirection,sweepDirection:e.sweepDirection??1,sweepIndex:e.sweepIndex??0,sweepElapsedMs:e.sweepElapsedMs??0};const i=s.angles,l=i.length;if(l===1){const M=n?r+i[0]:i[0];return{direction:Ft(M),sweepDirection:e.sweepDirection??1,sweepIndex:0,sweepElapsedMs:0}}let o=e.sweepDirection??1,d=_e(e.sweepIndex??0,0,l-1),m=(e.sweepElapsedMs??0)+t;const f=ma(s.cycleDurationMs)/(l-1);for(;m>=f;){m-=f;let M=d+o;M>=l?(o=-1,M=l-2):M<0&&(o=1,M=1),d=_e(M,0,l-1)}const u=_e(d+o,0,l-1),g=_e(f===0?0:m/f,0,1),h=i[d],I=i[u],y=di(h,I),E=h+y*g,R=n?r+E:E;return{direction:Ft(R),sweepDirection:o,sweepIndex:d,sweepElapsedMs:m}},ga=(e,t)=>{const n=pa(e,t,!1,0);return e.currentDirection=n.direction,e.sweepDirection=n.sweepDirection,e.sweepIndex=n.sweepIndex,e.sweepElapsedMs=n.sweepElapsedMs,e},Nn=(e,t)=>t===0?0:e<0?t-1:e>=t?0:e,Wo=(e,t)=>{const n=e.patrolPath;if(!n||n.waypoints.length===0)return ga(e,t);const r=n.waypoints,s=ma(n.travelDurationMs)/r.length;let i=(e.patrolProgressMs??0)+t,l=Nn(e.currentWaypointIndex??0,r.length),o=Nn(l+1,r.length);for(;i>=s;)i-=s,l=o,o=Nn(l+1,r.length);const d=r[l],m=r[o],f=s<=0?0:_e(i/s,0,1),u=Dr(d.x,m.x,f),g=Dr(d.y,m.y,f),h=Math.atan2(m.y-d.y,m.x-d.x),I=sa(h),y=pa(e,t,!0,I);return e.position={x:u,y:g},e.currentDirection=y.direction,e.currentWaypointIndex=l,e.patrolProgressMs=i,e.sweepDirection=y.sweepDirection,e.sweepIndex=y.sweepIndex,e.sweepElapsedMs=y.sweepElapsedMs,e},Uo=(e,t)=>{let n;switch(e.type){case"drone":n=Wo(e,t);break;case"motionSensor":case"static":default:n=ga(e,t);break}return n.trackingPlayer&&typeof n.trackingDirection=="number"&&(n.currentDirection=Ft(n.trackingDirection)),n},Go=(e,t)=>{const{hackState:n}=e;return n?!!(n.disabledUntil&&n.disabledUntil>t):!1},Vo=(e,t)=>{const{hackState:n}=e;return!!(n!=null&&n.loopFootageUntil&&n.loopFootageUntil>t)},On=e=>{switch(e){case be.IDLE:return 0;case be.SUSPICIOUS:return 1;case be.INVESTIGATING:return 2;case be.ALARMED:return 3;default:return 0}},ha=(e,t)=>{const n=e.x-t.x,r=e.y-t.y;return Math.sqrt(n*n+r*r)},ya=(e,t)=>t.blackoutTier==="rolling"?.55:t.blackoutTier==="brownout"?.65:e==="night"?.7:e==="evening"||e==="morning"?.85:1,ba=e=>{var l;const t=((l=e.skillTraining)==null?void 0:l.stealth)??0,n=e.skills.agility??5,r=Math.min(t/120,.35),s=Math.max(0,(n-6)*.03),i=Math.min(.45,r+s);return _e(1-i,.55,1)},xa=e=>{switch(e.movementProfile){case"silent":return .7;case"sprint":return 1.15;default:return 1}},qo=e=>{const t=e.label;return typeof t=="string"&&t.trim().length>0?t:e.id.split(/[_-]/g).map(n=>n.charAt(0).toUpperCase()+n.slice(1)).join(" ")},Ko=({enemy:e,player:t,mapArea:n,timeOfDay:r,environmentFlags:s,playerVisible:i,timestamp:l})=>{const o=e.visionCone;if(!o||!i)return null;const d=e.alertLevel??be.IDLE,m=ha(e.position,t.position),f=o.range||8,u=_e(.7+On(d)*.06,.6,.95),g=_e(1-m/(f+1),.25,1),h=ya(r,s),I=ba(t),y=xa(t);return{witnessId:e.id,witnessLabel:e.name??"Guard",targetId:t.id,zoneId:n.zoneId,areaId:n.id,timestamp:l,source:"guard",recognitionChannel:"face",baseCertainty:u,distanceModifier:g,lightingModifier:h,disguiseModifier:I,postureModifier:y,reported:On(d)>=On(be.INVESTIGATING),location:{...e.position}}},Yo=({camera:e,player:t,mapArea:n,timeOfDay:r,environmentFlags:s,timestamp:i,alertState:l})=>{const o=ha(e.position,t.position),d=e.range||8,m=l===ee.ALARMED?.88:l===ee.INVESTIGATING?.76:l===ee.SUSPICIOUS?.65:.5,f=_e(1-o/(d+1),.3,1),u=ya(r,s),g=ba(t),h=xa(t);return{witnessId:e.id,witnessLabel:qo(e),targetId:t.id,zoneId:n.zoneId,areaId:n.id,timestamp:i,source:"camera",recognitionChannel:"face",baseCertainty:m,distanceModifier:f,lightingModifier:u,disguiseModifier:g,postureModifier:h,reported:l===ee.ALARMED,location:{...e.position}}},Xo=100/3e3,Qr=100/4e3,Qo=60,Zn=100,Zo=6e4,Jo=5*60*1e3,un={},nt={},va=(e,t)=>!e.activationPhases||e.activationPhases.length===0?!0:e.activationPhases.includes(t),el=e=>{const t=e%360;return t<0?t+360:t},tl=(e,t)=>{const n=Math.atan2(t.position.y-e.position.y,t.position.x-e.position.x),r=sa(n);return el(r)},wa=(e,t)=>{const n=t.x-e.x,r=t.y-e.y;return Math.sqrt(n*n+r*r)},Sa=(e,t)=>{var r;const n=(r=e.skillTraining)==null?void 0:r[t];return typeof n=="number"?n:0},nl=(e,t)=>{const n=e.type==="motionSensor"?e.motionRadius??e.range:e.range,r=Sa(t,"stealth"),s=_e(r/200,0,.75);let i=n*(1-s);const l=t.movementProfile==="silent"?.8:t.movementProfile==="sprint"?1.2:1;return i*=l,t.stealthModeEnabled&&(i*=.75),Math.max(1,i)},rl=(e,t,n,r,s,i,l)=>{if(!e.isActive)return{state:ee.DISABLED,progress:0,detectionActive:!1,lastDetectionTimestamp:void 0};if(Go(t,l))return{state:ee.DISABLED,progress:0,detectionActive:!1,lastDetectionTimestamp:void 0};const o=Vo(t,l),d=nl(e,n),m=wa(e.position,n.position);let f=!1;if(!o)if(e.type==="motionSensor"){const I=n.movementProfile!=="silent";f=m<=d&&s&&I}else Yn(e.position,n.position,{range:d,angle:e.fieldOfView,direction:e.currentDirection})&&Xn(e.position,n.position,r)&&(f=!0);let u=t.detectionProgress,g=t.lastDetectionTimestamp;if(f){const I=Sa(n,"hacking"),y=_e(I/400,0,.25),E=n.movementProfile==="silent"?.7:n.movementProfile==="sprint"?1.2:1,R=n.stealthModeEnabled?.75:1;u+=Xo*i*(1-y)*E*R,u=Math.min(Zn,u),g=l}else{const I=t.trackingPlayer?Qr*1.8:Qr;u-=I*i,u=Math.max(0,u)}const h=il(u);return h===ee.ALARMED&&(u=Zn),{state:h,progress:u,detectionActive:f,lastDetectionTimestamp:g}},sl=(e,t,n)=>{nt[e]||(nt[e]=[]),nt[e].push({cameraId:t,timestamp:n}),nt[e]=nt[e].filter(r=>n-r.timestamp<=Zo)},al=e=>{const t=nt[e];return t?t.length>=3:!1},Xt=e=>{switch(e){case ee.ALARMED:return 4;case ee.INVESTIGATING:return 3;case ee.SUSPICIOUS:return 2;case ee.IDLE:return 1;case ee.DISABLED:default:return 0}},il=e=>e>=Zn?ee.ALARMED:e>=Qo?ee.INVESTIGATING:e>0?ee.SUSPICIOUS:ee.IDLE,ol=e=>{const{area:t,timeOfDay:n,dispatch:r,timestamp:s}=e,l=zo(t.zoneId).map(o=>{const d=$o(o),m=va(d,n);return d.isActive=m,d.alertState=m?ee.IDLE:ee.DISABLED,d.detectionProgress=0,d.lastDetectionTimestamp=void 0,d});r(fi({areaId:t.id,zoneId:t.zoneId,cameras:l,timestamp:s})),un[t.id]={lastPlayerPosition:void 0,lastUpdateTimestamp:s,hudSnapshot:void 0},nt[t.id]=[]},Zr=e=>{const{areaId:t,dispatch:n}=e;n(ui({areaId:t})),delete un[t],delete nt[t]},ll=e=>{const{zone:t,area:n,timeOfDay:r,dispatch:s,timestamp:i}=e;if(!t||!n)return;const l=[];let o=!1;Object.values(t.cameras).forEach(d=>{const m=va(d,r);if(m===d.isActive&&(m||d.alertState===ee.DISABLED&&(d.detectionProgress??0)===0))return;const f={isActive:m,detectionProgress:m?d.detectionProgress:0,lastDetectionTimestamp:m?d.lastDetectionTimestamp:void 0,alertState:m?ee.IDLE:ee.DISABLED,trackingPlayer:!1,trackingDirection:void 0};m?o=!0:o=o||d.isActive,l.push({cameraId:d.id,changes:f})}),l.forEach(d=>{s(lr({areaId:t.areaId,cameraId:d.cameraId,changes:d.changes,timestamp:i}))}),o&&r!=="day"&&r!=="morning"&&s(aa({visible:!0,timestamp:i}))},cl=e=>{const{zone:t,mapArea:n,player:r,deltaMs:s,timestamp:i,dispatch:l,logStrings:o,reinforcementsScheduled:d,globalAlertLevel:m,timeOfDay:f,environmentFlags:u,worldTimeSeconds:g,onWitnessObservation:h}=e,I=un[t.areaId]??{lastPlayerPosition:void 0},y=I.lastPlayerPosition,E=y?y.x!==r.position.x||y.y!==r.position.y:!1,R=z=>z.type==="motionSensor"?z.motionRadius??z.range:z.range;let M=0,F=0,G=ee.IDLE,B=null;const A=[];let Q=!1,$=!1;Object.values(t.cameras).forEach(z=>{const T={...z,position:{...z.position},hackState:{...z.hackState}};Uo(T,s);const ue=rl(T,z,r,n,E,s,i);if(T.alertState=ue.state,T.detectionProgress=ue.progress,T.lastDetectionTimestamp=ue.lastDetectionTimestamp,T.alertState===ee.DISABLED&&(T.detectionProgress=0),T.type!=="motionSensor")if(T.isActive&&ue.detectionActive&&(T.alertState===ee.SUSPICIOUS||T.alertState===ee.INVESTIGATING||T.alertState===ee.ALARMED)){const L=tl(T,r);T.trackingPlayer=!0,T.trackingDirection=L,T.currentDirection=L}else T.trackingPlayer&&(T.trackingPlayer=!1,T.trackingDirection=void 0);else T.trackingPlayer&&(T.trackingPlayer=!1,T.trackingDirection=void 0);const Z=T.alertState!==z.alertState,fe=T.currentDirection!==z.currentDirection,Y=T.position.x!==z.position.x||T.position.y!==z.position.y,J=Math.abs(T.detectionProgress-z.detectionProgress)>.1,le=T.lastDetectionTimestamp!==z.lastDetectionTimestamp,me=T.sweepDirection!==z.sweepDirection||T.sweepIndex!==z.sweepIndex||Math.abs((T.sweepElapsedMs??0)-(z.sweepElapsedMs??0))>.1,xe=(T.trackingPlayer??!1)!==(z.trackingPlayer??!1),ke=T.trackingDirection!==z.trackingDirection;if(Z&&(T.alertState===ee.SUSPICIOUS||T.alertState===ee.INVESTIGATING||T.alertState===ee.ALARMED)){const x=Yo({camera:T,player:r,mapArea:n,timeOfDay:f,environmentFlags:u,timestamp:g,alertState:T.alertState});h&&h(x)}if((Z||fe||Y||J||le||me||xe||ke)&&A.push({cameraId:z.id,runtime:T,previous:z}),Z&&T.alertState===ee.ALARMED&&($=!0,sl(t.areaId,z.id,i)),T.isActive&&T.alertState!==ee.DISABLED){const x=R(T);wa(T.position,r.position)<=x+.5&&(M+=1)}T.detectionProgress>F&&(F=T.detectionProgress,B=z.id),Xt(T.alertState)>Xt(G)&&(G=T.alertState)}),A.forEach(({cameraId:z,runtime:T,previous:ue})=>{const Z={alertState:T.alertState,detectionProgress:T.detectionProgress,currentDirection:T.currentDirection,lastDetectionTimestamp:T.lastDetectionTimestamp,position:T.position,sweepDirection:T.sweepDirection,sweepIndex:T.sweepIndex,sweepElapsedMs:T.sweepElapsedMs,patrolProgressMs:T.patrolProgressMs,currentWaypointIndex:T.currentWaypointIndex,trackingPlayer:T.trackingPlayer,trackingDirection:T.trackingDirection};if(T.isActive||(Z.detectionProgress=0,Z.alertState=ee.DISABLED,Z.lastDetectionTimestamp=void 0,Z.trackingPlayer=!1,Z.trackingDirection=void 0),l(lr({areaId:t.areaId,cameraId:z,changes:Z,timestamp:i})),ue.alertState!==T.alertState){const fe=Xt(ue.alertState);Xt(T.alertState)>fe&&(T.alertState===ee.SUSPICIOUS?l(O(o.cameraAlertSuspicious)):T.alertState===ee.INVESTIGATING?l(O(o.cameraAlertInvestigating)):T.alertState===ee.ALARMED&&l(O(o.cameraAlertAlarmed)))}});const de=nt[t.areaId]??[];let ne=t.networkAlert;if(ne&&ne.expiresAt<=i&&(l(_r({areaId:t.areaId,alert:null})),ne=null),!ne&&al(t.areaId)){Q=!0;const z=de.slice(-3).map(T=>T.cameraId);ne={triggeredAt:i,expiresAt:i+Jo,contributingCameraIds:z},l(_r({areaId:t.areaId,alert:ne}))}const S={camerasNearby:M,detectionProgress:Number(Math.min(100,F).toFixed(2)),alertState:G,activeCameraId:B,networkAlertActive:!!ne,networkAlertExpiresAt:(ne==null?void 0:ne.expiresAt)??null},N=I.hudSnapshot;(!N||N.camerasNearby!==S.camerasNearby||Math.abs(N.detectionProgress-S.detectionProgress)>.5||N.alertState!==S.alertState||N.activeCameraId!==S.activeCameraId||N.networkAlertActive!==S.networkAlertActive||N.networkAlertExpiresAt!==S.networkAlertExpiresAt)&&(l(mi(S)),I.hudSnapshot=S),$&&!d?(l(O(o.reinforcementsIncoming)),l(ia()),l(rn(be.ALARMED))):Q?(l(O(o.curfewReinforcement)),l(rn(be.ALARMED))):$&&m!==be.ALARMED&&l(rn(be.ALARMED)),un[t.areaId]={...I,lastPlayerPosition:{...r.position},lastUpdateTimestamp:i}},ut=[],dl=e=>{const t=ut.findIndex(n=>n.id===e.id);if(t>=0){ut[t]={...ut[t],...e},ut[t].fired=!1,ut[t].lastFiredAt=void 0;return}ut.push({...e})},ul=e=>{e.forEach(dl)},fl=(e,t,n=Date.now())=>{const r=t();ut.forEach(s=>{s.once&&s.fired||typeof s.cooldownMs=="number"&&s.lastFiredAt!==void 0&&n-s.lastFiredAt<s.cooldownMs||!s.when(r)||(s.fire({dispatch:e,getState:t,now:n}),s.lastFiredAt=n,s.once&&(s.fired=!0))})},ml={low:[{id:"rumor.low.coyotes-logo",groupId:"slum-barflies",flag:"gangHeat",value:"low",storyFunction:"world-building",description:"Warm-up chatter when the streets are calm.",lines:["Coyotes rebranded again. Same howls, new accounting font.","CorpSec confiscated their synth-leather jackets. Fashion crime unit, I guess.","If the gang war is over, someone forgot to tell the bullet holes."]},{id:"rumor.low.tax-audit",groupId:"dock-liquor-patrons",flag:"gangHeat",value:"low",storyFunction:"foreshadow",description:"Hints at upcoming tensions despite low heat.",lines:["Heard the Coyotes scheduled a tax audit. They grow up so fast.","You know it’s quiet when the bartops stop vibrating.","Peace smells like ozone and unpaid protection money."]}],med:[{id:"rumor.med.return",groupId:"slum-barflies",flag:"gangHeat",value:"med",storyFunction:"misdirect",description:"Contradicts official statements to set up later payoffs.",lines:["Coyotes are back. Again. They brought merch this time.","Saw their lieutenant handing out coupons for muggings. 20% off with code “WHOOPS”.","If the city says everything is fine, duck."]},{id:"rumor.med.payroll",groupId:"dock-liquor-patrons",flag:"gangHeat",value:"med",storyFunction:"payoff",description:"Signals growing pressure around the docks.",lines:["Dock payroll went missing. Must have taken the scenic route through a heist.","CorpSec switched to hazard pay. They called it “enthusiasm adjustment”.","Graffiti keeps spelling “WE ARE TEMPORARY”. Someone stamped “UNTIL AUDIT COMPLETE” on top."]}],high:[{id:"rumor.high.curfew",groupId:"slum-barflies",flag:"gangHeat",value:"high",storyFunction:"foreshadow",description:"Signals impending clampdowns.",lines:["Curfew now starts before brunch. Crime brunch still sold out.","Coyotes swapped bullets for invoices. Same damage, more paperwork.","Saw CorpSec drones high-fiving. Never a good omen."]},{id:"rumor.high.wanted",groupId:"dock-liquor-patrons",flag:"gangHeat",value:"high",storyFunction:"payoff",description:"Pairs with power glitch triggers that reveal wanted posters.",lines:["CRTs keep flashing some wanted face. He already skipped town, obviously.","Dock sirens learned harmony. It’s unnerving in four-part.","When the lights flicker, we clap. Keeps the grid on edge."]}]},pl=e=>ml[e]??[],gl=[{id:"note.supply.norm.crate",flag:"supplyScarcity",value:"norm",storyFunction:"world-building",description:"Everyday logistics with a dry punchline.",preferredZoneId:"downtown_checkpoint",position:{x:28,y:26},lines:["[DATE STAMP SMEARED]","Shift log: 6 crates “medical”.","Counted 5.","Crate 6 coughing."]},{id:"note.supply.tight.ammo-iou",flag:"supplyScarcity",value:"tight",storyFunction:"misdirect",description:"Sets up later gag about returned bullets.",preferredZoneId:"downtown_checkpoint",position:{x:34,y:30},lines:["IOU: 3 bullets. Return unused.","Signed: Depot Clerk, with love.","PS: Bring wipes."]},{id:"note.supply.rationed.bullet-receipt",flag:"supplyScarcity",value:"rationed",storyFunction:"payoff",description:"Punchline for earlier IOU rumor.",preferredZoneId:"downtown_checkpoint",position:{x:36,y:28},lines:["Receipt: All three bullets returned.","Two still lodged in debtor.","Processing fee waived."]},{id:"note.curfew.tier2",flag:"curfewLevel",value:2,storyFunction:"foreshadow",description:"Hints at creeping curfew changes.",preferredZoneId:"downtown_checkpoint",position:{x:40,y:24},lines:["Memo: Curfew trial balloon.","Please begin night at 3 PM.","Public feedback: “Already dark”."]},{id:"note.gangHeat.high",flag:"gangHeat",value:"high",storyFunction:"payoff",description:"Ties to high-heat rumors.",preferredZoneId:"downtown_checkpoint",position:{x:32,y:34},lines:["Wanted poster: “Seen smiling. Suspicious.”","Reward: Half-price cola (while grid stable).","Report sightings to CO-LAW vending kiosks."]},{id:"note.gangHeat.low.suspicion-drill",flag:"gangHeat",value:"low",storyFunction:"world-building",description:"Field memo coaching crews on witness heat drills.",preferredZoneId:"downtown_checkpoint",position:{x:30,y:24},lines:["Ops memo: Trigger one patrol sighting and log the heat spike.","Break line-of-sight, watch the Suspicion Inspector cool to calm.","Report anomalies to George so the city remembers accurately."]}],hl=(e,t)=>gl.filter(n=>n.flag===e&&n.value===t),ka=[{id:"sign.blackout.none.cola",signId:"downtown.vending.primary",flag:"blackoutTier",value:"none",storyFunction:"world-building",description:"Default advertising bluster.",text:"COLA: Now with 12 essential sugars."},{id:"sign.blackout.brownout.colaw",signId:"downtown.vending.primary",flag:"blackoutTier",value:"brownout",storyFunction:"misdirect",description:"First hint the grid is lying.",text:"CO-LAW: Report loiterers, earn fizz miles."},{id:"sign.blackout.rolling.alert",signId:"downtown.vending.primary",flag:"blackoutTier",value:"rolling",storyFunction:"payoff",description:"Full propaganda mode during outages.",text:"CO-LAW: Lights out? Snitch brighter."},{id:"sign.supply.tight.milk",signId:"corner.bodega.priceboard",flag:"supplyScarcity",value:"tight",storyFunction:"foreshadow",description:"Price jumps signal scarcity.",text:"Milk: 45 credits. Bottles scowl included."},{id:"sign.supply.rationed.ammo",signId:"corner.bodega.priceboard",flag:"supplyScarcity",value:"rationed",storyFunction:"payoff",description:"Ammo “sale” becomes a comedic beat.",text:"Ammo Sale*: *Bring your own casing."}],Jr=(e,t)=>ka.filter(n=>n.flag===e&&n.value===t),yl=e=>ka.find(t=>t.id===e),dr=[{id:"weather.curfew.0",flag:"curfewLevel",value:0,rainIntensity:0,thunderActive:!1,sirenLoop:!1,storyFunction:"world-building",description:"Dry air wobble when curfew is dormant."},{id:"weather.curfew.1",flag:"curfewLevel",value:1,rainIntensity:.2,thunderActive:!1,sirenLoop:!1,storyFunction:"foreshadow",description:"Light drizzle telegraphs rising tension."},{id:"weather.curfew.2",flag:"curfewLevel",value:2,rainIntensity:.6,thunderActive:!1,sirenLoop:!0,storyFunction:"payoff",description:"Rain and sirens when curfew crosses enforcement threshold."},{id:"weather.curfew.3",flag:"curfewLevel",value:3,rainIntensity:.85,thunderActive:!0,sirenLoop:!0,storyFunction:"world-building",description:"Thunderclaps sync with decision beats at max curfew."},{id:"weather.gangHeat.high",flag:"gangHeat",value:"high",rainIntensity:.75,thunderActive:!0,sirenLoop:!0,storyFunction:"misdirect",description:"Extra thunder during high gang heat for dramatic cues."}],bl=e=>dr.find(t=>t.flag==="curfewLevel"&&typeof t.value=="number"&&t.value===e),xl=e=>dr.find(t=>t.flag==="gangHeat"&&t.value===e),vl=e=>dr.find(t=>t.id===e),es={"slum-barflies":[{dialogueId:"npc_lira_vendor"},{dialogueId:"npc_courier_brant"}],"dock-liquor-patrons":[{dialogueId:"npc_captain_reyna"},{dialogueId:"npc_drone_handler_kesh"}]},wl=()=>["low","med","high"].flatMap(t=>pl(t).map(r=>({id:`environment.rumor.${r.id}`,cooldownMs:1e3,when:s=>{const{flags:i,rumorSets:l}=s.world.environment;if(i.gangHeat!==t||!(r.groupId in es))return!1;const o=l[r.groupId];return!o||o.sourceId!==r.id},fire:({dispatch:s,getState:i,now:l})=>{const d=i().settings.locale,m=ot(d).logs,f=es[r.groupId];s(pi({groupId:r.groupId,snapshot:{lines:[...r.lines],storyFunction:r.storyFunction,sourceId:r.id,updatedAt:l}})),f.forEach(u=>{s(gi({match:u,profile:{lines:[...r.lines],storyFunction:r.storyFunction,sourceId:r.id,updatedAt:l}}))}),s(O(m.environmentRumorSwap(r.description)))}}))),ts=e=>{const{flags:t}=e.world.environment;if(t.curfewLevel<3){const n=xl(t.gangHeat);if(n)return n}return bl(t.curfewLevel)??null},Sl=()=>[{id:"environment.weather.update",when:e=>{const t=ts(e);if(!t)return!1;const n=e.world.environment.weather,r=e.world.timeOfDay,s=n.presetId!==t.id,i=n.timeOfDay!==r;return s||i},fire:({dispatch:e,getState:t,now:n})=>{const r=t(),s=ts(r);if(!s)return;const i=r.world.environment.weather,l=r.world.timeOfDay,o=r.settings.locale,d=ot(o).logs;if(e(hi({presetId:s.id,rainIntensity:s.rainIntensity,sirenLoop:s.sirenLoop,thunderActive:s.thunderActive,storyFunction:s.storyFunction,updatedAt:n,timeOfDay:l})),i.presetId!==s.id||i.timeOfDay!==l){const m=s.description??s.id;e(O(d.environmentWeatherShift(m)))}}}],kl=()=>{const e=["none","brownout","rolling"],t=["norm","tight","rationed"],n=e.flatMap(s=>Jr("blackoutTier",s).map(l=>({id:`environment.signage.${l.id}`,cooldownMs:4e3,when:o=>{if(o.world.environment.flags.blackoutTier!==s)return!1;const d=o.world.environment.signage[l.signId];return!d||d.variantId!==l.id},fire:({dispatch:o,getState:d,now:m})=>{const f=d().settings.locale,u=ot(f).logs;o(Lr({signId:l.signId,snapshot:{variantId:l.id,storyFunction:l.storyFunction,updatedAt:m}})),o(O(u.environmentSignageSwap(l.text)))}}))),r=t.flatMap(s=>Jr("supplyScarcity",s).map(l=>({id:`environment.signage.${l.id}`,cooldownMs:4e3,when:o=>{if(o.world.environment.flags.supplyScarcity!==s)return!1;const d=o.world.environment.signage[l.signId];return!d||d.variantId!==l.id},fire:({dispatch:o,getState:d,now:m})=>{const f=d().settings.locale,u=ot(f).logs;o(Lr({signId:l.signId,snapshot:{variantId:l.id,storyFunction:l.storyFunction,updatedAt:m}})),o(O(u.environmentSignageSwap(l.text)))}})));return[...n,...r]},Il=()=>{const e=["norm","tight","rationed"],t=["low","med","high"],n=[0,1,2,3],r=(s,i)=>i.flatMap(l=>hl(s,l).map(d=>({id:`environment.notes.${d.id}`,cooldownMs:5e3,when:m=>{const f=m.world.environment.flags;return(s==="supplyScarcity"?f.supplyScarcity===l:s==="gangHeat"?f.gangHeat===l:f.curfewLevel===l)?!m.world.environment.notes.some(g=>g.definitionId===d.id):!1},fire:({dispatch:m,getState:f,now:u})=>{const g=f(),h=g.world.currentMapArea.id,I=g.settings.locale,y=ot(I).logs;m(yi({instanceId:`env-note::${d.id}`,definitionId:d.id,areaId:h,lines:[...d.lines],storyFunction:d.storyFunction,spawnedAt:u})),m(O(y.environmentNoteSpawned(d.description??"new memo recovered")))}})));return[...r("supplyScarcity",e),...r("gangHeat",t),...r("curfewLevel",n)]};let ns=!1;const El=()=>{if(ns)return;const e=[...wl(),...Sl(),...kl(),...Il()];ul(e),ns=!0},rs={light:0,balanced:1,heavy:2,sensor:3},ss={open:0,restricted:1,sealed:2},as={clear:0,caution:1,severe:2},Tl={"smog:none":{},"smog:light":{behavior:{sightMultiplier:.9,chaseMultiplier:.95,routineIntervalMultiplier:1.05},travel:{visibilityMultiplier:.85,staminaDrainPerMinute:1,encounterRiskModifier:1.1,advisoryLevel:"caution"}},"smog:heavy":{behavior:{sightMultiplier:.65,chaseMultiplier:.8,loadoutBias:"sensor",routineIntervalMultiplier:1.2},travel:{visibilityMultiplier:.55,staminaDrainPerMinute:3,encounterRiskModifier:1.35,vehicleWearMultiplier:1.2,advisoryLevel:"severe"}},"blackout:none":{},"blackout:brownout":{behavior:{sightMultiplier:.95},faction:{shopMarkupDelta:.05,reinforcementDelayMultiplier:1.1,safehouseAccess:"restricted"},travel:{visibilityMultiplier:.8,advisoryLevel:"caution"}},"blackout:rolling":{behavior:{sightMultiplier:.85,loadoutBias:"sensor"},faction:{shopMarkupDelta:.12,reinforcementDelayMultiplier:.9,safehouseAccess:"restricted"},travel:{visibilityMultiplier:.7,vehicleWearMultiplier:1.1,advisoryLevel:"caution"}},"surveillance:low":{},"surveillance:elevated":{behavior:{chaseMultiplier:1.15,routineIntervalMultiplier:1.05},faction:{reinforcementDelayMultiplier:.95},travel:{encounterRiskModifier:1.2,advisoryLevel:"caution"}},"surveillance:extreme":{behavior:{sightMultiplier:1.1,chaseMultiplier:1.3,loadoutBias:"sensor",routineIntervalMultiplier:1.15},faction:{shopMarkupDelta:.08,reinforcementDelayMultiplier:.75,safehouseAccess:"restricted"},travel:{encounterRiskModifier:1.4,advisoryLevel:"severe"}},"radiation:none":{},"radiation:localized":{behavior:{routineIntervalMultiplier:1.08},faction:{safehouseAccess:"restricted"},travel:{staminaDrainPerMinute:2,vehicleWearMultiplier:1.15,advisoryLevel:"caution"}},"radiation:pervasive":{behavior:{routineIntervalMultiplier:1.18,loadoutBias:"heavy"},faction:{shopMarkupDelta:.1,safehouseAccess:"sealed"},travel:{staminaDrainPerMinute:4,vehicleWearMultiplier:1.3,encounterRiskModifier:1.25,advisoryLevel:"severe"}},"curfew:off":{},"curfew:tight":{behavior:{chaseMultiplier:1.1,routineIntervalMultiplier:1.05},faction:{shopMarkupDelta:.08,reinforcementDelayMultiplier:.85,safehouseAccess:"restricted"},travel:{encounterRiskModifier:1.25,advisoryLevel:"caution"}},"curfew:lockdown":{behavior:{chaseMultiplier:1.35,routineIntervalMultiplier:1.25,loadoutBias:"heavy"},faction:{shopMarkupDelta:.2,reinforcementDelayMultiplier:.65,safehouseAccess:"sealed"},travel:{encounterRiskModifier:1.6,advisoryLevel:"severe"}}},ft=(e,t,n)=>_e(e,t,n),Cl=()=>({behavior:{sightMultiplier:1,chaseMultiplier:1,routineIntervalMultiplier:1,loadoutBias:"balanced"},faction:{shopMarkupDelta:0,reinforcementDelayMultiplier:1,safehouseAccess:"open"},travel:{staminaDrainPerMinute:0,vehicleWearMultiplier:1,encounterRiskModifier:1,advisoryLevel:"clear",visibilityMultiplier:1}}),Ml=(e,t)=>{if(t&&(typeof t.sightMultiplier=="number"&&(e.sightMultiplier=ft(e.sightMultiplier*t.sightMultiplier,.35,1.8)),typeof t.chaseMultiplier=="number"&&(e.chaseMultiplier=ft(e.chaseMultiplier*t.chaseMultiplier,.5,2)),typeof t.routineIntervalMultiplier=="number"&&(e.routineIntervalMultiplier=ft(e.routineIntervalMultiplier*t.routineIntervalMultiplier,.7,2.2)),t.loadoutBias)){const n=rs[e.loadoutBias];rs[t.loadoutBias]>n&&(e.loadoutBias=t.loadoutBias)}},Pl=(e,t)=>{if(t&&(typeof t.shopMarkupDelta=="number"&&(e.shopMarkupDelta=_e(e.shopMarkupDelta+t.shopMarkupDelta,-.5,1)),typeof t.reinforcementDelayMultiplier=="number"&&(e.reinforcementDelayMultiplier=ft(e.reinforcementDelayMultiplier*t.reinforcementDelayMultiplier,.4,1.6)),t.safehouseAccess)){const n=ss[e.safehouseAccess];ss[t.safehouseAccess]>n&&(e.safehouseAccess=t.safehouseAccess)}},Rl=(e,t)=>{if(t&&(typeof t.staminaDrainPerMinute=="number"&&(e.staminaDrainPerMinute=_e(e.staminaDrainPerMinute+t.staminaDrainPerMinute,0,12)),typeof t.vehicleWearMultiplier=="number"&&(e.vehicleWearMultiplier=ft(e.vehicleWearMultiplier*t.vehicleWearMultiplier,.6,2)),typeof t.encounterRiskModifier=="number"&&(e.encounterRiskModifier=ft(e.encounterRiskModifier*t.encounterRiskModifier,.5,3)),typeof t.visibilityMultiplier=="number"&&(e.visibilityMultiplier=ft(e.visibilityMultiplier*t.visibilityMultiplier,.2,1)),t.advisoryLevel)){const n=as[e.advisoryLevel];as[t.advisoryLevel]>n&&(e.advisoryLevel=t.advisoryLevel)}},Al=e=>{const t=Cl();return e.forEach(n=>{const r=Tl[n];r&&(r.behavior&&Ml(t.behavior,r.behavior),r.faction&&Pl(t.faction,r.faction),r.travel&&Rl(t.travel,r.travel))}),t},Dl=e=>{if(!e||e.length===0)return"none";const t=e.map(n=>n.toLowerCase());return t.some(n=>n.includes("dense smog")||n.includes("toxic smog"))?"heavy":t.some(n=>n.includes("smog")||n.includes("gas cloud"))?"light":"none"},_l=(e,t)=>{let n="low";(e.gangHeat!=="low"||e.curfewLevel>=1)&&(n="elevated");const r=(t==null?void 0:t.map(s=>s.toLowerCase()))??[];return(e.gangHeat==="high"||e.curfewLevel>=3||r.some(s=>s.includes("camera")||s.includes("drone")||s.includes("surveillance")||s.includes("riot squad")))&&(n="extreme"),n},Ll=e=>{if(!e||e.length===0)return"none";const t=e.map(n=>n.toLowerCase());return t.some(n=>n.includes("radiation pocket")||n.includes("reactor"))?"localized":t.some(n=>n.includes("radiation")||n.includes("toxic sludge"))?"pervasive":"none"},jl=e=>e>=3?"lockdown":e>=1?"tight":"off",Nl=e=>{const t=Dl(e.zoneHazards);let n=Ll(e.zoneHazards);n==="none"&&e.zoneId&&(e.zoneId.includes("industrial")||e.zoneId.includes("wasteland"))&&(n="localized");const r=_l(e.flags,e.zoneHazards),s=jl(e.flags.curfewLevel),i=`blackout:${e.flags.blackoutTier}`;return[`smog:${t}`,i,`surveillance:${r}`,`radiation:${n}`,`curfew:${s}`]},ur=e=>e.world.environment,Ht=X(ur,e=>e.flags);X(Ht,e=>e.gangHeat);X(Ht,e=>e.curfewLevel);X(Ht,e=>e.supplyScarcity);X(Ht,e=>e.blackoutTier);X(ur,e=>e.notes);const Ia=e=>e.world.currentMapArea,Ol=X([Ht,Ia],(e,t)=>({flags:e,zoneHazards:(t==null?void 0:t.hazards)??[],zoneId:(t==null?void 0:t.zoneId)??null})),Fl=X(Ol,e=>Nl(e)),Ea=X(Fl,e=>Al(e)),zl=e=>e.length===0?null:[...e].sort((n,r)=>((r==null?void 0:r.updatedAt)??0)-((n==null?void 0:n.updatedAt)??0))[0]??null,Hl=e=>e.length===0?null:[...e].sort((n,r)=>((r==null?void 0:r.updatedAt)??0)-((n==null?void 0:n.updatedAt)??0))[0]??null,Bl=X([ur,Ia,Ea],(e,t,n)=>{const r=Object.entries(e.rumorSets).map(([d,m])=>({groupId:d,lines:[...m.lines],storyFunction:m.storyFunction,updatedAt:m.updatedAt})),s=Object.entries(e.signage).map(([d,m])=>{const f=yl(m.variantId);return{signId:d,text:(f==null?void 0:f.text)??"",storyFunction:(f==null?void 0:f.storyFunction)??m.storyFunction,updatedAt:m.updatedAt}}),i=e.weather.presetId?vl(e.weather.presetId):null,l={presetId:e.weather.presetId,description:(i==null?void 0:i.description)??"",storyFunction:(i==null?void 0:i.storyFunction)??e.weather.storyFunction,updatedAt:e.weather.updatedAt,rainIntensity:e.weather.rainIntensity,thunderActive:e.weather.thunderActive,timeOfDay:e.weather.timeOfDay},o={zoneId:(t==null?void 0:t.zoneId)??null,zoneName:(t==null?void 0:t.displayName)??(t==null?void 0:t.name)??null,dangerRating:(t==null?void 0:t.dangerRating)??null,hazards:Array.isArray(t==null?void 0:t.hazards)?[...t.hazards]:[],summary:(t==null?void 0:t.summary)??null,directives:Array.isArray(t==null?void 0:t.objectives)?t.objectives.filter(d=>d&&d.trim().length>0).map(d=>d.trim()):[]};return{flags:{...e.flags},impacts:n,rumor:zl(r),signage:Hl(s),weather:l,zone:o}}),Ta=e=>!!e.settings.reputationSystemsEnabled,Ca=e=>e.suspicion,Ma=e=>X(Ca,Ta,(t,n)=>!n||!e?null:t.zones[e]??null),Pa=e=>X(Ma(e),t=>t?t.heat:{zoneId:e??"unknown",totalHeat:0,tier:"calm",leadingWitnessIds:[]});X(Ca,Ta,(e,t)=>t?bi(e.zones):"calm");const $l=e=>X(Ma(e),t=>{if(!t)return[];const{heat:n,memories:r}=t;return n.leadingWitnessIds.map(s=>r[s]).filter(s=>!!s).map(s=>xi(s))}),Et=e=>e.paranoia,Ra=X(Et,e=>e.value),Wl=X(Et,e=>e.tier);X(Ra,e=>Math.max(0,Math.min(1,e/100)));X(Et,e=>e.cooldowns);const Ul=X(Et,e=>e.lastSnapshot);X(Et,e=>e.frozen);const Gl=()=>({cameraAlarmedAt:{},guardAlertRank:{},lastCurfewActive:!1,lastLowHealth:!1,lastLowAmmo:!1,lastSafehouse:!1}),is=()=>Gl(),os=e=>{switch(e){case be.ALARMED:return 3;case be.INVESTIGATING:return 2;case be.SUSPICIOUS:return 1;default:return 0}},Vl=e=>e.type==="motionSensor"?e.motionRadius??e.range:e.range,ql=(e,t)=>{var n,r,s;return e?!!((n=e.zoneId)!=null&&n.toLowerCase().includes("safehouse")||(r=e.name)!=null&&r.toLowerCase().includes("safehouse")||(s=t==null?void 0:t.zoneId)!=null&&s.toLowerCase().includes("safehouse")):!1},Kl=(e,t)=>t<=0?0:_e(e/t,0,1),Yl=e=>e>=7?.5:e>=5?.8:1,Xl=(e,t,n,r)=>e!=="day"||t||n>.02?!1:r===0,Ql=(e,t)=>{var ne;const n=Math.max(0,e.deltaMs)/1e3,r={},s={},i={},l=e.player,o=e.mapArea,d=e.surveillanceZone,m=Math.max(1,l.skills.perception??5),f=Math.max(1,l.skills.endurance??5),u=Math.max(1,l.skills.intelligence??5),g=Math.max(1,l.skills.charisma??5),h=Math.max(1,l.skills.luck??5),I=_e(1+m*.02-f*.03-u*.03-g*.02,.5,1.8),y=1+f*.02+u*.02+h*.01,E=Yl(h);if(d&&o){let S=0,N=0;if(Object.values(d.cameras).forEach(W=>{if(!W.isActive||W.alertState===ee.DISABLED)return;const z=Vl(W),T=W.position.x-l.position.x,ue=W.position.y-l.position.y,Z=Math.hypot(T,ue);if(Z<=Se.surveillance.proximityRadius){const fe=1-Math.min(Z/Se.surveillance.proximityRadius,1);S+=fe*Se.surveillance.proximityGainPerSecond*n}if(W.type!=="motionSensor"&&Yn(W.position,l.position,{range:z,angle:W.fieldOfView,direction:W.currentDirection})&&Xn(W.position,l.position,o)&&(N+=Se.surveillance.coneGainPerSecond*n),W.alertState===ee.ALARMED){const fe=t.cameraAlarmedAt[W.id]??0;e.timestamp-fe>=1e4&&(i[`camera:${W.id}`]=Se.surveillance.alertSpike*E,t.cameraAlarmedAt[W.id]=e.timestamp)}}),S>0){const W=Math.min(S,Se.surveillance.maxProximityContributionPerSecond*n);r.camerasProximity=W}N>0&&(r.camerasSweep=N)}let R=0;e.enemies.forEach(S=>{if(!o||!S.visionCone){t.guardAlertRank[S.id]=os(S.alertLevel);return}(Yn(S.position,l.position,S.visionCone)?Xn(S.position,l.position,o):!1)&&(R+=1,r[`guardLOS:${S.id}`]=(r[`guardLOS:${S.id}`]??0)+Se.guards.lineOfSightGainPerSecond*n);const W=os(S.alertLevel),z=t.guardAlertRank[S.id]??0;t.guardAlertRank[S.id]=W,S.alertLevel===be.ALARMED&&(r[`guardPursuit:${S.id}`]=(r[`guardPursuit:${S.id}`]??0)+Se.guards.pursuitGainPerSecond*n),W>=3&&z<3&&(i[`guardChase:${S.id}`]=Se.guards.pursuitSpike*E)});let M=0;if(e.zoneHeat){const S=vi(((ne=e.mapArea)==null?void 0:ne.zoneId)??null);M=Kl(e.zoneHeat.totalHeat,S.tierThresholds.crackdown),M>0&&(r.heat=M*Se.heat.baselineGainPerSecond*n)}e.timeOfDay==="night"&&(r.night=Se.circadian.nightGainPerSecond*n),e.curfewActive&&!t.lastCurfewActive&&(i.curfew=Se.circadian.curfewSpike*E),t.lastCurfewActive=e.curfewActive;const F=Math.max(1,l.maxHealth);l.health/F<Se.health.criticalThreshold?(r.lowHealth=Se.health.sustainedGainPerSecond*n,t.lastLowHealth||(i.lowHealth=Se.health.spike*E),t.lastLowHealth=!0):t.lastLowHealth=!1,t.lastLowAmmo=!1,e.environmentImpacts.travel.staminaDrainPerMinute>0&&(r.hazards=(r.hazards??0)+Se.hazards.smogGainPerSecond*n),e.environmentImpacts.travel.visibilityMultiplier<.75&&(r.hazards=(r.hazards??0)+Se.hazards.blackoutGainPerSecond*n);const A=ql(o,d);A&&(s.safehouse=(s.safehouse??0)+Se.safehouse.reliefPerSecond*n,t.lastSafehouse||(s.safehouseEntry=(s.safehouseEntry??0)+Se.safehouse.entryRelief)),t.lastSafehouse=A,Xl(e.timeOfDay,e.curfewActive,r.camerasProximity??0,R)&&(s.daylight=(s.daylight??0)+Se.circadian.daylightReliefPerSecond*n);const Q=1+M,$={};Object.entries(r).forEach(([S,N])=>{if(S==="heat"){$[S]=N;return}$[S]=N*Q});const de={gain:I,decay:y};return Object.keys(i).forEach(S=>{i[S]=i[S]*E}),{gains:$,losses:s,spikes:i,multipliers:de}},Zl=e=>e.world.engagementMode,Aa=e=>e.player.data.stealthModeEnabled,fr=e=>e.player.data.stealthCooldownExpiresAt,hn=e=>e.quests.activeDialogue.dialogueId,Da=X([e=>e.world.inCombat,hn,fr],(e,t,n)=>!(e||t||typeof n=="number"&&n>Date.now())),Jl=e=>{switch(e){case be.ALARMED:return 3;case be.INVESTIGATING:return 2;case be.SUSPICIOUS:return 1;case be.IDLE:default:return 0}},ec=e=>{switch(e){case ee.ALARMED:return 3;case ee.INVESTIGATING:return 2;case ee.SUSPICIOUS:return 1;case ee.IDLE:case ee.DISABLED:default:return 0}},tc=X([e=>e.world.currentMapArea.entities.enemies],e=>{let t=0,n=0;return e.forEach(r=>{const s=Jl(r.alertLevel);s>t&&(t=s);const i=r.alertProgress??0;i>n&&(n=i)}),{maxRank:t,maxProgress:Math.max(0,Math.min(100,Math.round(n)))}}),_a=X([Aa,Zl,Da,fr,e=>e.world.inCombat,hn,e=>e.surveillance.hud,tc,e=>e.player.data.movementProfile],(e,t,n,r,s,i,l,o,d)=>{const m=Date.now(),f=typeof r=="number"&&r>m,u=typeof r=="number"?r:null,g=ec(l.alertState),h=o.maxRank,I=g>0||l.detectionProgress>0||!!l.activeCameraId,y=h>0,E=e&&t==="stealth",R=Math.max(Math.round(l.detectionProgress??0),o.maxProgress);return s?{state:"compromised",reason:"combat",severity:Math.max(R,100),stealthActive:E,onCooldown:f,cooldownExpiresAt:u}:i?{state:E?"exposed":"standby",reason:"dialogue",severity:R,stealthActive:E,onCooldown:f,cooldownExpiresAt:u}:E?g>=3||h>=3?{state:"compromised",reason:g>=3?"camera":d==="sprint"?"noise":"vision",severity:Math.max(R,80),stealthActive:E,onCooldown:f,cooldownExpiresAt:u}:I||y||R>=30?{state:"exposed",reason:I?"camera":d==="sprint"?"noise":"vision",severity:Math.max(R,30),stealthActive:E,onCooldown:f,cooldownExpiresAt:u}:{state:"hidden",reason:"none",severity:R,stealthActive:E,onCooldown:f,cooldownExpiresAt:u}:f||!n?{state:"compromised",reason:"cooldown",severity:R,stealthActive:E,onCooldown:f,cooldownExpiresAt:u}:{state:"standby",reason:"none",severity:R,stealthActive:E,onCooldown:f,cooldownExpiresAt:u}});X([_a],e=>e.stealthActive&&e.state==="hidden");const nc=X([_a,e=>e.world.inCombat,hn],(e,t,n)=>{const r=Date.now(),s=e.onCooldown&&e.cooldownExpiresAt?Math.max(1,Math.ceil((e.cooldownExpiresAt-r)/1e3)):0,i=t?"combat":n?"dialogue":e.onCooldown||e.reason==="cooldown"?"cooldown":null,l=e.stealthActive,o=l||i===null;let d="ready";return i==="combat"?d="combat":i==="dialogue"?d="dialogue":i==="cooldown"?d=s>0?`cooldown:${s}`:"cooldown":l&&e.reason!=="none"&&(d=`${e.reason}:${Math.max(0,Math.min(100,Math.round(e.severity)))}`),{isActive:l,stateLabel:e.state,detailLabel:d,canToggle:o,blockedReason:i,severity:Math.max(0,Math.min(100,Math.round(e.severity))),keyHint:"X",reason:e.reason,cooldownSeconds:s}}),rc=X([Aa,Da,fr],(e,t,n)=>({enabled:e,eligible:t,cooldownExpiresAt:typeof n=="number"?n:null,onCooldown:typeof n=="number"&&n>Date.now()})),sc=e=>{switch(e){case"on_edge":return 1.1;case"panicked":return 1.2;case"breakdown":return 1.3;default:return 1}},ac=4500,ic=12e4,oc=3,Fn=e=>{switch(e){case be.SUSPICIOUS:return 1;case be.INVESTIGATING:return 2;case be.ALARMED:return 3;default:return 0}},lc={silent:{radius:2,gain:0},normal:{radius:4,gain:4},sprint:{radius:6,gain:8}},cc=e=>e.reduce((t,n)=>{const r=Array.isArray(n.tags)?n.tags:[],s=n.stackable?n.quantity??1:1;return r.includes("paranoia:calmtabs")&&(t.calmTabs+=s),r.includes("paranoia:cigarettes")&&(t.cigarettes+=s),t},{calmTabs:0,cigarettes:0}),La=e=>e.stackable?Math.max(1,e.quantity??1):1,ja=(e,t)=>e.type!=="collect"||e.isCompleted?!1:e.targetResourceKey&&t.resourceKey?e.targetResourceKey===t.resourceKey:e.target===t.name,dc=(e,t)=>{if(e.type!=="kill"||e.isCompleted)return!1;if(e.targetResourceKey&&t.resourceKey)return e.targetResourceKey===t.resourceKey;if(e.targetResourceKey==="enemies.corpsec_guard"){if(t.aiProfileId===Wi)return!0;const n=t.name.toLowerCase();return["corpsec","curfew patrol","patrol","sentinel","sentry","guard","captain","enforcer","watchman"].some(s=>n.includes(s))}return e.target?t.name.toLowerCase()===e.target.toLowerCase():!1},uc=e=>e.type==="kill"&&!e.isCompleted&&e.targetResourceKey==="devices.surveillance_camera",fc=e=>e.type==="explore"&&!e.isCompleted&&e.targetResourceKey==="devices.patrol_drone",Na=e=>{var t;return((t=fa[e.id])==null?void 0:t.kind)==="side"},jt=e=>!e.isCompleted&&(e.isActive||Na(e)),ls=(e,t)=>{const n=e.x-t.x,r=e.y-t.y;return Math.sqrt(n*n+r*r)},mc=(e,t)=>t.reduce((n,r)=>ja(e,r)?n+La(r):n,0),Qt=1.5,pc=(e,t,n)=>{var f;if(!e||!t||!Array.isArray(e.buildings)||e.buildings.length===0)return{available:!1,note:"No workbench nearby"};const{x:r,y:s}=t.position,i=e.buildings.find(u=>{if(!u.workbench)return!1;const{from:g,to:h}=u.footprint;return r>=g.x-Qt&&r<=h.x+Qt&&s>=g.y-Qt&&s<=h.y+Qt});if(!i||!i.workbench)return{available:!1,note:"No workbench nearby"};let l=!1;if(n){const u=gn(((f=t.factionReputation)==null?void 0:f.scavengers)??0);l=u.id==="friendly"||u.id==="allied"}const o=i.workbench.type==="market"&&(!n||!l)?i.workbench.feeRequired??50:void 0,d=o?t.credits>=o:!0,m=o&&!d?n?`Requires ${o} credits or Friendly scavenger standing`:`Requires ${o} credits`:o?n?"Fee applies if scavenger standing is below Friendly":"Market workbench fee applies":void 0;return{available:d,locationName:i.name,type:i.workbench.type,feeRequired:o,note:m}},gc=()=>{var Rr;const e=c.useMemo(()=>oa("GameController"),[]),t=Xe(),n=ri(),r=P(p=>p.player.data),s=r.encumbrance.level,i=r.encumbrance.warning,l=r.encumbrance.percentage,o=P(p=>p.world.currentMapArea),d=o==null?void 0:o.entities.items,m=o==null?void 0:o.id,f=(o==null?void 0:o.isInterior)??!1,u=P(p=>p.world.inCombat),g=P(p=>p.world.isPlayerTurn),h=P(p=>p.world.timeOfDay),I=P(p=>p.world.curfewActive),y=P(p=>p.world.currentMapArea.entities.enemies),E=P(p=>p.world.mapAreas),R=P(p=>p.world.mapConnections),M=P(p=>p.world),F=P(p=>p.quests.quests),G=P(p=>p.quests.dialogues),B=c.useMemo(()=>F.map(p=>`${p.id}:${p.isActive?1:0}:${p.isCompleted?1:0}`).join("|"),[F]),A=P(hn),Q=P(p=>p.settings.locale),$=P(p=>p.settings.autoBattleEnabled),de=P(p=>p.settings.autoBattleProfile),ne=P(rc),S=ne.cooldownExpiresAt,N=ne.eligible,W=typeof S=="number",z=P(p=>p.world.engagementMode),T=P(p=>p.world.stealthToggleRequestNonce),ue=P(p=>p.settings.autoStealthEnabled),Z=P(p=>!!p.settings.reputationSystemsEnabled),fe=P(p=>p.world.turnCount),Y=P(p=>p.world.globalAlertLevel),J=P(p=>p.world.reinforcementsScheduled),le=P(p=>m?p.surveillance.zones[m]:void 0),me=P(p=>p.surveillance.hud.overlayEnabled),xe=P(Ea),ke=P(p=>p.world.environment.flags),x=P(p=>p.world.currentTime),L=P(Wl),b=c.useMemo(()=>Pa((o==null?void 0:o.zoneId)??null),[o==null?void 0:o.zoneId]),j=P(p=>b(p)),w=c.useMemo(()=>ot(Q).logs,[Q]),ye=c.useMemo(()=>Qe(Q),[Q]),he=c.useMemo(()=>ye.autoBattle,[ye]),Le=c.useMemo(()=>Math.max(220,Math.round(320*xe.behavior.routineIntervalMultiplier)),[xe.behavior.routineIntervalMultiplier]),Ie=c.useMemo(()=>Math.max(750,Math.round(wi()*xe.faction.reinforcementDelayMultiplier)),[xe.faction.reinforcementDelayMultiplier]),$e=c.useRef(u),We=c.useRef(h),Ue=c.useRef(Y),Re=c.useRef(void 0),ve=c.useRef(r),rt=c.useRef(o??null),Bt=c.useRef(J),pt=c.useRef(Oo()),Ge=c.useRef(null),C=c.useRef(null),V=c.useRef(Y),ce=c.useRef(h),oe=c.useRef(A),we=c.useRef(me),ge=c.useRef(x),Ee=c.useRef(null),Te=c.useRef(null),gt=c.useRef(new Map),Fe=c.useRef(m??null),xn=c.useRef(null),ht=c.useRef(F),vn=c.useRef(new Set),wn=c.useRef(new Set),Sn=c.useRef(new Set),br=c.useRef(r.id),Tt=c.useRef(null),xr=c.useRef(is()),vr=c.useRef(L),wr=c.useRef(j),Sr=c.useRef(0),kn=c.useRef(T),kr=c.useRef({calmTabs:0,cigarettes:0}),Qa=((Rr=M.workbenchStatus)==null?void 0:Rr.available)!==void 0?{...M.workbenchStatus}:{available:M.workbenchAvailable??!1,note:M.workbenchAvailable?void 0:"No workbench nearby"},Ir=c.useRef(Qa),[ze,yt]=c.useState(0),$t=c.useRef(null),Wt=c.useRef(null),Ze=c.useRef(null),[Ut,st]=c.useState("clear"),[Ne,Ce]=c.useState([]),bt=c.useRef(new Set),Ct=c.useRef([]),lt=c.useRef(new Map),Gt=c.useRef(null),[In,Pe]=c.useState(null),[En,Ae]=c.useState(null),Vt=c.useCallback(p=>{var k;if(!p.isInteractive||!p.dialogueId)return t(O(w.npcNotReady(p.name))),!1;if(A===p.dialogueId)return!0;const v=G.find(D=>D.id===p.dialogueId);if(!v||v.nodes.length===0)return t(O(w.npcNoNewInfo(p.name))),!1;const _=(k=v.nodes[0])==null?void 0:k.id;return _?(t(jr({dialogueId:v.id,nodeId:_})),t(O(w.npcChannelOpened(p.name))),!0):(t(O(w.npcChannelEmpty(p.name))),!1)},[t,G,A,w]),xt=c.useCallback((p={})=>{const{sprint:v=!1}=p;if(u)return!0;if(v&&r.isExhausted)return t(O(w.tooTiredToSprint)),!1;let k=l>=80?Nr.strenuousInteraction:0;return v&&(k+=Nr.sprintTile),k<=0?(r.stamina<r.maxStamina&&t(Si(void 0)),!0):r.stamina<k?(t(O(w.notEnoughStamina(k,r.stamina))),!1):(t(ki(k)),!0)},[l,t,u,w,r.isExhausted,r.stamina,r.maxStamina]),He=c.useCallback((p=!0)=>{p&&$t.current!==null&&window.clearTimeout($t.current),$t.current=null,Wt.current=null},[]),vt=c.useRef(null),Mt=()=>typeof performance<"u"?performance.now():Date.now(),Er=()=>Date.now(),Tr=c.useCallback(()=>{var p;t(Cn({enabled:!0,cooldownExpiresAt:null})),((p=ve.current)==null?void 0:p.movementProfile)!=="silent"&&t(Mn("silent"))},[t]),wt=c.useCallback(p=>{var _;const v=Er();t(Cn({enabled:!1,cooldownExpiresAt:p?v+ac:null})),((_=ve.current)==null?void 0:_.movementProfile)==="silent"&&t(Mn("normal"))},[t]),qt=c.useCallback(p=>{const v=ve.current;if(v){if(e.debug("Stealth toggle requested",{source:p}),v.stealthModeEnabled){wt(!1),t(Pn("none")),t(O(w.stealthDisengaged));return}if(!N){if(u){t(O(w.stealthUnavailableCombat));return}if(oe.current){t(O(w.stealthUnavailableDialogue));return}if(W&&typeof S=="number"){const _=Date.now(),k=Math.max(0,S-_);if(k>0){const D=Math.ceil(k/1e3);t(O(w.stealthCooldown(D)))}}return}Tr(),t(Pn("stealth")),t(O(w.stealthEngaged))}},[wt,t,Tr,u,e,w,S,N,W]),Ve=c.useCallback(p=>{!p.isActive&&Na(p)&&t(la(p.id))},[t]);c.useEffect(()=>{Re.current=le},[le]),c.useEffect(()=>{vr.current=L},[L]),c.useEffect(()=>{wr.current=j},[j]),c.useEffect(()=>{ve.current=r},[r]),c.useEffect(()=>{br.current!==r.id&&(br.current=r.id,vn.current.clear(),wn.current.clear(),Sn.current.clear())},[r.id]),c.useEffect(()=>{oe.current=A},[A]),c.useEffect(()=>{ht.current=F},[F]),c.useEffect(()=>{rt.current=o??null},[o]),c.useEffect(()=>{if(!d||d.length===0)return;const p=d.filter(_=>{var k,D;return((k=_.position)==null?void 0:k.x)===r.position.x&&((D=_.position)==null?void 0:D.y)===r.position.y});if(p.length===0)return;const v=ht.current.filter(jt);p.forEach(_=>{var H,re;const k=La(_),D=Ii(_);t(ca(_)),t(Ei({id:_.id,position:_.position,name:_.name})),window.dispatchEvent(new CustomEvent(Ti,{detail:{areaId:o.id,itemId:_.id,position:_.position}})),t(At({id:et(),value:k,gridX:((H=_.position)==null?void 0:H.x)??r.position.x,gridY:((re=_.position)==null?void 0:re.y)??r.position.y,type:"pickup",label:D})),t(O(w.itemPickedUp(D,k))),v.forEach(K=>{K.objectives.forEach(q=>{ja(q,_)&&(Ve(K),t(Dt({questId:K.id,objectiveId:q.id,count:k})))})})})},[t,d,r.position,w,o==null?void 0:o.id,Ve]),c.useEffect(()=>{const p=ht.current.filter(jt);if(p.length===0)return;const v=r.inventory.items??[];v.length!==0&&p.forEach(_=>{_.objectives.forEach(k=>{if(k.type!=="collect"||k.isCompleted)return;const D=mc(k,v);if(D<=0)return;const H=k.count??1,re=k.currentCount??0,q=Math.min(D,H)-re;q<=0||(Ve(_),t(Dt({questId:_.id,objectiveId:k.id,count:q})))})})},[t,r.inventory.items,B,Ve]),c.useEffect(()=>{if(!I)return;const p=Re.current??le;if(!p)return;const v=ht.current.filter(jt);if(v.length===0)return;const _=Object.values(p.cameras).filter(D=>D.type!=="drone"||!D.isActive||D.alertState===ee.ALARMED?!1:ls(D.position,r.position)<=oc);if(_.length===0)return;const k=new Map;v.forEach(D=>{D.objectives.forEach(H=>{fc(H)&&_.forEach(re=>{const K=`${re.id}:${re.currentWaypointIndex??0}`,q=`${D.id}:${H.id}:${K}`;if(Sn.current.has(q))return;Sn.current.add(q),Ve(D),t(Dt({questId:D.id,objectiveId:H.id,count:1}));const se=`${D.id}:${H.id}`,te=k.get(se)??H.currentCount??0,ae=H.count??1,U=Math.min(te+1,ae);k.set(se,U),t(O(w.droneReconWaypointLogged(U,ae)))})})})},[I,t,w,r.position,le,B,Ve]),c.useEffect(()=>{const p=Re.current??le,v=ve.current,k=y.reduce((q,se)=>{const te=Fn(se.alertLevel);return te>q?te:q},0)>=3,H=(p?Object.values(p.cameras):[]).some(q=>q.alertState===ee.ALARMED),re=Er();!(v!=null&&v.stealthModeEnabled)&&(v!=null&&v.stealthCooldownExpiresAt)&&v.stealthCooldownExpiresAt<=re&&t(Cn({enabled:!1,cooldownExpiresAt:null}));let K="none";u?(K="combat",v!=null&&v.stealthModeEnabled&&(wt(!0),t(O(w.stealthCompromised)))):oe.current?(K="dialog",v!=null&&v.stealthModeEnabled&&wt(!1)):v!=null&&v.stealthModeEnabled&&(k||H?(wt(!0),t(O(w.stealthCompromised))):K="stealth"),z!==K&&t(Pn(K))},[A,wt,t,z,y,u,w,le]),c.useEffect(()=>{xr.current=is()},[m]),c.useEffect(()=>{if(!o){Fe.current=null,gt.current=new Map(y.map(k=>[k.id,k]));return}if(Fe.current!==o.id){Fe.current=o.id,gt.current=new Map(y.map(k=>[k.id,k]));return}const p=gt.current,v=new Map(y.map(k=>[k.id,k])),_=ht.current.filter(jt);p.forEach((k,D)=>{const H=v.get(D);k.health>0&&(!H||H.health<=0)&&(Z&&t(Ci({witnessId:D,zoneId:o.zoneId})),_.forEach(K=>{K.objectives.forEach(q=>{if(!dc(q,k))return;const se=`${K.id}:${q.id}:${D}`;vn.current.has(se)||(vn.current.add(se),Ve(K),t(Dt({questId:K.id,objectiveId:q.id,count:1})))})}))}),Fe.current=o.id,gt.current=v},[y,o,t,Z,Ve]),c.useEffect(()=>{Bt.current=J},[J]),c.useEffect(()=>{!J&&Ge.current!==null&&(pt.current.cancel(Ge.current),Ge.current=null)},[J]),c.useEffect(()=>{const p=cc(r.inventory.items??[]),v=kr.current;kr.current=p;const _=Mt();p.calmTabs<v.calmTabs&&t(Or({amount:Se.calmTabs.relief,timestamp:_,cooldownKey:"calmTabs",cooldownMs:Se.calmTabs.cooldownMs})),p.cigarettes<v.cigarettes&&(t(Or({amount:Se.cigarettes.relief,timestamp:_})),t(Mi({amountPerSecond:Se.cigarettes.decayBoostPerSecond,durationMs:Se.cigarettes.durationMs,timestamp:_})))},[r.inventory.items,t]),c.useEffect(()=>{V.current=Y},[Y]),c.useEffect(()=>{ce.current=h},[h]),c.useEffect(()=>{we.current=me},[me]),c.useEffect(()=>{ge.current=x},[x]),c.useEffect(()=>{Tt.current||(Tt.current=new Pi(t,n))},[t,n]),c.useEffect(()=>{Tt.current&&Tt.current.update({enabled:$,profileId:de,player:r,enemies:y,mapArea:o??null,inCombat:u,isPlayerTurn:g,turnCount:fe,activeDialogueId:A,logStrings:w,autoBattleStrings:he})},[$,de,r,y,o,u,g,fe,A,w,he]),c.useEffect(()=>{vt.current&&vt.current.focus();const p=v=>{if(!vt.current)return;const _=v.target;_ instanceof Element&&(vt.current.contains(_)||_.closest('[data-controller-focus-ignore="true"]'))||vt.current.focus()};return document.addEventListener("click",p),()=>{document.removeEventListener("click",p)}},[]),c.useEffect(()=>{const p=rt.current;if(!p||!m)return;Te.current!==null&&(window.clearTimeout(Te.current),Te.current=null);const v=Ee.current;v&&v!==m&&Zr({areaId:v,dispatch:t});const _=Re.current;return(!_||_.areaId!==m)&&ol({area:p,timeOfDay:ce.current,dispatch:t,timestamp:Mt()}),Ee.current=m,()=>{const k=Ee.current;k&&(Te.current=window.setTimeout(()=>{Zr({areaId:k,dispatch:t}),Ee.current=null,Te.current=null},0))}},[m,t]),c.useEffect(()=>{if(!o||!m)return;const p=Re.current??le;p&&ll({zone:p,area:o,timeOfDay:h,dispatch:t,timestamp:Mt()})},[h,m,le,o,t]),c.useEffect(()=>{const p=v=>{if(v.defaultPrevented)return;const _=v.target;if(!(_ instanceof Element&&_.closest('[data-controller-focus-ignore="true"]'))){if(v.key==="Tab"){if(v.preventDefault(),v.repeat)return;t(Ui({enabled:!we.current}));return}if(v.key.toLowerCase()==="x"){if(v.repeat)return;v.preventDefault(),qt("keyboard")}}};return window.addEventListener("keydown",p),()=>{window.removeEventListener("keydown",p)}},[t,qt]),c.useEffect(()=>{if(T<=kn.current){kn.current=T;return}kn.current=T,qt("hudButton")},[qt,T]),c.useEffect(()=>{if(!m||typeof window>"u")return;El();let p=null,v=Mt();const _=()=>{const k=Re.current,D=rt.current,H=ve.current,re=Mt(),K=re-v;v=re;const se=n.getState().world;if(D&&H){const te=Z?wr.current:null,ae=Ql({player:H,enemies:D.entities.enemies,mapArea:D,surveillanceZone:k,zoneHeat:te,environmentImpacts:xe,timeOfDay:se.timeOfDay,curfewActive:se.curfewActive,worldTimeSeconds:se.currentTime,deltaMs:K,timestamp:re},xr.current),U=Object.values(ae.gains).reduce((at,St)=>at+St,0),ie=Object.values(ae.losses).reduce((at,St)=>at+St,0),pe=Object.values(ae.spikes).reduce((at,St)=>at+St,0),qe=U*ae.multipliers.gain-ie+pe;(qe!==0||U>0||ie>0||pe!==0)&&t(Gi({timestamp:re,delta:qe,deltaMs:K,breakdown:{gains:ae.gains,losses:ae.losses,spikes:ae.spikes}})),t(Vi({deltaMs:K,timestamp:re,decayMultiplier:ae.multipliers.decay}))}if(k&&D&&H){const te=Z?ae=>{t($r(ae)),e.debug(`Suspicion: camera ${ae.witnessId} reported player in ${ae.zoneId} (${ae.recognitionChannel})`)}:void 0;cl({zone:k,mapArea:D,player:H,deltaMs:K,timestamp:re,dispatch:t,logStrings:w,reinforcementsScheduled:Bt.current??!1,globalAlertLevel:V.current??be.IDLE,timeOfDay:se.timeOfDay,environmentFlags:se.environment.flags,worldTimeSeconds:se.currentTime,onWitnessObservation:te})}if(!u&&z==="stealth"&&ue&&D&&H){const te=jo();te&&t(O(`[Auto-Stealth]: ${te.summary}`))}if(D&&H){const te=pc(D,H,Z),ae=Ir.current;(ae.available!==te.available||ae.type!==te.type||ae.locationName!==te.locationName||ae.feeRequired!==te.feeRequired||ae.note!==te.note)&&(Ir.current=te,t(qi(te)))}fl(t,n.getState),p=window.requestAnimationFrame(_)};return p=window.requestAnimationFrame(_),()=>{p!==null&&window.cancelAnimationFrame(p)}},[m,t,w,n,e,xe,ue,z,u,Z]),c.useEffect(()=>{const p=v=>{const k=v.detail;if(!k||!o||k.areaId!==o.id||u)return;const D=k.position;if(Pe(null),Ae(null),D.x===r.position.x&&D.y===r.position.y){Ce([]),Ae(null);return}const H=o.entities.npcs.find(q=>q.position.x===D.x&&q.position.y===D.y);if(H){if(u){t(O(w.combatChatterOverrides));return}if(Math.abs(H.position.x-r.position.x)+Math.abs(H.position.y-r.position.y)<=1){Vt(H);return}const se=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}];let te=null;for(const ae of se){const U={x:H.position.x+ae.x,y:H.position.y+ae.y};if(U.x===r.position.x&&U.y===r.position.y||U.x<0||U.y<0||U.x>=o.width||U.y>=o.height||!Kt(U,o,r,y,{npcs:o.entities.npcs}))continue;const ie=_t(r.position,U,o,{player:r,enemies:y,npcs:o.entities.npcs});if(ie.length>0){te=ie;break}}te?(Pe(H.id),Ce(te)):t(O(w.npcBoxedIn(H.name)));return}const re=o.entities.enemies.find(q=>q.position.x===D.x&&q.position.y===D.y&&q.health>0);if(re){if(Math.abs(re.position.x-r.position.x)+Math.abs(re.position.y-r.position.y)<=1){u||(t(Lt()),t(O(w.enteredCombat)));return}const se=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}];let te=null;for(const ae of se){const U={x:re.position.x+ae.x,y:re.position.y+ae.y};if(U.x===r.position.x&&U.y===r.position.y||U.x<0||U.y<0||U.x>=o.width||U.y>=o.height||!Kt(U,o,r,y,{npcs:o.entities.npcs}))continue;const ie=_t(r.position,U,o,{player:r,enemies:y,npcs:o.entities.npcs});if(ie.length>0){te=ie;break}}te?(Ae(re.id),Ce(te)):t(O(w.enemyOutOfRange));return}const K=_t(r.position,D,o,{player:r,enemies:y,npcs:o.entities.npcs});if(K.length===0){window.dispatchEvent(new CustomEvent(Rn,{detail:{areaId:o.id,path:[]}})),Ae(null);return}Ce(K)};return window.addEventListener(Fr,p),()=>{window.removeEventListener(Fr,p)}},[o,r,y,u,t,Vt,R,w]),c.useEffect(()=>{o&&window.dispatchEvent(new CustomEvent(Rn,{detail:{areaId:o.id,path:Ne}}))},[Ne,o]),c.useEffect(()=>{if(!o)return;const p=v=>{const _=v.detail;if(!_||_.areaId!==o.id)return;const k=_t(r.position,_.target,o,{player:r,enemies:y,npcs:o.entities.npcs});Ce(k),window.dispatchEvent(new CustomEvent(Rn,{detail:{areaId:o.id,path:k}}))};return window.addEventListener(zr,p),()=>{window.removeEventListener(zr,p)}},[o,r,y]),c.useEffect(()=>{Ce(p=>p.length>0?[]:p),Pe(null),Ae(null)},[o==null?void 0:o.id]),c.useEffect(()=>{f&&st("clear")},[m,f]),c.useEffect(()=>{const p=bt.current,v=Ct.current,_=lt.current;p.clear(),v.forEach(k=>{window.clearTimeout(k)}),v.length=0,_.clear()},[o==null?void 0:o.id]);const Cr=c.useCallback((p,v)=>{if(v.length===0){lt.current.delete(p.id);return}if(bt.current.has(p.id))return;const _=v[v.length-1];lt.current.set(p.id,_),bt.current.add(p.id);const k=Le;let D=0,H=p;const re=()=>{if(D>=v.length){bt.current.delete(p.id),lt.current.delete(p.id);return}const K=v[D];if(D+=1,H={...H,position:K},t(Ki(H)),D<v.length){const q=window.setTimeout(()=>{const se=Ct.current.indexOf(q);se>-1&&Ct.current.splice(se,1),re()},k);Ct.current.push(q)}else bt.current.delete(p.id),lt.current.delete(p.id)};re()},[t,Le]);c.useEffect(()=>{o&&o.entities.npcs.forEach(p=>{const v=p.routine.find(H=>H.timeOfDay===h);if(!v||p.position.x===v.position.x&&p.position.y===v.position.y)return;const _=o.entities.npcs.filter(H=>H.id!==p.id).map(H=>H.position),k=Array.from(lt.current.entries()).filter(([H])=>H!==p.id).map(([,H])=>H),D=_t(p.position,v.position,o,{player:r,enemies:y,blockedPositions:[..._,...k]});D.length>0&&Cr(p,D)})},[o,h,r,y,Cr]),c.useEffect(()=>{const p=Ct.current,v=bt.current,_=lt.current;return()=>{p.forEach(k=>{window.clearTimeout(k)}),p.length=0,v.clear(),_.clear()}},[]),c.useEffect(()=>{var re;if(Ne.length===0)return;if(u){Ce([]),Pe(null);return}if(r.encumbrance.level==="immobile"){r.encumbrance.warning&&t(O(r.encumbrance.warning)),Ce([]),Pe(null),Ae(null);return}const p=Ne[0],v=r.position.x,_=r.position.y;if(v===p.x&&_===p.y){Ce(K=>K.slice(1));return}if(!Kt(p,o,r,y,{npcs:o.entities.npcs})){Ce([]),Pe(null),Ae(null);return}const k=o.tiles[p.y][p.x],D=R.find(K=>K.fromAreaId===o.id&&K.fromPosition.x===p.x&&K.fromPosition.y===p.y);if(D){const K=E[D.toAreaId];if(I&&k.type===Hr.DOOR&&K&&!K.isInterior){t(O(w.checkpointSealed)),Ce([]),Pe(null),Ae(null);return}if(K){if(Z&&K.factionRequirement){const q=K.factionRequirement,se=ye.playerStatus.factions[q.factionId]??q.factionId,te=((re=r.factionReputation)==null?void 0:re[q.factionId])??0,ae=gn(te);let U=!0;if(q.minimumStanding){const ie=Ye(ae.id),pe=Ye(q.minimumStanding);ie<pe&&(U=!1)}if(U&&typeof q.minimumReputation=="number"&&te<q.minimumReputation&&(U=!1),!U){const ie=[];q.minimumStanding&&ie.push(ln(Q,q.minimumStanding)),typeof q.minimumReputation=="number"&&ie.push(`${ye.factionPanel.reputationLabel} ${q.minimumReputation}+`);const pe=ie.join(" • ")||ln(Q,ae.id);t(O(w.factionAccessDenied(se,pe))),Ce([]),Pe(null),Ae(null);return}}if(!xt()){Ce([]),Pe(null),Ae(null);return}t(Br(K)),t(Yt(D.toPosition)),K.isInterior&&(t(sn({type:"campfireRest",locationId:K.id})),t(O(w.slipInsideStructure)),st("clear"))}else e.warn(`Missing target area in state for ${D.toAreaId}`);Ce([]),Pe(null),Ae(null);return}if(!xt()){Ce([]),Pe(null),Ae(null);return}const H=r.movementProfile==="silent"?140:0;Ze.current===null&&(Ze.current=window.setTimeout(()=>{Ze.current=null,t(Yt(p))},H))},[Ne,r,o,y,u,I,t,E,R,e,w,xt,Q,ye,Z]),c.useEffect(()=>{Ne.length===0&&Ze.current!==null&&(window.clearTimeout(Ze.current),Ze.current=null)},[Ne.length]),c.useEffect(()=>()=>{Ze.current!==null&&(window.clearTimeout(Ze.current),Ze.current=null)},[]),c.useEffect(()=>{const p=i??null;if(p&&p!==Gt.current&&t(O(p)),!p&&Gt.current&&s==="normal"){Gt.current=null;return}Gt.current=p},[s,i,t]),c.useEffect(()=>{if(!In||!o)return;const p=o.entities.npcs.find(_=>_.id===In);if(!p){Pe(null);return}if(Math.abs(p.position.x-r.position.x)+Math.abs(p.position.y-r.position.y)<=1){if(u)Pe(null);else{const _=Vt(p);Pe(null),_&&Ce([])}return}Ne.length===0&&(t(O(w.npcOutOfReach(p.name))),Pe(null))},[In,o,r,u,Ne.length,t,R,Vt,w]),c.useEffect(()=>{if(!En||!o)return;const p=o.entities.enemies.find(_=>_.id===En);if(!p||p.health<=0){Ae(null);return}if(Math.abs(p.position.x-r.position.x)+Math.abs(p.position.y-r.position.y)<=1){Ae(null),Ce([]),u||(t(Lt()),t(O(w.enteredCombat)));return}Ne.length===0&&Ae(null)},[En,o,r,u,Ne.length,t,w,y]),c.useEffect(()=>{We.current!==h&&(h==="night"?(t(O(w.nightFalls)),st("clear")):We.current==="night"&&(t(O(w.dawnBreaks)),st("clear")),We.current=h)},[h,t,w]),c.useEffect(()=>{Z&&t(Ri(!!A))},[A,t,Z]),c.useEffect(()=>{var ae;if(!r||y.length===0||!o){xn.current=null;return}const p=[o.id,`${r.position.x},${r.position.y}`,r.movementProfile,u?"combat":"field",h,y.map(U=>{var ie;return`${U.id}:${U.health}:${U.position.x},${U.position.y}:${U.facing}:${((ie=U.visionCone)==null?void 0:ie.direction)??"na"}`}).join("|")].join("::");if(xn.current===p)return;xn.current=p;const v=sc(vr.current),_=r.movementProfile==="silent"?.6:r.movementProfile==="sprint"?1.6:1,k=((ae=r.skillTraining)==null?void 0:ae.stealth)??0,D=Math.max(.7,1-Math.min(.3,k/333)),H=(ce.current??h)==="night"?.85:1,re=v*_*D*H,{updatedEnemies:K,maxAlertLevel:q,guardPerception:se}=Ai(y,r,o,re);let te=!1;if(r.movementProfile!=="silent"){const U=lc[r.movementProfile];K.forEach((ie,pe)=>{const Be=se[pe];if(!ie||Be!=null&&Be.playerVisible)return;const qe=ie.position.x-r.position.x,at=ie.position.y-r.position.y;if(Math.sqrt(qe*qe+at*at)>U.radius||U.gain<=0)return;const Ar=ie.alertProgress??0,Pt=Math.min(100,Ar+U.gain);if(Pt<=Ar)return;const ei=ie.alertLevel??be.IDLE;let Rt=ie.alertLevel??be.IDLE;Pt>=An.alarmThreshold?Rt=be.ALARMED:Pt>=An.investigationThreshold?Rt=be.INVESTIGATING:Pt>=An.suspicionThreshold&&(Rt=be.SUSPICIOUS),K[pe]={...ie,alertProgress:Pt,alertLevel:Rt},Fn(Rt)>Fn(ei)&&(te=!0)})}if(te){const ie=Date.now();ie-Sr.current>=1500&&(t(O(w.stealthNoiseCue)),Sr.current=ie)}if(K.forEach((U,ie)=>{const pe=y[ie];pe&&(U.alertLevel!==pe.alertLevel||U.alertProgress!==pe.alertProgress)&&t(Dn(U))}),Z&&se.forEach(({enemy:U,playerVisible:ie})=>{if(!ie)return;const pe=Ko({enemy:U,player:r,mapArea:o,timeOfDay:h,environmentFlags:ke,playerVisible:ie,timestamp:x});pe&&(t($r(pe)),e.debug(`Suspicion: guard ${U.id} observed player in ${o.zoneId} (certainty ${(pe.baseCertainty*pe.distanceModifier).toFixed(2)})`))}),q!==Ue.current){const U=Di(Ue.current,q);U&&t(O(w[U])),t(rn(q)),Ue.current=q,_i(q,J)&&(t(ia()),t(O(w.reinforcementsIncoming)),Ge.current!==null&&pt.current.cancel(Ge.current),Ge.current=pt.current.schedule(()=>{Ge.current=null,u||t(Lt());const ie=u&&!g,pe={id:et(),resourceKey:"enemies.corpsec_guard",name:w.curfewPatrolName,position:{x:r.position.x+5,y:r.position.y+2},facing:"west",coverOrientation:null,suppression:0,health:45,maxHealth:45,actionPoints:ie?0:4,maxActionPoints:4,damage:7,attackRange:2,isHostile:!0,visionCone:{range:10,angle:90,direction:180},alertLevel:be.ALARMED,alertProgress:100};t(Wr(pe)),t(kt()),ie&&!g&&(t(ct()),t(kt())),He(),yt(0),t(Li())},Ie))}},[r,y,o,t,w,u,g,J,He,Ie,h,ke,x,e,Z]),c.useEffect(()=>{if(e.debug(`=== useEffect RUNNING === Turn: ${g?"Player":"Enemy"}, Combat: ${u}, Processing: ${Wt.current?"true":"false"}, EnemyIdx: ${ze}`),!u||g||y.length===0){He(),(!u||g)&&ze!==0&&yt(0);return}if(y.filter(k=>k.health>0).length===0){He(),e.warn("Enemy turn effect running but no living enemies found.");return}if(ze>=y.length){e.debug(`Enemy index ${ze} out of bounds (length: ${y.length}). Ending enemy turn.`),He(),t(ct()),t(kt()),yt(0);return}const v=y[ze];if(!v||v.health<=0||v.actionPoints<=0){e.debug(`Enemy ${(v==null?void 0:v.id)??`at index ${ze}`} cannot act (Dead or 0 AP). Checking next.`),He();let k=ze+1,D=!1;for(;k<y.length;){const H=y[k];if(H&&H.health>0&&H.actionPoints>0){D=!0;break}k+=1}D?(e.debug(`Moving to next valid enemy at index ${k}`),yt(k)):(e.debug("All enemies processed, switching back to player."),t(ct()),t(kt()),yt(0));return}if(Wt.current)return;e.debug(`Scheduling action for enemy index ${ze}: ${v.id} (AP: ${v.actionPoints})`),Wt.current=v.id;let _=null;$t.current=window.setTimeout(()=>{if(e.debug(`>>> setTimeout CALLBACK for index ${ze}`),!u){e.debug("Combat ended, skipping enemy action"),He(!1);return}try{e.debug(`Enemy Turn AI: START for ${v.id}`);const k=[];for(let H=0;H<o.height;H+=1)for(let re=0;re<o.width;re+=1)o.tiles[H][re].provideCover&&k.push({x:re,y:H});e.debug(`Enemy Turn AI: Got cover positions for ${v.id}`);const D=ji(v,r,o,y,k,o.entities.npcs,ge.current);if(_=D,e.debug(`Enemy ${v.id} action: ${D.action}, AP left: ${D.enemy.actionPoints}`),D.action==="attack"||D.action==="attack_missed"){const H=r.health-D.player.health;H>0?(t(At({id:et(),value:H,gridX:r.position.x,gridY:r.position.y,type:D.isCritical?"crit":"damage"})),t(Ni({id:et(),type:D.isCritical?"crit":"damage",intensity:.6,duration:300}))):D.action==="attack_missed"&&t(At({id:et(),value:0,gridX:r.position.x,gridY:r.position.y,type:"miss"}))}e.debug(`Enemy Turn AI: BEFORE dispatching updates for ${v.id}`),t(Dn(D.enemy)),e.debug(`Enemy Turn AI: AFTER dispatch(updateEnemy) for ${v.id}`),D.player.id===r.id&&(e.debug(`Enemy Turn AI: BEFORE dispatch(setPlayerData) for ${v.id}`),t(Ur(D.player)),e.debug(`Enemy Turn AI: AFTER dispatch(setPlayerData) for ${v.id}`)),e.debug(`Enemy Turn AI: END AI & Dispatches for ${v.id}`)}catch(k){e.error("Error during enemy turn AI:",{enemyId:v==null?void 0:v.id,error:k})}finally{const k=(_==null?void 0:_.enemy)??v,D=k&&k.health>0&&k.actionPoints>0;e.debug(`Enemy Turn FINALLY for index ${ze}. Remaining AP: ${(k==null?void 0:k.actionPoints)??v.actionPoints}. Repeat: ${D}`),He(!1),D||yt(H=>H+1)}},500)},[u,g,ze,y,t,r,o,He,e]),c.useEffect(()=>()=>{He()},[He]),c.useEffect(()=>{const p=pt.current;return()=>{p.dispose(),Ge.current=null}},[]),c.useEffect(()=>{if(!u){C.current=null;return}g&&C.current!==fe&&(C.current=fe,t(Oi()))},[t,u,g,fe]),c.useEffect(()=>{$e.current&&!u&&(t(O(w.combatOver)),e.debug("Combat ended (detected via useEffect watching inCombat)."),t(kt())),$e.current=u},[u,t,e,w]);const Mr=c.useCallback((p,v)=>{var ae,U;const _=((ae=r.equipped.weapon)==null?void 0:ae.apCost)??Fi,k=Number.isFinite(r.encumbrance.attackApMultiplier)?Math.max(r.encumbrance.attackApMultiplier,0):Number.POSITIVE_INFINITY,D=zi(r)?0:Math.ceil(Math.max(0,_)*k);if(!Number.isFinite(D)||r.actionPoints<D){t(O(w.notEnoughAp));return}const H=((U=r.equipped.weapon)==null?void 0:U.range)??1;if(!_n(r.position,p.position,H)){t(O(w.enemyOutOfRange));return}const re=v.tiles[p.position.y][p.position.x].provideCover;e.debug("attackEnemy: PRE-ATTACK",{enemyId:p.id,enemyPosition:p.position,isBehindCover:re,playerAP_before:r.actionPoints,attackCost:D});const K=Hi(r,p,re),q=K.newAttacker;t(Ur(q)),K.events&&K.events.forEach(ie=>t(O(ie.message))),e.debug("attackEnemy: POST-ATTACK",{apCost:D,playerAP_after:q.actionPoints}),K.success?(t(O(w.hitEnemy(p.name,K.damage))),t(At({id:et(),value:K.damage,gridX:p.position.x,gridY:p.position.y,type:K.isCritical?"crit":"damage"}))):(t(O(w.missedEnemy(p.name))),t(At({id:et(),value:0,gridX:p.position.x,gridY:p.position.y,type:"miss"})));const se=K.newTarget;e.debug("attackEnemy: PRE-DISPATCH updateEnemy",{enemyId:se.id,healthBeforeUpdate:p.health,healthInNewTarget:se.health}),t(Dn(se)),y.some(ie=>ie.id!==p.id||ie.id===p.id&&K.newTarget.health>0)?q.actionPoints<=0&&(e.debug("attackEnemy: Player out of AP after attack, switching turn."),t(ct())):t(O(w.allEnemiesDefeated))},[r,y,t,e,w]),Tn=c.useCallback(p=>y.length===0?null:y.reduce((v,_)=>{const k=Math.abs(_.position.x-p.x)+Math.abs(_.position.y-p.y),D=Math.abs(v.position.x-p.x)+Math.abs(v.position.y-p.y);return k<D?_:v}),[y]),Pr=c.useCallback(p=>{if(!o)return null;const v=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1},{x:1,y:1},{x:-1,y:-1},{x:-1,y:1},{x:1,y:-1}];for(const _ of v){const k={x:p.x+_.x,y:p.y+_.y};if(k.x<0||k.y<0||k.x>=o.width||k.y>=o.height)continue;const D=o.tiles[k.y],H=D?D[k.x]:void 0;if(!H||!H.isWalkable)continue;if(!y.some(K=>K.position.x===k.x&&K.position.y===k.y))return k}return null},[o,y]),Za=c.useCallback(p=>{var D,H,re,K;const v=p.key,_=(o==null?void 0:o.isInterior)??!1;if(p.shiftKey&&(v==="A"||v==="a")){p.preventDefault(),p.stopPropagation(),t(Qn(!$));return}if($&&u&&((D=Tt.current)==null||D.notifyManualOverride("manual_input"),t(Qn(!1))),A){p.preventDefault(),p.stopPropagation(),v==="Escape"&&(t(cn()),t(O(w.conversationEnded)));return}if(v==="e"||v==="E"){if(p.preventDefault(),p.stopPropagation(),!o)return;const q=o.entities.npcs.find(pe=>!pe.isInteractive||!pe.dialogueId?!1:Math.abs(pe.position.x-r.position.x)+Math.abs(pe.position.y-r.position.y)<=1);if(q){const pe=G.find(qe=>qe.id===q.dialogueId);if(!pe||pe.nodes.length===0){t(O(w.npcNoNewInfo(q.name)));return}const Be=pe.nodes[0].id;t(jr({dialogueId:pe.id,nodeId:Be})),t(O(w.npcChannelOpened(q.name)));return}const se=m?Re.current??le:void 0,te=se?Object.values(se.cameras).find(pe=>ls(pe.position,r.position)<=1.5):void 0;if(!te||!m){t(O(w.noFriendlyContact));return}const ae=Date.now(),U=typeof((H=te.hackState)==null?void 0:H.disabledUntil)=="number"&&te.hackState.disabledUntil>ae;if(!I||U||!te.isActive){t(O(w.cameraSabotageFailed));return}t(lr({areaId:m,cameraId:te.id,timestamp:ae,changes:{alertState:ee.DISABLED,detectionProgress:0,trackingPlayer:!1,trackingDirection:void 0,lastDetectionTimestamp:void 0,hackState:{...te.hackState??{},disabledUntil:ae+ic}}})),t(O(w.cameraSabotageSuccess)),ht.current.filter(jt).forEach(pe=>{pe.objectives.forEach(Be=>{if(!uc(Be))return;const qe=`${pe.id}:${Be.id}:${te.id}`;wn.current.has(qe)||(wn.current.add(qe),Ve(pe),t(Dt({questId:pe.id,objectiveId:Be.id,count:1})))})});return}if(v==="Tab"&&u&&g){p.preventDefault(),p.stopPropagation(),t(O(w.endingTurn??"Ending turn...")),t(ct());return}if(v===" "){if(p.preventDefault(),p.stopPropagation(),Ne.length>0&&(Ce([]),Pe(null),Ae(null)),!u){const q=Tn(r.position),se=((re=r.equipped.weapon)==null?void 0:re.range)??1;if(q&&_n(r.position,q.position,se)){t(Lt()),t(O(w.enteredCombat));return}}if(u&&g){const q=Tn(r.position),se=((K=r.equipped.weapon)==null?void 0:K.range)??1;if(q&&_n(r.position,q.position,se)){Mr(q,o);return}t(O(w.noEnemiesInRange));return}return}if(u&&(!g||r.actionPoints<=0)){if(y.filter(se=>se.health>0).length===0){t(Bi()),t(kt()),t(O(w.zoneSecured));return}if(!g){t(O(w.notYourTurn));return}if(r.actionPoints<=0){t(O(w.actionPointsDepleted)),t(ct());return}}Ne.length>0&&(Ce([]),Pe(null),Ae(null));const k={...r.position};switch(v){case"ArrowUp":case"w":case"W":k.y-=1;break;case"ArrowDown":case"s":case"S":k.y+=1;break;case"ArrowLeft":case"a":case"A":k.x-=1;break;case"ArrowRight":case"d":case"D":k.x+=1;break;default:return}if(p.preventDefault(),p.stopPropagation(),Kt(k,o,r,y,{npcs:o.entities.npcs})){const q=o.tiles[k.y][k.x],se=R.find(U=>U.fromAreaId===o.id&&U.fromPosition.x===k.x&&U.fromPosition.y===k.y),te=!u&&p.shiftKey,ae=r.stealthModeEnabled?te?"sprint":"silent":te?"sprint":"normal";if(r.movementProfile!==ae&&t(Mn(ae)),se){const U=E[se.toAreaId];if(I&&q.type===Hr.DOOR&&U&&!U.isInterior){t(O(w.checkpointSealed));return}if(U){if(!xt({sprint:te}))return;t(Br(U)),t(Yt(se.toPosition)),U.isInterior&&(t(sn({type:"campfireRest",locationId:U.id})),t(O(w.slipInsideStructure)),st("clear"))}else e.warn(`Missing target area in state for ${se.toAreaId}`);Ce([]),Pe(null);return}if(!xt({sprint:te}))return;if(t(Yt(k)),I&&!_){if(Ut==="clear")t(O(w.searchlightsWarning)),st("warning");else if(Ut==="warning"){const U=Pr(k);if(U){const ie={id:et(),resourceKey:"enemies.corpsec_guard",name:w.curfewPatrolName,position:U,maxHealth:30,health:30,actionPoints:6,maxActionPoints:6,damage:6,attackRange:1,isHostile:!0};t(Wr(ie)),t(sn({type:"patrolAmbush",locationId:o==null?void 0:o.id,tags:["corpsec"]})),u?t(O(w.curfewReinforcement)):(t(Lt()),t(O(w.curfewOpenFire)))}else t(O(w.curfewFootsteps));st("spawned")}}else Ut!=="clear"&&st("clear");u&&(e.debug("handleKeyDown: PRE-MOVE AP DEDUCTION",{apCost:1,playerAP_before:r.actionPoints}),t($i(-1)),e.debug("handleKeyDown: POST-MOVE AP DEDUCTION",{apCost:1,playerAP_after:r.actionPoints-1}),r.actionPoints<=1&&(e.debug("handleKeyDown: Player out of AP after move, switching turn."),t(ct())))}},[r,o,u,g,t,y,Mr,Tn,I,Ut,Pr,E,Ne,Ce,Pe,A,R,G,m,le,Ve,e,w,xt,$]),Ja=c.useCallback(p=>{p.key},[]);return a.jsx("div",{ref:vt,tabIndex:0,onKeyDown:Za,onKeyUp:Ja,className:"fixed inset-0 focus:outline-none",style:{zIndex:1},"data-testid":"game-controller"})},hc=(...e)=>e.filter(Boolean).join(" "),yc=(e,t,n,r)=>r==="none"?"base":r==="ascending"?e>=n?"critical":e>=t?"warning":"base":e<=n?"critical":e<=t?"warning":"base",cs=({label:e,current:t,max:n,icon:r,variant:s="neutral",lowThreshold:i=50,criticalThreshold:l=25,disableGlow:o=!1,dangerDirection:d="descending"})=>{const m=c.useMemo(()=>{if(n<=0)return 0;const u=t/n*100;return Math.max(0,Math.min(100,u))},[t,n]),f=yc(m,i,l,d);return a.jsxs("div",{className:"hud-stat","data-variant":s,"data-level":f,"data-glow":o?"off":"on",children:[a.jsxs("div",{className:hc("hud-stat__row",f!=="base"?"hud-stat__row--emphasis":null),children:[a.jsxs("div",{className:"flex items-center gap-[0.4rem]",children:[r?a.jsx("span",{className:"hud-stat__icon",children:r}):null,a.jsx("span",{children:e})]}),a.jsxs("span",{className:"hud-stat__value","aria-live":"polite",children:[t,"/",n]})]}),a.jsx("div",{className:"hud-stat__bar",children:a.jsx("div",{className:"hud-stat__fill",style:{width:`${m}%`}})})]})},bc=(...e)=>e.filter(Boolean).join(" "),Oa=c.forwardRef(({className:e,title:t,children:n,role:r,...s},i)=>a.jsxs("svg",{ref:i,viewBox:"0 0 24 24",className:bc("h-4 w-4 shrink-0 text-current",e),role:t?r??"img":"presentation","aria-hidden":t?void 0:!0,...s,children:[t?a.jsx("title",{children:t}):null,n]}));Oa.displayName="IconBase";const xc=({className:e,...t})=>a.jsxs(Oa,{className:e,...t,children:[a.jsx("path",{d:"M12 4.8 4 18.4c-.4.7.1 1.6.9 1.6h14.2c.8 0 1.3-.9.9-1.6L12 4.8z",fill:"currentColor",fillOpacity:.2}),a.jsx("path",{d:"M12 4.8 4 18.4c-.4.7.1 1.6.9 1.6h14.2c.8 0 1.3-.9.9-1.6L12 4.8z",stroke:"currentColor",strokeWidth:1.8,strokeLinejoin:"round",fill:"none"}),a.jsx("path",{d:"M12 9.8v3.8",stroke:"currentColor",strokeWidth:1.8,strokeLinecap:"round",fill:"none"}),a.jsx("circle",{cx:12,cy:16.6,r:1,fill:"currentColor"})]}),vc=({onOpenCharacter:e,characterOpen:t=!1,showActionButton:n=!0,className:r,variant:s="default"})=>{const i=Xe(),l=P(B=>B.player.data),o=P(Ra),d=P(B=>B.settings.locale),m=P(B=>B.settings.testMode),f=P(nc),u=Qe(d),g=u.stealthIndicator,h=l.backgroundId?Yi[l.backgroundId]:void 0,I=(h==null?void 0:h.name)??u.playerStatus.backgroundFallback,y=Math.round(o),E=f.isActive?g.stealthToggleOn:g.stealthToggleOff,R=f.blockedReason==="combat"?g.unavailableReasons.combat:f.blockedReason==="dialogue"?g.unavailableReasons.dialogue:f.blockedReason==="cooldown"?g.cooldown(Math.max(1,f.cooldownSeconds||1)):g.keyHint,M=()=>{const B=l.level,A=Zi(B+1),Q=l.experience,$=A-Q;i(an({amount:Math.max(1,$),reason:"Test mode XP boost"}))},F=s==="frameless"?"flex h-full min-h-0 flex-1 flex-col gap-[0.5rem] px-0 py-0 text-[#f8fafc] font-body":"flex flex-col gap-[0.5rem] rounded-[18px] border border-[rgba(59,130,246,0.22)] bg-[linear-gradient(145deg,rgba(8,15,30,0.92),rgba(12,22,42,0.82),rgba(6,12,28,0.92))] px-[0.9rem] py-[0.9rem] text-[#f8fafc] shadow-[0_20px_30px_-20px_rgba(8,12,24,0.5)] backdrop-blur-[14px] font-body",G=r?`${F} ${r}`:F;return a.jsxs("div",{className:G,"data-testid":"player-summary-panel",children:[a.jsx("div",{className:"flex items-start gap-[0.75rem]",children:a.jsxs("div",{className:"flex min-w-0 flex-1 flex-col gap-[0.2rem]",children:[a.jsxs("div",{className:"flex items-center gap-[0.5rem] text-[0.9rem] uppercase tracking-[0.26em] text-[#bfdbfe] drop-shadow-[0_0_8px_rgba(56,189,248,0.4)]",children:[a.jsx("span",{className:"truncate",children:l.name}),a.jsxs("span",{className:"inline-flex items-center gap-[0.25rem] rounded-[999px] border border-[rgba(56,189,248,0.45)] bg-[rgba(56,189,248,0.18)] px-[0.55rem] py-[0.22rem] text-[0.6rem] font-semibold tracking-[0.14em] text-[#f8fafc] shadow-[0_10px_20px_-10px_rgba(56,189,248,0.55)]",children:[u.playerStatus.levelLabel," ",l.level]}),a.jsx("button",{type:"button",onClick:()=>i(Xi()),className:["inline-flex items-center gap-[0.25rem] rounded-[999px] border px-[0.55rem] py-[0.22rem] text-[0.6rem] font-semibold uppercase tracking-[0.14em] transition-all duration-150",f.isActive?"border-[rgba(45,212,191,0.65)] bg-[rgba(20,83,74,0.44)] text-[#ccfbf1] shadow-[0_10px_20px_-12px_rgba(20,184,166,0.55)]":"border-[rgba(148,163,184,0.6)] bg-[rgba(30,41,59,0.45)] text-[#dbeafe] shadow-[0_10px_20px_-12px_rgba(59,130,246,0.35)]"].join(" "),"data-testid":"player-stealth-toggle","aria-pressed":f.isActive,title:R,children:E})]}),a.jsx("div",{className:"text-[0.6rem] uppercase tracking-[0.12em] text-[rgba(226,232,240,0.72)]",children:I})]})}),a.jsx(cs,{label:u.playerStatus.healthLabel,current:l.health,max:l.maxHealth,variant:"health",lowThreshold:50,criticalThreshold:25}),a.jsx(cs,{label:u.playerStatus.paranoiaLabel,current:y,max:100,variant:"paranoia",lowThreshold:50,criticalThreshold:75,dangerDirection:"ascending"}),l.isExhausted&&a.jsxs("span",{className:"mt-[0.35rem] inline-flex items-center gap-[0.3rem] rounded-[999px] border border-[rgba(250,204,21,0.65)] bg-[rgba(250,204,21,0.08)] px-[0.55rem] py-[0.22rem] text-[0.55rem] font-semibold uppercase tracking-[0.14em] text-[#facc15] shadow-[0_8px_18px_-12px_rgba(250,204,21,0.6)]",title:u.playerStatus.fatigueHint,children:[a.jsx(xc,{className:"text-[#facc15]","aria-hidden":!0}),a.jsx("span",{children:u.playerStatus.fatigueStatus})]}),a.jsxs("div",{className:"grid grid-cols-2 gap-[0.28rem]",children:[a.jsxs("div",{className:"flex min-w-0 flex-col gap-[0.12rem] rounded-[12px] border border-[rgba(248,250,252,0.08)] bg-[linear-gradient(160deg,rgba(14,26,52,0.88),rgba(10,18,34,0.88))] px-[0.5rem] py-[0.45rem] shadow-[0_16px_30px_-20px_rgba(13,148,136,0.6)]",children:[a.jsx("span",{className:"text-[0.5rem] uppercase tracking-[0.12em] text-[rgba(148,163,184,0.7)]",children:u.playerStatus.creditsLabel}),a.jsxs("span",{className:"text-[0.85rem] font-semibold text-[#fbbf24] drop-shadow-[0_0_12px_rgba(251,191,36,0.5)]",children:["₿",l.credits]})]}),a.jsxs("div",{className:"flex min-w-0 flex-col gap-[0.12rem] rounded-[12px] border border-[rgba(248,250,252,0.08)] bg-[linear-gradient(160deg,rgba(14,26,52,0.88),rgba(10,18,34,0.88))] px-[0.5rem] py-[0.45rem] shadow-[0_16px_30px_-20px_rgba(13,148,136,0.6)]",children:[a.jsx("span",{className:"text-[0.5rem] uppercase tracking-[0.12em] text-[rgba(148,163,184,0.7)]",children:u.playerStatus.experienceLabel}),a.jsx("span",{className:"text-[0.85rem] font-semibold text-[#38bdf8] drop-shadow-[0_0_12px_rgba(56,189,248,0.45)]",children:Qi(l.experience,l.level)})]})]}),e&&n&&a.jsxs("div",{className:"flex gap-[0.5rem]",children:[a.jsx("button",{type:"button",onClick:e,className:["flex-1 rounded-[999px] border px-[0.75rem] py-[0.42rem] text-[0.58rem] font-semibold uppercase tracking-[0.18em] text-[#e0f2fe] shadow-[0_12px_20px_-18px_rgba(56,189,248,0.45)] transition-transform duration-200 focus:outline-none focus-visible:ring-2 focus-visible:ring-neon/60 focus-visible:ring-offset-2 focus-visible:ring-offset-gunmetal-900",t?"border-[rgba(251,191,36,0.9)] bg-[linear-gradient(130deg,rgba(251,191,36,0.6),rgba(249,115,22,0.55))] text-[#fff7e1]":"border-[rgba(56,189,248,0.55)] bg-[linear-gradient(130deg,rgba(56,189,248,0.48),rgba(14,165,233,0.45))]"].join(" "),"data-testid":"summary-open-character","aria-pressed":t,children:u.shell.characterButton}),m&&a.jsx("button",{type:"button",onClick:M,className:"flex-1 rounded-[999px] border border-[rgba(251,191,36,0.9)] bg-[linear-gradient(130deg,rgba(251,191,36,0.48),rgba(249,115,22,0.45))] px-[0.75rem] py-[0.38rem] text-[0.58rem] font-semibold uppercase tracking-[0.18em] text-[#fff8dc] shadow-[0_12px_20px_-16px_rgba(251,191,36,0.48)] transition-all duration-200 hover:-translate-y-[2px] hover:scale-[1.01] hover:border-[rgba(251,191,36,1)] hover:shadow-[0_0_0_2px_rgba(251,191,36,0.4),0_14px_24px_-16px_rgba(251,191,36,0.6)] focus:outline-none focus-visible:ring-2 focus-visible:ring-amber-400 focus-visible:ring-offset-2 focus-visible:ring-offset-gunmetal-900",title:"Test Mode: Gain XP to level up",children:"⬆ Level Up"})]})]})},wc=pn.memo(vc),ds=15,Sc=e=>{const{totalMinutes:t}=da(e),n=Math.floor(t/ds)*ds,r=Math.floor(n/60)%24,s=n%60;return`${r.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`},kc=()=>{const e=P(l=>Sc(l.world.currentTime)),t=P(l=>l.settings.locale),n=Qe(t).dayNight,[r,s]=e.split(":");return a.jsxs(a.Fragment,{children:[a.jsx("style",{children:`
    .day-night-clock {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0.28rem;
      width: 7.6rem;
      justify-content: center;
      padding: 0.44rem 0.7rem;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.9);
      box-shadow: 0 0 12px rgba(56, 189, 248, 0.16);
      color: #e2e8f0;
      font-family: 'DM Mono', 'IBM Plex Mono', monospace;
      font-size: 0.98rem;
      font-weight: 600;
      letter-spacing: 0.14em;
      line-height: 1;
      text-shadow: 0 0 9px rgba(56, 189, 248, 0.32);
      pointer-events: none;
      user-select: none;
    }

    .day-night-clock::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(
        to bottom,
        rgba(148, 163, 184, 0.1),
        rgba(15, 23, 42, 0)
      );
      pointer-events: none;
    }

    .day-night-clock__digit {
      display: inline-flex;
      min-width: 1.55rem;
      justify-content: center;
    }

    .day-night-clock__colon {
      color: rgba(186, 230, 253, 0.9);
    }
  `}),a.jsxs("div",{className:"day-night-clock",role:"status","aria-label":`${n.clockLabel}: ${e}`,"data-testid":"day-night-clock",children:[a.jsx("span",{className:"day-night-clock__digit",children:r}),a.jsx("span",{className:"day-night-clock__colon","aria-hidden":!0,children:":"}),a.jsx("span",{className:"day-night-clock__digit",children:s})]})]})},Zt=8,Fa={liveArea:20,stroke:2},us={floor:"#101b32",wall:"#1f2937",door:"#fbbf24",cover:"#1d4ed8",water:"#0ea5e9",trap:"#7c3aed",default:"#101b32"},fs={player:"#60a5fa",enemy:"#f87171",npc:"#34d399",objective:"#facc15"},ms={[ee.IDLE]:"#38bdf8",[ee.SUSPICIOUS]:"#fbbf24",[ee.INVESTIGATING]:"#f97316",[ee.ALARMED]:"#ef4444",[ee.DISABLED]:"#64748b"},fn=Fa.stroke,za=Fa.liveArea/2,Ic="rgba(15, 23, 42, 0.95)",ps=16,Ec=256,Tc=192,Cc=192,Mc=160,Ha=(e,t)=>{if(typeof window>"u"||typeof document>"u")return t;try{const n=window.getComputedStyle(document.documentElement).getPropertyValue(e);return(n==null?void 0:n.trim())||t}catch{return t}},Ba=()=>Ha("--color-hud-surface",Ic),Pc=()=>{const e=Ha("--hud-radius-lg",`${ps}px`),t=Number.parseFloat(e);return Number.isFinite(t)?t:ps},Jn=e=>({minX:0,minY:0,maxX:Math.max(0,e.mapWidth-1),maxY:Math.max(0,e.mapHeight-1),width:Math.max(1,e.mapWidth),height:Math.max(1,e.mapHeight)}),Jt=e=>{var n;if(!e)return!1;const t=((n=e.type)==null?void 0:n.toString().toLowerCase())??"";return t==="wall"||t==="door"||t==="cover"?!0:e.isWalkable===!1},zn=e=>{var y;const t=e.tiles;if(!t.length||!((y=t[0])!=null&&y.length))return Jn(e);const n=(E,R,M)=>Math.min(Math.max(E,R),M),r=E=>{if(!E)return-1;for(let R=0;R<E.length;R+=1)if(Jt(E[R]))return R;return-1},s=E=>{if(!E)return-1;for(let R=E.length-1;R>=0;R-=1)if(Jt(E[R]))return R;return-1},i=E=>{for(let R=0;R<t.length;R+=1){const M=t[R];if(M&&Jt(M[E]))return R}return-1},l=E=>{for(let R=t.length-1;R>=0;R-=1){const M=t[R];if(M&&Jt(M[E]))return R}return-1};let o=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY,m=Number.POSITIVE_INFINITY,f=Number.NEGATIVE_INFINITY;for(let E=0;E<t.length;E+=1){const R=t[E],M=r(R);M!==-1&&M<o&&(o=M);const F=s(R);F!==-1&&F>d&&(d=F)}for(let E=0;E<e.mapWidth;E+=1){const R=i(E);R!==-1&&R<m&&(m=R);const M=l(E);M!==-1&&M>f&&(f=M)}if(!Number.isFinite(o)||!Number.isFinite(d)||!Number.isFinite(m)||!Number.isFinite(f))return Jn(e);const u=n(o,0,Math.max(0,e.mapWidth-1)),g=n(d,u,Math.max(0,e.mapWidth-1)),h=n(m,0,Math.max(0,e.mapHeight-1)),I=n(f,h,Math.max(0,e.mapHeight-1));return{minX:u,minY:h,maxX:g,maxY:I,width:Math.max(1,g-u+1),height:Math.max(1,I-h+1)}},Nt=(e,t,n)=>Math.min(Math.max(e,t),n),gs=(e,t)=>Math.min(za,Math.max(3,e*t)),mt=(e,t=fn)=>Math.max(.5,t)/Math.max(e,1e-4),Rc=(e,t,n,r,s,i)=>{const l=Math.max(0,Math.min(i,Math.min(r,s)/2));e.beginPath(),e.moveTo(t+l,n),e.lineTo(t+r-l,n),e.quadraticCurveTo(t+r,n,t+r,n+l),e.lineTo(t+r,n+s-l),e.quadraticCurveTo(t+r,n+s,t+r-l,n+s),e.lineTo(t+l,n+s),e.quadraticCurveTo(t,n+s,t,n+s-l),e.lineTo(t,n+l),e.quadraticCurveTo(t,n,t+l,n),e.closePath()},Hn=(e,t)=>{const n=1.3333333333333333,r=Math.max(1,Math.round(t.width)),s=Math.max(1,Math.round(t.height));let i=Math.max(1,e.width),l=Math.max(1,e.height);return i/l>n?i=l*n:l=i/n,i>r&&(i=r,l=i/n),l>s&&(l=s,i=l*n,i>r&&(i=r,l=i/n)),{width:Math.max(1,Math.round(i)),height:Math.max(1,Math.round(l))}},Ac=(e,t,n)=>{if(!e)return null;const r=window.devicePixelRatio||1,s=Math.max(1,Math.round(t*r)),i=Math.max(1,Math.round(n*r));e.width!==s&&(e.width=s),e.height!==i&&(e.height=i),e.style.width=`${t}px`,e.style.height=`${n}px`;const l=e.getContext("2d");return l?(l.setTransform(r,0,0,r,0,0),l.imageSmoothingEnabled=!1,l):null},Dc=({ctx:e,state:t,crop:n})=>{const{tiles:r,tileScale:s}=t,i=Ba();e.fillStyle=i,e.fillRect(n.minX*s,n.minY*s,n.width*s,n.height*s);for(let l=n.minY;l<=n.maxY;l+=1){const o=r[l];if(o)for(let d=n.minX;d<=n.maxX;d+=1){const m=o[d];if(!m)continue;const f=us[m.type.toLowerCase()]??us.default;e.fillStyle=f,e.fillRect(d*s,l*s,s,s),m.provideCover&&(e.fillStyle="rgba(59, 130, 246, 0.15)",e.fillRect(d*s,l*s,s,s))}}},_c=({ctx:e,state:t,scale:n,crop:r})=>{const{tileScale:s,entities:i,cameras:l}=t,o=t.objectiveMarkers??[];i.forEach(d=>{if(d.x<r.minX||d.x>r.maxX||d.y<r.minY||d.y>r.maxY)return;const m=fs[d.kind]??fs.npc,f=gs(s,d.kind==="player"?.7:d.kind==="npc"?.62:.5),u=(d.x+.5)*s,g=(d.y+.5)*s;d.kind==="player"?(e.fillStyle=m,e.beginPath(),e.moveTo(u,g-f),e.lineTo(u+f,g+f),e.lineTo(u-f,g+f),e.closePath(),e.fill()):(e.fillStyle=d.status==="inactive"?"rgba(148, 163, 184, 0.35)":m,e.beginPath(),e.arc(u,g,f*.85,0,Math.PI*2),e.fill(),(d.kind==="enemy"||d.kind==="npc")&&(e.strokeStyle="rgba(15, 23, 42, 0.85)",e.lineWidth=mt(n),e.stroke()))}),o.forEach(d=>{if(d.x<r.minX||d.x>r.maxX||d.y<r.minY||d.y>r.maxY)return;const m=d.markerKind==="questContact",f=Math.min(za,Math.max(m?6:5,s*(m?.66:.55))),u=(d.x+.5)*s,g=(d.y+.5)*s;e.fillStyle=m?"rgba(34, 211, 238, 0.2)":"rgba(251, 191, 36, 0.2)",e.beginPath(),e.arc(u,g,f,0,Math.PI*2),e.fill(),e.strokeStyle=m?"rgba(34, 211, 238, 0.95)":"rgba(251, 191, 36, 0.95)",e.lineWidth=mt(n),e.beginPath(),e.arc(u,g,f*.7,0,Math.PI*2),e.stroke()}),l.forEach(d=>{if(d.x<r.minX||d.x>r.maxX||d.y<r.minY||d.y>r.maxY)return;const m=d.isActive?ms[d.alertState]:ms[ee.DISABLED],f=gs(s,.5),u=(d.x+.5)*s,g=(d.y+.5)*s;e.save(),e.fillStyle=m,e.beginPath(),e.moveTo(u,g-f),e.lineTo(u+f,g+f),e.lineTo(u-f,g+f),e.closePath(),e.fill(),e.lineWidth=mt(n),e.strokeStyle="rgba(15, 23, 42, 0.65)",e.stroke(),e.restore()})},Lc=({ctx:e,state:t,scale:n})=>{const{path:r,tileScale:s}=t;if(!r||r.length<2)return;e.strokeStyle="rgba(59, 130, 246, 0.6)",e.lineWidth=mt(n,fn*.95),e.lineJoin="round",e.lineCap="round",e.setLineDash([s*.8,s*.5]),e.beginPath(),r.forEach((d,m)=>{const f=(d.x+.5)*s,u=(d.y+.5)*s;m===0?e.moveTo(f,u):e.lineTo(f,u)}),e.stroke(),e.setLineDash([]);const i=r[r.length-1],l=(i.x+.5)*s,o=(i.y+.5)*s;e.fillStyle="rgba(59, 130, 246, 0.12)",e.beginPath(),e.arc(l,o,Math.max(4,s*.4),0,Math.PI*2),e.fill(),e.strokeStyle="rgba(59, 130, 246, 0.7)",e.lineWidth=mt(n),e.beginPath(),e.arc(l,o,Math.max(3,s*.28),0,Math.PI*2),e.stroke()},jc=({ctx:e,state:t,scale:n},r)=>{const{viewport:s,tileScale:i}=t;if(!s||s.width<=0||s.height<=0)return;const l=r.width,o=r.height,d=l*i,m=o*i,f=(s.x+s.width/2)*i,u=(s.y+s.height/2)*i,g=f-d/2,h=u-m/2,I=Math.min(Math.max(4,d*.12),Pc()/Math.max(n,1e-4));e.save(),e.lineWidth=mt(n,fn*.85),e.strokeStyle="rgba(148, 163, 184, 0.4)",Rc(e,g,h,d,m,I),e.stroke(),e.restore();const y=Math.max(2,i*.5);e.save(),e.strokeStyle="rgba(148, 163, 184, 0.5)",e.lineWidth=mt(n,fn*.75),e.beginPath(),e.moveTo(f-y,u),e.lineTo(f+y,u),e.moveTo(f,u-y),e.lineTo(f,u+y),e.stroke(),e.restore()},Nc=(e,t,n,r,s,i)=>{const l=Ac(e,n,r);if(!l)return;l.clearRect(0,0,n,r),l.fillStyle=Ba(),l.fillRect(0,0,n,r);const o=i.width*t.tileScale,d=i.height*t.tileScale;if(o<=0||d<=0)return;const m=Math.min(n/o,r/d),f=(n-o*m)/2,u=(r-d*m)/2;l.save(),l.translate(f,u),l.scale(m,m),l.translate(-i.minX*t.tileScale,-i.minY*t.tileScale);const g={ctx:l,state:t,scale:m,crop:i};Dc(g),Lc(g),_c(g),jc(g,s),l.restore()},Oc=()=>{const e=c.useRef(null),t=c.useRef(null),n=c.useRef(dt.getState()),r=c.useRef(n.current?zn(n.current):null),[s,i]=c.useState({width:Ec,height:Tc}),[l,o]=c.useState(0),d=c.useRef(null),m=c.useRef(null),f=c.useRef(!1),u=c.useRef(null),g=c.useRef(!1),h=c.useCallback(()=>n.current,[]),I=c.useCallback(S=>S?(r.current||(r.current=zn(S)),r.current??Jn(S)):null,[]),y=c.useCallback(S=>{const N=S.viewport;if(!N)return;m.current!==S.areaId&&(d.current=null,m.current=S.areaId);const W=Hn(N,{width:S.mapWidth,height:S.mapHeight}),z=d.current;(!z||z.width!==W.width||z.height!==W.height)&&(d.current=W)},[]);c.useEffect(()=>{const S=N=>{const W=N.detail;n.current=W,r.current=zn(W),y(W),o(W.version)};return dt.addEventListener(Gr,S),dt.requestImmediateState(),()=>{dt.removeEventListener(Gr,S)}},[y]),c.useEffect(()=>{const S=e.current;if(!S||typeof ResizeObserver>"u")return;const N=new ResizeObserver(()=>{const W=Math.max(Cc,Math.floor(S.clientWidth/Zt)*Zt),z=Math.max(Mc,Math.floor(S.clientHeight/Zt)*Zt);i(T=>T.width===W&&T.height===z?T:{width:W,height:z}),dt.setCanvasBounds(W,z)});return N.observe(S),()=>N.disconnect()},[]),c.useEffect(()=>{const S=h(),N=d.current,W=I(S);!S||!N||!W||Nc(t.current,S,s.width,s.height,N,W)},[s.width,s.height,l,h,I]);const E=c.useCallback(S=>{const N=h(),W=t.current,z=I(N);if(!N||!W||!z)return null;const T=W.getBoundingClientRect(),ue=T.width,Z=T.height;if(ue===0||Z===0)return null;const fe=z.width*N.tileScale,Y=z.height*N.tileScale,J=Math.min(ue/fe,Z/Y),le=(ue-fe*J)/2,me=(Z-Y*J)/2,xe=(S.clientX-T.left-le)/J,ke=(S.clientY-T.top-me)/J,x=xe+z.minX*N.tileScale,L=ke+z.minY*N.tileScale,b=Nt(x/N.tileScale,0,N.mapWidth),j=Nt(L/N.tileScale,0,N.mapHeight);return{gridX:b,gridY:j}},[I,h]),R=c.useCallback((S,N)=>{if(!S)return;const W=h(),z=W==null?void 0:W.viewport;if(!W||!z)return;const T=d.current??Hn(z,{width:W.mapWidth,height:W.mapHeight}),ue=T.width/2,Z=T.height/2,fe=Nt(S.gridX,ue,Math.max(ue,W.mapWidth-ue)),Y=Nt(S.gridY,Z,Math.max(Z,W.mapHeight-Z));d.current=T,dt.emitInteraction({type:Ji,gridX:fe,gridY:Y,animate:N})},[h]),M=S=>{if(S.pointerType!=="touch"&&S.button!==0)return;const N=E(S);if(N){if(f.current=!0,g.current=!1,u.current=S.pointerId,typeof S.currentTarget.setPointerCapture=="function")try{S.currentTarget.setPointerCapture(S.pointerId)}catch{}R(N,!0)}},F=S=>{if(!f.current||u.current!==S.pointerId)return;const N=E(S);N&&(g.current=!0,R(N,!1))},G=S=>{if(!f.current||u.current!==S.pointerId)return;const N=E(S);R(N,!g.current),f.current=!1,u.current=null},B=S=>{u.current===S.pointerId&&(f.current=!1,u.current=null)},A=()=>{f.current=!1,u.current=null},Q=S=>{S.preventDefault();const N=Nt(S.deltaY,-120,120);dt.adjustZoom(N<0?.15:-.15)},$=S=>{if(!["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(S.key))return;S.preventDefault();const N=h();if(!N)return;const W=d.current??Hn(N.viewport,{width:N.mapWidth,height:N.mapHeight}),z=Math.max(1,Math.floor(W.width*.2));let T=N.viewport.x+N.viewport.width/2,ue=N.viewport.y+N.viewport.height/2;switch(S.key){case"ArrowUp":ue-=z;break;case"ArrowDown":ue+=z;break;case"ArrowLeft":T-=z;break;case"ArrowRight":T+=z;break}R({gridX:T,gridY:ue},!1)};return!(h()&&d.current)?null:a.jsx("section",{className:"mini-map-panel","aria-label":"MiniMap panel",children:a.jsx("div",{ref:e,className:"mini-map-canvas",role:"application","aria-label":"MiniMap viewport",tabIndex:0,onKeyDown:$,onWheel:Q,onPointerDown:M,onPointerMove:F,onPointerUp:G,onPointerCancel:B,onPointerLeave:A,children:a.jsx("canvas",{ref:t,style:{width:"100%",height:"100%",display:"block"}})})})},Fc=pn.memo(Oc),zc=({children:e,className:t,variant:n="default"})=>{const r=n==="frameless"?"flex h-full min-h-0 flex-1 flex-col gap-[0.5rem] px-0 py-0 text-[#f8fafc] font-body":"flex h-full min-h-0 flex-1 flex-col gap-[0.5rem] rounded-[18px] border border-[rgba(59,130,246,0.22)] bg-[linear-gradient(145deg,rgba(8,15,30,0.92),rgba(12,22,42,0.82),rgba(6,12,28,0.92))] px-[0.9rem] py-[0.9rem] text-[#f8fafc] shadow-[0_20px_30px_-20px_rgba(8,12,24,0.5)] backdrop-blur-[14px] font-body",s=t?`${r} ${t}`:r;return a.jsx("div",{className:s,"data-testid":"tactical-panel",children:e})},Hc=pn.memo(zc),yn=e=>e.player.data,Bc=e=>!!e.settings.reputationSystemsEnabled,$c={resistance:0,corpsec:0,scavengers:0};X(yn,e=>e.karma);const Wc=X(yn,Bc,(e,t)=>t?e.factionReputation:$c),Uc={corpsec_defector:{earnest:.6,stoic:.4},street_urchin:{sarcastic:.7,ruthless:.3},underground_hacker:{sarcastic:.6,earnest:.4},wasteland_scavenger:{ruthless:.6,stoic:.4}},Gc=e=>{let t="earnest",n=Number.NEGATIVE_INFINITY;return Object.keys(e).forEach(r=>{const s=e[r];s>n&&(t=r,n=s)}),t},Vc=e=>{const t={earnest:0,sarcastic:0,ruthless:0,stoic:0},n={...t,...e},r=Object.values(n).reduce((s,i)=>s+i,0);return r<=0?{...t,earnest:1}:Object.keys(n).reduce((s,i)=>(s[i]=Number.parseFloat((n[i]/r).toFixed(3)),s),t)},qc=X(yn,e=>{const t={...e.personality.flags};if(e.backgroundId){const r=Uc[e.backgroundId];r&&Object.keys(r).forEach(s=>{const i=t[s]??0;t[s]=i+r[s]})}const n=Vc(t);return{alignment:Gc(n),flags:n,lastUpdated:e.personality.lastUpdated,lastChangeSource:e.personality.lastChangeSource}});X(yn,e=>e.name);const Kc=e=>e.quests.quests,Yc=X(Kc,e=>e.filter(t=>t.isActive&&!t.isCompleted)),Xc=(e,t)=>/main/i.test(e.id)||/main/i.test(e.name)?-50+t:/datapad|operation|cold|iron/i.test(e.id)?-25+t:t,mr=X(Yc,e=>{const t=[];return e.forEach((n,r)=>{n.objectives.filter(s=>!s.isCompleted).forEach((s,i)=>{t.push({questId:n.id,questName:n.name,questDescription:n.description,objective:s,priority:Xc(n,r)*10+i,isPrimary:r===0})})}),t.sort((n,r)=>n.priority-r.priority)});X(mr,e=>e.length>0?e[0]:null);X(mr,e=>e.length>1?e[1]:null);const pr=e=>e.missions,Qc=e=>e.quests.quests,Zc=X(pr,e=>e.levels[e.currentLevelIndex]??null),Jc=e=>e?e.isCompleted?!0:e.objectives.length>0&&e.objectives.every(t=>t.isCompleted):!1,ed=(e,t)=>{const n=e.questIds.map(l=>t.find(o=>o.id===l)),r=e.questIds.length,s=n.filter(Jc).length;return{...e,totalQuests:r,completedQuests:s,isComplete:r===0?!1:s===r}},hs=(e,t)=>e.map(n=>ed(n,t)),Oe=X([Zc,Qc],(e,t)=>{if(!e)return null;const n=hs(e.objectives.filter(i=>i.kind==="primary"),t),r=hs(e.objectives.filter(i=>i.kind==="side"),t),s=n.length>0&&n.every(i=>i.isComplete);return{level:e.level,levelId:e.levelId,name:e.name,zoneId:e.zoneId,primary:n,side:r,allPrimaryComplete:s}});X(Oe,e=>(e==null?void 0:e.primary)??[]);X(Oe,e=>(e==null?void 0:e.side)??[]);const td=X(Oe,e=>(e==null?void 0:e.primary.find(t=>!t.isComplete))??null),nd=X(Oe,e=>(e==null?void 0:e.side.find(t=>!t.isComplete))??null);X(Oe,e=>(e==null?void 0:e.allPrimaryComplete)??!1);const $a=X(pr,e=>e.pendingAdvance),rd=X(pr,e=>e.celebrationAcknowledged);X(Oe,e=>(e==null?void 0:e.level)??0);X(Oe,e=>(e==null?void 0:e.name)??"");const er={banter:{earnest:[{text:"Shelterline kids started a rumor that thunder is just the ocean applauding us. Let’s stay worth the encore.",guidelineRef:"plot.tone.guideline.7"},{text:"Amara logged a new morale playlist: ninety minutes of clattering cutlery recorded during a pre-war dinner rush. We could dance to that later.",guidelineRef:"plot.tone.guideline.6"}],sarcastic:[{text:"CorpSec just issued an alert about “unauthorized optimism in Sector 12.” Congratulations, you’re contraband joy.",guidelineRef:"plot.tone.guideline.4"},{text:"Fun fact: drone firmware now includes “coyote deterrent mode.” Somewhere an engineer thinks we’re wildlife. Let’s give them a nature documentary.",guidelineRef:"plot.tone.guideline.2"}],ruthless:[{text:"Found an ESD memo describing us as “surgical entropy.” I’ll embrace the brand if you do.",guidelineRef:"plot.tone.guideline.5"},{text:"CorpSec requisitioned riot foam flavored like citrus. Imagine choking on oranges while we dismantle their barricade.",guidelineRef:"plot.tone.guideline.2"}],stoic:[{text:"Filed under anomalies: pigeons roosting in the comms tower tapped out Morse for “stay loud.” No human hands detected.",guidelineRef:"plot.tone.guideline.2"},{text:"Supply ledger shows someone requisitioned 40 kilos of glitter for “psychological operations.” I logged it as “to be determined.”",guidelineRef:"plot.tone.guideline.3"}]},interjections:{questCompleted:{earnest:[{text:"Objective archived. You just stretched curfew a little thinner.",guidelineRef:"plot.tone.guideline.1"},{text:"Quest wrapped. Shelterline will taste this win in their next ration drop.",guidelineRef:"plot.tone.guideline.7"}],sarcastic:[{text:"You crushed that objective so hard the drones filed a workplace grievance.",guidelineRef:"plot.tone.guideline.4"},{text:"Quest complete. Somewhere an ESD analyst just spat in their nutrient slurry.",guidelineRef:"plot.tone.guideline.4"}],ruthless:[{text:"Target neutralized. Momentum stays with us.",guidelineRef:"plot.tone.guideline.5"},{text:"Objective cleared. Line them up for the next strike.",guidelineRef:"plot.tone.guideline.5"}],stoic:[{text:"Task completed. Logging success before it cools.",guidelineRef:"plot.tone.guideline.3"},{text:"Objective done. Updating projections now.",guidelineRef:"plot.tone.guideline.3"}]},reputationPositive:{earnest:[{text:"Your name circulates with smiles today. Resistance morale just spiked.",guidelineRef:"plot.tone.guideline.7"}],sarcastic:[{text:"Congrats, you’re trending on the underground net for something other than property damage.",guidelineRef:"plot.tone.guideline.4"}],ruthless:[{text:"Factions noticed your precision. They’ll expect more sharp edges.",guidelineRef:"plot.tone.guideline.5"}],stoic:[{text:"Reputation bump logged. Allies recalibrating expectations.",guidelineRef:"plot.tone.guideline.3"}]},reputationNegative:{earnest:[{text:"Heads up: whispers turned uneasy. We might need to mend fences soon.",guidelineRef:"plot.tone.guideline.1"}],sarcastic:[{text:"Your popularity dip just broke a few pirate radio polls. Impressive in its own way.",guidelineRef:"plot.tone.guideline.4"}],ruthless:[{text:"Standing dropped. Intimidation can be leverage, but watch the collateral.",guidelineRef:"plot.tone.guideline.5"}],stoic:[{text:"Faction trust decaying. Rebalancing recommendations forthcoming.",guidelineRef:"plot.tone.guideline.3"}]},hostileEntered:{earnest:[{text:"Sensors scream hostile territory. Stay quick, stay breathing.",guidelineRef:"plot.tone.guideline.1"}],sarcastic:[{text:"Welcome to enemy hospitality. Complimentary bullets on the mezzanine.",guidelineRef:"plot.tone.guideline.4"}],ruthless:[{text:"Hostile zone confirmed. Perfect conditions for decisive violence.",guidelineRef:"plot.tone.guideline.5"}],stoic:[{text:"Hostility detected. Updating threat overlay now.",guidelineRef:"plot.tone.guideline.3"}]}}},sd=e=>{const t=er.banter[e]??er.banter.earnest;return t[Math.floor(Math.random()*t.length)]},ad=(e,t)=>{const n=er.interjections[e];if(!n)return null;const r=n[t]??n.earnest;return!r||r.length===0?null:r[Math.floor(Math.random()*r.length)]},id=["gangHeat","curfewLevel","supplyScarcity","blackoutTier"],od={rumor:45e3,signage:45e3,weather:3e4,zoneDanger:15e3,hazardChange:12e3,zoneBrief:6e4},tr=e=>({gangHeat:e.gangHeat,curfewLevel:e.curfewLevel,supplyScarcity:e.supplyScarcity,blackoutTier:e.blackoutTier}),ys=e=>({flags:tr(e.flags),impacts:{behavior:{...e.impacts.behavior},faction:{...e.impacts.faction},travel:{...e.impacts.travel}},rumor:e.rumor?{groupId:e.rumor.groupId,lines:[...e.rumor.lines],storyFunction:e.rumor.storyFunction,updatedAt:e.rumor.updatedAt}:null,signage:e.signage?{signId:e.signage.signId,text:e.signage.text,storyFunction:e.signage.storyFunction,updatedAt:e.signage.updatedAt}:null,weather:{presetId:e.weather.presetId,description:e.weather.description,storyFunction:e.weather.storyFunction,updatedAt:e.weather.updatedAt,rainIntensity:e.weather.rainIntensity,thunderActive:e.weather.thunderActive,timeOfDay:e.weather.timeOfDay},zone:{zoneId:e.zone.zoneId,zoneName:e.zone.zoneName,dangerRating:e.zone.dangerRating,hazards:[...e.zone.hazards],summary:e.zone.summary,directives:[...e.zone.directives]}}),bs=e=>{const t=new Map;return e.forEach(n=>{const r=n.trim();if(!r)return;const s=r.toLowerCase();t.has(s)||t.set(s,r)}),t},ld=(e,t)=>{if(e.length!==t.length)return!1;for(let n=0;n<e.length;n+=1)if(e[n]!==t[n])return!1;return!0};class cd{constructor(t){je(this,"previous",null);je(this,"lastEmitted",{});je(this,"cooldowns");this.cooldowns={...od,...(t==null?void 0:t.cooldowns)??{}}}prime(t){this.previous=ys(t),this.lastEmitted={}}reset(){this.previous=null,this.lastEmitted={}}collect(t,n=Date.now()){const r=ys(t);if(!this.previous)return this.previous=r,[];const s=this.diff(this.previous,r,n),i=[];for(const l of s){const o=this.lastEmitted[l.category],d=this.cooldowns[l.category]??0;typeof o=="number"&&d>0&&n-o<d||(i.push(l),this.lastEmitted[l.category]=n)}return this.previous=r,i}diff(t,n,r){const s=[];n.rumor&&n.rumor.lines.length>0&&(!t.rumor||t.rumor.updatedAt!==n.rumor.updatedAt)&&s.push({category:"rumor",timestamp:r,groupId:n.rumor.groupId,lines:[...n.rumor.lines],storyFunction:n.rumor.storyFunction}),n.signage&&(!t.signage||t.signage.updatedAt!==n.signage.updatedAt||t.signage.text!==n.signage.text)&&s.push({category:"signage",timestamp:r,signId:n.signage.signId,text:n.signage.text,storyFunction:n.signage.storyFunction}),(t.weather.presetId!==n.weather.presetId||t.weather.updatedAt!==n.weather.updatedAt||t.weather.rainIntensity!==n.weather.rainIntensity||t.weather.thunderActive!==n.weather.thunderActive||t.weather.timeOfDay!==n.weather.timeOfDay)&&s.push({category:"weather",timestamp:r,presetId:n.weather.presetId,previousPresetId:t.weather.presetId,description:n.weather.description,storyFunction:n.weather.storyFunction,rainIntensity:n.weather.rainIntensity,thunderActive:n.weather.thunderActive,timeOfDay:n.weather.timeOfDay});const l=id.reduce((I,y)=>(t.flags[y]!==n.flags[y]&&I.push({key:y,previous:t.flags[y],next:n.flags[y]}),I),[]),o=t.zone.dangerRating!==n.zone.dangerRating,d=n.zone.zoneName??t.zone.zoneName??null;(o||l.length>0)&&s.push({category:"zoneDanger",timestamp:r,dangerRating:n.zone.dangerRating??null,previousDangerRating:t.zone.dangerRating??null,flags:tr(n.flags),previousFlags:tr(t.flags),changedFlags:l,zoneName:d});const m=bs(t.zone.hazards),f=bs(n.zone.hazards),u=[];f.forEach((I,y)=>{m.has(y)||u.push(I)});const g=[];return m.forEach((I,y)=>{f.has(y)||g.push(I)}),(u.length>0||g.length>0)&&s.push({category:"hazardChange",timestamp:r,added:u,removed:g,zoneName:d}),(t.zone.zoneId!==n.zone.zoneId||t.zone.zoneName!==n.zone.zoneName||t.zone.summary!==n.zone.summary||!ld(t.zone.directives,n.zone.directives))&&s.push({category:"zoneBrief",timestamp:r,zoneName:n.zone.zoneName??d,summary:n.zone.summary??null,dangerRating:n.zone.dangerRating??null,hazards:[...n.zone.hazards],directives:[...n.zone.directives]}),s}}const nr="MISSION_ACCOMPLISHED",rr="LEVEL_ADVANCE_REQUESTED",dd=e=>{typeof window>"u"||window.dispatchEvent(new CustomEvent(nr,{detail:e}))},ud=e=>{typeof window>"u"||window.dispatchEvent(new CustomEvent(rr,{detail:e}))},fd=9e3,xs=48e3,md=96e3,vs=12,pd=['Diagnostics show morale at "manageable"—keep it that way.',"Filed another complaint against the rain. Status: pending since 2034.","If you spot Theo, remind him the coffee synth still needs a filter.","Today’s lucky number is 404. Let’s try not to vanish."],gd={operation:{badge:"OP",tone:"operation"},status:{badge:"ST",tone:"status"},interjection:{badge:"BC",tone:"broadcast"},player:{badge:"ME",tone:"player"},broadcast:{badge:"BC",tone:"broadcast"},battle:{badge:"BT",tone:"battle"},dialog:{badge:"DG",tone:"dialog"},stealth:{badge:"SF",tone:"stealth"}},hd={badge:"--",tone:"broadcast"},ws=({size:e=32,className:t})=>{const n=c.useId(),r=`${n}-bg`,s=`${n}-glow`;return a.jsxs("svg",{className:t,width:e,height:e,viewBox:"0 0 64 64",role:"img","aria-hidden":"true",focusable:"false",children:[a.jsxs("defs",{children:[a.jsxs("linearGradient",{id:r,x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[a.jsx("stop",{offset:"0%",stopColor:"#1e293b",stopOpacity:1}),a.jsx("stop",{offset:"100%",stopColor:"#0f172a",stopOpacity:1})]}),a.jsxs("linearGradient",{id:s,x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[a.jsx("stop",{offset:"0%",stopColor:"#38bdf8",stopOpacity:1}),a.jsx("stop",{offset:"100%",stopColor:"#0ea5e9",stopOpacity:1})]})]}),a.jsx("circle",{cx:"32",cy:"32",r:"32",fill:`url(#${r})`}),a.jsx("path",{d:"M32 16 L46 24 L32 32 L18 24 Z",fill:"#475569",opacity:"0.6"}),a.jsx("circle",{cx:"32",cy:"32",r:"10",fill:"none",stroke:`url(#${s})`,strokeWidth:"2.5"}),a.jsx("circle",{cx:"32",cy:"32",r:"6",fill:"none",stroke:`url(#${s})`,strokeWidth:"1.5"}),a.jsx("line",{x1:"32",y1:"22",x2:"32",y2:"26",stroke:"#38bdf8",strokeWidth:"2",strokeLinecap:"round"}),a.jsx("line",{x1:"32",y1:"38",x2:"32",y2:"42",stroke:"#38bdf8",strokeWidth:"2",strokeLinecap:"round"}),a.jsx("line",{x1:"22",y1:"32",x2:"26",y2:"32",stroke:"#38bdf8",strokeWidth:"2",strokeLinecap:"round"}),a.jsx("line",{x1:"38",y1:"32",x2:"42",y2:"32",stroke:"#38bdf8",strokeWidth:"2",strokeLinecap:"round"}),a.jsx("circle",{cx:"32",cy:"32",r:"2",fill:"#38bdf8"}),a.jsx("path",{d:"M8 8 L12 8 L12 12",fill:"none",stroke:"#0ea5e9",strokeWidth:"1.5",opacity:.4}),a.jsx("path",{d:"M56 8 L52 8 L52 12",fill:"none",stroke:"#0ea5e9",strokeWidth:"1.5",opacity:.4}),a.jsx("path",{d:"M8 56 L12 56 L12 52",fill:"none",stroke:"#0ea5e9",strokeWidth:"1.5",opacity:.4}),a.jsx("path",{d:"M56 56 L52 56 L52 52",fill:"none",stroke:"#0ea5e9",strokeWidth:"1.5",opacity:.4})]})},yd=(e,t,n)=>{if(e.length===0)return[t.questNone];const s=e.slice(0,n).map(i=>{const l=i.objective.count&&i.objective.count>1?` (${i.objective.currentCount??0}/${i.objective.count})`:"";return`${i.questName}: ${i.objective.description}${l}`});return e.length>n&&s.push(t.questMore),s},bd=e=>{const t=e.replace(/\s+/g," ").trim();return t.length<=140?t:`${t.slice(0,137).trimEnd()}…`},xd=(e,t)=>{const n=e.trim(),r=n.length?n:"---",s=r.toLowerCase(),i=l=>l.some(o=>s.includes(o));return i(["attack","enemy","combat","battle","damage","hostile"])?{category:"battle",label:t.battle,text:r,timestamp:Date.now()}:i(["dialog","dialogue","whispers","says","conversation","briefing","speech"])?{category:"dialog",label:t.dialog,text:r,timestamp:Date.now()}:i(["stealth","hidden","sneak","shadow","camouflage","conceal"])?{category:"stealth",label:t.stealth,text:r,timestamp:Date.now()}:{category:"broadcast",label:t.broadcast,text:r,timestamp:Date.now()}},vd=()=>{const e=P(C=>C.settings.locale),t=c.useMemo(()=>Qe(e),[e]),n=c.useMemo(()=>t.george,[t]),{feedLabels:r,levelAdvance:s,missionComplete:i,promptPlaceholder:l,askPlaceholder:o,askInputLabel:d,sendLabel:m}=n,f=P(mr),u=P(Oe),g=P(td),h=P(nd),I=P(qc),y=P(Wc),E=P(C=>!!C.settings.reputationSystemsEnabled),R=P(C=>C.quests.quests),M=P(C=>C.world),F=P(Bl),G=P(C=>C.log.messages),B=c.useMemo(()=>{var C;return(C=n.ambient)!=null&&C.length?n.ambient:pd},[n]),[A,Q]=c.useState([]),[$,de]=c.useState(""),ne=c.useRef(0),S=c.useRef(null),N=c.useRef(new Set),W=c.useRef(y),z=c.useRef({level:M.globalAlertLevel,inCombat:M.inCombat}),T=c.useRef(null),ue=c.useRef(null),Z=c.useRef(""),fe=c.useRef(G.length),Y=c.useRef(null),J=c.useRef(!1),le=c.useRef([]),me=c.useRef(null),xe=c.useCallback(()=>{if(!le.current.length){me.current=null;return}const C=le.current.shift();C&&Q(V=>{const ce=[...V,C];return ce.length>vs?ce.slice(ce.length-vs):ce}),me.current=window.setTimeout(xe,1e3)},[]),ke=c.useCallback(({category:C,label:V,text:ce,timestamp:oe})=>{const we=oe??Date.now(),ge=gd[C]??hd,Ee={id:`${we}-${Math.random().toString(36).slice(2)}`,category:C,text:bd(ce),label:V,timestamp:we,badge:ge.badge,tone:ge.tone};le.current=[...le.current,Ee],me.current===null&&xe()},[xe]),x=c.useCallback(C=>{ke(C)},[ke]),L=c.useCallback(C=>{ne.current=Date.now()+fd,S.current=null,x({category:"interjection",label:n.feedLabels.interjection,text:C.text,timestamp:Date.now()})},[n.feedLabels.interjection,x]),b=c.useCallback(C=>{const V=ad(C,I.alignment);if(!V)return;if(Date.now()>=ne.current){L(V);return}S.current=V},[I.alignment,L]),j=c.useCallback(()=>B.length&&Math.random()<.5?{text:B[Math.floor(Math.random()*B.length)],guidelineRef:"ambient.line"}:sd(I.alignment),[B,I.alignment]),w=c.useCallback(C=>{de(C.target.value)},[]),ye=c.useCallback(C=>{var we,ge;C&&C.preventDefault();const V=$.trim();if(!V){(we=Y.current)==null||we.focus();return}ke({category:"player",label:r.player,text:V,timestamp:Date.now()}),de(""),(ge=Y.current)==null||ge.focus();const ce=j(),oe=l(ce.text);ke({category:"interjection",label:r.interjection,text:oe,timestamp:Date.now()})},[ke,r.interjection,r.player,j,l,$]),he=c.useCallback(()=>{T.current!==null&&window.clearTimeout(T.current);const C=Math.floor(xs+Math.random()*(md-xs));T.current=window.setTimeout(()=>{const V=j();Date.now()>=ne.current?L(V):S.current=V,he()},C)},[j,L]);c.useEffect(()=>{const C=window.setInterval(()=>{const V=S.current;V&&Date.now()>=ne.current&&L(V)},400);return()=>window.clearInterval(C)},[L]),c.useEffect(()=>(he(),()=>{T.current!==null&&(window.clearTimeout(T.current),T.current=null),me.current!==null&&(window.clearTimeout(me.current),me.current=null),le.current=[]}),[he]),c.useEffect(()=>{if(G.length<=fe.current){fe.current=G.length;return}G.slice(fe.current).forEach(V=>{const ce=xd(V,{battle:r.battle,dialog:r.dialog,stealth:r.stealth,broadcast:r.broadcast});x(ce)}),fe.current=G.length},[r.battle,r.broadcast,r.dialog,r.stealth,G,x]),c.useEffect(()=>{const C=(u==null?void 0:u.name)??n.zoneFallback,V=[];if(u){if(u.allPrimaryComplete)V.push(n.guidancePrimaryComplete(C));else if(g){const ge=g.totalQuests>1?n.guidanceProgress(g.completedQuests??0,g.totalQuests):"";V.push(n.guidancePrimaryObjective(g.label,ge))}h&&V.push(n.guidanceSideObjective(h.label))}const ce=yd(f,n,3),oe=[n.guidanceIntro];V.length>0&&oe.push(...V),ce.length>0&&(V.length>0&&oe.push(""),oe.push(...ce));const we=oe.join(`
`).trim();!we||Z.current===we||(Z.current=we,x({category:"operation",label:r.operation,text:we,timestamp:Date.now()}))},[r.operation,n,u,g,h,f,x]);const Le=c.useCallback(C=>{if(!C)return"";try{return new Intl.DateTimeFormat(e,{hour:"2-digit",minute:"2-digit"}).format(new Date(C))}catch{return new Date(C).toLocaleTimeString()}},[e]),Ie=c.useCallback(C=>{var we;const V=n.ambientFeed,ce=I.alignment,oe=ge=>({category:"broadcast",text:ge,label:r.broadcast,timestamp:C.timestamp});switch(C.category){case"rumor":{const ge=((we=C.lines.find(Te=>Te&&Te.trim().length>0))==null?void 0:we.trim())??V.fallbacks.rumor,Ee=C.storyFunction?V.storyFunctionLabels[C.storyFunction]??C.storyFunction.replace(/-/g," ").toUpperCase():void 0;return oe(V.formatRumor({line:ge,storyLabel:Ee},ce))}case"signage":{const ge=C.text&&C.text.trim().length>0?C.text.trim():V.fallbacks.signage,Ee=C.storyFunction?V.storyFunctionLabels[C.storyFunction]??C.storyFunction.replace(/-/g," ").toUpperCase():void 0;return oe(V.formatSignage({text:ge,storyLabel:Ee},ce))}case"weather":{const ge=C.description&&C.description.trim().length>0?C.description.trim():V.fallbacks.weather,Ee=C.storyFunction?V.storyFunctionLabels[C.storyFunction]??C.storyFunction.replace(/-/g," ").toUpperCase():void 0;return oe(V.formatWeather({description:ge,storyLabel:Ee},ce))}case"zoneDanger":{const ge=t.levelIndicator.dangerLevels,Ee=C.dangerRating?ge[C.dangerRating]??C.dangerRating:V.dangerFallback,Te=C.previousDangerRating?ge[C.previousDangerRating]??C.previousDangerRating:null,gt=C.changedFlags.map(Fe=>({label:V.flagLabels[Fe.key]??Fe.key,previous:V.formatFlagValue(Fe.key,Fe.previous),next:V.formatFlagValue(Fe.key,Fe.next)}));return oe(V.formatZoneDanger({zoneName:C.zoneName,dangerLabel:Ee,previousDangerLabel:Te,flagChanges:gt},ce))}case"hazardChange":{const ge=C.added.map(Te=>Te.trim()).filter(Te=>Te.length>0),Ee=C.removed.map(Te=>Te.trim()).filter(Te=>Te.length>0);return oe(V.formatHazards({zoneName:C.zoneName,additions:ge,removals:Ee},ce))}case"zoneBrief":{const ge=t.levelIndicator.dangerLevels,Ee=C.dangerRating?ge[C.dangerRating]??C.dangerRating:V.dangerFallback;return oe(V.formatZoneBrief({zoneName:C.zoneName,summary:C.summary??null,dangerLabel:Ee,hazards:C.hazards,directives:C.directives},ce))}default:return null}},[r.broadcast,n.ambientFeed,I.alignment,t.levelIndicator.dangerLevels]);c.useEffect(()=>{const C=ce=>{const oe=ce.detail;if(!oe)return;const we=i(oe.name);x({category:"operation",label:r.operation,text:we,timestamp:Date.now()}),b("questCompleted")},V=ce=>{const oe=ce.detail;if(!oe)return;const we=oe.nextLevelId??`level ${oe.nextLevel}`,ge=s(we);x({category:"operation",label:r.operation,text:ge,timestamp:Date.now()})};return window.addEventListener(nr,C),window.addEventListener(rr,V),()=>{window.removeEventListener(nr,C),window.removeEventListener(rr,V)}},[r.operation,s,i,x,b]),c.useEffect(()=>{const C=new Set(R.filter(oe=>oe.isCompleted).map(oe=>oe.id)),V=N.current;Array.from(C).filter(oe=>!V.has(oe)).length>0&&b("questCompleted"),N.current=C},[R,b]),c.useEffect(()=>{if(!F)return;if(!ue.current){const ce=new cd;ce.prime(F),ue.current=ce;const oe={category:"zoneBrief",timestamp:Date.now(),zoneName:F.zone.zoneName,summary:F.zone.summary,dangerRating:F.zone.dangerRating??null,hazards:[...F.zone.hazards],directives:[...F.zone.directives]},we=Ie(oe);we&&x(we);return}const V=ue.current.collect(F);V.length&&V.forEach(ce=>{const oe=Ie(ce);oe&&x(oe)})},[F,Ie,x]),c.useEffect(()=>{const C=W.current,V=y;if(!E){W.current=V;return}const ce=new Set([...Object.keys(V),...Object.keys(C)]),oe=Array.from(ce).some(ge=>{const Ee=V[ge]??0,Te=C[ge]??0;return Ee-Te>=20}),we=Array.from(ce).some(ge=>{const Ee=V[ge]??0,Te=C[ge]??0;return Ee-Te<=-20});oe?b("reputationPositive"):we&&b("reputationNegative"),W.current=V},[y,b,E]),c.useEffect(()=>{const C=z.current;(!C.inCombat&&M.inCombat||C.level!=="alarmed"&&M.globalAlertLevel==="alarmed")&&b("hostileEntered"),z.current={level:M.globalAlertLevel,inCombat:M.inCombat}},[b,M.globalAlertLevel,M.inCombat]);const $e=c.useRef(null),We=c.useCallback(C=>{var V;C.preventDefault(),(V=Y.current)==null||V.focus()},[]),Ue=c.useCallback(()=>{J.current=!0},[]),Re=c.useCallback(()=>{J.current=!1},[]);c.useEffect(()=>{var V;const C=$e.current;C&&(C.scrollTo({top:C.scrollHeight,behavior:"smooth"}),J.current&&((V=Y.current)==null||V.focus()))},[A]);const ve={id:"george-placeholder",category:"status",text:n.logEmpty,label:r.broadcast,timestamp:0,badge:"NB",tone:"broadcast"},rt=A.length>0?A:[ve],Bt=A.length>0,pt=rt.length-1,Ge=$.trim().length===0;return a.jsxs("div",{className:"george-inline","data-controller-focus-ignore":"true",children:[a.jsx("div",{className:"george-chat",role:"log","aria-live":"polite",ref:$e,children:rt.map((C,V)=>{const ce=Bt&&V===pt,oe=C.timestamp?Le(C.timestamp):"";return a.jsxs("div",{className:"george-chat-entry",children:[a.jsx("div",{className:"george-chat-avatar","aria-hidden":"true",children:a.jsx(ws,{size:32})}),a.jsxs("div",{className:`george-chat-bubble george-chat-bubble--${C.tone}${ce?" george-chat-bubble--latest":""}`,children:[a.jsxs("div",{className:"george-chat-bubble__header",children:[a.jsxs("div",{className:"george-chat-bubble__title",children:[a.jsx("span",{className:`george-chat-badge george-chat-badge--${C.tone}`,"aria-hidden":"true",children:C.badge}),a.jsx("span",{className:"george-chat-bubble__label",children:C.label})]}),oe?a.jsx("span",{className:"george-chat-bubble__time",children:oe}):null]}),a.jsx("p",{className:"george-chat-bubble__text",children:C.text})]})]},C.id)})}),a.jsxs("form",{className:"george-input-row",onSubmit:ye,children:[a.jsx(ws,{size:36}),a.jsx("div",{className:"george-input",children:a.jsx("input",{id:"george-prompt-input",className:"george-input__field",type:"text",placeholder:o,"aria-label":d,value:$,onChange:w,autoComplete:"off",ref:Y,onFocus:Ue,onBlur:Re})}),a.jsx("button",{type:"submit",className:"george-send-button","data-disabled":Ge,"aria-label":m,onMouseDown:We,children:a.jsx("span",{className:"george-send-icon","aria-hidden":"true",children:"↗"})})]})]})},bn=["warmth","melancholy","sarcasm","surrealism","urgency","steadiness","wit"],wd={author:.4,persona:.4,scene:.2},tt={sentenceLengthMean:14,sentenceLengthStdDev:4,metaphorRate:.35,fragmentPreference:.2,motifDensity:.25},Ss=bn.reduce((e,t)=>(e[t]=.5,e),{});bn.reduce((e,t)=>(e[t]={type:"number",minimum:0,maximum:1},e),{});const Bn=e=>e.rhetoric?{sentenceLengthMean:e.rhetoric.sentenceLengthMean??tt.sentenceLengthMean,sentenceLengthStdDev:e.rhetoric.sentenceLengthStdDev??tt.sentenceLengthStdDev,metaphorRate:e.rhetoric.metaphorRate??tt.metaphorRate,fragmentPreference:e.rhetoric.fragmentPreference??tt.fragmentPreference,motifDensity:e.rhetoric.motifDensity??tt.motifDensity}:{...tt},Sd=e=>{let t=1779033703,n=3144134277,r=1013904242,s=2773480762;for(let i=0;i<e.length;i+=1){const l=e.charCodeAt(i);t=Math.imul(t^l,597399067),n=Math.imul(n^l,2869860233),r=Math.imul(r^l,951274213),s=Math.imul(s^l,2716044179)}return t=Math.imul(t^t>>>18,597399067),n=Math.imul(n^n>>>22,2869860233),r=Math.imul(r^r>>>17,951274213),s=Math.imul(s^s>>>19,2716044179),[t^n^r^s,n^t,r^t,s^t]},kd=e=>()=>{let t=e+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296},zt=e=>{const t=typeof e=="number"?e.toString(36):e,n=Sd(t),r=kd(n[0]),s=()=>r(),i=o=>o<=0?0:Math.floor(s()*o);return{next:s,nextInt:i,pick:o=>{if(o.length===0)throw new Error("Cannot pick from an empty list.");return o[i(o.length)]}}},Ot=(e,t,n)=>Math.min(Math.max(e,t),n),Id=(e,t)=>{const n={...wd,...e};if(!t){const s=n.author+n.persona;return s===0?{author:.5,persona:.5,scene:0}:{author:n.author/s,persona:n.persona/s,scene:0}}const r=n.author+n.persona+n.scene;return r===0?{author:.4,persona:.4,scene:.2}:{author:n.author/r,persona:n.persona/r,scene:n.scene/r}},$n=e=>e?bn.reduce((t,n)=>{var s;const r=(s=e.traits)==null?void 0:s[n];return typeof r=="number"&&!Number.isNaN(r)?t[n]=Ot(r,0,1):t[n]=Ss[n],t},{}):{...Ss},Ed=(e,t,n,r)=>bn.reduce((s,i)=>{const l=t[i]??.5,o=n[i]??.5,d=r?r[i]??.5:.5,m=l*e.author+o*e.persona+d*e.scene;return s[i]=Ot(m,0,1),s},{}),Td=(e,t,n,r)=>{const s=Bn(t),i=Bn(n),l=r?Bn(r):tt;return{sentenceLengthMean:s.sentenceLengthMean*e.author+i.sentenceLengthMean*e.persona+l.sentenceLengthMean*e.scene,sentenceLengthStdDev:s.sentenceLengthStdDev*e.author+i.sentenceLengthStdDev*e.persona+l.sentenceLengthStdDev*e.scene,metaphorRate:s.metaphorRate*e.author+i.metaphorRate*e.persona+l.metaphorRate*e.scene,fragmentPreference:s.fragmentPreference*e.author+i.fragmentPreference*e.persona+l.fragmentPreference*e.scene,motifDensity:s.motifDensity*e.author+i.motifDensity*e.persona+l.motifDensity*e.scene}},Cd=(e,t)=>{const n=[],r=tt.sentenceLengthMean+e.melancholy*4-e.urgency*5+e.surrealism*3+e.wit*1-e.sarcasm*1,s=Ot((t.sentenceLengthMean+r)/2,6,28);Math.abs(s-t.sentenceLengthMean)>.01&&(n.push({trait:"urgency",from:t.sentenceLengthMean,to:s}),t.sentenceLengthMean=s);const i=.15+e.sarcasm*.25+e.urgency*.3-e.steadiness*.2,l=Ot((t.fragmentPreference+i)/2,0,.85);Math.abs(l-t.fragmentPreference)>.01&&(n.push({trait:"sarcasm",from:t.fragmentPreference,to:l}),t.fragmentPreference=l);const o=tt.metaphorRate+e.surrealism*.4+e.melancholy*.2-e.urgency*.25,d=Ot((t.metaphorRate+o)/2,0,.9);return Math.abs(d-t.metaphorRate)>.01&&(n.push({trait:"surrealism",from:t.metaphorRate,to:d}),t.metaphorRate=d),n},Md=e=>Object.entries(e).reduce((t,[n,r])=>{const s=Math.max(0,r-1);return s>0&&(t[n]=s),t},{}),Pd=(e,t,n)=>{switch(e.type){case"requiresTrait":return!e.trait||typeof e.threshold!="number"?!0:t[e.trait]>=e.threshold;case"forbidsTrait":return!e.trait||typeof e.threshold!="number"?!0:t[e.trait]<=e.threshold;case"maxSentenceLength":return!0;case"requiresMotif":return e.motifId?(n[e.motifId]??0)>0:!0;default:return!0}},Rd=(e,t,n)=>e.requiredTraits&&Object.entries(e.requiredTraits).some(([s,i])=>t[s]<i)||e.forbiddenTraits&&Object.entries(e.forbiddenTraits).some(([s,i])=>t[s]>i)?!1:e.constraints?e.constraints.every(r=>Pd(r,t,n)):!0,Ad=(e,t,n,r)=>{var i,l;let s=1;if(e.traitWeightBoost)for(const[o,d]of Object.entries(e.traitWeightBoost))s+=(t[o]??.5)*d;return(i=n.templateBias)!=null&&i.includes(e.id)&&(s+=.75),(l=r.templateBias)!=null&&l.includes(e.id)&&(s+=.75),Math.max(s,.1)},Dd=(e,t,n,r)=>{var m,f;if(e.requestedTemplateId){const u=t.templates.find(g=>g.id===e.requestedTemplateId);if(u)return u}const s=t.templates.filter(u=>Rd(u,n,r));if(s.length===0){const u=((m=e.persona.fallbackTemplates)==null?void 0:m[0])??((f=e.author.fallbackTemplates)==null?void 0:f[0]),g=u?t.templates.find(h=>h.id===u):void 0;if(g)return g;if(t.templates.length===0)throw new Error("No dialogue tone templates defined.");return t.templates[0]}const i=zt(`${e.seed??"tone"}::template`),l=s.map(u=>({template:u,weight:Ad(u,n,e.author,e.persona)})),o=l.reduce((u,g)=>u+g.weight,0);let d=i.next()*o;for(const u of l){if(d<=u.weight)return u.template;d-=u.weight}return l[l.length-1].template},_d=(e,t)=>{const n=e.palettes.find(r=>r.id===t);if(!n)throw new Error(`Missing palette ${t} referenced by tone template.`);return n},Ld=(e,t)=>{var n;return(n=e.lexiconOverrides)==null?void 0:n[t]},jd=(e,t,n,r)=>{var i;let s=e.weight;if(e.traitInfluence)for(const[l,o]of Object.entries(e.traitInfluence))s+=(t[l]??.5)*o;if(e.motifId){const l=r[e.motifId]??0;s-=l*.35,(i=n.motifBias)!=null&&i.includes(e.motifId)&&(s+=.5)}return Math.max(s,0)},Nd=(e,t,n,r,s,i,l)=>{var I;const o=Ld(r.persona,t);if(o&&o.length>0){const y=zt(`${l}::override::${t}`),E=o[y.nextInt(o.length)];return{paletteId:e,entryId:"override",text:E}}const d=_d(s,e),m=zt(`${l}::palette::${e}`),f=d.entries.map(y=>({entry:y,weight:jd(y,n,r.persona,i)})),u=f.reduce((y,E)=>y+E.weight,0);if(u<=0){const y=d.defaultText??((I=d.entries[0])==null?void 0:I.text);if(!y)throw new Error(`Palette ${e} has no viable entries.`);return{paletteId:e,entryId:"fallback",text:y}}let g=m.next()*u;for(const{entry:y,weight:E}of f){if(g<=E)return{paletteId:e,entryId:y.id,text:y.text};g-=E}const h=f[f.length-1].entry;return{paletteId:e,entryId:h.id,text:h.text}},Od=(e,t)=>e.template.replace(/\{\{(.*?)\}\}/g,(n,r)=>{var l;const s=r.trim(),i=t[s];return i?i.text:((l=e.slots.find(o=>o.id===s))==null?void 0:l.fallback)??""}),Fd=(e,t)=>{var E;const n=Id(e.weights,!!e.scene),r=$n(e.author),s=$n(e.persona),i=e.scene?$n(e.scene):void 0,l=Ed(n,r,s,i),o=Td(n,e.author,e.persona,e.scene),d=Cd(l,o),m=Md(e.motifState??{}),f=Dd(e,t,l,m);!f.supportsFragments&&o.fragmentPreference>.55&&(d.push({trait:"steadiness",from:o.fragmentPreference,to:.45}),o.fragmentPreference=.45),f.maxSentenceLength&&o.sentenceLengthMean>f.maxSentenceLength&&(d.push({trait:"steadiness",from:o.sentenceLengthMean,to:f.maxSentenceLength}),o.sentenceLengthMean=f.maxSentenceLength);const u={...m},g=f.slots.reduce((R,M)=>{var A;const F=Nd(M.paletteId,M.id,l,e,t,u,e.seed??"tone");R[M.id]=F;const G=(A=t.palettes.find(Q=>Q.id===M.paletteId))==null?void 0:A.entries.find(Q=>Q.id===F.entryId),B=G==null?void 0:G.motifId;return B&&(u[B]=(u[B]??0)+2),R},{}),h=Od(f,g),I=e.motifState??{},y={templateId:f.id,text:h,slots:g,motifsApplied:Object.keys(u).filter(R=>(u[R]??0)>(I[R]??0))};return{traits:l,rhetoric:o,weights:n,clampLog:d,render:y,motifState:u,seed:e.seed??"tone",metadata:{authorId:e.author.id,personaId:e.persona.id,sceneId:(E=e.scene)==null?void 0:E.id,templateId:f.id}}},sr={id:"author.vonnegut_brautigan_core",label:"Vonnegut-Brautigan Core Voice",influences:["plot.tone.guideline.1","plot.tone.guideline.2","plot.tone.guideline.7"],traits:{wit:.75,melancholy:.6,surrealism:.68,sarcasm:.55,warmth:.52,urgency:.48,steadiness:.5},rhetoric:{sentenceLengthMean:18,sentenceLengthStdDev:5,metaphorRate:.48,fragmentPreference:.22},templateBias:["template.deadpan.reassure","template.surreal.resilience"],fallbackTemplates:["template.deadpan.reassure"]},ks={id:"author.propaganda_glitch",label:"Glitched Broadcast Satire",influences:["plot.tone.guideline.4","plot.tone.guideline.2"],traits:{wit:.55,melancholy:.35,surrealism:.5,sarcasm:.7,warmth:.32,urgency:.6,steadiness:.44},rhetoric:{sentenceLengthMean:14,sentenceLengthStdDev:3,metaphorRate:.28,fragmentPreference:.32},templateBias:["template.urgent.push"],fallbackTemplates:["template.urgent.push"]},ar={[sr.id]:sr,[ks.id]:ks},Wa=sr.id,Ua=e=>ar[e]??ar[Wa],ir={id:"persona.trace",label:"Trace (Player)",personaTags:["player","resistance"],traits:{wit:.65,warmth:.54,urgency:.62,steadiness:.4,sarcasm:.58,melancholy:.47,surrealism:.44},rhetoric:{sentenceLengthMean:14,sentenceLengthStdDev:4,fragmentPreference:.28},motifBias:["motif.streetlight","motif.rain_hum"],templateBias:["template.urgent.push","template.deadpan.reassure"],lexiconOverrides:{directive:["Keep moving like the cameras forgot you.","Drift along the blackout fringe—quiet shoes, loud mission."]}},Is={id:"persona.amara_velez",label:"Amara Velez",personaTags:["mentor","resistance"],traits:{wit:.52,warmth:.66,urgency:.48,steadiness:.68,sarcasm:.38,melancholy:.55,surrealism:.42},rhetoric:{sentenceLengthMean:17,sentenceLengthStdDev:3,fragmentPreference:.18},motifBias:["motif.compass","motif.streetlight"],templateBias:["template.deadpan.reassure","template.surreal.resilience"],lexiconOverrides:{comfort:["Breathe—we’ve lived through harsher tides.","You held the line; I’ll hold the fallout."]}},Es={id:"persona.theo_anders",label:"Theo Anders",personaTags:["hacker","ally"],traits:{wit:.7,warmth:.5,urgency:.57,steadiness:.38,sarcasm:.64,melancholy:.42,surrealism:.58},rhetoric:{sentenceLengthMean:13,sentenceLengthStdDev:5,fragmentPreference:.36},motifBias:["motif.glowsticks","motif.rain_hum"],templateBias:["template.urgent.push"],lexiconOverrides:{opener:["Signal’s noisy but alive.","Console’s humming like a nervous choir."]}},Ts={id:"persona.sadiq_rahm",label:"Sadiq Rahm",personaTags:["strategist","ally"],traits:{wit:.48,warmth:.4,urgency:.52,steadiness:.6,sarcasm:.46,melancholy:.58,surrealism:.36},rhetoric:{sentenceLengthMean:16,sentenceLengthStdDev:3,fragmentPreference:.22},motifBias:["motif.compass"],templateBias:["template.deadpan.reassure"],lexiconOverrides:{promise:["We bank this win, re-draw the map, hit harder tomorrow.","Blueprints shift in our favour; we keep walking."]}},or={[ir.id]:ir,[Is.id]:Is,[Es.id]:Es,[Ts.id]:Ts},Ga=ir.id,Va=e=>or[e]??or[Ga],Cs={id:"scene.share_scarce_food",label:"Share Scarce Food",intent:"break bread after a risky supply run",traits:{warmth:.72,melancholy:.58,wit:.46,surrealism:.42,sarcasm:.3,urgency:.28,steadiness:.64},rhetoric:{sentenceLengthMean:17,metaphorRate:.38}},Ms={id:"scene.post_ambush_reassurance",label:"Post-Ambush Reassurance",intent:"steady the squad after scraping through an ambush",traits:{warmth:.62,melancholy:.55,wit:.4,surrealism:.37,sarcasm:.34,urgency:.46,steadiness:.68},rhetoric:{sentenceLengthMean:16,fragmentPreference:.2}},Ps={id:"scene.pre_heist_briefing",label:"Pre-Heist Briefing",intent:"sharpen focus during mission prep",traits:{warmth:.38,melancholy:.32,wit:.5,surrealism:.28,sarcasm:.52,urgency:.72,steadiness:.58},rhetoric:{sentenceLengthMean:14,fragmentPreference:.26}},Rs={id:"scene.radio_counter_speech",label:"Counter-Broadcast Speech",intent:"mock the regime broadcast while rallying allies",traits:{warmth:.44,melancholy:.36,wit:.68,surrealism:.5,sarcasm:.74,urgency:.6,steadiness:.46},rhetoric:{sentenceLengthMean:15,sentenceLengthStdDev:4,fragmentPreference:.34}},qa={[Cs.id]:Cs,[Ms.id]:Ms,[Ps.id]:Ps,[Rs.id]:Rs},zd=e=>qa[e],Hd=[{id:"template.deadpan.reassure",label:"Deadpan Reassurance",template:"{{opener}} {{comfort}} {{promise}}",supportsFragments:!1,maxSentenceLength:22,requiredTraits:{warmth:.4,steadiness:.45},traitWeightBoost:{warmth:.6,steadiness:.3,wit:.2},slots:[{id:"opener",paletteId:"palette.opener.deadpan"},{id:"comfort",paletteId:"palette.comfort.solidarity"},{id:"promise",paletteId:"palette.promise.grit"}]},{id:"template.urgent.push",label:"Urgent Push",template:"{{urgent_intro}} {{directive}}",supportsFragments:!0,maxSentenceLength:18,requiredTraits:{urgency:.55},forbiddenTraits:{warmth:.85},traitWeightBoost:{urgency:.8,wit:.2,sarcasm:.3},slots:[{id:"urgent_intro",paletteId:"palette.urgent.intro",allowFragments:!0},{id:"directive",paletteId:"palette.directive.push",allowFragments:!0}]},{id:"template.surreal.resilience",label:"Surreal Resilience",template:"{{opener}} {{surreal_image}} {{resolution}}",supportsFragments:!1,maxSentenceLength:24,requiredTraits:{surrealism:.45},traitWeightBoost:{surrealism:.9,melancholy:.4,wit:.25},slots:[{id:"opener",paletteId:"palette.opener.deadpan"},{id:"surreal_image",paletteId:"palette.surreal.image"},{id:"resolution",paletteId:"palette.resolution.resilience"}]}],Bd=[{id:"palette.opener.deadpan",slotId:"opener",defaultText:"Streetlight holds.",entries:[{id:"opener.streetlight",text:"Streetlight holds.",weight:1,traitInfluence:{steadiness:.4,warmth:.2},motifId:"motif.streetlight"},{id:"opener.ashtray",text:"Ashtray smoke braids the curfew alarm.",weight:.8,traitInfluence:{melancholy:.3,surrealism:.4},motifId:"motif.rain_hum"},{id:"opener.static",text:"Static licks the PA like a bored coyote.",weight:.9,traitInfluence:{wit:.3,sarcasm:.35}}]},{id:"palette.comfort.solidarity",slotId:"comfort",defaultText:"We bend so we do not break.",entries:[{id:"comfort.breathe",text:"Breathe; the city hums but our pulse sets tempo.",weight:1,traitInfluence:{warmth:.35,steadiness:.35}},{id:"comfort.hum",text:"We hum louder than their drones tonight.",weight:.9,traitInfluence:{wit:.25,urgency:.2},motifId:"motif.rain_hum"},{id:"comfort.coffee",text:"Ration coffee still tastes like defiance.",weight:.8,traitInfluence:{wit:.3,warmth:.3}}]},{id:"palette.promise.grit",slotId:"promise",defaultText:"We bank this and push the next door.",entries:[{id:"promise.grid",text:"Map updates in our favour; we move before dawn.",weight:1,traitInfluence:{urgency:.35,steadiness:.4},motifId:"motif.compass"},{id:"promise.neon",text:"Neon farms glow for us tonight if we choose.",weight:.85,traitInfluence:{surrealism:.4,warmth:.25}},{id:"promise.ledger",text:"Ledger tilts our way; we cash it in soon.",weight:.9,traitInfluence:{wit:.2,melancholy:.2}}]},{id:"palette.urgent.intro",slotId:"urgent_intro",defaultText:"Sirens kick a four count.",entries:[{id:"urgent.metro",text:"Metro lights stutter; sweepers reroute.",weight:1,traitInfluence:{urgency:.45,surrealism:.25},motifId:"motif.glowsticks"},{id:"urgent.chopper",text:"Chopper rotors chew the humidity early.",weight:.9,traitInfluence:{urgency:.4,sarcasm:.3}},{id:"urgent.clocks",text:"Every stolen clock ticks loud right now.",weight:.85,traitInfluence:{melancholy:.25,wit:.3}}]},{id:"palette.directive.push",slotId:"directive",defaultText:"Push past the surveillance bloom.",entries:[{id:"directive.sprint",text:"Sprint the blackout seam before it seals.",weight:1,traitInfluence:{urgency:.5,wit:.2}},{id:"directive.slide",text:"Slide between floodlights like you rehearsed it.",weight:.9,traitInfluence:{steadiness:.2,wit:.35},motifId:"motif.glowsticks"},{id:"directive.smile",text:"Smile like the scanners owe you rent.",weight:.75,traitInfluence:{sarcasm:.45}}]},{id:"palette.surreal.image",slotId:"surreal_image",defaultText:"Drones drift like bored gulls.",entries:[{id:"surreal.malls",text:"Flooded malls grow neon algae halos.",weight:1,traitInfluence:{surrealism:.55,melancholy:.25},motifId:"motif.rain_hum"},{id:"surreal.balloons",text:"Propaganda balloons sag like tired saints.",weight:.9,traitInfluence:{sarcasm:.3,wit:.25}},{id:"surreal.kites",text:"Kids fly hacked drones like paper kites.",weight:.85,traitInfluence:{warmth:.3,wit:.3}}]},{id:"palette.resolution.resilience",slotId:"resolution",defaultText:"We walk out together and louder.",entries:[{id:"resolution.compass",text:"Compass north re-centers on us tonight.",weight:1,traitInfluence:{steadiness:.45,warmth:.3},motifId:"motif.compass"},{id:"resolution.lunch",text:"Save me a ration bar; we earned dessert.",weight:.8,traitInfluence:{wit:.35,warmth:.25}},{id:"resolution.rain",text:"Let the rain mask our getaway beats.",weight:.85,traitInfluence:{melancholy:.3,surrealism:.3},motifId:"motif.rain_hum"}]}],$d=()=>({authors:ar,personas:or,scenes:qa,templates:Hd,palettes:Bd,motifDefaults:{"motif.streetlight":0,"motif.rain_hum":0,"motif.compass":0,"motif.glowsticks":0}}),Wd=()=>Ua(Wa),Ud=()=>Va(Ga),Gd=e=>zd(e),Vd=(e,t)=>e?t?{...e,...t}:e:t,qd=(e,t,n,r,s)=>`${e}::persona:${t}::author:${n}::scene:${r??"none"}::template:${s??"any"}`,Kd=(e,t)=>e?{...e}:t.motifDefaults?{...t.motifDefaults}:{},Yd=(e,t,n,r)=>{const s=(n==null?void 0:n.seedKey)??r??"default";return`${e.id}:${t.id}:${s}`},Xd=(e,t)=>{var n;if(t!=null&&t.personaId)return t.personaId;if((n=e.toneDefaults)!=null&&n.personaId)return e.toneDefaults.personaId};class Qd{constructor(){je(this,"library");je(this,"motifStates");je(this,"cache");je(this,"defaultAuthor",Wd());je(this,"defaultPersona",Ud());je(this,"resolvePersona",t=>t?Va(t):this.defaultPersona);je(this,"resolveShouldGenerate",t=>(t==null?void 0:t.useGenerated)!==!1);je(this,"reset",()=>{this.cache.clear(),this.motifStates.clear()});je(this,"resetDialogue",t=>{for(const n of this.cache.keys())n.startsWith(`${t}:`)&&this.cache.delete(n)});je(this,"resolveLine",t=>{const{dialogue:n,node:r,fallbackText:s,seedOverride:i}=t,l=Vd(n.toneDefaults,r.tone);if(!l||!this.resolveShouldGenerate(l))return{text:s,source:"fallback"};const o=l.authorId?Ua(l.authorId):this.defaultAuthor,d=this.resolvePersona(Xd(n,l)),m=l.sceneId?Gd(l.sceneId):void 0,f=Yd(n,r,l,i),u=qd(f,d.id,o.id,m==null?void 0:m.id,l.templateId),g=this.cache.get(u);if(g)return{text:g.render.text,source:"generated",metadata:g};const h=Kd(this.motifStates.get(d.id),this.library),I=Fd({author:o,persona:d,scene:m,requestedTemplateId:l.templateId,seed:f,motifState:h},this.library);return this.cache.set(u,I),this.motifStates.set(d.id,I.motifState),{text:I.render.text,source:"generated",metadata:I}});this.library=$d(),this.motifStates=new Map,this.cache=new Map}}const Zd=new Qd,Jd=e=>{if(!e)return"?";const t=e.split(/[\s-]+/).map(n=>n.trim()).filter(Boolean);return t.length===0?"?":t.length===1?t[0].slice(0,2).toUpperCase():`${t[0][0]??""}${t[1][0]??""}`.toUpperCase()},As={lira_smuggler:{id:"lira_smuggler",initials:"LS",accentHex:"#f97316",gradientFromHex:"#7c2d12",gradientToHex:"#fb923c",imagePath:"/portraits/level0/lira_smuggler.svg"},archivist_naila:{id:"archivist_naila",initials:"AN",accentHex:"#38bdf8",gradientFromHex:"#0f172a",gradientToHex:"#0ea5e9",imagePath:"/portraits/level0/archivist_naila.svg"},courier_brant:{id:"courier_brant",initials:"CB",accentHex:"#22d3ee",gradientFromHex:"#0f172a",gradientToHex:"#14b8a6",imagePath:"/portraits/level0/courier_brant.svg"},firebrand_juno:{id:"firebrand_juno",initials:"FJ",accentHex:"#f43f5e",gradientFromHex:"#431407",gradientToHex:"#ef4444",imagePath:"/portraits/level0/firebrand_juno.svg"},seraph_warden:{id:"seraph_warden",initials:"SW",accentHex:"#93c5fd",gradientFromHex:"#1e293b",gradientToHex:"#3b82f6",imagePath:"/portraits/level0/seraph_warden.svg"},drone_handler_kesh:{id:"drone_handler_kesh",initials:"DK",accentHex:"#c084fc",gradientFromHex:"#312e81",gradientToHex:"#9333ea",imagePath:"/portraits/level0/drone_handler_kesh.svg"},medic_yara:{id:"medic_yara",initials:"MY",accentHex:"#4ade80",gradientFromHex:"#14532d",gradientToHex:"#16a34a",imagePath:"/portraits/level0/medic_yara.svg"},captain_reyna:{id:"captain_reyna",initials:"CR",accentHex:"#facc15",gradientFromHex:"#713f12",gradientToHex:"#f59e0b",imagePath:"/portraits/level0/captain_reyna.svg"}},eu={accentHex:"#94a3b8",gradientFromHex:"#0f172a",gradientToHex:"#334155"},tu=(e,t)=>e&&As[e]?As[e]:{id:e??"portrait_fallback",initials:Jd(t),...eu},nu=(e,t)=>{try{const n=to(e);return t==="charisma"?n.dialogueThresholdBonus:0}catch(n){console.warn("[DialogueSystem] Falling back to base stats for dialogue bonus.",n);const r=no(e.skills);return t==="charisma"?r.dialogueThresholdBonus:0}},ru=e=>{var t;return((t=e.skillCheck)==null?void 0:t.visibility)??"locked"},su=e=>{var t;return((t=e.factionRequirement)==null?void 0:t.visibility)??"locked"},au=(e,t)=>{if(!t.skillCheck)return null;const{skill:n,threshold:r,domain:s}=t.skillCheck,i=s??"attribute",l=ru(t);if(i==="skill"){const u=n,g=e.skillTraining[u]??0;return{isPassed:g>=r,currentValue:g,requiredValue:r,visibility:l,domain:i}}const o=n,d=e.skills[o],m=nu(e,o),f=d+m;return{isPassed:eo(d,r,m),currentValue:f,requiredValue:r,visibility:l,domain:i}},iu=(e,t,n=!0)=>{var g;if(!n||!t.factionRequirement)return null;const{factionId:r,minimumStanding:s,maximumStanding:i,minimumReputation:l,maximumReputation:o}=t.factionRequirement,d=((g=e.factionReputation)==null?void 0:g[r])??0,m=gn(d).id,f=su(t);let u;if(typeof l=="number"&&d<l&&(u="minimumReputation"),!u&&typeof o=="number"&&d>o&&(u="maximumReputation"),!u&&s){const h=Ye(m),I=Ye(s);h<I&&(u="minimumStanding")}if(!u&&i){const h=Ye(m),I=Ye(i);h>I&&(u="maximumStanding")}return{isPassed:!u,visibility:f,factionId:r,currentReputation:d,currentStanding:m,minimumStanding:s,maximumStanding:i,minimumReputation:l,maximumReputation:o,failedRequirement:u}},Wn={blackout:["blackout","brownout"],smog:["smog","toxic","fumes"],surveillance:["surveillance","camera","drone"]},Ds=["ration bricks","filtered water packs","reactive dampeners","silenced carbines","patch kits"],_s=["battery bricks","jury-rigged lanterns","hand-crank dynamos"],Ls=["homemade filters","charcoal respirators","sealed goggles"],js=["signal scrubbers","anti-drone flares","masking foil"],Ns=["Keep your head down; CorpSec doubled patrol rotations.","George whispered about a convoy slipping through the south gate tonight.","If you see a checkpoint scanner, go around—no one’s calibrating them right now.","Word is the resistance safehouse stashed contraband in the hollow neon signs."],ou=[{id:"merchant.default_greeting.resistanceFriend",roleId:"merchant",templateKey:"default_greeting",summary:"Warm greeting for resistance-aligned players during regular hours.",content:"Signal's clean for you. {{highlightItem}} just landed—priced for family. {{rumorHook}}",fallbackContent:"Welcome back. Supplies are stocked.",gating:{faction:[{factionId:"resistance",minimumReputation:25}],forbiddenTimesOfDay:["night"]},tokens:[{id:"highlightItem",fallback:"Ration bricks",resolve:(e,t)=>{const n=e.world.hazards.join(" ").toLowerCase();return Wn.blackout.some(r=>n.includes(r))?t.pickOne(_s,_s[0]):Wn.smog.some(r=>n.includes(r))?t.pickOne(Ls,Ls[0]):Wn.surveillance.some(r=>n.includes(r))?t.pickOne(js,js[0]):t.pickOne(Ds,Ds[0])}},{id:"rumorHook",fallback:"Stay nimble out there.",resolve:(e,t)=>t.pickOne(Ns,Ns[0])}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.amara_velez",useGenerated:!0},weight:3},{id:"merchant.default_greeting.curfewUrgent",roleId:"merchant",templateKey:"default_greeting",summary:"Curt greeting while curfew is active.",content:"Curfew sirens already spun up. {{highlightItem}} on the counter—take it and bolt.",fallbackContent:"Curfew's live. Make it quick.",gating:{requireCurfewActive:!0},tokens:[{id:"highlightItem",fallback:"Emergency stim kit",resolve:(e,t)=>e.player.perks.includes("quickDraw")?"reflex chems—your speed deserves it":e.player.perks.includes("toughness")?"impact gel armor—fits right onto your plates":t.pickOne(["emergency stim kit","flashburst grenade","thermal cloak"],"emergency stim kit")}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"merchant.default_greeting.corpsecWatcher",roleId:"merchant",templateKey:"default_greeting",summary:"Wary exchange when player reputation is low with CorpSec.",content:"CorpSec sniffers are wired to sniffing you. Credits up front, {{highlightItem}} after.",fallbackContent:"No trust, no chatter—show credits.",gating:{faction:[{factionId:"corpsec",maximumReputation:-10}]},tokens:[{id:"highlightItem",fallback:"scrambler chip",resolve:(e,t)=>t.pickOne(["scrambler chip","masking foil strip","signal foam"],"scrambler chip")}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"merchant.default_greeting.genericFallback",roleId:"merchant",templateKey:"default_greeting",summary:"Default line when no other gating applies.",content:"Stock's thin but serviceable. {{highlightItem}} still on the shelves.",fallbackContent:"Limited stock today.",tokens:[{id:"highlightItem",fallback:"standard issue kits",resolve:(e,t)=>t.pickOne(["standard issue kits","bulk rations","basic medpacks"],"basic medpacks")}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},weight:1,isFallback:!0}],Os=["Keep your papers visible and your hands where the drones can see them.","If you spot a rebel courier, flag Ops immediately.","Curfew level's rising—movement passes expire at sundown.","Checkpoint scanners lag two beats; don't test them."],Fs=["Orders say we hit siege level if one more rumor spikes.","CorpSec command wants names; don't make me drag you in.","We're one alert away from full lockdown."],lu=[{id:"checkpoint_guard.default_greeting.standard",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Baseline checkpoint greeting with procedural warning.",content:"Checkpoint Delta online. {{instructionHook}}",fallbackContent:"Checkpoint active. Move along.",tokens:[{id:"instructionHook",fallback:"Stay within curfew limits.",resolve:(e,t)=>t.pickOne(Os,Os[0])}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"checkpoint_guard.default_greeting.highAlert",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Escalated warning when curfew level is high.",content:"Alert tier is {{alertTier}}. Any resistance contact gets you cuffed.",fallbackContent:"High alert. Don't test me.",gating:{environment:[{flag:"curfewLevel",minimumNumeric:2}]},tokens:[{id:"alertTier",fallback:"escalating",resolve:e=>e.world.environmentFlags.curfewLevel>=3?"siege":"escalating"}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},weight:3},{id:"checkpoint_guard.default_greeting.blackout",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Warning when blackout tier is active.",content:"Power grid's unstable; blackout tier {{blackoutTier}}. Expect spot checks.",fallbackContent:"Power grid's shaky. Expect spot checks.",gating:{environment:[{flag:"blackoutTier",allowed:["brownout","rolling"]}]},tokens:[{id:"blackoutTier",fallback:"brownout",resolve:e=>e.world.environmentFlags.blackoutTier}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"checkpoint_guard.default_greeting.crackdown",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Threatening line for hostile resistance reputation.",content:"Your face is flagged on half the scanners in this grid. {{warning}}",fallbackContent:"I've got eyes on you.",gating:{faction:[{factionId:"resistance",maximumReputation:-10}]},tokens:[{id:"warning",fallback:"Step out of line and I'm calling it in.",resolve:(e,t)=>t.pickOne(Fs,Fs[0])}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"checkpoint_guard.default_greeting.nightShift",roleId:"checkpoint_guard",templateKey:"default_greeting",summary:"Night-time variant referencing curfew sweeps.",content:"Night shift sweep in progress. Curfew papers or back to shelter.",fallbackContent:"Curfew papers or move.",gating:{allowedTimesOfDay:["night"]},toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},isFallback:!0}],zs=["Keep wounds sealed; alley dust is lethal.","Rotating sutures hourly keeps CorpSec toxins from setting in.","Swap filters every hour—mutation spores love stagnant air.","Use the city's steam vents to sterilise gear if the clinic is compromised."],Hs=["Don't stack stim packs unless you want your heart to stage a protest.","Hydrate with electrolytes after each stim; trust me, you need them.","If the stim crash hits, sleep it off. No negotiation."],cu=[{id:"street_doc.default_greeting.resistanceAlly",roleId:"street_doc",templateKey:"default_greeting",summary:"Compassionate line for resistance allies.",content:"Clinic's running hot, but I carved out a cot for you. {{advice}}",fallbackContent:"Clinic's open for resistance blood.",gating:{faction:[{factionId:"resistance",minimumStanding:"friendly"}],forbiddenTimesOfDay:["night"]},tokens:[{id:"advice",fallback:"Stay hydrated and bandage often.",resolve:(e,t)=>t.pickOne(zs,zs[0])}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.amara_velez",useGenerated:!0},weight:2},{id:"street_doc.default_greeting.stimWarning",roleId:"street_doc",templateKey:"default_greeting",summary:"Warns players who lean on adrenaline perks.",content:"Saw your vitals spike mid-field. {{stimulantNote}}",fallbackContent:"Your vitals scream stim abuse.",gating:{forbiddenTimesOfDay:["morning"]},tokens:[{id:"stimulantNote",fallback:"Dial down the stim packs or you'll pancake.",resolve:(e,t)=>e.player.perks.includes("adrenalineRush")?t.pickOne(Hs,Hs[0]):"Your heart rate needs calm, not more gunfire."}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.amara_velez",useGenerated:!0}},{id:"street_doc.default_greeting.hazardClinic",roleId:"street_doc",templateKey:"default_greeting",summary:"Environmental note when hazardous clouds are active.",content:"Smog's thick tonight. I packed spare filters and anti-rad chems.",fallbackContent:"Air's poison. Use the filters.",gating:{requiredHazardKeywords:["smog","toxic","radiation"]},toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"street_doc.default_greeting.overrun",roleId:"street_doc",templateKey:"default_greeting",summary:"Terse line when curfew is active.",content:"I'm triaging patrol victims on the floor. Sit, bleed, talk later.",fallbackContent:"Busy. Sit and wait.",gating:{requireCurfewActive:!0},toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"street_doc.default_greeting.defaultFallback",roleId:"street_doc",templateKey:"default_greeting",summary:"General-purpose greeting.",content:"Slide onto the stool. Tools are clean; I made sure.",fallbackContent:"Seat's open. Let's patch you.",toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},isFallback:!0}],Bs=["CorpSec squads shifted to the mag-line every half hour.","Drone lattice thins out near the collapsed tram. Use it.","Rumor says resistance cracked the western floodgate. Check it tonight.","The scavengers set a new killbox under the viaduct. Don't stray."],$s=["Step wrong and I tip off the enforcers.","You smell like CorpSec. Two words: back off.","My crew has eyes everywhere. Try nothing."],du=[{id:"gang_scout.default_greeting.friendly",roleId:"gang_scout",templateKey:"default_greeting",summary:"Alliance tone when player reputation with scavengers is high.",content:"Scav nets flagged you green. {{intel}}",fallbackContent:"You're clear with the crew.",gating:{faction:[{factionId:"scavengers",minimumReputation:10}]},tokens:[{id:"intel",fallback:"Stick to the alleys; corp eyes are thick tonight.",resolve:(e,t)=>t.pickOne(Bs,Bs[0])}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"gang_scout.default_greeting.hostile",roleId:"gang_scout",templateKey:"default_greeting",summary:"Threatening line when player reputation is poor.",content:"Crew tagged you as trouble. {{warning}}",fallbackContent:"Crew doesn't trust you.",gating:{faction:[{factionId:"scavengers",maximumReputation:-5}]},tokens:[{id:"warning",fallback:"You move, we respond.",resolve:(e,t)=>t.pickOne($s,$s[0])}],toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0},weight:2},{id:"gang_scout.default_greeting.blackoutRecon",roleId:"gang_scout",templateKey:"default_greeting",summary:"Intel drop during blackout scenarios.",content:"Blackout's blanketing the grid. Use it to ghost past scanners.",fallbackContent:"Blackout cover tonight. Move quiet.",gating:{environment:[{flag:"blackoutTier",allowed:["brownout","rolling"]}]},toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0}},{id:"gang_scout.default_greeting.nightWatch",roleId:"gang_scout",templateKey:"default_greeting",summary:"Night-only greeting referencing curfew sweeps.",content:"Night patrol spotted a CorpSec sweeper moving east. Stay in the shadows.",fallbackContent:"Night sweeps inbound. Stay sharp.",gating:{allowedTimesOfDay:["night"]},toneOverrides:{templateId:"template.urgent.push",personaId:"persona.trace",useGenerated:!0}},{id:"gang_scout.default_greeting.fallback",roleId:"gang_scout",templateKey:"default_greeting",summary:"General-purpose line.",content:"Eyes are open. Feed me intel if you want safe passage.",fallbackContent:"Watch your angles out there.",toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},isFallback:!0}],Ws=["Bunks are sanitised—don't bleed on them.","We rotate guard shifts every twenty minutes; slot in if you can.","Leave broken gear on the workbench; the techs are patching it nightly."],Us=["Food stores run dry in two days unless the next convoy lands.","Filters arrive at dawn—ration what you have left.","Ammo press needs parts; scavenge springs if you spot any."],uu=[{id:"safehouse_handler.default_greeting.welcome",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Warm welcome when the player returns to a safehouse.",content:"Safehouse doors are sealed. {{restNote}}",fallbackContent:"Safehouse secured. Rest while you can.",tokens:[{id:"restNote",fallback:"Grab a bunk and breathe.",resolve:(e,t)=>t.pickOne(Ws,Ws[0])}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.amara_velez",useGenerated:!0},weight:2},{id:"safehouse_handler.default_greeting.lowSupplies",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Warns about low supplies when scarcity flag is high.",content:"Pantry's thin—{{supplyNote}}",fallbackContent:"Supplies low. Make your run count.",gating:{environment:[{flag:"supplyScarcity",allowed:["tight","rationed"]}]},tokens:[{id:"supplyNote",fallback:"stretch your rations.",resolve:(e,t)=>t.pickOne(Us,Us[0])}],toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0}},{id:"safehouse_handler.default_greeting.hazardShelter",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Highlights shelter when hazards are active outside.",content:"Outside's a killbox tonight. Trade routes stay closed until daybreak.",fallbackContent:"Outside is lethal right now. Stay in.",gating:{requiredHazardKeywords:["smog","radiation","patrol"]},toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0}},{id:"safehouse_handler.default_greeting.curfewShelter",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Curfew-specific shelter reminder.",content:"Curfew alarms are peaking. Lock-in lasts until morning.",fallbackContent:"Curfew locked. Sit tight.",gating:{requireCurfewActive:!0},toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0}},{id:"safehouse_handler.default_greeting.fallback",roleId:"safehouse_handler",templateKey:"default_greeting",summary:"Default handler line.",content:"We keep the lights dim and the exits mapped. Rest easy.",fallbackContent:"Safehouse steady.",toneOverrides:{templateId:"template.deadpan.reassure",personaId:"persona.trace",useGenerated:!0},isFallback:!0}],fu=[...ou,...lu,...cu,...du,...uu],mu=fu.reduce((e,t)=>(e[t.roleId]||(e[t.roleId]=[]),e[t.roleId].push(t),e),{}),Gs=1,pu=(e,t)=>{const n=t[e.flag];return!(e.allowed&&e.allowed.length>0&&!e.allowed.includes(n)||e.forbidden&&e.forbidden.includes(n)||typeof n=="number"&&(typeof e.minimumNumeric=="number"&&n<e.minimumNumeric||typeof e.maximumNumeric=="number"&&n>e.maximumNumeric))},gu=(e,t,n)=>{try{const r=e.resolve(t,n);return n.ensure(r,e.fallback)}catch(r){return console.warn("[RoleTemplateResolver] Token resolver failed",e.id,r),e.fallback}},hu=(e,t,n)=>{if(!e.tokens||e.tokens.length===0)return{};const r=zt(`${n}::${e.id}::tokens`),s={rng:()=>r.next(),pickOne:(i,l)=>!i||i.length===0?l:i[r.nextInt(i.length)],ensure:(i,l)=>i&&i.trim().length>0?i:l};return e.tokens.reduce((i,l)=>(i[l.id]=gu(l,t,s),i),{})},Vs=(e,t)=>e?e.replace(/{{\s*([\w.]+)\s*}}/g,(n,r)=>{const s=t[r];return typeof s=="string"&&s.length>0?s:n}):"",yu=(e,t,n)=>!(t&&t.some(r=>!e.includes(r))||n&&n.some(r=>e.includes(r))),bu=(e,t)=>e.reputationSystemsEnabled===!1||!t||t.length===0?!0:t.every(n=>{var i;const r=((i=e.player.factionReputation)==null?void 0:i[n.factionId])??0;if(typeof n.minimumReputation=="number"&&r<n.minimumReputation||typeof n.maximumReputation=="number"&&r>n.maximumReputation)return!1;const s=gn(r);if(n.minimumStanding){const l=Ye(s.id),o=Ye(n.minimumStanding);if(l<o)return!1}if(n.maximumStanding){const l=Ye(s.id),o=Ye(n.maximumStanding);if(l>o)return!1}return!0}),xu=(e,t,n)=>!(t&&t.length>0&&!t.every(s=>e.some(i=>i.toLowerCase().includes(s.toLowerCase())))||n&&n.length>0&&n.some(s=>e.some(i=>i.toLowerCase().includes(s.toLowerCase())))),vu=(e,t)=>{const n=e.gating;if(!n)return!0;const{world:r,player:s,npc:i}=t;if(!bu(t,n.faction)||!yu(s.perks??[],n.requiresPerkIds,n.forbiddenPerkIds)||n.allowedTimesOfDay&&n.allowedTimesOfDay.length>0&&!n.allowedTimesOfDay.includes(r.timeOfDay)||n.forbiddenTimesOfDay&&n.forbiddenTimesOfDay.includes(r.timeOfDay)||typeof n.requireCurfewActive=="boolean"&&n.requireCurfewActive!==r.curfewActive||typeof n.forbidCurfewActive=="boolean"&&n.forbidCurfewActive===r.curfewActive||!xu(r.hazards??[],n.requiredHazardKeywords,n.forbiddenHazardKeywords)||n.environment&&n.environment.length>0&&!n.environment.every(o=>pu(o,r.environmentFlags)))return!1;if(n.requiredNpcTags&&n.requiredNpcTags.length>0){const l=(i==null?void 0:i.tags)??[];if(!n.requiredNpcTags.every(d=>l.includes(d)))return!1}if(n.forbiddenNpcTags&&n.forbiddenNpcTags.length>0){const l=(i==null?void 0:i.tags)??[];if(n.forbiddenNpcTags.some(o=>l.includes(o)))return!1}return!(n.requiredZoneIds&&n.requiredZoneIds.length>0&&!n.requiredZoneIds.includes(r.zoneId))},wu=(e,t)=>{if(!e.length)return null;if(e.length===1)return e[0];const n=zt(`${t}::templatePick`),r=e.reduce((i,l)=>i+(l.weight??Gs),0);let s=n.next()*r;for(const i of e)if(s-=i.weight??Gs,s<=0)return i;return e[n.nextInt(e.length)]},Su=(e,t)=>{const n=mu[e];return n?n.filter(r=>r.templateKey===t):[]},ku=e=>{const{roleId:t,templateKey:n,context:r}=e,s=Su(t,n);if(s.length===0)return console.warn("[RoleTemplateResolver] Missing templates for role",t,"template",n),null;const i=s.filter(h=>vu(h,r)),l=i.length>0?i:s.filter(h=>h.isFallback)||s,o=e.seedOverride??r.randomSeed??`${t}:${n}`,d=wu(l,o)??l[0],m=`${o}::${d.seedHint??d.id}`,f=hu(d,r,m),u=Vs(d.content,f),g=Vs(d.fallbackContent,f);return{templateId:d.id,roleId:t,text:u,fallbackText:g,tokens:f,seed:m,toneOverrides:d.toneOverrides,metadata:d.metadata}},en=e=>e.charAt(0).toUpperCase()+e.slice(1),Iu=/^\[roleTemplate:([a-zA-Z0-9_]+)\.([a-zA-Z0-9_]+)\]$/i,qs={resistance:0,corpsec:0,scavengers:0},Un=e=>e.objectives.some(t=>t.type!=="talk"&&!t.isCompleted),Eu=e=>{if(!e)return null;const t=e.trim(),n=Iu.exec(t);if(!n)return null;const[,r,s]=n;return{roleId:r,templateKey:s}},Gn=e=>Number.isInteger(e)?e:Number(e.toFixed(1)),Ks=e=>({xp:Math.max(0,e*5),credits:Math.max(0,e*3)}),Tu=()=>{var ke;const e=Xe(),t=P(x=>x.quests.quests),n=P(x=>x.settings.locale),r=P(x=>!!x.settings.reputationSystemsEnabled),s=ot(n),i=Qe(n),{logs:l}=s,o=P(x=>x.player.data),d=P(x=>x.world),[m,f]=c.useState(null),u=(x,L="attribute")=>{if(L==="skill")try{return oo(x).name}catch(b){return console.warn("[DialogueOverlay] Missing skill definition for",x,b),en(x)}return i.skills[x]??en(x)},g=x=>i.playerStatus.factions[x]??en(x),h=x=>i.dialogueOverlay.standingLabels[x]??en(x),I=c.useCallback(x=>{const L=t.find(j=>j.id===x);if(!L)return;let b=!1;if(L.rewards.forEach(j=>{switch(j.type){case"experience":j.amount>0&&(e(an({amount:j.amount,reason:`Quest complete: ${L.name}`})),e(O(l.rewardExperience(j.amount,L.name))),b=!0);break;case"currency":j.amount>0&&(e(Vr(j.amount)),e(O(l.rewardCredits(j.amount,L.name))));break;case"item":if(j.id){const w=Math.max(1,j.amount||1);for(let ye=0;ye<w;ye+=1){const he={id:et(),name:j.id,description:i.dialogueOverlay.itemRecoveredDescription(L.name),weight:1,value:0,isQuestItem:!1};e(ca(he))}e(O(l.rewardItem(j.id,L.name)))}break}}),!b){const j=Math.max(40,(L.objectives.length||1)*30);e(an({amount:j,reason:`Quest complete: ${L.name}`})),e(O(l.rewardExperience(j,L.name)))}},[e,t,l,i]),y=c.useCallback(x=>{if(!x.questEffect)return;const{questId:L,effect:b,objectiveId:j}=x.questEffect;switch(b){case"start":{const w=t.find(ye=>ye.id===L);w&&!w.isActive&&!w.isCompleted&&(e(la(L)),e(O(l.questAccepted(w.name))))}break;case"complete":{const w=t.find(ye=>ye.id===L);if(w&&w.isActive&&!w.isCompleted){if(Un(w))break;e(so(L)),I(L),e(O(l.questCompleted(w.name)))}}break;case"update":if(j){e(ro({questId:L,objectiveId:j,isCompleted:!0}));const w=t.find(he=>he.id===L),ye=w==null?void 0:w.objectives.find(he=>he.id===j);w&&ye&&e(O(l.objectiveUpdated(ye.description,w.name)))}break}},[e,I,t,l]),{activeDialogue:{dialogueId:E,currentNodeId:R},dialogues:M,claimedDialogueRewards:F}=P(x=>x.quests),G=c.useMemo(()=>new Map(t.map(x=>[x.id,x])),[t]),B=c.useMemo(()=>E?M.find(x=>x.id===E)??null:null,[E,M]),A=c.useMemo(()=>!B||B.nodes.length===0?null:B.nodes.find(L=>L.id===R)??B.nodes[0],[B,R]),Q=c.useMemo(()=>{var ye,he,Le;if(!B||!A)return null;const x=B.nodes.find(Ie=>Ie.id===A.id)??A;let L=x.text,b=x,j;const w=Eu(x.text);if(w&&o&&d){const Ie=w.roleId,{templateKey:$e}=w,We={level:o.level,perks:o.perks??[],factionReputation:r?o.factionReputation??qs:qs},Ue={locale:n,reputationSystemsEnabled:r,player:We,world:{timeOfDay:d.timeOfDay,curfewActive:d.curfewActive,zoneId:((ye=d.currentMapArea)==null?void 0:ye.zoneId)??"unknown_zone",zoneName:(he=d.currentMapArea)==null?void 0:he.name,hazards:((Le=d.currentMapArea)==null?void 0:Le.hazards)??[],environmentFlags:d.environment.flags},npc:void 0,randomSeed:`${B.id}:${x.id}`},Re=ku({roleId:Ie,templateKey:$e,context:Ue});Re&&(L=Re.text,j=Re.seed,b={...x,text:Re.text,tone:{...x.tone??{},...Re.toneOverrides??{}}})}return{dialogue:B,node:b,fallbackText:L,seedOverride:j}},[B,A,n,o,d,r]),$=c.useMemo(()=>Q?Zd.resolveLine({dialogue:Q.dialogue,node:Q.node,fallbackText:Q.fallbackText,seedOverride:Q.seedOverride}):null,[Q]),de=c.useCallback(x=>{if(!x.questEffect)return null;const L=t.find(b=>{var j;return b.id===((j=x.questEffect)==null?void 0:j.questId)});if(!L)return null;switch(x.questEffect.effect){case"start":if(L.isCompleted)return"alreadyCompleted";if(L.isActive)return"alreadyActive";break;case"complete":if(L.isCompleted)return"alreadyCompleted";if(!L.isActive)return"notActive";if(Un(L))return"objectivesIncomplete";break;case"update":if(x.questEffect.objectiveId){const b=L.objectives.find(j=>{var w;return j.id===((w=x.questEffect)==null?void 0:w.objectiveId)});if(b!=null&&b.isCompleted)return"objectiveCompleted"}break}return null},[t]),ne=c.useCallback(x=>{if(!x.questEffect)return!0;const L=t.find(b=>{var j;return b.id===((j=x.questEffect)==null?void 0:j.questId)});if(!L)return!1;switch(x.questEffect.effect){case"start":return!L.isActive&&!L.isCompleted;case"complete":return L.isActive&&!L.isCompleted&&!Un(L);case"update":return!L.isActive||L.isCompleted?!1:x.questEffect.objectiveId?!L.objectives.some(b=>{var j;return b.id===((j=x.questEffect)==null?void 0:j.objectiveId)&&b.isCompleted}):!0;default:return!0}},[t]),S=c.useCallback(x=>au(o,x),[o]),N=c.useCallback(x=>iu(o,x,r),[o,r]),W=c.useCallback(x=>{if(de(x))return!0;const b=S(x);if(b&&!b.isPassed)return!0;const j=N(x);return!!(j&&!j.isPassed)},[S,N,de]),z=c.useMemo(()=>A?A.options.filter(x=>{if(!ne(x))return!1;const L=S(x);if(L&&!L.isPassed&&L.visibility==="hidden")return!1;const b=N(x);return!(b&&!b.isPassed&&b.visibility==="hidden")}):[],[A,S,N,ne]),T=c.useCallback(x=>{var w;if(!x.skillCheck||x.questEffect)return;const L=(w=x.outcomePreview)==null?void 0:w.rewardClaimKey;if(!L||F!=null&&F[L])return;const{xp:b,credits:j}=Ks(x.skillCheck.threshold);b>0&&e(an({amount:b,reason:`Dialogue check: ${x.text}`})),j>0&&e(Vr(j)),e(ao(L))},[F,e]),ue=c.useCallback(x=>{W(x)||(T(x),y(x),x.nextNodeId?e(io(x.nextNodeId)):e(cn()))},[T,e,y,W]);if(c.useEffect(()=>{if(!A)return;const x=b=>{var he;if(b.target instanceof HTMLElement&&(b.target.tagName==="INPUT"||b.target.tagName==="TEXTAREA"||b.target.getAttribute("contenteditable")==="true"))return;let j=null;if(/^[0-9]$/.test(b.key))j=Number(b.key);else if((he=b.code)!=null&&he.startsWith("Numpad")){const Le=Number(b.code.replace("Numpad",""));j=Number.isNaN(Le)?null:Le}if(j===null||j<1)return;const w=j-1,ye=z[w];ye&&(b.preventDefault(),b.stopPropagation(),typeof b.stopImmediatePropagation=="function"&&b.stopImmediatePropagation(),ue(ye))},L={capture:!0};return window.addEventListener("keydown",x,L),()=>{window.removeEventListener("keydown",x,L)}},[A,ue,z]),!E||!B||!A)return null;const Z=($==null?void 0:$.text)??(A==null?void 0:A.text)??"...",fe=Object.values(B.speakers??{})[0],Y=A.speakerId??B.defaultSpeakerId,J=Y?((ke=B.speakers)==null?void 0:ke[Y])??fe:fe,le=(J==null?void 0:J.displayName)??A.speaker??B.npcId??i.dialogueOverlay.speakerFallback,me=tu(J==null?void 0:J.portraitId,le),xe={"--dialogue-portrait-accent":me.accentHex,"--dialogue-portrait-from":me.gradientFromHex,"--dialogue-portrait-to":me.gradientToHex};return a.jsx("div",{className:"dialogue-overlay",children:a.jsxs("div",{className:"dialogue-overlay__card",children:[a.jsxs("div",{className:"dialogue-overlay__header",children:[a.jsx("span",{className:"dialogue-overlay__speaker",children:le}),a.jsxs("div",{className:"dialogue-overlay__line-row",children:[a.jsx("div",{className:"dialogue-overlay__portrait",style:xe,children:me.imagePath?a.jsx("img",{src:me.imagePath,alt:le,className:"dialogue-overlay__portrait-image"}):a.jsx("span",{className:"dialogue-overlay__portrait-initials","aria-hidden":"true",children:me.initials})}),a.jsx("h2",{className:"dialogue-overlay__line",children:Z})]})]}),a.jsx("div",{className:"dialogue-overlay__options",children:z.map((x,L)=>{var $e,We,Ue,Re;const b=W(x),j=S(x),w=N(x),ye=de(x),he=($e=x.outcomePreview)==null?void 0:$e.rewardClaimKey,Le=!!(he&&(F!=null&&F[he])),Ie=[];if(x.questEffect){const ve=((We=G.get(x.questEffect.questId))==null?void 0:We.name)??x.questEffect.questId;Ie.push({text:i.dialogueOverlay.questActionLabel(x.questEffect.effect,ve),tone:"quest"})}if((Ue=x.outcomePreview)!=null&&Ue.summary&&Ie.push({text:x.outcomePreview.summary,tone:"outcome"}),x.skillCheck&&!x.questEffect&&he)if(Le)Ie.push({text:i.dialogueOverlay.rewardClaimed,tone:"reward"});else{const ve=Ks(x.skillCheck.threshold);Ie.push({text:i.dialogueOverlay.rewardPreview(ve.xp,ve.credits),tone:"reward"})}if(ye&&Ie.push({text:i.dialogueOverlay.questLocks[ye],tone:"lock"}),j&&x.skillCheck&&!j.isPassed){const ve=Math.max(0,j.requiredValue-Gn(j.currentValue));Ie.push({text:i.dialogueOverlay.lockedSkillGap(u(x.skillCheck.skill,j.domain),Gn(ve),Gn(j.currentValue),j.requiredValue),tone:"lock"}),(Re=x.outcomePreview)!=null&&Re.unlocks&&Ie.push({text:i.dialogueOverlay.unlocksLabel(x.outcomePreview.unlocks),tone:"unlock"})}if(w&&!w.isPassed){let ve="";switch(w.failedRequirement){case"minimumStanding":ve=h(w.minimumStanding??"neutral");break;case"maximumStanding":ve=`≤ ${h(w.maximumStanding??"allied")}`;break;case"minimumReputation":ve=`Rep ${w.minimumReputation??0}+`;break;case"maximumReputation":ve=`Rep ≤ ${w.maximumReputation??0}`;break;default:ve=h(w.minimumStanding??"neutral");break}Ie.push({text:i.dialogueOverlay.requiresFactionStanding(g(w.factionId),ve,h(w.currentStanding)),tone:"lock"})}return a.jsxs("button",{type:"button",onClick:()=>ue(x),onMouseEnter:()=>!b&&f(L),onMouseLeave:()=>f(null),className:"dialogue-overlay__option","data-locked":b?"true":"false","data-hovered":m===L&&!b?"true":"false",style:{pointerEvents:b?"none":"auto"},children:[a.jsx("span",{className:"dialogue-overlay__option-index",children:L+1}),a.jsxs("span",{className:"dialogue-overlay__option-content",children:[a.jsx("span",{className:"dialogue-overlay__option-text",children:x.text}),Ie.length>0&&a.jsx("span",{className:"dialogue-overlay__option-meta",children:Ie.map((ve,rt)=>a.jsx("span",{className:"dialogue-overlay__option-status","data-tone":ve.tone,"data-locked":b?"true":"false",children:ve.text},`${x.text}-meta-${rt}`))})]})]},`${x.text}-${L}`)})}),a.jsx("span",{className:"dialogue-overlay__hint",children:i.dialogueOverlay.escHint})]})})},Cu=e=>e.quests.quests,Mu=e=>e.settings.locale,Ys=(e,t)=>{var o,d,m;const n=fa[e.id],r=(n==null?void 0:n.kind)??"primary",s=(o=n==null?void 0:n.relatedNpcKeys)==null?void 0:o[0],i=s?((d=t.npcs[s])==null?void 0:d.name)??null:null,l=n!=null&&n.missionKey&&n.missionKey in t.missions?((m=t.missions[n.missionKey])==null?void 0:m.summary)??null:null;return{id:e.id,name:e.name,description:e.description,objectives:e.objectives,rewards:e.rewards,kind:r,giverName:i,missionSummary:l,isActive:e.isActive,isCompleted:e.isCompleted}},Pu=X([Oe,Cu,Mu],(e,t,n)=>{const r=Mo(n),s=new Map(t.map(f=>[f.id,f])),i=t.map(f=>Ys(f,r)).filter(f=>f.kind==="side"),l=i.filter(f=>f.isActive&&!f.isCompleted).sort((f,u)=>f.name.localeCompare(u.name)),o=i.filter(f=>!f.isActive&&!f.isCompleted).sort((f,u)=>f.name.localeCompare(u.name)),d=t.map(f=>Ys(f,r)).filter(f=>f.isCompleted).sort((f,u)=>f.name.localeCompare(u.name));return{primaryObjectives:((e==null?void 0:e.primary)??[]).filter(f=>f.questIds.some(u=>{const g=s.get(u);return!!(g&&(g.isActive||g.isCompleted))})),activeSideQuests:l,availableSideQuests:o,completedQuests:d}}),Ru=(...e)=>e.filter(Boolean).join(" "),Au=({showCompleted:e=!1})=>{const t=P(g=>g.settings.locale),n=Qe(t),r=P(Pu),s=(g,h)=>g<=0?null:t==="en"?g>1?`${g} ${h}s`:`${g} ${h}`:`${g} ${h}`,i=g=>{const h=g.rewards.filter(R=>R.type==="currency").reduce((R,M)=>R+M.amount,0),I=g.rewards.filter(R=>R.type==="experience").reduce((R,M)=>R+M.amount,0),y=g.rewards.filter(R=>R.type==="item"),E=[h?n.questLog.currencyLabel(h):null,I?n.questLog.experienceLabel(I):null,...y.map(R=>s(Math.max(1,R.amount||1),R.id??n.questLog.supplyFallback))].filter(Boolean);return E.length===0?null:a.jsxs("div",{className:"text-[0.66rem] uppercase tracking-[0.18em] text-[#34d399]",children:[n.questLog.rewardsHeading,": ",E.join(" • ")]})},l=g=>a.jsx("h4",{className:"hud-ops-section-label text-[0.62rem] font-semibold text-[#93c5fd]",children:g}),o=()=>r.primaryObjectives.length===0?a.jsx("div",{className:"hud-ops-empty text-[0.7rem]",children:n.questLog.primaryEmpty}):a.jsx("div",{className:"flex flex-col gap-2.5",children:r.primaryObjectives.map(g=>a.jsxs("div",{className:"hud-ops-card hud-ops-card--active flex items-start justify-between gap-3 p-[0.8rem]",children:[a.jsxs("div",{className:"flex min-w-0 flex-1 flex-col gap-1.5",children:[a.jsx("div",{className:"text-[0.76rem] font-semibold tracking-[0.04em] text-slate-100",children:g.label}),g.summary?a.jsx("p",{className:"hud-ops-text-muted text-[0.68rem] leading-[1.45]",children:g.summary}):null]}),a.jsxs("div",{className:"flex min-w-[4.6rem] flex-col items-end gap-1",children:[a.jsx("span",{className:"text-[0.62rem] uppercase tracking-[0.16em]",style:{color:g.isComplete?"#86efac":"#facc15"},children:g.isComplete?n.questLog.primaryComplete:n.questLog.primaryInProgress}),a.jsxs("span",{className:"text-[0.66rem] text-[#e2e8f0]",children:[g.completedQuests,"/",g.totalQuests]})]})]},g.id))}),d=()=>r.activeSideQuests.length===0?a.jsx("div",{className:"hud-ops-empty text-[0.7rem]",children:n.questLog.activeSideEmpty}):a.jsx("div",{className:"flex flex-col gap-2.5",children:r.activeSideQuests.map(g=>a.jsxs("div",{className:"hud-ops-card hud-ops-card--active flex flex-col gap-2.5 p-[0.88rem]",children:[a.jsx("div",{className:"text-[0.84rem] font-semibold tracking-[0.05em] text-slate-50",children:g.name}),a.jsx("p",{className:"hud-ops-text-muted text-[0.72rem] leading-[1.5]",children:g.description}),a.jsx("div",{className:"flex flex-col gap-2.5",children:g.objectives.map(h=>a.jsxs("div",{className:"flex items-start gap-[0.52rem] text-[0.72rem] text-[#cbd5f5]",children:[a.jsx("span",{"aria-hidden":"true",className:"hud-ops-objective-check mt-[1px]","data-completed":h.isCompleted,children:"✓"}),a.jsx("span",{className:"flex-1 leading-tight",children:h.description}),h.count?a.jsxs("span",{className:"text-[0.62rem] uppercase tracking-[0.14em] text-[#facc15]",children:[h.currentCount??0,"/",h.count]}):null]},h.id))}),i(g)]},g.id))}),m=()=>r.availableSideQuests.length===0?a.jsx("div",{className:"hud-ops-empty text-[0.7rem]",children:n.questLog.availableSideEmpty}):a.jsx("div",{className:"flex flex-col gap-2.5",children:r.availableSideQuests.map(g=>a.jsxs("div",{className:"hud-ops-card flex flex-col gap-2.5 p-[0.84rem]",children:[a.jsx("div",{className:"text-[0.78rem] font-semibold tracking-[0.05em] text-[#e2e8f0]",children:g.name}),g.missionSummary?a.jsx("p",{className:"hud-ops-text-muted text-[0.7rem] leading-[1.5]",children:g.missionSummary}):a.jsx("p",{className:"hud-ops-text-muted text-[0.7rem] leading-[1.5]",children:g.description}),a.jsx("div",{className:"text-[0.64rem] uppercase tracking-[0.14em] text-[#93c5fd]",children:g.giverName?n.questLog.giverLabel(g.giverName):n.questLog.giverUnknown}),a.jsx("div",{className:"flex flex-col gap-2",children:g.objectives.map(h=>a.jsxs("div",{className:"flex items-start gap-[0.52rem] text-[0.69rem] text-[#b7c3df]",children:[a.jsx("span",{"aria-hidden":"true",className:"hud-ops-objective-check mt-[1px]","data-completed":h.isCompleted,children:"✓"}),a.jsx("span",{className:"flex-1 leading-tight",children:h.description}),h.count?a.jsxs("span",{className:"text-[0.62rem] uppercase tracking-[0.14em] text-[#facc15]",children:[h.currentCount??0,"/",h.count]}):null]},h.id))}),i(g)]},g.id))}),f=()=>r.completedQuests.length===0?a.jsx("div",{className:"hud-ops-empty text-[0.72rem]",children:n.questLog.completedEmpty}):a.jsx("div",{className:"flex flex-col gap-2.5",children:r.completedQuests.map(g=>a.jsxs("div",{className:"hud-ops-card hud-ops-card--completed flex flex-col gap-2.5 p-[0.84rem]",children:[a.jsxs("div",{className:"flex items-center justify-between gap-2",children:[a.jsx("div",{className:"text-[0.78rem] font-semibold tracking-[0.05em] text-[#ede9fe]",children:g.name}),a.jsx("span",{"aria-hidden":"true",className:"hud-ops-complete-badge inline-flex h-[1.15rem] w-[1.15rem] items-center justify-center rounded-[0.35rem] text-[0.72rem] font-bold",children:"✓"})]}),a.jsx("p",{className:"hud-ops-text-muted text-[0.7rem] leading-[1.5]",children:g.description})]},g.id))});if(e)return a.jsx("div",{className:"flex flex-col gap-3.5 overflow-y-auto pr-1",children:a.jsxs("section",{className:"flex flex-col gap-2.5",children:[l(n.questLog.completed),f()]})});const u=r.primaryObjectives.length+r.activeSideQuests.length+r.availableSideQuests.length>4;return a.jsxs("div",{className:Ru("flex flex-col gap-4 pr-1",u?"overflow-y-auto":"overflow-y-hidden"),children:[a.jsxs("section",{className:"flex flex-col gap-2.5",children:[l(n.questLog.primaryProgress),o()]}),a.jsxs("section",{className:"flex flex-col gap-2.5",children:[l(n.questLog.activeSideQuests),d()]}),a.jsxs("section",{className:"flex flex-col gap-2.5",children:[l(n.questLog.availableSideQuests),m()]})]})},Xs=pn.memo(Au),mn={cyan:"#38bdf8",textPrimary:"#f8fafc",textSecondary:"rgba(226, 232, 240, 0.78)",textMuted:"rgba(148, 163, 184, 0.72)"},km={background:"rgba(15, 23, 42, 0.6)",borderRadius:"12px",border:"1px solid rgba(148, 163, 184, 0.18)",padding:"0.8rem",boxShadow:"inset 0 1px 0 rgba(148, 163, 184, 0.18)"},Im={display:"flex",flexDirection:"column",gap:"0.14rem"},Em={fontSize:"0.52rem",letterSpacing:"0.19em",textTransform:"uppercase",color:"rgba(148, 163, 184, 0.72)"},Tm={fontSize:"0.72rem",fontWeight:600,letterSpacing:"0.05em",color:"#f8fafc",margin:0},Cm={fontFamily:'"DM Sans", "Inter", sans-serif',fontSize:"0.85rem",fontWeight:700,color:mn.textPrimary},Mm={fontFamily:'"DM Sans", "Inter", sans-serif',fontSize:"0.62rem",color:mn.textMuted},Pm=(e,t)=>({background:`linear-gradient(135deg, ${e}, ${t})`,WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text"}),Du=(e,t=8)=>({textShadow:`0 0 ${t}px ${e}, 0 0 ${t*2}px ${e}40`}),Qs=24,_u=e=>{if(!e)return null;const t=e.canvasDisplayWidth/(e.canvasWidth||1),n=e.canvasDisplayHeight/(e.canvasHeight||1);return{x:e.canvasLeft+e.screenX*t,y:e.canvasTop+e.screenY*n}},Lu=()=>{const[e,t]=c.useState(null),n=c.useRef(null),r=c.useCallback(s=>{n.current=s;const i=_u(s);i&&t(i)},[]);return c.useEffect(()=>{if(typeof window<"u"){const s=window.__getawayPlayerScreenPosition;s&&r(s)}},[r]),c.useEffect(()=>{const s=i=>{r(i.detail)};return window.addEventListener(dn,s),()=>window.removeEventListener(dn,s)},[r]),c.useEffect(()=>{const s=()=>{n.current&&r(n.current)};return window.addEventListener("resize",s),()=>window.removeEventListener("resize",s)},[r]),e},ju=({notification:e,onComplete:t})=>{const[n,r]=c.useState(!1);c.useEffect(()=>{const o=setTimeout(()=>r(!0),10),d=setTimeout(()=>{r(!1),setTimeout(()=>t(e.id),200)},2200);return()=>{clearTimeout(o),clearTimeout(d)}},[e.id,t]);const s={display:"inline-flex",alignItems:"center",gap:"0.28rem",padding:"0.28rem 0.45rem",minWidth:"fit-content",background:"linear-gradient(150deg, rgba(7, 13, 26, 0.92) 0%, rgba(12, 148, 136, 0.58) 100%)",border:"1px solid rgba(56, 189, 248, 0.45)",borderRadius:"999px",boxShadow:"0 10px 18px -16px rgba(13, 148, 136, 0.55)",opacity:n?1:0,transform:n?"translateY(0)":"translateY(10px)",transition:"opacity 0.18s ease-out, transform 0.18s ease-out",pointerEvents:"none"},i={fontSize:"0.9rem",fontWeight:800,letterSpacing:"0.16em",textTransform:"uppercase",color:mn.textPrimary,...Du(mn.cyan,6)},l={fontSize:"0.55rem",fontWeight:700,letterSpacing:"0.24em",textTransform:"uppercase",color:"rgba(148, 233, 255, 0.92)"};return a.jsxs("div",{style:s,children:[a.jsxs("span",{style:i,children:["+",e.amount]}),a.jsx("span",{style:l,children:"XP"})]})},Nu=({notifications:e,onDismiss:t})=>{const n=Lu(),r=c.useMemo(()=>({right:28,top:72}),[]);return a.jsx(a.Fragment,{children:e.map((s,i)=>{const l=n&&typeof window<"u"?(()=>{const o=(h,I,y)=>Math.min(Math.max(h,I),y),d=window.innerWidth||r.right*2,m=window.innerHeight||r.top*2,f=o(n.x,24,d-24),u=o(n.y,24,m-24),g=o(u-56-i*Qs,16,m-16);return{position:"fixed",left:f,top:g,transform:"translateX(-50%)",zIndex:9998,pointerEvents:"none"}})():{position:"fixed",right:`${r.right}px`,top:`${r.top+i*Qs}px`,zIndex:9998,pointerEvents:"none"};return a.jsx("div",{style:l,children:a.jsx(ju,{notification:s,onComplete:t})},s.id)})})},Ou=()=>{const{currentMapArea:e,inCombat:t,engagementMode:n}=P(g=>g.world),r=P(g=>g.surveillance.hud),s=P(g=>!!g.settings.reputationSystemsEnabled),i=P(g=>g.world.currentMapArea.zoneId),l=P(g=>{var h;return s?(h=g.suspicion.zones[i])==null?void 0:h.heat:void 0}),[o,d]=c.useState(()=>new Date),m=n==="stealth",f=n==="dialog",u=c.useMemo(()=>{const g=(r==null?void 0:r.detectionProgress)??0,h=(l==null?void 0:l.totalHeat)??0,I=Math.max(0,Math.min(100,Math.round(h)));return Math.max(g,I)},[r==null?void 0:r.detectionProgress,l==null?void 0:l.totalHeat]);return c.useEffect(()=>{const g=window.setInterval(()=>d(new Date),1e3);return()=>window.clearInterval(g)},[]),a.jsxs("div",{className:"pointer-events-none absolute inset-0 select-none font-mono uppercase tracking-[0.18em] text-[#38bdf8]",children:[a.jsx("div",{className:"hud-corner","data-position":"top-left"}),a.jsx("div",{className:"hud-corner","data-position":"top-right"}),a.jsx("div",{className:"hud-corner","data-position":"bottom-right"}),a.jsx("div",{className:"hud-corner","data-position":"bottom-left"}),a.jsxs("div",{className:"hud-frame-top",children:[a.jsxs("div",{className:"hud-frame-chip","data-state":t?"alert":m?"stealth":"idle",children:[a.jsx("span",{className:"text-[0.45rem]",children:"●"}),a.jsx("span",{children:t?"COMBAT":m?"STEALTH":f?"DIALOG":"TACTICAL"})]}),a.jsxs("div",{className:"hud-frame-chip",children:[a.jsx("span",{children:"LOC"}),a.jsx("span",{className:"text-slate-100",children:(e==null?void 0:e.id)??"UNKNOWN"})]}),a.jsx("div",{className:"hud-frame-chip",children:a.jsx("span",{children:o.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"})})})]}),a.jsx("div",{className:"hud-threat","data-alert":t?"true":"false",children:m?a.jsxs("span",{children:["DETECTION: ",u,"%"]}):f?a.jsx(a.Fragment,{children:"DIALOG MODE ACTIVE"}):a.jsxs(a.Fragment,{children:["THREAT LEVEL: ",t?"HOSTILE":"CLEAR"]})}),a.jsx("div",{className:"hud-frame-line","data-orientation":"top"}),a.jsx("div",{className:"hud-frame-line","data-orientation":"bottom"})]})},Fu=({value:e,gridX:t,gridY:n,type:r,label:s,onComplete:i})=>{const[l,o]=c.useState(!0),[d,m]=c.useState(null),f=c.useRef(null),u=P(M=>M.player.data.position),g=c.useCallback(M=>{if(!M)return;f.current=M;const F=t-u.x,G=n-u.y,B=64,A=B,Q=B/2,$=(F-G)*(A/2),de=(F+G)*(Q/2),ne=M.worldX+$,S=M.worldY+de,N=M.worldX-M.screenX/M.zoom,W=M.worldY-M.screenY/M.zoom,z=(ne-N)*M.zoom,T=(S-W)*M.zoom,ue=M.canvasDisplayWidth/M.canvasWidth,Z=M.canvasDisplayHeight/M.canvasHeight,fe=M.canvasLeft+z*ue,Y=M.canvasTop+T*Z;m({x:fe,y:Y})},[t,n,u.x,u.y]);if(c.useEffect(()=>{if(typeof window<"u"){const M=window.__getawayPlayerScreenPosition;M&&g(M)}},[g]),c.useEffect(()=>{const M=F=>{g(F.detail)};return window.addEventListener(dn,M),()=>window.removeEventListener(dn,M)},[g]),c.useEffect(()=>{const M=setTimeout(()=>{o(!1),i==null||i()},1500);return()=>clearTimeout(M)},[i]),!l||!d)return null;const I=(()=>{switch(r){case"damage":return{color:"#ef4444",glow:"rgba(239, 68, 68, 0.8)",prefix:"-",scale:1};case"heal":return{color:"#34d399",glow:"rgba(52, 211, 153, 0.8)",prefix:"+",scale:1};case"crit":return{color:"#fbbf24",glow:"rgba(251, 191, 36, 0.9)",prefix:"-",scale:1.4};case"miss":return{color:"#94a3b8",glow:"rgba(148, 163, 184, 0.6)",prefix:"",scale:.9};case"block":return{color:"#38bdf8",glow:"rgba(56, 189, 248, 0.8)",prefix:"",scale:1};case"pickup":return{color:"#22d3ee",glow:"rgba(34, 211, 238, 0.85)",prefix:"+",scale:1.05};default:return{color:"#ffffff",glow:"rgba(255, 255, 255, 0.6)",prefix:"",scale:1}}})(),y=r==="miss"?"MISS":r==="block"?"BLOCK":r==="pickup"?`PICKED UP: ${e>1?`${e}x `:""}${s??(e===1?"ITEM":"ITEMS")}`:`${I.prefix}${e}`,E={position:"fixed",left:`${d.x}px`,top:`${d.y}px`,transform:"translate(-50%, -100%)",pointerEvents:"none",userSelect:"none",zIndex:1e4,animation:"floatUp 1.5s cubic-bezier(0.4, 0, 0.2, 1) forwards"},R={fontSize:`${1.2*I.scale}rem`,fontWeight:r==="crit"?900:800,color:I.color,textShadow:`0 0 12px ${I.glow}, 0 0 6px ${I.glow}, 0 2px 4px rgba(0, 0, 0, 0.8)`,fontFamily:'"DM Mono", "IBM Plex Mono", monospace',letterSpacing:"0.05em",WebkitTextStroke:r==="crit"?`1px ${I.color}dd`:"none"};return a.jsxs(a.Fragment,{children:[a.jsx("style",{children:`
        @keyframes floatUp {
          0% {
            transform: translateY(0) scale(${I.scale*.8});
            opacity: 0;
          }
          20% {
            opacity: 1;
          }
          100% {
            transform: translateY(-60px) scale(${I.scale});
            opacity: 0;
          }
        }
      `}),a.jsx("div",{style:E,children:a.jsx("span",{style:R,children:y})})]})},zu=({active:e,type:t="damage",intensity:n=.6,duration:r=300})=>{const[s,i]=c.useState(!1);if(c.useEffect(()=>{if(e){i(!0);const m=setTimeout(()=>{i(!1)},r);return()=>clearTimeout(m)}},[e,r]),!s)return null;const d={...{position:"absolute",inset:0,pointerEvents:"none",zIndex:9999,animation:`hitFlash ${r}ms ease-out forwards`},...(()=>{switch(t){case"damage":return{background:`radial-gradient(circle at center, rgba(239, 68, 68, ${Math.max(0,n*.22)}) 0%, rgba(239, 68, 68, 0) 65%)`,mixBlendMode:"screen"};case"heal":return{background:`rgba(52, 211, 153, ${n})`,mixBlendMode:"lighten"};case"crit":return{background:`rgba(251, 191, 36, ${n*.8})`,mixBlendMode:"screen"};case"block":return{background:`rgba(56, 189, 248, ${n*.7})`,mixBlendMode:"screen"};default:return{background:`rgba(255, 255, 255, ${n})`,mixBlendMode:"screen"}}})()};return a.jsxs(a.Fragment,{children:[a.jsx("style",{children:`
        @keyframes hitFlash {
          0% {
            opacity: 1;
          }
          100% {
            opacity: 0;
          }
        }
      `}),a.jsx("div",{style:d})]})},Hu=()=>{const e=Xe(),{floatingNumbers:t,activeFlashId:n,hitFlashes:r}=P(i=>i.combatFeedback),s=r.find(i=>i.id===n);return a.jsxs(a.Fragment,{children:[s&&a.jsx(zu,{active:!0,type:s.type,intensity:s.intensity,duration:s.duration}),t.map(i=>a.jsx(Fu,{value:i.value,gridX:i.gridX,gridY:i.gridY,type:i.type,label:i.label,onComplete:()=>e(lo(i.id))},i.id))]})},Bu={position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",pointerEvents:"none",zIndex:20},$u={padding:"1.8rem 3rem",borderRadius:"18px",background:"rgba(15, 23, 42, 0.85)",border:"1px solid rgba(248, 250, 252, 0.35)",boxShadow:"0 40px 60px rgba(15, 23, 42, 0.55)",display:"flex",flexDirection:"column",alignItems:"center",gap:"0.6rem",textAlign:"center",color:"#f8fafc",letterSpacing:"0.28em",textTransform:"uppercase"},Wu={fontSize:"1.6rem",fontWeight:800},Uu={fontSize:"0.85rem",fontWeight:600,opacity:.8},Gu=()=>{const e=Xe(),t=P(n=>n.surveillance.curfewBanner.visible);return c.useEffect(()=>{if(!t)return;const n=window.setTimeout(()=>{e(aa({visible:!1,timestamp:Date.now()}))},3e3);return()=>{window.clearTimeout(n)}},[t,e]),t?a.jsx("div",{style:Bu,"aria-live":"assertive","aria-atomic":"true",children:a.jsxs("div",{style:$u,role:"alert",children:[a.jsx("span",{style:Wu,children:"Curfew Active"}),a.jsx("span",{style:Uu,children:"Surveillance Engaged"})]})}):null},Vu=e=>e.hudLayout.override,qu=X([Vu,e=>e.world.inCombat],(e,t)=>e||(t?"combat":"exploration")),Ku=()=>{const e=Xe(),t=P(Oe),n=P($a),r=c.useRef(!1),s=c.useRef(!1);return c.useEffect(()=>{const i=(t==null?void 0:t.allPrimaryComplete)??!1;i&&!r.current&&!n&&e(co()),r.current=i},[t==null?void 0:t.allPrimaryComplete,n,e]),c.useEffect(()=>{if(!t){s.current=!1;return}n&&!s.current&&(dd({level:t.level,levelId:t.levelId,name:t.name}),e(sn({type:"missionCompletion",missionId:t.levelId})),s.current=!0),n||(s.current=!1)},[e,n,t]),null},gr=e=>!!e.settings.reputationSystemsEnabled,Yu={resistance:0,corpsec:0,scavengers:0},Xu=[],Qu=[],Ka=e=>e.player.data.factionReputation,Zu=e=>e.player.pendingFactionEvents;X(Ka,gr,(e,t)=>t?e:Yu);const Ju=X(Zu,gr,(e,t)=>!t||e.length===0?Xu:e),Rm=X(Ka,gr,(e,t)=>t?uo().map(({id:r})=>{const s=mo(r),i=fo(r,e[r]??s.definition.defaultReputation);return{factionId:r,name:s.definition.name,description:s.definition.description,value:i.value,standingId:i.standing.id,standingLabel:i.standing.label,color:i.standing.color,icon:i.standing.icon,effects:i.effects,nextThreshold:i.nextThreshold}}):Qu),ef={position:"fixed",top:"80px",right:"28px",display:"flex",flexDirection:"column",gap:"0.45rem",zIndex:9999,pointerEvents:"none"},tf=e=>({minWidth:"220px",maxWidth:"280px",borderRadius:"12px",border:`1px solid ${e}`,background:"rgba(15, 23, 42, 0.92)",boxShadow:"0 18px 32px rgba(2, 6, 23, 0.45)",padding:"0.55rem 0.7rem",display:"flex",flexDirection:"column",gap:"0.28rem",color:"rgba(226, 232, 240, 0.95)",pointerEvents:"auto"}),nf={fontSize:"0.64rem",letterSpacing:"0.12em",textTransform:"uppercase"},Zs={fontSize:"0.58rem",lineHeight:1.35,color:"rgba(203, 213, 225, 0.92)"},Js=e=>e===0?"±0":`${e>0?"+":""}${e}`,rf=4200,sf=()=>{const e=Xe(),t=P(Ju),n=P(f=>f.settings.locale),r=P(f=>!!f.settings.reputationSystemsEnabled),s=c.useMemo(()=>Qe(n),[n]),i=s.playerStatus.factions,[l,o]=c.useState([]),d=c.useRef({}),m=c.useCallback(f=>{o(g=>g.filter(h=>h.id!==f));const u=d.current[f];u&&(window.clearTimeout(u),delete d.current[f])},[]);return c.useEffect(()=>{if(!r){Object.values(d.current).forEach(u=>window.clearTimeout(u)),d.current={},o(u=>u.length>0?[]:u);return}if(!t.length)return;const f=[];t.forEach(u=>{const g=i[u.factionId]??u.factionId,h=u.standingChanges.find(ne=>ne.factionId===u.factionId),I=u.standingChanges.find(ne=>ne.factionId!==u.factionId),y=Object.entries(u.rivalDeltas??{}),E=y.length>0?y[0]:void 0,R=u.reason?s.factionToast.reasons[u.reason]??u.reason:void 0,M=Js(u.delta),F=h?ln(n,h.nextStanding):void 0,G=F?s.factionToast.standingChange(F):void 0,B=I?ln(n,I.nextStanding):void 0,A=E?s.factionToast.rivalChange(i[E[0]]??E[0],Js(E[1]),B):void 0,Q=s.factionToast.reputationChange(g,M,R),$=`${u.factionId}-${u.timestamp}`,de=u.delta>0?"rgba(56, 189, 248, 0.65)":u.delta<0?"rgba(248, 113, 113, 0.65)":"rgba(148, 163, 184, 0.65)";f.push({id:$,factionId:u.factionId,message:Q,standingNote:G,rivalNote:A,color:de}),e(O(Q)),G&&G!==Q&&e(O(G)),A&&e(O(A))}),o(u=>[...u,...f].slice(-6)),f.forEach(u=>{const g=window.setTimeout(()=>m(u.id),rf);d.current[u.id]=g}),e(po())},[e,t,i,n,m,s.factionToast,r]),c.useEffect(()=>()=>{Object.values(d.current).forEach(f=>window.clearTimeout(f)),d.current={}},[]),!r||l.length===0?null:a.jsx("div",{style:ef,"aria-live":"polite","aria-atomic":"false",children:l.map(f=>a.jsxs("div",{style:tf(f.color),role:"status","aria-live":"polite",children:[a.jsx("span",{style:nf,children:f.message}),f.standingNote&&a.jsx("span",{style:Zs,children:f.standingNote}),f.rivalNote&&a.jsx("span",{style:Zs,children:f.rivalNote})]},f.id))})},af={position:"fixed",inset:0,display:"flex",alignItems:"center",justifyContent:"center",background:"rgba(15, 23, 42, 0.86)",backdropFilter:"blur(6px)",zIndex:20,padding:"1.5rem"},of={width:"min(520px, 92vw)",borderRadius:"18px",border:"1px solid rgba(94, 234, 212, 0.2)",background:"linear-gradient(135deg, rgba(6, 15, 28, 0.95), rgba(13, 31, 48, 0.92))",color:"#f8fafc",fontFamily:"'DM Mono', 'IBM Plex Mono', monospace",boxShadow:"0 40px 68px rgba(2, 6, 23, 0.55)",display:"flex",flexDirection:"column",gap:"1.2rem",padding:"2rem 2.2rem"},lf={display:"flex",gap:"0.75rem"},ea={all:"unset",cursor:"pointer",flex:1,padding:"0.7rem 1.2rem",borderRadius:"999px",letterSpacing:"0.15em",fontSize:"0.72rem",fontWeight:700,textTransform:"uppercase",textAlign:"center",minWidth:0},cf=({open:e,levelName:t,missionStrings:n,primaryObjectives:r,sideObjectives:s,onContinue:i,onDefer:l})=>{if(!e)return null;const o=r.filter(m=>m.isComplete),d=s.filter(m=>!m.isComplete);return a.jsx("div",{role:"dialog","aria-modal":"true",style:af,children:a.jsxs("div",{style:of,children:[a.jsxs("header",{style:{display:"flex",flexDirection:"column",gap:"0.4rem"},children:[a.jsx("span",{style:{fontSize:"0.7rem",letterSpacing:"0.28em",color:"rgba(94, 234, 212, 0.75)",textTransform:"uppercase"},children:n.accomplishedTitle}),a.jsx("h2",{style:{fontSize:"1.35rem",fontWeight:700,letterSpacing:"0.08em",margin:0},children:n.accomplishedSubtitle(t)})]}),a.jsxs("section",{style:{display:"flex",flexDirection:"column",gap:"0.9rem"},children:[a.jsxs("div",{style:{border:"1px solid rgba(148, 163, 184, 0.22)",borderRadius:"14px",padding:"0.9rem 1.1rem",background:"rgba(15, 23, 42, 0.68)",display:"flex",flexDirection:"column",gap:"0.6rem"},children:[a.jsx("span",{style:{fontSize:"0.7rem",color:"rgba(148, 163, 184, 0.78)"},children:n.primarySummaryLabel}),o.length===0?a.jsx("span",{style:{fontSize:"0.72rem",color:"rgba(226, 232, 240, 0.86)"},children:"—"}):a.jsx("ul",{style:{margin:0,padding:0,listStyle:"none",display:"flex",flexDirection:"column",gap:"0.45rem"},children:o.map(m=>a.jsxs("li",{style:{display:"flex",gap:"0.55rem",alignItems:"flex-start",fontSize:"0.74rem",color:"rgba(226, 232, 240, 0.9)",lineHeight:1.35},children:[a.jsx("span",{"aria-hidden":!0,style:{width:"0.9rem",height:"0.9rem",borderRadius:"999px",display:"inline-flex",alignItems:"center",justifyContent:"center",background:"linear-gradient(135deg, rgba(56, 189, 248, 0.55), rgba(94, 234, 212, 0.55))",color:"#02111f",fontSize:"0.62rem",fontWeight:700,border:"1px solid rgba(94, 234, 212, 0.5)"},children:"✓"}),a.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"0.2rem",flex:1},children:[a.jsx("span",{style:{fontWeight:600},children:m.label}),m.summary&&a.jsx("span",{style:{fontSize:"0.66rem",color:"rgba(203, 213, 225, 0.82)"},children:m.summary})]})]},m.id))})]}),a.jsxs("div",{style:{border:"1px solid rgba(148, 163, 184, 0.22)",borderRadius:"14px",padding:"0.9rem 1.1rem",background:"rgba(15, 23, 42, 0.6)",display:"flex",flexDirection:"column",gap:"0.65rem"},children:[a.jsx("span",{style:{fontSize:"0.7rem",color:"rgba(148, 163, 184, 0.78)"},children:n.sideReminder}),d.length===0?a.jsx("span",{style:{fontSize:"0.72rem",color:"rgba(226, 232, 240, 0.88)"},children:"—"}):a.jsx("ul",{style:{margin:0,paddingLeft:"1.1rem",display:"flex",flexDirection:"column",gap:"0.35rem",fontSize:"0.72rem",color:"rgba(226, 232, 240, 0.88)",listStyle:"disc"},children:d.map(m=>a.jsx("li",{children:m.label},m.id))})]}),a.jsx("span",{style:{fontSize:"0.64rem",color:"rgba(148, 163, 184, 0.65)"},children:n.deferHint})]}),a.jsxs("div",{style:lf,children:[a.jsx("button",{type:"button",onClick:i,style:{...ea,border:"1px solid rgba(94, 234, 212, 0.5)",background:"linear-gradient(135deg, rgba(56, 189, 248, 0.7), rgba(94, 234, 212, 0.65))",color:"#02111f",boxShadow:"0 20px 36px rgba(13, 148, 136, 0.35)"},children:n.continueCta}),a.jsx("button",{type:"button",onClick:l,style:{...ea,border:"1px solid rgba(148, 163, 184, 0.45)",background:"rgba(15, 23, 42, 0.75)",color:"rgba(226, 232, 240, 0.9)"},children:n.deferCta})]})]})})},df=()=>{const e=Xe(),t=P(f=>f.settings.locale),n=P(Oe),r=P(f=>f.missions),s=P($a),i=P(rd),l=Qe(t),o=s&&!i,d=()=>{if(!n)return;const f=r.levels[r.currentLevelIndex+1],u=(f==null?void 0:f.zoneId)??null;ud({level:n.level,levelId:n.levelId,name:n.name,nextLevel:(f==null?void 0:f.level)??n.level+1,nextLevelId:f==null?void 0:f.levelId}),e(ho()),u&&e(yo({zoneId:u}))},m=()=>{e(go())};return a.jsx(cf,{open:o,levelName:(n==null?void 0:n.name)??"Current Sector",missionStrings:l.mission,primaryObjectives:(n==null?void 0:n.primary)??[],sideObjectives:(n==null?void 0:n.side)??[],onContinue:d,onDefer:m})},uf=[],ff={width:"min(360px, 32vw)",minWidth:"280px",padding:"0.85rem 1rem 1.1rem",borderRadius:"16px",background:"linear-gradient(165deg, rgba(10,17,32,0.93), rgba(15,23,42,0.9))",border:"1px solid rgba(56,189,248,0.28)",boxShadow:"0 18px 36px rgba(15,23,42,0.55)",display:"flex",flexDirection:"column",gap:"0.72rem",pointerEvents:"auto"},mf={display:"flex",alignItems:"center",justifyContent:"space-between",fontSize:"0.62rem",letterSpacing:"0.22em",textTransform:"uppercase",color:"#94a3b8"},pf={display:"inline-flex",gap:"0.42rem",alignItems:"center",fontSize:"0.62rem",letterSpacing:"0.18em"},gf={fontWeight:700,fontSize:"0.78rem",color:"#38bdf8"},hf={opacity:.8,color:"#cbd5f5"},yf=e=>({width:"100%",display:"flex",alignItems:"center",justifyContent:"center",padding:"0.52rem 1rem",borderRadius:"12px",fontWeight:700,letterSpacing:"0.22em",fontSize:"0.76rem",textTransform:"uppercase",color:e?"#0f172a":"#f8fafc",background:e?"linear-gradient(135deg, #38bdf8, #60a5fa)":"linear-gradient(135deg, rgba(248,113,113,0.85), rgba(239,68,68,0.95))",boxShadow:e?"0 0 18px rgba(56,189,248,0.6), 0 14px 24px -10px rgba(56,189,248,0.55)":"0 0 18px rgba(239,68,68,0.6), 0 14px 24px -10px rgba(239,68,68,0.55)"}),bf={display:"flex",flexDirection:"column",gap:"0.65rem",padding:"0.9rem 1rem 0.85rem",borderRadius:"14px",background:"linear-gradient(155deg, rgba(15,23,42,0.92), rgba(30,41,59,0.8))",border:"1px solid rgba(56,189,248,0.18)",boxShadow:"0 16px 32px rgba(15,23,42,0.45)"},xf={display:"flex",justifyContent:"space-between",alignItems:"center",fontSize:"0.68rem",letterSpacing:"0.16em",color:"#9ca3c6",textTransform:"uppercase"},vf=e=>({fontSize:"0.98rem",fontWeight:600,color:e?"#fda4af":"#f8fafc",textShadow:e?"0 0 12px rgba(248,113,113,0.45)":"none"}),wf={position:"relative",height:"9px",borderRadius:"999px",background:"linear-gradient(90deg, rgba(30,41,59,0.9), rgba(11,16,28,0.85))",overflow:"hidden",boxShadow:"inset 0 0 8px rgba(15,23,42,0.6)"},Sf=e=>({position:"absolute",top:0,left:0,height:"100%",width:`${Math.max(0,Math.min(1,e))*100}%`,background:"linear-gradient(90deg, rgba(96,165,250,0.95), rgba(56,189,248,0.85))",boxShadow:"0 0 16px rgba(56,189,248,0.38)",transition:"width 160ms ease-out"}),kf=e=>{const t={off:{border:"rgba(148,163,184,0.32)",glow:"rgba(148,163,184,0.22)",background:"linear-gradient(135deg, rgba(15,23,42,0.86), rgba(30,41,59,0.78))",label:"#cbd5f5",state:"#94a3b8",dot:"#64748b"},running:{border:"rgba(34,197,94,0.55)",glow:"rgba(34,197,94,0.45)",background:"linear-gradient(135deg, rgba(22,163,74,0.25), rgba(74,222,128,0.18))",label:"#d1fae5",state:"#86efac",dot:"#34d399"},paused:{border:"rgba(250,204,21,0.55)",glow:"rgba(250,204,21,0.38)",background:"linear-gradient(135deg, rgba(120,53,15,0.28), rgba(217,119,6,0.22))",label:"#fef3c7",state:"#fde68a",dot:"#fbbf24"}}[e];return{width:"100%",display:"flex",alignItems:"center",justifyContent:"space-between",padding:"0.52rem 0.9rem",borderRadius:"12px",border:`1px solid ${t.border}`,background:t.background,color:t.label,fontWeight:500,fontSize:"0.72rem",letterSpacing:"0.16em",textTransform:"uppercase",cursor:"pointer",boxShadow:`0 0 22px ${t.glow}`,transition:"transform 120ms ease, box-shadow 120ms ease, border-color 160ms ease"}},If={display:"flex",flexDirection:"column",alignItems:"flex-start",gap:"0.14rem"},Ef={fontSize:"0.58rem",letterSpacing:"0.3em",opacity:.74},Tf=e=>({fontSize:"0.84rem",letterSpacing:"0.14em",color:{off:"#cbd5f5",running:"#bbf7d0",paused:"#fde68a"}[e]}),Cf=e=>{const t={off:{background:"#64748b",shadow:"rgba(100,116,139,0.35)"},running:{background:"#34d399",shadow:"rgba(52,211,153,0.55)"},paused:{background:"#fbbf24",shadow:"rgba(251,191,36,0.45)"}};return{width:"0.6rem",height:"0.6rem",borderRadius:"50%",background:t[e].background,boxShadow:`0 0 14px ${t[e].shadow}`}},Mf={display:"flex",flexDirection:"column",gap:"0.5rem",padding:"0.82rem 0.95rem",borderRadius:"14px",background:"linear-gradient(160deg, rgba(17,24,39,0.86), rgba(15,23,42,0.9))",border:"1px solid rgba(99,102,241,0.22)",boxShadow:"0 16px 32px rgba(15,23,42,0.42)"},Pf={display:"block",fontSize:"0.58rem",letterSpacing:"0.24em",color:"#808bb2",textTransform:"uppercase"},Rf={display:"grid",gridTemplateColumns:"minmax(0, 1fr) minmax(0, 1.5fr) auto",alignItems:"center",gap:"0.6rem",fontSize:"0.72rem",color:"#d1dcff"},Af={position:"relative",height:"6px",borderRadius:"999px",background:"rgba(71,85,105,0.45)",overflow:"hidden"},Df=e=>({position:"absolute",inset:0,width:`${Math.max(0,Math.min(1,e))*100}%`,background:"linear-gradient(90deg, rgba(239,68,68,0.85), rgba(248,113,113,0.78))",boxShadow:"0 0 12px rgba(248,113,113,0.32)",transition:"width 160ms ease-out"}),_f={fontSize:"0.66rem",opacity:.84,minWidth:"44px",textAlign:"right"},Lf=()=>{const e=Xe(),t=P(A=>A.settings.locale),n=P(A=>A.autoBattle.status),r=P(A=>A.world.inCombat),s=P(A=>A.world.isPlayerTurn),i=P(A=>A.settings.autoBattleEnabled),l=P(A=>A.player.data.actionPoints),o=P(A=>A.player.data.maxActionPoints),d=P(A=>{var Q;return((Q=A.world.currentMapArea)==null?void 0:Q.entities.enemies)??uf}),m=Qe(t),f=c.useMemo(()=>d.filter(A=>A.health>0),[d]),u=f.length,g=c.useMemo(()=>f.slice().sort((A,Q)=>Q.actionPoints-A.actionPoints).slice(0,4),[f]),[h,I]=c.useState(l),y=c.useRef(h),E=c.useRef(null);if(c.useEffect(()=>{y.current=h},[h]),c.useEffect(()=>{const A=l;if(E.current&&(window.clearTimeout(E.current),E.current=null),!r){I(A);return}if(!(i&&n==="running")||A>=y.current){I(A);return}const $=()=>{const de=y.current;if(de<=A){E.current=null;return}I(de-1),E.current=window.setTimeout($,70)};return E.current=window.setTimeout($,60),()=>{E.current&&(window.clearTimeout(E.current),E.current=null)}},[l,r,i,n]),c.useEffect(()=>()=>{E.current&&window.clearTimeout(E.current)},[]),!r)return null;const R=Math.max(0,o),M=R>0?Math.max(0,Math.min(1,h/R)):0,F=()=>{e(Qn(!i))},B=i?n==="paused"?"paused":n==="running"?"running":"off":"off";return a.jsxs("div",{style:ff,"data-testid":"combat-control-widget",children:[a.jsxs("div",{style:mf,children:[a.jsx("span",{children:m.turnTracker.heading.toUpperCase()}),a.jsxs("span",{style:pf,children:[a.jsx("span",{style:gf,children:u}),a.jsx("span",{style:hf,children:m.turnTracker.hostileReadout.toUpperCase()})]})]}),a.jsx("div",{style:yf(s),children:s?m.turnTracker.playerTurn:m.turnTracker.enemyTurn}),a.jsxs("div",{style:bf,children:[a.jsxs("div",{style:xf,children:[a.jsx("span",{children:m.playerStatus.actionPointsLabel}),a.jsxs("span",{style:vf(h===0),children:[h,"/",o]})]}),a.jsx("div",{style:wf,children:a.jsx("div",{style:Sf(M)})})]}),a.jsxs("button",{type:"button",onClick:F,style:kf(B),"aria-pressed":i,"aria-label":m.autoBattle.toggleLabel,children:[a.jsxs("span",{style:If,children:[a.jsx("span",{style:Ef,children:m.autoBattle.heading.toUpperCase()}),a.jsx("span",{style:Tf(B),children:B==="off"?m.autoBattle.hudToggleOffLabel:m.autoBattle.hudToggleOnLabel})]}),a.jsx("span",{style:Cf(B)})]}),a.jsxs("div",{style:Mf,children:[a.jsx("span",{style:Pf,children:m.turnTracker.hostileReadout.toUpperCase()}),a.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"0.55rem"},children:g.length>0?g.map(A=>{const Q=A.maxActionPoints>0?Math.max(0,Math.min(1,A.actionPoints/A.maxActionPoints)):0;return a.jsxs("div",{style:Rf,children:[a.jsx("span",{style:{fontWeight:600,overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"},title:A.name,children:A.name}),a.jsx("div",{style:Af,children:a.jsx("div",{style:Df(Q)})}),a.jsxs("span",{style:_f,children:[A.actionPoints,"/",A.maxActionPoints]})]},A.id)}):a.jsx("span",{style:{fontSize:"0.68rem",color:"#9ca3c6",textAlign:"center",letterSpacing:"0.1em"},children:m.turnTracker.playerTurn.toUpperCase()})})]})]})},hr=e=>!!e.settings.reputationSystemsEnabled,jf={},yr=e=>e.reputation,Nf=X(hr,yr,(e,t)=>e&&t.debug.heatmapEnabled),Ya=X(yr,hr,(e,t)=>t?e.profiles:jf),Of=e=>X(Ya,t=>t[e]),Ff=(e,t=3)=>X(Ya,n=>{const r=n[e];return r?bo.map(s=>{const i=r.traits[s];return{trait:s,value:(i==null?void 0:i.value)??0,confidence:(i==null?void 0:i.confidence)??0}}).filter(s=>s.value!==0).sort((s,i)=>Math.abs(i.value)-Math.abs(s.value)).slice(0,t):[]}),zf=X(hr,yr,(e,t)=>e?t.debug.inspectorTargetId??null:null),Hf=()=>{if(typeof process<"u")return"production";if(typeof window<"u"){const e=window;if(typeof e.__VITE_MODE__=="string")return e.__VITE_MODE__}return"development"},Bf=e=>`${Math.round(e*100)}`,$f=e=>e.charAt(0).toUpperCase()+e.slice(1),Vn=e=>{if(!Number.isFinite(e))return"—";const{hour:t,minute:n}=da(e,cr);return`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`},Xa=e=>Math.floor(e/24*cr.cycleDuration),Wf=Xa(vo),ta=Xa(wo),Uf={fontSize:"0.64rem",letterSpacing:"0.18em",textTransform:"uppercase",color:"rgba(226, 232, 240, 0.72)"},Gf={all:"unset",display:"flex",alignItems:"center",justifyContent:"space-between",gap:"0.5rem",width:"100%",marginBottom:"0.35rem",cursor:"pointer",letterSpacing:"0.18em",textTransform:"uppercase",color:"rgba(226, 232, 240, 0.86)"},Vf={fontSize:"0.68rem",color:"rgba(148, 163, 184, 0.72)"},qf={display:"none"},Je={display:"flex",justifyContent:"space-between",fontSize:"0.78rem",marginBottom:"0.22rem"},tn={listStyle:"none",margin:0,padding:0,display:"grid",gap:"0.35rem"},nn={padding:"0.45rem 0.55rem",borderRadius:"0.55rem",backgroundColor:"rgba(24, 36, 52, 0.78)",border:"1px solid rgba(70, 104, 150, 0.3)"},Kf={display:"flex",flexDirection:"column",alignItems:"flex-start",gap:"0.5rem",pointerEvents:"auto"},Yf={all:"unset",display:"inline-flex",alignItems:"center",gap:"0.45rem",padding:"0.45rem 0.85rem",borderRadius:"999px",border:"1px solid rgba(59, 130, 246, 0.42)",background:"linear-gradient(135deg, rgba(15, 23, 42, 0.92), rgba(30, 41, 59, 0.92))",color:"#e2e8f0",fontFamily:'"DM Mono","IBM Plex Mono",monospace',fontSize:"0.62rem",letterSpacing:"0.2em",textTransform:"uppercase",cursor:"pointer",transition:"transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease"},it={all:"unset",display:"inline-flex",alignItems:"center",justifyContent:"center",padding:"0.35rem 0.65rem",borderRadius:"0.55rem",border:"1px solid rgba(148, 163, 184, 0.45)",background:"rgba(15, 23, 42, 0.88)",color:"rgba(226, 232, 240, 0.92)",fontSize:"0.58rem",letterSpacing:"0.18em",textTransform:"uppercase",cursor:"pointer"},Xf={padding:"0.85rem 1rem",borderRadius:"0.85rem",backgroundColor:"rgba(12, 18, 28, 0.9)",color:"#f1f5ff",backdropFilter:"blur(6px)",border:"1px solid rgba(59, 130, 246, 0.38)",width:"min(360px, 28vw)",display:"grid",gap:"0.75rem",fontFamily:'"DM Mono","IBM Plex Mono",monospace',boxShadow:"0 18px 40px rgba(15, 23, 42, 0.32)",zIndex:5},Qf=[],Zf=({zoneId:e,rendererInfo:t})=>{const n=Xe(),r=e??"unknown",s=c.useMemo(()=>Pa(r),[r]),i=c.useMemo(()=>$l(r),[r]),l=P(Nf),o=P(zf),d=P(b=>b.world.currentMapArea.entities.npcs),m=P(b=>b.world.currentMapArea),f=P(b=>b.settings.testMode),u=P(b=>!!b.settings.reputationSystemsEnabled),g=c.useMemo(()=>o?Of(o):null,[o]),h=c.useMemo(()=>o?Ff(o,4):null,[o]),I=P(b=>g?g(b):null),y=P(b=>h?h(b):Qf),[E,R]=c.useState({renderer:!1,time:!1,mission:!1,suspicion:!1,reputation:!1,paranoia:!1}),M={renderer:"Renderer diagnostics",time:"Time/lighting debug",mission:"Mission snapshot",suspicion:"Suspicion snapshot",reputation:"Reputation debug",paranoia:"Paranoia debug"},[F,G]=c.useState(null),[B,A]=c.useState(null),Q=c.useCallback(b=>{R(j=>({...j,[b]:!j[b]}))},[]);c.useEffect(()=>{!o&&d.length>0&&n(qr(d[0].id))},[n,o,d]);const $=c.useCallback(()=>{const b=Wf;n(Kr(b)),A(`Set to day (${Vn(b)})`)},[n]),de=c.useCallback(()=>{n(Kr(ta)),A(`Set to night (${Vn(ta)})`)},[n]),ne=c.useMemo(()=>d.find(b=>b.id===o),[d,o]),[S,N]=c.useState(!0),W=Hf(),z=P(b=>s(b)),T=P(b=>i(b)),ue=P(b=>Et(b)),Z=P(Ul),fe=P(Oe),Y=P(b=>b.world.currentTime),J=P(b=>b.world.timeOfDay),le=c.useCallback(()=>{if(!u){G("Reputation systems are disabled for MVP.");return}if(!o||!m){G("Select an NPC inside the current map to seed a sample event.");return}const b=d.find(j=>j.id===o);if(!b){G("Selected NPC is no longer present in this area.");return}n(xo({actorId:"player",actorLabel:"Player",zoneId:m.zoneId??"zone::debug",position:{...b.position},intensity:"legendary",traits:{heroic:28,intimidating:8},tags:["debug_sample"],mapArea:m,npcsOverride:[b],ambientLighting:1,ambientNoise:.8,disguisePenalty:0,timestamp:Date.now()})),G(`Seeded a heroic event around ${b.name}. If nothing appears, try again nearby or toggle the reputation heatmap.`)},[n,o,m,d,u]);if(c.useEffect(()=>{F&&y.length>0&&G(null)},[F,y.length]),W==="production"||!f)return null;const me="command-debug-panel",xe=(t==null?void 0:t.label)??"Detecting…",ke=(t==null?void 0:t.detail)??"Negotiating renderer",x=S?"Show Debug Panel":"Hide Debug Panel",L=(b,j,w,ye)=>{const he=E[b],Le=`${me}-${ye}`,Ie=typeof j=="string"?j:M[b];return a.jsxs("section",{children:[a.jsxs("button",{type:"button",style:Gf,onClick:()=>Q(b),"aria-expanded":!he,"aria-controls":Le,"aria-label":`${he?"Expand":"Collapse"} ${Ie}`,children:[a.jsx("span",{style:Uf,children:j}),a.jsx("span",{style:Vf,children:he?"▸":"▾"})]}),a.jsx("div",{id:Le,style:he?qf:void 0,"aria-hidden":he,children:he?null:w()})]})};return a.jsxs("div",{style:Kf,children:[a.jsxs("button",{type:"button",style:Yf,onClick:()=>N(b=>!b),"aria-expanded":!S,"aria-controls":me,children:[a.jsx("span",{children:x}),a.jsx("span",{style:{fontSize:"0.58rem",letterSpacing:"0.2em",textTransform:"uppercase",opacity:.75},children:xe})]}),!S&&a.jsxs("div",{id:me,style:Xf,role:"region","aria-label":"Debug Panel",children:[L("renderer","Renderer Diagnostics",()=>a.jsxs(a.Fragment,{children:[a.jsxs("div",{style:Je,children:[a.jsx("span",{children:"Mode"}),a.jsx("span",{children:xe})]}),a.jsxs("div",{style:{...Je,alignItems:"flex-start"},children:[a.jsx("span",{children:"Detail"}),a.jsx("span",{style:{textAlign:"right",maxWidth:"18rem"},children:ke})]}),a.jsxs("div",{style:Je,children:[a.jsx("span",{children:"Phaser"}),a.jsx("span",{children:Ke.VERSION})]})]}),"renderer"),L("time","Time & Lighting",()=>a.jsxs(a.Fragment,{children:[a.jsxs("div",{style:Je,children:[a.jsx("span",{children:"Current"}),a.jsxs("strong",{children:[Vn(Y)," · ",J]})]}),a.jsxs("div",{style:Je,children:[a.jsx("span",{children:"Cycle Duration"}),a.jsxs("strong",{children:[cr.cycleDuration,"s"]})]}),a.jsxs("div",{style:{display:"flex",gap:"0.35rem",flexWrap:"wrap"},children:[a.jsx("button",{type:"button",style:it,onClick:$,children:"Set Day"}),a.jsx("button",{type:"button",style:it,onClick:de,children:"Set Night"})]}),B&&a.jsx("div",{style:{fontSize:"0.62rem",color:"rgba(96, 165, 250, 0.8)"},children:B})]}),"time"),L("mission","Mission Snapshot",()=>a.jsx(a.Fragment,{children:fe?a.jsxs("div",{style:{display:"grid",gap:"0.42rem"},children:[a.jsxs("div",{style:Je,children:[a.jsx("span",{children:"Level"}),a.jsxs("strong",{children:[fe.level," · ",fe.name]})]}),a.jsx("div",{style:{fontSize:"0.64rem",textTransform:"uppercase",letterSpacing:"0.16em",color:"rgba(125, 211, 252, 0.9)"},children:"Primary Objectives"}),fe.primary.length>0?a.jsx("ul",{style:tn,children:fe.primary.map(b=>a.jsxs("li",{style:nn,children:[a.jsx("div",{style:{fontSize:"0.7rem",marginBottom:"0.15rem"},children:b.label}),a.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.64rem",opacity:.8},children:[a.jsxs("span",{children:[b.completedQuests,"/",b.totalQuests]}),a.jsx("span",{children:b.isComplete?"complete":"in progress"})]})]},b.id))}):a.jsx("div",{style:{fontSize:"0.68rem",opacity:.65},children:"No primary objectives mapped."}),a.jsx("div",{style:{fontSize:"0.64rem",textTransform:"uppercase",letterSpacing:"0.16em",color:"rgba(196, 181, 253, 0.92)"},children:"Side Objectives"}),fe.side.length>0?a.jsx("ul",{style:tn,children:fe.side.map(b=>a.jsxs("li",{style:nn,children:[a.jsx("div",{style:{fontSize:"0.7rem",marginBottom:"0.15rem"},children:b.label}),a.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.64rem",opacity:.8},children:[a.jsxs("span",{children:[b.completedQuests,"/",b.totalQuests]}),a.jsx("span",{children:b.isComplete?"complete":"in progress"})]})]},b.id))}):a.jsx("div",{style:{fontSize:"0.68rem",opacity:.65},children:"No side objectives mapped."})]}):a.jsx("div",{style:{fontSize:"0.7rem",opacity:.65},children:"No active mission manifest."})}),"mission"),u&&L("suspicion",`Suspicion Snapshot · ${r}`,()=>a.jsxs(a.Fragment,{children:[a.jsxs("div",{style:Je,children:[a.jsx("span",{children:"Heat Tier"}),a.jsx("span",{children:z.tier})]}),a.jsxs("div",{style:Je,children:[a.jsx("span",{children:"Total Heat"}),a.jsx("span",{children:z.totalHeat.toFixed(2)})]}),T.length>0?a.jsx("ul",{style:tn,children:T.map(b=>a.jsxs("li",{style:nn,children:[a.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.72rem",marginBottom:"0.18rem"},children:[a.jsx("span",{children:b.witnessLabel??b.witnessId}),a.jsxs("span",{children:[Bf(b.certainty),"%"]})]}),a.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.68rem",opacity:.75},children:[a.jsx("span",{children:b.recognitionChannel}),a.jsx("span",{children:b.reported?"reported":"unreported"})]})]},b.id))}):a.jsx("div",{style:{fontSize:"0.7rem",opacity:.65},children:"No active witnesses."})]}),"suspicion"),u&&L("reputation",`Reputation Debug · ${(ne==null?void 0:ne.name)??"Local Cell"}`,()=>a.jsxs(a.Fragment,{children:[a.jsx("div",{style:{display:"flex",gap:"0.4rem",flexWrap:"wrap",marginBottom:"0.45rem"},children:a.jsx("button",{type:"button",style:{...it,borderColor:l?"rgba(96, 165, 250, 0.65)":it.border},onClick:()=>n(So(!l)),children:l?"Hide Heatmap":"Show Heatmap"})}),a.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"0.35rem",marginBottom:"0.45rem"},children:d.length?d.map(b=>a.jsx("button",{type:"button",style:{...it,borderColor:o===b.id?"rgba(96, 165, 250, 0.65)":it.border},onClick:()=>n(qr(b.id)),"aria-pressed":o===b.id,children:b.name},b.id)):a.jsx("span",{style:{fontSize:"0.68rem",opacity:.6},children:"No NPCs in this map."})}),a.jsx("div",{style:{fontSize:"0.62rem",color:"rgba(148, 163, 184, 0.75)",marginBottom:"0.35rem"},children:"1) Pick an NPC in the active cell. 2) Trigger an in-game action or use the seed button below. 3) Inspect the traits that populate here and toggle the heatmap to see cell sentiment."}),I?y.length?a.jsx("ul",{style:tn,children:y.map(b=>{const j=I.traits[b.trait],w=(j==null?void 0:j.sources)??[];return a.jsxs("li",{style:nn,children:[a.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.7rem",marginBottom:"0.18rem"},children:[a.jsx("span",{children:$f(b.trait)}),a.jsx("span",{children:b.value.toFixed(1)})]}),a.jsxs("div",{style:{fontSize:"0.64rem",opacity:.72},children:["Confidence ",Math.round(b.confidence*100),"%"]}),w.length?a.jsxs("div",{style:{fontSize:"0.62rem",opacity:.62,marginTop:"0.2rem"},children:["Rumors: ",w.slice(0,3).join(", ")]}):a.jsx("div",{style:{fontSize:"0.62rem",opacity:.45,marginTop:"0.2rem"},children:"No rumor sources tracked."})]},b.trait)})}):a.jsxs("div",{style:{display:"grid",gap:"0.35rem"},children:[a.jsx("div",{style:{fontSize:"0.68rem",opacity:.6},children:"No localized reputation yet. Trigger a nearby event so NPCs can witness something."}),a.jsx("button",{type:"button",onClick:le,style:{...it,borderColor:"rgba(96, 165, 250, 0.55)",justifyContent:"center"},disabled:!m,children:"Seed Sample Heroic Event"}),F&&a.jsx("div",{style:{fontSize:"0.62rem",color:"rgba(96, 165, 250, 0.8)"},children:F})]}):a.jsxs("div",{style:{display:"grid",gap:"0.35rem"},children:[a.jsx("div",{style:{fontSize:"0.68rem",opacity:.6},children:"Select an NPC to inspect reputation."}),a.jsx("button",{type:"button",onClick:le,style:{...it,borderColor:"rgba(96, 165, 250, 0.55)",justifyContent:"center"},disabled:!m,children:"Seed Sample Heroic Event"}),F&&a.jsx("div",{style:{fontSize:"0.62rem",color:"rgba(96, 165, 250, 0.8)"},children:F})]})]}),"reputation"),L("paranoia",`Paranoia Debug · ${ue.tier}`,()=>a.jsxs(a.Fragment,{children:[a.jsxs("div",{style:Je,children:[a.jsx("span",{children:"Value"}),a.jsx("span",{children:ue.value.toFixed(1)})]}),Z?a.jsxs("div",{style:{display:"grid",gap:"0.3rem",fontSize:"0.72rem"},children:[a.jsxs("div",{children:[a.jsx("strong",{style:{opacity:.8},children:"Δ"})," ",Z.delta>=0?"+":"",Z.delta.toFixed(3)]}),a.jsxs("div",{children:[a.jsx("strong",{style:{opacity:.8},children:"Gains"})," ",Object.keys(Z.breakdown.gains).length===0?"—":Object.entries(Z.breakdown.gains).map(([b,j])=>`${b}:${j.toFixed(3)}`).join(" | ")]}),a.jsxs("div",{children:[a.jsx("strong",{style:{opacity:.8},children:"Losses"})," ",Object.keys(Z.breakdown.losses).length===0?"—":Object.entries(Z.breakdown.losses).map(([b,j])=>`${b}:${j.toFixed(3)}`).join(" | ")]}),a.jsxs("div",{children:[a.jsx("strong",{style:{opacity:.8},children:"Spikes"})," ",Object.keys(Z.breakdown.spikes).length===0?"—":Object.entries(Z.breakdown.spikes).map(([b,j])=>`${b}:${j.toFixed(3)}`).join(" | ")]})]}):a.jsx("div",{style:{fontSize:"0.7rem",opacity:.65},children:"No recent paranoia stimuli."})]}),"paranoia")]})]})},Jf=c.lazy(()=>It(()=>import("./GameMenu-5Z21hAsW.js"),__vite__mapDeps([0,1,2,3,4,5]))),em=c.lazy(()=>It(()=>import("./CharacterCreationScreen-Cl8BXET8.js"),__vite__mapDeps([6,1,2,4,3,5,7]))),tm=c.lazy(()=>It(()=>import("./CharacterScreen-CDES-cnZ.js"),__vite__mapDeps([8,1,2,3,4,7]))),nm=c.lazy(()=>It(()=>import("./LevelUpModal-CEh9CGhX.js"),__vite__mapDeps([9,1,2,5,4,3])).then(e=>({default:e.LevelUpModal}))),rm=c.lazy(()=>It(()=>import("./PerkSelectionPanel-DhBsZLfg.js"),__vite__mapDeps([10,1,2,3,4]))),sm=c.lazy(()=>It(()=>import("./LevelUpPointAllocationPanel-BrxXHFsF.js"),__vite__mapDeps([11,1,2,4,3,5]))),na=oa("App"),am={margin:0,padding:0,width:"100vw",height:"100vh",overflow:"hidden",position:"relative",backgroundColor:"var(--color-gunmetal-900)",color:"var(--color-hud-text)",fontFamily:"var(--font-mono)"},im={position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",background:"var(--hud-stage-background)"},qn=260,om=320,lm={flex:"1 1 auto",minWidth:0,height:"100%",position:"relative",overflow:"hidden"},cm={position:"absolute",top:"1.25rem",left:"1.25rem",display:"flex",flexDirection:"column",alignItems:"flex-start",gap:"0.75rem",zIndex:5,pointerEvents:"auto"},dm={position:"absolute",top:"1.25rem",left:"50%",transform:"translateX(-50%)",display:"flex",flexDirection:"column",alignItems:"center",gap:"0.75rem",zIndex:6,pointerEvents:"auto"},um={position:"absolute",top:"1.25rem",right:"1.25rem",display:"flex",flexDirection:"column",alignItems:"flex-end",gap:"0.75rem",zIndex:6,pointerEvents:"none"},fm={all:"unset",display:"flex",alignItems:"center",justifyContent:"space-between",gap:"0.5rem",padding:"0.7rem 0.9rem",boxSizing:"border-box",borderRadius:"14px",border:"var(--hud-command-button-border)",background:"var(--hud-command-button-bg)",boxShadow:"var(--hud-command-button-shadow)",color:"var(--hud-command-button-text)",fontFamily:"var(--font-mono)",fontSize:"0.7rem",letterSpacing:"0.14em",textTransform:"uppercase",cursor:"pointer",pointerEvents:"auto",transition:"transform 0.16s ease, box-shadow 0.16s ease, border-color 0.16s ease, color 0.16s ease"},mm={fontSize:"0.78rem",letterSpacing:"0.2em",color:"inherit"},pm={fontSize:"0.62rem",letterSpacing:"0.24em",color:"var(--hud-command-button-text-muted)",textTransform:"uppercase"},gm=({onOpenMenu:e,onToggleCharacter:t,showMenu:n,characterOpen:r,hudLayoutPreset:s})=>{const i=P($=>$.settings.locale),l=P($=>$.settings.testMode),o=P($=>$.world.inCombat),d=Qe(i),m=P($=>{var de;return((de=$.world.currentMapArea)==null?void 0:de.zoneId)??null}),f=s==="combat",[u,g]=c.useState(!1),[h,I]=c.useState(null),y=c.useRef(null),[E,R]=c.useState(null),[M,F]=c.useState(qn);c.useEffect(()=>{n&&g(!1)},[n]),c.useEffect(()=>{o&&g(!1)},[o]),c.useEffect(()=>{if(typeof window>"u"||typeof ResizeObserver>"u")return;const $=y.current;if(!$)return;const de=new ResizeObserver(ne=>{const S=ne[0];if(!S)return;const N=Math.round(S.contentRect.height);R(W=>W===N?W:N)});return de.observe($),()=>de.disconnect()},[]),c.useEffect(()=>{const $=y.current;if(!$)return;const de=Math.round($.getBoundingClientRect().height);R(ne=>ne===de?ne:de)},[]),c.useEffect(()=>{if(!E){F(qn);return}if(typeof window>"u"){F(E);return}const de=(parseFloat(window.getComputedStyle(document.documentElement).fontSize||"16")||16)*1.3,ne=Math.round(E+de),S=Math.min(Math.max(ne,qn),om);F(N=>N===S?N:S)},[E]);const G=()=>{g($=>!$)},B=u?d.shell.completedToggleClose:d.shell.completedToggleOpen;return c.useEffect(()=>{if(!(typeof document>"u"))return M?document.documentElement.style.setProperty("--bottom-panel-height",`${M}px`):document.documentElement.style.removeProperty("--bottom-panel-height"),()=>{typeof document<"u"&&document.documentElement.style.removeProperty("--bottom-panel-height")}},[M]),a.jsxs("div",{style:im,className:"command-shell-stage","data-hud-layout":s,children:[a.jsxs("div",{style:lm,children:[a.jsx(Ou,{}),a.jsx(_o,{onRendererInfo:I}),a.jsx(gc,{}),a.jsxs("div",{style:cm,children:[a.jsxs("button",{type:"button",onClick:e,style:{...fm,width:"90vw",maxWidth:"240px"},"data-testid":"menu-overlay-button","aria-label":d.shell.menuButton,title:d.shell.menuButton,onMouseEnter:$=>{$.currentTarget.style.transform="translateY(-2px)",$.currentTarget.style.boxShadow="var(--hud-command-button-shadow-hover)",$.currentTarget.style.borderColor="var(--hud-command-button-border-hover)",$.currentTarget.style.color="var(--hud-command-button-text-hover)"},onMouseLeave:$=>{$.currentTarget.style.transform="translateY(0)",$.currentTarget.style.boxShadow="var(--hud-command-button-shadow)",$.currentTarget.style.borderColor="var(--hud-command-button-border-rest)",$.currentTarget.style.color="var(--hud-command-button-text)"},onFocus:$=>{$.currentTarget.style.boxShadow="var(--hud-command-button-shadow-focus)",$.currentTarget.style.borderColor="var(--hud-command-button-border-focus)"},onBlur:$=>{$.currentTarget.style.boxShadow="var(--hud-command-button-shadow)",$.currentTarget.style.borderColor="var(--hud-command-button-border-rest)"},children:[a.jsx("span",{style:mm,children:d.shell.menuButton}),a.jsx("span",{style:pm,children:"ESC"})]}),l?a.jsx(Zf,{zoneId:m,rendererInfo:h}):null]}),a.jsx("div",{style:dm,children:a.jsx(Lf,{})}),a.jsx("div",{style:um,children:a.jsx("div",{style:{pointerEvents:"auto"},children:a.jsx(kc,{})})}),a.jsx(Tu,{}),a.jsx(Hu,{})]}),a.jsxs("div",{className:"hud-bottom-dock","data-hud-layout":s,children:[a.jsx("div",{className:"hud-bottom-lane hud-bottom-lane--map",children:a.jsx("div",{className:"hud-bottom-lane-card",children:a.jsx("div",{className:"hud-bottom-card-surface",children:a.jsx(Hc,{className:"hud-bottom-map-card",variant:"frameless",children:a.jsx(Fc,{})})})})}),a.jsx("div",{className:"hud-bottom-lane hud-bottom-lane--status",ref:y,"data-hud-emphasis":f?"true":void 0,children:a.jsx("div",{className:"hud-bottom-lane-card",children:a.jsx("div",{className:"hud-bottom-card-surface",children:a.jsx(wc,{onOpenCharacter:t,characterOpen:r,variant:"frameless"})})})}),a.jsx("div",{className:"hud-bottom-lane hud-bottom-lane--george",children:a.jsx("div",{className:"hud-bottom-lane-card",children:a.jsx("div",{className:"hud-bottom-card-surface",children:a.jsx(vd,{})})})}),a.jsxs("div",{className:"hud-bottom-lane hud-bottom-lane--ops",children:[a.jsx("div",{className:"hud-bottom-lane-card",children:a.jsxs("div",{className:"hud-bottom-card-surface",children:[a.jsx("div",{className:"hud-bottom-quests",children:a.jsx(Xs,{})}),a.jsx("div",{className:"hud-bottom-control-row",children:a.jsx("button",{type:"button",className:"hud-bottom-toggle",onClick:G,"aria-expanded":u,"aria-controls":"command-objective-overlay",children:B})})]})}),a.jsx("div",{id:"command-objective-overlay",className:"hud-bottom-overlay","data-expanded":u,children:a.jsx("div",{className:"hud-bottom-overlay__scroll",children:a.jsx(Xs,{showCompleted:!0})})})]})]})]})},ra=()=>{if(typeof window>"u")return!1;try{return!!window.localStorage.getItem(ua)}catch(e){return console.warn("[App] Failed to read persisted game state",e),!1}},on=e=>Po().filter(t=>!e.perks.includes(t.id)),Kn=e=>on(e).map(t=>Ro(e,t)).filter(t=>t.canSelect);function hm(){const[e,t]=c.useState(!1),[n,r]=c.useState(!0),[s,i]=c.useState(!1),[l,o]=c.useState(()=>ra()),[d,m]=c.useState(null),[f,u]=c.useState([]),[g,h]=c.useState(!1),[I,y]=c.useState(0),[E,R]=c.useState(!1),[M,F]=c.useState(!1),[G,B]=c.useState(!1),A=P(qu),Q=P(Y=>!!Y.settings.reputationSystemsEnabled);c.useEffect(()=>{na.debug("Component mounted"),na.debug("Store state:",Me.getState())},[]),c.useEffect(()=>Me.subscribe(()=>{const J=Me.getState(),le=J.player.pendingLevelUpEvents;m(ke=>ke||(le.length>0?le[0]:null));const me=J.player.data.pendingPerkSelections;y(me);const xe=J.player.xpNotifications??[];u(xe)}),[]),c.useEffect(()=>{if(n){if(e){o(!0);return}o(ra())}},[n,e]),c.useEffect(()=>{if(typeof window>"u")return;const Y=new URLSearchParams(window.location.search);if(Y.get("poc")!=="esb"||e||s)return;try{window.localStorage.removeItem(ua)}catch{}o(!1),r(!1);const J={name:Y.get("pocName")??"Deus",attributes:Yr,backgroundId:"corpsec_defector",visualPreset:"default"};de(J)},[e,s]),c.useEffect(()=>{e&&window.requestAnimationFrame(()=>{window.dispatchEvent(new Event("resize"))})},[e]),c.useEffect(()=>{(n||s)&&h(!1)},[n,s]),c.useEffect(()=>{const Y=J=>{J.key.toLowerCase()==="c"&&e&&!n&&!s&&h(le=>!le)};return window.addEventListener("keydown",Y),()=>window.removeEventListener("keydown",Y)},[e,n,s]);const $=()=>{r(!1),i(!0)},de=Y=>{Me.dispatch(ko());const J=Y.attributes??Yr,le=Y.backgroundId??"corpsec_defector";Me.dispatch(Io({name:Y.name,skills:J,backgroundId:le,visualPreset:Y.visualPreset}));const me=Me.getState(),{logs:xe}=ot(me.settings.locale);Me.dispatch(O(`${xe.operationStart} - Call sign: ${Y.name}`)),i(!1),t(!0),o(!0)},ne=()=>{i(!1),r(!0)},S=()=>{Me.dispatch(Eo()),t(!0),r(!1),o(!0)};c.useEffect(()=>{if(!e)return;const Y=J=>{if(J.key!=="Escape")return;if(J.preventDefault(),g){h(!1),M&&F(!1);return}if(!!Me.getState().quests.activeDialogue.dialogueId){Me.dispatch(cn());return}if(n){S();return}s||r(!0)};return window.addEventListener("keydown",Y),()=>window.removeEventListener("keydown",Y)},[e,n,s,g,M]);const N=()=>{if(!e){r(!0);return}if(n){S();return}if(!!Me.getState().quests.activeDialogue.dialogueId){Me.dispatch(cn());return}r(!0)},W=()=>{!e||n||s||h(Y=>!Y)},z=()=>{if(!d)return;const J=Me.getState().player.data,le=J.pendingPerkSelections,me=on(J),xe=Kn(J),ke=le>0,x=xe.length>0,L=J.skillPoints>0||J.attributePoints>0;F(ke||L),Me.dispatch(To()),m(null),ke&&me.length>0?(x||console.info("[LevelUp] Perk selections available but current requirements are unmet. Player may need to allocate points first."),R(!0)):(ke&&me.length===0&&Me.dispatch(Ln()),L?B(!0):F(!1))},T=()=>{if(R(!1),!M)return;const Y=Me.getState().player.data,J=Y.pendingPerkSelections,le=Y.skillPoints>0||Y.attributePoints>0,me=on(Y),xe=Kn(Y);if(J>0&&xe.length===0&&me.length===0&&Me.dispatch(Ln()),le){B(!0);return}F(!1)},ue=()=>{h(!1),M&&F(!1)},Z=()=>{B(!1);const Y=Me.getState().player.data,J=Y.pendingPerkSelections,le=on(Y),me=Kn(Y);if(J>0&&me.length>0){R(!0);return}J>0&&me.length===0&&le.length===0&&Me.dispatch(Ln()),F(!1)},fe=Y=>{Me.dispatch(Co(Y))};return a.jsxs(a.Fragment,{children:[a.jsx(Ku,{}),Q&&a.jsx(sf,{}),a.jsxs("div",{style:am,children:[e&&a.jsx(gm,{onOpenMenu:N,onToggleCharacter:W,showMenu:n,characterOpen:g,hudLayoutPreset:A}),a.jsx(Gu,{})]}),a.jsxs(c.Suspense,{fallback:null,children:[n&&a.jsx(Jf,{onStartNewGame:$,onContinue:S,hasActiveGame:e||l}),s&&a.jsx(em,{onComplete:de,onCancel:ne}),d&&a.jsx(nm,{newLevel:d.newLevel,skillPointsEarned:d.skillPointsEarned,attributePointsEarned:d.attributePointsEarned,perksUnlocked:d.perksUnlocked,onContinue:z}),a.jsx(rm,{open:E,pendingSelections:I,onClose:T}),G&&a.jsx(sm,{onComplete:Z}),a.jsx(tm,{open:g,onClose:ue}),a.jsx(df,{})]}),a.jsx(Nu,{notifications:f,onDismiss:fe})]})}function ym(){return a.jsx(si,{store:Me,children:a.jsx(hm,{})})}ai.createRoot(document.getElementById("root")).render(a.jsx(c.StrictMode,{children:a.jsx(ym,{})}));export{wc as P,Im as a,Em as b,km as c,Tm as d,Cm as e,Rm as f,Pm as g,mn as n,Mm as s};
